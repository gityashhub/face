{"file_contents":{"frontend/src/api/index.js":{"content":"// src/api/index.js\nimport axios from 'axios';\n\nconst API = axios.create({\n  baseURL: import.meta.env.VITE_API_BASE_URL\n});\n\nexport default API;\n","path":null,"size_bytes":145,"size_tokens":null},"frontend/src/utils/config.js":{"content":"export const OFFICE_LOCATION = {\n  latitude: 22.29867,\n  longitude: 73.13130,\n  radius: 100 // meters - Strict office location enforcement\n};\n","path":null,"size_bytes":142,"size_tokens":null},"frontend/src/services/taskService.js":{"content":"import api from './api';\n\nexport const taskService = {\n  getTasks: async (params = {}) => {\n    try {\n      console.log('Fetching tasks with params:', params);\n      const response = await api.get('/tasks', { params });\n      console.log('Tasks API response:', response.data);\n      return response.data;\n    } catch (error) {\n      console.error('Get tasks error:', error.response?.data || error);\n      throw error.response?.data || { message: 'Failed to get tasks' };\n    }\n  },\n  \n createTask: async (taskData) => {\n  try {\n    console.log('Creating task:', taskData);\n    const response = await api.post('/tasks', taskData);\n    console.log('Create task success response:', response.data);\n    return response.data;\n  } catch (error) {\n    console.error('Create task error details:', {\n      status: error.response?.status,\n      data: error.response?.data,\n      message: error.message\n    });\n    \n    // Log specific validation errors\n    if (error.response?.data?.errors) {\n      console.log('Specific validation errors:');\n      error.response.data.errors.forEach((err, index) => {\n        console.log(`${index + 1}. Field: ${err.path || err.param}, Error: ${err.msg || err.message}`);\n      });\n    }\n    \n    throw error.response?.data || { message: 'Failed to create task' };\n  }\n},\n\n\n  // Get task by ID\n  getTaskById: async (taskId) => {\n    try {\n      const response = await api.get(`/tasks/${taskId}`);\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to get task' };\n    }\n  },\n\n  // Create new task (Admin only)\n  // createTask: async (taskData) => {\n  //   try {\n  //     const response = await api.post('/tasks', taskData);\n  //     return response.data;\n  //   } catch (error) {\n  //     throw error.response?.data || { message: 'Failed to create task' };\n  //   }\n  // },\n\n  // Update task\n  updateTask: async (taskId, taskData) => {\n    try {\n      const response = await api.put(`/tasks/${taskId}`, taskData);\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to update task' };\n    }\n  },\n\n  // Delete task (Admin only)\n  deleteTask: async (taskId) => {\n    try {\n      const response = await api.delete(`/tasks/${taskId}`);\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to delete task' };\n    }\n  },\n\n  // Add comment to task\n  addComment: async (taskId, text) => {\n    try {\n      const response = await api.post(`/tasks/${taskId}/comments`, { text });\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to add comment' };\n    }\n  },\n\n  // Update task progress\n  updateProgress: async (taskId, progress) => {\n    try {\n      const response = await api.put(`/tasks/${taskId}/progress`, { progress });\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to update progress' };\n    }\n  },\n\n  // Change task status\n  changeStatus: async (taskId, status) => {\n    try {\n      const response = await api.put(`/tasks/${taskId}/status`, { status });\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to change status' };\n    }\n  },\n\n  // Toggle subtask\n  toggleSubtask: async (taskId, subtaskId) => {\n    try {\n      const response = await api.put(`/tasks/${taskId}/subtasks/${subtaskId}`);\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to toggle subtask' };\n    }\n  },\n\n  // Get task statistics\n  getTaskStats: async () => {\n    try {\n      const response = await api.get('/tasks/stats');\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to get task stats' };\n    }\n  }\n};","path":null,"size_bytes":3841,"size_tokens":null},"frontend/src/pages/Admin/AdminProfile.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { User, Mail, Phone, Building2, Shield, Save, Camera } from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport AdminLayout from '../../components/Admin/layout/AdminLayout';\nimport { authAPI } from '../../utils/api';\n\nconst AdminProfile = () => {\n  const [profile, setProfile] = useState({\n    name: '',\n    email: '',\n    phone: '',\n    department: 'Administration',\n    role: 'admin'\n  });\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n\n  useEffect(() => {\n    fetchProfile();\n  }, []);\n\n  const fetchProfile = async () => {\n    try {\n      setLoading(true);\n      const response = await authAPI.getProfile();\n      if (response.data.success) {\n        const userData = response.data.data.user;\n        setProfile({\n          name: userData.name || localStorage.getItem('userName') || '',\n          email: userData.email || localStorage.getItem('userEmail') || '',\n          phone: userData.phone || '',\n          department: 'Administration',\n          role: 'admin'\n        });\n      }\n    } catch (error) {\n      console.error('Error fetching profile:', error);\n      setProfile({\n        name: localStorage.getItem('userName') || 'Admin',\n        email: localStorage.getItem('userEmail') || 'admin@company.com',\n        phone: '',\n        department: 'Administration',\n        role: 'admin'\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleChange = (e) => {\n    setProfile(prev => ({\n      ...prev,\n      [e.target.name]: e.target.value\n    }));\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setSaving(true);\n    try {\n      await authAPI.updateProfile({\n        name: profile.name,\n        phone: profile.phone\n      });\n      toast.success('Profile updated successfully');\n      localStorage.setItem('userName', profile.name);\n      // Refresh profile data to show updated values\n      await fetchProfile();\n    } catch (error) {\n      console.error('Update profile error:', error);\n      toast.error(error.response?.data?.message || 'Failed to update profile');\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  if (loading) {\n    return (\n      <AdminLayout>\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-neon-pink\"></div>\n        </div>\n      </AdminLayout>\n    );\n  }\n\n  return (\n    <AdminLayout>\n      <div className=\"max-w-2xl mx-auto\">\n        <div className=\"mb-6\">\n          <h1 className=\"text-2xl font-bold text-white\">Profile Settings</h1>\n          <p className=\"text-secondary-400 mt-1\">Manage your account information</p>\n        </div>\n\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <div className=\"flex items-center space-x-4 mb-8\">\n            <div className=\"relative\">\n              <div className=\"w-20 h-20 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                <User className=\"w-10 h-10 text-white\" />\n              </div>\n              <button className=\"absolute bottom-0 right-0 w-8 h-8 bg-secondary-700 rounded-full flex items-center justify-center border-2 border-secondary-800 hover:bg-secondary-600 transition-colors\">\n                <Camera className=\"w-4 h-4 text-white\" />\n              </button>\n            </div>\n            <div>\n              <h2 className=\"text-xl font-semibold text-white\">{profile.name}</h2>\n              <div className=\"flex items-center space-x-2 mt-1\">\n                <Shield className=\"w-4 h-4 text-neon-pink\" />\n                <span className=\"text-sm text-neon-pink\">Administrator</span>\n              </div>\n            </div>\n          </div>\n\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                Full Name\n              </label>\n              <div className=\"relative\">\n                <User className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                <input\n                  type=\"text\"\n                  name=\"name\"\n                  value={profile.name}\n                  onChange={handleChange}\n                  className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 transition-all\"\n                  placeholder=\"Enter your name\"\n                />\n              </div>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                Email Address\n              </label>\n              <div className=\"relative\">\n                <Mail className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                <input\n                  type=\"email\"\n                  name=\"email\"\n                  value={profile.email}\n                  disabled\n                  className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/30 border border-secondary-700 rounded-lg text-secondary-400 cursor-not-allowed\"\n                />\n              </div>\n              <p className=\"text-xs text-secondary-500 mt-1\">Email cannot be changed</p>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                Phone Number\n              </label>\n              <div className=\"relative\">\n                <Phone className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                <input\n                  type=\"tel\"\n                  name=\"phone\"\n                  value={profile.phone}\n                  onChange={handleChange}\n                  className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 transition-all\"\n                  placeholder=\"Enter your phone number\"\n                />\n              </div>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                Department\n              </label>\n              <div className=\"relative\">\n                <Building2 className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                <input\n                  type=\"text\"\n                  value={profile.department}\n                  disabled\n                  className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/30 border border-secondary-700 rounded-lg text-secondary-400 cursor-not-allowed\"\n                />\n              </div>\n            </div>\n\n            <button\n              type=\"submit\"\n              disabled={saving}\n              className=\"w-full py-3 px-4 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 disabled:opacity-50 flex items-center justify-center space-x-2\"\n            >\n              {saving ? (\n                <span className=\"flex items-center\">\n                  <svg className=\"animate-spin -ml-1 mr-3 h-5 w-5 text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                  </svg>\n                  Saving...\n                </span>\n              ) : (\n                <>\n                  <Save className=\"w-5 h-5\" />\n                  <span>Save Changes</span>\n                </>\n              )}\n            </button>\n          </form>\n        </div>\n      </div>\n    </AdminLayout>\n  );\n};\n\nexport default AdminProfile;","path":null,"size_bytes":8083,"size_tokens":null},"backend/controllers/attendanceController.js":{"content":"// controllers/attendanceController.js\nimport Attendance from '../models/Attendance.js';\nimport Employee from '../models/Employee.js';\nimport User from '../models/User.js';\nimport Notification from '../models/Notification.js';\nimport mongoose from 'mongoose';\n\nexport const OFFICE_LOCATION = {\n  latitude: 22.29867,\n  longitude: 73.13130,\n  radius: 100 // meters - Strict office location enforcement\n}\n\n// Shared face similarity threshold (cosine similarity).\n// This is aligned with the Python face_service default and can be overridden\n// via the FACE_SIMILARITY_THRESHOLD environment variable to keep behavior\n// consistent across services.\nconst FACE_SIMILARITY_THRESHOLD = parseFloat(process.env.FACE_SIMILARITY_THRESHOLD || '0.6');\n\n\nfunction calculateDistance(lat1, lon1, lat2, lon2) {\n  const R = 6371e3; // meters\n  const toRad = (deg) => (deg * Math.PI) / 180;\n\n  const φ1 = toRad(lat1);\n  const φ2 = toRad(lat2);\n  const Δφ = toRad(lat2 - lat1);\n  const Δλ = toRad(lon2 - lon1);\n\n  const a =\n    Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +\n    Math.cos(φ1) * Math.cos(φ2) *\n    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n  return R * c;\n}\n\n// Helper function to get today's date range\nconst getTodayDateRange = () => {\n  const now = new Date();\n  const startOfDay = new Date(now.toISOString().split('T')[0] + 'T00:00:00Z');\n  const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000);\n  return { startOfDay, endOfDay };\n};\n\n// @desc    Mark attendance (Check In) - REQUIRES FACE VERIFICATION\n// @route   POST /api/attendance/checkin\n// @access  Private (Employee)\nexport const checkIn = async (req, res) => {\n  try {\n    const { location, deviceInfo, notes, faceVerified } = req.body;\n    console.log('Check-in request:', { userId: req.user.id, location, faceVerified });\n\n    // ⚠️ SECURITY: Require face verification for attendance\n    // This prevents employees from marking attendance without face verification\n    if (!faceVerified) {\n      return res.status(403).json({\n        success: false,\n        message: 'Face verification is required to mark attendance. Please use the face verification feature.'\n      });\n    }\n\n    // Validate location data\n    if (!location || !location.latitude || !location.longitude) {\n      return res.status(400).json({\n        success: false,\n        message: 'Location data is required for attendance'\n      });\n    }\n\n    // Validate location within office radius\n    const distance = calculateDistance(\n      location.latitude,\n      location.longitude,\n      OFFICE_LOCATION.latitude,\n      OFFICE_LOCATION.longitude\n    );\n\n    if (distance > OFFICE_LOCATION.radius) {\n      return res.status(400).json({\n        success: false,\n        message: `You are not within office premises (Distance: ${Math.round(distance)}m)`\n      });\n    }\n\n    // Get employee record\n    const employee = await Employee.findOne({ user: req.user.id });\n    if (!employee) {\n      console.log('Employee not found for user:', req.user.id);\n      return res.status(404).json({\n        success: false,\n        message: 'Employee record not found'\n      });\n    }\n\n    console.log('Employee found:', employee._id);\n\n    // Check if attendance already marked for today\n    const { startOfDay, endOfDay } = getTodayDateRange();\n    console.log('Checking attendance for date range:', { startOfDay, endOfDay });\n\n    const existingAttendance = await Attendance.findOne({\n      employee: employee._id,\n      $or: [\n        {\n          date: {\n            $gte: startOfDay,\n            $lte: endOfDay\n          }\n        },\n        {\n          checkInTime: {\n            $gte: startOfDay,\n            $lte: endOfDay\n          }\n        }\n      ]\n    });\n\n    if (existingAttendance) {\n      console.log('Existing attendance found:', existingAttendance);\n      return res.status(400).json({\n        success: false,\n        message: 'Attendance already marked for today',\n        data: existingAttendance\n      });\n    }\n\n    // Create attendance record\n    const checkInTime = new Date();\nconst localDate = new Date(checkInTime.toISOString().split('T')[0] + 'T00:00:00Z');    \n    \n    // Handle address - it might be an object or a string\n    let addressString = '';\n    if (location.address) {\n      if (typeof location.address === 'object') {\n        addressString = location.address.address || `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;\n      } else {\n        addressString = location.address;\n      }\n    }\n\n    const attendance = new Attendance({\n      employee: employee._id,\n      user: req.user.id,\n      checkInTime: checkInTime,\n      date: localDate,\n      checkInLocation: {\n        latitude: location.latitude,\n        longitude: location.longitude,\n        address: addressString,\n        accuracy: location.accuracy || 0\n      },\n      notes: notes || '',\n      ipAddress: req.ip,\n      deviceInfo: deviceInfo || {\n        userAgent: req.headers['user-agent'],\n        platform: 'Web',\n        browser: 'Unknown'\n      }\n    });\n\n    console.log('Creating attendance record:', {\n      employee: employee._id,\n      date: localDate,\n      checkInTime: checkInTime\n    });\n\n    await attendance.save();\n    console.log('Attendance saved successfully:', attendance._id);\n\n    // Send notification to admins about employee check-in\n    try {\n      const adminUsers = await User.find({ role: 'admin', isActive: true });\n      console.log(`Found ${adminUsers.length} active admin users for check-in notification`);\n\n      if (adminUsers.length > 0) {\n        const employeeName = `${employee.personalInfo?.firstName || 'Employee'} ${employee.personalInfo?.lastName || ''}`.trim();\n\n        const notification = await Notification.createNotification({\n          title: 'Employee Check-in',\n          message: `${employeeName} has checked in for work`,\n          type: 'info',\n          category: 'attendance',\n          targetUsers: adminUsers.map(admin => admin._id),\n          sender: req.user.id,\n          priority: 'medium',\n          relatedEntity: {\n            model: 'Attendance',\n            id: attendance._id\n          },\n          metadata: {\n            employeeName: employeeName,\n            checkInTime: checkInTime,\n            location: location.address || 'Office Location',\n            employeeId: employee.employeeId\n          }\n        });\n\n        console.log(`✅ Check-in notification sent successfully to ${adminUsers.length} admins`);\n        console.log('Notification details:', {\n          id: notification._id,\n          title: notification.title,\n          targetUsersCount: notification.targetUsers.length\n        });\n      } else {\n        console.warn('⚠️ No active admin users found for check-in notification');\n      }\n    } catch (notificationError) {\n      console.error('❌ Error sending check-in notification:', notificationError);\n      console.error('Notification error details:', {\n        message: notificationError.message,\n        stack: notificationError.stack\n      });\n      // Don't fail the check-in if notification fails\n    }\n\n    // Populate employee and user data\n    await attendance.populate([\n      { path: 'employee', select: 'personalInfo workInfo' },\n      { path: 'user', select: 'name email employeeId' }\n    ]);\n\n    res.status(201).json({\n      success: true,\n      message: 'Attendance marked successfully',\n      data: attendance\n    });\n\n  } catch (error) {\n    console.error('Check-in error:', error);\n    \n    if (error.code === 11000) {\n      return res.status(400).json({\n        success: false,\n        message: 'Attendance already marked for today'\n      });\n    }\n\n    res.status(500).json({\n      success: false,\n      message: 'Server error while marking attendance',\n      error: error.message\n    });\n  }\n};\n\n// @desc    Mark checkout\n// @route   PUT /api/attendance/checkout\n// @access  Private (Employee)\n// Replace your checkOut function with this exact version\nexport const checkOut = async (req, res) => {\n  try {\n    const { location, notes } = req.body;\n    \n    console.log('=== CHECKOUT DEBUG START ===');\n    console.log('User ID:', req.user.id);\n\n    // Validate location data\n    if (!location || !location.latitude || !location.longitude) {\n      console.log('ERROR: Missing location data');\n      return res.status(400).json({\n        success: false,\n        message: 'Location data is required for checkout'\n      });\n    }\n\n    // Validate location within office radius\n    const distance = calculateDistance(\n      location.latitude,\n      location.longitude,\n      OFFICE_LOCATION.latitude,\n      OFFICE_LOCATION.longitude\n    );\n\n    if (distance > OFFICE_LOCATION.radius) {\n      return res.status(400).json({\n        success: false,\n        message: `You are not within office premises (Distance: ${Math.round(distance)}m)`\n      });\n    }\n\n    // Get employee record\n    const employee = await Employee.findOne({ user: req.user.id });\n    console.log('Employee found:', employee ? employee._id : 'NOT FOUND');\n    \n    if (!employee) {\n      return res.status(404).json({\n        success: false,\n        message: 'Employee record not found'\n      });\n    }\n    // ✅ NOW SAFE TO USE employee._id\n    console.log('=== DEBUG: All attendance records ===');\n    const allRecords = await Attendance.find({ employee: employee._id }).sort({ checkInTime: -1 });\n    allRecords.forEach(r => {\n      console.log(`ID: ${r._id}, CheckIn: ${r.checkInTime}, CheckOut: ${r.checkOutTime}, Date: ${r.date}`);\n    });\n\n    console.log('=== TRYING MULTIPLE STRATEGIES TO FIND ATTENDANCE ===');\n\n    // Strategy 1: Find most recent attendance without checkout (simplest approach)\nlet attendance = await Attendance.findOne({\n  employee: employee._id,\n  $or: [\n    { checkOutTime: { $exists: false } },\n    { checkOutTime: null }\n  ]\n}).sort({ checkInTime: -1 });\n    \n    console.log('Strategy 1 (Most recent without checkout):', attendance ? attendance._id : 'NOT FOUND');\n\n    // Strategy 2: Find by today's date if Strategy 1 fails\n if (!attendance) {\n  const { startOfDay, endOfDay } = getTodayDateRange(); // ✅ Use consistent UTC range\n  \n  attendance = await Attendance.findOne({\n    employee: employee._id,\n    checkInTime: { \n      $gte: startOfDay,\n      $lt: endOfDay\n    },\n    checkOutTime: { $exists: false }\n  });\n}\n\n    // Strategy 3: Search within last 24 hours if still not found\n    if (!attendance) {\n      const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);\n      \n      attendance = await Attendance.findOne({\n        employee: employee._id,\n        checkInTime: { $gte: twentyFourHoursAgo },\n        checkOutTime: { $exists: false }\n      }).sort({ checkInTime: -1 });\n      \n      console.log('Strategy 3 (Last 24 hours):', attendance ? attendance._id : 'NOT FOUND');\n    }\n\n    // If still no attendance found, provide detailed debugging\n    if (!attendance) {\n      console.log('=== NO ATTENDANCE FOUND - FULL DEBUG ===');\n      \n      // Get ALL records for this employee\n      const allEmployeeRecords = await Attendance.find({ \n        employee: employee._id \n      }).sort({ checkInTime: -1 }).limit(5);\n      \n      console.log('All employee records (last 5):');\n      allEmployeeRecords.forEach((record, index) => {\n        console.log(`${index + 1}:`, {\n          id: record._id.toString(),\n          date: record.date,\n          checkInTime: record.checkInTime,\n          hasCheckOut: !!record.checkOutTime,\n          checkOutTime: record.checkOutTime\n        });\n      });\n\n      return res.status(404).json({\n        success: false,\n        message: 'No check-in record found for checkout',\n        debug: {\n          employeeId: employee._id,\n          userId: req.user.id,\n          totalRecords: allEmployeeRecords.length,\n          recentRecords: allEmployeeRecords.map(r => ({\n            id: r._id.toString(),\n            date: r.date,\n            checkInTime: r.checkInTime,\n            hasCheckOut: !!r.checkOutTime\n          }))\n        }\n      });\n    }\n\n    console.log('=== FOUND ATTENDANCE RECORD ===');\n    console.log('Attendance ID:', attendance._id);\n    console.log('Check-in time:', attendance.checkInTime);\n    console.log('Current checkout status:', !!attendance.checkOutTime);\n\n    // Check if already checked out\n    if (attendance.checkOutTime) {\n      return res.status(400).json({\n        success: false,\n        message: 'Already checked out for this session',\n        data: attendance\n      });\n    }\n\n    // Perform checkout\n    const checkOutTime = new Date();\n    attendance.checkOutTime = checkOutTime;\n    \n    // Handle address - it might be an object or a string\n    let checkoutAddressString = '';\n    if (location.address) {\n      if (typeof location.address === 'object') {\n        checkoutAddressString = location.address.address || `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;\n      } else {\n        checkoutAddressString = location.address;\n      }\n    }\n    \n    attendance.checkOutLocation = {\n      latitude: location.latitude,\n      longitude: location.longitude,\n      address: checkoutAddressString,\n      accuracy: location.accuracy || 0\n    };\n    \n    // Calculate working hours in minutes\n    const timeDiff = checkOutTime - attendance.checkInTime;\n    const workingMinutes = Math.round(timeDiff / (1000 * 60));\n    attendance.workingHours = workingMinutes;\n    \n    console.log('Working time calculated:', workingMinutes, 'minutes');\n    \n    if (notes) {\n      attendance.notes = attendance.notes ? \n        `${attendance.notes}. Checkout: ${notes}` : \n        `Checkout: ${notes}`;\n    }\n\n    // Save the record\n    await attendance.save();\n    console.log('Attendance saved successfully');\n\n    // Send notification to admins about employee check-out\n    try {\n      const adminUsers = await User.find({ role: 'admin', isActive: true });\n      console.log(`Found ${adminUsers.length} active admin users for check-out notification`);\n\n      if (adminUsers.length > 0) {\n        const employeeName = `${employee.personalInfo?.firstName || 'Employee'} ${employee.personalInfo?.lastName || ''}`.trim();\n\n        const notification = await Notification.createNotification({\n          title: 'Employee Check-out',\n          message: `${employeeName} has checked out from work`,\n          type: 'info',\n          category: 'attendance',\n          targetUsers: adminUsers.map(admin => admin._id),\n          sender: req.user.id,\n          priority: 'medium',\n          relatedEntity: {\n            model: 'Attendance',\n            id: attendance._id\n          },\n          metadata: {\n            employeeName: employeeName,\n            checkOutTime: checkOutTime,\n            workingHours: workingMinutes,\n            location: location.address || 'Office Location',\n            employeeId: employee.employeeId\n          }\n        });\n\n        console.log(`✅ Check-out notification sent successfully to ${adminUsers.length} admins`);\n        console.log('Notification details:', {\n          id: notification._id,\n          title: notification.title,\n          targetUsersCount: notification.targetUsers.length\n        });\n      } else {\n        console.warn('⚠️ No active admin users found for check-out notification');\n      }\n    } catch (notificationError) {\n      console.error('❌ Error sending check-out notification:', notificationError);\n      console.error('Notification error details:', {\n        message: notificationError.message,\n        stack: notificationError.stack\n      });\n      // Don't fail the check-out if notification fails\n    }\n\n    // Populate for response\n    await attendance.populate([\n      { path: 'employee', select: 'personalInfo workInfo' },\n      { path: 'user', select: 'name email employeeId' }\n    ]);\n\n    const workingTimeFormatted = attendance.getWorkingTime();\n    console.log('Working time formatted:', workingTimeFormatted);\n\n    console.log('=== CHECKOUT SUCCESS ===');\n\n    res.json({\n      success: true,\n      message: 'Checkout marked successfully',\n      data: attendance,\n      workingTime: workingTimeFormatted\n    });\n\n  } catch (error) {\n    console.error('=== CHECKOUT ERROR ===');\n    console.error('Error message:', error.message);\n    console.error('Error stack:', error.stack);\n    \n    res.status(500).json({\n      success: false,\n      message: 'Server error while marking checkout',\n      error: error.message\n    });\n  }\n};\n\n// @desc    Combined face and location validation for attendance\n// @route   POST /api/attendance/checkin-with-face\n// @access  Private (Employee)\nexport const checkInWithFace = async (req, res) => {\n  try {\n    const { faceDescriptor, location, deviceInfo, notes } = req.body;\n    console.log('Combined check-in request:', { userId: req.user.id, hasFaceDescriptor: !!faceDescriptor, hasLocation: !!location });\n\n    // Validate input data\n    if (!faceDescriptor || !Array.isArray(faceDescriptor) || faceDescriptor.length !== 512) {\n      return res.status(400).json({\n        success: false,\n        message: 'Invalid face descriptor. Must be array of 512 numbers.',\n        validation: {\n          face: false,\n          location: false\n        },\n        errors: ['Face descriptor is required and must be valid']\n      });\n    }\n\n    if (!location || !location.latitude || !location.longitude) {\n      return res.status(400).json({\n        success: false,\n        message: 'Location data is required for attendance',\n        validation: {\n          face: false,\n          location: false\n        },\n        errors: ['Location data is required']\n      });\n    }\n\n    // Get employee record\n    const employee = await Employee.findOne({ user: req.user.id });\n    if (!employee) {\n      console.log('Employee not found for user:', req.user.id);\n      return res.status(404).json({\n        success: false,\n        message: 'Employee record not found',\n        validation: {\n          face: false,\n          location: false\n        },\n        errors: ['Employee record not found']\n      });\n    }\n\n    console.log('Employee found:', employee._id);\n\n    // Check if employee has registered face\n    if (!employee.hasFaceRegistered || !employee.faceDescriptor) {\n      return res.status(400).json({\n        success: false,\n        message: 'No face registered for this employee. Please register your face first.',\n        validation: {\n          face: false,\n          location: false\n        },\n        errors: ['Face not registered for this employee']\n      });\n    }\n\n    // Step 1: Validate location\n    const distance = calculateDistance(\n      location.latitude,\n      location.longitude,\n      OFFICE_LOCATION.latitude,\n      OFFICE_LOCATION.longitude\n    );\n\n    const locationValid = distance <= OFFICE_LOCATION.radius;\n    console.log('Location validation:', { distance: Math.round(distance), radius: OFFICE_LOCATION.radius, valid: locationValid });\n\n    if (!locationValid) {\n      return res.status(400).json({\n        success: false,\n        message: `You are not within office premises (Distance: ${Math.round(distance)}m, Required: ${OFFICE_LOCATION.radius}m)`,\n        validation: {\n          face: false,\n          location: false\n        },\n        errors: [`Location validation failed: Distance ${Math.round(distance)}m exceeds office radius ${OFFICE_LOCATION.radius}m`]\n      });\n    }\n\n    // Step 2: Verify face\n    const registeredDescriptor = employee.faceDescriptor;\n    const currentDescriptor = faceDescriptor;\n\n\t    // Cosine similarity\n\t    const dotProduct = registeredDescriptor.reduce((sum, val, i) => sum + val * currentDescriptor[i], 0);\n\t    const mag1 = Math.sqrt(registeredDescriptor.reduce((sum, val) => sum + val * val, 0));\n\t    const mag2 = Math.sqrt(currentDescriptor.reduce((sum, val) => sum + val * val, 0));\n\t    const similarity = dotProduct / (mag1 * mag2);\n\n\t    // Shared threshold for cosine similarity (higher = stricter).\n\t    // Kept in sync with the FACE_SIMILARITY_THRESHOLD used by the\n\t    // Python face_service for consistent behaviour across flows.\n\t    const threshold = FACE_SIMILARITY_THRESHOLD;\n\t    const faceMatch = similarity > threshold;\n\n    console.log('Face verification result:', {\n      userId: req.user.id,\n      similarity: similarity.toFixed(4),\n      threshold,\n      match: faceMatch\n    });\n\n    if (!faceMatch) {\n      return res.status(400).json({\n        success: false,\n        message: `Face not recognized. Similarity: ${similarity.toFixed(4)} (Required: >${threshold})`,\n        validation: {\n          face: false,\n          location: true\n        },\n        errors: [`Face verification failed: Similarity ${similarity.toFixed(4)} below threshold ${threshold}`]\n      });\n    }\n\n    // Step 3: Both validations passed - check if attendance already marked for today\n    const { startOfDay, endOfDay } = getTodayDateRange();\n    console.log('Checking attendance for date range:', { startOfDay, endOfDay });\n\n    const existingAttendance = await Attendance.findOne({\n      employee: employee._id,\n      $or: [\n        {\n          date: {\n            $gte: startOfDay,\n            $lte: endOfDay\n          }\n        },\n        {\n          checkInTime: {\n            $gte: startOfDay,\n            $lte: endOfDay\n          }\n        }\n      ]\n    });\n\n    if (existingAttendance) {\n      console.log('Existing attendance found:', existingAttendance);\n      return res.status(400).json({\n        success: false,\n        message: 'Attendance already marked for today',\n        validation: {\n          face: true,\n          location: true\n        },\n        errors: ['Attendance already marked for today'],\n        data: existingAttendance\n      });\n    }\n\n    // Step 4: Create attendance record\n    const checkInTime = new Date();\n    const localDate = new Date(checkInTime.toISOString().split('T')[0] + 'T00:00:00Z');\n\n    // Handle address - it might be an object or a string\n    let faceAddressString = '';\n    if (location.address) {\n      if (typeof location.address === 'object') {\n        faceAddressString = location.address.address || `${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}`;\n      } else {\n        faceAddressString = location.address;\n      }\n    }\n\n    const attendance = new Attendance({\n      employee: employee._id,\n      user: req.user.id,\n      checkInTime: checkInTime,\n      date: localDate,\n      checkInLocation: {\n        latitude: location.latitude,\n        longitude: location.longitude,\n        address: faceAddressString,\n        accuracy: location.accuracy || 0\n      },\n      notes: notes || 'Check-in via web application with dual face and location verification',\n      ipAddress: req.ip,\n      deviceInfo: deviceInfo || {\n        userAgent: req.headers['user-agent'],\n        platform: 'Web',\n        browser: 'Unknown'\n      },\n      // Add metadata about dual validation\n      validationMethod: 'face_and_location',\n      faceVerification: {\n        similarity: similarity.toFixed(4),\n        threshold,\n        verifiedAt: checkInTime\n      }\n    });\n\n    console.log('Creating attendance record with dual validation:', {\n      employee: employee._id,\n      date: localDate,\n      checkInTime: checkInTime,\n      validationMethod: 'face_and_location'\n    });\n\n    await attendance.save();\n    console.log('Attendance saved successfully:', attendance._id);\n\n    // Populate employee and user data\n    await attendance.populate([\n      { path: 'employee', select: 'personalInfo workInfo' },\n      { path: 'user', select: 'name email employeeId' }\n    ]);\n\n    res.status(201).json({\n      success: true,\n      message: 'Attendance marked successfully with dual validation',\n      data: attendance,\n      validation: {\n        face: true,\n        location: true\n      },\n      details: {\n        faceSimilarity: similarity.toFixed(4),\n        locationDistance: Math.round(distance),\n        officeRadius: OFFICE_LOCATION.radius\n      }\n    });\n\n  } catch (error) {\n    console.error('Combined check-in error:', error);\n\n    if (error.code === 11000) {\n      return res.status(400).json({\n        success: false,\n        message: 'Attendance already marked for today',\n        validation: {\n          face: false,\n          location: false\n        },\n        errors: ['Attendance already marked for today']\n      });\n    }\n\n    res.status(500).json({\n      success: false,\n      message: 'Server error while marking attendance with dual validation',\n      validation: {\n        face: false,\n        location: false\n      },\n      errors: [error.message]\n    });\n  }\n};\n\n// @desc    Verify face for attendance\n// @route   POST /api/attendance/verify-face\n// @access  Private (Employee)\nexport const verifyFace = async (req, res) => {\n  try {\n    const { faceDescriptor } = req.body;\n\n    // Validate input - face-api.js uses 128 dimensions\n    if (!faceDescriptor || !Array.isArray(faceDescriptor) || faceDescriptor.length !== 128) {\n      return res.status(400).json({\n        success: false,\n        message: `Invalid face descriptor. Must be array of 128 numbers (received ${faceDescriptor?.length || 0}).`\n      });\n    }\n\n    // Get employee record\n    const employee = await Employee.findOne({ user: req.user.id });\n    if (!employee) {\n      return res.status(404).json({\n        success: false,\n        message: 'Employee record not found'\n      });\n    }\n\n    // Check if employee has registered face\n    if (!employee.hasFaceRegistered || !employee.faceDescriptor) {\n      return res.status(400).json({\n        success: false,\n        message: 'No face registered for this employee'\n      });\n    }\n\n    // Calculate similarity (cosine similarity)\n    const registeredDescriptor = employee.faceDescriptor;\n    const currentDescriptor = faceDescriptor;\n\n\t    // Cosine similarity\n\t    const dotProduct = registeredDescriptor.reduce((sum, val, i) => sum + val * currentDescriptor[i], 0);\n\t    const mag1 = Math.sqrt(registeredDescriptor.reduce((sum, val) => sum + val * val, 0));\n\t    const mag2 = Math.sqrt(currentDescriptor.reduce((sum, val) => sum + val * val, 0));\n\t    const similarity = dotProduct / (mag1 * mag2);\n\n\t    // Shared threshold for cosine similarity (higher = stricter).\n\t    // Kept in sync with the FACE_SIMILARITY_THRESHOLD used by the\n\t    // Python face_service for consistent behaviour across flows.\n\t    const threshold = FACE_SIMILARITY_THRESHOLD;\n\t    const match = similarity > threshold;\n\n    console.log('Face verification result:', {\n      userId: req.user.id,\n      similarity: similarity.toFixed(4),\n      threshold,\n      match\n    });\n\n    res.json({\n      success: true,\n      match,\n      similarity: similarity.toFixed(4)\n    });\n\n  } catch (error) {\n    console.error('Face verification error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error during face verification',\n      error: error.message\n    });\n  }\n};\n// @desc    Get today's attendance status\n// @route   GET /api/attendance/today\n// @access  Private (Employee)\nexport const getTodayAttendance = async (req, res) => {\n  try {\n    console.log('Getting today attendance for employee:', req.employee._id);\n\n    const { startOfDay, endOfDay } = getTodayDateRange();\n    console.log('Date range for today:', { startOfDay, endOfDay });\n\n    // Try multiple query strategies\n    let attendance = await Attendance.findOne({\n      employee: req.employee._id,\n      date: {\n        $gte: startOfDay,\n        $lte: endOfDay\n      }\n    }).populate([\n      { path: 'employee', select: 'personalInfo workInfo' },\n      { path: 'user', select: 'name email employeeId' }\n    ]);\n\n    if (!attendance) {\n      attendance = await Attendance.findOne({\n        employee: req.employee._id,\n        checkInTime: {\n          $gte: startOfDay,\n          $lte: endOfDay\n        }\n      }).populate([\n        { path: 'employee', select: 'personalInfo workInfo' },\n        { path: 'user', select: 'name email employeeId' }\n      ]);\n    }\n\n    console.log('Found attendance:', attendance ? attendance._id : 'none');\n\n    res.json({\n      success: true,\n      data: attendance,\n      hasCheckedIn: !!attendance,\n      hasCheckedOut: !!(attendance && attendance.checkOutTime),\n      workingTime: attendance ? attendance.getWorkingTime() : null\n    });\n\n  } catch (error) {\n    console.error('Get today attendance error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching today\\'s attendance',\n      error: error.message\n    });\n  }\n};\n\n// Keep all other functions the same as the previous fixed version\n// ... (getAllAttendance, getAttendanceSummary, etc.)\n\nexport const getAttendanceHistory = async (req, res) => {\n  try {\n    const { startDate, endDate, page = 1, limit = 10 } = req.query;\n\n    // Build date filter\n    let dateFilter = { employee: req.employee._id };\n    \n    if (startDate && endDate) {\n      dateFilter.date = {\n        $gte: new Date(startDate),\n        $lte: new Date(endDate)\n      };\n    } else {\n      // Default to current month\n      const now = new Date();\n      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n      const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);\n      dateFilter.date = { $gte: startOfMonth, $lte: endOfMonth };\n    }\n\n    // Get paginated attendance records\n    const skip = (parseInt(page) - 1) * parseInt(limit);\n    \n    const attendance = await Attendance.find(dateFilter)\n      .populate('employee', 'personalInfo workInfo')\n      .populate('user', 'name email employeeId')\n      .sort({ date: -1 })\n      .limit(parseInt(limit))\n      .skip(skip);\n\n    // Get total count for pagination\n    const total = await Attendance.countDocuments(dateFilter);\n\n    // Get attendance summary\n    const summaryDateRange = startDate && endDate ?\n      { $gte: new Date(startDate), $lte: new Date(endDate) } :\n      dateFilter.date;\n\n    const summary = await Attendance.getAttendanceSummary(\n      req.employee._id,\n      summaryDateRange.$gte,\n      summaryDateRange.$lte\n    );\n\n    res.json({\n      success: true,\n      data: attendance,\n      pagination: {\n        current: parseInt(page),\n        pages: Math.ceil(total / parseInt(limit)),\n        total\n      },\n      summary: summary[0] || {\n        totalDays: 0,\n        presentDays: 0,\n        lateDays: 0,\n        halfDays: 0,\n        totalWorkingMinutes: 0\n      }\n    });\n\n  } catch (error) {\n    console.error('Get attendance history error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching attendance history'\n    });\n  }\n};\n\nexport const getAllAttendance = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { \n      startDate, \n      endDate, \n      employeeId, \n      department, \n      status, \n      page = 1, \n      limit = 20,\n      search \n    } = req.query;\n\n    // Build filter\n    let filter = {};\n\n    // Date filter - use proper date range\n    if (startDate && endDate) {\n      const start = new Date(startDate);\n      const end = new Date(endDate);\n      end.setHours(23, 59, 59, 999);\n      \n      filter.date = {\n        $gte: start,\n        $lte: end\n      };\n    } else {\n      // Default to current month\n      const now = new Date();\n      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);\n      const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);\n      endOfMonth.setHours(23, 59, 59, 999);\n      \n      filter.date = { $gte: startOfMonth, $lte: endOfMonth };\n    }\n\n    // Employee filter\n    if (employeeId) {\n      filter.employee = new mongoose.Types.ObjectId(employeeId);\n    }\n\n    // Status filter\n    if (status) {\n      filter.status = status;\n    }\n\n    // Build aggregation pipeline\n    let pipeline = [\n      { $match: filter },\n      {\n        $lookup: {\n          from: 'employees',\n          localField: 'employee',\n          foreignField: '_id',\n          as: 'employeeData'\n        }\n      },\n      {\n        $lookup: {\n          from: 'users',\n          localField: 'user',\n          foreignField: '_id',\n          as: 'userData'\n        }\n      },\n      { $unwind: '$employeeData' },\n      { $unwind: '$userData' }\n    ];\n\n    // Department filter\n    if (department) {\n      pipeline.push({\n        $match: {\n          'employeeData.workInfo.department': department\n        }\n      });\n    }\n\n    // Search filter\n    if (search) {\n      pipeline.push({\n        $match: {\n          $or: [\n            { 'employeeData.personalInfo.firstName': { $regex: search, $options: 'i' } },\n            { 'employeeData.personalInfo.lastName': { $regex: search, $options: 'i' } },\n            { 'userData.employeeId': { $regex: search, $options: 'i' } }\n          ]\n        }\n      });\n    }\n\n    // Add sorting\n    pipeline.push({ $sort: { date: -1, checkInTime: -1 } });\n\n    // Get total count\n    const countPipeline = [...pipeline, { $count: 'total' }];\n    const countResult = await Attendance.aggregate(countPipeline);\n    const total = countResult[0]?.total || 0;\n\n    // Add pagination\n    const skip = (parseInt(page) - 1) * parseInt(limit);\n    pipeline.push(\n      { $skip: skip },\n      { $limit: parseInt(limit) }\n    );\n\n    // Execute aggregation\n    const attendance = await Attendance.aggregate(pipeline);\n\n    // Get statistics\n    const stats = await Attendance.aggregate([\n      { $match: filter },\n      {\n        $group: {\n          _id: null,\n          totalRecords: { $sum: 1 },\n          presentCount: { $sum: { $cond: [{ $eq: ['$status', 'Present'] }, 1, 0] } },\n          lateCount: { $sum: { $cond: [{ $eq: ['$status', 'Late'] }, 1, 0] } },\n          halfDayCount: { $sum: { $cond: [{ $eq: ['$status', 'Half Day'] }, 1, 0] } },\n          avgWorkingHours: { $avg: '$workingHours' }\n        }\n      }\n    ]);\n\n    res.json({\n      success: true,\n      data: attendance,\n      pagination: {\n        current: parseInt(page),\n        pages: Math.ceil(total / parseInt(limit)),\n        total\n      },\n      statistics: stats[0] || {\n        totalRecords: 0,\n        presentCount: 0,\n        lateCount: 0,\n        halfDayCount: 0,\n        avgWorkingHours: 0\n      }\n    });\n\n  } catch (error) {\n    console.error('Get all attendance error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching attendance records'\n    });\n  }\n};\n\nexport const getAttendanceSummary = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { date } = req.query;\n    const targetDate = date ? new Date(date) : new Date();\n    \n    // Get start and end of the target date\n    const startOfDay = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());\n    const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000);\n\n    console.log('Getting attendance summary for:', { startOfDay, endOfDay });\n\n    // Get today's attendance summary\n    const todayStats = await Attendance.aggregate([\n      {\n        $match: {\n          date: { \n            $gte: startOfDay, \n            $lt: endOfDay \n          }\n        }\n      },\n      {\n        $group: {\n          _id: '$status',\n          count: { $sum: 1 }\n        }\n      }\n    ]);\n\n    console.log('Today stats:', todayStats);\n\n    // Get total active employees\n    const totalEmployees = await Employee.countDocuments({ \n      $or: [\n        { status: 'Active' },\n        { status: { $exists: false } } \n      ]\n    });\n\n    console.log('Total employees:', totalEmployees);\n\n    // Format stats\n    const stats = {\n      totalEmployees,\n      present: 0,\n      late: 0,\n      halfDay: 0,\n      absent: 0,\n      workFromHome: 0\n    };\n\n    todayStats.forEach(stat => {\n      switch (stat._id) {\n        case 'Present':\n          stats.present = stat.count;\n          break;\n        case 'Late':\n          stats.late = stat.count;\n          break;\n        case 'Half Day':\n          stats.halfDay = stat.count;\n          break;\n        case 'Work from Home':\n          stats.workFromHome = stat.count;\n          break;\n      }\n    });\n\n    // Calculate absent employees\n    const totalPresent = stats.present + stats.late + stats.halfDay + stats.workFromHome;\n    stats.absent = Math.max(0, totalEmployees - totalPresent);\n\n    // Get department-wise attendance\n    const departmentStats = await Attendance.aggregate([\n      {\n        $match: {\n          date: { \n            $gte: startOfDay, \n            $lt: endOfDay \n          }\n        }\n      },\n      {\n        $lookup: {\n          from: 'employees',\n          localField: 'employee',\n          foreignField: '_id',\n          as: 'employeeData'\n        }\n      },\n      { $unwind: '$employeeData' },\n      {\n        $group: {\n          _id: '$employeeData.workInfo.department',\n          present: { $sum: { $cond: [{ $eq: ['$status', 'Present'] }, 1, 0] } },\n          late: { $sum: { $cond: [{ $eq: ['$status', 'Late'] }, 1, 0] } },\n          total: { $sum: 1 }\n        }\n      }\n    ]);\n\n    console.log('Final stats:', stats);\n\n    res.json({\n      success: true,\n      data: {\n        date: targetDate,\n        overallStats: stats,\n        departmentStats\n      }\n    });\n\n  } catch (error) {\n    console.error('Get attendance summary error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching attendance summary'\n    });\n  }\n};\n\nexport const updateAttendance = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { id } = req.params;\n    const { status, notes, isManualEntry, manualEntryReason } = req.body;\n\n    const attendance = await Attendance.findById(id);\n    if (!attendance) {\n      return res.status(404).json({\n        success: false,\n        message: 'Attendance record not found'\n      });\n    }\n\n    // Update fields\n    if (status) attendance.status = status;\n    if (notes) attendance.notes = notes;\n    if (isManualEntry !== undefined) attendance.isManualEntry = isManualEntry;\n    if (manualEntryReason) attendance.manualEntryReason = manualEntryReason;\n    \n    attendance.approvedBy = req.user.id;\n\n    await attendance.save();\n\n    // Populate and return updated record\n    await attendance.populate([\n      { path: 'employee', select: 'personalInfo workInfo' },\n      { path: 'user', select: 'name email employeeId' },\n      { path: 'approvedBy', select: 'name email' }\n    ]);\n\n    res.json({\n      success: true,\n      message: 'Attendance record updated successfully',\n      data: attendance\n    });\n\n  } catch (error) {\n    console.error('Update attendance error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while updating attendance record'\n    });\n  }\n};\n\nexport const deleteAttendance = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { id } = req.params;\n\n    const attendance = await Attendance.findById(id);\n    if (!attendance) {\n      return res.status(404).json({\n        success: false,\n        message: 'Attendance record not found'\n      });\n    }\n\n    await attendance.deleteOne();\n\n    res.json({\n      success: true,\n      message: 'Attendance record deleted successfully'\n    });\n\n  } catch (error) {\n    console.error('Delete attendance error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while deleting attendance record'\n    });\n  }\n};\n\n","path":null,"size_bytes":39832,"size_tokens":null},"frontend/src/pages/Admin/EmployeeManagement.jsx":{"content":"import React, { useState, useEffect, useRef } from 'react';\nimport { employeeAPI, departmentAPI } from '../../utils/api';\nimport AdminLayout from '../../components/Admin/layout/AdminLayout';\nimport { faceAPI, cameraHelper } from '../../utils/faceAPI';\nimport {\n  Plus,\n  Search,\n  Filter,\n  Edit,\n  Eye,\n  Trash2,\n  Mail,\n  User,\n  X,\n  Save,\n  UserPlus,\n  AlertCircle,\n  CheckCircle,\n  Camera\n} from 'lucide-react';\nimport toast from 'react-hot-toast';\n\n\n// ================================\n// EXTRACTED AddEmployeeModal Component\n// ================================\nconst AddEmployeeModal = ({\n  show,\n  onClose,\n  currentStep,\n  setCurrentStep,\n  newEmployee,\n  setNewEmployee,\n  departments,\n  faceRegistrationEnabled,\n  setFaceRegistrationEnabled,\n  modelsLoaded,\n  faceDetected,\n  isScanning,\n  capturedFaceData,\n  setCapturedFaceData,\n  capturedDescriptors,\n  setCapturedDescriptors,\n  posesCaptured,\n  setPosesCaptured,\n  videoRef,\n  canvasRef,\n  startCamera,\n  captureCurrentPose,\n  handleCreateEmployee,\n  handleFormNext,\n  resetForm\n}) => {\n  const updateEmployee = (field, value, nestedField = null, subNestedField = null) => {\n    if (subNestedField) {\n      setNewEmployee(prev => ({\n        ...prev,\n        [field]: {\n          ...prev[field],\n          [nestedField]: {\n            ...prev[field][nestedField],\n            [subNestedField]: value\n          }\n        }\n      }));\n    } else if (nestedField) {\n      setNewEmployee(prev => ({\n        ...prev,\n        [field]: {\n          ...prev[field],\n          [nestedField]: value\n        }\n      }));\n    } else {\n      setNewEmployee(prev => ({\n        ...prev,\n        [field]: value\n      }));\n    }\n  };\n  const genders = ['Male', 'Female', 'Other'];\n  const bloodGroups = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'];\n  const maritalStatuses = ['Single', 'Married', 'Divorced', 'Widowed'];\n  const employmentTypes = ['Full-time', 'Part-time', 'Contract', 'Intern'];\n  const workLocations = ['Office', 'Remote', 'Hybrid'];\n  const workShifts = ['Morning', 'Afternoon', 'Evening', 'Night', 'Flexible'];\n  const accountTypes = ['Savings', 'Current'];\n  if (!show) return null;\n  const POSES = [\n    { name: 'front', instruction: 'Look straight ahead at the camera. Keep your head level.', emoji: '�️' }\n  ];\n  const currentPoseIndex = posesCaptured.length;\n  const currentPose = currentPoseIndex < POSES.length ? POSES[currentPoseIndex] : null;\n  return (\n    <div className=\"fixed inset-0 z-[9999] flex items-center justify-center p-2 sm:p-4\">\n      {/* Enhanced backdrop with blur - Click to close */}\n      <div\n        className=\"fixed inset-0 bg-black/70 backdrop-blur-md\"\n        onClick={() => {\n          resetForm();\n          onClose();\n        }}\n      />\n\n      {/* Modal content - Prevent click propagation */}\n      <div\n        className=\"relative glass-morphism neon-border rounded-2xl p-3 sm:p-4 md:p-6 w-full max-w-full sm:max-w-6xl max-h-[95vh] overflow-y-auto shadow-2xl\"\n        onClick={(e) => e.stopPropagation()}\n      >\n        <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6\">\n          <div className=\"flex items-center flex-wrap gap-2\">\n            <h2 className=\"text-xl sm:text-2xl font-bold text-white\">Add New Employee</h2>\n            <div className=\"flex items-center space-x-2\">\n              <div className={`w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-xs sm:text-sm font-bold ${\n                currentStep >= 1 ? 'bg-neon-pink text-white' : 'bg-secondary-600 text-secondary-400'\n              }`}>\n                1\n              </div>\n              <div className={`w-6 h-1 ${currentStep >= 2 ? 'bg-neon-pink' : 'bg-secondary-600'}`}></div>\n              <div className={`w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-xs sm:text-sm font-bold ${\n                currentStep >= 2 ? 'bg-neon-pink text-white' : 'bg-secondary-600 text-secondary-400'\n              }`}>\n                2\n              </div>\n            </div>\n          </div>\n          <div className=\"flex items-center space-x-2\">\n            <div className=\"flex items-center space-x-2 text-xs sm:text-sm text-green-400\">\n              <Camera className=\"w-4 h-4\" />\n              <span>Face Registration Required</span>\n            </div>\n            <button\n              onClick={() => {\n                resetForm();\n                onClose();\n              }}\n              className=\"text-secondary-400 hover:text-white transition-colors\"\n              aria-label=\"Close modal\"\n              type=\"button\"\n            >\n              <X className=\"w-5 h-5 sm:w-6 sm:h-6\" />\n            </button>\n          </div>\n        </div>\n        {currentStep === 1 ? (\n          <form onSubmit={handleFormNext} className=\"space-y-6 sm:space-y-8\">\n            {/* Personal Information */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-base sm:text-lg font-bold text-white border-b border-secondary-600 pb-2\">Personal Information</h3>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4\">\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">First Name *</label>\n                  <input\n                    type=\"text\"\n                    value={newEmployee.personalInfo.firstName}\n                    onChange={(e) => updateEmployee('personalInfo', e.target.value, 'firstName')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Last Name *</label>\n                  <input\n                    type=\"text\"\n                    value={newEmployee.personalInfo.lastName}\n                    onChange={(e) => updateEmployee('personalInfo', e.target.value, 'lastName')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Date of Birth *</label>\n                  <input\n                    type=\"date\"\n                    value={newEmployee.personalInfo.dateOfBirth}\n                    onChange={(e) => updateEmployee('personalInfo', e.target.value, 'dateOfBirth')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Gender *</label>\n                  <select\n                    value={newEmployee.personalInfo.gender}\n                    onChange={(e) => updateEmployee('personalInfo', e.target.value, 'gender')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  >\n                    <option value=\"\">Select Gender</option>\n                    {genders.map(gender => (\n                      <option key={gender} value={gender}>{gender}</option>\n                    ))}\n                  </select>\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Blood Group</label>\n                  <select\n                    value={newEmployee.personalInfo.bloodGroup}\n                    onChange={(e) => updateEmployee('personalInfo', e.target.value, 'bloodGroup')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  >\n                    <option value=\"\">Select Blood Group</option>\n                    {bloodGroups.map(bg => (\n                      <option key={bg} value={bg}>{bg}</option>\n                    ))}\n                  </select>\n                </div>\n              </div>\n            </div>\n            {/* Contact Information */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-base sm:text-lg font-bold text-white border-b border-secondary-600 pb-2\">Contact Information</h3>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4\">\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Email *</label>\n                  <input\n                    type=\"email\"\n                    value={newEmployee.contactInfo.personalEmail}\n                    onChange={(e) => updateEmployee('contactInfo', e.target.value, 'personalEmail')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Phone *</label>\n                  <input\n                    type=\"tel\"\n                    value={newEmployee.contactInfo.phone}\n                    onChange={(e) => updateEmployee('contactInfo', e.target.value, 'phone')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  />\n                </div>\n                <div className=\"sm:col-span-2\">\n                  <h4 className=\"text-sm sm:text-md font-semibold text-white mb-2 sm:mb-3\">Emergency Contact</h4>\n                  <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4\">\n                    <div>\n                      <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Name *</label>\n                      <input\n                        type=\"text\"\n                        value={newEmployee.contactInfo.emergencyContact.name}\n                        onChange={(e) => updateEmployee('contactInfo', e.target.value, 'emergencyContact', 'name')}\n                        className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                        required\n                      />\n                    </div>\n                    <div>\n                      <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Relationship *</label>\n                      <input\n                        type=\"text\"\n                        value={newEmployee.contactInfo.emergencyContact.relationship}\n                        onChange={(e) => updateEmployee('contactInfo', e.target.value, 'emergencyContact', 'relationship')}\n                        className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                        required\n                      />\n                    </div>\n                    <div>\n                      <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Phone *</label>\n                      <input\n                        type=\"tel\"\n                        value={newEmployee.contactInfo.emergencyContact.phone}\n                        onChange={(e) => updateEmployee('contactInfo', e.target.value, 'emergencyContact', 'phone')}\n                        className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                        required\n                      />\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n            {/* Work Information */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-base sm:text-lg font-bold text-white border-b border-secondary-600 pb-2\">Work Information</h3>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4\">\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Position *</label>\n                  <input\n                    type=\"text\"\n                    value={newEmployee.workInfo.position}\n                    onChange={(e) => updateEmployee('workInfo', e.target.value, 'position')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Department *</label>\n                  <select\n                    value={newEmployee.workInfo.department}\n                    onChange={(e) => updateEmployee('workInfo', e.target.value, 'department')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  >\n                    <option value=\"\">Select Department</option>\n                    {departments.map(dept => (\n                      <option key={dept._id} value={dept._id}>{dept.name}</option>\n                    ))}\n                  </select>\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Basic Salary *</label>\n                  <input\n                    type=\"number\"\n                    value={newEmployee.salaryInfo.basicSalary}\n                    onChange={(e) => updateEmployee('salaryInfo', parseFloat(e.target.value) || 0, 'basicSalary')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                    min=\"0\"\n                  />\n                </div>\n              </div>\n            </div>\n            {/* Bank Information */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-base sm:text-lg font-bold text-white border-b border-secondary-600 pb-2\">Bank Information</h3>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4\">\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Account Holder Name</label>\n                  <input\n                    type=\"text\"\n                    value={newEmployee.bankInfo.accountHolderName}\n                    onChange={(e) => updateEmployee('bankInfo', e.target.value, 'accountHolderName')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Account Number</label>\n                  <input\n                    type=\"text\"\n                    value={newEmployee.bankInfo.accountNumber}\n                    onChange={(e) => updateEmployee('bankInfo', e.target.value, 'accountNumber')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Bank Name</label>\n                  <input\n                    type=\"text\"\n                    value={newEmployee.bankInfo.bankName}\n                    onChange={(e) => updateEmployee('bankInfo', e.target.value, 'bankName')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Branch Name</label>\n                  <input\n                    type=\"text\"\n                    value={newEmployee.bankInfo.branchName}\n                    onChange={(e) => updateEmployee('bankInfo', e.target.value, 'branchName')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">IFSC Code</label>\n                  <input\n                    type=\"text\"\n                    value={newEmployee.bankInfo.ifscCode}\n                    onChange={(e) => updateEmployee('bankInfo', e.target.value.toUpperCase(), 'ifscCode')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Account Type</label>\n                  <select\n                    value={newEmployee.bankInfo.accountType}\n                    onChange={(e) => updateEmployee('bankInfo', e.target.value, 'accountType')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  >\n                    <option value=\"Savings\">Savings</option>\n                    <option value=\"Current\">Current</option>\n                  </select>\n                </div>\n              </div>\n            </div>\n            <div className=\"flex flex-col sm:flex-row justify-end gap-3 pt-6 border-t border-secondary-600\">\n              <button\n                type=\"button\"\n                onClick={() => {\n                  resetForm();\n                  onClose();\n                }}\n                className=\"px-4 sm:px-6 py-2.5 sm:py-3 border border-secondary-600 text-secondary-300 text-sm rounded-lg hover:bg-secondary-700/50 transition-colors\"\n              >\n                Cancel\n              </button>\n              <button\n                type=\"submit\"\n                className=\"px-4 sm:px-6 py-2.5 sm:py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold text-sm rounded-lg hover-glow transition-all duration-300\"\n              >\n                Next: Face Registration\n              </button>\n            </div>\n          </form>\n        ) : (\n          <div className=\"space-y-6\">\n            <div className=\"text-center\">\n              <h3 className=\"text-lg font-bold text-white mb-2\">\n                Face Registration for {newEmployee.personalInfo.firstName} {newEmployee.personalInfo.lastName}\n              </h3>\n              <p className=\"text-secondary-400 text-sm\">Position your face directly in front of the camera</p>\n            </div>\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6\">\n              {/* Camera Feed */}\n              <div className=\"space-y-3 sm:space-y-4\">\n                <div className=\"relative bg-black rounded-lg overflow-hidden aspect-video max-h-[300px] sm:max-h-[360px] w-full\">\n                  <video\n                    ref={videoRef}\n                    width=\"640\"\n                    height=\"480\"\n                    className=\"w-full h-full object-cover\"\n                    autoPlay\n                    muted\n                    playsInline\n                  />\n                  <canvas\n                    ref={canvasRef}\n                    width=\"640\"\n                    height=\"480\"\n                    className=\"absolute top-0 left-0 w-full h-full\"\n                  />\n                  {!modelsLoaded && (\n                    <div className=\"absolute inset-0 bg-black/50 flex items-center justify-center\">\n                      <div className=\"text-white text-center\">\n                        <div className=\"animate-spin rounded-full h-6 w-6 sm:h-8 sm:w-8 border-b-2 border-neon-pink mx-auto mb-1 sm:mb-2\"></div>\n                        <p className=\"text-xs sm:text-sm\">Loading face models... (one-time setup)</p>\n                      </div>\n                    </div>\n                  )}\n                </div>\n                <div className=\"flex items-center justify-between p-2.5 sm:p-3 bg-secondary-800/50 rounded-lg\">\n                  <div className=\"flex items-center space-x-2\">\n                    <div className={`w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-full ${faceDetected ? 'bg-green-400' : 'bg-red-400'} animate-pulse`}></div>\n                    <span className=\"text-xs sm:text-sm text-secondary-400\">\n                      {faceDetected ? 'Face detected - Ready to capture' : 'No face detected - Position face in frame'}\n                    </span>\n                  </div>\n                  <div className=\"text-[10px] sm:text-xs text-secondary-500\">\n                    {modelsLoaded ? 'Models ready' : 'Loading...'}\n                  </div>\n                </div>\n              </div>\n              {/* Instructions & Actions */}\n              <div className=\"space-y-4 sm:space-y-6\">\n                {/* Pose Progress */}\n                {posesCaptured.length > 0 && (\n                  <div className=\"bg-secondary-800/30 rounded-lg p-3 sm:p-4\">\n                    <div className=\"flex items-center space-x-2 sm:space-x-3 mb-2 sm:mb-3\">\n                      <CheckCircle className=\"w-4 h-4 sm:w-5 sm:h-5 text-green-400\" />\n                      <span className=\"text-sm sm:text-white font-medium\">Face Captured Successfully!</span>\n                    </div>\n                    <div className=\"grid grid-cols-1 gap-1.5 sm:gap-2 mb-2 sm:mb-3\">\n                      {POSES.map(pose => (\n                        <div key={pose.name} className={`text-center p-1.5 sm:p-2 rounded text-[10px] sm:text-xs font-medium ${\n                          posesCaptured.includes(pose.name)\n                            ? 'bg-green-400/20 text-green-400'\n                            : 'bg-secondary-700 text-secondary-400'\n                        }`}>\n                          {pose.name === 'up' ? 'Top' : pose.name.charAt(0).toUpperCase() + pose.name.slice(1)}\n                        </div>\n                      ))}\n                    </div>\n                    {capturedDescriptors.length > 0 && (\n                      <div className=\"grid grid-cols-1 gap-1.5 sm:gap-2\">\n                        {capturedDescriptors.map((faceData, index) => (\n                          <div key={index} className=\"text-center\">\n                            <img\n                              src={faceData.thumbnail}\n                              alt={`Front face`}\n                              className=\"w-20 h-20 sm:w-24 sm:h-24 rounded object-cover border border-secondary-600 mx-auto mb-1\"\n                            />\n                            <p className=\"text-[10px] sm:text-xs text-secondary-400\">Front Face</p>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                )}\n                {/* Dynamic Instruction */}\n                <div className=\"bg-secondary-800/30 rounded-lg p-3 sm:p-4\">\n                  <div className=\"text-center mb-3 sm:mb-4\">\n                    <div className=\"text-xl sm:text-2xl font-bold text-neon-pink mb-1 sm:mb-2\">\n                      {currentPose \n                        ? `${currentPose.emoji} ${currentPose.instruction}` \n                        : '✅ All poses captured!'}\n                    </div>\n                    <p className=\"text-secondary-300 text-xs sm:text-sm\">\n                      {currentPose \n                        ? 'Position your face as shown, then click “Capture This Pose”' \n                        : 'Face registration complete!'}\n                    </p>\n                  </div>\n                  <div className=\"flex justify-center space-x-1.5 sm:space-x-2 mb-2 sm:mb-3\">\n                    {POSES.map((pose, index) => (\n                      <div key={pose.name} className={`w-2 h-2 sm:w-3 sm:h-3 rounded-full transition-colors ${\n                        posesCaptured.includes(pose.name) ? 'bg-green-400' :\n                        posesCaptured.length === index ? 'bg-neon-pink animate-pulse' : 'bg-secondary-600'\n                      }`} />\n                    ))}\n                  </div>\n                  <div className=\"text-center text-[10px] sm:text-xs text-secondary-400\">\n                    {posesCaptured.length > 0 ? 'Face captured!' : 'Ready to capture'}\n                  </div>\n                </div>\n                {!capturedFaceData ? (\n                  <button\n                    onClick={captureCurrentPose}\n                    disabled={isScanning || posesCaptured.length >= 1}\n                    className=\"w-full py-3 sm:py-4 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold text-sm rounded-lg hover-glow transition-all duration-300 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed\"\n                  >\n                    <Camera className=\"w-4 h-4 sm:w-5 sm:h-5\" />\n                    <span>{isScanning ? 'Capturing...' : 'Capture This Pose'}</span>\n                  </button>\n                ) : (\n                  <button\n                    onClick={() => {\n                      setCapturedFaceData(null);\n                      setCapturedDescriptors([]);\n                      setPosesCaptured([]);\n                      startCamera();\n                    }}\n                    className=\"w-full py-2.5 sm:py-3 border border-secondary-600 text-secondary-300 text-sm rounded-lg hover:bg-secondary-700/50 transition-colors flex items-center justify-center space-x-2\"\n                  >\n                    <Camera className=\"w-3 h-3 sm:w-4 sm:h-4\" />\n                    <span>Recapture Face</span>\n                  </button>\n                )}\n              </div>\n            </div>\n            <div className=\"flex flex-col sm:flex-row justify-end gap-3 pt-6 border-t border-secondary-600\">\n              <button\n                type=\"button\"\n                onClick={() => setCurrentStep(1)}\n                className=\"px-4 sm:px-6 py-2.5 sm:py-3 border border-secondary-600 text-secondary-300 text-sm rounded-lg hover:bg-secondary-700/50 transition-colors\"\n              >\n                Back\n              </button>\n              <button\n                type=\"button\"\n                onClick={handleCreateEmployee}\n                disabled={!capturedFaceData}\n                className=\"px-4 sm:px-6 py-2.5 sm:py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold text-sm rounded-lg hover-glow transition-all duration-300 flex items-center space-x-2 disabled:opacity-50\"\n              >\n                <Save className=\"w-3 h-3 sm:w-4 sm:h-4\" />\n                <span>Create Employee {capturedFaceData ? 'with Face Data' : ''}</span>\n              </button>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n\n// ================================\n// MAIN COMPONENT\n// ================================\nconst EmployeeManagement = () => {\n  const [employees, setEmployees] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [filterDepartment, setFilterDepartment] = useState('');\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [showViewModal, setShowViewModal] = useState(false);\n  const [showEditModal, setShowEditModal] = useState(false);\n  const [selectedEmployee, setSelectedEmployee] = useState(null);\n  const [departments, setDepartments] = useState([]);\n  const [currentStep, setCurrentStep] = useState(1);\n  const [faceRegistrationEnabled, setFaceRegistrationEnabled] = useState(true); // Face registration is now COMPULSORY\n  const [globalModelsLoaded, setGlobalModelsLoaded] = useState(false);\n  const [faceDetected, setFaceDetected] = useState(false);\n  const [isScanning, setIsScanning] = useState(false);\n  const [capturedFaceData, setCapturedFaceData] = useState(null);\n  const [capturedDescriptors, setCapturedDescriptors] = useState([]);\n  const [posesCaptured, setPosesCaptured] = useState([]);\n  const videoRef = useRef(null);\n  const canvasRef = useRef(null);\n  const POSES = [\n    { name: 'front', instruction: 'Look straight ahead at the camera. Keep your head level.', emoji: '�️' }\n  ];\n  const [newEmployee, setNewEmployee] = useState({\n    personalInfo: {\n      firstName: '',\n      lastName: '',\n      dateOfBirth: '',\n      gender: '',\n      nationality: 'Indian',\n      maritalStatus: 'Single',\n      bloodGroup: ''\n    },\n    contactInfo: {\n      phone: '',\n      alternatePhone: '',\n      personalEmail: '',\n      address: {\n        street: '',\n        city: '',\n        state: '',\n        pincode: '',\n        country: 'India'\n      },\n      emergencyContact: {\n        name: '',\n        relationship: '',\n        phone: ''\n      }\n    },\n    workInfo: {\n      position: '',\n      department: '',\n      joiningDate: new Date().toISOString().split('T')[0],\n      employmentType: 'Full-time',\n      workLocation: 'Office',\n      team: '',\n      skills: [],\n      workShift: 'Morning'\n    },\n    salaryInfo: {\n      basicSalary: 0,\n      allowances: {\n        hra: 0,\n        medical: 0,\n        transport: 0,\n        other: 0\n      },\n      deductions: {\n        pf: 0,\n        esi: 0,\n        tax: 0,\n        other: 0\n      },\n      currency: 'INR',\n      payFrequency: 'Monthly'\n    },\n    bankInfo: {\n      accountHolderName: '',\n      accountNumber: '',\n      bankName: '',\n      branchName: '',\n      ifscCode: '',\n      accountType: 'Savings'\n    }\n  });\n\n  const startCamera = async () => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({\n        video: {\n          width: 640,\n          height: 480,\n          facingMode: 'user'\n        }\n      });\n      if (videoRef.current) {\n        videoRef.current.srcObject = stream;\n        videoRef.current.onloadedmetadata = () => {\n          videoRef.current.play();\n          startFaceDetection();\n        };\n      }\n    } catch (error) {\n      console.error('Camera access error:', error);\n      toast.error('Please allow camera access to register face');\n    }\n  };\n\n  const stopCamera = () => {\n    if (videoRef.current?.srcObject) {\n      const tracks = videoRef.current.srcObject.getTracks();\n      tracks.forEach(track => track.stop());\n      videoRef.current.srcObject = null;\n    }\n    if (videoRef.current?.detectionInterval) {\n      clearInterval(videoRef.current.detectionInterval);\n    }\n  };\n\n  // ✅ Draw unique hexagon instead of square\n  const drawHexagon = (ctx, x, y, width, height) => {\n    const centerX = x + width / 2;\n    const centerY = y + height / 2;\n    const radius = Math.max(width, height) * 0.6;\n    ctx.beginPath();\n    for (let i = 0; i < 6; i++) {\n      const angle = (Math.PI / 3) * i - Math.PI / 6;\n      const hx = centerX + radius * Math.cos(angle);\n      const hy = centerY + radius * Math.sin(angle);\n      if (i === 0) ctx.moveTo(hx, hy);\n      else ctx.lineTo(hx, hy);\n    }\n    ctx.closePath();\n  };\n\n  const startFaceDetection = async () => {\n    // Simplified face detection - just assume face is present if camera is ready\n    // This avoids the timeout issues with continuous detection\n    console.log('Face detection simplified - assuming face is present when camera is ready');\n\n    // Set face detected to true after a short delay to allow camera to initialize\n    setTimeout(() => {\n      if (videoRef.current && videoRef.current.readyState >= 2) {\n        setFaceDetected(true);\n        console.log('Camera ready - face detection enabled');\n      }\n    }, 1000);\n\n    // Optional: You can still draw a guide box without actual detection\n    if (videoRef.current && canvasRef.current) {\n      const canvas = canvasRef.current;\n      const ctx = canvas.getContext('2d');\n      if (ctx) {\n        // Draw a centered guide box\n        const centerX = canvas.width / 2;\n        const centerY = canvas.height / 2;\n        const boxWidth = canvas.width * 0.6;\n        const boxHeight = canvas.height * 0.8;\n\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\n        ctx.strokeStyle = '#00ff88';\n        ctx.lineWidth = 2;\n        ctx.setLineDash([10, 5]);\n        ctx.strokeRect(\n          centerX - boxWidth / 2,\n          centerY - boxHeight / 2,\n          boxWidth,\n          boxHeight\n        );\n        ctx.setLineDash([]);\n      }\n    }\n  };\n\n  const captureCurrentPose = async () => {\n    // Removed face detection check - we'll validate during capture instead\n    const currentPoseIndex = posesCaptured.length;\n    if (currentPoseIndex >= POSES.length) {\n      toast.error('Face already captured.');\n      return false;\n    }\n    setIsScanning(true);\n\n    // Add timeout to prevent infinite loading\n    const timeoutId = setTimeout(() => {\n      setIsScanning(false);\n      toast.error('Capture timeout. Please try again.');\n    }, 30000); // 30 second timeout\n\n    try {\n      // Capture image as base64\n      const imageBase64 = cameraHelper.captureImage(videoRef.current);\n      if (!imageBase64) {\n        clearTimeout(timeoutId);\n        toast.error('Failed to capture image. Please try again.');\n        setIsScanning(false);\n        return false;\n      }\n\n      console.log('Captured image size:', imageBase64.length, 'characters');\n\n      // Use the new analyzeFrameBase64 endpoint with error handling\n      let response;\n      try {\n        console.log('Sending request to analyze frame...');\n        response = await Promise.race([\n          faceAPI.analyzeFrameBase64(imageBase64),\n          new Promise((_, reject) =>\n            setTimeout(() => reject(new Error('Request timeout - server took too long to respond')), 25000)\n          )\n        ]);\n        console.log('Response received:', response.data);\n      } catch (apiError) {\n        clearTimeout(timeoutId);\n        console.error('API call error:', apiError);\n\n        // More specific error messages\n        if (apiError.message && apiError.message.includes('timeout')) {\n          toast.error('Request timeout. The server is taking too long. Please try again.');\n        } else if (apiError.code === 'ERR_NETWORK') {\n          toast.error('Network error. Please check if the backend server is running.');\n        } else if (apiError.response?.status === 413) {\n          toast.error('Image too large. Please try with better lighting.');\n        } else {\n          toast.error(`Error: ${apiError.message || 'Network error. Please try again.'}`);\n        }\n\n        setIsScanning(false);\n        return false;\n      }\n\n      clearTimeout(timeoutId);\n\n      if (!response.data?.success || !response.data?.face_detected) {\n        toast.error(response.data?.message || 'No face detected. Please try again.');\n        setIsScanning(false);\n        return false;\n      }\n\n      const faceDescriptor = response.data.face.descriptor;\n      if (!Array.isArray(faceDescriptor) || faceDescriptor.length !== 128) {\n        toast.error('Invalid face descriptor. Please try again.');\n        setIsScanning(false);\n        return false;\n      }\n\n      // Create thumbnail from captured image\n      const thumbnail = imageBase64;\n      const confidence = response.data.quality?.score\n        ? Math.round(response.data.quality.score * 100)\n        : 90;\n\n      const faceData = {\n        pose: POSES[currentPoseIndex].name,\n        descriptor: faceDescriptor,\n        thumbnail: thumbnail,\n        confidence: confidence\n      };\n\n      setCapturedDescriptors(prev => [...prev, faceData]);\n      setPosesCaptured(prev => [...prev, POSES[currentPoseIndex].name]);\n      toast.success(`Front face captured successfully!`);\n\n      // Since we only capture one pose now, immediately set the face data\n      setCapturedFaceData({\n        descriptors: [faceData],\n        averageDescriptor: faceDescriptor,\n        thumbnail: thumbnail,\n        confidence: confidence\n      });\n      toast.success('Face registration complete!');\n\n      return true;\n    } catch (error) {\n      clearTimeout(timeoutId);\n      console.error('Error capturing face:', error);\n      toast.error('Failed to capture face data. Please try again.');\n      return false;\n    } finally {\n      setIsScanning(false);\n    }\n  };\n\n  const fetchEmployees = async () => {\n    try {\n      setLoading(true);\n      const response = await employeeAPI.getEmployees();\n      if (response.data.success) {\n        const employeeData = response.data.data?.employees || [];\n        const enrichedEmployees = employeeData.map(emp => {\n          // Check multiple possible indicators of face registration\n          const hasFaceRegistered =\n            emp.hasFaceRegistered === true ||\n            (Array.isArray(emp.faceDescriptor) && (emp.faceDescriptor.length === 128 || emp.faceDescriptor.length === 512)) ||\n            !!emp.faceImage;\n          return {\n            ...emp,\n            hasFaceRegistered // explicitly set the flag\n          };\n        });\n        setEmployees(enrichedEmployees);\n      }\n    } catch (error) {\n      console.error('Error fetching employees:', error);\n      toast.error('Failed to fetch employees');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchEmployees();\n    setGlobalModelsLoaded(true); // No local model loading needed - using backend service\n    return () => stopCamera();\n  }, []);\n\n  useEffect(() => {\n    const fetchDepartments = async () => {\n      try {\n        const response = await departmentAPI.getDepartments();\n        if (response.data.success) {\n          setDepartments(response.data.data);\n        }\n      } catch (error) {\n        console.error('Error fetching departments:', error);\n      }\n    };\n    fetchDepartments();\n  }, []);\n\n  useEffect(() => {\n    if (showAddModal && currentStep === 2 && faceRegistrationEnabled && globalModelsLoaded) {\n      startCamera();\n    } else {\n      stopCamera();\n    }\n    return () => stopCamera();\n  }, [showAddModal, currentStep, faceRegistrationEnabled, globalModelsLoaded]);\n\n  const filteredEmployees = employees.filter(emp => {\n    const fullName = `${emp.personalInfo?.firstName || ''} ${emp.personalInfo?.lastName || ''}`.toLowerCase();\n    const userEmail = emp.user?.email?.toLowerCase() || '';\n    const position = emp.workInfo?.position?.toLowerCase() || '';\n    const employeeId = emp.employeeId?.toLowerCase() || emp.user?.employeeId?.toLowerCase() || '';\n    const matchesSearch = fullName.includes(searchTerm.toLowerCase()) ||\n                         userEmail.includes(searchTerm.toLowerCase()) ||\n                         position.includes(searchTerm.toLowerCase()) ||\n                         employeeId.includes(searchTerm.toLowerCase());\n    const departmentName = typeof emp.workInfo?.department === 'object'\n      ? emp.workInfo.department.name\n      : emp.workInfo?.department;\n    const matchesDepartment = !filterDepartment || departmentName === filterDepartment;\n    return matchesSearch && matchesDepartment;\n  });\n\n  const handleFormNext = (e) => {\n    e.preventDefault();\n    if (!newEmployee.personalInfo.firstName || !newEmployee.personalInfo.lastName) {\n      toast.error('First name and last name are required');\n      return;\n    }\n    if (!newEmployee.contactInfo.personalEmail) {\n      toast.error('Email is required');\n      return;\n    }\n    if (!newEmployee.workInfo.position || !newEmployee.workInfo.department) {\n      toast.error('Position and department are required');\n      return;\n    }\n    // Face registration is now COMPULSORY - always go to step 2\n    setCurrentStep(2);\n  };\n\n  const handleCreateEmployee = async () => {\n    try {\n      let employeeDataWithFace = { ...newEmployee };\n      if (capturedFaceData) {\n        // ✅ Send average face descriptor (128-number array)\n        employeeDataWithFace.faceDescriptor = capturedFaceData.averageDescriptor;\n        employeeDataWithFace.faceImage = capturedFaceData.thumbnail;\n        employeeDataWithFace.hasFaceRegistered = true;\n      }\n      const response = await employeeAPI.createEmployee(employeeDataWithFace);\n      if (response.data.success) {\n        await fetchEmployees();\n        resetForm();\n        setShowAddModal(false);\n        const employeeName = `${newEmployee.personalInfo.firstName} ${newEmployee.personalInfo.lastName}`;\n        toast.success(`Employee ${employeeName} added successfully with 4-pose face registration!`);\n      }\n    } catch (error) {\n      console.error('❌ Error creating employee:', error);\n      toast.error(error.response?.data?.message || 'Failed to create employee');\n    }\n  };\n\n  const resetForm = () => {\n    setNewEmployee({\n      personalInfo: {\n        firstName: '',\n        lastName: '',\n        dateOfBirth: '',\n        gender: '',\n        nationality: 'Indian',\n        maritalStatus: 'Single',\n        bloodGroup: ''\n      },\n      contactInfo: {\n        phone: '',\n        alternatePhone: '',\n        personalEmail: '',\n        address: {\n          street: '',\n          city: '',\n          state: '',\n          pincode: '',\n          country: 'India'\n        },\n        emergencyContact: {\n          name: '',\n          relationship: '',\n          phone: ''\n        }\n      },\n      workInfo: {\n        position: '',\n        department: '',\n        joiningDate: new Date().toISOString().split('T')[0],\n        employmentType: 'Full-time',\n        workLocation: 'Office',\n        team: '',\n        skills: [],\n        workShift: 'Morning'\n      },\n      salaryInfo: {\n        basicSalary: 0,\n        allowances: {\n          hra: 0,\n          medical: 0,\n          transport: 0,\n          other: 0\n        },\n        deductions: {\n          pf: 0,\n          esi: 0,\n          tax: 0,\n          other: 0\n        },\n        currency: 'INR',\n        payFrequency: 'Monthly'\n      },\n      bankInfo: {\n        accountHolderName: '',\n        accountNumber: '',\n        bankName: '',\n        branchName: '',\n        ifscCode: '',\n        accountType: 'Savings'\n      }\n    });\n    setCurrentStep(1);\n    setCapturedFaceData(null);\n    setCapturedDescriptors([]);\n    setPosesCaptured([]);\n    setFaceDetected(false);\n    setIsScanning(false);\n    stopCamera();\n  };\n\n  const updateSelectedEmployee = (field, value, nestedField = null, subNestedField = null) => {\n    if (subNestedField) {\n      setSelectedEmployee(prev => ({\n        ...prev,\n        [field]: {\n          ...prev[field],\n          [nestedField]: {\n            ...prev[field][nestedField],\n            [subNestedField]: value\n          }\n        }\n      }));\n    } else if (nestedField) {\n      setSelectedEmployee(prev => ({\n        ...prev,\n        [field]: {\n          ...prev[field],\n          [nestedField]: value\n        }\n      }));\n    } else {\n      setSelectedEmployee(prev => ({\n        ...prev,\n        [field]: value\n      }));\n    }\n  };\n\n  const handleEditEmployee = async (e) => {\n    e.preventDefault();\n    try {\n      const response = await employeeAPI.updateEmployee(selectedEmployee._id, selectedEmployee);\n      if (response.data.success) {\n        await fetchEmployees();\n        setShowEditModal(false);\n        toast.success('Employee updated successfully!');\n      }\n    } catch (error) {\n      console.error('Error updating employee:', error);\n      toast.error(error.response?.data?.message || 'Failed to update employee');\n    }\n  };\n\n  const handleDeleteEmployee = async (id) => {\n    if (window.confirm('Are you sure you want to delete this employee? This will also delete their user account.')) {\n      try {\n        const response = await employeeAPI.deleteEmployee(id);\n        if (response.data.success) {\n          await fetchEmployees();\n          toast.success('Employee deleted successfully!');\n        }\n      } catch (error) {\n        console.error('Error deleting employee:', error);\n        toast.error(error.response?.data?.message || 'Failed to delete employee');\n      }\n    }\n  };\n\n  const EditModal = () => {\n    if (!selectedEmployee) return null;\n    return (\n      <div className=\"fixed inset-0 z-[9999] flex items-center justify-center p-2 sm:p-4\">\n        {/* Enhanced backdrop with blur */}\n        <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" />\n\n        {/* Modal content */}\n        <div className=\"relative glass-morphism neon-border rounded-2xl p-3 sm:p-4 md:p-6 w-full max-w-full sm:max-w-6xl max-h-[95vh] overflow-y-auto shadow-2xl\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <h2 className=\"text-xl sm:text-2xl font-bold text-white\">Edit Employee</h2>\n            <button onClick={() => setShowEditModal(false)} className=\"text-secondary-400 hover:text-white\">\n              <X className=\"w-5 h-5 sm:w-6 sm:h-6\" />\n            </button>\n          </div>\n          <form onSubmit={handleEditEmployee} className=\"space-y-6\">\n            {/* Personal Information */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-base sm:text-lg font-bold text-white border-b border-secondary-600 pb-2\">Personal Information</h3>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4\">\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">First Name *</label>\n                  <input\n                    type=\"text\"\n                    value={selectedEmployee.personalInfo?.firstName || ''}\n                    onChange={(e) => updateSelectedEmployee('personalInfo', e.target.value, 'firstName')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                    inputMode=\"text\"\n                    autoComplete=\"off\"\n                    autoCapitalize=\"words\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Last Name *</label>\n                  <input\n                    type=\"text\"\n                    value={selectedEmployee.personalInfo?.lastName || ''}\n                    onChange={(e) => updateSelectedEmployee('personalInfo', e.target.value, 'lastName')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Date of Birth *</label>\n                  <input\n                    type=\"date\"\n                    value={selectedEmployee.personalInfo?.dateOfBirth ? selectedEmployee.personalInfo.dateOfBirth.split('T')[0] : ''}\n                    onChange={(e) => updateSelectedEmployee('personalInfo', e.target.value, 'dateOfBirth')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Gender *</label>\n                  <select\n                    value={selectedEmployee.personalInfo?.gender || ''}\n                    onChange={(e) => updateSelectedEmployee('personalInfo', e.target.value, 'gender')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  >\n                    <option value=\"\">Select Gender</option>\n                    <option value=\"Male\">Male</option>\n                    <option value=\"Female\">Female</option>\n                    <option value=\"Other\">Other</option>\n                  </select>\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Blood Group</label>\n                  <select\n                    value={selectedEmployee.personalInfo?.bloodGroup || ''}\n                    onChange={(e) => updateSelectedEmployee('personalInfo', e.target.value, 'bloodGroup')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  >\n                    <option value=\"\">Select Blood Group</option>\n                    <option value=\"A+\">A+</option>\n                    <option value=\"A-\">A-</option>\n                    <option value=\"B+\">B+</option>\n                    <option value=\"B-\">B-</option>\n                    <option value=\"AB+\">AB+</option>\n                    <option value=\"AB-\">AB-</option>\n                    <option value=\"O+\">O+</option>\n                    <option value=\"O-\">O-</option>\n                  </select>\n                </div>\n              </div>\n            </div>\n            {/* Contact Information */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-base sm:text-lg font-bold text-white border-b border-secondary-600 pb-2\">Contact Information</h3>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4\">\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Email *</label>\n                  <input\n                    type=\"email\"\n                    value={selectedEmployee.contactInfo?.personalEmail || ''}\n                    onChange={(e) => updateSelectedEmployee('contactInfo', e.target.value, 'personalEmail')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Phone *</label>\n                  <input\n                    type=\"tel\"\n                    value={selectedEmployee.contactInfo?.phone || ''}\n                    onChange={(e) => updateSelectedEmployee('contactInfo', e.target.value, 'phone')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  />\n                </div>\n                <div className=\"sm:col-span-2\">\n                  <h4 className=\"text-sm sm:text-md font-semibold text-white mb-2 sm:mb-3\">Emergency Contact</h4>\n                  <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4\">\n                    <div>\n                      <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Name *</label>\n                      <input\n                        type=\"text\"\n                        value={selectedEmployee.contactInfo?.emergencyContact?.name || ''}\n                        onChange={(e) => updateSelectedEmployee('contactInfo', e.target.value, 'emergencyContact', 'name')}\n                        className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                        required\n                      />\n                    </div>\n                    <div>\n                      <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Relationship *</label>\n                      <input\n                        type=\"text\"\n                        value={selectedEmployee.contactInfo?.emergencyContact?.relationship || ''}\n                        onChange={(e) => updateSelectedEmployee('contactInfo', e.target.value, 'emergencyContact', 'relationship')}\n                        className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                        required\n                      />\n                    </div>\n                    <div>\n                      <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Phone *</label>\n                      <input\n                        type=\"tel\"\n                        value={selectedEmployee.contactInfo?.emergencyContact?.phone || ''}\n                        onChange={(e) => updateSelectedEmployee('contactInfo', e.target.value, 'emergencyContact', 'phone')}\n                        className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                        required\n                      />\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n            {/* Work Information */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-base sm:text-lg font-bold text-white border-b border-secondary-600 pb-2\">Work Information</h3>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4\">\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Position *</label>\n                  <input\n                    type=\"text\"\n                    value={selectedEmployee.workInfo?.position || ''}\n                    onChange={(e) => updateSelectedEmployee('workInfo', e.target.value, 'position')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Department *</label>\n                  <select\n                    value={typeof selectedEmployee.workInfo?.department === 'object' ? selectedEmployee.workInfo.department._id : selectedEmployee.workInfo?.department || ''}\n                    onChange={(e) => updateSelectedEmployee('workInfo', e.target.value, 'department')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  >\n                    <option value=\"\">Select Department</option>\n                    {departments.map(dept => (\n                      <option key={dept._id} value={dept._id}>{dept.name}</option>\n                    ))}\n                  </select>\n                </div>\n                <div>\n                  <label className=\"block text-xs sm:text-sm font-medium text-secondary-300 mb-1 sm:mb-2\">Basic Salary *</label>\n                  <input\n                    type=\"number\"\n                    value={selectedEmployee.salaryInfo?.basicSalary || 0}\n                    onChange={(e) => updateSelectedEmployee('salaryInfo', parseFloat(e.target.value) || 0, 'basicSalary')}\n                    className=\"w-full px-3 sm:px-4 py-2.5 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                    min=\"0\"\n                  />\n                </div>\n              </div>\n            </div>\n            <div className=\"flex flex-col sm:flex-row justify-end gap-3 pt-6 border-t border-secondary-600\">\n              <button\n                type=\"button\"\n                onClick={() => setShowEditModal(false)}\n                className=\"px-4 sm:px-6 py-2.5 sm:py-3 border border-secondary-600 text-secondary-300 text-sm rounded-lg hover:bg-secondary-700/50 transition-colors\"\n              >\n                Cancel\n              </button>\n              <button\n                type=\"submit\"\n                className=\"px-4 sm:px-6 py-2.5 sm:py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold text-sm rounded-lg hover-glow transition-all duration-300\"\n              >\n                Update Employee\n              </button>\n            </div>\n          </form>\n        </div>\n      </div>\n    );\n  };\n\n  const ViewModal = () => (\n    <div className=\"fixed inset-0 z-[9999] flex items-center justify-center p-2 sm:p-4\">\n      {/* Enhanced backdrop with blur */}\n      <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" />\n\n      {/* Modal content */}\n      <div className=\"relative glass-morphism neon-border rounded-2xl p-4 sm:p-6 w-full max-w-full sm:max-w-6xl max-h-[95vh] overflow-y-auto shadow-2xl\">\n        <div className=\"flex items-center justify-between mb-4 sm:mb-6\">\n          <h2 className=\"text-xl sm:text-2xl font-bold text-white\">Employee Details</h2>\n          <button\n            onClick={() => setShowViewModal(false)}\n            className=\"text-secondary-400 hover:text-white\"\n          >\n            <X className=\"w-5 h-5 sm:w-6 sm:h-6\" />\n          </button>\n        </div>\n        {selectedEmployee && (\n          <div className=\"space-y-6 sm:space-y-8\">\n            {/* Header */}\n            <div className=\"flex items-center space-x-4 p-4 bg-secondary-800/30 rounded-lg\">\n              <div className=\"w-16 h-16 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                <User className=\"w-8 h-8 text-white\" />\n              </div>\n              <div>\n                <h3 className=\"text-xl font-bold text-white\">{selectedEmployee.fullName}</h3>\n                <p className=\"text-neon-pink text-base\">{selectedEmployee.workInfo?.position}</p>\n                <p className=\"text-secondary-400 text-sm\">\n                  {typeof selectedEmployee.workInfo?.department === 'object'\n                    ? selectedEmployee.workInfo.department.name\n                    : selectedEmployee.workInfo?.department}\n                </p>\n                <p className=\"text-secondary-400 text-sm\">ID: {selectedEmployee.employeeId || selectedEmployee.user?.employeeId}</p>\n                {selectedEmployee.hasFaceRegistered && (\n                  <span className=\"inline-block px-2 py-1 text-xs rounded-full bg-green-400/20 text-green-400 mt-1\">\n                    Face Registered\n                  </span>\n                )}\n              </div>\n            </div>\n\n            {/* Personal Information */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-lg font-bold text-white border-b border-secondary-600 pb-2\">Personal Information</h3>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">First Name</label>\n                  <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.personalInfo?.firstName || 'N/A'}</p>\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Last Name</label>\n                  <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.personalInfo?.lastName || 'N/A'}</p>\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Date of Birth</label>\n                  <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">\n                    {selectedEmployee.personalInfo?.dateOfBirth ? new Date(selectedEmployee.personalInfo.dateOfBirth).toLocaleDateString() : 'N/A'}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Gender</label>\n                  <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.personalInfo?.gender || 'N/A'}</p>\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Blood Group</label>\n                  <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.personalInfo?.bloodGroup || 'N/A'}</p>\n                </div>\n              </div>\n            </div>\n\n            {/* Contact Information */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-lg font-bold text-white border-b border-secondary-600 pb-2\">Contact Information</h3>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Email</label>\n                  <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.contactInfo?.personalEmail || selectedEmployee.user?.email || 'N/A'}</p>\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Phone</label>\n                  <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.contactInfo?.phone || 'N/A'}</p>\n                </div>\n                <div className=\"sm:col-span-2\">\n                  <h4 className=\"text-base font-semibold text-white mb-3\">Emergency Contact</h4>\n                  <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\n                    <div>\n                      <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Name</label>\n                      <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.contactInfo?.emergencyContact?.name || 'N/A'}</p>\n                    </div>\n                    <div>\n                      <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Relationship</label>\n                      <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.contactInfo?.emergencyContact?.relationship || 'N/A'}</p>\n                    </div>\n                    <div>\n                      <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Phone</label>\n                      <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.contactInfo?.emergencyContact?.phone || 'N/A'}</p>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* Work Information */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-lg font-bold text-white border-b border-secondary-600 pb-2\">Work Information</h3>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Position</label>\n                  <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.workInfo?.position || 'N/A'}</p>\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Department</label>\n                  <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">\n                    {typeof selectedEmployee.workInfo?.department === 'object'\n                      ? selectedEmployee.workInfo.department.name\n                      : selectedEmployee.workInfo?.department || 'N/A'}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Basic Salary</label>\n                  <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">\n                    {selectedEmployee.salaryInfo?.basicSalary ? `₹${selectedEmployee.salaryInfo.basicSalary}` : 'N/A'}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Joining Date</label>\n                  <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">\n                    {selectedEmployee.workInfo?.joiningDate ? new Date(selectedEmployee.workInfo.joiningDate).toLocaleDateString() : 'N/A'}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Employment Type</label>\n                  <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.workInfo?.employmentType || 'N/A'}</p>\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Work Location</label>\n                  <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.workInfo?.workLocation || 'N/A'}</p>\n                </div>\n              </div>\n            </div>\n\n            {/* Bank Information */}\n            {selectedEmployee.bankInfo && (\n              <div className=\"space-y-4\">\n                <h3 className=\"text-lg font-bold text-white border-b border-secondary-600 pb-2\">Bank Information</h3>\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Account Holder Name</label>\n                    <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.bankInfo?.accountHolderName || 'N/A'}</p>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Account Number</label>\n                    <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.bankInfo?.accountNumber || 'N/A'}</p>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Bank Name</label>\n                    <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.bankInfo?.bankName || 'N/A'}</p>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">IFSC Code</label>\n                    <p className=\"text-white bg-secondary-800/50 px-3 py-2 rounded-lg\">{selectedEmployee.bankInfo?.ifscCode || 'N/A'}</p>\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n\n  if (loading) {\n    return (\n      <AdminLayout>\n        <div className=\"flex items-center justify-center min-h-screen px-4\">\n          <div className=\"text-white text-lg sm:text-xl\">Loading employees...</div>\n        </div>\n      </AdminLayout>\n    );\n  }\n\n  return (\n    <AdminLayout>\n      <div className=\"space-y-6 px-2 sm:px-4 md:px-6 lg:px-8 xl:px-12 2xl:px-16\">\n        {/* Header */}\n        <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-3 sm:gap-4\">\n          <div>\n            <p className=\"text-xl sm:text-2xl md:text-3xl font-bold text-white\">Employee Management</p>\n            <p className=\"text-secondary-400 text-xs sm:text-sm\">Manage your company's workforce with integrated face registration</p>\n          </div>\n          <button\n            onClick={() => setShowAddModal(true)}\n            className=\"px-3 sm:px-4 py-2 sm:py-2.5 md:py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold text-xs sm:text-sm rounded-lg hover-glow transition-all duration-300 flex items-center\"\n          >\n            <Plus className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1.5 sm:mr-2\" />\n            Add Employee\n          </button>\n        </div>\n        {/* Filters */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-3 sm:p-4 md:p-6\">\n          <div className=\"flex flex-col md:flex-row gap-3 sm:gap-4\">\n            <div className=\"relative flex-1\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 sm:w-5 sm:h-5 text-secondary-400\" />\n              <input\n                type=\"text\"\n                placeholder=\"Search employees...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"w-full pl-9 sm:pl-10 pr-3 sm:pr-4 py-2 sm:py-2.5 md:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 text-xs sm:text-sm\"\n              />\n            </div>\n            <div className=\"relative\">\n              <Filter className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 sm:w-5 sm:h-5 text-secondary-400\" />\n              <select\n                value={filterDepartment}\n                onChange={(e) => setFilterDepartment(e.target.value)}\n                className=\"pl-9 sm:pl-10 pr-7 sm:pr-8 py-2 sm:py-2.5 md:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 text-xs sm:text-sm\"\n              >\n                <option value=\"\">All Departments</option>\n                {departments.map(dept => (\n                  <option key={dept._id} value={dept.name}>{dept.name}</option>\n                ))}\n              </select>\n            </div>\n          </div>\n        </div>\n        {/* Stats */}\n        <div className=\"grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-3 sm:p-4 md:p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-lg sm:text-xl md:text-2xl font-bold text-white\">{employees.length}</h3>\n                <p className=\"text-secondary-400 text-xs sm:text-sm\">Total Employees</p>\n              </div>\n              <div className=\"w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center\">\n                <User className=\"w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n          <div className=\"glass-morphism neon-border rounded-2xl p-3 sm:p-4 md:p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-lg sm:text-xl md:text-2xl font-bold text-white\">\n                  {employees.filter(e => e.hasFaceRegistered).length}\n                </h3>\n                <p className=\"text-secondary-400 text-xs sm:text-sm\">Face Registered</p>\n              </div>\n              <div className=\"w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center\">\n                <Camera className=\"w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n          <div className=\"glass-morphism neon-border rounded-2xl p-3 sm:p-4 md:p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-lg sm:text-xl md:text-2xl font-bold text-white\">\n                  {new Set(employees.map(e => e.workInfo?.department).filter(Boolean)).size}\n                </h3>\n                <p className=\"text-secondary-400 text-xs sm:text-sm\">Departments</p>\n              </div>\n              <div className=\"w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center\">\n                <UserPlus className=\"w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n          <div className=\"glass-morphism neon-border rounded-2xl p-3 sm:p-4 md:p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-lg sm:text-xl md:text-2xl font-bold text-white\">\n                  {employees.filter(e => e.status === 'Active' || !e.status).length}\n                </h3>\n                <p className=\"text-secondary-400 text-xs sm:text-sm\">Active</p>\n              </div>\n              <div className=\"w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 bg-gradient-to-r from-pink-500 to-pink-600 rounded-lg flex items-center justify-center\">\n                <UserPlus className=\"w-4 h-4 sm:w-5 sm:h-5 md:w-6 md:h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n        </div>\n        {/* Employee Table/Cards */}\n        <div className=\"glass-morphism neon-border rounded-2xl overflow-hidden\">\n          {/* Mobile Cards */}\n          <div className=\"md:hidden grid gap-4 p-4\">\n            {filteredEmployees.map((employee) => (\n              <div key={employee._id} className=\"bg-secondary-800/30 border border-secondary-700 rounded-xl p-4 hover:bg-secondary-800/50 transition-colors\">\n                <div className=\"flex items-start justify-between mb-3\">\n                  <div className=\"flex items-center space-x-3\">\n                    <div className=\"w-10 h-10 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center flex-shrink-0\">\n                      <User className=\"w-5 h-5 text-white\" />\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-white font-medium text-sm truncate\">{employee.fullName}</p>\n                      <p className=\"text-secondary-400 text-xs flex items-center\">\n                        <Mail className=\"w-3 h-3 mr-1\" />\n                        <span className=\"truncate\">{employee.user?.email || employee.contactInfo?.personalEmail}</span>\n                      </p>\n                      <p className=\"text-secondary-400 text-xs\">ID: {employee.employeeId || employee.user?.employeeId}</p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center space-x-2 ml-2\">\n                    <button\n                      onClick={() => {\n                        setSelectedEmployee(employee);\n                        setShowViewModal(true);\n                      }}\n                      className=\"p-1.5 text-secondary-400 hover:text-blue-400 hover:bg-blue-400/10 rounded-lg transition-colors\"\n                      title=\"View Details\"\n                    >\n                      <Eye className=\"w-4 h-4\" />\n                    </button>\n                    <button\n                      onClick={() => {\n                        setSelectedEmployee(employee);\n                        setShowEditModal(true);\n                      }}\n                      className=\"p-1.5 text-secondary-400 hover:text-neon-pink hover:bg-neon-pink/10 rounded-lg transition-colors\"\n                      title=\"Edit\"\n                    >\n                      <Edit className=\"w-4 h-4\" />\n                    </button>\n                    <button\n                      onClick={() => handleDeleteEmployee(employee._id)}\n                      className=\"p-1.5 text-secondary-400 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-colors\"\n                      title=\"Delete\"\n                    >\n                      <Trash2 className=\"w-4 h-4\" />\n                    </button>\n                  </div>\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex justify-between items-center\">\n                    <span className=\"text-secondary-400 text-xs\">Position</span>\n                    <span className=\"text-white text-sm font-medium\">{employee.workInfo?.position}</span>\n                  </div>\n                  <div className=\"flex justify-between items-center\">\n                    <span className=\"text-secondary-400 text-xs\">Department</span>\n                    <span className=\"text-white text-sm\">\n                      {typeof employee.workInfo?.department === 'object'\n                        ? employee.workInfo.department.name\n                        : employee.workInfo?.department || 'No Department'}\n                    </span>\n                  </div>\n\n                  <div className=\"flex justify-between items-center\">\n                    <span className=\"text-secondary-400 text-xs\">Status</span>\n                    <span className={`text-xs px-2 py-1 rounded-full ${\n                      employee.status === 'Active' || !employee.status\n                        ? 'bg-green-400/20 text-green-400'\n                        : 'bg-red-400/20 text-red-400'\n                    }`}>\n                      {employee.status || 'Active'}\n                    </span>\n                  </div>\n                </div>\n              </div>\n            ))}\n          </div>\n          \n          {/* Desktop Table */}\n          <div className=\"hidden md:block\">\n            <div className=\"overflow-x-auto scrollbar-thin scrollbar-thumb-neon-pink scrollbar-track-secondary-900\">\n              <table className=\"w-full\">\n                <thead className=\"border-b border-secondary-700\">\n                  <tr>\n                    <th className=\"text-left p-4 md:p-6 text-secondary-300 font-medium text-sm\">Employee</th>\n                    <th className=\"text-left p-4 md:p-6 text-secondary-300 font-medium text-sm\">Position</th>\n                    <th className=\"text-left p-4 md:p-6 text-secondary-300 font-medium text-sm\">Department</th>\n\n                    <th className=\"text-left p-4 md:p-6 text-secondary-300 font-medium text-sm\">Status</th>\n                    <th className=\"text-left p-4 md:p-6 text-secondary-300 font-medium text-sm\">Actions</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {filteredEmployees.map((employee) => (\n                    <tr key={employee._id} className=\"border-b border-secondary-800 hover:bg-secondary-800/30 transition-colors\">\n                      <td className=\"p-4 md:p-6\">\n                        <div className=\"flex items-center space-x-3\">\n                          <div className=\"w-8 h-8 md:w-10 md:h-10 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                            <User className=\"w-4 h-4 md:w-5 md:h-5 text-white\" />\n                          </div>\n                          <div>\n                            <p className=\"text-white font-medium text-sm\">{employee.fullName}</p>\n                            <p className=\"text-secondary-400 text-xs flex items-center\">\n                              <Mail className=\"w-3 h-3 mr-1\" />\n                              {employee.user?.email || employee.contactInfo?.personalEmail}\n                            </p>\n                            <p className=\"text-secondary-400 text-xs\">ID: {employee.employeeId || employee.user?.employeeId}</p>\n                          </div>\n                        </div>\n                      </td>\n                      <td className=\"p-4 md:p-6 text-white text-sm\">{employee.workInfo?.position}</td>\n                      <td className=\"p-4 md:p-6\">\n                        <span className=\"px-2.5 py-1.5 text-xs rounded-full bg-secondary-700 text-secondary-300\">\n                          {typeof employee.workInfo?.department === 'object'\n                            ? employee.workInfo.department.name\n                            : employee.workInfo?.department || 'No Department'}\n                        </span>\n                      </td>\n\n                      <td className=\"p-4 md:p-6\">\n                        <span className={`px-2.5 py-1.5 text-xs rounded-full ${\n                          employee.status === 'Active' || !employee.status\n                            ? 'bg-green-400/20 text-green-400'\n                            : 'bg-red-400/20 text-red-400'\n                        }`}>\n                          {employee.status || 'Active'}\n                        </span>\n                      </td>\n                      <td className=\"p-4 md:p-6\">\n                        <div className=\"flex items-center space-x-1.5\">\n                          <button\n                            onClick={() => {\n                              setSelectedEmployee(employee);\n                              setShowViewModal(true);\n                            }}\n                            className=\"p-1.5 text-secondary-400 hover:text-blue-400 hover:bg-blue-400/10 rounded-lg transition-colors\"\n                            title=\"View Details\"\n                          >\n                            <Eye className=\"w-3 h-3\" />\n                          </button>\n                          <button\n                            onClick={() => {\n                              setSelectedEmployee(employee);\n                              setShowEditModal(true);\n                            }}\n                            className=\"p-1.5 text-secondary-400 hover:text-neon-pink hover:bg-neon-pink/10 rounded-lg transition-colors\"\n                            title=\"Edit\"\n                          >\n                            <Edit className=\"w-3 h-3\" />\n                          </button>\n                          <button\n                            onClick={() => handleDeleteEmployee(employee._id)}\n                            className=\"p-1.5 text-secondary-400 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-colors\"\n                            title=\"Delete\"\n                          >\n                            <Trash2 className=\"w-3 h-3\" />\n                          </button>\n                        </div>\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          </div>\n          \n          {filteredEmployees.length === 0 && (\n            <div className=\"p-6 sm:p-8 text-center\">\n              <User className=\"w-8 h-8 sm:w-10 sm:h-10 text-secondary-600 mx-auto mb-3 sm:mb-4\" />\n              <h3 className=\"text-sm sm:text-base font-medium text-secondary-400 mb-1 sm:mb-2\">No employees found</h3>\n              <p className=\"text-secondary-500 text-xs sm:text-sm\">\n                {searchTerm || filterDepartment\n                  ? 'Try adjusting your search filters'\n                  : 'Start by adding your first employee'}\n              </p>\n            </div>\n          )}\n        </div>\n      {/* Modals */}\n      {showAddModal && (\n        <AddEmployeeModal\n          show={showAddModal}\n          onClose={() => setShowAddModal(false)}\n          currentStep={currentStep}\n          setCurrentStep={setCurrentStep}\n          newEmployee={newEmployee}\n          setNewEmployee={setNewEmployee}\n          departments={departments}\n          faceRegistrationEnabled={faceRegistrationEnabled}\n          setFaceRegistrationEnabled={setFaceRegistrationEnabled}\n          modelsLoaded={globalModelsLoaded}\n          faceDetected={faceDetected}\n          isScanning={isScanning}\n          capturedFaceData={capturedFaceData}\n          setCapturedFaceData={setCapturedFaceData}\n          capturedDescriptors={capturedDescriptors}\n          setCapturedDescriptors={setCapturedDescriptors}\n          posesCaptured={posesCaptured}\n          setPosesCaptured={setPosesCaptured}\n          videoRef={videoRef}\n          canvasRef={canvasRef}\n          startCamera={startCamera}\n          captureCurrentPose={captureCurrentPose}\n          handleCreateEmployee={handleCreateEmployee}\n          handleFormNext={handleFormNext}\n          resetForm={resetForm}\n        />\n      )}\n      {showEditModal && <EditModal />}\n      {showViewModal && <ViewModal />}\n    </div>\n  </AdminLayout>\n);\n};\n\nexport default EmployeeManagement;","path":null,"size_bytes":86405,"size_tokens":null},"frontend/postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"frontend/src/pages/Employee/EmployeeDashboard.jsx":{"content":"// src/pages/Employee/EmployeeDashboard.js\nimport React, { useState, useEffect, useRef, useCallback, useLayoutEffect } from 'react';\nimport EmployeeLayout from '../../components/Employee/EmployeeLayout/EmployeeLayout';\nimport {\n  User, Clock, Calendar, DollarSign, CheckCircle, AlertCircle, MapPin, Bell, Award, Target, TrendingUp, FileText, MessageCircle, X, Send, Bot, Camera, Download, Users\n} from 'lucide-react';\nimport GroupChatModal from '../../components/Employee/GroupChat/GroupChatModal';\nimport toast from 'react-hot-toast';\nimport { employeeAPI, authAPI, attendanceAPI, payslipAPI } from '../../utils/api';\nimport API from '../../utils/api';\nimport { geolocationUtils } from '../../utils/geolocationUtils';\nimport io from 'socket.io-client';\n\nconst EmployeeDashboard = () => {\n  const [currentTime, setCurrentTime] = useState(new Date());\n  const [location, setLocation] = useState(null);\n  const [employeeData, setEmployeeData] = useState(null);\n  const [dashboardStats, setDashboardStats] = useState(null);\n  const [todayAttendance, setTodayAttendance] = useState(null);\n  const [hasCheckedIn, setHasCheckedIn] = useState(false);\n  const [hasCheckedOut, setHasCheckedOut] = useState(false);\n  const [attendanceLoading, setAttendanceLoading] = useState(false);\n  const [workingTime, setWorkingTime] = useState(null);\n  const [realTimeWorkingTime, setRealTimeWorkingTime] = useState(0);\n  const [loading, setLoading] = useState(true);\n  const [showChatModal, setShowChatModal] = useState(false);\n  const [showBotModal, setShowBotModal] = useState(false);\n  const [showGroupChatModal, setShowGroupChatModal] = useState(false);\n  const [showPayslipModal, setShowPayslipModal] = useState(false);\n  const [currentPayslip, setCurrentPayslip] = useState(null);\n  const [payslipLoading, setPayslipLoading] = useState(false);\n  const [chatMessages, setChatMessages] = useState([]);\n  const [botMessages, setBotMessages] = useState([]);\n  const [selectedPeer, setSelectedPeer] = useState(null);\n  const [peers, setPeers] = useState([]);\n  const [onlineUsers, setOnlineUsers] = useState(new Set());\n  const [typingUsers, setTypingUsers] = useState(new Set());\n  const [newMessage, setNewMessage] = useState('');\n  const [newBotMessage, setNewBotMessage] = useState('');\n  const [loadingChat, setLoadingChat] = useState(false);\n  const [loadingBot, setLoadingBot] = useState(false);\n  const socketRef = useRef(null);\n  const messagesEndRef = useRef(null);\n  const botMessagesEndRef = useRef(null);\n  const botMessagesContainerRef = useRef(null);\n  const botTimeoutRef = useRef(null);\n  const isUserScrolledUp = useRef(false);\n  const typingTimeoutRef = useRef(null);\n\n  const handleBotMessageChange = useCallback((e) => {\n    setNewBotMessage(e.target.value);\n  }, []);\n\n  const handleChatMessageChange = useCallback((e) => {\n    setNewMessage(e.target.value);\n    \n    if (socketRef.current?.connected && selectedPeer?._id) {\n      socketRef.current.emit('typing:start', { to: selectedPeer._id });\n      \n      if (typingTimeoutRef.current) {\n        clearTimeout(typingTimeoutRef.current);\n      }\n      typingTimeoutRef.current = setTimeout(() => {\n        if (socketRef.current?.connected && selectedPeer?._id) {\n          socketRef.current.emit('typing:stop', { to: selectedPeer._id });\n        }\n      }, 2000);\n    }\n  }, [selectedPeer]);\n\n  const scrollToBottom = () => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  };\n\n  const scrollToBottomBot = () => {\n    if (!isUserScrolledUp.current) {\n      botMessagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n    }\n  };\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [chatMessages]);\n\n  useLayoutEffect(() => {\n    scrollToBottomBot();\n  }, [botMessages]);\n\n  useEffect(() => {\n    const fetchEmployeeData = async () => {\n      try {\n        setLoading(true);\n        let profileResponse;\n        try {\n          profileResponse = await authAPI.getMyProfile();\n        } catch (error) {\n          console.warn('authAPI.getMyProfile() failed, trying employeeAPI.getMyProfile()');\n          profileResponse = await employeeAPI.getMyProfile();\n        }\n\n        if (profileResponse.data && profileResponse.data.success) {\n          const employee = profileResponse.data.data;\n          // Ensure we have the user ID as id, and employee ID as employeeId\n          setEmployeeData({\n            ...employee,\n            id: employee.id || employee.user?._id || employee._id,\n            employeeId: employee.employeeId || employee._id\n          });\n\n          const stats = [\n            { title: 'Days Present', value: '22', subtitle: 'This Month', icon: CheckCircle, color: 'from-green-500 to-green-600', change: '+2 from last month' },\n            { title: 'Leave Balance', value: employee.leaveBalance?.remaining?.toString() || '30', subtitle: 'Days Remaining', icon: Calendar, color: 'from-blue-500 to-blue-600', change: `${employee.leaveBalance?.total || 30} total allocated` },\n            { title: 'Current Salary', value: `₹${employee.salaryInfo?.basicSalary?.toLocaleString() || '60,000'}`, subtitle: 'Basic Salary', icon: DollarSign, color: 'from-purple-500 to-purple-600', change: 'Monthly' },\n            { title: 'Years of Service', value: employee.yearsOfService?.toString() || '0', subtitle: 'Years', icon: Target, color: 'from-pink-500 to-pink-600', change: `Since ${employee.workInfo?.joiningDate ? new Date(employee.workInfo.joiningDate).getFullYear() : 'N/A'}` }\n          ];\n          setDashboardStats(stats);\n        } else {\n          console.error('Failed to fetch employee profile:', profileResponse);\n          toast.error('Unable to load your profile data');\n          setDefaultStats();\n        }\n\n        try {\n          const attendanceResponse = await attendanceAPI.getTodayAttendance();\n          if (attendanceResponse.data.success) {\n            const data = attendanceResponse.data;\n            setTodayAttendance(data.data);\n            setHasCheckedIn(data.hasCheckedIn);\n            setHasCheckedOut(data.hasCheckedOut);\n          }\n        } catch (error) {\n          if (error.response?.status !== 404) {\n            console.error('Error fetching today attendance:', error);\n          }\n        }\n      } catch (error) {\n        console.error('Error fetching employee ', error);\n        if (error.response?.status === 401) {\n          toast.error('Session expired. Please login again.');\n        } else if (error.response?.status === 403) {\n          toast.error('Access denied. Please contact HR.');\n        } else if (error.response?.status === 404) {\n          toast.error('Employee profile not found. Please contact HR.');\n        } else {\n          toast.error('Unable to load dashboard data.');\n        }\n        setDefaultStats();\n      } finally {\n        setLoading(false);\n      }\n    };\n    fetchEmployeeData();\n  }, []);\n\n  useEffect(() => {\n    getCurrentLocation();\n  }, []);\n\n  const getCurrentLocation = async () => {\n    try {\n      const position = await geolocationUtils.getCurrentPosition();\n      const addressData = await geolocationUtils.getAddressFromCoords(position.latitude, position.longitude);\n      // Format address as string for display\n      const addressString = typeof addressData === 'object' ? addressData.address : addressData;\n      setLocation({ ...position, address: addressString });\n    } catch (error) {\n      console.error('Location error:', error);\n    }\n  };\n\n  const setDefaultStats = () => {\n    setDashboardStats([\n      { title: 'Days Present', value: '22', subtitle: 'This Month', icon: CheckCircle, color: 'from-green-500 to-green-600', change: '+2 from last month' },\n      { title: 'Leave Balance', value: '30', subtitle: 'Days Remaining', icon: Calendar, color: 'from-blue-500 to-blue-600', change: '30 total allocated' },\n      { title: 'Current Salary', value: '₹60,000', subtitle: 'Basic Salary', icon: DollarSign, color: 'from-purple-500 to-purple-600', change: 'Monthly' },\n      { title: 'Years of Service', value: '0', subtitle: 'Years', icon: Target, color: 'from-pink-500 to-pink-600', change: 'New Employee' }\n    ]);\n  };\n\n  useEffect(() => {\n    const timer = setInterval(() => setCurrentTime(new Date()), 1000);\n    return () => clearInterval(timer);\n  }, []);\n\n  // Real-time working time counter\n  useEffect(() => {\n    let interval;\n    if (hasCheckedIn && !hasCheckedOut && todayAttendance?.checkInTime) {\n      interval = setInterval(() => {\n        const checkInTime = new Date(todayAttendance.checkInTime);\n        const now = new Date();\n        const diffMs = now - checkInTime;\n        const minutes = Math.floor(diffMs / (1000 * 60));\n        setRealTimeWorkingTime(minutes);\n      }, 1000);\n    } else {\n      setRealTimeWorkingTime(0);\n    }\n    return () => clearInterval(interval);\n  }, [hasCheckedIn, hasCheckedOut, todayAttendance]);\n\n  useEffect(() => {\n    if (!showBotModal) {\n      setBotMessages([]);\n      setNewBotMessage('');\n      setLoadingBot(false);\n      if (botTimeoutRef.current) {\n        clearTimeout(botTimeoutRef.current);\n        botTimeoutRef.current = null;\n      }\n    }\n  }, [showBotModal]);\n\n  useEffect(() => {\n    if (showBotModal && employeeData && botMessages.length === 0) {\n      setBotMessages([\n        {\n          _id: 'welcome',\n          from: null,\n          to: employeeData.id,\n          text: 'Hello! I am your HR Assistant. How can I help you today? You can ask for salary slip, leave status, or any HR related query.',\n          timestamp: new Date(),\n          self: false,\n          fromBot: true\n        }\n      ]);\n    }\n  }, [showBotModal, employeeData]);\n\n  const handleViewPayslip = async () => {\n    try {\n      setPayslipLoading(true);\n      setShowPayslipModal(true);\n\n      // Get current month and year\n      const now = new Date();\n      const currentMonth = now.getMonth() + 1;\n      const currentYear = now.getFullYear();\n\n      // Fetch payslips for current user\n      const response = await payslipAPI.getPayslips({\n        month: currentMonth,\n        year: currentYear\n      });\n\n      console.log('Employee payslip response:', response.data);\n\n      const payslips = response.data?.data?.payslips || [];\n\n      if (payslips.length > 0) {\n        // Get the most recent payslip\n        setCurrentPayslip(payslips[0]);\n      } else {\n        setCurrentPayslip(null);\n        toast.info('No payslip generated for current month');\n      }\n    } catch (error) {\n      console.error('Error fetching payslip:', error);\n      toast.error('Failed to load payslip');\n      setCurrentPayslip(null);\n    } finally {\n      setPayslipLoading(false);\n    }\n  };\n\n  const handleDownloadPayslip = async () => {\n    if (!currentPayslip?._id) {\n      toast.error('No payslip available to download');\n      return;\n    }\n\n    try {\n      toast.loading('Preparing download...', { id: 'payslip-download' });\n      const response = await payslipAPI.downloadPayslip(currentPayslip._id);\n      \n      const blob = new Blob([response.data], { type: 'application/pdf' });\n      const url = window.URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `Payslip_${currentPayslip.employeeId}_${currentPayslip.period.month}_${currentPayslip.period.year}.pdf`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      window.URL.revokeObjectURL(url);\n      \n      toast.success('Payslip downloaded successfully!', { id: 'payslip-download' });\n    } catch (error) {\n      console.error('Error downloading payslip:', error);\n      toast.error('Failed to download payslip. Please try again.', { id: 'payslip-download' });\n    }\n  };\n\n  const handlePdfDownload = async (url) => {\n    try {\n      const filename = url.split('/').pop();\n      const response = await fetch(url, {\n        headers: {\n          'Authorization': `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n\n      const blob = await response.blob();\n      const downloadUrl = window.URL.createObjectURL(blob);\n\n      const link = document.createElement('a');\n      link.href = downloadUrl;\n      link.download = filename;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      window.URL.revokeObjectURL(downloadUrl);\n\n      toast.success('Document downloaded successfully!');\n    } catch (error) {\n      console.error('PDF download error:', error);\n      toast.error('Failed to download document. Please try again.');\n    }\n  };\n\n  const renderMessageText = (text) => {\n    const urlRegex = /(\\/api\\/bot\\/download\\/[a-zA-Z0-9_-]+\\.pdf)/g;\n    const parts = text.split(urlRegex);\n    \n    return parts.map((part, i) => {\n      if (urlRegex.test(part)) {\n        return (\n          <button\n            key={i}\n            onClick={(e) => {\n              e.preventDefault();\n              e.stopPropagation();\n              handlePdfDownload(part);\n            }}\n            className=\"text-blue-400 underline hover:text-blue-300 break-all bg-transparent border-0 cursor-pointer text-left p-0 font-medium\"\n          >\n            📄 Download Document\n          </button>\n        );\n      }\n      return part;\n    });\n  };\n\n  useEffect(() => {\n    if ((showChatModal || showBotModal) && employeeData && !socketRef.current) {\n      const socket = io('/employee', {\n        auth: { token: localStorage.getItem('token') },\n        transports: ['websocket', 'polling'],\n        reconnection: true,\n        reconnectionAttempts: 5,\n        reconnectionDelay: 1000\n      });\n\n      socket.on('connect', () => {\n        console.log('Socket connected:', socket.id);\n      });\n\n      socket.on('connect_error', (error) => {\n        console.error('Socket connection error:', error);\n      });\n\n      socket.on('reconnect', (attemptNumber) => {\n        console.log('Socket reconnected after', attemptNumber, 'attempts');\n      });\n\n      const handlePresenceSync = (data) => {\n        console.log('Presence sync:', data);\n        if (data.onlineUsers) {\n          setOnlineUsers(new Set(data.onlineUsers));\n        }\n      };\n\n      const handlePresenceUpdate = (data) => {\n        console.log('Presence update:', data);\n        setOnlineUsers(prev => {\n          const updated = new Set(prev);\n          if (data.status === 'online') {\n            updated.add(data.userId);\n          } else {\n            updated.delete(data.userId);\n          }\n          return updated;\n        });\n      };\n\n      const handleTypingStart = (data) => {\n        setTypingUsers(prev => new Set(prev).add(data.from));\n      };\n\n      const handleTypingStop = (data) => {\n        setTypingUsers(prev => {\n          const updated = new Set(prev);\n          updated.delete(data.from);\n          return updated;\n        });\n      };\n\n      const handleMessage = (msg) => {\n        console.log('Received message:', msg);\n\n        if (msg.fromBot) {\n          setBotMessages(prev => {\n            if (prev.some(m => m._id === msg._id)) return prev;\n            return [...prev, msg];\n          });\n          setLoadingBot(false);\n          if (botTimeoutRef.current) {\n            clearTimeout(botTimeoutRef.current);\n            botTimeoutRef.current = null;\n          }\n          return;\n        }\n\n        setChatMessages(prev => {\n          if (msg.clientMessageId) {\n            const tempIndex = prev.findIndex(m => m.clientMessageId === msg.clientMessageId);\n            if (tempIndex !== -1) {\n              const updated = [...prev];\n              updated[tempIndex] = { ...msg, self: msg.self };\n              return updated;\n            }\n          }\n          if (prev.some(m => m._id === msg._id)) return prev;\n          return [...prev, msg];\n        });\n      };\n\n      const handleError = (error) => {\n        console.error('Socket error:', error);\n        if (error?.type === 'SELF_CHAT_PREVENTED') {\n          toast.error('You cannot send messages to yourself');\n        } else if (error?.message) {\n          toast.error(error.message);\n        } else {\n          toast.error('Chat error occurred');\n        }\n      };\n\n      socket.on('message', handleMessage);\n      socket.on('error', handleError);\n      socket.on('presence:sync', handlePresenceSync);\n      socket.on('presence:update', handlePresenceUpdate);\n      socket.on('typing:start', handleTypingStart);\n      socket.on('typing:stop', handleTypingStop);\n\n      socketRef.current = socket;\n\n      return () => {\n        socket.off('message', handleMessage);\n        socket.off('error', handleError);\n        socket.off('connect');\n        socket.off('connect_error');\n        socket.off('reconnect');\n        socket.off('presence:sync', handlePresenceSync);\n        socket.off('presence:update', handlePresenceUpdate);\n        socket.off('typing:start', handleTypingStart);\n        socket.off('typing:stop', handleTypingStop);\n        socket.disconnect();\n        socketRef.current = null;\n      };\n    }\n\n    if (!showChatModal && !showBotModal && socketRef.current) {\n      socketRef.current.disconnect();\n      socketRef.current = null;\n    }\n  }, [showChatModal, showBotModal, employeeData]);\n\n  useEffect(() => {\n    if (showChatModal && employeeData) {\n      const fetchChatUsers = async () => {\n        try {\n          const res = await employeeAPI.get('/messages/chat-users');\n          if (res.data.success) {\n            setPeers(res.data.data);\n            res.data.data.forEach(user => {\n              if (user.isOnline) {\n                setOnlineUsers(prev => new Set(prev).add(user._id));\n              }\n            });\n            if (res.data.data.length > 0 && !selectedPeer) {\n              setSelectedPeer(res.data.data[0]);\n            }\n          }\n        } catch (err) {\n          console.error('Failed to load chat users:', err);\n          toast.error('Could not load employee list for chat');\n        }\n      };\n      fetchChatUsers();\n    }\n  }, [showChatModal, employeeData]);\n\n  useEffect(() => {\n    if (selectedPeer && employeeData) {\n      const loadChatHistory = async () => {\n        setLoadingChat(true);\n        setChatMessages([]); // Clear previous messages\n        try {\n          // selectedPeer is an employee object with _id directly, not nested under user\n          const peerId = selectedPeer._id || selectedPeer.user?._id;\n          if (!peerId) {\n            console.error('No peer ID found:', selectedPeer);\n            setLoadingChat(false);\n            return;\n          }\n\n          const response = await employeeAPI.get(`/messages/history/${peerId}`);\n          if (response.data.success) {\n            const currentUserId = employeeData.id || employeeData._id;\n            const normalized = response.data.data.map(msg => {\n              const msgFromId = msg.from?._id || msg.from;\n              const isSelf = String(msgFromId) === String(currentUserId);\n              return {\n                _id: msg._id,\n                from: msgFromId,\n                fromName: msg.from?.fullName ||\n                         (msg.from?.personalInfo?.firstName && msg.from?.personalInfo?.lastName\n                           ? `${msg.from.personalInfo.firstName} ${msg.from.personalInfo.lastName}`\n                           : 'Unknown'),\n                to: msg.to?._id || msg.to,\n                text: msg.text,\n                timestamp: msg.timestamp,\n                self: isSelf,\n                fromBot: msg.fromBot || false\n              };\n            });\n            setChatMessages(normalized);\n          }\n        } catch (err) {\n          console.error('Failed to load chat history:', err);\n          toast.error('Could not load chat history');\n          setChatMessages([]);\n        } finally {\n          setLoadingChat(false);\n        }\n      };\n      loadChatHistory();\n    } else {\n      setChatMessages([]);\n    }\n  }, [selectedPeer, employeeData]);\n\n  const sendMessage = async () => {\n    if (!newMessage.trim() || !selectedPeer) {\n      console.log('Cannot send message:', { newMessage, selectedPeer });\n      return;\n    }\n\n    const peerId = selectedPeer._id || selectedPeer.user?._id;\n    const currentUserId = employeeData.id || employeeData._id;\n\n    if (!peerId || !currentUserId) {\n      console.error('Missing IDs:', { peerId, currentUserId });\n      toast.error('Unable to send message - missing user information');\n      return;\n    }\n\n    if (String(peerId) === String(currentUserId)) {\n      toast.error('You cannot send messages to yourself');\n      return;\n    }\n\n    const clientMessageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const message = {\n      from: currentUserId,\n      fromName: `${employeeData.personalInfo.firstName} ${employeeData.personalInfo.lastName}`,\n      to: peerId,\n      text: newMessage.trim(),\n      timestamp: new Date().toISOString(),\n      clientMessageId\n    };\n\n    setChatMessages(prev => [...prev, { ...message, _id: clientMessageId, self: true, pending: true }]);\n    setNewMessage('');\n\n    try {\n      if (socketRef.current && socketRef.current.connected) {\n        console.log('Sending message via socket:', message);\n        socketRef.current.emit('message', message);\n      } else {\n        console.log('Socket not connected, using HTTP fallback');\n        const response = await employeeAPI.post('/messages', { to: peerId, text: message.text });\n        if (response.data.success) {\n          setChatMessages(prev => prev.map(m =>\n            m.clientMessageId === clientMessageId ? { ...response.data.data, self: true } : m\n          ));\n        }\n      }\n    } catch (err) {\n      console.error('Failed to send message:', err);\n      setChatMessages(prev => prev.filter(m => m.clientMessageId !== clientMessageId));\n      toast.error('Failed to send message');\n      setNewMessage(message.text);\n    }\n  };\n\n  const sendBotMessage = async () => {\n    if (!newBotMessage.trim()) return;\n\n    const userMessage = {\n      from: employeeData.id,\n      to: employeeData.id,\n      text: newBotMessage.trim(),\n      timestamp: new Date().toISOString(),\n      self: true\n    };\n\n    const tempId = 'temp-' + Date.now();\n    setBotMessages(prev => [...prev, { ...userMessage, _id: tempId }]);\n    setLoadingBot(true);\n\n    botTimeoutRef.current = setTimeout(() => {\n      setLoadingBot(false);\n      botTimeoutRef.current = null;\n      toast.error('Bot is taking longer than expected. Please try again.');\n    }, 10000);\n\n    try {\n      const response = await API.post('/bot/message', {\n        text: newBotMessage.trim(),\n        userId: employeeData.id\n      });\n\n      if (response.data.success) {\n        const botMessage = {\n          _id: 'bot-' + Date.now(),\n          from: null,\n          to: employeeData.id,\n          text: response.data.response,\n          timestamp: new Date().toISOString(),\n          self: false,\n          fromBot: true\n        };\n        setBotMessages(prev => [...prev, botMessage]);\n      } else {\n        toast.error('Failed to get bot response');\n      }\n    } catch (err) {\n      console.error('Bot message error:', err);\n      toast.error('Failed to send message to bot');\n    } finally {\n      setLoadingBot(false);\n      if (botTimeoutRef.current) {\n        clearTimeout(botTimeoutRef.current);\n        botTimeoutRef.current = null;\n      }\n    }\n    setNewBotMessage('');\n  };\n\n  const markAttendance = () => {\n    // Redirect to attendance page for face verification\n    window.location.href = '/employee/attendance';\n  };\n\n  const recentNotices = [\n    { id: 1, title: \"Company Holiday Announcement\", message: \"Office will be closed on October 15th for Diwali festival.\", date: \"2024-10-10\", priority: \"High\" },\n    { id: 2, title: \"New HR Policy Update\", message: \"Please review the updated attendance policy.\", date: \"2024-10-08\", priority: \"Medium\" },\n    { id: 3, title: \"Team Meeting Scheduled\", message: \"Monthly team sync meeting scheduled for tomorrow at 2 PM.\", date: \"2024-10-09\", priority: \"Medium\" }\n  ];\n\n  const getStatusColor = (status) => {\n    switch (status.toLowerCase()) {\n      case 'completed': case 'on track': return 'text-green-400 bg-green-400/20';\n      case 'in progress': case 'nearly complete': return 'text-yellow-400 bg-yellow-400/20';\n      case 'pending': case 'not started': return 'text-red-400 bg-red-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  const getPriorityColor = (priority) => {\n    switch (priority.toLowerCase()) {\n      case 'high': return 'text-red-400 bg-red-400/20';\n      case 'medium': return 'text-yellow-400 bg-yellow-400/20';\n      case 'low': return 'text-green-400 bg-green-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  if (loading) {\n    return (\n      <EmployeeLayout>\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"text-white\">Loading your dashboard...</div>\n        </div>\n      </EmployeeLayout>\n    );\n  }\n\n  const displayName = employeeData?.personalInfo ? \n    `${employeeData.personalInfo.firstName} ${employeeData.personalInfo.lastName}` : \n    employeeData?.fullName || 'Employee';\n  const displayPosition = employeeData?.workInfo?.position || 'Employee';\n  const displayDepartment = employeeData?.workInfo?.department || 'General';\n  const displayEmployeeId = employeeData?.employeeId || employeeData?.user?.employeeId || 'N/A';\n\n  const handleCloseChatModal = () => {\n    setShowChatModal(false);\n    setNewMessage('');\n    // Don't clear selectedPeer and messages immediately to avoid flash\n    setTimeout(() => {\n      setSelectedPeer(null);\n      setChatMessages([]);\n    }, 300);\n  };\n\n  const handleCloseBotModal = () => {\n    setShowBotModal(false);\n    setNewBotMessage('');\n    setTimeout(() => {\n      setBotMessages([]);\n    }, 300);\n  };\n\n  return (\n    <EmployeeLayout employeeData={employeeData}>\n      <div className=\"space-y-6\">\n        {/* Welcome Section */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <div className=\"flex flex-col md:flex-row md:items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <div className=\"w-16 h-16 bg-gradient-to-r from-neon-pink to-neon-purple rounded-2xl flex items-center justify-center\">\n                <User className=\"w-8 h-8 text-white\" />\n              </div>\n              <div>\n                <h1 className=\"text-3xl font-bold text-white mb-1\">\n                  Welcome, <span className=\"neon-text\">{displayName}!</span>\n                </h1>\n                <p className=\"text-secondary-400\">{displayPosition} • {displayDepartment}</p>\n                <p className=\"text-sm text-neon-pink\">Employee ID: {displayEmployeeId}</p>\n              </div>\n            </div>\n            <div className=\"mt-4 md:mt-0 text-right\">\n              <p className=\"text-lg font-semibold text-white\">{currentTime.toLocaleTimeString()}</p>\n              <p className=\"text-secondary-400\">\n                {currentTime.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n              </p>\n            </div>\n          </div>\n        </div>\n\n        {/* Quick Stats */}\n        {dashboardStats && (\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n            {dashboardStats.map((stat, index) => (\n              <div key={index} className=\"glass-morphism neon-border rounded-2xl p-6 hover-glow\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <div className={`w-12 h-12 bg-gradient-to-r ${stat.color} rounded-lg flex items-center justify-center`}>\n                    <stat.icon className=\"w-6 h-6 text-white\" />\n                  </div>\n                </div>\n                <div>\n                  <h3 className=\"text-2xl font-bold text-white mb-1\">{stat.value}</h3>\n                  <p className=\"text-secondary-400 text-sm mb-2\">{stat.title}</p>\n                  <p className=\"text-xs text-neon-pink\">{stat.change}</p>\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n\n        {/* Attendance Section */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <h2 className=\"text-xl font-bold text-white\">Today's Attendance</h2>\n            <Clock className=\"w-5 h-5 text-neon-pink\" />\n          </div>\n          <div className=\"flex flex-col md:flex-row md:items-center justify-between\">\n            <div className=\"flex items-center space-x-4 mb-4 md:mb-0\">\n              <div className={`w-4 h-4 rounded-full ${hasCheckedIn ? 'bg-green-400' : 'bg-red-400'} animate-pulse`}></div>\n              <div>\n                <p className=\"text-white font-medium\">\n                  Status: <span className={hasCheckedIn ? 'text-green-400' : 'text-red-400'}>\n                    {hasCheckedIn ? (hasCheckedOut ? 'Completed for today' : 'Checked In') : 'Not Marked'}\n                  </span>\n                </p>\n                {todayAttendance && (\n                  <div className=\"text-sm text-secondary-400 space-y-1\">\n                    {todayAttendance.checkInTime && <p>Check-in: {new Date(todayAttendance.checkInTime).toLocaleTimeString()}</p>}\n                    {hasCheckedIn && !hasCheckedOut && realTimeWorkingTime > 0 && (\n                      <p className=\"text-green-400\">Working Time: {Math.floor(realTimeWorkingTime / 60)}h {realTimeWorkingTime % 60}m</p>\n                    )}\n                    {todayAttendance.checkOutTime && <p>Check-out: {new Date(todayAttendance.checkOutTime).toLocaleTimeString()}</p>}\n                  </div>\n                )}\n                {location && (\n                  <p className=\"text-xs text-secondary-400 flex items-center mt-1\">\n                    <MapPin className=\"w-3 h-3 mr-1\" /> Location ready\n                  </p>\n                )}\n              </div>\n            </div>\n            {!hasCheckedIn && (\n              <div className=\"flex flex-col space-y-2\">\n                <button\n                  onClick={markAttendance}\n                  className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 flex items-center justify-center\"\n                >\n                  <Camera className=\"w-4 h-4 mr-2\" /> Mark Attendance with Face Verification\n                </button>\n                <p className=\"text-xs text-secondary-400 text-center\">\n                  Face verification required\n                </p>\n              </div>\n            )}\n            {hasCheckedIn && !hasCheckedOut && (\n              <button\n                onClick={() => window.location.href = '/employee/attendance'}\n                className=\"px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white font-semibold rounded-lg hover-glow\"\n              >\n                <Clock className=\"w-4 h-4 mr-2\" /> Check Out\n              </button>\n            )}\n          </div>\n        </div>\n\n        {/* Main Content Grid */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between mb-6\">\n              <h2 className=\"text-xl font-bold text-white\">Profile Summary</h2>\n              <User className=\"w-5 h-5 text-neon-pink\" />\n            </div>\n            <div className=\"space-y-4\">\n              <div className=\"flex justify-between items-center p-3 bg-secondary-800/30 rounded-lg\">\n                <span className=\"text-secondary-400\">Employee ID</span>\n                <span className=\"text-white font-medium\">{displayEmployeeId}</span>\n              </div>\n              <div className=\"flex justify-between items-center p-3 bg-secondary-800/30 rounded-lg\">\n                <span className=\"text-secondary-400\">Department</span>\n                <span className=\"text-white font-medium\">{displayDepartment}</span>\n              </div>\n              <div className=\"flex justify-between items-center p-3 bg-secondary-800/30 rounded-lg\">\n                <span className=\"text-secondary-400\">Join Date</span>\n                <span className=\"text-white font-medium\">\n                  {employeeData?.workInfo?.joiningDate ? new Date(employeeData.workInfo.joiningDate).toLocaleDateString() : 'N/A'}\n                </span>\n              </div>\n              <div className=\"flex justify-between items-center p-3 bg-secondary-800/30 rounded-lg\">\n                <span className=\"text-secondary-400\">Email</span>\n                <span className=\"text-white font-medium\">{employeeData?.contactInfo?.personalEmail || employeeData?.user?.email || 'N/A'}</span>\n              </div>\n              <div className=\"flex justify-between items-center p-3 bg-secondary-800/30 rounded-lg\">\n                <span className=\"text-secondary-400\">Phone</span>\n                <span className=\"text-white font-medium\">{employeeData?.contactInfo?.phone || 'N/A'}</span>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between mb-6\">\n              <h2 className=\"text-xl font-bold text-white\">Latest Notices</h2>\n              <Bell className=\"w-5 h-5 text-neon-purple\" />\n            </div>\n            <div className=\"space-y-4 max-h-80 overflow-y-auto\">\n              {recentNotices.map((notice) => (\n                <div key={notice.id} className=\"p-4 border border-secondary-600 rounded-lg hover:border-neon-pink/30\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <h4 className=\"text-white font-medium\">{notice.title}</h4>\n                    <span className={`text-xs px-2 py-1 rounded-full ${getPriorityColor(notice.priority)}`}>\n                      {notice.priority}\n                    </span>\n                  </div>\n                  <p className=\"text-secondary-400 text-sm mb-2\">{notice.message}</p>\n                  <p className=\"text-xs text-neon-pink\">{new Date(notice.date).toLocaleDateString()}</p>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <h2 className=\"text-xl font-bold text-white mb-6\">Quick Actions</h2>\n          <div className=\"grid grid-cols-2 md:grid-cols-6 gap-4\">\n            <button \n              onClick={() => window.location.href = '/employee/attendance'}\n              className=\"p-4 rounded-lg border-2 border-dashed border-secondary-600 hover:border-neon-pink/50 hover:bg-neon-pink/5 group\"\n            >\n              <Clock className=\"w-8 h-8 text-secondary-400 group-hover:text-neon-pink mx-auto mb-2\" />\n              <p className=\"text-sm text-secondary-400 group-hover:text-white\">My Attendance</p>\n            </button>\n            <button \n              onClick={() => window.location.href = '/employee/leaves'}\n              className=\"p-4 rounded-lg border-2 border-dashed border-secondary-600 hover:border-neon-purple/50 hover:bg-neon-purple/5 group\"\n            >\n              <Calendar className=\"w-8 h-8 text-secondary-400 group-hover:text-neon-purple mx-auto mb-2\" />\n              <p className=\"text-sm text-secondary-400 group-hover:text-white\">Apply Leave</p>\n            </button>\n            <button\n              onClick={handleViewPayslip}\n              className=\"p-4 rounded-lg border-2 border-dashed border-secondary-600 hover:border-neon-pink/50 hover:bg-neon-pink/5 group\">\n              <FileText className=\"w-8 h-8 text-secondary-400 group-hover:text-neon-pink mx-auto mb-2\" />\n              <p className=\"text-sm text-secondary-400 group-hover:text-white\">View Payslip</p>\n            </button>\n            <button \n              onClick={() => setShowChatModal(true)}\n              className=\"p-4 rounded-lg border-2 border-dashed border-secondary-600 hover:border-neon-purple/50 hover:bg-neon-purple/5 group\"\n            >\n              <MessageCircle className=\"w-8 h-8 text-secondary-400 group-hover:text-neon-purple mx-auto mb-2\" />\n              <p className=\"text-sm text-secondary-400 group-hover:text-white\">Chat with Team</p>\n            </button>\n            <button \n              onClick={() => setShowGroupChatModal(true)}\n              className=\"p-4 rounded-lg border-2 border-dashed border-secondary-600 hover:border-green-500/50 hover:bg-green-500/5 group\"\n            >\n              <Users className=\"w-8 h-8 text-secondary-400 group-hover:text-green-400 mx-auto mb-2\" />\n              <p className=\"text-sm text-secondary-400 group-hover:text-white\">Group Chats</p>\n            </button>\n            <button \n              onClick={() => setShowBotModal(true)}\n              className=\"p-4 rounded-lg border-2 border-dashed border-secondary-600 hover:border-blue-500/50 hover:bg-blue-500/5 group\"\n            >\n              <Bot className=\"w-8 h-8 text-secondary-400 group-hover:text-blue-400 mx-auto mb-2\" />\n              <p className=\"text-sm text-secondary-400 group-hover:text-white\">HR Bot</p>\n            </button>\n          </div>\n        </div>\n\n        {/* Chat Modal - rendered inline to prevent remounting */}\n        {showChatModal && (\n          <div className=\"fixed inset-0 z-[99999] flex items-center justify-center p-4\">\n            <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md z-[99998]\" onClick={handleCloseChatModal} />\n            <div className=\"relative z-[99999] glass-morphism neon-border rounded-2xl w-full max-w-4xl h-[80vh] flex flex-col shadow-2xl bg-gray-900\">\n              <div className=\"flex items-center justify-between p-4 border-b border-secondary-700\">\n                <h2 className=\"text-xl font-bold text-white flex items-center\">\n                  <MessageCircle className=\"w-5 h-5 mr-2 text-neon-pink\" />\n                  Employee Chat\n                </h2>\n                <button onClick={handleCloseChatModal} className=\"text-secondary-400 hover:text-white transition-colors\">\n                  <X className=\"w-6 h-6\" />\n                </button>\n              </div>\n              <div className=\"flex flex-1 overflow-hidden\">\n                <div className=\"w-1/3 border-r border-secondary-700 overflow-y-auto\">\n                  <div className=\"p-3 text-sm text-secondary-400 font-medium\">Colleagues ({peers.length})</div>\n                  {peers.length === 0 ? (\n                    <div className=\"p-4 text-center text-secondary-500 text-sm\">No colleagues available</div>\n                  ) : (\n                    peers.map(peer => {\n                      const isOnline = onlineUsers.has(peer._id);\n                      const peerName = peer.name || 'Unknown';\n                      return (\n                        <div\n                          key={peer._id}\n                          onClick={() => setSelectedPeer(peer)}\n                          className={`p-3 border-l-4 cursor-pointer transition-colors ${\n                            selectedPeer?._id === peer._id\n                              ? 'border-neon-pink bg-secondary-800/50 text-white'\n                              : 'border-transparent text-secondary-400 hover:bg-secondary-800/30'\n                          }`}\n                        >\n                          <div className=\"flex items-center justify-between\">\n                            <div className=\"font-medium truncate\">{peerName}</div>\n                            <div className={`w-2.5 h-2.5 rounded-full flex-shrink-0 ml-2 ${isOnline ? 'bg-green-500' : 'bg-gray-500'}`} title={isOnline ? 'Online' : 'Offline'} />\n                          </div>\n                          <div className=\"text-xs text-secondary-500 flex items-center gap-1\">\n                            <span>{peer.position || peer.workInfo?.position || 'Employee'}</span>\n                            {isOnline && <span className=\"text-green-400\">• Online</span>}\n                          </div>\n                        </div>\n                      );\n                    })\n                  )}\n                </div>\n                <div className=\"flex-1 flex flex-col\">\n                  {selectedPeer ? (\n                    <>\n                      <div className=\"p-3 border-b border-secondary-700 bg-secondary-800/30\">\n                        <div className=\"flex items-center gap-2\">\n                          <div className=\"font-bold text-white\">{selectedPeer.name || 'Unknown User'}</div>\n                          <div className={`w-2 h-2 rounded-full ${onlineUsers.has(selectedPeer._id) ? 'bg-green-500' : 'bg-gray-500'}`} />\n                        </div>\n                        <div className=\"text-sm text-secondary-400 flex items-center gap-2\">\n                          <span>{selectedPeer.position || selectedPeer.workInfo?.position || 'Employee'}</span>\n                          {onlineUsers.has(selectedPeer._id) ? (\n                            typingUsers.has(selectedPeer._id) ? (\n                              <span className=\"text-neon-pink animate-pulse\">typing...</span>\n                            ) : (\n                              <span className=\"text-green-400\">Online</span>\n                            )\n                          ) : (\n                            <span className=\"text-gray-500\">Offline</span>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex-1 overflow-y-auto p-4 space-y-3 bg-secondary-900/30 relative\">\n                        {loadingChat ? (\n                          <div className=\"flex items-center justify-center h-full\">\n                            <div className=\"text-secondary-500\">Loading chat history...</div>\n                          </div>\n                        ) : (\n                          <>\n                            {(() => {\n                              const currentUserId = String(employeeData.id || employeeData._id);\n                              const selectedPeerId = String(selectedPeer._id || selectedPeer.user?._id);\n                              const filteredMessages = chatMessages.filter(msg => {\n                                const msgFrom = String(msg.from || '');\n                                const msgTo = String(msg.to || '');\n                                return (msgFrom === currentUserId && msgTo === selectedPeerId) ||\n                                       (msgFrom === selectedPeerId && msgTo === currentUserId);\n                              });\n                              if (filteredMessages.length === 0) {\n                                return (\n                                  <div className=\"flex flex-col items-center justify-center h-full text-secondary-500\">\n                                    <MessageCircle className=\"w-16 h-16 mb-3 opacity-30\" />\n                                    <p className=\"text-sm\">No messages yet</p>\n                                    <p className=\"text-xs mt-1\">Start a conversation with {selectedPeer.name || 'this colleague'}</p>\n                                  </div>\n                                );\n                              }\n                              return filteredMessages.map((msg, idx) => (\n                                <div key={msg._id || `msg-${idx}`} className={`flex ${msg.self ? 'justify-end' : 'justify-start'}`}>\n                                  <div className={`max-w-xs md:max-w-md p-3 rounded-lg ${msg.self ? 'bg-gradient-to-r from-neon-pink to-neon-purple text-white' : 'bg-secondary-800 text-white'}`}>\n                                    {!msg.self && (\n                                      <div className=\"text-xs text-secondary-400 mb-1 font-medium\">\n                                        {msg.fromName || selectedPeer.name || 'Unknown'}\n                                      </div>\n                                    )}\n                                    <div className=\"text-sm break-words\">{msg.text}</div>\n                                    <div className={`text-xs mt-1 ${msg.self ? 'text-pink-200' : 'text-secondary-400'}`}>\n                                      {new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n                                    </div>\n                                  </div>\n                                </div>\n                              ));\n                            })()}\n                            <div ref={messagesEndRef} />\n                          </>\n                        )}\n                      </div>\n                      <div className=\"p-3 border-t border-secondary-700\">\n                        <form onSubmit={(e) => { e.preventDefault(); sendMessage(); }} className=\"flex\">\n                          <input\n                            type=\"text\"\n                            value={newMessage}\n                            onChange={handleChatMessageChange}\n                            onKeyDown={(e) => {\n                              if (e.key === 'Enter' && !e.shiftKey) {\n                                e.preventDefault();\n                                sendMessage();\n                              }\n                            }}\n                            placeholder=\"Type a message...\"\n                            className=\"flex-1 px-4 py-2 bg-secondary-800 border border-secondary-600 rounded-l-lg text-white placeholder-secondary-500 focus:outline-none focus:ring-2 focus:ring-neon-pink focus:border-transparent\"\n                            autoComplete=\"off\"\n                          />\n                          <button\n                            type=\"submit\"\n                            disabled={!newMessage.trim()}\n                            className=\"px-4 bg-gradient-to-r from-neon-pink to-neon-purple text-white rounded-r-lg disabled:opacity-50 disabled:cursor-not-allowed hover:opacity-90 transition-opacity\"\n                          >\n                            <Send className=\"w-4 h-4\" />\n                          </button>\n                        </form>\n                      </div>\n                    </>\n                  ) : (\n                    <div className=\"flex-1 flex items-center justify-center text-secondary-500\">\n                      Select a colleague to start chatting\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Bot Modal - rendered inline to prevent remounting */}\n        {showBotModal && (\n          <div className=\"fixed inset-0 z-[9999] flex items-center justify-center p-4\">\n            <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" onClick={handleCloseBotModal} />\n            <div className=\"relative glass-morphism neon-border rounded-2xl w-full max-w-md h-[70vh] flex flex-col shadow-2xl\">\n              <div className=\"flex items-center justify-between p-4 border-b border-secondary-700\">\n                <h2 className=\"text-xl font-bold text-white flex items-center\">\n                  <Bot className=\"w-5 h-5 mr-2 text-blue-400\" />\n                  HR Assistant\n                </h2>\n                <button onClick={handleCloseBotModal} className=\"text-secondary-400 hover:text-white transition-colors\">\n                  <X className=\"w-6 h-6\" />\n                </button>\n              </div>\n              <div\n                ref={botMessagesContainerRef}\n                className=\"flex-1 overflow-y-auto p-4 space-y-3 bg-secondary-900/30 relative\"\n                onScroll={() => {\n                  if (botMessagesContainerRef.current) {\n                    const { scrollTop, clientHeight, scrollHeight } = botMessagesContainerRef.current;\n                    isUserScrolledUp.current = scrollTop + clientHeight < scrollHeight - 50;\n                  }\n                }}\n              >\n                {botMessages.length === 0 && !loadingBot ? (\n                  <div className=\"flex flex-col items-center justify-center h-full text-secondary-500\">\n                    <Bot className=\"w-16 h-16 mb-3 opacity-30\" />\n                    <p className=\"text-sm\">Hi! I'm your HR Assistant</p>\n                    <p className=\"text-xs mt-1 text-center px-4\">Ask me about leave policies, attendance, salary slips, or any HR-related questions.</p>\n                  </div>\n                ) : (\n                  <>\n                    {botMessages.map((msg, idx) => (\n                      <div\n                        key={msg._id || idx}\n                        className={`max-w-xs p-3 rounded-lg ${\n                          msg.self\n                            ? 'ml-auto bg-gradient-to-r from-neon-pink to-neon-purple text-white'\n                            : msg.fromBot\n                              ? 'mr-auto bg-blue-600/20 border border-blue-500/30 text-white'\n                              : 'mr-auto bg-secondary-800 text-white'\n                        }`}\n                      >\n                        <div className=\"text-sm\">\n                          {renderMessageText(msg.text)}\n                        </div>\n                        <div className={`text-xs mt-1 ${msg.self ? 'text-pink-200' : 'text-blue-200'}`}>\n                          {new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n                        </div>\n                      </div>\n                    ))}\n                    <div ref={botMessagesEndRef} />\n                  </>\n                )}\n                {loadingBot && (\n                  <div className=\"flex items-center text-secondary-500 p-3\">\n                    <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-400 mr-2\"></div>\n                    Bot is thinking...\n                  </div>\n                )}\n              </div>\n              <div className=\"p-3 border-t border-secondary-700\">\n                <div className=\"flex\">\n                  <input\n                    type=\"text\"\n                    value={newBotMessage}\n                    onChange={(e) => setNewBotMessage(e.target.value)}\n                    onKeyDown={(e) => {\n                      if (e.key === 'Enter' && !e.shiftKey) {\n                        e.preventDefault();\n                        sendBotMessage();\n                      }\n                    }}\n                    placeholder=\"Ask HR Assistant...\"\n                    className=\"flex-1 px-4 py-2 bg-secondary-800 border border-secondary-600 rounded-l-lg text-white focus:outline-none focus:ring-1 focus:ring-blue-400\"\n                    disabled={loadingBot}\n                  />\n                  <button\n                    onClick={sendBotMessage}\n                    disabled={!newBotMessage.trim() || loadingBot}\n                    className=\"px-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-r-lg disabled:opacity-50\"\n                  >\n                    <Send className=\"w-4 h-4\" />\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Payslip Modal */}\n        {showPayslipModal && employeeData && (\n          <div className=\"fixed inset-0 z-[99999] flex items-center justify-center p-4\">\n            <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md z-[99998]\" onClick={() => setShowPayslipModal(false)} />\n            <div className=\"relative z-[99999] glass-morphism neon-border rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl bg-gray-900\">\n              <div className=\"flex items-center justify-between p-4 border-b border-secondary-700\">\n                <h2 className=\"text-xl font-bold text-white flex items-center\">\n                  <FileText className=\"w-5 h-5 mr-2 text-neon-pink\" />\n                  Salary Slip - {new Date().toLocaleString('default', { month: 'long', year: 'numeric' })}\n                </h2>\n                <button onClick={() => setShowPayslipModal(false)} className=\"text-secondary-400 hover:text-white transition-colors\">\n                  <X className=\"w-6 h-6\" />\n                </button>\n              </div>\n              <div className=\"p-6 space-y-6\">\n                {payslipLoading ? (\n                  <div className=\"flex items-center justify-center py-12\">\n                    <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-neon-pink\"></div>\n                  </div>\n                ) : !currentPayslip ? (\n                  <div className=\"text-center py-12\">\n                    <FileText className=\"w-16 h-16 text-secondary-600 mx-auto mb-4\" />\n                    <p className=\"text-secondary-400 text-lg\">No payslip generated for current month</p>\n                    <p className=\"text-secondary-500 text-sm mt-2\">Please contact HR for more information</p>\n                  </div>\n                ) : (\n                  <>\n                    {/* Employee Info */}\n                    <div className=\"bg-secondary-800/50 rounded-lg p-4\">\n                      <h3 className=\"text-lg font-semibold text-white mb-3\">Employee Details</h3>\n                      <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                        <div>\n                          <span className=\"text-secondary-400\">Name:</span>\n                          <span className=\"text-white ml-2\">{currentPayslip.employeeName || 'N/A'}</span>\n                        </div>\n                        <div>\n                          <span className=\"text-secondary-400\">Employee ID:</span>\n                          <span className=\"text-white ml-2\">{currentPayslip.employeeId || 'N/A'}</span>\n                        </div>\n                        <div>\n                          <span className=\"text-secondary-400\">Period:</span>\n                          <span className=\"text-white ml-2\">\n                            {new Date(currentPayslip.period.year, currentPayslip.period.month - 1).toLocaleString('default', { month: 'long', year: 'numeric' })}\n                          </span>\n                        </div>\n                        <div>\n                          <span className=\"text-secondary-400\">Status:</span>\n                          <span className=\"text-white ml-2 capitalize\">{currentPayslip.status || 'N/A'}</span>\n                        </div>\n                      </div>\n                    </div>\n\n                    {/* Attendance Info */}\n                    {currentPayslip.attendance && (\n                      <div className=\"bg-secondary-800/50 rounded-lg p-4\">\n                        <h3 className=\"text-lg font-semibold text-blue-400 mb-3\">Attendance Summary</h3>\n                        <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                          <div className=\"flex justify-between\">\n                            <span className=\"text-secondary-400\">Working Days:</span>\n                            <span className=\"text-white\">{currentPayslip.attendance.workingDays || 0}</span>\n                          </div>\n                          <div className=\"flex justify-between\">\n                            <span className=\"text-secondary-400\">Present Days:</span>\n                            <span className=\"text-white\">{currentPayslip.attendance.presentDays || 0}</span>\n                          </div>\n                          <div className=\"flex justify-between\">\n                            <span className=\"text-secondary-400\">Leave Days:</span>\n                            <span className=\"text-white\">{currentPayslip.attendance.leaveDays || 0}</span>\n                          </div>\n                          <div className=\"flex justify-between\">\n                            <span className=\"text-secondary-400\">Absent Days:</span>\n                            <span className=\"text-white\">{currentPayslip.attendance.absentDays || 0}</span>\n                          </div>\n                        </div>\n                      </div>\n                    )}\n\n                    {/* Earnings */}\n                    <div className=\"bg-secondary-800/50 rounded-lg p-4\">\n                      <h3 className=\"text-lg font-semibold text-green-400 mb-3\">Earnings</h3>\n                      <div className=\"space-y-2 text-sm\">\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-secondary-400\">Basic Salary</span>\n                          <span className=\"text-white\">₹{(currentPayslip.earnings?.basicSalary || 0).toLocaleString()}</span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-secondary-400\">HRA</span>\n                          <span className=\"text-white\">₹{(currentPayslip.earnings?.hra || 0).toLocaleString()}</span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-secondary-400\">Medical Allowance</span>\n                          <span className=\"text-white\">₹{(currentPayslip.earnings?.medical || 0).toLocaleString()}</span>\n                        </div>\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-secondary-400\">Transport Allowance</span>\n                          <span className=\"text-white\">₹{(currentPayslip.earnings?.transport || 0).toLocaleString()}</span>\n                        </div>\n                        {(currentPayslip.earnings?.bonus || 0) > 0 && (\n                          <div className=\"flex justify-between\">\n                            <span className=\"text-secondary-400\">Bonus</span>\n                            <span className=\"text-white\">₹{(currentPayslip.earnings?.bonus || 0).toLocaleString()}</span>\n                          </div>\n                        )}\n                        {(currentPayslip.earnings?.overtime || 0) > 0 && (\n                          <div className=\"flex justify-between\">\n                            <span className=\"text-secondary-400\">Overtime</span>\n                            <span className=\"text-white\">₹{(currentPayslip.earnings?.overtime || 0).toLocaleString()}</span>\n                          </div>\n                        )}\n                        <div className=\"flex justify-between\">\n                          <span className=\"text-secondary-400\">Other Allowances</span>\n                          <span className=\"text-white\">₹{(currentPayslip.earnings?.otherAllowances || 0).toLocaleString()}</span>\n                        </div>\n                        <div className=\"flex justify-between border-t border-secondary-600 pt-2 font-semibold\">\n                          <span className=\"text-green-400\">Gross Earnings</span>\n                          <span className=\"text-green-400\">₹{(currentPayslip.grossEarnings || 0).toLocaleString()}</span>\n                        </div>\n                      </div>\n                    </div>\n                  </>\n                )}\n\n                    {/* Deductions */}\n                    {currentPayslip && (\n                      <>\n                        <div className=\"bg-secondary-800/50 rounded-lg p-4\">\n                          <h3 className=\"text-lg font-semibold text-red-400 mb-3\">Deductions</h3>\n                          <div className=\"space-y-2 text-sm\">\n                            <div className=\"flex justify-between\">\n                              <span className=\"text-secondary-400\">Provident Fund (PF)</span>\n                              <span className=\"text-white\">₹{(currentPayslip.deductions?.pf || 0).toLocaleString()}</span>\n                            </div>\n                            <div className=\"flex justify-between\">\n                              <span className=\"text-secondary-400\">ESI</span>\n                              <span className=\"text-white\">₹{(currentPayslip.deductions?.esi || 0).toLocaleString()}</span>\n                            </div>\n                            <div className=\"flex justify-between\">\n                              <span className=\"text-secondary-400\">Tax</span>\n                              <span className=\"text-white\">₹{(currentPayslip.deductions?.tax || 0).toLocaleString()}</span>\n                            </div>\n                            {(currentPayslip.deductions?.professionalTax || 0) > 0 && (\n                              <div className=\"flex justify-between\">\n                                <span className=\"text-secondary-400\">Professional Tax</span>\n                                <span className=\"text-white\">₹{(currentPayslip.deductions?.professionalTax || 0).toLocaleString()}</span>\n                              </div>\n                            )}\n                            {(currentPayslip.deductions?.loanDeduction || 0) > 0 && (\n                              <div className=\"flex justify-between\">\n                                <span className=\"text-secondary-400\">Loan Deduction</span>\n                                <span className=\"text-white\">₹{(currentPayslip.deductions?.loanDeduction || 0).toLocaleString()}</span>\n                              </div>\n                            )}\n                            <div className=\"flex justify-between\">\n                              <span className=\"text-secondary-400\">Other Deductions</span>\n                              <span className=\"text-white\">₹{(currentPayslip.deductions?.otherDeductions || 0).toLocaleString()}</span>\n                            </div>\n                            <div className=\"flex justify-between border-t border-secondary-600 pt-2 font-semibold\">\n                              <span className=\"text-red-400\">Total Deductions</span>\n                              <span className=\"text-red-400\">₹{(currentPayslip.totalDeductions || 0).toLocaleString()}</span>\n                            </div>\n                          </div>\n                        </div>\n\n                        {/* Net Salary */}\n                        <div className=\"bg-gradient-to-r from-neon-pink/20 to-neon-purple/20 rounded-lg p-4 border border-neon-pink/30\">\n                          <div className=\"flex justify-between items-center\">\n                            <span className=\"text-lg font-bold text-white\">Net Salary</span>\n                            <span className=\"text-2xl font-bold text-neon-pink\">₹{(currentPayslip.netSalary || 0).toLocaleString()}</span>\n                          </div>\n                        </div>\n\n                        {/* Bank Info */}\n                        {currentPayslip.bankInfo && (\n                          <div className=\"bg-secondary-800/50 rounded-lg p-4\">\n                            <h3 className=\"text-lg font-semibold text-white mb-3\">Bank Details</h3>\n                            <div className=\"space-y-2 text-sm\">\n                              <div className=\"flex justify-between\">\n                                <span className=\"text-secondary-400\">Bank Name:</span>\n                                <span className=\"text-white\">{currentPayslip.bankInfo.bankName || 'N/A'}</span>\n                              </div>\n                              <div className=\"flex justify-between\">\n                                <span className=\"text-secondary-400\">Account Number:</span>\n                                <span className=\"text-white\">{currentPayslip.bankInfo.accountNumber || 'N/A'}</span>\n                              </div>\n                              <div className=\"flex justify-between\">\n                                <span className=\"text-secondary-400\">IFSC Code:</span>\n                                <span className=\"text-white\">{currentPayslip.bankInfo.ifscCode || 'N/A'}</span>\n                              </div>\n                            </div>\n                          </div>\n                        )}\n\n                        {/* Remarks */}\n                        {currentPayslip.remarks && (\n                          <div className=\"bg-secondary-800/50 rounded-lg p-4\">\n                            <h3 className=\"text-lg font-semibold text-white mb-2\">Remarks</h3>\n                            <p className=\"text-secondary-300 text-sm\">{currentPayslip.remarks}</p>\n                          </div>\n                        )}\n\n                        {/* Download Button */}\n                        <div className=\"flex justify-center pt-4\">\n                          <button\n                            onClick={handleDownloadPayslip}\n                            className=\"flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover:opacity-90 transition-opacity shadow-lg\"\n                          >\n                            <Download className=\"w-5 h-5\" />\n                            Download Payslip PDF\n                          </button>\n                        </div>\n                      </>\n                    )}\n\n\n                <p className=\"text-xs text-secondary-500 text-center\">This is a computer generated payslip and does not require a signature.</p>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Group Chat Modal */}\n        <GroupChatModal\n          isOpen={showGroupChatModal}\n          onClose={() => setShowGroupChatModal(false)}\n          socket={socketRef.current}\n          employeeData={employeeData}\n          onlineUsers={onlineUsers}\n        />\n      </div>\n    </EmployeeLayout>\n  );\n};\n\nexport default EmployeeDashboard;","path":null,"size_bytes":65683,"size_tokens":null},"backend/models/User.js":{"content":"import mongoose from 'mongoose';\nimport bcrypt from 'bcryptjs';\nimport jwt from 'jsonwebtoken';\nimport crypto from 'crypto';\n\nconst userSchema = new mongoose.Schema({\n  name: {\n    type: String,\n    required: [true, 'Name is required'],\n    trim: true,\n    maxlength: [50, 'Name cannot be more than 50 characters']\n  },\n  email: {\n    type: String,\n    required: [true, 'Email is required'],\n    unique: true,\n    lowercase: true,\n    match: [\n      /^\\w+([.-]?\\w+)*@\\w+([.-]?\\w+)*(\\.\\w{2,3})+$/,\n      'Please add a valid email'\n    ]\n  },\n  phone: {\n    type: String,\n    trim: true,\n    default: ''\n  },\n  password: {\n    type: String,\n    required: [true, 'Password is required'],\n    minlength: 6,\n    select: false\n  },\n  role: {\n    type: String,\n    enum: ['admin', 'employee'],\n    default: 'employee'\n  },\n  employeeId: {\n    type: String,\n    unique: true,\n    sparse: true,\n    uppercase: true\n  },\n  isActive: {\n    type: Boolean,\n    default: true\n  },\n  profileImage: {\n    type: String,\n    default: null\n  },\n  lastLogin: {\n    type: Date\n  },\n  loginAttempts: {\n    type: Number,\n    default: 0\n  },\n  lockUntil: {\n    type: Date\n  },\n  resetPasswordToken: String,\n  resetPasswordExpire: Date,\n  emailVerified: {\n    type: Boolean,\n    default: true // Set to true for now, can be false if email verification is implemented\n  },\n  emailVerificationToken: String,\n  emailVerificationExpire: Date\n}, {\n  timestamps: true,\n  toJSON: { virtuals: true },\n  toObject: { virtuals: true }\n});\n\n// Indexes for better performance\nuserSchema.index({ role: 1 });\nuserSchema.index({ isActive: 1 });\n\n// Virtual for checking if account is locked\nuserSchema.virtual('isLocked').get(function() {\n  return !!(this.lockUntil && this.lockUntil > Date.now());\n});\n\n// Auto-generate employeeId for employees\nuserSchema.pre('save', async function(next) {\n  // Only generate employeeId for employees and if not already set\n  if (this.role === 'employee' && !this.employeeId) {\n    try {\n      // Find the last employee ID to generate the next one\n      const lastEmployee = await this.constructor.findOne(\n        { role: 'employee', employeeId: { $exists: true } },\n        {},\n        { sort: { employeeId: -1 } }\n      );\n\n      if (lastEmployee && lastEmployee.employeeId) {\n        // Extract number from last employee ID (e.g., EMP001 -> 1)\n        const lastNumber = parseInt(lastEmployee.employeeId.replace(/\\D/g, ''));\n        const nextNumber = lastNumber + 1;\n        this.employeeId = `EMP${nextNumber.toString().padStart(3, '0')}`;\n      } else {\n        // First employee\n        this.employeeId = 'EMP001';\n      }\n    } catch (error) {\n      return next(error);\n    }\n  }\n  next();\n});\n\n// Encrypt password using bcrypt\nuserSchema.pre('save', async function(next) {\n  if (!this.isModified('password')) {\n    next();\n  }\n\n  const salt = await bcrypt.genSalt(10);\n  this.password = await bcrypt.hash(this.password, salt);\n});\n\n// Sign JWT and return\nuserSchema.methods.getSignedJwtToken = function() {\n  return jwt.sign(\n    { \n      id: this._id,\n      role: this.role,\n      email: this.email,\n      employeeId: this.employeeId\n    },\n    process.env.JWT_SECRET,\n    {\n      expiresIn: process.env.JWT_EXPIRE || '30d'\n    }\n  );\n};\n\n// Match user entered password to hashed password in database\nuserSchema.methods.matchPassword = async function(enteredPassword) {\n  return await bcrypt.compare(enteredPassword, this.password);\n};\n\n// Generate and hash password token\nuserSchema.methods.getResetPasswordToken = function() {\n  // Generate token\n  const resetToken = crypto.randomBytes(20).toString('hex');\n\n  // Hash token and set to resetPasswordToken field\n  this.resetPasswordToken = crypto\n    .createHash('sha256')\n    .update(resetToken)\n    .digest('hex');\n\n  // Set expire\n  this.resetPasswordExpire = Date.now() + 10 * 60 * 1000; // 10 minutes\n\n  return resetToken;\n};\n\n// Handle failed login attempts\nuserSchema.methods.handleFailedLogin = async function() {\n  // Increment login attempts\n  this.loginAttempts += 1;\n\n  // Lock account after configured number of failed attempts\n  const maxAttempts = parseInt(process.env.MAX_LOGIN_ATTEMPTS) || 10;\n  const lockTimeMinutes = parseInt(process.env.LOCK_TIME_MINUTES) || 10;\n\n  if (this.loginAttempts >= maxAttempts) {\n    this.lockUntil = Date.now() + lockTimeMinutes * 60 * 1000; // Configurable lock time\n  }\n\n  await this.save();\n};\n\n// Update last login\nuserSchema.methods.updateLastLogin = async function() {\n  this.lastLogin = new Date();\n  this.loginAttempts = 0; // Reset login attempts on successful login\n  this.lockUntil = undefined; // Remove lock\n  await this.save();\n};\n\n// Manually unlock account (admin function)\nuserSchema.methods.unlockAccount = async function() {\n  this.loginAttempts = 0;\n  this.lockUntil = undefined;\n  await this.save();\n};\n\n// Static method to find by credentials\nuserSchema.statics.findByCredentials = async function(email, password) {\n  const user = await this.findOne({ \n    email: email.toLowerCase(),\n    isActive: true\n  }).select('+password');\n\n  if (!user) {\n    throw new Error('Invalid credentials');\n  }\n\n  // Check if account is locked\n  if (user.isLocked) {\n    throw new Error('Account temporarily locked due to too many failed login attempts');\n  }\n\n  const isMatch = await user.matchPassword(password);\n  if (!isMatch) {\n    // Handle failed login attempt\n    await user.handleFailedLogin();\n    throw new Error('Invalid credentials');\n  }\n\n  // Reset login attempts on successful login\n  if (user.loginAttempts > 0) {\n    user.loginAttempts = 0;\n    user.lockUntil = undefined;\n    await user.save();\n  }\n\n  return user;\n};\n\n// Static method to get user stats\nuserSchema.statics.getStats = async function() {\n  const stats = await this.aggregate([\n    {\n      $group: {\n        _id: null,\n        totalUsers: { $sum: 1 },\n        activeUsers: {\n          $sum: { $cond: [{ $eq: ['$isActive', true] }, 1, 0] }\n        },\n        inactiveUsers: {\n          $sum: { $cond: [{ $eq: ['$isActive', false] }, 1, 0] }\n        },\n        admins: {\n          $sum: { $cond: [{ $eq: ['$role', 'admin'] }, 1, 0] }\n        },\n        employees: {\n          $sum: { $cond: [{ $eq: ['$role', 'employee'] }, 1, 0] }\n        }\n      }\n    }\n  ]);\n\n  return stats[0] || {\n    totalUsers: 0,\n    activeUsers: 0,\n    inactiveUsers: 0,\n    admins: 0,\n    employees: 0\n  };\n};\n\n// Remove sensitive fields when converting to JSON\nuserSchema.methods.toJSON = function() {\n  const user = this.toObject();\n  delete user.password;\n  delete user.resetPasswordToken;\n  delete user.resetPasswordExpire;\n  delete user.emailVerificationToken;\n  delete user.emailVerificationExpire;\n  delete user.loginAttempts;\n  delete user.lockUntil;\n  return user;\n};\n\nexport default mongoose.model('User', userSchema);","path":null,"size_bytes":6796,"size_tokens":null},"backend/routes/messageRoutes.js":{"content":"import express from 'express';\nimport Message from '../models/Message.js';\nimport User from '../models/User.js';\nimport { protect } from '../middleware/auth.js';\nimport { getOnlineUserIds } from '../socket/chat.js';\n\nconst router = express.Router();\n\nrouter.use(protect);\n\nrouter.get('/chat-users', async (req, res) => {\n  try {\n    const currentUserId = req.user.id;\n    \n    // Only fetch other employees (exclude admins and current user)\n    const users = await User.find({ \n      _id: { $ne: currentUserId },\n      role: 'employee',\n      isActive: true\n    })\n    .select('name email employeeId profileImage role')\n    .lean();\n\n    const onlineUserIds = getOnlineUserIds();\n    \n    const chatUsers = users.map(user => {\n      return {\n        _id: user._id.toString(),\n        name: user.name || 'Unknown User',\n        department: 'General',\n        position: 'Employee',\n        avatar: user.profileImage || null,\n        isOnline: onlineUserIds.includes(user._id.toString())\n      };\n    });\n\n    chatUsers.sort((a, b) => {\n      if (a.isOnline && !b.isOnline) return -1;\n      if (!a.isOnline && b.isOnline) return 1;\n      return a.name.localeCompare(b.name);\n    });\n\n    res.json({ success: true, data: chatUsers });\n  } catch (error) {\n    console.error('Failed to get chat users:', error);\n    res.status(500).json({ success: false, message: 'Failed to load chat users' });\n  }\n});\n\nrouter.get('/history/:peerId', async (req, res) => {\n  try {\n    const { peerId } = req.params;\n    const currentUserId = req.user.id;\n\n    if (peerId === currentUserId) {\n      return res.status(400).json({ success: false, message: 'Cannot load chat history with yourself' });\n    }\n\n    const messages = await Message.find({\n      $or: [\n        { from: currentUserId, to: peerId },\n        { from: peerId, to: currentUserId }\n      ]\n    })\n    .sort({ timestamp: 1 })\n    .populate('from', 'name email')\n    .populate('to', 'name email');\n\n    res.json({ success: true, data: messages });\n  } catch (error) {\n    console.error('Failed to load chat history:', error);\n    res.status(500).json({ success: false, message: 'Failed to load chat history' });\n  }\n});\n\nrouter.post('/', async (req, res) => {\n  try {\n    const { to, text } = req.body;\n    const from = req.user.id;\n\n    if (to === from) {\n      return res.status(400).json({ success: false, message: 'Cannot send message to yourself' });\n    }\n\n    if (!text?.trim()) {\n      return res.status(400).json({ success: false, message: 'Message text is required' });\n    }\n\n    const message = new Message({\n      from,\n      to,\n      text: text.trim()\n    });\n    await message.save();\n    \n    res.status(201).json({ success: true, data: message });\n  } catch (error) {\n    console.error('Failed to send message:', error);\n    res.status(500).json({ success: false, message: 'Failed to send message' });\n  }\n});\n\nexport default router;\n","path":null,"size_bytes":2896,"size_tokens":null},"frontend/src/pages/Admin/AdminAttendance.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport AdminLayout from '../../components/Admin/layout/AdminLayout';\nimport { \n  Users, Calendar, Clock, MapPin, Search, Filter, Download, \n  Edit3, Trash2, CheckCircle, XCircle, AlertCircle, Timer,\n  TrendingUp, Building2, User, MoreVertical, RefreshCw, Eye\n} from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport { attendanceAPI } from '../../utils/api';\n\nconst AdminAttendance = () => {\n  const [attendanceRecords, setAttendanceRecords] = useState([]);\n  const [attendanceSummary, setAttendanceSummary] = useState(null);\n  const [loading, setLoading] = useState(false);\n  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().slice(0, 10));\n  const [filters, setFilters] = useState({\n    startDate: new Date().toISOString().slice(0, 10),\n    endDate: new Date().toISOString().slice(0, 10),\n    department: '',\n    status: '',\n    search: ''\n  });\n  const [pagination, setPagination] = useState({\n    current: 1,\n    pages: 1,\n    total: 0\n  });\n  const [showFilters, setShowFilters] = useState(false);\n  const [editingRecord, setEditingRecord] = useState(null);\n  const [viewingRecord, setViewingRecord] = useState(null);\n  const [editForm, setEditForm] = useState({\n    status: '',\n    notes: '',\n    isManualEntry: false,\n    manualEntryReason: ''\n  });\n  const [departments] = useState([\n    'Human Resources', 'Information Technology', 'Finance', 'Marketing',\n    'Operations', 'Sales', 'Customer Service', 'Research & Development'\n  ]);\n\n  useEffect(() => {\n    fetchAttendanceData();\n    fetchAttendanceSummary();\n  }, [filters, pagination.current, selectedDate]);\n\n  const fetchAttendanceData = async () => {\n    try {\n      setLoading(true);\n      const params = {\n        page: pagination.current,\n        limit: 20,\n        ...filters\n      };\n\n      const response = await attendanceAPI.getAllAttendance(params);\n      if (response.data.success) {\n        setAttendanceRecords(response.data.data || []);\n        setPagination(response.data.pagination || { current: 1, pages: 1, total: 0 });\n      }\n\n    } catch (error) {\n      console.error('Error fetching attendance data:', error);\n      toast.error('Failed to fetch attendance records');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const fetchAttendanceSummary = async () => {\n    try {\n      const response = await attendanceAPI.getAttendanceSummary({ date: selectedDate });\n      if (response.data.success) {\n        setAttendanceSummary(response.data.data);\n      }\n    } catch (error) {\n      console.error('Error fetching attendance summary:', error);\n    }\n  };\n\n  const handleFilterChange = (key, value) => {\n    setFilters(prev => ({ ...prev, [key]: value }));\n    setPagination(prev => ({ ...prev, current: 1 }));\n  };\n\n  const handleEditRecord = (record) => {\n    setEditingRecord(record);\n    setEditForm({\n      status: record.status,\n      notes: record.notes || '',\n      isManualEntry: record.isManualEntry || false,\n      manualEntryReason: record.manualEntryReason || ''\n    });\n  };\n\n  const handleUpdateRecord = async () => {\n    try {\n      const response = await attendanceAPI.updateAttendance(editingRecord._id, editForm);\n      if (response.data.success) {\n        toast.success('Attendance record updated successfully');\n        setEditingRecord(null);\n        fetchAttendanceData();\n      }\n    } catch (error) {\n      console.error('Error updating record:', error);\n      toast.error('Failed to update attendance record');\n    }\n  };\n\n  const handleDeleteRecord = async (recordId) => {\n    if (!window.confirm('Are you sure you want to delete this attendance record?')) {\n      return;\n    }\n\n    try {\n      await attendanceAPI.deleteAttendance(recordId);\n      toast.success('Attendance record deleted successfully');\n      fetchAttendanceData();\n    } catch (error) {\n      console.error('Error deleting record:', error);\n      toast.error('Failed to delete attendance record');\n    }\n  };\n\n  const getStatusColor = (status) => {\n    switch (status?.toLowerCase()) {\n      case 'present': return 'text-green-400 bg-green-400/20';\n      case 'late': return 'text-yellow-400 bg-yellow-400/20';\n      case 'half day': return 'text-orange-400 bg-orange-400/20';\n      case 'absent': return 'text-red-400 bg-red-400/20';\n      case 'work from home': return 'text-blue-400 bg-blue-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  const formatTime = (dateString) => {\n    if (!dateString) return '--:--';\n    return new Date(dateString).toLocaleTimeString('en-US', {\n      hour: '2-digit',\n      minute: '2-digit',\n      hour12: true\n    });\n  };\n\n  const formatDate = (dateString) => {\n    if (!dateString) return '--';\n    return new Date(dateString).toLocaleDateString('en-US', {\n      month: 'short',\n      day: 'numeric',\n      year: 'numeric'\n    });\n  };\n\n  const formatWorkingTime = (minutes) => {\n    if (!minutes || minutes === 0) return '0h 0m';\n    const hours = Math.floor(minutes / 60);\n    const mins = minutes % 60;\n    return `${hours}h ${mins}m`;\n  };\n\n  const exportAttendanceData = () => {\n    const csvContent = [\n      ['Date', 'Employee', 'Employee ID', 'Department', 'Check In', 'Check Out', 'Working Time', 'Status'],\n      ...attendanceRecords.map(record => [\n        formatDate(record.date),\n        record.employeeData?.personalInfo ? \n          `${record.employeeData.personalInfo.firstName} ${record.employeeData.personalInfo.lastName}` :\n          record.userData?.name || 'Unknown',\n        record.userData?.employeeId || '',\n        record.employeeData?.workInfo?.department || '',\n        formatTime(record.checkInTime),\n        formatTime(record.checkOutTime),\n        formatWorkingTime(record.workingHours),\n        record.status\n      ])\n    ];\n\n    const csv = csvContent.map(row => row.join(',')).join('\\n');\n    const blob = new Blob([csv], { type: 'text/csv' });\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `attendance_report_${filters.startDate}_to_${filters.endDate}.csv`;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    window.URL.revokeObjectURL(url);\n    toast.success('Attendance report exported successfully');\n  };\n\n  return (\n    <AdminLayout>\n        <div className=\"w-full max-w-screen-lg mx-auto px-2 sm:px-4 md:px-6 lg:px-8 space-y-4 sm:space-y-6\">\n        {/* Header */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <div className=\"flex flex-col md:flex-row md:items-center justify-between\">\n            <div>\n              <h1 className=\"text-3xl font-bold text-white mb-2\">\n                Attendance <span className=\"neon-text\">Management</span>\n              </h1>\n              <p className=\"text-secondary-400\">Monitor and manage employee attendance records</p>\n            </div>\n            <div className=\"mt-4 md:mt-0 flex flex-col space-y-2 md:flex-row md:space-y-0 md:space-x-3\">\n              <button\n                onClick={() => setShowFilters(!showFilters)}\n                className=\"px-3 sm:px-4 py-2 bg-secondary-700 hover:bg-secondary-600 text-white rounded-lg flex items-center space-x-2 transition-colors text-sm\"\n              >\n                <Filter className=\"w-4 h-4\" />\n                <span>Filters</span>\n              </button>\n              <button\n                onClick={exportAttendanceData}\n                disabled={attendanceRecords.length === 0}\n                className=\"px-3 sm:px-4 py-2 bg-neon-purple/20 hover:bg-neon-purple/30 text-neon-purple rounded-lg flex items-center space-x-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm\"\n              >\n                <Download className=\"w-4 h-4\" />\n                <span>Export</span>\n              </button>\n              <button\n                onClick={fetchAttendanceData}\n                className=\"px-3 sm:px-4 py-2 bg-neon-pink/20 hover:bg-neon-pink/30 text-neon-pink rounded-lg flex items-center space-x-2 transition-colors text-sm\"\n              >\n                <RefreshCw className=\"w-4 h-4\" />\n                <span>Refresh</span>\n              </button>\n            </div>\n          </div>\n        </div>\n\n        {/* Summary Cards */}\n        {attendanceSummary && (\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 sm:gap-6\">\n            <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-secondary-400 text-xs sm:text-sm\">Total Employees</p>\n                  <p className=\"text-xl sm:text-2xl font-bold text-white\">{attendanceSummary.overallStats?.totalEmployees || 0}</p>\n                </div>\n                <Users className=\"w-6 h-6 sm:w-8 sm:h-8 text-neon-pink\" />\n              </div>\n            </div>\n            <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-secondary-400 text-xs sm:text-sm\">Present</p>\n                  <p className=\"text-xl sm:text-2xl font-bold text-green-400\">{attendanceSummary.overallStats?.present || 0}</p>\n                </div>\n                <CheckCircle className=\"w-6 h-6 sm:w-8 sm:h-8 text-green-400\" />\n              </div>\n            </div>\n            <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-secondary-400 text-xs sm:text-sm\">Late</p>\n                  <p className=\"text-xl sm:text-2xl font-bold text-yellow-400\">{attendanceSummary.overallStats?.late || 0}</p>\n                </div>\n                <Clock className=\"w-6 h-6 sm:w-8 sm:h-8 text-yellow-400\" />\n              </div>\n            </div>\n            <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-secondary-400 text-xs sm:text-sm\">Half Day</p>\n                  <p className=\"text-xl sm:text-2xl font-bold text-orange-400\">{attendanceSummary.overallStats?.halfDay || 0}</p>\n                </div>\n                <Timer className=\"w-6 h-6 sm:w-8 sm:h-8 text-orange-400\" />\n              </div>\n            </div>\n            <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-secondary-400 text-xs sm:text-sm\">Absent</p>\n                  <p className=\"text-xl sm:text-2xl font-bold text-red-400\">{attendanceSummary.overallStats?.absent || 0}</p>\n                </div>\n                <XCircle className=\"w-6 h-6 sm:w-8 sm:h-8 text-red-400\" />\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Filters */}\n        {showFilters && (\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <h3 className=\"text-lg font-bold text-white mb-4\">Filters & Search</h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4\">\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1 sm:mb-2\">Start Date</label>\n                <input\n                  type=\"date\"\n                  value={filters.startDate}\n                  onChange={(e) => handleFilterChange('startDate', e.target.value)}\n                  className=\"w-full px-2 sm:px-3 py-1.5 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:outline-none focus:border-neon-pink text-xs sm:text-sm\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1 sm:mb-2\">End Date</label>\n                <input\n                  type=\"date\"\n                  value={filters.endDate}\n                  onChange={(e) => handleFilterChange('endDate', e.target.value)}\n                  className=\"w-full px-2 sm:px-3 py-1.5 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:outline-none focus:border-neon-pink text-xs sm:text-sm\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1 sm:mb-2\">Department</label>\n                <select\n                  value={filters.department}\n                  onChange={(e) => handleFilterChange('department', e.target.value)}\n                  className=\"w-full px-2 sm:px-3 py-1.5 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:outline-none focus:border-neon-pink text-xs sm:text-sm\"\n                >\n                  <option value=\"\">All Departments</option>\n                  {departments.map(dept => (\n                    <option key={dept} value={dept}>{dept}</option>\n                  ))}\n                </select>\n              </div>\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1 sm:mb-2\">Status</label>\n                <select\n                  value={filters.status}\n                  onChange={(e) => handleFilterChange('status', e.target.value)}\n                  className=\"w-full px-2 sm:px-3 py-1.5 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:outline-none focus:border-neon-pink text-xs sm:text-sm\"\n                >\n                  <option value=\"\">All Status</option>\n                  <option value=\"Present\">Present</option>\n                  <option value=\"Late\">Late</option>\n                  <option value=\"Half Day\">Half Day</option>\n                  <option value=\"Absent\">Absent</option>\n                  <option value=\"Work from Home\">Work from Home</option>\n                </select>\n              </div>\n            </div>\n            <div className=\"mt-3 sm:mt-4\">\n              <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1 sm:mb-2\">Search Employee</label>\n              <div className=\"relative\">\n                <Search className=\"absolute left-2 sm:left-3 top-1/2 transform -translate-y-1/2 w-3 sm:w-4 h-3 sm:h-4 text-secondary-400\" />\n                <input\n                  type=\"text\"\n                  placeholder=\"Search by name or employee ID...\"\n                  value={filters.search}\n                  onChange={(e) => handleFilterChange('search', e.target.value)}\n                  className=\"w-full pl-8 sm:pl-10 pr-3 sm:pr-4 py-1.5 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white placeholder-secondary-400 focus:outline-none focus:border-neon-pink text-xs sm:text-sm\"\n                />\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Attendance Records Table */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <h2 className=\"text-xl font-bold text-white\">Attendance Records</h2>\n            <p className=\"text-secondary-400\">\n              Showing {attendanceRecords.length} of {pagination.total} records\n            </p>\n          </div>\n\n          <>\n            {/* Mobile Cards */}\n            <div className=\"md:hidden grid gap-3 sm:gap-4 p-3 sm:p-4\">\n              {loading ? (\n                <div className=\"col-span-full text-center py-8 text-secondary-400\">\n                  <div className=\"flex items-center justify-center space-x-2\">\n                    <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-neon-pink\"></div>\n                    <span className=\"text-xs sm:text-sm\">Loading attendance records...</span>\n                  </div>\n                </div>\n              ) : attendanceRecords.length === 0 ? (\n                <div className=\"col-span-full text-center py-8 text-secondary-400\">\n                  <div className=\"flex flex-col items-center space-y-2\">\n                    <Users className=\"w-6 h-6 sm:w-8 sm:h-8 text-secondary-400\" />\n                    <span className=\"text-xs sm:text-sm\">No attendance records found</span>\n                    <span className=\"text-xs\">Try adjusting your filters</span>\n                  </div>\n                </div>\n              ) : (\n                attendanceRecords.map((record) => (\n                  <div key={record._id} className=\"bg-secondary-800/30 border border-secondary-700 rounded-xl p-3 sm:p-4 hover:bg-secondary-800/50 transition-colors\">\n                    <div className=\"flex items-start justify-between mb-2 sm:mb-3\">\n                      <div className=\"flex items-center space-x-2 sm:space-x-3 flex-1 min-w-0\">\n                        <div className=\"w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-r from-neon-pink to-neon-purple rounded-lg flex items-center justify-center flex-shrink-0\">\n                          <User className=\"w-4 h-4 sm:w-5 sm:h-5 text-white\" />\n                        </div>\n                        <div className=\"min-w-0 flex-1\">\n                          <p className=\"text-white font-medium text-xs sm:text-sm truncate\">\n                            {record.employeeData?.personalInfo ?\n                              `${record.employeeData.personalInfo.firstName} ${record.employeeData.personalInfo.lastName}` :\n                              record.userData?.name || 'Unknown'}\n                          </p>\n                          <p className=\"text-xs text-secondary-400 truncate\">\n                            ID: {record.userData?.employeeId || 'N/A'} • {record.employeeData?.workInfo?.department || 'N/A'}\n                          </p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center space-x-1 ml-1 sm:ml-2\">\n                        <button\n                          onClick={() => setViewingRecord(record)}\n                          className=\"p-1 sm:p-1.5 text-secondary-400 hover:text-neon-purple hover:bg-neon-purple/10 rounded-lg transition-colors\"\n                          title=\"View Details\"\n                        >\n                          <Eye className=\"w-3 h-3 sm:w-4 sm:h-4\" />\n                        </button>\n                        <button\n                          onClick={() => handleEditRecord(record)}\n                          className=\"p-1 sm:p-1.5 text-secondary-400 hover:text-neon-pink hover:bg-neon-pink/10 rounded-lg transition-colors\"\n                          title=\"Edit Record\"\n                        >\n                          <Edit3 className=\"w-3 h-3 sm:w-4 sm:h-4\" />\n                        </button>\n                        <button\n                          onClick={() => handleDeleteRecord(record._id)}\n                          className=\"p-1 sm:p-1.5 text-secondary-400 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-colors\"\n                          title=\"Delete Record\"\n                        >\n                          <Trash2 className=\"w-3 h-3 sm:w-4 sm:h-4\" />\n                        </button>\n                      </div>\n                    </div>\n                    <div className=\"space-y-1 sm:space-y-2\">\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-secondary-400 text-xs\">Date</span>\n                        <span className=\"text-white text-xs sm:text-sm\">{formatDate(record.date)}</span>\n                      </div>\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-secondary-400 text-xs\">Check In</span>\n                        <span className=\"text-white text-xs sm:text-sm\">{formatTime(record.checkInTime)}</span>\n                        {record.isLate && (\n                          <span className=\"text-red-400 text-xs ml-1\">{record.lateMinutes}m late</span>\n                        )}\n                      </div>\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-secondary-400 text-xs\">Check Out</span>\n                        <span className=\"text-white text-xs sm:text-sm\">{formatTime(record.checkOutTime)}</span>\n                      </div>\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-secondary-400 text-xs\">Working Time</span>\n                        <span className=\"text-neon-pink text-xs sm:text-sm font-medium\">{formatWorkingTime(record.workingHours)}</span>\n                      </div>\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-secondary-400 text-xs\">Status</span>\n                        <span className={`text-xs px-1 sm:px-2 py-1 rounded-full ${getStatusColor(record.status)}`}>\n                          {record.status}\n                        </span>\n                        {record.isManualEntry && (\n                          <span className=\"text-yellow-400 text-xs ml-1\">Manual</span>\n                        )}\n                      </div>\n                      <div className=\"flex justify-between items-center pt-1 sm:pt-2 border-t border-secondary-700\">\n                        <span className=\"text-secondary-400 text-xs\">Location</span>\n                        <span className=\"text-secondary-400 text-xs truncate max-w-24 sm:max-w-32\">\n                          {record.checkInLocation?.address || 'Unavailable'}\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                ))\n              )}\n            </div>\n\n            {/* Desktop Table */}\n            <div className=\"hidden md:block\">\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full text-left\">\n                  <thead>\n                    <tr className=\"border-b border-secondary-600\">\n                      <th className=\"pb-3 text-secondary-400 font-medium\">Employee</th>\n                      <th className=\"pb-3 text-secondary-400 font-medium\">Date</th>\n                      <th className=\"pb-3 text-secondary-400 font-medium\">Check In</th>\n                      <th className=\"pb-3 text-secondary-400 font-medium\">Check Out</th>\n                      <th className=\"pb-3 text-secondary-400 font-medium\">Working Time</th>\n                      <th className=\"pb-3 text-secondary-400 font-medium\">Status</th>\n                      <th className=\"pb-3 text-secondary-400 font-medium\">Location</th>\n                      <th className=\"pb-3 text-secondary-400 font-medium\">Actions</th>\n                    </tr>\n                  </thead>\n                  <tbody className=\"divide-y divide-secondary-700\">\n                    {loading ? (\n                      <tr>\n                        <td colSpan=\"8\" className=\"py-8 text-center text-secondary-400\">\n                          <div className=\"flex items-center justify-center space-x-2\">\n                            <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-neon-pink\"></div>\n                            <span>Loading attendance records...</span>\n                          </div>\n                        </td>\n                      </tr>\n                    ) : attendanceRecords.length === 0 ? (\n                      <tr>\n                        <td colSpan=\"8\" className=\"py-8 text-center text-secondary-400\">\n                          <div className=\"flex flex-col items-center space-y-2\">\n                            <Users className=\"w-8 h-8 text-secondary-400\" />\n                            <span>No attendance records found</span>\n                            <span className=\"text-xs\">Try adjusting your filters</span>\n                          </div>\n                        </td>\n                      </tr>\n                    ) : (\n                      attendanceRecords.map((record) => (\n                        <tr key={record._id} className=\"hover:bg-secondary-800/20 transition-colors\">\n                          <td className=\"py-3\">\n                            <div className=\"flex items-center space-x-3\">\n                              <div className=\"w-8 h-8 bg-gradient-to-r from-neon-pink to-neon-purple rounded-lg flex items-center justify-center\">\n                                <User className=\"w-4 h-4 text-white\" />\n                              </div>\n                              <div>\n                                <p className=\"text-white font-medium\">\n                                  {record.employeeData?.personalInfo ? \n                                    `${record.employeeData.personalInfo.firstName} ${record.employeeData.personalInfo.lastName}` :\n                                    record.userData?.name || 'Unknown'}\n                                </p>\n                                <p className=\"text-xs text-secondary-400\">\n                                  ID: {record.userData?.employeeId || 'N/A'} • {record.employeeData?.workInfo?.department || 'N/A'}\n                                </p>\n                              </div>\n                            </div>\n                          </td>\n                          <td className=\"py-3 text-white\">{formatDate(record.date)}</td>\n                          <td className=\"py-3\">\n                            <div className=\"text-white\">{formatTime(record.checkInTime)}</div>\n                            {record.isLate && (\n                              <div className=\"text-xs text-red-400\">\n                                {record.lateMinutes}m late\n                              </div>\n                            )}\n                          </td>\n                          <td className=\"py-3 text-white\">{formatTime(record.checkOutTime)}</td>\n                          <td className=\"py-3 text-neon-pink font-medium\">\n                            {formatWorkingTime(record.workingHours)}\n                          </td>\n                          <td className=\"py-3\">\n                            <span className={`text-xs px-2 py-1 rounded-full ${getStatusColor(record.status)}`}>\n                              {record.status}\n                            </span>\n                            {record.isManualEntry && (\n                              <div className=\"text-xs text-yellow-400 mt-1\">Manual Entry</div>\n                            )}\n                          </td>\n                          <td className=\"py-3\">\n                            <div className=\"flex items-center text-secondary-400 text-xs\">\n                              <MapPin className=\"w-3 h-3 mr-1\" />\n                              <span className=\"truncate max-w-24\">\n                                {record.checkInLocation?.address || 'Location unavailable'}\n                              </span>\n                            </div>\n                          </td>\n                          <td className=\"py-3\">\n                            <div className=\"flex items-center space-x-2\">\n                              <button\n                                onClick={() => setViewingRecord(record)}\n                                className=\"p-1 text-secondary-400 hover:text-neon-purple transition-colors\"\n                                title=\"View Details\"\n                              >\n                                <Eye className=\"w-4 h-4\" />\n                              </button>\n                              <button\n                                onClick={() => handleEditRecord(record)}\n                                className=\"p-1 text-secondary-400 hover:text-neon-pink transition-colors\"\n                                title=\"Edit Record\"\n                              >\n                                <Edit3 className=\"w-4 h-4\" />\n                              </button>\n                              <button\n                                onClick={() => handleDeleteRecord(record._id)}\n                                className=\"p-1 text-secondary-400 hover:text-red-400 transition-colors\"\n                                title=\"Delete Record\"\n                              >\n                                <Trash2 className=\"w-4 h-4\" />\n                              </button>\n                            </div>\n                          </td>\n                        </tr>\n                      ))\n                    )}\n                  </tbody>\n                </table>\n              </div>\n            </div>\n          </>\n\n          {/* Pagination */}\n          {pagination.pages > 1 && (\n            <div className=\"flex flex-col sm:flex-row items-center justify-between mt-6 pt-6 border-t border-secondary-600 gap-4 sm:gap-0\">\n              <div className=\"text-secondary-400 text-xs sm:text-sm text-center sm:text-left\">\n                Page {pagination.current} of {pagination.pages} ({pagination.total} total records)\n              </div>\n              <div className=\"flex items-center space-x-2\">\n                <button\n                  onClick={() => setPagination(prev => ({ ...prev, current: Math.max(1, prev.current - 1) }))}\n                  disabled={pagination.current === 1}\n                  className=\"px-2 sm:px-3 py-1 bg-secondary-700 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-secondary-600 transition-colors text-xs sm:text-sm\"\n                >\n                  Previous\n                </button>\n                <span className=\"px-2 sm:px-3 py-1 bg-neon-pink/20 text-neon-pink rounded text-xs sm:text-sm\">\n                  {pagination.current}\n                </span>\n                <button\n                  onClick={() => setPagination(prev => ({ ...prev, current: Math.min(prev.pages, prev.current + 1) }))}\n                  disabled={pagination.current === pagination.pages}\n                  className=\"px-2 sm:px-3 py-1 bg-secondary-700 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-secondary-600 transition-colors text-xs sm:text-sm\"\n                >\n                  Next\n                </button>\n              </div>\n            </div>\n          )}\n        </div>\n\n        {/* View Record Modal */}\n        {viewingRecord && (\n          <div className=\"fixed inset-0 z-[9999] flex items-center justify-center p-2 sm:p-4\">\n            {/* Enhanced backdrop with blur */}\n            <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" onClick={() => setViewingRecord(null)} />\n\n            {/* Modal content */}\n            <div className=\"relative glass-morphism neon-border rounded-xl sm:rounded-2xl p-2 sm:p-3 w-full max-w-full max-h-[90vh] overflow-y-auto sm:max-w-2xl shadow-2xl\">\n              <h3 className=\"text-base sm:text-lg font-bold text-white mb-3\">Attendance Details</h3>\n              \n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4\">\n                <div className=\"space-y-2 sm:space-y-3\">\n                  <div>\n                    <label className=\"block text-xs text-secondary-400 mb-1\">Employee</label>\n                    <p className=\"text-white text-xs sm:text-sm\">\n                      {viewingRecord.employeeData?.personalInfo ? \n                        `${viewingRecord.employeeData.personalInfo.firstName} ${viewingRecord.employeeData.personalInfo.lastName}` :\n                        viewingRecord.userData?.name || 'Unknown'}\n                    </p>\n                  </div>\n                  \n                  <div>\n                    <label className=\"block text-xs text-secondary-400 mb-1\">Date</label>\n                    <p className=\"text-white text-xs sm:text-sm\">{formatDate(viewingRecord.date)}</p>\n                  </div>\n                  \n                  <div>\n                    <label className=\"block text-xs text-secondary-400 mb-1\">Check In Time</label>\n                    <p className=\"text-white text-xs sm:text-sm\">{formatTime(viewingRecord.checkInTime)}</p>\n                  </div>\n                  \n                  <div>\n                    <label className=\"block text-xs text-secondary-400 mb-1\">Check Out Time</label>\n                    <p className=\"text-white text-xs sm:text-sm\">{formatTime(viewingRecord.checkOutTime)}</p>\n                  </div>\n                  \n                  <div>\n                    <label className=\"block text-xs text-secondary-400 mb-1\">Working Hours</label>\n                    <p className=\"text-neon-pink font-medium text-xs sm:text-sm\">{formatWorkingTime(viewingRecord.workingHours)}</p>\n                  </div>\n                  \n                  <div>\n                    <label className=\"block text-xs text-secondary-400 mb-1\">Status</label>\n                    <span className={`text-xs px-1.5 py-0.5 sm:px-2 sm:py-1 rounded-full ${getStatusColor(viewingRecord.status)}`}>\n                      {viewingRecord.status}\n                    </span>\n                  </div>\n                </div>\n\n                <div className=\"space-y-2 sm:space-y-3\">\n                  <div>\n                    <label className=\"block text-xs text-secondary-400 mb-1\">Check In Location</label>\n                    <p className=\"text-white text-xs\">\n                      {viewingRecord.checkInLocation?.address || 'Address not available'}\n                    </p>\n                    <p className=\"text-xs text-secondary-400\">\n                      {viewingRecord.checkInLocation?.latitude}, {viewingRecord.checkInLocation?.longitude}\n                    </p>\n                  </div>\n                  \n                  {viewingRecord.checkOutLocation && (\n                    <div>\n                      <label className=\"block text-xs text-secondary-400 mb-1\">Check Out Location</label>\n                      <p className=\"text-white text-xs\">\n                        {viewingRecord.checkOutLocation.address || 'Address not available'}\n                      </p>\n                      <p className=\"text-xs text-secondary-400\">\n                        {viewingRecord.checkOutLocation.latitude}, {viewingRecord.checkOutLocation.longitude}\n                      </p>\n                    </div>\n                  )}\n                  \n                  <div>\n                    <label className=\"block text-xs text-secondary-400 mb-1\">Device Info</label>\n                    <p className=\"text-white text-xs\">\n                      {viewingRecord.deviceInfo?.browser || 'Unknown'} on {viewingRecord.deviceInfo?.platform || 'Unknown'}\n                    </p>\n                  </div>\n                  \n                  {viewingRecord.notes && (\n                    <div>\n                      <label className=\"block text-xs text-secondary-400 mb-1\">Notes</label>\n                      <p className=\"text-white text-xs\">{viewingRecord.notes}</p>\n                    </div>\n                  )}\n                  \n                  {viewingRecord.isLate && (\n                    <div>\n                      <label className=\"block text-xs text-secondary-400 mb-1\">Late Information</label>\n                      <p className=\"text-red-400 text-xs\">{viewingRecord.lateMinutes} minutes late</p>\n                    </div>\n                  )}\n                  \n                  {viewingRecord.isManualEntry && (\n                    <div>\n                      <label className=\"block text-xs text-secondary-400 mb-1\">Manual Entry Reason</label>\n                      <p className=\"text-yellow-400 text-xs\">\n                        {viewingRecord.manualEntryReason || 'No reason provided'}\n                      </p>\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              <div className=\"flex justify-end mt-4\">\n                <button\n                  onClick={() => setViewingRecord(null)}\n                  className=\"px-2 sm:px-3 py-1.5 bg-secondary-700 hover:bg-secondary-600 text-white font-medium rounded-lg transition-colors text-xs sm:text-sm\"\n                >\n                  Close\n                </button>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Edit Record Modal */}\n        {editingRecord && (\n          <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-2 sm:p-4\">\n            <div className=\"glass-morphism neon-border rounded-xl sm:rounded-2xl p-2 sm:p-3 w-full max-w-full sm:max-w-md\">\n              <h3 className=\"text-base sm:text-lg font-bold text-white mb-3\">Edit Attendance Record</h3>\n              \n              <div className=\"space-y-2 sm:space-y-3\">\n                <div>\n                  <label className=\"block text-xs text-secondary-400 mb-1\">Employee</label>\n                  <p className=\"text-white text-xs sm:text-sm\">\n                    {editingRecord.employeeData?.personalInfo ? \n                      `${editingRecord.employeeData.personalInfo.firstName} ${editingRecord.employeeData.personalInfo.lastName}` :\n                      editingRecord.userData?.name || 'Unknown'}\n                  </p>\n                  <p className=\"text-xs text-secondary-400\">{formatDate(editingRecord.date)}</p>\n                </div>\n\n                <div>\n                  <label className=\"block text-xs text-secondary-400 mb-1\">Status</label>\n                  <select\n                    value={editForm.status}\n                    onChange={(e) => setEditForm(prev => ({ ...prev, status: e.target.value }))}\n                    className=\"w-full px-2 py-1.5 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:outline-none focus:border-neon-pink text-xs sm:text-sm\"\n                  >\n                    <option value=\"Present\">Present</option>\n                    <option value=\"Late\">Late</option>\n                    <option value=\"Half Day\">Half Day</option>\n                    <option value=\"Absent\">Absent</option>\n                    <option value=\"Work from Home\">Work from Home</option>\n                  </select>\n                </div>\n\n                <div>\n                  <label className=\"block text-xs text-secondary-400 mb-1\">Notes</label>\n                  <textarea\n                    value={editForm.notes}\n                    onChange={(e) => setEditForm(prev => ({ ...prev, notes: e.target.value }))}\n                    rows=\"3\"\n                    className=\"w-full px-2 py-1.5 bg-secondary-800 border border-secondary-600 rounded-lg text-white placeholder-secondary-400 focus:outline-none focus:border-neon-pink text-xs sm:text-sm\"\n                    placeholder=\"Add any additional notes...\"\n                  />\n                </div>\n\n                <div>\n                  <label className=\"flex items-center space-x-2\">\n                    <input\n                      type=\"checkbox\"\n                      checked={editForm.isManualEntry}\n                      onChange={(e) => setEditForm(prev => ({ ...prev, isManualEntry: e.target.checked }))}\n                      className=\"rounded border-secondary-600 text-neon-pink focus:ring-neon-pink\"\n                    />\n                    <span className=\"text-secondary-400 text-xs\">Manual Entry</span>\n                  </label>\n                </div>\n\n                {editForm.isManualEntry && (\n                  <div>\n                    <label className=\"block text-xs text-secondary-400 mb-1\">Manual Entry Reason</label>\n                    <input\n                      type=\"text\"\n                      value={editForm.manualEntryReason}\n                      onChange={(e) => setEditForm(prev => ({ ...prev, manualEntryReason: e.target.value }))}\n                      className=\"w-full px-2 py-1.5 bg-secondary-800 border border-secondary-600 rounded-lg text-white placeholder-secondary-400 focus:outline-none focus:border-neon-pink text-xs sm:text-sm\"\n                      placeholder=\"Reason for manual entry...\"\n                    />\n                  </div>\n                )}\n              </div>\n\n              <div className=\"flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2 mt-4\">\n                <button\n                  onClick={handleUpdateRecord}\n                  className=\"flex-1 px-2 sm:px-3 py-1.5 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-medium rounded-lg hover-glow transition-all duration-300 text-xs sm:text-sm\"\n                >\n                  Update Record\n                </button>\n                <button\n                  onClick={() => setEditingRecord(null)}\n                  className=\"flex-1 px-2 sm:px-3 py-1.5 bg-secondary-700 hover:bg-secondary-600 text-white font-medium rounded-lg transition-colors text-xs sm:text-sm\"\n                >\n                  Cancel\n                </button>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Department-wise Summary (if available) */}\n        {attendanceSummary && attendanceSummary.departmentStats && attendanceSummary.departmentStats.length > 0 && (\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between mb-6\">\n              <h2 className=\"text-xl font-bold text-white\">Department-wise Attendance</h2>\n              <Building2 className=\"w-5 h-5 text-neon-purple\" />\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              {attendanceSummary.departmentStats.map((dept, index) => (\n                <div key={index} className=\"p-4 bg-secondary-800/30 rounded-lg\">\n                  <h4 className=\"text-white font-medium mb-2\">{dept._id || 'Unknown Department'}</h4>\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <span className=\"text-secondary-400\">Present:</span>\n                    <span className=\"text-green-400 font-medium\">{dept.present}</span>\n                  </div>\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <span className=\"text-secondary-400\">Late:</span>\n                    <span className=\"text-yellow-400 font-medium\">{dept.late}</span>\n                  </div>\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <span className=\"text-secondary-400\">Total:</span>\n                    <span className=\"text-white font-medium\">{dept.total}</span>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n      </div>\n    </AdminLayout>\n  );\n};\n\nexport default AdminAttendance;","path":null,"size_bytes":42698,"size_tokens":null},"backend/middleware/auth.js":{"content":"// middleware/auth.js\nimport jwt from 'jsonwebtoken';\nimport User from '../models/User.js';\n\n// Protect routes - verify JWT token\nexport const protect = async (req, res, next) => {\n  try {\n    let token;\n\n    if (req.headers.authorization?.startsWith('Bearer')) {\n      token = req.headers.authorization.split(' ')[1];\n    } else if (req.cookies?.token) {\n      token = req.cookies.token;\n    }\n\n    if (!token) {\n      return res.status(401).json({ success: false, message: 'Access denied. No token provided.' });\n    }\n\n    try {\n      const decoded = jwt.verify(token, process.env.JWT_SECRET);\n      const user = await User.findById(decoded.id);\n\n      if (!user) return res.status(401).json({ success: false, message: 'Token valid but user no longer exists' });\n      if (!user.isActive) return res.status(401).json({ success: false, message: 'User account is deactivated' });\n\n      req.user = user;\n      next();\n    } catch (tokenError) {\n      if (tokenError.name === 'TokenExpiredError') return res.status(401).json({ success: false, message: 'Token has expired' });\n      if (tokenError.name === 'JsonWebTokenError') return res.status(401).json({ success: false, message: 'Invalid token' });\n      return res.status(401).json({ success: false, message: 'Token verification failed' });\n    }\n  } catch (error) {\n    console.error('Auth middleware error:', error);\n    return res.status(500).json({ success: false, message: 'Server error in authentication' });\n  }\n};\n\n// Authorize specific roles\nexport const authorize = (...roles) => (req, res, next) => {\n  if (!req.user) return res.status(401).json({ success: false, message: 'Access denied. Please login first.' });\n  if (!roles.includes(req.user.role)) return res.status(403).json({ success: false, message: `Access denied. Role '${req.user.role}' is not authorized for this action.` });\n  next();\n};\n\n// Admin only\nexport const adminOnly = (req, res, next) => {\n  if (!req.user) return res.status(401).json({ success: false, message: 'Access denied. Please login first.' });\n  if (req.user.role !== 'admin') return res.status(403).json({ success: false, message: 'Admin access required.' });\n  next();\n};\n\n// Employee only\nexport const employeeOnly = (req, res, next) => {\n  if (!req.user) return res.status(401).json({ success: false, message: 'Access denied. Please login first.' });\n  if (req.user.role !== 'employee') return res.status(403).json({ success: false, message: 'Employee access required.' });\n  next();\n};\n\n// Owner or Admin\nexport const ownerOrAdmin = (req, res, next) => {\n  if (!req.user) return res.status(401).json({ success: false, message: 'Access denied. Please login first.' });\n  if (req.user.role === 'admin') return next();\n\n  const resourceUserId = req.params.userId || req.params.id;\n  if (req.user._id.toString() !== resourceUserId) return res.status(403).json({ success: false, message: 'Access denied. You can only access your own resources.' });\n  next();\n};\n\n// Optional auth\nexport const optionalAuth = async (req, res, next) => {\n  try {\n    let token;\n    if (req.headers.authorization?.startsWith('Bearer')) token = req.headers.authorization.split(' ')[1];\n    else if (req.cookies?.token) token = req.cookies.token;\n\n    if (token) {\n      try {\n        const decoded = jwt.verify(token, process.env.JWT_SECRET);\n        const user = await User.findById(decoded.id);\n        if (user?.isActive) req.user = user;\n      } catch (error) {\n        console.log('Optional auth token invalid:', error.message);\n      }\n    }\n    next();\n  } catch (error) {\n    console.error('Optional auth middleware error:', error);\n    next();\n  }\n};\n\n// Auth rate limiter\nexport const authRateLimit = (maxAttempts = 5, windowMs = 15 * 60 * 1000) => {\n  const attempts = new Map();\n\n  return (req, res, next) => {\n    const key = req.ip + req.body.email;\n    const now = Date.now();\n\n    if (!attempts.has(key)) {\n      attempts.set(key, { count: 1, resetTime: now + windowMs });\n      return next();\n    }\n\n    const attempt = attempts.get(key);\n\n    if (now > attempt.resetTime) {\n      attempts.set(key, { count: 1, resetTime: now + windowMs });\n      return next();\n    }\n\n    if (attempt.count >= maxAttempts) {\n      return res.status(429).json({\n        success: false,\n        message: 'Too many login attempts. Please try again later.',\n        retryAfter: Math.ceil((attempt.resetTime - now) / 1000),\n      });\n    }\n\n    attempt.count++;\n    next();\n  };\n};\n","path":null,"size_bytes":4453,"size_tokens":null},"backend/routes/leadRoutes.js":{"content":"import express from 'express';\nimport { body } from 'express-validator';\nimport { protect } from '../middleware/authMiddleware.js';\nimport {\n  getLeads,\n  getLeadById,\n  createLead,\n  updateLead,\n  updateWonLead,\n  addLeadNote,\n  addMeeting,\n  updateMeeting,\n  deleteLead,\n  getLeadStats,\n  getWonLeadsStats,\n  getMeetingStats,\n  getUpcomingFollowUps,\n  getOverdueFollowUps,\n  getUpcomingMeetings\n} from '../controllers/leadController.js';\n\nconst router = express.Router();\n\n// Enhanced validation middleware for lead creation\nconst validateLead = [\n  body('firstName')\n    .trim()\n    .notEmpty()\n    .withMessage('First name is required')\n    .isLength({ min: 1, max: 50 })\n    .withMessage('First name must be between 1 and 50 characters'),\n  \n  body('lastName')\n    .trim()\n    .notEmpty()\n    .withMessage('Last name is required')\n    .isLength({ min: 1, max: 50 })\n    .withMessage('Last name must be between 1 and 50 characters'),\n    \n  body('email')\n    .isEmail()\n    .withMessage('Valid email is required')\n    .normalizeEmail()\n    .custom(async (email) => {\n      // Add email uniqueness check if needed\n      // const existingLead = await Lead.findOne({ email });\n      // if (existingLead) {\n      //   throw new Error('Email already exists');\n      // }\n      return true;\n    }),\n    \n  body('phone')\n    .trim()\n    .notEmpty()\n    .withMessage('Phone number is required')\n    .matches(/^[+]?[\\d\\s\\-\\(\\)]+$/)\n    .withMessage('Please provide a valid phone number'),\n    \n  body('source')\n    .notEmpty()\n    .withMessage('Source is required')\n    .isIn(['Website', 'Social Media', 'Email Campaign', 'Cold Call', 'Referral', 'Trade Show', 'Advertisement', 'Other'])\n    .withMessage('Please select a valid source'),\n    \n  body('priority')\n    .optional()\n    .isIn(['Low', 'Medium', 'High', 'Hot'])\n    .withMessage('Please select a valid priority level'),\n    \n  body('company')\n    .optional()\n    .trim()\n    .isLength({ max: 100 })\n    .withMessage('Company name must be less than 100 characters'),\n    \n  body('position')\n    .optional()\n    .trim()\n    .isLength({ max: 100 })\n    .withMessage('Position must be less than 100 characters'),\n    \n  body('estimatedValue')\n    .optional()\n    .custom((value) => {\n      if (value === '' || value === null || value === undefined) return true;\n      if (isNaN(value) || parseFloat(value) < 0) {\n        throw new Error('Estimated value must be a positive number');\n      }\n      return true;\n    }),\n    \n  body('expectedCloseDate')\n    .optional()\n    .custom((value) => {\n      if (!value) return true;\n      const date = new Date(value);\n      if (isNaN(date.getTime())) {\n        throw new Error('Expected close date must be a valid date');\n      }\n      return true;\n    }),\n    \n  body('nextFollowUpDate')\n    .optional()\n    .custom((value) => {\n      if (!value) return true;\n      const date = new Date(value);\n      if (isNaN(date.getTime())) {\n        throw new Error('Next follow-up date must be a valid date');\n      }\n      return true;\n    }),\n\n  body('interestedProducts')\n    .optional()\n    .isArray()\n    .withMessage('Interested products must be an array'),\n\n  body('notes')\n    .optional()\n    .trim()\n    .isLength({ max: 1000 })\n    .withMessage('Notes must be less than 1000 characters')\n];\n\nconst validateLeadUpdate = [\n  body('firstName')\n    .optional()\n    .trim()\n    .notEmpty()\n    .withMessage('First name cannot be empty')\n    .isLength({ min: 1, max: 50 })\n    .withMessage('First name must be between 1 and 50 characters'),\n  \n  body('lastName')\n    .optional()\n    .trim()\n    .notEmpty()\n    .withMessage('Last name cannot be empty')\n    .isLength({ min: 1, max: 50 })\n    .withMessage('Last name must be between 1 and 50 characters'),\n    \n  body('email')\n    .optional()\n    .isEmail()\n    .withMessage('Valid email is required')\n    .normalizeEmail(),\n    \n  body('phone')\n    .optional()\n    .trim()\n    .notEmpty()\n    .withMessage('Phone number cannot be empty')\n    .matches(/^[+]?[\\d\\s\\-\\(\\)]+$/)\n    .withMessage('Please provide a valid phone number'),\n    \n  body('source')\n    .optional()\n    .isIn(['Website', 'Social Media', 'Email Campaign', 'Cold Call', 'Referral', 'Trade Show', 'Advertisement', 'Other'])\n    .withMessage('Please select a valid source'),\n    \n  body('status')\n    .optional()\n    .isIn(['New', 'Contacted', 'Qualified', 'Proposal', 'Negotiation', 'Won', 'Lost'])\n    .withMessage('Please select a valid status'),\n    \n  body('priority')\n    .optional()\n    .isIn(['Low', 'Medium', 'High', 'Hot'])\n    .withMessage('Please select a valid priority level'),\n    \n  body('estimatedValue')\n    .optional()\n    .custom((value) => {\n      if (value === '' || value === null || value === undefined) return true;\n      if (isNaN(value) || parseFloat(value) < 0) {\n        throw new Error('Estimated value must be a positive number');\n      }\n      return true;\n    }),\n    \n  body('expectedCloseDate')\n    .optional()\n    .custom((value) => {\n      if (!value) return true;\n      const date = new Date(value);\n      if (isNaN(date.getTime())) {\n        throw new Error('Expected close date must be a valid date');\n      }\n      return true;\n    }),\n    \n  body('nextFollowUpDate')\n    .optional()\n    .custom((value) => {\n      if (!value) return true;\n      const date = new Date(value);\n      if (isNaN(date.getTime())) {\n        throw new Error('Next follow-up date must be a valid date');\n      }\n      return true;\n    })\n];\n\nconst validateWonUpdate = [\n  body('finalValue')\n    .optional()\n    .custom((value) => {\n      if (value === '' || value === null || value === undefined) return true;\n      if (isNaN(value) || parseFloat(value) < 0) {\n        throw new Error('Final value must be a positive number');\n      }\n      return true;\n    }),\n    \n  body('recurringRevenue')\n    .optional()\n    .custom((value) => {\n      if (value === '' || value === null || value === undefined) return true;\n      if (isNaN(value) || parseFloat(value) < 0) {\n        throw new Error('Recurring revenue must be a positive number');\n      }\n      return true;\n    }),\n    \n  body('contractDuration')\n    .optional()\n    .custom((value) => {\n      if (value === '' || value === null || value === undefined) return true;\n      if (isNaN(value) || parseInt(value) < 1) {\n        throw new Error('Contract duration must be at least 1 month');\n      }\n      return true;\n    }),\n    \n  body('satisfactionScore')\n    .optional()\n    .custom((value) => {\n      if (value === '' || value === null || value === undefined) return true;\n      const score = parseInt(value);\n      if (isNaN(score) || score < 1 || score > 10) {\n        throw new Error('Satisfaction score must be between 1 and 10');\n      }\n      return true;\n    }),\n\n  body('onboardingStatus')\n    .optional()\n    .isIn(['Not Started', 'In Progress', 'Completed'])\n    .withMessage('Please select a valid onboarding status'),\n\n  body('deliveryDate')\n    .optional()\n    .custom((value) => {\n      if (!value) return true;\n      const date = new Date(value);\n      if (isNaN(date.getTime())) {\n        throw new Error('Delivery date must be a valid date');\n      }\n      return true;\n    }),\n\n  body('renewalDate')\n    .optional()\n    .custom((value) => {\n      if (!value) return true;\n      const date = new Date(value);\n      if (isNaN(date.getTime())) {\n        throw new Error('Renewal date must be a valid date');\n      }\n      return true;\n    }),\n\n  body('paymentTerms')\n    .optional()\n    .trim()\n    .isLength({ max: 200 })\n    .withMessage('Payment terms must be less than 200 characters'),\n\n  body('discount')\n    .optional()\n    .custom((value) => {\n      if (value === '' || value === null || value === undefined) return true;\n      if (isNaN(value) || parseFloat(value) < 0) {\n        throw new Error('Discount must be a positive number');\n      }\n      return true;\n    })\n];\n\nconst validateMeeting = [\n  body('type')\n    .notEmpty()\n    .withMessage('Meeting type is required')\n    .isIn(['Call', 'Video Meeting', 'In-Person', 'Email Follow-up', 'Demo', 'Presentation', 'Negotiation'])\n    .withMessage('Please select a valid meeting type'),\n    \n  body('scheduledDate')\n    .notEmpty()\n    .withMessage('Scheduled date is required')\n    .isISO8601()\n    .withMessage('Scheduled date must be a valid date')\n    .custom((value) => {\n      if (new Date(value) < new Date()) {\n        throw new Error('Scheduled date must be in the future');\n      }\n      return true;\n    }),\n    \n  body('duration')\n    .optional()\n    .isNumeric()\n    .withMessage('Duration must be a number')\n    .isInt({ min: 5, max: 480 })\n    .withMessage('Duration must be between 5 and 480 minutes'),\n    \n  body('agenda')\n    .optional()\n    .trim()\n    .isLength({ max: 1000 })\n    .withMessage('Agenda must be less than 1000 characters'),\n    \n  body('attendees')\n    .optional()\n    .isArray()\n    .withMessage('Attendees must be an array'),\n    \n  body('attendees.*.name')\n    .optional()\n    .trim()\n    .isLength({ min: 1, max: 100 })\n    .withMessage('Attendee name must be between 1-100 characters'),\n    \n  body('attendees.*.email')\n    .optional()\n    .isEmail()\n    .withMessage('Attendee email must be valid')\n];\n\nconst validateMeetingUpdate = [\n  body('type')\n    .optional()\n    .isIn(['Call', 'Video Meeting', 'In-Person', 'Email Follow-up', 'Demo', 'Presentation', 'Negotiation'])\n    .withMessage('Please select a valid meeting type'),\n    \n  body('scheduledDate')\n    .optional()\n    .isISO8601()\n    .withMessage('Scheduled date must be a valid date'),\n    \n  body('duration')\n    .optional()\n    .isNumeric()\n    .withMessage('Duration must be a number')\n    .isInt({ min: 5, max: 480 })\n    .withMessage('Duration must be between 5 and 480 minutes'),\n    \n  body('status')\n    .optional()\n    .isIn(['Scheduled', 'Completed', 'Cancelled', 'Rescheduled', 'No Show'])\n    .withMessage('Please select a valid meeting status'),\n    \n  body('outcome')\n    .optional()\n    .trim()\n    .isLength({ max: 2000 })\n    .withMessage('Outcome must be less than 2000 characters'),\n    \n  body('nextAction')\n    .optional()\n    .trim()\n    .isLength({ max: 500 })\n    .withMessage('Next action must be less than 500 characters'),\n    \n  body('nextMeetingDate')\n    .optional()\n    .isISO8601()\n    .withMessage('Next meeting date must be a valid date'),\n    \n  body('agenda')\n    .optional()\n    .trim()\n    .isLength({ max: 1000 })\n    .withMessage('Agenda must be less than 1000 characters'),\n    \n  body('attendees')\n    .optional()\n    .isArray()\n    .withMessage('Attendees must be an array')\n];\n\nconst validateNote = [\n  body('content')\n    .trim()\n    .notEmpty()\n    .withMessage('Note content is required')\n    .isLength({ min: 1, max: 1000 })\n    .withMessage('Note content must be between 1 and 1000 characters'),\n    \n  body('type')\n    .optional()\n    .isIn(['General', 'Meeting', 'Call', 'Email', 'Follow-up'])\n    .withMessage('Please select a valid note type')\n];\n\n// IMPORTANT: Apply protection middleware to all routes\nrouter.use(protect);\n\n// Statistics routes - MUST come first before parameterized routes\nrouter.get('/stats', getLeadStats);\nrouter.get('/won-stats', getWonLeadsStats);\nrouter.get('/meeting-stats', getMeetingStats);\n\n// Follow-up routes - MUST come before parameterized routes\nrouter.get('/upcoming-followups', getUpcomingFollowUps);\nrouter.get('/overdue-followups', getOverdueFollowUps);\n\n// Meeting routes - MUST come before parameterized routes\nrouter.get('/upcoming-meetings', getUpcomingMeetings);\n\n// Main CRUD routes\nrouter.get('/', getLeads);\nrouter.post('/', validateLead, createLead);\n\n// Lead-specific routes (parameterized routes come last)\nrouter.get('/:id', getLeadById);\nrouter.put('/:id', validateLeadUpdate, updateLead);\nrouter.delete('/:id', deleteLead);\n\n// Won lead management\nrouter.put('/:id/won-details', validateWonUpdate, updateWonLead);\n\n// Add this route (it's missing from your current routes)\nrouter.get('/upcoming-meetings', getUpcomingMeetings);\n\n// Notes management\nrouter.post('/:id/notes', validateNote, addLeadNote);\n\n// Meeting management\nrouter.post('/:id/meetings', validateMeeting, addMeeting);\nrouter.put('/:leadId/meetings/:meetingId', validateMeetingUpdate, updateMeeting);\n\nexport default router;","path":null,"size_bytes":12253,"size_tokens":null},"frontend/src/utils/notificationUtils.js":{"content":"// utils/notificationUtils.js\n\nexport const notificationUtils = {\n  // Format notification time for display\n  formatTime: (timestamp) => {\n    const now = new Date();\n    const time = new Date(timestamp);\n    const diffInMinutes = Math.floor((now - time) / (1000 * 60));\n    \n    if (diffInMinutes < 1) return 'Just now';\n    if (diffInMinutes < 60) return `${diffInMinutes} min ago`;\n    \n    const diffInHours = Math.floor(diffInMinutes / 60);\n    if (diffInHours < 24) return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;\n    \n    const diffInDays = Math.floor(diffInHours / 24);\n    if (diffInDays < 7) return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;\n    \n    return time.toLocaleDateString();\n  },\n\n  // Get notification priority based on type and category\n  getPriority: (notification) => {\n    const { type, category } = notification;\n    \n    if (type === 'error') return 3; // High priority\n    if (type === 'warning') return 2; // Medium priority\n    if (category === 'leave' && type === 'info') return 2; // Medium priority\n    return 1; // Low priority\n  },\n\n  // Group notifications by category\n  groupByCategory: (notifications) => {\n    const categories = {\n      tasks: [],\n      leaves: [],\n      employee: [],\n      attendance: [],\n      profile: [],\n      other: []\n    };\n    \n    notifications.forEach(notification => {\n      const category = notification.category || 'other';\n      if (categories[category]) {\n        categories[category].push(notification);\n      } else {\n        categories.other.push(notification);\n      }\n    });\n    \n    return categories;\n  },\n\n  // Get notification settings\n  getSettings: () => {\n    try {\n      const settings = localStorage.getItem('notificationSettings');\n      return settings ? JSON.parse(settings) : {\n        sound: true,\n        vibration: true,\n        desktop: true,\n        email: false\n      };\n    } catch (error) {\n      console.error('Error parsing notification settings:', error);\n      return {\n        sound: true,\n        vibration: true,\n        desktop: true,\n        email: false\n      };\n    }\n  },\n\n  // Save notification settings\n  saveSettings: (settings) => {\n    try {\n      localStorage.setItem('notificationSettings', JSON.stringify(settings));\n      return true;\n    } catch (error) {\n      console.error('Error saving notification settings:', error);\n      return false;\n    }\n  },\n\n  // Get notification icon based on type\n  getIcon: (type) => {\n    const icons = {\n      success: '✅',\n      warning: '⚠️',\n      error: '❌',\n      info: 'ℹ️',\n      default: '📢'\n    };\n    return icons[type] || icons.default;\n  },\n\n  // Get notification color based on type\n  getColor: (type) => {\n    const colors = {\n      success: 'text-green-400',\n      warning: 'text-yellow-400',\n      error: 'text-red-400',\n      info: 'text-blue-400',\n      default: 'text-gray-400'\n    };\n    return colors[type] || colors.default;\n  },\n\n  // Sort notifications by priority and time\n  sortNotifications: (notifications) => {\n    return notifications.sort((a, b) => {\n      const priorityDiff = notificationUtils.getPriority(b) - notificationUtils.getPriority(a);\n      if (priorityDiff !== 0) return priorityDiff;\n      \n      return new Date(b.timestamp) - new Date(a.timestamp);\n    });\n  }\n};","path":null,"size_bytes":3307,"size_tokens":null},"backend/models/Employee.js":{"content":"import mongoose from 'mongoose';\n\nconst employeeSchema = new mongoose.Schema({\n  // Reference to User model\n  user: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true,\n    unique: true\n  },\n  \n  // Employee ID (auto-generated)\n  employeeId: {\n    type: String,\n    unique: true,\n    uppercase: true\n  },\n\n  // Personal Information\n  personalInfo: {\n    firstName: {\n      type: String,\n      required: [true, 'First name is required'],\n      trim: true,\n      maxlength: [30, 'First name cannot exceed 30 characters']\n    },\n    lastName: {\n      type: String,\n      required: [true, 'Last name is required'],\n      trim: true,\n      maxlength: [30, 'Last name cannot exceed 30 characters']\n    },\n    dateOfBirth: {\n      type: Date,\n      required: [true, 'Date of birth is required']\n    },\n    gender: {\n      type: String,\n      enum: ['Male', 'Female', 'Other'],\n      required: [true, 'Gender is required']\n    },\n    nationality: {\n      type: String,\n      default: 'Indian'\n    },\n    maritalStatus: {\n      type: String,\n      enum: ['Single', 'Married', 'Divorced', 'Widowed'],\n      default: 'Single'\n    },\n    bloodGroup: {\n      type: String,\n      enum: ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-']\n    }\n  },\n\n  // Contact Information\n  contactInfo: {\n    phone: {\n      type: String,\n      required: [true, 'Phone number is required']\n    },\n    alternatePhone: String,\n    personalEmail: {\n      type: String,\n      required: [true, 'Personal email is required'],\n      lowercase: true\n    },\n    address: {\n      street: String,\n      city: String,\n      state: String,\n      pincode: String,\n      country: {\n        type: String,\n        default: 'India'\n      }\n    },\n    emergencyContact: {\n      name: {\n        type: String,\n        required: [true, 'Emergency contact name is required']\n      },\n      relationship: {\n        type: String,\n        required: [true, 'Emergency contact relationship is required']\n      },\n      phone: {\n        type: String,\n        required: [true, 'Emergency contact phone is required']\n      }\n    }\n  },\n\n  // Work Information\n  workInfo: {\n    position: {\n      type: String,\n      required: [true, 'Position is required']\n    },\n department: {\n  type: mongoose.Schema.Types.ObjectId,\n  ref: 'Department',\n  required: true\n},\n\n    joiningDate: {\n      type: Date,\n      required: [true, 'Joining date is required'],\n      default: Date.now\n    },\n    employmentType: {\n      type: String,\n      enum: ['Full-time', 'Part-time', 'Contract', 'Intern'],\n      default: 'Full-time'\n    },\n    workLocation: {\n      type: String,\n      enum: ['Office', 'Remote', 'Hybrid'],\n      default: 'Office'\n    },\n    team: String,\n    skills: [String],\n    workShift: {\n      type: String,\n      enum: ['Morning', 'Afternoon', 'Evening', 'Night', 'Flexible'],\n      default: 'Morning'\n    },\n    reportingManager: {\n      type: mongoose.Schema.Types.ObjectId,\n      ref: 'Employee'\n    }\n  },\n\n  // Salary Information\n  salaryInfo: {\n    basicSalary: {\n      type: Number,\n      required: [true, 'Basic salary is required'],\n      min: 0\n    },\n    allowances: {\n      hra: { type: Number, default: 0 },\n      medical: { type: Number, default: 0 },\n      transport: { type: Number, default: 0 },\n      other: { type: Number, default: 0 }\n    },\n    deductions: {\n      pf: { type: Number, default: 0 },\n      esi: { type: Number, default: 0 },\n      tax: { type: Number, default: 0 },\n      other: { type: Number, default: 0 }\n    },\n    currency: {\n      type: String,\n      default: 'INR'\n    },\n    payFrequency: {\n      type: String,\n      enum: ['Monthly', 'Weekly', 'Bi-weekly'],\n      default: 'Monthly'\n    }\n  },\n\n  // Bank Information\n  bankInfo: {\n    accountHolderName: String,\n    accountNumber: String,\n    bankName: String,\n    branchName: String,\n    ifscCode: String,\n    accountType: {\n      type: String,\n      enum: ['Savings', 'Current'],\n      default: 'Savings'\n    }\n  },\n\n  // Status\n  status: {\n    type: String,\n    enum: ['Active', 'Inactive', 'On Leave', 'Terminated'],\n    default: 'Active'\n  },\n\n\n   leaveBalance: {\n    total: { type: Number, default: 30 }, // Total annual leave days\n    used: { type: Number, default: 0 },\n    remaining: { type: Number, default: 30 }\n  \n},\nfaceDescriptor: {\n  type: [Number], \n  default: null\n},\nfaceEmbeddings: {\n  front: { type: [Number], default: null },\n  left: { type: [Number], default: null },\n  right: { type: [Number], default: null },\n  average: { type: [Number], default: null }\n},\nfaceQualityScores: {\n  front: { type: Number, default: 0 },\n  left: { type: Number, default: 0 },\n  right: { type: Number, default: 0 }\n},\nfaceImage: {\n  type: String, \n  default: null\n},\nfaceImages: {\n  front: { type: String, default: null },\n  left: { type: String, default: null },\n  right: { type: String, default: null }\n},\nhasFaceRegistered: {\n  type: Boolean,\n  default: false\n},\nfaceRegistrationDate: {\n  type: Date,\n  default: null\n},\nfaceRegistrationMethod: {\n  type: String,\n  enum: ['single', 'multi-angle', 'video'],\n  default: null\n},\n\n\n  // Documents (file paths/URLs)\n  documents: {\n    resume: String,\n    idProof: String,\n    addressProof: String,\n    educationCertificates: [String],\n    experienceCertificates: [String],\n    others: [String]\n  },\n\n  // Additional fields\n  notes: String,\n  tags: [String]\n}, {\n  timestamps: true,\n  toJSON: { virtuals: true },\n  toObject: { virtuals: true }\n});\n\n// Indexes\nemployeeSchema.index({ 'workInfo.department': 1 });\nemployeeSchema.index({ 'workInfo.position': 1 });\nemployeeSchema.index({ status: 1 });\nemployeeSchema.index({ 'personalInfo.firstName': 1 });\nemployeeSchema.index({ 'personalInfo.lastName': 1 });\n\n// Auto-generate employeeId\nemployeeSchema.pre('save', async function(next) {\n  if (!this.employeeId) {\n    try {\n      // Find the last employee ID to generate the next one\n      const lastEmployee = await this.constructor.findOne(\n        { employeeId: { $exists: true } },\n        {},\n        { sort: { employeeId: -1 } }\n      );\n\n      if (lastEmployee && lastEmployee.employeeId) {\n        // Extract number from last employee ID (e.g., EMP001 -> 1)\n        const lastNumber = parseInt(lastEmployee.employeeId.replace(/\\D/g, ''));\n        const nextNumber = lastNumber + 1;\n        this.employeeId = `EMP${nextNumber.toString().padStart(3, '0')}`;\n      } else {\n        // First employee\n        this.employeeId = 'EMP001';\n      }\n    } catch (error) {\n      return next(error);\n    }\n  }\n  next();\n});\n\n\n// Pre-save middleware to ensure leave balance is initialized\nemployeeSchema.pre('save', function(next) {\n  if (this.isNew && !this.leaveBalance) {\n    this.leaveBalance = {\n      total: 30,\n      used: 0,\n      remaining: 30\n    };\n  }\n  next();\n});\n\n// Method to calculate remaining balance\nemployeeSchema.methods.calculateRemainingBalance = function() {\n  this.leaveBalance.remaining = this.leaveBalance.total - this.leaveBalance.used;\n  return this.leaveBalance.remaining;\n};\n\n// Virtual for full name\nemployeeSchema.virtual('fullName').get(function() {\n  return `${this.personalInfo.firstName} ${this.personalInfo.lastName}`;\n});\n\n// Virtual for age\nemployeeSchema.virtual('age').get(function() {\n  if (!this.personalInfo.dateOfBirth) return null;\n  \n  const today = new Date();\n  const birthDate = new Date(this.personalInfo.dateOfBirth);\n  let age = today.getFullYear() - birthDate.getFullYear();\n  const monthDiff = today.getMonth() - birthDate.getMonth();\n  \n  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {\n    age--;\n  }\n  \n  return age;\n});\n\n// Virtual for years of service\nemployeeSchema.virtual('yearsOfService').get(function() {\n  if (!this.workInfo.joiningDate) return 0;\n  \n  const today = new Date();\n  const joinDate = new Date(this.workInfo.joiningDate);\n  const diffTime = Math.abs(today - joinDate);\n  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n  \n  return Math.floor(diffDays / 365.25);\n});\n\n// Virtual for gross salary\nemployeeSchema.virtual('grossSalary').get(function() {\n  const basic = this.salaryInfo.basicSalary || 0;\n  const allowances = this.salaryInfo.allowances;\n  const totalAllowances = (allowances.hra || 0) + (allowances.medical || 0) + \n                         (allowances.transport || 0) + (allowances.other || 0);\n  \n  return basic + totalAllowances;\n});\n\n// Virtual for net salary\nemployeeSchema.virtual('netSalary').get(function() {\n  const gross = this.grossSalary;\n  const deductions = this.salaryInfo.deductions;\n  const totalDeductions = (deductions.pf || 0) + (deductions.esi || 0) + \n                         (deductions.tax || 0) + (deductions.other || 0);\n  \n  return Math.max(0, gross - totalDeductions);\n});\n\n// Static methods\nemployeeSchema.statics.getByDepartment = function(department) {\n  return this.find({ 'workInfo.department': department, status: 'Active' })\n    .populate('user', 'name email employeeId')\n    .sort({ 'personalInfo.firstName': 1 });\n};\n\nemployeeSchema.statics.getActiveEmployees = function() {\n  return this.find({ status: 'Active' })\n    .populate('user', 'name email employeeId')\n    .sort({ 'workInfo.joiningDate': -1 });\n};\n\nemployeeSchema.statics.getEmployeeStats = async function() {\n  const stats = await this.aggregate([\n    {\n      $group: {\n        _id: null,\n        total: { $sum: 1 },\n        active: { $sum: { $cond: [{ $eq: ['$status', 'Active'] }, 1, 0] } },\n        inactive: { $sum: { $cond: [{ $eq: ['$status', 'Inactive'] }, 1, 0] } },\n        onLeave: { $sum: { $cond: [{ $eq: ['$status', 'On Leave'] }, 1, 0] } },\n        terminated: { $sum: { $cond: [{ $eq: ['$status', 'Terminated'] }, 1, 0] } }\n      }\n    }\n  ]);\n\n  return stats[0] || { total: 0, active: 0, inactive: 0, onLeave: 0, terminated: 0 };\n};\n\nexport default mongoose.model('Employee', employeeSchema);","path":null,"size_bytes":9860,"size_tokens":null},"frontend/src/pages/Admin/DepartmentManagement.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { departmentAPI } from '../../utils/api';\nimport AdminLayout from '../../components/Admin/layout/AdminLayout';\nimport { \n  Plus, \n  Search, \n  Edit, \n  Trash2, \n  Users, \n  Building,\n  X,\n  Save,\n  AlertCircle,\n  CheckCircle,\n  User,\n  MapPin,\n  Calendar,\n  TrendingUp,\n  Eye,\n  DollarSign\n} from 'lucide-react';\nimport toast from 'react-hot-toast';\n\nconst DepartmentManagement = () => {\n  const [departments, setDepartments] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [showEditModal, setShowEditModal] = useState(false);\n  const [showViewModal, setShowViewModal] = useState(false);\n  const [selectedDepartment, setSelectedDepartment] = useState(null);\n\n  const [newDepartment, setNewDepartment] = useState({\n    name: '',\n    code: '',\n    description: '',\n    manager: '',\n    location: '',\n    budget: 0,\n    status: 'Active',\n    establishedDate: new Date().toISOString().split('T')[0],\n    goals: []\n  });\n\n  const statusOptions = ['Active', 'Inactive', 'Restructuring'];\n\n  // Fetch departments from backend\n  const fetchDepartments = async () => {\n    try {\n      setLoading(true);\n      const response = await departmentAPI.getDepartments();\n      if (response.data.success) {\n        setDepartments(response.data.data);\n      }\n    } catch (error) {\n      console.error('Error fetching departments:', error);\n      toast.error('Failed to fetch departments');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchDepartments();\n  }, []);\n\n  const filteredDepartments = departments.filter(dept => {\n    const searchLower = searchTerm.toLowerCase();\n    return dept.name.toLowerCase().includes(searchLower) ||\n           dept.code.toLowerCase().includes(searchLower) ||\n           dept.manager?.toLowerCase().includes(searchLower) ||\n           dept.description?.toLowerCase().includes(searchLower);\n  });\n\n  const handleCreateDepartment = async (e) => {\n    e.preventDefault();\n    \n    if (!newDepartment.name || !newDepartment.code) {\n      toast.error('Department name and code are required');\n      return;\n    }\n\n    try {\n      const response = await departmentAPI.createDepartment(newDepartment);\n      \n      if (response.data.success) {\n        await fetchDepartments();\n        resetForm();\n        setShowAddModal(false);\n        toast.success('Department created successfully!');\n      }\n    } catch (error) {\n      console.error('Error creating department:', error);\n      toast.error(error.response?.data?.message || 'Failed to create department');\n    }\n  };\n\n  const handleEditDepartment = async (e) => {\n    e.preventDefault();\n    \n    try {\n      const response = await departmentAPI.updateDepartment(selectedDepartment._id, selectedDepartment);\n      if (response.data.success) {\n        await fetchDepartments();\n        setShowEditModal(false);\n        setSelectedDepartment(null);\n        toast.success('Department updated successfully!');\n      }\n    } catch (error) {\n      console.error('Error updating department:', error);\n      toast.error(error.response?.data?.message || 'Failed to update department');\n    }\n  };\n\n  const handleDeleteDepartment = async (id) => {\n    const department = departments.find(d => d._id === id);\n    \n    if (department?.employeeCount > 0) {\n      toast.error('Cannot delete department with employees. Please reassign employees first.');\n      return;\n    }\n\n    if (window.confirm(`Are you sure you want to delete the ${department?.name} department?`)) {\n      try {\n        const response = await departmentAPI.deleteDepartment(id);\n        if (response.data.success) {\n          await fetchDepartments();\n          toast.success('Department deleted successfully!');\n        }\n      } catch (error) {\n        console.error('Error deleting department:', error);\n        toast.error(error.response?.data?.message || 'Failed to delete department');\n      }\n    }\n  };\n\n  const resetForm = () => {\n    setNewDepartment({\n      name: '',\n      code: '',\n      description: '',\n      manager: '',\n      location: '',\n      budget: 0,\n      status: 'Active',\n      establishedDate: new Date().toISOString().split('T')[0],\n      goals: []\n    });\n  };\n\n  const addGoal = () => {\n    if (newDepartment.goals.length < 5) {\n      setNewDepartment({\n        ...newDepartment,\n        goals: [...newDepartment.goals, '']\n      });\n    }\n  };\n\n  const updateGoal = (index, value) => {\n    const updatedGoals = [...newDepartment.goals];\n    updatedGoals[index] = value;\n    setNewDepartment({\n      ...newDepartment,\n      goals: updatedGoals\n    });\n  };\n\n  const removeGoal = (index) => {\n    const updatedGoals = newDepartment.goals.filter((_, i) => i !== index);\n    setNewDepartment({\n      ...newDepartment,\n      goals: updatedGoals\n    });\n  };\n\n  // Add Department Modal\n  const AddDepartmentModal = () => (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-gray-900 neon-border rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h2 className=\"text-2xl font-bold text-white\">Add New Department</h2>\n          <button \n            onClick={() => {resetForm(); setShowAddModal(false);}}\n            className=\"text-secondary-400 hover:text-white\"\n          >\n            <X className=\"w-6 h-6\" />\n          </button>\n        </div>\n\n        <form onSubmit={handleCreateDepartment} className=\"space-y-6\">\n          <div className=\"space-y-4\">\n            <h3 className=\"text-lg font-bold text-white border-b border-secondary-600 pb-2\">Basic Information</h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Department Name *</label>\n                <input\n                  type=\"text\"\n                  value={newDepartment.name}\n                  onChange={(e) => setNewDepartment({...newDepartment, name: e.target.value})}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  required\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Department Code *</label>\n                <input\n                  type=\"text\"\n                  value={newDepartment.code}\n                  onChange={(e) => setNewDepartment({...newDepartment, code: e.target.value.toUpperCase()})}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  placeholder=\"e.g., ENG, HR, MKT\"\n                  maxLength={5}\n                  required\n                />\n              </div>\n              <div className=\"md:col-span-2\">\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Description</label>\n                <textarea\n                  value={newDepartment.description}\n                  onChange={(e) => setNewDepartment({...newDepartment, description: e.target.value})}\n                  rows={3}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  placeholder=\"Brief description of the department...\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Department Manager</label>\n                <input\n                  type=\"text\"\n                  value={newDepartment.manager}\n                  onChange={(e) => setNewDepartment({...newDepartment, manager: e.target.value})}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  placeholder=\"Manager name\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Location</label>\n                <input\n                  type=\"text\"\n                  value={newDepartment.location}\n                  onChange={(e) => setNewDepartment({...newDepartment, location: e.target.value})}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  placeholder=\"Office location\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Budget</label>\n                <input\n                  type=\"number\"\n                  value={newDepartment.budget}\n                  onChange={(e) => setNewDepartment({...newDepartment, budget: parseFloat(e.target.value) || 0})}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  placeholder=\"0\"\n                  min=\"0\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Status</label>\n                <select\n                  value={newDepartment.status}\n                  onChange={(e) => setNewDepartment({...newDepartment, status: e.target.value})}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                >\n                  {statusOptions.map(status => (\n                    <option key={status} value={status}>{status}</option>\n                  ))}\n                </select>\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Established Date</label>\n                <input\n                  type=\"date\"\n                  value={newDepartment.establishedDate}\n                  onChange={(e) => setNewDepartment({...newDepartment, establishedDate: e.target.value})}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                />\n              </div>\n            </div>\n          </div>\n\n          {/* Goals Section */}\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <h3 className=\"text-lg font-bold text-white border-b border-secondary-600 pb-2\">Department Goals</h3>\n              <button\n                type=\"button\"\n                onClick={addGoal}\n                className=\"px-3 py-1 text-sm bg-neon-pink/20 text-neon-pink rounded-lg hover:bg-neon-pink/30 transition-colors\"\n                disabled={newDepartment.goals.length >= 5}\n              >\n                Add Goal\n              </button>\n            </div>\n            {newDepartment.goals.map((goal, index) => (\n              <div key={index} className=\"flex items-center space-x-2\">\n                <input\n                  type=\"text\"\n                  value={goal}\n                  onChange={(e) => updateGoal(index, e.target.value)}\n                  className=\"flex-1 px-4 py-2 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  placeholder={`Goal ${index + 1}`}\n                />\n                <button\n                  type=\"button\"\n                  onClick={() => removeGoal(index)}\n                  className=\"p-2 text-red-400 hover:bg-red-400/10 rounded-lg transition-colors\"\n                >\n                  <X className=\"w-4 h-4\" />\n                </button>\n              </div>\n            ))}\n          </div>\n\n          <div className=\"flex justify-end space-x-4 pt-6 border-t border-secondary-600\">\n            <button\n              type=\"button\"\n              onClick={() => {resetForm(); setShowAddModal(false);}}\n              className=\"px-6 py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700/50 transition-colors\"\n            >\n              Cancel\n            </button>\n            <button\n              type=\"submit\"\n              className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300\"\n            >\n              Create Department\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  );\n\n  // Edit Modal (similar to Add but with selectedDepartment)\n  const EditModal = () => (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-gray-900 neon-border rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h2 className=\"text-2xl font-bold text-white\">Edit Department</h2>\n          <button onClick={() => setShowEditModal(false)} className=\"text-secondary-400 hover:text-white\">\n            <X className=\"w-6 h-6\" />\n          </button>\n        </div>\n\n        <form onSubmit={handleEditDepartment} className=\"space-y-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Department Name *</label>\n              <input\n                type=\"text\"\n                value={selectedDepartment?.name || ''}\n                onChange={(e) => setSelectedDepartment({...selectedDepartment, name: e.target.value})}\n                className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                required\n              />\n            </div>\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Department Code *</label>\n              <input\n                type=\"text\"\n                value={selectedDepartment?.code || ''}\n                onChange={(e) => setSelectedDepartment({...selectedDepartment, code: e.target.value.toUpperCase()})}\n                className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                maxLength={5}\n                required\n              />\n            </div>\n          </div>\n\n          <div className=\"flex justify-end space-x-4 pt-6 border-t border-secondary-600\">\n            <button\n              type=\"button\"\n              onClick={() => setShowEditModal(false)}\n              className=\"px-6 py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700/50 transition-colors\"\n            >\n              Cancel\n            </button>\n            <button\n              type=\"submit\"\n              className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300\"\n            >\n              Update Department\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  );\n\n  // View Modal\n  const ViewModal = () => (\n    <div className=\"fixed inset-0 z-[9999] flex items-center justify-center p-4\">\n      {/* Enhanced backdrop with blur */}\n      <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" onClick={() => setShowViewModal(false)} />\n\n      {/* Modal content */}\n      <div className=\"relative glass-morphism neon-border rounded-2xl p-4 sm:p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h2 className=\"text-2xl font-bold text-white\">Department Details</h2>\n          <button onClick={() => setShowViewModal(false)} className=\"text-secondary-400 hover:text-white\">\n            <X className=\"w-6 h-6\" />\n          </button>\n        </div>\n        \n        {selectedDepartment && (\n          <div className=\"space-y-6\">\n            <div className=\"flex items-center space-x-4 p-4 bg-secondary-800/30 rounded-lg\">\n              <div className=\"w-16 h-16 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                <Building className=\"w-8 h-8 text-white\" />\n              </div>\n              <div>\n                <h3 className=\"text-xl font-bold text-white\">{selectedDepartment.name}</h3>\n                <p className=\"text-neon-pink\">{selectedDepartment.code}</p>\n                <p className=\"text-secondary-400\">{selectedDepartment.description}</p>\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              <div className=\"space-y-4\">\n                <h4 className=\"text-lg font-semibold text-white\">Information</h4>\n                <div className=\"space-y-2\">\n                  <p className=\"text-secondary-300\"><span className=\"text-white\">Manager:</span> {selectedDepartment.manager || 'Not assigned'}</p>\n                  <p className=\"text-secondary-300\"><span className=\"text-white\">Location:</span> {selectedDepartment.location || 'Not specified'}</p>\n                  <p className=\"text-secondary-300\"><span className=\"text-white\">Status:</span> \n                    <span className={`ml-2 px-2 py-1 text-xs rounded-full ${\n                      selectedDepartment.status === 'Active' ? 'bg-green-400/20 text-green-400' :\n                      selectedDepartment.status === 'Inactive' ? 'bg-red-400/20 text-red-400' :\n                      'bg-yellow-400/20 text-yellow-400'\n                    }`}>\n                      {selectedDepartment.status}\n                    </span>\n                  </p>\n                  <p className=\"text-secondary-300\"><span className=\"text-white\">Employees:</span> {selectedDepartment.employeeCount || 0}</p>\n                </div>\n              </div>\n\n              <div className=\"space-y-4\">\n                <h4 className=\"text-lg font-semibold text-white\">Goals</h4>\n                {selectedDepartment.goals && selectedDepartment.goals.length > 0 ? (\n                  <ul className=\"space-y-2\">\n                    {selectedDepartment.goals.map((goal, index) => (\n                      <li key={index} className=\"flex items-start space-x-2 text-secondary-300\">\n                        <CheckCircle className=\"w-4 h-4 text-neon-pink mt-1 flex-shrink-0\" />\n                        <span>{goal}</span>\n                      </li>\n                    ))}\n                  </ul>\n                ) : (\n                  <p className=\"text-secondary-400\">No goals set</p>\n                )}\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n\n  if (loading) {\n    return (\n      <AdminLayout>\n        <div className=\"flex items-center justify-center min-h-screen\">\n          <div className=\"text-white text-xl\">Loading departments...</div>\n        </div>\n      </AdminLayout>\n    );\n  }\n\n  return (\n    <AdminLayout>\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-3 sm:gap-4\">\n          <div>\n            <h1 className=\"text-xl sm:text-2xl font-bold text-white\">Department Management</h1>\n            <p className=\"text-secondary-400 text-sm sm:text-base\">Manage company departments and organizational structure</p>\n          </div>\n          <button\n            onClick={() => setShowAddModal(true)}\n            className=\"px-4 sm:px-6 py-2 sm:py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold text-sm rounded-lg hover-glow transition-all duration-300 flex items-center\"\n          >\n            <Plus className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1.5 sm:mr-2\" />\n            Add Department\n          </button>\n        </div>\n\n        {/* Search */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 sm:w-5 sm:h-5 text-secondary-400\" />\n            <input\n              type=\"text\"\n              placeholder=\"Search departments...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"w-full pl-10 pr-4 py-2 sm:py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n            />\n          </div>\n        </div>\n\n        {/* Department Stats */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 sm:gap-6\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-xl sm:text-2xl font-bold text-white\">{departments.length}</h3>\n                <p className=\"text-secondary-400 text-sm sm:text-base\">Total Departments</p>\n              </div>\n              <div className=\"w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center\">\n                <Building className=\"w-5 h-5 sm:w-6 sm:h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n          <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-xl sm:text-2xl font-bold text-white\">\n                  {departments.filter(d => d.status === 'Active').length}\n                </h3>\n                <p className=\"text-secondary-400 text-sm sm:text-base\">Active</p>\n              </div>\n              <div className=\"w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center\">\n                <CheckCircle className=\"w-5 h-5 sm:w-6 sm:h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n          <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-xl sm:text-2xl font-bold text-white\">\n                  {departments.reduce((sum, dept) => sum + (dept.employeeCount || 0), 0)}\n                </h3>\n                <p className=\"text-secondary-400 text-sm sm:text-base\">Total Employees</p>\n              </div>\n              <div className=\"w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center\">\n                <Users className=\"w-5 h-5 sm:w-6 sm:h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n          <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-xl sm:text-2xl font-bold text-white\">\n                  {departments.reduce((sum, dept) => sum + (dept.budget || 0), 0).toLocaleString()}\n                </h3>\n                <p className=\"text-secondary-400 text-sm sm:text-base\">Total Budget</p>\n              </div>\n              <div className=\"w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-pink-500 to-pink-600 rounded-lg flex items-center justify-center\">\n                <DollarSign className=\"w-5 h-5 sm:w-6 sm:h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Department Table */}\n        <div className=\"glass-morphism neon-border rounded-2xl overflow-hidden\">\n          {/* Desktop Table View */}\n          <div className=\"hidden md:block overflow-x-auto\">\n            <table className=\"w-full\">\n              <thead className=\"border-b border-secondary-700\">\n                <tr>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Department</th>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Manager</th>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Employees</th>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Status</th>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Budget</th>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Actions</th>\n                </tr>\n              </thead>\n              <tbody>\n                {filteredDepartments.map((department) => (\n                  <tr key={department._id} className=\"border-b border-secondary-800 hover:bg-secondary-800/30 transition-colors\">\n                    <td className=\"p-4 sm:p-6\">\n                      <div className=\"flex items-center space-x-3\">\n                        <div className=\"w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                          <Building className=\"w-4 h-4 sm:w-5 sm:h-5 text-white\" />\n                        </div>\n                        <div>\n                          <p className=\"text-white font-medium\">{department.name}</p>\n                          <p className=\"text-secondary-400 text-sm\">{department.code}</p>\n                        </div>\n                      </div>\n                    </td>\n                    <td className=\"p-4 sm:p-6 text-white\">{department.manager || 'Not assigned'}</td>\n                    <td className=\"p-4 sm:p-6 text-white\">{department.employeeCount || 0}</td>\n                    <td className=\"p-4 sm:p-6\">\n                      <span className={`px-3 py-1 text-xs rounded-full ${\n                        department.status === 'Active' ? 'bg-green-400/20 text-green-400' :\n                        department.status === 'Inactive' ? 'bg-red-400/20 text-red-400' :\n                        'bg-yellow-400/20 text-yellow-400'\n                      }`}>\n                        {department.status}\n                      </span>\n                    </td>\n                    <td className=\"p-4 sm:p-6 text-white\">{department.budget ? `₹${department.budget.toLocaleString()}` : '-'}</td>\n                    <td className=\"p-4 sm:p-6\">\n                      <div className=\"flex items-center space-x-2\">\n                        <button\n                          onClick={() => {\n                            setSelectedDepartment(department);\n                            setShowViewModal(true);\n                          }}\n                          className=\"p-2 text-secondary-400 hover:text-blue-400 hover:bg-blue-400/10 rounded-lg transition-colors\"\n                          title=\"View Details\"\n                        >\n                          <Eye className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                          onClick={() => {\n                            setSelectedDepartment(department);\n                            setShowEditModal(true);\n                          }}\n                          className=\"p-2 text-secondary-400 hover:text-neon-pink hover:bg-neon-pink/10 rounded-lg transition-colors\"\n                          title=\"Edit\"\n                        >\n                          <Edit className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                          onClick={() => handleDeleteDepartment(department._id)}\n                          className=\"p-2 text-secondary-400 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-colors\"\n                          title=\"Delete\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </button>\n                      </div>\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n\n          {/* Mobile Card View */}\n          <div className=\"md:hidden\">\n            {filteredDepartments.map((department) => (\n              <div key={department._id} className=\"p-4 border-b border-secondary-800 hover:bg-secondary-800/30 transition-colors\">\n                <div className=\"flex items-center space-x-3 mb-3\">\n                  <div className=\"w-10 h-10 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                    <Building className=\"w-5 h-5 text-white\" />\n                  </div>\n                  <div>\n                    <p className=\"text-white font-medium\">{department.name}</p>\n                    <p className=\"text-secondary-400 text-sm\">{department.code}</p>\n                  </div>\n                </div>\n                <div className=\"space-y-2 mb-3\">\n                  <p className=\"text-secondary-300 text-sm\"><span className=\"text-white\">Manager:</span> {department.manager || 'Not assigned'}</p>\n                  <p className=\"text-secondary-300 text-sm\"><span className=\"text-white\">Employees:</span> {department.employeeCount || 0}</p>\n                  <p className=\"text-secondary-300 text-sm\"><span className=\"text-white\">Status:</span>\n                    <span className={`ml-2 px-2 py-1 text-xs rounded-full ${\n                      department.status === 'Active' ? 'bg-green-400/20 text-green-400' :\n                      department.status === 'Inactive' ? 'bg-red-400/20 text-red-400' :\n                      'bg-yellow-400/20 text-yellow-400'\n                    }`}>\n                      {department.status}\n                    </span>\n                  </p>\n                  <p className=\"text-secondary-300 text-sm\"><span className=\"text-white\">Budget:</span> {department.budget ? `₹${department.budget.toLocaleString()}` : '-'}</p>\n                </div>\n                <div className=\"flex items-center space-x-2\">\n                  <button\n                    onClick={() => {\n                      setSelectedDepartment(department);\n                      setShowViewModal(true);\n                    }}\n                    className=\"p-2 text-secondary-400 hover:text-blue-400 hover:bg-blue-400/10 rounded-lg transition-colors\"\n                    title=\"View Details\"\n                  >\n                    <Eye className=\"w-4 h-4\" />\n                  </button>\n                  <button\n                    onClick={() => {\n                      setSelectedDepartment(department);\n                      setShowEditModal(true);\n                    }}\n                    className=\"p-2 text-secondary-400 hover:text-neon-pink hover:bg-neon-pink/10 rounded-lg transition-colors\"\n                    title=\"Edit\"\n                  >\n                    <Edit className=\"w-4 h-4\" />\n                  </button>\n                  <button\n                    onClick={() => handleDeleteDepartment(department._id)}\n                    className=\"p-2 text-secondary-400 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-colors\"\n                    title=\"Delete\"\n                  >\n                    <Trash2 className=\"w-4 h-4\" />\n                  </button>\n                </div>\n              </div>\n            ))}\n          </div>\n\n          {filteredDepartments.length === 0 && (\n            <div className=\"p-8 sm:p-12 text-center\">\n              <Building className=\"w-10 h-10 sm:w-12 sm:h-12 text-secondary-600 mx-auto mb-4\" />\n              <h3 className=\"text-base sm:text-lg font-medium text-secondary-400 mb-2\">No departments found</h3>\n              <p className=\"text-sm sm:text-base text-secondary-500\">\n                {searchTerm\n                  ? 'Try adjusting your search term'\n                  : 'Start by adding your first department'}\n              </p>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Modals */}\n      {showAddModal && <AddDepartmentModal />}\n      {showEditModal && <EditModal />}\n      {showViewModal && <ViewModal />}\n    </AdminLayout>\n  );\n};\n\nexport default DepartmentManagement;","path":null,"size_bytes":32575,"size_tokens":null},"backend/models/GroupMessage.js":{"content":"import mongoose from 'mongoose';\n\nconst groupMessageSchema = new mongoose.Schema({\n  group: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'Group',\n    required: true\n  },\n  sender: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true\n  },\n  text: {\n    type: String,\n    required: true,\n    trim: true\n  },\n  type: {\n    type: String,\n    enum: ['text', 'system'],\n    default: 'text'\n  },\n  readBy: [{\n    user: {\n      type: mongoose.Schema.Types.ObjectId,\n      ref: 'User'\n    },\n    readAt: {\n      type: Date,\n      default: Date.now\n    }\n  }],\n  isDeleted: {\n    type: Boolean,\n    default: false\n  }\n}, {\n  timestamps: true\n});\n\ngroupMessageSchema.index({ group: 1, createdAt: -1 });\ngroupMessageSchema.index({ sender: 1 });\n\nexport default mongoose.model('GroupMessage', groupMessageSchema);\n","path":null,"size_bytes":836,"size_tokens":null},"backend/utils/email.js":{"content":"import nodemailer from 'nodemailer';\n\n// Create transporter based on environment\nconst createTransporter = () => {\n  if (process.env.NODE_ENV === 'production') {\n    // Production email configuration (e.g., Gmail SMTP)\n    return nodemailer.createTransport({\n      service: 'gmail', // or use custom SMTP host\n      auth: {\n        user: process.env.EMAIL_FROM,\n        pass: process.env.EMAIL_PASSWORD, // App Password for Gmail\n      },\n    });\n  } else {\n    // Development - use Ethereal Email for testing\n    return nodemailer.createTransport({\n      host: 'smtp.ethereal.email',\n      port: 587,\n      secure: false,\n      auth: {\n        user: process.env.ETHEREAL_USER || 'ethereal.user@ethereal.email',\n        pass: process.env.ETHEREAL_PASS || 'ethereal.pass',\n      },\n    });\n  }\n};\n\n/**\n * Send email utility function\n */\nexport const sendEmail = async ({ to, subject, html, text }) => {\n  try {\n    const transporter = createTransporter();\n\n    const mailOptions = {\n      from: {\n        name: 'CompanyName EMS',\n        address: process.env.EMAIL_FROM || 'noreply@company.com',\n      },\n      to,\n      subject,\n      html,\n      text: text || html.replace(/<[^>]*>/g, ''), // Fallback plain text\n    };\n\n    console.log(`📧 Attempting to send email to: ${to}`);\n    console.log(`📧 Subject: ${subject}`);\n\n    const info = await transporter.sendMail(mailOptions);\n\n    console.log('✅ Email sent successfully:', info.messageId);\n\n    if (process.env.NODE_ENV !== 'production') {\n      console.log('🔗 Preview URL:', nodemailer.getTestMessageUrl(info));\n    }\n\n    return {\n      success: true,\n      messageId: info.messageId,\n      previewUrl:\n        process.env.NODE_ENV !== 'production'\n          ? nodemailer.getTestMessageUrl(info)\n          : null,\n    };\n  } catch (error) {\n    console.error('❌ Email sending error:', error);\n    console.error('❌ Error details:', {\n      to,\n      subject,\n      error: error.message,\n      code: error.code,\n      command: error.command\n    });\n\n    // Don't throw error in production to prevent breaking the main flow\n    // Instead return a failure result\n    return {\n      success: false,\n      error: error.message,\n      message: 'Email could not be sent'\n    };\n  }\n};\n\n/**\n * Email template wrapper with company branding\n */\nconst createEmailTemplate = (content, title = 'CompanyName EMS') => {\n  return `\n    <!DOCTYPE html>\n    <html lang=\"en\">\n    <head>\n      <meta charset=\"UTF-8\">\n      <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n      <title>${title}</title>\n      <style>\n        body { font-family: sans-serif; background: #f4f4f7; color: #333; }\n        .email-container { max-width: 600px; margin: auto; background: white; border-radius: 10px; overflow: hidden; }\n        .header { background: linear-gradient(135deg, #e91e63, #9c27b0); padding: 30px; text-align: center; color: white; }\n        .content { padding: 30px; }\n        .button { display: inline-block; padding: 14px 28px; border-radius: 8px; background: linear-gradient(135deg, #e91e63, #9c27b0); color: white; text-decoration: none; }\n        .info-box, .warning-box, .success-box { padding: 15px; border-radius: 6px; margin: 20px 0; }\n        .info-box { background: #f8f9fa; border-left: 4px solid #e91e63; }\n        .warning-box { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; }\n        .success-box { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }\n        .footer { background: #f8f9fa; padding: 15px; text-align: center; font-size: 13px; color: #666; }\n      </style>\n    </head>\n    <body>\n      <div class=\"email-container\">\n        <div class=\"header\">\n          <h1>CompanyName</h1>\n          <p>Employee Management System</p>\n        </div>\n        <div class=\"content\">\n          ${content}\n        </div>\n        <div class=\"footer\">\n          <p>This is an automated email from CompanyName EMS. Please do not reply.</p>\n          <p>\n            <a href=\"${process.env.FRONTEND_URL}\">Visit Portal</a> | \n            <a href=\"mailto:${process.env.SUPPORT_EMAIL || 'support@company.com'}\">Contact Support</a>\n          </p>\n        </div>\n      </div>\n    </body>\n    </html>\n  `;\n};\n\n/**\n * Password reset request email\n */\nexport const sendPasswordResetEmail = async (user, resetToken) => {\n  const resetURL = `${process.env.FRONTEND_URL}/reset-password/${resetToken}`;\n\n  const emailContent = `\n    <h2>Password Reset Request</h2>\n    <p>Hello <strong>${user.name}</strong>,</p>\n    <p>Click below to reset your password:</p>\n    <div style=\"text-align:center;margin:20px;\">\n      <a href=\"${resetURL}\" class=\"button\">Reset Password</a>\n    </div>\n    <div class=\"warning-box\">\n      <p>⚠️ This link expires in <strong>10 minutes</strong>. If you didn’t request this, ignore this email.</p>\n    </div>\n    <p>If the button doesn’t work, copy and paste this link:<br>\n    <a href=\"${resetURL}\">${resetURL}</a></p>\n  `;\n\n  const htmlContent = createEmailTemplate(emailContent, 'Password Reset Request');\n\n  return await sendEmail({\n    to: user.email,\n    subject: '🔐 Password Reset Request - CompanyName EMS',\n    html: htmlContent,\n  });\n};\n\n/**\n * Password reset confirmation\n */\nexport const sendPasswordResetConfirmation = async (user) => {\n  const emailContent = `\n    <h2>✅ Password Reset Successful</h2>\n    <p>Hello <strong>${user.name}</strong>,</p>\n    <p>Your password was successfully changed. You can now login with your new password.</p>\n    <div style=\"text-align:center;margin:20px;\">\n      <a href=\"${process.env.FRONTEND_URL}/login\" class=\"button\">Login Now</a>\n    </div>\n  `;\n\n  const htmlContent = createEmailTemplate(emailContent, 'Password Reset Confirmation');\n\n  return await sendEmail({\n    to: user.email,\n    subject: '✅ Password Reset Confirmation - CompanyName EMS',\n    html: htmlContent,\n  });\n};\n\n/**\n * Welcome email\n */\nexport const sendWelcomeEmail = async (employee, tempPassword) => {\n  const emailContent = `\n    <h2>Welcome to Our Team 🎉</h2>\n    <p>Hello <strong>${employee.fullName}</strong>,</p>\n    <p>Your account has been created. Here are your login details:</p>\n    <div class=\"info-box\">\n      <p><strong>Email:</strong> ${employee.user.email}</p>\n      <p><strong>Employee ID:</strong> ${employee.employeeId}</p>\n      <p><strong>Temporary Password:</strong> ${tempPassword}</p>\n    </div>\n    <div style=\"text-align:center;margin:20px;\">\n      <a href=\"${process.env.FRONTEND_URL}/login\" class=\"button\">Login to Your Account</a>\n    </div>\n    <div class=\"warning-box\">\n      <p>⚠️ Please change your temporary password after first login.</p>\n    </div>\n  `;\n\n  const htmlContent = createEmailTemplate(emailContent, 'Welcome to CompanyName');\n\n  return await sendEmail({\n    to: employee.user.email,\n    subject: '🎉 Welcome to CompanyName - Your Account is Ready!',\n    html: htmlContent,\n  });\n};\n","path":null,"size_bytes":6908,"size_tokens":null},"backend/routes/problemRoutes.js":{"content":"// backend/routes/problemRoutes.js\nimport express from 'express';\nimport Problem from '../models/Problem.js';\nimport { protect } from '../middleware/auth.js';\n\nconst router = express.Router();\n\n// Apply auth middleware to all routes\nrouter.use(protect);\n\n// GET all problems\nrouter.get('/', async (req, res) => {\n  try {\n    const problems = await Problem.find()\n      .populate('reportedBy', 'personalInfo')\n      .populate('solvedBy', 'personalInfo')\n      .sort({ createdAt: -1 });\n    res.json({ success: true, data: problems });\n  } catch (err) {\n    res.status(500).json({ success: false, message: 'Failed to fetch problems' });\n  }\n});\n\n// POST new problem\nrouter.post('/', async (req, res) => {\n  try {\n    const problem = new Problem({\n      description: req.body.description,\n      reportedBy: req.user.id,\n      status: 'Pending'\n    });\n    await problem.save();\n    await problem.populate('reportedBy', 'personalInfo');\n    res.status(201).json({ success: true, data: problem });\n  } catch (err) {\n    res.status(500).json({ success: false, message: 'Failed to create problem' });\n  }\n});\n\n// PATCH solve problem\nrouter.patch('/:id/solve', async (req, res) => {\n  try {\n    const problem = await Problem.findById(req.params.id);\n    if (!problem) return res.status(404).json({ success: false, message: 'Problem not found' });\n    \n    problem.status = 'Solved';\n    problem.solvedBy = req.user.id;\n    problem.solvedAt = new Date();\n    await problem.save();\n    await problem.populate('reportedBy solvedBy', 'personalInfo');\n    \n    res.json({ success: true, data: problem });\n  } catch (err) {\n    res.status(500).json({ success: false, message: 'Failed to solve problem' });\n  }\n});\n\nexport default router;","path":null,"size_bytes":1723,"size_tokens":null},"frontend/src/components/Admin/main/TODO.md":{"content":"# TODO: Add \"Add New Task\" Command to Admin Chatbot\n\n- [x] Add new if condition in parseCommand function for \"add new task\" or \"create task\"\n- [x] Parse input to extract task details: title, assignedTo, project, dueDate\n- [x] Call taskService.createTask() with parsed details\n- [x] Return confirmation message\n- [ ] Test the chatbot by running the app and trying the command\n","path":null,"size_bytes":375,"size_tokens":null},"frontend/src/pages/Admin/AdminDashboardPage.jsx":{"content":"import React from 'react'\nimport AdminDashboard from '../../components/Admin/main/AdminDashboard'\n\nfunction AdminDashboardPage() {\n  return (\n    \n    <><AdminDashboard/></>\n  )\n}\n\nexport default AdminDashboardPage","path":null,"size_bytes":214,"size_tokens":null},"frontend/src/pages/Admin/AdminPayslips.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport AdminLayout from '../../components/Admin/layout/AdminLayout';\nimport { payslipAPI, employeeAPI } from '../../utils/api';\nimport {\n  FileText,\n  Download,\n  Plus,\n  Search,\n  Filter,\n  Calendar,\n  DollarSign,\n  Users,\n  Eye,\n  Trash2,\n  X,\n  CheckCircle,\n  AlertCircle,\n  RefreshCw\n} from 'lucide-react';\nimport toast from 'react-hot-toast';\n\nconst AdminPayslips = () => {\n  const [payslips, setPayslips] = useState([]);\n  const [employees, setEmployees] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [showGenerateModal, setShowGenerateModal] = useState(false);\n  const [showBulkModal, setShowBulkModal] = useState(false);\n  const [showViewModal, setShowViewModal] = useState(false);\n  const [selectedPayslip, setSelectedPayslip] = useState(null);\n  const [generating, setGenerating] = useState(false);\n  \n  const currentDate = new Date();\n  const [filterMonth, setFilterMonth] = useState(currentDate.getMonth() + 1);\n  const [filterYear, setFilterYear] = useState(currentDate.getFullYear());\n  \n  const [formData, setFormData] = useState({\n    employeeId: '',\n    month: currentDate.getMonth() + 1,\n    year: currentDate.getFullYear(),\n    earnings: {\n      basicSalary: 0,\n      hra: 0,\n      medical: 0,\n      transport: 0,\n      bonus: 0,\n      overtime: 0,\n      otherAllowances: 0\n    },\n    deductions: {\n      pf: 0,\n      esi: 0,\n      tax: 0,\n      professionalTax: 0,\n      loanDeduction: 0,\n      otherDeductions: 0\n    },\n    remarks: ''\n  });\n\n  const months = [\n    'January', 'February', 'March', 'April', 'May', 'June',\n    'July', 'August', 'September', 'October', 'November', 'December'\n  ];\n\n  const years = Array.from({ length: 5 }, (_, i) => currentDate.getFullYear() - i);\n\n  useEffect(() => {\n    fetchPayslips();\n    fetchEmployees();\n  }, [filterMonth, filterYear]);\n\n  const fetchPayslips = async () => {\n    try {\n      setLoading(true);\n      const response = await payslipAPI.getPayslips({ month: filterMonth, year: filterYear });\n      console.log('Payslips response:', response.data); // Debug log\n      setPayslips(response.data?.data?.payslips || []); // ✅ Fixed: Correct nested path\n    } catch (error) {\n      console.error('Error fetching payslips:', error);\n      toast.error('Failed to load payslips');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const fetchEmployees = async () => {\n    try {\n      const response = await employeeAPI.getEmployees({ status: 'Active', limit: 100 });\n      setEmployees(response.data?.data?.employees || []);\n    } catch (error) {\n      console.error('Error fetching employees:', error);\n      toast.error('Failed to load employees');\n    }\n  };\n\n  const handleEmployeeSelect = async (employeeId) => {\n    const employee = employees.find(e => e._id === employeeId);\n    if (employee) {\n      setFormData(prev => ({\n        ...prev,\n        employeeId,\n        earnings: {\n          basicSalary: employee.salaryInfo?.basicSalary || 0,\n          hra: employee.salaryInfo?.allowances?.hra || 0,\n          medical: employee.salaryInfo?.allowances?.medical || 0,\n          transport: employee.salaryInfo?.allowances?.transport || 0,\n          bonus: 0,\n          overtime: 0,\n          otherAllowances: employee.salaryInfo?.allowances?.other || 0\n        },\n        deductions: {\n          pf: employee.salaryInfo?.deductions?.pf || 0,\n          esi: employee.salaryInfo?.deductions?.esi || 0,\n          tax: employee.salaryInfo?.deductions?.tax || 0,\n          professionalTax: 0,\n          loanDeduction: 0,\n          otherDeductions: employee.salaryInfo?.deductions?.other || 0\n        }\n      }));\n    }\n  };\n\n  const handleGeneratePayslip = async (e, forceRegenerate = false) => {\n    e.preventDefault();\n    if (!formData.employeeId) {\n      toast.error('Please select an employee');\n      return;\n    }\n\n    try {\n      setGenerating(true);\n      const dataToSend = { ...formData };\n      if (forceRegenerate) {\n        dataToSend.regenerate = true;\n      }\n\n      const response = await payslipAPI.generatePayslip(dataToSend);\n      toast.success(forceRegenerate ? 'Payslip regenerated successfully!' : 'Payslip generated successfully!');\n      setShowGenerateModal(false);\n      resetForm();\n      fetchPayslips();\n    } catch (error) {\n      console.error('Error generating payslip:', error);\n\n      // Check if error is due to existing payslip\n      if (error.response?.data?.canRegenerate) {\n        const existingPayslip = error.response.data.existingPayslip;\n        const monthName = months[formData.month - 1];\n\n        // Show confirmation dialog\n        const confirmed = window.confirm(\n          `A payslip already exists for this employee for ${monthName} ${formData.year}.\\n\\n` +\n          `Generated: ${new Date(existingPayslip.generatedAt).toLocaleDateString()}\\n` +\n          `Net Salary: ₹${existingPayslip.netSalary?.toLocaleString()}\\n\\n` +\n          `Do you want to regenerate it? This will delete the existing payslip and create a new one.`\n        );\n\n        if (confirmed) {\n          // Retry with regenerate flag\n          handleGeneratePayslip(e, true);\n        }\n      } else {\n        toast.error(error.response?.data?.message || 'Failed to generate payslip');\n      }\n    } finally {\n      setGenerating(false);\n    }\n  };\n\n  const handleBulkGenerate = async (regenerate = false) => {\n    try {\n      setGenerating(true);\n      const response = await payslipAPI.bulkGenerate({\n        month: formData.month,\n        year: formData.year,\n        regenerate\n      });\n\n      const results = response.data.data;\n      const message = response.data.message;\n\n      // Show detailed results\n      if (results.success?.length > 0 || results.regenerated?.length > 0) {\n        toast.success(message);\n      } else if (results.skipped?.length > 0) {\n        const monthName = months[formData.month - 1];\n        const confirmed = window.confirm(\n          `All payslips for ${monthName} ${formData.year} already exist.\\n\\n` +\n          `${results.skipped.length} employees already have payslips.\\n\\n` +\n          `Do you want to regenerate all payslips? This will delete existing payslips and create new ones.`\n        );\n\n        if (confirmed) {\n          handleBulkGenerate(true);\n          return;\n        }\n      }\n\n      setShowBulkModal(false);\n      fetchPayslips();\n    } catch (error) {\n      console.error('Error bulk generating payslips:', error);\n      toast.error(error.response?.data?.message || 'Failed to generate payslips');\n    } finally {\n      setGenerating(false);\n    }\n  };\n\n  const handleDownload = async (payslipId) => {\n    try {\n      const response = await payslipAPI.downloadPayslip(payslipId);\n\n      // The response.data is already a Blob when responseType: 'blob' is set\n      const blob = new Blob([response.data], { type: 'application/pdf' });\n      const url = window.URL.createObjectURL(blob);\n\n      // Get payslip details for better filename\n      const payslip = payslips.find(p => p._id === payslipId);\n      const filename = payslip\n        ? `Payslip_${payslip.employeeId}_${payslip.period.month}_${payslip.period.year}.pdf`\n        : `payslip_${payslipId}.pdf`;\n\n      const link = document.createElement('a');\n      link.href = url;\n      link.setAttribute('download', filename);\n      document.body.appendChild(link);\n      link.click();\n\n      // Cleanup\n      setTimeout(() => {\n        link.remove();\n        window.URL.revokeObjectURL(url);\n      }, 100);\n\n      toast.success('Payslip downloaded successfully!');\n    } catch (error) {\n      console.error('Error downloading payslip:', error);\n      toast.error(error.response?.data?.message || 'Failed to download payslip');\n    }\n  };\n\n  const handleDelete = async (payslipId) => {\n    if (!window.confirm('Are you sure you want to delete this payslip?')) return;\n    \n    try {\n      await payslipAPI.deletePayslip(payslipId);\n      toast.success('Payslip deleted');\n      fetchPayslips();\n    } catch (error) {\n      console.error('Error deleting payslip:', error);\n      toast.error('Failed to delete payslip');\n    }\n  };\n\n  const handleViewPayslip = (payslip) => {\n    setSelectedPayslip(payslip);\n    setShowViewModal(true);\n  };\n\n  const resetForm = () => {\n    setFormData({\n      employeeId: '',\n      month: currentDate.getMonth() + 1,\n      year: currentDate.getFullYear(),\n      earnings: {\n        basicSalary: 0,\n        hra: 0,\n        medical: 0,\n        transport: 0,\n        bonus: 0,\n        overtime: 0,\n        otherAllowances: 0\n      },\n      deductions: {\n        pf: 0,\n        esi: 0,\n        tax: 0,\n        professionalTax: 0,\n        loanDeduction: 0,\n        otherDeductions: 0\n      },\n      remarks: ''\n    });\n  };\n\n  const calculateTotals = () => {\n    const grossEarnings = Object.values(formData.earnings).reduce((a, b) => a + (parseFloat(b) || 0), 0);\n    const totalDeductions = Object.values(formData.deductions).reduce((a, b) => a + (parseFloat(b) || 0), 0);\n    const netSalary = grossEarnings - totalDeductions;\n    return { grossEarnings, totalDeductions, netSalary };\n  };\n\n  const getStatusColor = (status) => {\n    switch (status) {\n      case 'paid': return 'bg-green-400/20 text-green-400';\n      case 'generated': return 'bg-blue-400/20 text-blue-400';\n      case 'draft': return 'bg-yellow-400/20 text-yellow-400';\n      case 'cancelled': return 'bg-red-400/20 text-red-400';\n      default: return 'bg-secondary-600 text-secondary-400';\n    }\n  };\n\n  return (\n    <AdminLayout>\n      <div className=\"space-y-6\">\n        <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n          <div>\n            <h1 className=\"text-2xl sm:text-3xl font-bold text-white\">Payslip Management</h1>\n            <p className=\"text-secondary-400 mt-1\">Generate and manage employee payslips</p>\n          </div>\n          <div className=\"flex flex-wrap gap-3\">\n            <button\n              onClick={() => setShowBulkModal(true)}\n              className=\"px-4 py-2.5 bg-secondary-700 hover:bg-secondary-600 text-white rounded-lg flex items-center space-x-2 transition-colors\"\n            >\n              <Users className=\"w-5 h-5\" />\n              <span>Bulk Generate</span>\n            </button>\n            <button\n              onClick={() => setShowGenerateModal(true)}\n              className=\"px-4 py-2.5 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg flex items-center space-x-2 hover-glow transition-all duration-300\"\n            >\n              <Plus className=\"w-5 h-5\" />\n              <span>Generate Payslip</span>\n            </button>\n          </div>\n        </div>\n\n        <div className=\"glass-morphism neon-border rounded-xl p-4\">\n          <div className=\"flex flex-wrap items-center gap-4\">\n            <div className=\"flex items-center space-x-2\">\n              <Calendar className=\"w-5 h-5 text-secondary-400\" />\n              <select\n                value={filterMonth}\n                onChange={(e) => setFilterMonth(parseInt(e.target.value))}\n                className=\"px-4 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:border-neon-pink\"\n              >\n                {months.map((month, index) => (\n                  <option key={index} value={index + 1}>{month}</option>\n                ))}\n              </select>\n              <select\n                value={filterYear}\n                onChange={(e) => setFilterYear(parseInt(e.target.value))}\n                className=\"px-4 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:border-neon-pink\"\n              >\n                {years.map(year => (\n                  <option key={year} value={year}>{year}</option>\n                ))}\n              </select>\n            </div>\n            <button\n              onClick={fetchPayslips}\n              className=\"px-4 py-2 bg-secondary-700 hover:bg-secondary-600 text-white rounded-lg flex items-center space-x-2\"\n            >\n              <RefreshCw className=\"w-4 h-4\" />\n              <span>Refresh</span>\n            </button>\n            <div className=\"ml-auto text-secondary-400\">\n              Total: {payslips.length} payslips\n            </div>\n          </div>\n        </div>\n\n        <div className=\"glass-morphism neon-border rounded-xl overflow-hidden\">\n          {loading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-neon-pink\"></div>\n            </div>\n          ) : payslips.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <FileText className=\"w-12 h-12 text-secondary-500 mx-auto mb-4\" />\n              <p className=\"text-secondary-400\">No payslips found for {months[filterMonth - 1]} {filterYear}</p>\n              <button\n                onClick={() => setShowGenerateModal(true)}\n                className=\"mt-4 px-4 py-2 bg-neon-pink/20 text-neon-pink rounded-lg hover:bg-neon-pink/30 transition-colors\"\n              >\n                Generate First Payslip\n              </button>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full\">\n                <thead className=\"bg-secondary-800/50\">\n                  <tr>\n                    <th className=\"px-4 py-3 text-left text-xs font-medium text-secondary-400 uppercase\">Employee</th>\n                    <th className=\"px-4 py-3 text-left text-xs font-medium text-secondary-400 uppercase\">Period</th>\n                    <th className=\"px-4 py-3 text-right text-xs font-medium text-secondary-400 uppercase\">Gross</th>\n                    <th className=\"px-4 py-3 text-right text-xs font-medium text-secondary-400 uppercase\">Deductions</th>\n                    <th className=\"px-4 py-3 text-right text-xs font-medium text-secondary-400 uppercase\">Net Salary</th>\n                    <th className=\"px-4 py-3 text-center text-xs font-medium text-secondary-400 uppercase\">Status</th>\n                    <th className=\"px-4 py-3 text-center text-xs font-medium text-secondary-400 uppercase\">Actions</th>\n                  </tr>\n                </thead>\n                <tbody className=\"divide-y divide-secondary-700\">\n                  {payslips.map((payslip) => (\n                    <tr key={payslip._id} className=\"hover:bg-secondary-800/30 transition-colors\">\n                      <td className=\"px-4 py-4\">\n                        <div>\n                          <p className=\"font-medium text-white\">{payslip.employeeName}</p>\n                          <p className=\"text-sm text-secondary-400\">{payslip.employeeId}</p>\n                        </div>\n                      </td>\n                      <td className=\"px-4 py-4 text-secondary-300\">\n                        {months[payslip.period.month - 1]} {payslip.period.year}\n                      </td>\n                      <td className=\"px-4 py-4 text-right text-green-400 font-medium\">\n                        INR {payslip.grossEarnings?.toLocaleString() || 0}\n                      </td>\n                      <td className=\"px-4 py-4 text-right text-red-400 font-medium\">\n                        INR {payslip.totalDeductions?.toLocaleString() || 0}\n                      </td>\n                      <td className=\"px-4 py-4 text-right text-white font-bold\">\n                        INR {payslip.netSalary?.toLocaleString() || 0}\n                      </td>\n                      <td className=\"px-4 py-4 text-center\">\n                        <span className={`px-2 py-1 rounded-full text-xs font-medium capitalize ${getStatusColor(payslip.status)}`}>\n                          {payslip.status}\n                        </span>\n                      </td>\n                      <td className=\"px-4 py-4\">\n                        <div className=\"flex items-center justify-center space-x-2\">\n                          <button\n                            onClick={() => handleViewPayslip(payslip)}\n                            className=\"p-2 text-secondary-400 hover:text-white hover:bg-secondary-700 rounded-lg transition-colors\"\n                            title=\"View Details\"\n                          >\n                            <Eye className=\"w-4 h-4\" />\n                          </button>\n                          <button\n                            onClick={() => handleDownload(payslip._id)}\n                            className=\"p-2 text-secondary-400 hover:text-neon-pink hover:bg-secondary-700 rounded-lg transition-colors\"\n                            title=\"Download PDF\"\n                          >\n                            <Download className=\"w-4 h-4\" />\n                          </button>\n                          <button\n                            onClick={() => handleDelete(payslip._id)}\n                            className=\"p-2 text-secondary-400 hover:text-red-400 hover:bg-secondary-700 rounded-lg transition-colors\"\n                            title=\"Delete\"\n                          >\n                            <Trash2 className=\"w-4 h-4\" />\n                          </button>\n                        </div>\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          )}\n        </div>\n\n        {showGenerateModal && (\n          <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\n            <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" onClick={() => setShowGenerateModal(false)} />\n            <div className=\"relative glass-morphism neon-border rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto\">\n              <div className=\"flex items-center justify-between mb-6\">\n                <h2 className=\"text-xl font-bold text-white\">Generate Payslip</h2>\n                <button onClick={() => setShowGenerateModal(false)} className=\"text-secondary-400 hover:text-white\">\n                  <X className=\"w-6 h-6\" />\n                </button>\n              </div>\n\n              <form onSubmit={handleGeneratePayslip} className=\"space-y-6\">\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Employee *</label>\n                    <select\n                      value={formData.employeeId}\n                      onChange={(e) => handleEmployeeSelect(e.target.value)}\n                      className=\"w-full px-4 py-3 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:border-neon-pink\"\n                      required\n                    >\n                      <option value=\"\">Select Employee</option>\n                      {employees.map(emp => (\n                        <option key={emp._id} value={emp._id}>\n                          {emp.personalInfo?.firstName} {emp.personalInfo?.lastName} ({emp.employeeId})\n                        </option>\n                      ))}\n                    </select>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Month *</label>\n                    <select\n                      value={formData.month}\n                      onChange={(e) => setFormData(prev => ({ ...prev, month: parseInt(e.target.value) }))}\n                      className=\"w-full px-4 py-3 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:border-neon-pink\"\n                    >\n                      {months.map((month, index) => (\n                        <option key={index} value={index + 1}>{month}</option>\n                      ))}\n                    </select>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Year *</label>\n                    <select\n                      value={formData.year}\n                      onChange={(e) => setFormData(prev => ({ ...prev, year: parseInt(e.target.value) }))}\n                      className=\"w-full px-4 py-3 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:border-neon-pink\"\n                    >\n                      {years.map(year => (\n                        <option key={year} value={year}>{year}</option>\n                      ))}\n                    </select>\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                  <div className=\"space-y-4\">\n                    <h3 className=\"text-lg font-bold text-green-400 border-b border-secondary-600 pb-2\">Earnings</h3>\n                    {Object.entries(formData.earnings).map(([key, value]) => (\n                      <div key={key} className=\"flex items-center justify-between\">\n                        <label className=\"text-sm text-secondary-300 capitalize\">{key.replace(/([A-Z])/g, ' $1').trim()}</label>\n                        <input\n                          type=\"number\"\n                          value={value}\n                          onChange={(e) => setFormData(prev => ({\n                            ...prev,\n                            earnings: { ...prev.earnings, [key]: parseFloat(e.target.value) || 0 }\n                          }))}\n                          className=\"w-32 px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-right focus:border-neon-pink\"\n                          min=\"0\"\n                        />\n                      </div>\n                    ))}\n                  </div>\n\n                  <div className=\"space-y-4\">\n                    <h3 className=\"text-lg font-bold text-red-400 border-b border-secondary-600 pb-2\">Deductions</h3>\n                    {Object.entries(formData.deductions).map(([key, value]) => (\n                      <div key={key} className=\"flex items-center justify-between\">\n                        <label className=\"text-sm text-secondary-300 capitalize\">{key.replace(/([A-Z])/g, ' $1').trim()}</label>\n                        <input\n                          type=\"number\"\n                          value={value}\n                          onChange={(e) => setFormData(prev => ({\n                            ...prev,\n                            deductions: { ...prev.deductions, [key]: parseFloat(e.target.value) || 0 }\n                          }))}\n                          className=\"w-32 px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-right focus:border-neon-pink\"\n                          min=\"0\"\n                        />\n                      </div>\n                    ))}\n                  </div>\n                </div>\n\n                <div className=\"bg-secondary-800/50 rounded-lg p-4\">\n                  <div className=\"grid grid-cols-3 gap-4 text-center\">\n                    <div>\n                      <p className=\"text-sm text-secondary-400\">Gross Earnings</p>\n                      <p className=\"text-xl font-bold text-green-400\">INR {calculateTotals().grossEarnings.toLocaleString()}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-sm text-secondary-400\">Total Deductions</p>\n                      <p className=\"text-xl font-bold text-red-400\">INR {calculateTotals().totalDeductions.toLocaleString()}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-sm text-secondary-400\">Net Salary</p>\n                      <p className=\"text-xl font-bold text-white\">INR {calculateTotals().netSalary.toLocaleString()}</p>\n                    </div>\n                  </div>\n                </div>\n\n                <div>\n                  <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Remarks</label>\n                  <textarea\n                    value={formData.remarks}\n                    onChange={(e) => setFormData(prev => ({ ...prev, remarks: e.target.value }))}\n                    className=\"w-full px-4 py-3 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:border-neon-pink\"\n                    rows={2}\n                    placeholder=\"Optional remarks...\"\n                  />\n                </div>\n\n                <div className=\"flex justify-end gap-3 pt-4 border-t border-secondary-600\">\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowGenerateModal(false)}\n                    className=\"px-6 py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700\"\n                  >\n                    Cancel\n                  </button>\n                  <button\n                    type=\"submit\"\n                    disabled={generating}\n                    className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow disabled:opacity-50\"\n                  >\n                    {generating ? 'Generating...' : 'Generate Payslip'}\n                  </button>\n                </div>\n              </form>\n            </div>\n          </div>\n        )}\n\n        {showBulkModal && (\n          <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\n            <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" onClick={() => setShowBulkModal(false)} />\n            <div className=\"relative glass-morphism neon-border rounded-2xl p-6 w-full max-w-md\">\n              <div className=\"flex items-center justify-between mb-6\">\n                <h2 className=\"text-xl font-bold text-white\">Bulk Generate Payslips</h2>\n                <button onClick={() => setShowBulkModal(false)} className=\"text-secondary-400 hover:text-white\">\n                  <X className=\"w-6 h-6\" />\n                </button>\n              </div>\n\n              <div className=\"space-y-4\">\n                <p className=\"text-secondary-300\">\n                  This will generate payslips for all active employees for the selected period.\n                </p>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Month</label>\n                    <select\n                      value={formData.month}\n                      onChange={(e) => setFormData(prev => ({ ...prev, month: parseInt(e.target.value) }))}\n                      className=\"w-full px-4 py-3 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:border-neon-pink\"\n                    >\n                      {months.map((month, index) => (\n                        <option key={index} value={index + 1}>{month}</option>\n                      ))}\n                    </select>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Year</label>\n                    <select\n                      value={formData.year}\n                      onChange={(e) => setFormData(prev => ({ ...prev, year: parseInt(e.target.value) }))}\n                      className=\"w-full px-4 py-3 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:border-neon-pink\"\n                    >\n                      {years.map(year => (\n                        <option key={year} value={year}>{year}</option>\n                      ))}\n                    </select>\n                  </div>\n                </div>\n\n                <div className=\"bg-yellow-400/10 border border-yellow-400/30 rounded-lg p-4\">\n                  <div className=\"flex items-start space-x-3\">\n                    <AlertCircle className=\"w-5 h-5 text-yellow-400 mt-0.5\" />\n                    <div>\n                      <p className=\"text-sm text-yellow-400 font-medium\">Note</p>\n                      <p className=\"text-xs text-secondary-300\">\n                        Employees with existing payslips for this period will be skipped.\n                        Salary data will be taken from employee records.\n                      </p>\n                    </div>\n                  </div>\n                </div>\n\n                <div className=\"flex justify-end gap-3 pt-4\">\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowBulkModal(false)}\n                    className=\"px-6 py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700\"\n                  >\n                    Cancel\n                  </button>\n                  <button\n                    onClick={handleBulkGenerate}\n                    disabled={generating}\n                    className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow disabled:opacity-50\"\n                  >\n                    {generating ? 'Generating...' : 'Generate All'}\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {showViewModal && selectedPayslip && (\n          <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\n            <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" onClick={() => setShowViewModal(false)} />\n            <div className=\"relative glass-morphism neon-border rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n              <div className=\"flex items-center justify-between mb-6\">\n                <h2 className=\"text-xl font-bold text-white\">Payslip Details</h2>\n                <button onClick={() => setShowViewModal(false)} className=\"text-secondary-400 hover:text-white\">\n                  <X className=\"w-6 h-6\" />\n                </button>\n              </div>\n\n              <div className=\"space-y-6\">\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <p className=\"text-sm text-secondary-400\">Employee</p>\n                    <p className=\"text-white font-medium\">{selectedPayslip.employeeName}</p>\n                    <p className=\"text-sm text-secondary-400\">{selectedPayslip.employeeId}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-secondary-400\">Period</p>\n                    <p className=\"text-white font-medium\">{months[selectedPayslip.period.month - 1]} {selectedPayslip.period.year}</p>\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-6\">\n                  <div className=\"bg-green-400/10 rounded-lg p-4\">\n                    <h3 className=\"text-green-400 font-bold mb-3\">Earnings</h3>\n                    <div className=\"space-y-2 text-sm\">\n                      <div className=\"flex justify-between\"><span className=\"text-secondary-300\">Basic Salary</span><span className=\"text-white\">INR {selectedPayslip.earnings?.basicSalary?.toLocaleString()}</span></div>\n                      <div className=\"flex justify-between\"><span className=\"text-secondary-300\">HRA</span><span className=\"text-white\">INR {selectedPayslip.earnings?.hra?.toLocaleString()}</span></div>\n                      <div className=\"flex justify-between\"><span className=\"text-secondary-300\">Medical</span><span className=\"text-white\">INR {selectedPayslip.earnings?.medical?.toLocaleString()}</span></div>\n                      <div className=\"flex justify-between\"><span className=\"text-secondary-300\">Transport</span><span className=\"text-white\">INR {selectedPayslip.earnings?.transport?.toLocaleString()}</span></div>\n                      <div className=\"flex justify-between\"><span className=\"text-secondary-300\">Bonus</span><span className=\"text-white\">INR {selectedPayslip.earnings?.bonus?.toLocaleString()}</span></div>\n                      <div className=\"flex justify-between\"><span className=\"text-secondary-300\">Overtime</span><span className=\"text-white\">INR {selectedPayslip.earnings?.overtime?.toLocaleString()}</span></div>\n                      <div className=\"flex justify-between\"><span className=\"text-secondary-300\">Other</span><span className=\"text-white\">INR {selectedPayslip.earnings?.otherAllowances?.toLocaleString()}</span></div>\n                      <div className=\"border-t border-green-400/30 pt-2 mt-2\">\n                        <div className=\"flex justify-between font-bold\"><span className=\"text-green-400\">Total Earnings</span><span className=\"text-green-400\">INR {selectedPayslip.grossEarnings?.toLocaleString()}</span></div>\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"bg-red-400/10 rounded-lg p-4\">\n                    <h3 className=\"text-red-400 font-bold mb-3\">Deductions</h3>\n                    <div className=\"space-y-2 text-sm\">\n                      <div className=\"flex justify-between\"><span className=\"text-secondary-300\">Provident Fund</span><span className=\"text-white\">INR {selectedPayslip.deductions?.pf?.toLocaleString()}</span></div>\n                      <div className=\"flex justify-between\"><span className=\"text-secondary-300\">ESI</span><span className=\"text-white\">INR {selectedPayslip.deductions?.esi?.toLocaleString()}</span></div>\n                      <div className=\"flex justify-between\"><span className=\"text-secondary-300\">Income Tax</span><span className=\"text-white\">INR {selectedPayslip.deductions?.tax?.toLocaleString()}</span></div>\n                      <div className=\"flex justify-between\"><span className=\"text-secondary-300\">Professional Tax</span><span className=\"text-white\">INR {selectedPayslip.deductions?.professionalTax?.toLocaleString()}</span></div>\n                      <div className=\"flex justify-between\"><span className=\"text-secondary-300\">Loan</span><span className=\"text-white\">INR {selectedPayslip.deductions?.loanDeduction?.toLocaleString()}</span></div>\n                      <div className=\"flex justify-between\"><span className=\"text-secondary-300\">Other</span><span className=\"text-white\">INR {selectedPayslip.deductions?.otherDeductions?.toLocaleString()}</span></div>\n                      <div className=\"border-t border-red-400/30 pt-2 mt-2\">\n                        <div className=\"flex justify-between font-bold\"><span className=\"text-red-400\">Total Deductions</span><span className=\"text-red-400\">INR {selectedPayslip.totalDeductions?.toLocaleString()}</span></div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                <div className=\"bg-neon-pink/10 border border-neon-pink/30 rounded-lg p-4 text-center\">\n                  <p className=\"text-secondary-300 text-sm\">Net Salary</p>\n                  <p className=\"text-3xl font-bold text-white\">INR {selectedPayslip.netSalary?.toLocaleString()}</p>\n                </div>\n\n                {selectedPayslip.attendance && (\n                  <div className=\"bg-secondary-800/50 rounded-lg p-4\">\n                    <h3 className=\"text-white font-bold mb-3\">Attendance Summary</h3>\n                    <div className=\"grid grid-cols-4 gap-4 text-center\">\n                      <div>\n                        <p className=\"text-2xl font-bold text-white\">{selectedPayslip.attendance.workingDays}</p>\n                        <p className=\"text-xs text-secondary-400\">Working Days</p>\n                      </div>\n                      <div>\n                        <p className=\"text-2xl font-bold text-green-400\">{selectedPayslip.attendance.presentDays}</p>\n                        <p className=\"text-xs text-secondary-400\">Present</p>\n                      </div>\n                      <div>\n                        <p className=\"text-2xl font-bold text-yellow-400\">{selectedPayslip.attendance.leaveDays}</p>\n                        <p className=\"text-xs text-secondary-400\">Leave</p>\n                      </div>\n                      <div>\n                        <p className=\"text-2xl font-bold text-red-400\">{selectedPayslip.attendance.absentDays}</p>\n                        <p className=\"text-xs text-secondary-400\">Absent</p>\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                <div className=\"flex justify-end gap-3 pt-4 border-t border-secondary-600\">\n                  <button\n                    onClick={() => handleDownload(selectedPayslip._id)}\n                    className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow flex items-center space-x-2\"\n                  >\n                    <Download className=\"w-5 h-5\" />\n                    <span>Download PDF</span>\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </AdminLayout>\n  );\n};\n\nexport default AdminPayslips;\n","path":null,"size_bytes":36857,"size_tokens":null},"frontend/src/components/Admin/Dashboard/RecentActivities.jsx":{"content":"// components/Dashboard/RecentActivities.js\nimport React from 'react';\nimport { Clock } from 'lucide-react';\n\nconst RecentActivities = ({ activities = [], loading = false }) => {\n  const getActivityTypeStyles = (type) => {\n    const styles = {\n      success: 'bg-green-400',\n      warning: 'bg-yellow-400',\n      info: 'bg-blue-400',\n      error: 'bg-red-400'\n    };\n    return styles[type] || styles.info;\n  };\n\n  const formatActivityTime = (timeString) => {\n    try {\n      const time = new Date(timeString);\n      const now = new Date();\n      const diffInMinutes = Math.floor((now - time) / (1000 * 60));\n      \n      if (diffInMinutes < 1) return 'Just now';\n      if (diffInMinutes < 60) return `${diffInMinutes} min ago`;\n      \n      const diffInHours = Math.floor(diffInMinutes / 60);\n      if (diffInHours < 24) return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;\n      \n      return time.toLocaleDateString();\n    } catch (error) {\n      return timeString || 'Unknown time';\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h2 className=\"text-xl font-bold text-white\">Recent Activities</h2>\n          <Clock className=\"w-5 h-5 text-neon-pink animate-pulse\" />\n        </div>\n        <div className=\"space-y-4\">\n          {[1, 2, 3].map((i) => (\n            <div key={i} className=\"animate-pulse\">\n              <div className=\"flex items-start space-x-3 p-3 rounded-lg\">\n                <div className=\"w-2 h-2 bg-gray-400 rounded-full mt-2 flex-shrink-0\"></div>\n                <div className=\"flex-1\">\n                  <div className=\"h-4 bg-gray-600 rounded mb-2\"></div>\n                  <div className=\"h-3 bg-gray-700 rounded w-1/2 mb-1\"></div>\n                  <div className=\"h-3 bg-gray-700 rounded w-1/3\"></div>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n      <div className=\"flex items-center justify-between mb-6\">\n        <h2 className=\"text-xl font-bold text-white\">Recent Activities</h2>\n        <Clock className=\"w-5 h-5 text-neon-pink\" />\n      </div>\n      <div className=\"space-y-4 max-h-80 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-600\">\n        {activities.length > 0 ? (\n          activities.map((activity, index) => (\n            <div \n              key={activity.id || index} \n              className=\"flex items-start space-x-3 p-3 rounded-lg hover:bg-secondary-700/30 transition-all duration-200 cursor-pointer group\"\n            >\n              <div className={`w-2 h-2 rounded-full mt-2 flex-shrink-0 ${getActivityTypeStyles(activity.type)} shadow-sm`}></div>\n              <div className=\"flex-1 min-w-0\">\n                <p className=\"text-white text-sm leading-relaxed group-hover:text-neon-pink transition-colors\">\n                  {activity.action || activity.description}\n                </p>\n                {activity.user && (\n                  <p className=\"text-neon-pink text-sm font-medium mt-1\">\n                    {activity.user}\n                  </p>\n                )}\n                <p className=\"text-secondary-400 text-xs mt-1\">\n                  {formatActivityTime(activity.time || activity.timestamp || activity.createdAt)}\n                </p>\n              </div>\n            </div>\n          ))\n        ) : (\n          <div className=\"text-center py-12\">\n            <Clock className=\"w-12 h-12 text-secondary-500 mx-auto mb-4\" />\n            <p className=\"text-secondary-400 text-lg\">No recent activities</p>\n            <p className=\"text-secondary-500 text-sm mt-2\">Activities will appear here as they happen</p>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default RecentActivities;","path":null,"size_bytes":3887,"size_tokens":null},"frontend/src/components/Common/ResetPassword.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { Lock, Eye, EyeOff, Building2, AlertCircle, CheckCircle, ArrowLeft } from 'lucide-react';\n\n// Simulated API functions\nconst verifyResetToken = async (token) => {\n  const response = await fetch(`/api/auth/verify-reset-token/${token}`);\n  \n  if (!response.ok) {\n    const errorData = await response.json();\n    throw new Error(errorData.message || 'Invalid or expired token');\n  }\n  \n  return response.json();\n};\n\nconst resetPassword = async (token, password, confirmPassword) => {\n  const response = await fetch(`/api/auth/reset-password/${token}`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({ password, confirmPassword })\n  });\n  \n  if (!response.ok) {\n    const errorData = await response.json();\n    throw new Error(errorData.message || 'Failed to reset password');\n  }\n  \n  return response.json();\n};\n\nconst ResetPassword = () => {\n  const [formData, setFormData] = useState({\n    password: '',\n    confirmPassword: ''\n  });\n  const [showPassword, setShowPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n  const [loading, setLoading] = useState(false);\n  const [verifying, setVerifying] = useState(true);\n  const [error, setError] = useState('');\n  const [success, setSuccess] = useState(false);\n  const [tokenValid, setTokenValid] = useState(false);\n  const [userEmail, setUserEmail] = useState('');\n\n  // Get token from URL - in real app, use useParams from react-router\n  const token = 'demo-token'; // Replace with actual token from URL\n\n  useEffect(() => {\n    const verifyToken = async () => {\n      try {\n        const response = await verifyResetToken(token);\n        if (response.success) {\n          setTokenValid(true);\n          setUserEmail(response.email);\n        }\n      } catch (error) {\n        setError(error.message);\n        setTokenValid(false);\n      } finally {\n        setVerifying(false);\n      }\n    };\n\n    verifyToken();\n  }, [token]);\n\n  const handleChange = (e) => {\n    setFormData({\n      ...formData,\n      [e.target.name]: e.target.value\n    });\n    setError(''); // Clear error when user types\n  };\n\n  const validatePassword = (password) => {\n    const minLength = 8;\n    const hasUpperCase = /[A-Z]/.test(password);\n    const hasLowerCase = /[a-z]/.test(password);\n    const hasNumbers = /\\d/.test(password);\n    const hasSpecialChar = /[!@#$%^&*(),.?\":{}|<>]/.test(password);\n\n    const errors = [];\n    if (password.length < minLength) errors.push(`At least ${minLength} characters`);\n    if (!hasUpperCase) errors.push('One uppercase letter');\n    if (!hasLowerCase) errors.push('One lowercase letter');\n    if (!hasNumbers) errors.push('One number');\n    if (!hasSpecialChar) errors.push('One special character');\n\n    return errors;\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setLoading(true);\n    setError('');\n\n    try {\n      const { password, confirmPassword } = formData;\n\n      // Validation\n      if (!password || !confirmPassword) {\n        throw new Error('Please fill in all fields');\n      }\n\n      if (password !== confirmPassword) {\n        throw new Error('Passwords do not match');\n      }\n\n      const passwordErrors = validatePassword(password);\n      if (passwordErrors.length > 0) {\n        throw new Error(`Password must contain: ${passwordErrors.join(', ')}`);\n      }\n\n      const response = await resetPassword(token, password, confirmPassword);\n      \n      if (response.success) {\n        setSuccess(true);\n      }\n    } catch (error) {\n      setError(error.message);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // Loading state while verifying token\n  if (verifying) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-secondary-900 via-secondary-800 to-secondary-900\">\n        <div className=\"glass-morphism neon-border p-8 rounded-2xl text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-neon-pink mx-auto mb-4\"></div>\n          <p className=\"text-white\">Verifying reset token...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Invalid token state\n  if (!tokenValid) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-secondary-900 via-secondary-800 to-secondary-900\">\n        <div className=\"absolute inset-0 overflow-hidden\">\n          <div className=\"absolute -top-10 -left-10 w-72 h-72 bg-neon-pink opacity-10 rounded-full blur-3xl animate-pulse\"></div>\n          <div className=\"absolute -bottom-10 -right-10 w-72 h-72 bg-neon-purple opacity-10 rounded-full blur-3xl animate-pulse delay-1000\"></div>\n        </div>\n\n        <div className=\"w-full max-w-md relative\">\n          <div className=\"text-center mb-8\">\n            <div className=\"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-neon-pink to-neon-purple rounded-2xl mb-4 animate-glow\">\n              <Building2 className=\"w-8 h-8 text-white\" />\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border p-8 rounded-2xl text-center\">\n            <div className=\"w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4\">\n              <AlertCircle className=\"w-8 h-8 text-red-400\" />\n            </div>\n            <h2 className=\"text-2xl font-bold text-white mb-2\">Invalid Reset Link</h2>\n            <p className=\"text-secondary-400 mb-6\">\n              This password reset link is invalid or has expired. Reset links are valid for 10 minutes only.\n            </p>\n            <div className=\"space-y-4\">\n              <button\n                onClick={() => window.location.href = '/forgot-password'}\n                className=\"w-full py-3 px-4 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300\"\n              >\n                Request New Reset Link\n              </button>\n              <button\n                onClick={() => window.location.href = '/login'}\n                className=\"inline-flex items-center text-secondary-400 hover:text-white transition-colors duration-300 bg-transparent border-none cursor-pointer\"\n              >\n                <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                Back to Login\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // Success state\n  if (success) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-secondary-900 via-secondary-800 to-secondary-900\">\n        <div className=\"absolute inset-0 overflow-hidden\">\n          <div className=\"absolute -top-10 -left-10 w-72 h-72 bg-neon-pink opacity-10 rounded-full blur-3xl animate-pulse\"></div>\n          <div className=\"absolute -bottom-10 -right-10 w-72 h-72 bg-neon-purple opacity-10 rounded-full blur-3xl animate-pulse delay-1000\"></div>\n        </div>\n\n        <div className=\"w-full max-w-md relative\">\n          <div className=\"text-center mb-8\">\n            <div className=\"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-neon-pink to-neon-purple rounded-2xl mb-4 animate-glow\">\n              <Building2 className=\"w-8 h-8 text-white\" />\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border p-8 rounded-2xl text-center\">\n            <div className=\"w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4\">\n              <CheckCircle className=\"w-8 h-8 text-green-400\" />\n            </div>\n            <h2 className=\"text-2xl font-bold text-white mb-2\">Password Reset Successful!</h2>\n            <p className=\"text-secondary-400 mb-6\">\n              Your password has been successfully updated. You can now login with your new password.\n            </p>\n            <button\n              onClick={() => window.location.href = '/login'}\n              className=\"w-full py-3 px-4 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 mb-4\"\n            >\n              Continue to Login\n            </button>\n            <p className=\"text-xs text-secondary-500\">\n              A confirmation email has been sent to your registered email address.\n            </p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // Password reset form\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-secondary-900 via-secondary-800 to-secondary-900\">\n      {/* Background Effects */}\n      <div className=\"absolute inset-0 overflow-hidden\">\n        <div className=\"absolute -top-10 -left-10 w-72 h-72 bg-neon-pink opacity-10 rounded-full blur-3xl animate-pulse\"></div>\n        <div className=\"absolute -bottom-10 -right-10 w-72 h-72 bg-neon-purple opacity-10 rounded-full blur-3xl animate-pulse delay-1000\"></div>\n      </div>\n\n      <div className=\"w-full max-w-md relative\">\n        {/* Header */}\n        <div className=\"text-center mb-8\">\n          <div className=\"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-neon-pink to-neon-purple rounded-2xl mb-4 animate-glow\">\n            <Building2 className=\"w-8 h-8 text-white\" />\n          </div>\n          <h1 className=\"text-3xl font-bold neon-text mb-2\">CompanyName</h1>\n        </div>\n\n        {/* Form */}\n        <div className=\"glass-morphism neon-border p-8 rounded-2xl\">\n          <div className=\"text-center mb-6\">\n            <h2 className=\"text-2xl font-bold text-white mb-2\">Create New Password</h2>\n            <p className=\"text-secondary-400 mb-2\">\n              Enter a new password for your account\n            </p>\n            {userEmail && (\n              <p className=\"text-neon-pink text-sm font-medium\">\n                {userEmail}\n              </p>\n            )}\n          </div>\n\n          <div onSubmit={handleSubmit} className=\"space-y-6\">\n            {/* New Password */}\n            <div className=\"space-y-2\">\n              <label className=\"block text-sm font-medium text-secondary-300\">\n                New Password\n              </label>\n              <div className=\"relative\">\n                <Lock className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                <input\n                  type={showPassword ? 'text' : 'password'}\n                  name=\"password\"\n                  value={formData.password}\n                  onChange={handleChange}\n                  className=\"w-full pl-10 pr-12 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 transition-all duration-300\"\n                  placeholder=\"Enter new password\"\n                  required\n                />\n                <button\n                  type=\"button\"\n                  onClick={() => setShowPassword(!showPassword)}\n                  className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary-400 hover:text-white transition-colors\"\n                >\n                  {showPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\n                </button>\n              </div>\n            </div>\n\n            {/* Confirm Password */}\n            <div className=\"space-y-2\">\n              <label className=\"block text-sm font-medium text-secondary-300\">\n                Confirm Password\n              </label>\n              <div className=\"relative\">\n                <Lock className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                <input\n                  type={showConfirmPassword ? 'text' : 'password'}\n                  name=\"confirmPassword\"\n                  value={formData.confirmPassword}\n                  onChange={handleChange}\n                  className=\"w-full pl-10 pr-12 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 transition-all duration-300\"\n                  placeholder=\"Confirm new password\"\n                  required\n                />\n                <button\n                  type=\"button\"\n                  onClick={() => setShowConfirmPassword(!showConfirmPassword)}\n                  className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary-400 hover:text-white transition-colors\"\n                >\n                  {showConfirmPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\n                </button>\n              </div>\n            </div>\n\n            {/* Password Requirements */}\n            <div className=\"bg-secondary-800/30 rounded-lg p-4 border border-secondary-600\">\n              <h3 className=\"text-sm font-medium text-secondary-300 mb-2\">Password Requirements:</h3>\n              <ul className=\"text-xs text-secondary-400 space-y-1\">\n                <li>• At least 8 characters long</li>\n                <li>• Contains uppercase and lowercase letters</li>\n                <li>• Contains at least one number</li>\n                <li>• Contains at least one special character</li>\n              </ul>\n            </div>\n\n            {error && (\n              <div className=\"flex items-start space-x-3 p-3 bg-red-500/20 border border-red-500/50 rounded-lg\">\n                <AlertCircle className=\"w-5 h-5 text-red-400 mt-0.5 flex-shrink-0\" />\n                <p className=\"text-red-400 text-sm\">{error}</p>\n              </div>\n            )}\n\n            <button\n              onClick={handleSubmit}\n              disabled={loading}\n              className=\"w-full py-3 px-4 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              {loading ? (\n                <span className=\"loading-dots\">Updating Password</span>\n              ) : (\n                'Update Password'\n              )}\n            </button>\n          </div>\n\n          <div className=\"text-center mt-6\">\n            <button\n              onClick={() => window.location.href = '/login'}\n              className=\"inline-flex items-center text-secondary-400 hover:text-white transition-colors duration-300 bg-transparent border-none cursor-pointer\"\n            >\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              Back to Login\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default ResetPassword;","path":null,"size_bytes":14715,"size_tokens":null},"frontend/src/components/Common/ForgotPassword.jsx":{"content":"// components/ForgotPassword.js\nimport React, { useState } from 'react';\nimport { Link } from 'react-router-dom';\nimport { Mail, ArrowLeft, Building2, AlertCircle, CheckCircle, Clock } from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport axios from 'axios';\n\n// Create axios instance\nconst API = axios.create({\n  baseURL: '/api',\n  headers: {\n    'Content-Type': 'application/json'\n  }\n});\n\nconst ForgotPassword = () => {\n  const [email, setEmail] = useState('');\n  const [loading, setLoading] = useState(false);\n  const [sent, setSent] = useState(false);\n  const [error, setError] = useState('');\n  const [countdown, setCountdown] = useState(0);\n\n  // Countdown timer for resend functionality\n  React.useEffect(() => {\n    let timer;\n    if (countdown > 0) {\n      timer = setInterval(() => {\n        setCountdown(prev => prev - 1);\n      }, 1000);\n    }\n    return () => clearInterval(timer);\n  }, [countdown]);\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setLoading(true);\n    setError('');\n    \n    try {\n      const response = await API.post('/auth/forgot-password', { email });\n      \n      if (response.data.success) {\n        setSent(true);\n        setCountdown(60); // 60 seconds before allowing resend\n        toast.success(response.data.message);\n      }\n    } catch (error) {\n      const errorMessage = error.response?.data?.message || 'Failed to send reset link. Please try again.';\n      setError(errorMessage);\n      toast.error(errorMessage);\n      \n      // If rate limited, show countdown\n      if (error.response?.status === 429) {\n        const retryAfter = error.response?.data?.retryAfter || 900; // 15 minutes default\n        setCountdown(retryAfter);\n      }\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleResendEmail = async () => {\n    if (countdown > 0) return;\n    \n    setLoading(true);\n    setError('');\n    \n    try {\n      const response = await API.post('/auth/forgot-password', { email });\n      \n      if (response.data.success) {\n        setCountdown(60); // Reset countdown\n        toast.success('Reset link sent again!');\n      }\n    } catch (error) {\n      const errorMessage = error.response?.data?.message || 'Failed to resend link.';\n      setError(errorMessage);\n      toast.error(errorMessage);\n      \n      if (error.response?.status === 429) {\n        const retryAfter = error.response?.data?.retryAfter || 900;\n        setCountdown(retryAfter);\n      }\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const formatTime = (seconds) => {\n    const minutes = Math.floor(seconds / 60);\n    const remainingSeconds = seconds % 60;\n    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;\n  };\n\n  if (sent) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-secondary-900 via-secondary-800 to-secondary-900\">\n        {/* Background Effects */}\n        <div className=\"absolute inset-0 overflow-hidden\">\n          <div className=\"absolute -top-10 -left-10 w-72 h-72 bg-neon-pink opacity-10 rounded-full blur-3xl animate-pulse\"></div>\n          <div className=\"absolute -bottom-10 -right-10 w-72 h-72 bg-neon-purple opacity-10 rounded-full blur-3xl animate-pulse delay-1000\"></div>\n        </div>\n\n        <div className=\"w-full max-w-md relative\">\n          <div className=\"text-center mb-8\">\n            <div className=\"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-neon-pink to-neon-purple rounded-2xl mb-4 animate-glow\">\n              <Building2 className=\"w-8 h-8 text-white\" />\n            </div>\n            <h1 className=\"text-3xl font-bold neon-text mb-2\">CompanyName</h1>\n          </div>\n\n          <div className=\"glass-morphism neon-border p-8 rounded-2xl text-center\">\n            <div className=\"w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4\">\n              <CheckCircle className=\"w-8 h-8 text-green-400\" />\n            </div>\n            <h2 className=\"text-2xl font-bold text-white mb-2\">Check Your Email</h2>\n            <p className=\"text-secondary-400 mb-4\">\n              We've sent a password reset link to \n            </p>\n            <p className=\"text-neon-pink font-medium mb-6 break-all\">\n              {email}\n            </p>\n            \n            <div className=\"bg-secondary-800/30 rounded-lg p-4 mb-6 text-left\">\n              <h3 className=\"text-white font-medium mb-2 flex items-center\">\n                <Clock className=\"w-4 h-4 mr-2\" />\n                What's next?\n              </h3>\n              <ul className=\"text-secondary-400 text-sm space-y-1\">\n                <li>• Check your email inbox (and spam folder)</li>\n                <li>• Click the reset link in the email</li>\n                <li>• Create your new password</li>\n                <li>• <span className=\"text-yellow-400\">The link expires in 10 minutes</span></li>\n              </ul>\n            </div>\n\n            {error && (\n              <div className=\"mb-4 flex items-start space-x-3 p-3 bg-red-500/20 border border-red-500/50 rounded-lg\">\n                <AlertCircle className=\"w-5 h-5 text-red-400 mt-0.5 flex-shrink-0\" />\n                <p className=\"text-red-400 text-sm text-left\">{error}</p>\n              </div>\n            )}\n\n            <div className=\"space-y-4\">\n              <button\n                onClick={handleResendEmail}\n                disabled={loading || countdown > 0}\n                className=\"w-full py-2 px-4 bg-secondary-700/50 text-white font-medium rounded-lg hover:bg-secondary-700 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed\"\n              >\n                {loading ? (\n                  'Sending...'\n                ) : countdown > 0 ? (\n                  `Resend in ${formatTime(countdown)}`\n                ) : (\n                  'Resend Email'\n                )}\n              </button>\n              \n              <Link\n                to=\"/login\"\n                className=\"inline-flex items-center text-neon-pink hover:text-neon-purple transition-colors duration-300\"\n              >\n                <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                Back to Login\n              </Link>\n            </div>\n\n            {/* Troubleshooting section */}\n            <div className=\"mt-6 pt-6 border-t border-secondary-600\">\n              <h3 className=\"text-sm font-medium text-secondary-300 mb-2\">Didn't receive the email?</h3>\n              <ul className=\"text-xs text-secondary-400 space-y-1 text-left\">\n                <li>• Check your spam/junk folder</li>\n                <li>• Make sure you entered the correct email</li>\n                <li>• Wait a few minutes for email delivery</li>\n                <li>• Contact support if problems persist</li>\n              </ul>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-secondary-900 via-secondary-800 to-secondary-900\">\n      {/* Background Effects */}\n      <div className=\"absolute inset-0 overflow-hidden\">\n        <div className=\"absolute -top-10 -left-10 w-72 h-72 bg-neon-pink opacity-10 rounded-full blur-3xl animate-pulse\"></div>\n        <div className=\"absolute -bottom-10 -right-10 w-72 h-72 bg-neon-purple opacity-10 rounded-full blur-3xl animate-pulse delay-1000\"></div>\n      </div>\n\n      <div className=\"w-full max-w-md relative\">\n        {/* Header */}\n        <div className=\"text-center mb-8\">\n          <div className=\"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-neon-pink to-neon-purple rounded-2xl mb-4 animate-glow\">\n            <Building2 className=\"w-8 h-8 text-white\" />\n          </div>\n          <h1 className=\"text-3xl font-bold neon-text mb-2\">CompanyName</h1>\n        </div>\n\n        {/* Form */}\n        <div className=\"glass-morphism neon-border p-8 rounded-2xl\">\n          <div className=\"text-center mb-6\">\n            <h2 className=\"text-2xl font-bold text-white mb-2\">Forgot Password?</h2>\n            <p className=\"text-secondary-400\">Enter your email address and we'll send you a secure link to reset your password.</p>\n          </div>\n\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            <div className=\"space-y-2\">\n              <label className=\"block text-sm font-medium text-secondary-300\">\n                Email Address\n              </label>\n              <div className=\"relative\">\n                <Mail className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                <input\n                  type=\"email\"\n                  value={email}\n                  onChange={(e) => {\n                    setEmail(e.target.value);\n                    setError(''); // Clear error when user types\n                  }}\n                  className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 transition-all duration-300\"\n                  placeholder=\"Enter your registered email\"\n                  required\n                  disabled={loading}\n                />\n              </div>\n              <p className=\"text-xs text-secondary-500\">\n                Enter the email address associated with your account\n              </p>\n            </div>\n\n            {error && (\n              <div className=\"flex items-start space-x-3 p-3 bg-red-500/20 border border-red-500/50 rounded-lg\">\n                <AlertCircle className=\"w-5 h-5 text-red-400 mt-0.5 flex-shrink-0\" />\n                <div>\n                  <p className=\"text-red-400 text-sm\">{error}</p>\n                  {countdown > 0 && (\n                    <p className=\"text-red-300 text-xs mt-1\">\n                      Please wait {formatTime(countdown)} before trying again\n                    </p>\n                  )}\n                </div>\n              </div>\n            )}\n\n            <button\n              type=\"submit\"\n              disabled={loading || countdown > 0}\n              className=\"w-full py-3 px-4 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              {loading ? (\n                <span className=\"flex items-center justify-center\">\n                  <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2\"></div>\n                  Sending Reset Link\n                </span>\n              ) : countdown > 0 ? (\n                `Wait ${formatTime(countdown)}`\n              ) : (\n                'Send Reset Link'\n              )}\n            </button>\n          </form>\n\n          <div className=\"text-center mt-6\">\n            <Link\n              to=\"/login\"\n              className=\"inline-flex items-center text-secondary-400 hover:text-white transition-colors duration-300\"\n            >\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              Back to Login\n            </Link>\n          </div>\n\n          {/* Security notice */}\n          <div className=\"mt-6 p-4 bg-secondary-800/30 rounded-lg border border-secondary-600\">\n            <h3 className=\"text-sm font-medium text-secondary-300 mb-2\">🔒 Security Notice</h3>\n            <ul className=\"text-xs text-secondary-400 space-y-1\">\n              <li>• Reset links are valid for 10 minutes only</li>\n              <li>• If you don't have an account, no email will be sent</li>\n              <li>• Check your spam folder if you don't see the email</li>\n              <li>• Contact support if you continue having issues</li>\n            </ul>\n          </div>\n\n          {/* Demo info - Remove in production */}\n          {process.env.NODE_ENV === 'development' && (\n            <div className=\"mt-4 p-3 bg-blue-500/20 border border-blue-500/50 rounded-lg\">\n              <p className=\"text-blue-400 text-xs\">\n                <strong>Development Mode:</strong> Check console for email preview links\n              </p>\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default ForgotPassword;","path":null,"size_bytes":12266,"size_tokens":null},"frontend/src/pages/Admin/AdminLeaveManagement.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport axios from 'axios';\nimport AdminLayout from '../../components/Admin/layout/AdminLayout';\nimport { \n  Calendar, \n  Clock, \n  CheckCircle, \n  XCircle, \n  Eye, \n  Filter,\n  Search,\n  Download,\n  User,\n  AlertCircle,\n  FileText,\n  TrendingUp,\n  Users,\n  Loader\n} from 'lucide-react';\nimport toast from 'react-hot-toast';\n\nconst AdminLeaveManagement = () => {\n  const [leaves, setLeaves] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [stats, setStats] = useState({\n    total: 0,\n    pending: 0,\n    approved: 0,\n    rejected: 0\n  });\n\n  const [searchTerm, setSearchTerm] = useState('');\n  const [statusFilter, setStatusFilter] = useState('');\n  const [leaveTypeFilter, setLeaveTypeFilter] = useState('');\n  const [selectedLeave, setSelectedLeave] = useState(null);\n  const [showModal, setShowModal] = useState(false);\n  const [actionLoading, setActionLoading] = useState(false);\n\n  // Fetch leaves from backend\n  const fetchLeaves = async () => {\n    try {\n      setLoading(true);\n      const token = localStorage.getItem('token');\n      const response = await axios.get('/api/leaves', {\n        headers: { Authorization: `Bearer ${token}` },\n        params: {\n          search: searchTerm,\n          status: statusFilter,\n          leaveType: leaveTypeFilter\n        }\n      });\n      \n      if (response.data.success) {\n        setLeaves(response.data.leaves || []);\n      }\n    } catch (error) {\n      console.error('Error fetching leaves:', error);\n      toast.error('Failed to fetch leave applications');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // Fetch leave statistics\n  const fetchStats = async () => {\n    try {\n      const token = localStorage.getItem('token');\n      const response = await axios.get('/api/leaves/stats', {\n        headers: { Authorization: `Bearer ${token}` }\n      });\n      \n      if (response.data.success) {\n        setStats(response.data.stats);\n      }\n    } catch (error) {\n      console.error('Error fetching leave stats:', error);\n    }\n  };\n\n  useEffect(() => {\n    fetchLeaves();\n    fetchStats();\n  }, [searchTerm, statusFilter, leaveTypeFilter]);\n\n  const handleApprove = async (leaveId, comments = '') => {\n    try {\n      setActionLoading(true);\n      const token = localStorage.getItem('token');\n      \n      await axios.put(`/api/leaves/${leaveId}/approve`, \n        { comments },\n        { headers: { Authorization: `Bearer ${token}` } }\n      );\n      \n      toast.success('Leave application approved!');\n      fetchLeaves();\n      fetchStats();\n      setShowModal(false);\n    } catch (error) {\n      console.error('Error approving leave:', error);\n      toast.error(error.response?.data?.message || 'Failed to approve leave');\n    } finally {\n      setActionLoading(false);\n    }\n  };\n\n  const handleReject = async (leaveId, comments = '') => {\n    try {\n      setActionLoading(true);\n      const token = localStorage.getItem('token');\n      \n      await axios.put(`/api/leaves/${leaveId}/reject`, \n        { comments },\n        { headers: { Authorization: `Bearer ${token}` } }\n      );\n      \n      toast.success('Leave application rejected!');\n      fetchLeaves();\n      fetchStats();\n      setShowModal(false);\n    } catch (error) {\n      console.error('Error rejecting leave:', error);\n      toast.error(error.response?.data?.message || 'Failed to reject leave');\n    } finally {\n      setActionLoading(false);\n    }\n  };\n\n  const getStatusColor = (status) => {\n    switch (status.toLowerCase()) {\n      case 'pending': return 'text-yellow-400 bg-yellow-400/20';\n      case 'approved': return 'text-green-400 bg-green-400/20';\n      case 'rejected': return 'text-red-400 bg-red-400/20';\n      case 'cancelled': return 'text-gray-400 bg-gray-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  const getLeaveTypeColor = (type) => {\n    switch (type.toLowerCase()) {\n      case 'casual': return 'bg-blue-500/20 text-blue-400';\n      case 'sick': return 'bg-red-500/20 text-red-400';\n      case 'earned': return 'bg-green-500/20 text-green-400';\n      case 'emergency': return 'bg-orange-500/20 text-orange-400';\n      default: return 'bg-purple-500/20 text-purple-400';\n    }\n  };\n\n  // Update the LeaveDetailModal function in your AdminLeaveManagement.jsx\n// Replace the existing LeaveDetailModal with this fixed version\n\nconst LeaveDetailModal = () => {\n  const [comments, setComments] = useState('');\n\n  return (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"glass-morphism neon-border rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h2 className=\"text-2xl font-bold text-white\">Leave Application Details</h2>\n          <button \n            onClick={() => setShowModal(false)}\n            className=\"text-secondary-400 hover:text-white\"\n          >\n            <XCircle className=\"w-6 h-6\" />\n          </button>\n        </div>\n        \n        {selectedLeave && (\n          <div className=\"space-y-6\">\n            {/* Employee Info */}\n            <div className=\"flex items-center space-x-4 p-4 bg-secondary-800/30 rounded-lg\">\n              <div className=\"w-12 h-12 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                <User className=\"w-6 h-6 text-white\" />\n              </div>\n              <div>\n                <h3 className=\"text-lg font-bold text-white\">\n                  {selectedLeave.employee?.fullName || \n                   selectedLeave.employee?.personalInfo?.firstName + ' ' + selectedLeave.employee?.personalInfo?.lastName ||\n                   selectedLeave.employee?.user?.name}\n                </h3>\n                <p className=\"text-neon-pink\">{selectedLeave.employee?.employeeId || selectedLeave.employee?.user?.employeeId}</p>\n              </div>\n            </div>\n\n            {/* Leave Details */}\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div className=\"space-y-3\">\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Leave Type</label>\n                  <p className=\"text-white font-medium\">{selectedLeave.leaveType}</p>\n                </div>\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Start Date</label>\n                  <p className=\"text-white font-medium\">{new Date(selectedLeave.startDate).toLocaleDateString()}</p>\n                </div>\n                <div>\n                  <label className=\"text-sm text-secondary-400\">End Date</label>\n                  <p className=\"text-white font-medium\">{new Date(selectedLeave.endDate).toLocaleDateString()}</p>\n                </div>\n              </div>\n              <div className=\"space-y-3\">\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Duration</label>\n                  <p className=\"text-white font-medium\">\n                    {selectedLeave.isHalfDay ? `0.5 day (${selectedLeave.halfDaySession})` : `${selectedLeave.totalDays} days`}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Applied Date</label>\n                  <p className=\"text-white font-medium\">{new Date(selectedLeave.appliedDate).toLocaleDateString()}</p>\n                </div>\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Status</label>\n                  <span className={`inline-block px-3 py-1 text-xs rounded-full ${getStatusColor(selectedLeave.status)}`}>\n                    {selectedLeave.status}\n                  </span>\n                </div>\n              </div>\n            </div>\n\n            {/* Reason */}\n            <div>\n              <label className=\"text-sm text-secondary-400\">Reason</label>\n              <p className=\"text-white bg-secondary-800/30 p-3 rounded-lg mt-1\">{selectedLeave.reason}</p>\n            </div>\n\n            {/* Previous Comments - Fixed field name */}\n            {selectedLeave.approverComments && (\n              <div>\n                <label className=\"text-sm text-secondary-400\">Previous Comments</label>\n                <p className=\"text-white bg-secondary-800/30 p-3 rounded-lg mt-1\">{selectedLeave.approverComments}</p>\n              </div>\n            )}\n\n            {/* Action Buttons */}\n            {selectedLeave.status.toLowerCase() === 'pending' && (\n              <div className=\"space-y-4\">\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Comments (Optional)</label>\n                  <textarea\n                    value={comments}\n                    onChange={(e) => setComments(e.target.value)}\n                    rows=\"3\"\n                    className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 mt-1\"\n                    placeholder=\"Add comments for the employee...\"\n                    maxLength=\"300\"\n                  />\n                </div>\n                \n                <div className=\"flex justify-end space-x-4\">\n                  <button\n                    onClick={() => handleReject(selectedLeave._id, comments)}\n                    disabled={actionLoading}\n                    className=\"px-6 py-3 border border-red-500 text-red-400 rounded-lg hover:bg-red-500/10 transition-colors disabled:opacity-50 flex items-center\"\n                  >\n                    {actionLoading ? <Loader className=\"w-4 h-4 mr-2 animate-spin\" /> : <XCircle className=\"w-4 h-4 mr-2\" />}\n                    Reject\n                  </button>\n                  <button\n                    onClick={() => handleApprove(selectedLeave._id, comments)}\n                    disabled={actionLoading}\n                    className=\"px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-lg hover-glow transition-all duration-300 disabled:opacity-50 flex items-center\"\n                  >\n                    {actionLoading ? <Loader className=\"w-4 h-4 mr-2 animate-spin\" /> : <CheckCircle className=\"w-4 h-4 mr-2\" />}\n                    Approve\n                  </button>\n                </div>\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n\n  return (\n    <AdminLayout>\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-white\">Leave Management</h1>\n            <p className=\"text-secondary-400\">Manage employee leave requests</p>\n          </div>\n          <button className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 flex items-center\">\n            <Download className=\"w-4 h-4 mr-2\" />\n            Export Report\n          </button>\n        </div>\n\n        {/* Stats Cards */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-2xl font-bold text-white\">{stats.total}</h3>\n                <p className=\"text-secondary-400\">Total Applications</p>\n              </div>\n              <div className=\"w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center\">\n                <FileText className=\"w-6 h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-2xl font-bold text-yellow-400\">{stats.pending}</h3>\n                <p className=\"text-secondary-400\">Pending</p>\n              </div>\n              <div className=\"w-12 h-12 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center\">\n                <Clock className=\"w-6 h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-2xl font-bold text-green-400\">{stats.approved}</h3>\n                <p className=\"text-secondary-400\">Approved</p>\n              </div>\n              <div className=\"w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center\">\n                <CheckCircle className=\"w-6 h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-2xl font-bold text-red-400\">{stats.rejected}</h3>\n                <p className=\"text-secondary-400\">Rejected</p>\n              </div>\n              <div className=\"w-12 h-12 bg-gradient-to-r from-red-500 to-red-600 rounded-lg flex items-center justify-center\">\n                <XCircle className=\"w-6 h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Filters */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n              <input\n                type=\"text\"\n                placeholder=\"Search employees...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n              />\n            </div>\n\n            <div className=\"relative\">\n              <Filter className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n              <select\n                value={statusFilter}\n                onChange={(e) => setStatusFilter(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n              >\n                <option value=\"\">All Status</option>\n                <option value=\"Pending\">Pending</option>\n                <option value=\"Approved\">Approved</option>\n                <option value=\"Rejected\">Rejected</option>\n                <option value=\"Cancelled\">Cancelled</option>\n              </select>\n            </div>\n\n            <div className=\"relative\">\n              <Calendar className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n              <select\n                value={leaveTypeFilter}\n                onChange={(e) => setLeaveTypeFilter(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n              >\n                <option value=\"\">All Types</option>\n                <option value=\"Casual\">Casual</option>\n                <option value=\"Sick\">Sick</option>\n                <option value=\"Earned\">Earned</option>\n                <option value=\"Emergency\">Emergency</option>\n                <option value=\"Personal\">Personal</option>\n              </select>\n            </div>\n\n            <button\n              onClick={() => {\n                setSearchTerm('');\n                setStatusFilter('');\n                setLeaveTypeFilter('');\n              }}\n              className=\"px-4 py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700/50 transition-colors\"\n            >\n              Clear Filters\n            </button>\n          </div>\n        </div>\n\n        {/* Leave Applications Table/Cards */}\n        <div className=\"glass-morphism neon-border rounded-2xl overflow-hidden\">\n          {loading ? (\n            <div className=\"p-12 text-center\">\n              <Loader className=\"w-8 h-8 text-neon-pink mx-auto mb-4 animate-spin\" />\n              <p className=\"text-secondary-400\">Loading leave applications...</p>\n            </div>\n          ) : (\n            <>\n              {/* Mobile Cards */}\n              <div className=\"md:hidden grid gap-4 p-4\">\n                {leaves.map((leave) => (\n                  <div key={leave._id} className=\"bg-secondary-800/30 border border-secondary-700 rounded-xl p-4 hover:bg-secondary-800/50 transition-colors\">\n                    <div className=\"flex items-start justify-between mb-3\">\n                      <div className=\"flex items-center space-x-3\">\n                        <div className=\"w-10 h-10 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center flex-shrink-0\">\n                          <User className=\"w-5 h-5 text-white\" />\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"text-white font-medium text-sm truncate\">\n                            {leave.employee?.fullName ||\n                             (leave.employee?.personalInfo?.firstName + ' ' + leave.employee?.personalInfo?.lastName) ||\n                             leave.employee?.user?.name}\n                          </p>\n                          <p className=\"text-secondary-400 text-xs flex items-center\">\n                            <span className=\"truncate\">{leave.employee?.employeeId || leave.employee?.user?.employeeId}</span>\n                          </p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-center space-x-2 ml-2\">\n                        <button\n                          onClick={() => {\n                            setSelectedLeave(leave);\n                            setShowModal(true);\n                          }}\n                          className=\"p-1.5 text-secondary-400 hover:text-blue-400 hover:bg-blue-400/10 rounded-lg transition-colors\"\n                          title=\"View Details\"\n                        >\n                          <Eye className=\"w-4 h-4\" />\n                        </button>\n                        {leave.status === 'Pending' && (\n                          <>\n                            <button\n                              onClick={() => handleApprove(leave._id)}\n                              className=\"p-1.5 text-secondary-400 hover:text-green-400 hover:bg-green-400/10 rounded-lg transition-colors\"\n                              title=\"Quick Approve\"\n                            >\n                              <CheckCircle className=\"w-4 h-4\" />\n                            </button>\n                            <button\n                              onClick={() => handleReject(leave._id, 'Application rejected')}\n                              className=\"p-1.5 text-secondary-400 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-colors\"\n                              title=\"Quick Reject\"\n                            >\n                              <XCircle className=\"w-4 h-4\" />\n                            </button>\n                          </>\n                        )}\n                      </div>\n                    </div>\n                    <div className=\"space-y-2\">\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-secondary-400 text-xs\">Leave Type</span>\n                        <span className={`text-xs px-2 py-1 rounded-full ${getLeaveTypeColor(leave.leaveType)}`}>\n                          {leave.leaveType}\n                        </span>\n                      </div>\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-secondary-400 text-xs\">Duration</span>\n                        <span className=\"text-white text-sm\">\n                          {new Date(leave.startDate).toLocaleDateString()} - {new Date(leave.endDate).toLocaleDateString()}\n                        </span>\n                      </div>\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-secondary-400 text-xs\">Days</span>\n                        <span className=\"text-white text-sm\">{leave.totalDays} days</span>\n                      </div>\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-secondary-400 text-xs\">Applied Date</span>\n                        <span className=\"text-secondary-400 text-sm\">\n                          {new Date(leave.appliedDate).toLocaleDateString()}\n                        </span>\n                      </div>\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-secondary-400 text-xs\">Status</span>\n                        <span className={`text-xs px-2 py-1 rounded-full ${getStatusColor(leave.status)}`}>\n                          {leave.status}\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n\n              {/* Desktop Table */}\n              <div className=\"hidden md:block\">\n                <div className=\"overflow-x-auto\">\n                  <table className=\"w-full\">\n                    <thead className=\"border-b border-secondary-700\">\n                      <tr>\n                        <th className=\"text-left p-6 text-secondary-300 font-medium\">Employee</th>\n                        <th className=\"text-left p-6 text-secondary-300 font-medium\">Leave Type</th>\n                        <th className=\"text-left p-6 text-secondary-300 font-medium\">Duration</th>\n                        <th className=\"text-left p-6 text-secondary-300 font-medium\">Applied Date</th>\n                        <th className=\"text-left p-6 text-secondary-300 font-medium\">Status</th>\n                        <th className=\"text-left p-6 text-secondary-300 font-medium\">Actions</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {leaves.map((leave) => (\n                        <tr key={leave._id} className=\"border-b border-secondary-800 hover:bg-secondary-800/30 transition-colors\">\n                          <td className=\"p-6\">\n                            <div className=\"flex items-center space-x-3\">\n                              <div className=\"w-10 h-10 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                                <User className=\"w-5 h-5 text-white\" />\n                              </div>\n                              <div>\n                                <p className=\"text-white font-medium\">\n                                  {leave.employee?.fullName ||\n                                   (leave.employee?.personalInfo?.firstName + ' ' + leave.employee?.personalInfo?.lastName) ||\n                                   leave.employee?.user?.name}\n                                </p>\n                                <p className=\"text-secondary-400 text-sm\">{leave.employee?.employeeId || leave.employee?.user?.employeeId}</p>\n                              </div>\n                            </div>\n                          </td>\n                          <td className=\"p-6\">\n                            <span className={`px-3 py-1 text-xs rounded-full ${getLeaveTypeColor(leave.leaveType)}`}>\n                              {leave.leaveType}\n                            </span>\n                          </td>\n                          <td className=\"p-6 text-white\">\n                            <div>\n                              <p>{new Date(leave.startDate).toLocaleDateString()} - {new Date(leave.endDate).toLocaleDateString()}</p>\n                              <p className=\"text-sm text-secondary-400\">{leave.totalDays} days</p>\n                            </div>\n                          </td>\n                          <td className=\"p-6 text-secondary-400\">\n                            {new Date(leave.appliedDate).toLocaleDateString()}\n                          </td>\n                          <td className=\"p-6\">\n                            <span className={`px-3 py-1 text-xs rounded-full ${getStatusColor(leave.status)}`}>\n                              {leave.status}\n                            </span>\n                          </td>\n                          <td className=\"p-6\">\n                            <div className=\"flex items-center space-x-2\">\n                              <button\n                                onClick={() => {\n                                  setSelectedLeave(leave);\n                                  setShowModal(true);\n                                }}\n                                className=\"p-2 text-secondary-400 hover:text-blue-400 hover:bg-blue-400/10 rounded-lg transition-colors\"\n                                title=\"View Details\"\n                              >\n                                <Eye className=\"w-4 h-4\" />\n                              </button>\n                              {leave.status === 'Pending' && (\n                                <>\n                                  <button\n                                    onClick={() => handleApprove(leave._id)}\n                                    className=\"p-2 text-secondary-400 hover:text-green-400 hover:bg-green-400/10 rounded-lg transition-colors\"\n                                    title=\"Quick Approve\"\n                                  >\n                                    <CheckCircle className=\"w-4 h-4\" />\n                                  </button>\n                                  <button\n                                    onClick={() => handleReject(leave._id, 'Application rejected')}\n                                    className=\"p-2 text-secondary-400 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-colors\"\n                                    title=\"Quick Reject\"\n                                  >\n                                    <XCircle className=\"w-4 h-4\" />\n                                  </button>\n                                </>\n                              )}\n                            </div>\n                          </td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n              </div>\n            </>\n          )}\n\n          {!loading && leaves.length === 0 && (\n            <div className=\"p-12 text-center\">\n              <Calendar className=\"w-12 h-12 text-secondary-600 mx-auto mb-4\" />\n              <h3 className=\"text-lg font-medium text-secondary-400 mb-2\">No leave applications found</h3>\n              <p className=\"text-secondary-500\">\n                {searchTerm || statusFilter || leaveTypeFilter\n                  ? 'Try adjusting your search filters'\n                  : 'No leave applications have been submitted yet'}\n              </p>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Modal */}\n      {showModal && <LeaveDetailModal />}\n    </AdminLayout>\n  );\n};\nexport default AdminLeaveManagement;","path":null,"size_bytes":27896,"size_tokens":null},"backend/routes/notificationRoutes.js":{"content":"import express from 'express';\nimport {\n  getUserNotifications,\n  getUnreadCount,\n  markAsRead,\n  markAllAsRead,\n  deleteNotification,\n  createNotification,\n  getNotificationStats,\n  notifyAdmins,\n  notifyUsers\n} from '../controllers/notificationController.js';\nimport { protect } from '../middleware/auth.js';\n\nconst router = express.Router();\n\n// All routes require authentication\nrouter.use(protect);\n\n// User notification routes\nrouter.get('/', getUserNotifications);\nrouter.get('/unread-count', getUnreadCount);\nrouter.get('/stats', getNotificationStats);\nrouter.put('/:id/read', markAsRead);\nrouter.put('/read-all', markAllAsRead);\nrouter.delete('/:id', deleteNotification);\n\n// Admin/Employee notification creation routes\nrouter.post('/', createNotification);\nrouter.post('/notify-admins', notifyAdmins);\nrouter.post('/notify-users', notifyUsers);\n\nexport default router;\n","path":null,"size_bytes":879,"size_tokens":null},"frontend/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\nbody {\n  margin: 0;\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',\n    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',\n    sans-serif;\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);\n  min-height: 100vh;\n}\n\n* {\n  box-sizing: border-box;\n}\n\n/* Custom scrollbar */\n::-webkit-scrollbar {\n  width: 6px;\n}\n\n::-webkit-scrollbar-track {\n  background: #1e293b;\n}\n\n::-webkit-scrollbar-thumb {\n  background: linear-gradient(135deg, #ff0080, #8000ff);\n  border-radius: 3px;\n}\n\n::-webkit-scrollbar-thumb:hover {\n  background: linear-gradient(135deg, #8000ff, #ff0080);\n}\n\n/* Neon glow effects */\n.neon-border {\n  border: 2px solid transparent;\n  background: linear-gradient(135deg, #1e293b, #334155) padding-box,\n              linear-gradient(135deg, #ff0080, #8000ff) border-box;\n  border-radius: 12px;\n}\n\n.neon-text {\n  background: linear-gradient(135deg, #ff0080, #8000ff);\n  -webkit-background-clip: text;\n  -webkit-text-fill-color: transparent;\n  background-clip: text;\n}\n\n.glass-morphism {\n  background: rgba(30, 41, 59, 0.95);\n  backdrop-filter: blur(20px);\n  -webkit-backdrop-filter: blur(20px);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);\n}\n\n.hover-glow:hover {\n  box-shadow: 0 0 20px rgba(255, 0, 128, 0.3), 0 0 40px rgba(128, 0, 255, 0.2);\n  transition: all 0.3s ease;\n}\n\n/* Modal backdrop with enhanced blur */\n.modal-backdrop {\n  background: rgba(0, 0, 0, 0.7);\n  backdrop-filter: blur(12px);\n  -webkit-backdrop-filter: blur(12px);\n}\n\n/* Prevent background scroll when modal is open */\nbody.modal-open {\n  overflow: hidden;\n}\n\n/* Better focus styles for accessibility */\n*:focus-visible {\n  outline: 2px solid #ff0080;\n  outline-offset: 2px;\n}\n\n/* Smooth transitions for all interactive elements */\nbutton, a, input, select, textarea {\n  transition: all 0.2s ease-in-out;\n}\n\n/* Improved text contrast for better readability */\n.text-readable {\n  color: #e2e8f0; /* Lighter than secondary-400 for better contrast */\n}\n\n.text-muted {\n  color: #94a3b8; /* secondary-400 - use sparingly */\n}\n\n.text-dimmed {\n  color: #cbd5e1; /* secondary-300 - better than 400 for readability */\n}\n\n/* Better input styles */\ninput:focus, textarea:focus, select:focus {\n  outline: none;\n  border-color: #ff0080;\n  ring: 2px;\n  ring-color: rgba(255, 0, 128, 0.2);\n}\n\n/* Improved button states */\nbutton:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\nbutton:not(:disabled):hover {\n  transform: translateY(-1px);\n}\n\nbutton:not(:disabled):active {\n  transform: translateY(0);\n}\n\n/* Responsive utilities */\n@media (max-width: 640px) {\n  /* Smaller modals on mobile */\n  .glass-morphism {\n    max-width: 95vw;\n  }\n\n  /* Better touch targets */\n  button, a {\n    min-height: 44px;\n    min-width: 44px;\n  }\n\n  /* Reduce padding on mobile */\n  .modal-content {\n    padding: 1rem;\n  }\n\n  /* Stack elements vertically on mobile */\n  .responsive-stack {\n    flex-direction: column;\n  }\n}\n\n/* Improved scrollbar styling */\n::-webkit-scrollbar {\n  width: 8px;\n  height: 8px;\n}\n\n::-webkit-scrollbar-track {\n  background: rgba(30, 41, 59, 0.5);\n  border-radius: 4px;\n}\n\n::-webkit-scrollbar-thumb {\n  background: rgba(255, 0, 128, 0.5);\n  border-radius: 4px;\n}\n\n::-webkit-scrollbar-thumb:hover {\n  background: rgba(255, 0, 128, 0.7);\n}\n\n/* Better table responsiveness */\n@media (max-width: 768px) {\n  table {\n    font-size: 0.875rem;\n  }\n\n  th, td {\n    padding: 0.5rem;\n  }\n}\n\n/* Form improvements */\n.form-input {\n  background: rgba(30, 41, 59, 0.5);\n  border: 1px solid rgba(148, 163, 184, 0.3);\n  color: #e2e8f0;\n  padding: 0.75rem 1rem;\n  border-radius: 0.5rem;\n  transition: all 0.2s ease-in-out;\n}\n\n.form-input:focus {\n  background: rgba(30, 41, 59, 0.7);\n  border-color: #ff0080;\n  box-shadow: 0 0 0 3px rgba(255, 0, 128, 0.1);\n}\n\n.form-input::placeholder {\n  color: #94a3b8;\n}\n\n.form-input:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n  background: rgba(30, 41, 59, 0.3);\n}\n\n.form-label {\n  color: #cbd5e1;\n  font-weight: 500;\n  margin-bottom: 0.5rem;\n  display: block;\n}\n\n.form-error {\n  color: #f87171;\n  font-size: 0.875rem;\n  margin-top: 0.25rem;\n}\n\n.form-success {\n  color: #4ade80;\n  font-size: 0.875rem;\n  margin-top: 0.25rem;\n}\n\n/* Better validation states */\n.form-input.error {\n  border-color: #f87171;\n}\n\n.form-input.success {\n  border-color: #4ade80;\n}\n\n/* Loading states */\n.loading {\n  opacity: 0.6;\n  pointer-events: none;\n  position: relative;\n}\n\n.loading::after {\n  content: '';\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  width: 20px;\n  height: 20px;\n  margin: -10px 0 0 -10px;\n  border: 2px solid #ff0080;\n  border-top-color: transparent;\n  border-radius: 50%;\n  animation: spin 0.6s linear infinite;\n}\n\n@keyframes spin {\n  to { transform: rotate(360deg); }\n}\n\n/* Navigation improvements */\n.nav-link {\n  position: relative;\n  transition: all 0.3s ease;\n}\n\n.nav-link::after {\n  content: '';\n  position: absolute;\n  bottom: -2px;\n  left: 0;\n  width: 0;\n  height: 2px;\n  background: linear-gradient(90deg, #ff0080, #8000ff);\n  transition: width 0.3s ease;\n}\n\n.nav-link:hover::after,\n.nav-link.active::after {\n  width: 100%;\n}\n\n/* Better spacing utilities */\n.section-spacing {\n  padding: 2rem 1rem;\n}\n\n@media (min-width: 640px) {\n  .section-spacing {\n    padding: 3rem 1.5rem;\n  }\n}\n\n@media (min-width: 1024px) {\n  .section-spacing {\n    padding: 4rem 2rem;\n  }\n}\n\n/* Card spacing */\n.card-spacing {\n  padding: 1rem;\n}\n\n@media (min-width: 640px) {\n  .card-spacing {\n    padding: 1.5rem;\n  }\n}\n\n@media (min-width: 1024px) {\n  .card-spacing {\n    padding: 2rem;\n  }\n}\n\n/* Consistent gaps */\n.gap-responsive {\n  gap: 0.75rem;\n}\n\n@media (min-width: 640px) {\n  .gap-responsive {\n    gap: 1rem;\n  }\n}\n\n@media (min-width: 1024px) {\n  .gap-responsive {\n    gap: 1.5rem;\n  }\n}\n\n/* Better hover effects */\n.hover-lift {\n  transition: transform 0.2s ease, box-shadow 0.2s ease;\n}\n\n.hover-lift:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 10px 30px rgba(255, 0, 128, 0.2);\n}\n\n/* Skeleton loading */\n.skeleton {\n  background: linear-gradient(\n    90deg,\n    rgba(30, 41, 59, 0.5) 25%,\n    rgba(51, 65, 85, 0.5) 50%,\n    rgba(30, 41, 59, 0.5) 75%\n  );\n  background-size: 200% 100%;\n  animation: skeleton-loading 1.5s ease-in-out infinite;\n}\n\n@keyframes skeleton-loading {\n  0% {\n    background-position: 200% 0;\n  }\n  100% {\n    background-position: -200% 0;\n  }\n}\n\n/* Loading animation */\n.loading-dots::after {\n  content: '';\n  animation: loading 1.5s infinite;\n}\n\n@keyframes loading {\n  0%, 20% { content: ''; }\n  40% { content: '.'; }\n  60% { content: '..'; }\n  80%, 100% { content: '...'; }\n}\n\n/* React Calendar Dark Theme */\n.react-calendar {\n  background: rgba(30, 41, 59, 0.8);\n  border: 1px solid rgba(255, 255, 255, 0.1);\n  border-radius: 8px;\n  color: white;\n}\n\n.react-calendar__navigation {\n  background: rgba(51, 65, 85, 0.5);\n  border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n.react-calendar__navigation button {\n  color: white;\n  background: transparent;\n  border: none;\n}\n\n.react-calendar__navigation button:enabled:hover,\n.react-calendar__navigation button:enabled:focus {\n  background: rgba(255, 255, 255, 0.1);\n}\n\n.react-calendar__navigation button:disabled {\n  background: rgba(51, 65, 85, 0.5);\n  color: rgba(255, 255, 255, 0.3);\n}\n\n.react-calendar__month-view__weekdays__weekday {\n  color: rgba(255, 255, 255, 0.7);\n  font-weight: 600;\n}\n\n.react-calendar__tile {\n  color: white;\n  background: transparent;\n  border: none;\n  padding: 0.75em 0.5em;\n}\n\n.react-calendar__tile:enabled:hover,\n.react-calendar__tile:enabled:focus {\n  background: rgba(255, 255, 255, 0.1);\n  border-radius: 4px;\n}\n\n.react-calendar__tile--now {\n  background: rgba(255, 255, 255, 0.1);\n  color: #ff0080;\n  font-weight: bold;\n}\n\n.react-calendar__tile--now:enabled:hover,\n.react-calendar__tile--now:enabled:focus {\n  background: rgba(255, 0, 128, 0.2);\n}\n\n.react-calendar__tile--active {\n  background: linear-gradient(135deg, #ff0080, #8000ff);\n  color: white;\n}\n\n.react-calendar__tile--active:enabled:hover,\n.react-calendar__tile--active:enabled:focus {\n  background: linear-gradient(135deg, #8000ff, #ff0080);\n}\n\n.react-calendar__month-view__days__day--neighboringMonth {\n  color: rgba(255, 255, 255, 0.3);\n}\n\n.react-calendar__month-view__days__day--weekend {\n  color: rgba(255, 100, 100, 0.8);\n}\n","path":null,"size_bytes":8458,"size_tokens":null},"frontend/src/pages/Admin/AdminSalesDashboard.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport AdminLayout from '../../components/Admin/layout/AdminLayout';\nimport {\n  TrendingUp, DollarSign, Target, Award, Users, Calendar,\n  Search, Filter, Download, Edit3, Trash2, Eye, User,\n  RefreshCw, AlertCircle, CheckCircle, XCircle, Phone,\n  Building2, UserCheck, Clock, ChevronDown\n} from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport { leadAPI } from '../../utils/api';\n\nconst AdminSalesDashboard = () => {\n  // State\n  const [leads, setLeads] = useState([]);\n  const [summary, setSummary] = useState(null);\n  const [funnelData, setFunnelData] = useState([]);\n  const [employees, setEmployees] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [filters, setFilters] = useState({\n    startDate: new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().slice(0, 10),\n    endDate: new Date().toISOString().slice(0, 10),\n    department: '',\n    status: 'all',\n    search: ''\n  });\n  const [showFilters, setShowFilters] = useState(false);\n  const [showReassignModal, setShowReassignModal] = useState(false);\n  const [selectedLead, setSelectedLead] = useState(null);\n  const [reassignTo, setReassignTo] = useState('');\n\n  // Fetch data\n  const fetchData = async () => {\n    try {\n      setLoading(true);\n      const [leadsRes, summaryRes] = await Promise.all([\n        leadAPI.getLeads({ ...filters, includeAll: true }),\n        leadAPI.getLeadStats({ ...filters })\n      ]);\n\n      const fetchedLeads = leadsRes.data.success ? leadsRes.data.data.leads || [] : [];\n      if (leadsRes.data.success) setLeads(fetchedLeads);\n      if (summaryRes.data.success) setSummary(summaryRes.data.data);\n      // Mock funnel data and employees for now\n      setFunnelData([\n        { name: 'New', count: fetchedLeads.filter(l => l.status === 'New').length },\n        { name: 'Contacted', count: fetchedLeads.filter(l => l.status === 'Contacted').length },\n        { name: 'Qualified', count: fetchedLeads.filter(l => l.status === 'Qualified').length },\n        { name: 'Proposal', count: fetchedLeads.filter(l => l.status === 'Proposal').length },\n        { name: 'Negotiation', count: fetchedLeads.filter(l => l.status === 'Negotiation').length },\n        { name: 'Won', count: fetchedLeads.filter(l => l.status === 'Won').length }\n      ]);\n      setEmployees([]); // Empty for now\n    } catch (err) {\n      console.error('Failed to load sales data:', err);\n      toast.error('Failed to load sales dashboard');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchData();\n  }, [filters]);\n\n  // Helpers\n  const getStatusColor = (status) => {\n    switch (status) {\n      case 'Won': return 'text-green-400 bg-green-400/20';\n      case 'Lost': return 'text-red-400 bg-red-400/20';\n      case 'Negotiation': return 'text-purple-400 bg-purple-400/20';\n      case 'Proposal': return 'text-orange-400 bg-orange-400/20';\n      case 'Qualified': return 'text-blue-400 bg-blue-400/20';\n      case 'Contacted': return 'text-yellow-400 bg-yellow-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  const getPriorityColor = (priority) => {\n    switch (priority) {\n      case 'High': return 'text-red-400 bg-red-400/20';\n      case 'Medium': return 'text-yellow-400 bg-yellow-400/20';\n      case 'Low': return 'text-green-400 bg-green-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  const handleFilterChange = (key, value) => {\n    setFilters(prev => ({ ...prev, [key]: value }));\n  };\n\n  const handleReassign = async () => {\n    try {\n      await leadAPI.reassignLead(selectedLead._id, { assignedTo: reassignTo });\n      toast.success('Lead reassigned successfully!');\n      setShowReassignModal(false);\n      fetchData();\n    } catch (err) {\n      toast.error('Failed to reassign lead');\n    }\n  };\n\n  const handleDelete = async (id) => {\n    if (!window.confirm('Delete this lead permanently?')) return;\n    try {\n      await leadAPI.deleteLead(id);\n      toast.success('Lead deleted');\n      fetchData();\n    } catch (err) {\n      toast.error('Failed to delete lead');\n    }\n  };\n\n  const exportData = () => {\n    const csvContent = [\n      ['Lead ID', 'Name', 'Email', 'Company', 'Status', 'Priority', 'Value', 'Assigned To', 'Created At'],\n      ...leads.map(l => [\n        l.leadId || '',\n        `${l.firstName} ${l.lastName}`,\n        l.email,\n        l.company || '',\n        l.status,\n        l.priority,\n        l.estimatedValue || l.actualValue || 0,\n        l.assignedTo?.personalInfo \n          ? `${l.assignedTo.personalInfo.firstName} ${l.assignedTo.personalInfo.lastName}`\n          : 'Unassigned',\n        new Date(l.createdAt).toLocaleDateString()\n      ])\n    ];\n    const csv = csvContent.map(row => row.map(field => `\"${field}\"`).join(',')).join('\\n');\n    const blob = new Blob([csv], { type: 'text/csv' });\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `sales_report_${filters.startDate}_to_${filters.endDate}.csv`;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    window.URL.revokeObjectURL(url);\n    toast.success('Sales report exported!');\n  };\n\n  // Format helpers\n  const formatCurrency = (value) => `₹${(value || 0).toLocaleString()}`;\n  const formatDate = (date) => date ? new Date(date).toLocaleDateString() : '—';\n\n  return (\n    <AdminLayout>\n      <div className=\"px-2 sm:px-4 md:px-6 lg:px-8 xl:px-12 space-y-6\">\n        {/* Header */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-3 sm:p-4 md:p-6\">\n          <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-3\">\n            <div>\n              <h1 className=\"text-xl sm:text-2xl md:text-3xl font-bold text-white mb-1\">\n                Sales <span className=\"neon-text\">Dashboard</span>\n              </h1>\n              <p className=\"text-secondary-400 text-xs sm:text-sm\">Monitor and manage your sales pipeline</p>\n            </div>\n            <div className=\"flex flex-wrap gap-2\">\n              <button\n                onClick={() => setShowFilters(!showFilters)}\n                className=\"px-3 py-1.5 sm:px-4 sm:py-2 bg-secondary-700 hover:bg-secondary-600 text-white rounded-lg flex items-center gap-1.5 text-xs sm:text-sm transition-colors\"\n              >\n                <Filter className=\"w-3.5 h-3.5 sm:w-4 sm:h-4\" />\n                <span>Filters</span>\n              </button>\n              <button\n                onClick={exportData}\n                disabled={leads.length === 0}\n                className=\"px-3 py-1.5 sm:px-4 sm:py-2 bg-neon-purple/20 hover:bg-neon-purple/30 text-neon-purple rounded-lg flex items-center gap-1.5 text-xs sm:text-sm transition-colors disabled:opacity-50\"\n              >\n                <Download className=\"w-3.5 h-3.5 sm:w-4 sm:h-4\" />\n                <span>Export</span>\n              </button>\n              <button\n                onClick={fetchData}\n                className=\"px-3 py-1.5 sm:px-4 sm:py-2 bg-neon-pink/20 hover:bg-neon-pink/30 text-neon-pink rounded-lg flex items-center gap-1.5 text-xs sm:text-sm transition-colors\"\n              >\n                <RefreshCw className=\"w-3.5 h-3.5 sm:w-4 sm:h-4\" />\n                <span>Refresh</span>\n              </button>\n            </div>\n          </div>\n        </div>\n\n        {/* Summary Cards */}\n        {summary && (\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4\">\n            <StatCard \n              title=\"Total Revenue\" \n              value={formatCurrency(summary.wonStats?.totalRevenue)} \n              icon={DollarSign}\n              color=\"green\"\n            />\n            <StatCard \n              title=\"Target Achievement\" \n              value={`${summary.achievementRate || 0}%`} \n              icon={Target}\n              color=\"neon-pink\"\n            />\n            <StatCard \n              title=\"Win Rate\" \n              value={`${summary.winRate || 0}%`} \n              icon={Award}\n              color=\"blue\"\n            />\n            <StatCard \n              title=\"Active Leads\" \n              value={summary.activeLeads || 0} \n              icon={Users}\n              color=\"purple\"\n            />\n          </div>\n        )}\n\n        {/* Filters */}\n        {showFilters && (\n          <div className=\"glass-morphism neon-border rounded-2xl p-3 sm:p-4 md:p-6\">\n            <h3 className=\"text-base sm:text-lg font-bold text-white mb-3\">Filters</h3>\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 sm:gap-4\">\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1.5\">Start Date</label>\n                <input\n                  type=\"date\"\n                  value={filters.startDate}\n                  onChange={(e) => handleFilterChange('startDate', e.target.value)}\n                  className=\"w-full px-2.5 py-1.5 sm:px-3 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-xs sm:text-sm focus:border-neon-pink\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1.5\">End Date</label>\n                <input\n                  type=\"date\"\n                  value={filters.endDate}\n                  onChange={(e) => handleFilterChange('endDate', e.target.value)}\n                  className=\"w-full px-2.5 py-1.5 sm:px-3 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-xs sm:text-sm focus:border-neon-pink\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1.5\">Department</label>\n                <select\n                  value={filters.department}\n                  onChange={(e) => handleFilterChange('department', e.target.value)}\n                  className=\"w-full px-2.5 py-1.5 sm:px-3 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-xs sm:text-sm focus:border-neon-pink\"\n                >\n                  <option value=\"\">All Departments</option>\n                  <option value=\"Sales\">Sales</option>\n                  <option value=\"Marketing\">Marketing</option>\n                </select>\n              </div>\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1.5\">Status</label>\n                <select\n                  value={filters.status}\n                  onChange={(e) => handleFilterChange('status', e.target.value)}\n                  className=\"w-full px-2.5 py-1.5 sm:px-3 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-xs sm:text-sm focus:border-neon-pink\"\n                >\n                  <option value=\"all\">All Status</option>\n                  <option value=\"Won\">Won</option>\n                  <option value=\"Lost\">Lost</option>\n                  <option value=\"Negotiation\">Negotiation</option>\n                  <option value=\"Proposal\">Proposal</option>\n                  <option value=\"Qualified\">Qualified</option>\n                  <option value=\"Contacted\">Contacted</option>\n                </select>\n              </div>\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1.5\">Search</label>\n                <div className=\"relative\">\n                  <Search className=\"absolute left-2.5 top-1/2 transform -translate-y-1/2 w-3.5 h-3.5 text-secondary-400\" />\n                  <input\n                    type=\"text\"\n                    placeholder=\"Lead name, email...\"\n                    value={filters.search}\n                    onChange={(e) => handleFilterChange('search', e.target.value)}\n                    className=\"w-full pl-8 pr-3 py-1.5 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white placeholder-secondary-400 text-xs sm:text-sm focus:border-neon-pink\"\n                  />\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Funnel Chart */}\n        {funnelData.length > 0 && (\n          <div className=\"glass-morphism neon-border rounded-2xl p-3 sm:p-4\">\n            <h3 className=\"text-base sm:text-lg font-bold text-white mb-3 sm:mb-4\">Sales Funnel</h3>\n            <div className=\"space-y-3 sm:space-y-2\">\n              {funnelData.map((stage, i) => (\n                <div key={stage.name} className=\"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-0\">\n                  <div className=\"w-full sm:w-20 text-secondary-400 text-sm font-medium\">{stage.name}</div>\n                  <div className=\"flex-1 bg-secondary-700 rounded-full h-2 mx-0 sm:mx-4\">\n                    <div\n                      className=\"h-2 rounded-full bg-gradient-to-r from-neon-pink to-neon-purple\"\n                      style={{ width: `${(stage.count / funnelData[0].count) * 100}%` }}\n                    ></div>\n                  </div>\n                  <div className=\"flex justify-between sm:justify-start sm:w-20 text-white text-sm font-medium\">\n                    <span>{stage.count}</span>\n                    <span className=\"sm:hidden text-secondary-400\">leads</span>\n                  </div>\n                  <div className=\"hidden sm:block w-16 text-secondary-400 text-sm\">{stage.conversionRate}%</div>\n                </div>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Leads Table */}\n        <div className=\"glass-morphism neon-border rounded-2xl overflow-hidden\">\n          <div className=\"p-3 sm:p-4 md:p-6\">\n            <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-4\">\n              <h2 className=\"text-base sm:text-lg font-bold text-white\">All Leads & Deals</h2>\n              <p className=\"text-secondary-400 text-xs sm:text-sm\">\n                Showing {leads.length} leads\n              </p>\n            </div>\n\n            {/* Desktop Table */}\n            <div className=\"hidden sm:block overflow-x-auto -mx-3 px-3\">\n              <table className=\"w-full min-w-[600px]\">\n                <thead className=\"border-b border-secondary-700\">\n                  <tr>\n                    <th className=\"text-left p-2 sm:p-3 text-secondary-300 font-medium text-xs sm:text-sm\">Lead</th>\n                    <th className=\"text-left p-2 sm:p-3 text-secondary-300 font-medium text-xs sm:text-sm\">Status</th>\n                    <th className=\"text-left p-2 sm:p-3 text-secondary-300 font-medium text-xs sm:text-sm\">Value</th>\n                    <th className=\"text-left p-2 sm:p-3 text-secondary-300 font-medium text-xs sm:text-sm\">Assigned To</th>\n                    <th className=\"text-left p-2 sm:p-3 text-secondary-300 font-medium text-xs sm:text-sm\">Next Follow-up</th>\n                    <th className=\"text-left p-2 sm:p-3 text-secondary-300 font-medium text-xs sm:text-sm\">Actions</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {loading ? (\n                    <tr><td colSpan=\"6\" className=\"py-6 text-center text-secondary-400\">Loading...</td></tr>\n                  ) : leads.length === 0 ? (\n                    <tr><td colSpan=\"6\" className=\"py-8 text-center text-secondary-400\">No leads found</td></tr>\n                  ) : (\n                    leads.map(lead => (\n                      <tr key={lead._id} className=\"border-b border-secondary-800 hover:bg-secondary-800/30\">\n                        <td className=\"p-2 sm:p-3\">\n                          <div className=\"flex items-center gap-2\">\n                            <div className=\"w-7 h-7 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                              <User className=\"w-3 h-3 text-white\" />\n                            </div>\n                            <div>\n                              <p className=\"text-white font-medium text-xs sm:text-sm\">\n                                {lead.firstName} {lead.lastName}\n                              </p>\n                              <p className=\"text-[10px] text-secondary-400\">{lead.company || '—'}</p>\n                            </div>\n                          </div>\n                        </td>\n                        <td className=\"p-2 sm:p-3\">\n                          <span className={`px-1.5 py-0.5 text-[10px] rounded-full ${getStatusColor(lead.status)}`}>\n                            {lead.status}\n                          </span>\n                        </td>\n                        <td className=\"p-2 sm:p-3 text-neon-pink font-medium text-xs sm:text-sm\">\n                          {formatCurrency(lead.estimatedValue || lead.actualValue)}\n                        </td>\n                        <td className=\"p-2 sm:p-3 text-white text-xs sm:text-sm\">\n                          {lead.assignedTo?.personalInfo\n                            ? `${lead.assignedTo.personalInfo.firstName} ${lead.assignedTo.personalInfo.lastName}`\n                            : 'Unassigned'}\n                        </td>\n                        <td className=\"p-2 sm:p-3 text-secondary-400 text-xs sm:text-sm\">\n                          {formatDate(lead.nextFollowUpDate)}\n                        </td>\n                        <td className=\"p-2 sm:p-3\">\n                          <div className=\"flex items-center gap-1\">\n                            <button\n                              onClick={() => {/* View modal */}}\n                              className=\"p-1 text-secondary-400 hover:text-blue-400\"\n                            >\n                              <Eye className=\"w-2.5 h-2.5\" />\n                            </button>\n                            <button\n                              onClick={() => {\n                                setSelectedLead(lead);\n                                setReassignTo(lead.assignedTo?._id || '');\n                                setShowReassignModal(true);\n                              }}\n                              className=\"p-1 text-secondary-400 hover:text-purple-400\"\n                            >\n                              <UserCheck className=\"w-2.5 h-2.5\" />\n                            </button>\n                            <button\n                              onClick={() => handleDelete(lead._id)}\n                              className=\"p-1 text-secondary-400 hover:text-red-400\"\n                            >\n                              <Trash2 className=\"w-2.5 h-2.5\" />\n                            </button>\n                          </div>\n                        </td>\n                      </tr>\n                    ))\n                  )}\n                </tbody>\n              </table>\n            </div>\n\n            {/* Mobile Cards */}\n            <div className=\"block sm:hidden space-y-4\">\n              {loading ? (\n                <div className=\"text-center py-8 text-secondary-400\">\n                  <div className=\"animate-spin rounded-full h-6 w-6 border-b-2 border-neon-pink mx-auto\"></div>\n                  <p className=\"mt-2\">Loading leads...</p>\n                </div>\n              ) : leads.length === 0 ? (\n                <div className=\"text-center py-8\">\n                  <User className=\"w-10 h-10 text-secondary-600 mx-auto mb-2\" />\n                  <p className=\"text-secondary-400\">No leads found</p>\n                </div>\n              ) : (\n                leads.map(lead => (\n                  <div key={lead._id} className=\"glass-morphism rounded-lg p-4 border border-secondary-700\">\n                    <div className=\"flex justify-between items-start mb-3\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-8 h-8 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                          <User className=\"w-4 h-4 text-white\" />\n                        </div>\n                        <div>\n                          <p className=\"text-white font-medium text-base\">{lead.firstName} {lead.lastName}</p>\n                          <p className=\"text-sm text-secondary-400\">{lead.company || '—'}</p>\n                        </div>\n                      </div>\n                      <div className=\"flex gap-1\">\n                        <button\n                          onClick={() => {/* View modal */}}\n                          className=\"p-2 text-secondary-400 hover:text-blue-400\"\n                        >\n                          <Eye className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                          onClick={() => {\n                            setSelectedLead(lead);\n                            setReassignTo(lead.assignedTo?._id || '');\n                            setShowReassignModal(true);\n                          }}\n                          className=\"p-2 text-secondary-400 hover:text-purple-400\"\n                        >\n                          <UserCheck className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                          onClick={() => handleDelete(lead._id)}\n                          className=\"p-2 text-secondary-400 hover:text-red-400\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </button>\n                      </div>\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                      <div>\n                        <p className=\"text-secondary-400\">Status</p>\n                        <span className={`px-2 py-1 rounded-full text-xs ${getStatusColor(lead.status)}`}>\n                          {lead.status}\n                        </span>\n                      </div>\n                      <div>\n                        <p className=\"text-secondary-400\">Value</p>\n                        <p className=\"text-neon-pink font-medium\">{formatCurrency(lead.estimatedValue || lead.actualValue)}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-secondary-400\">Assigned To</p>\n                        <p className=\"text-white\">\n                          {lead.assignedTo?.personalInfo\n                            ? `${lead.assignedTo.personalInfo.firstName} ${lead.assignedTo.personalInfo.lastName}`\n                            : 'Unassigned'}\n                        </p>\n                      </div>\n                      <div>\n                        <p className=\"text-secondary-400\">Next Follow-up</p>\n                        <p className=\"text-white\">{formatDate(lead.nextFollowUpDate)}</p>\n                      </div>\n                    </div>\n                  </div>\n                ))\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Reassign Modal */}\n      {showReassignModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-4 w-full max-w-md\">\n            <h3 className=\"text-lg font-bold text-white mb-3\">Reassign Lead</h3>\n            <p className=\"text-secondary-400 text-sm mb-4\">\n              Reassign <span className=\"text-white\">{selectedLead?.firstName} {selectedLead?.lastName}</span>\n            </p>\n            <select\n              value={reassignTo}\n              onChange={(e) => setReassignTo(e.target.value)}\n              className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink mb-4\"\n            >\n              <option value=\"\">Select Sales Rep</option>\n              {employees.map(emp => (\n                <option key={emp._id} value={emp._id}>\n                  {emp.personalInfo.firstName} {emp.personalInfo.lastName}\n                </option>\n              ))}\n            </select>\n            <div className=\"flex gap-2\">\n              <button\n                onClick={handleReassign}\n                className=\"flex-1 px-3 py-2 bg-gradient-to-r from-neon-pink to-neon-purple text-white rounded-lg text-sm\"\n              >\n                Reassign\n              </button>\n              <button\n                onClick={() => setShowReassignModal(false)}\n                className=\"flex-1 px-3 py-2 bg-secondary-700 text-white rounded-lg text-sm\"\n              >\n                Cancel\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </AdminLayout>\n  );\n};\n\n// Stat Card Component\nconst StatCard = ({ title, value, icon: Icon, color }) => {\n  const colorClasses = {\n    green: 'text-green-400',\n    'neon-pink': 'text-neon-pink',\n    blue: 'text-blue-400',\n    purple: 'text-purple-400'\n  };\n  \n  return (\n    <div className=\"glass-morphism neon-border rounded-xl p-3 sm:p-4\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <p className=\"text-secondary-400 text-xs\">{title}</p>\n          <p className={`text-lg sm:text-xl font-bold ${colorClasses[color] || 'text-white'}`}>\n            {value}\n          </p>\n        </div>\n        <Icon className={`w-5 h-5 sm:w-6 sm:h-6 ${colorClasses[color] || 'text-white'}`} />\n      </div>\n    </div>\n  );\n};\n\nexport default AdminSalesDashboard;","path":null,"size_bytes":25398,"size_tokens":null},"backend/models/Task.js":{"content":"import mongoose from 'mongoose';\n\nconst taskSchema = new mongoose.Schema({\n  title: {\n    type: String,\n    required: [true, 'Task title is required'],\n    trim: true,\n    maxlength: [100, 'Task title cannot exceed 100 characters']\n  },\n  description: {\n    type: String,\n    required: [true, 'Task description is required'],\n    trim: true,\n    maxlength: [1000, 'Task description cannot exceed 1000 characters']\n  },\n  assignedTo: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'Employee',\n    required: true\n  },\n  assignedBy: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true\n  },\n  project: {\n    type: String,\n    trim: true,\n    maxlength: [50, 'Project name cannot exceed 50 characters']\n  },\n  priority: {\n    type: String,\n    enum: ['Low', 'Medium', 'High', 'Critical'],\n    default: 'Medium'\n  },\n  status: {\n    type: String,\n    enum: ['Not Started', 'In Progress', 'Review', 'Completed', 'On Hold', 'Cancelled'],\n    default: 'Not Started'\n  },\n  dueDate: {\n    type: Date,\n    required: [true, 'Due date is required']\n  },\n  startDate: {\n    type: Date,\n    default: Date.now\n  },\n  completedDate: {\n    type: Date\n  },\n  estimatedHours: {\n    type: Number,\n    min: [0, 'Estimated hours cannot be negative'],\n    max: [1000, 'Estimated hours cannot exceed 1000']\n  },\n  actualHours: {\n    type: Number,\n    min: [0, 'Actual hours cannot be negative'],\n    default: 0\n  },\n  category: {\n    type: String,\n    enum: ['Development', 'Design', 'Testing', 'Documentation', 'Research', 'Bug Fix', 'Feature', 'Maintenance', 'Other'],\n    default: 'Other'\n  },\n  tags: [{\n    type: String,\n    trim: true,\n    maxlength: [20, 'Tag cannot exceed 20 characters']\n  }],\n  attachments: [{\n    fileName: String,\n    filePath: String,\n    fileSize: Number,\n    mimeType: String,\n    uploadedAt: {\n      type: Date,\n      default: Date.now\n    }\n  }],\n  comments: [{\n    user: {\n      type: mongoose.Schema.Types.ObjectId,\n      ref: 'User',\n      required: true\n    },\n    text: {\n      type: String,\n      required: true,\n      trim: true,\n      maxlength: [500, 'Comment cannot exceed 500 characters']\n    },\n    createdAt: {\n      type: Date,\n      default: Date.now\n    }\n  }],\n  subtasks: [{\n    title: {\n      type: String,\n      required: true,\n      trim: true,\n      maxlength: [100, 'Subtask title cannot exceed 100 characters']\n    },\n    completed: {\n      type: Boolean,\n      default: false\n    },\n    completedAt: Date,\n    createdAt: {\n      type: Date,\n      default: Date.now\n    }\n  }],\n  dependencies: [{\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'Task'\n  }],\n  progress: {\n    type: Number,\n    min: 0,\n    max: 100,\n    default: 0\n  },\n  isRecurring: {\n    type: Boolean,\n    default: false\n  },\n  recurringPattern: {\n    type: String,\n    enum: ['Daily', 'Weekly', 'Bi-weekly', 'Monthly', 'Quarterly'],\n    required: function() {\n      return this.isRecurring;\n    }\n  },\n  lastRecurringDate: Date,\n  nextRecurringDate: Date\n}, {\n  timestamps: true,\n  toJSON: { virtuals: true },\n  toObject: { virtuals: true }\n});\n\n// Indexes for better query performance\ntaskSchema.index({ assignedTo: 1 });\ntaskSchema.index({ assignedBy: 1 });\ntaskSchema.index({ status: 1 });\ntaskSchema.index({ priority: 1 });\ntaskSchema.index({ dueDate: 1 });\ntaskSchema.index({ project: 1 });\ntaskSchema.index({ category: 1 });\ntaskSchema.index({ createdAt: -1 });\n\n// Virtual for task status color\ntaskSchema.virtual('statusColor').get(function() {\n  const colors = {\n    'Not Started': 'gray',\n    'In Progress': 'blue',\n    'Review': 'yellow',\n    'Completed': 'green',\n    'On Hold': 'orange',\n    'Cancelled': 'red'\n  };\n  return colors[this.status] || 'gray';\n});\n\n// Virtual for priority color\ntaskSchema.virtual('priorityColor').get(function() {\n  const colors = {\n    'Low': 'green',\n    'Medium': 'yellow',\n    'High': 'orange',\n    'Critical': 'red'\n  };\n  return colors[this.priority] || 'gray';\n});\n\n// Virtual for overdue status\ntaskSchema.virtual('isOverdue').get(function() {\n  return this.status !== 'Completed' && new Date() > new Date(this.dueDate);\n});\n\n// Virtual for days remaining\ntaskSchema.virtual('daysRemaining').get(function() {\n  if (this.status === 'Completed') return 0;\n  \n  const now = new Date();\n  const due = new Date(this.dueDate);\n  const diffTime = due - now;\n  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n  \n  return diffDays;\n});\n\n// Virtual for completion percentage of subtasks\ntaskSchema.virtual('subtasksProgress').get(function() {\n  if (this.subtasks.length === 0) return 0;\n  \n  const completed = this.subtasks.filter(subtask => subtask.completed).length;\n  return Math.round((completed / this.subtasks.length) * 100);\n});\n\n// Pre-save middleware to update completion date\ntaskSchema.pre('save', function(next) {\n  if (this.isModified('status') && this.status === 'Completed' && !this.completedDate) {\n    this.completedDate = new Date();\n    this.progress = 100;\n  }\n  \n  if (this.isModified('status') && this.status !== 'Completed') {\n    this.completedDate = undefined;\n  }\n  \n  next();\n});\n\n// Pre-save middleware to calculate progress based on subtasks\ntaskSchema.pre('save', function(next) {\n  if (this.subtasks.length > 0 && this.status !== 'Completed') {\n    const completed = this.subtasks.filter(subtask => subtask.completed).length;\n    this.progress = Math.round((completed / this.subtasks.length) * 100);\n  }\n  next();\n});\n\n// Static method to get task statistics for an employee\ntaskSchema.statics.getEmployeeStats = async function(employeeId) {\n  const stats = await this.aggregate([\n    { $match: { assignedTo: new mongoose.Types.ObjectId(employeeId) } },\n    {\n      $group: {\n        _id: '$status',\n        count: { $sum: 1 },\n        totalHours: { $sum: '$actualHours' }\n      }\n    }\n  ]);\n  \n  const overdue = await this.countDocuments({\n    assignedTo: employeeId,\n    status: { $nin: ['Completed', 'Cancelled'] },\n    dueDate: { $lt: new Date() }\n  });\n  \n  return { statusStats: stats, overdue };\n};\n\n// Static method to get tasks by project\ntaskSchema.statics.getByProject = function(projectName) {\n  return this.find({ project: projectName })\n    .populate('assignedTo', 'personalInfo.firstName personalInfo.lastName employeeId')\n    .populate('assignedBy', 'name')\n    .sort({ createdAt: -1 });\n};\n\n// Static method to get overdue tasks\ntaskSchema.statics.getOverdueTasks = function() {\n  return this.find({\n    status: { $nin: ['Completed', 'Cancelled'] },\n    dueDate: { $lt: new Date() }\n  })\n    .populate('assignedTo', 'personalInfo.firstName personalInfo.lastName employeeId')\n    .sort({ dueDate: 1 });\n};\n\n// Instance method to add comment\ntaskSchema.methods.addComment = function(userId, text) {\n  this.comments.push({\n    user: userId,\n    text: text\n  });\n  return this.save();\n};\n\n// Instance method to add subtask\ntaskSchema.methods.addSubtask = function(title) {\n  this.subtasks.push({ title });\n  return this.save();\n};\n\n// Instance method to toggle subtask completion\ntaskSchema.methods.toggleSubtask = function(subtaskId) {\n  const subtask = this.subtasks.id(subtaskId);\n  if (subtask) {\n    subtask.completed = !subtask.completed;\n    subtask.completedAt = subtask.completed ? new Date() : null;\n    return this.save();\n  }\n  throw new Error('Subtask not found');\n};\n\n// Instance method to update progress\ntaskSchema.methods.updateProgress = function(progress) {\n  this.progress = Math.max(0, Math.min(100, progress));\n  \n  if (this.progress === 100 && this.status !== 'Completed') {\n    this.status = 'Completed';\n    this.completedDate = new Date();\n  } else if (this.progress > 0 && this.status === 'Not Started') {\n    this.status = 'In Progress';\n  }\n  \n  return this.save();\n};\n\n// Instance method to change status\ntaskSchema.methods.changeStatus = function(newStatus) {\n  this.status = newStatus;\n  \n  if (newStatus === 'Completed') {\n    this.completedDate = new Date();\n    this.progress = 100;\n  } else if (newStatus === 'In Progress' && this.progress === 0) {\n    this.progress = 10; // Set minimum progress when starting\n  }\n  \n  return this.save();\n};\n\nexport default mongoose.model('Task', taskSchema);","path":null,"size_bytes":8171,"size_tokens":null},"backend/utils/helpers.js":{"content":"// utils/helpers.js\nimport crypto from 'crypto';\n\n/**\n * Generate a random password with specified criteria\n * @param {number} length - Password length (default: 12)\n * @param {object} options - Password generation options\n * @returns {string} Generated password\n */\nexport const generatePassword = (length = 12, options = {}) => {\n  const {\n    includeUppercase = true,\n    includeLowercase = true,\n    includeNumbers = true,\n    includeSpecialChars = false,\n    excludeSimilar = true // Exclude similar looking characters like 0, O, l, I, 1\n  } = options;\n\n  let charset = '';\n  \n  if (includeUppercase) {\n    charset += excludeSimilar ? 'ABCDEFGHJKLMNPQRSTUVWXYZ' : 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';\n  }\n  \n  if (includeLowercase) {\n    charset += excludeSimilar ? 'abcdefghijkmnpqrstuvwxyz' : 'abcdefghijklmnopqrstuvwxyz';\n  }\n  \n  if (includeNumbers) {\n    charset += excludeSimilar ? '23456789' : '0123456789';\n  }\n  \n  if (includeSpecialChars) {\n    charset += '!@#$%^&*()_+-=[]{}|;:,.<>?';\n  }\n\n  if (!charset) {\n    throw new Error('At least one character type must be included');\n  }\n\n  let password = '';\n  \n  // Ensure at least one character from each selected type\n  if (includeUppercase) {\n    const uppercaseChars = excludeSimilar ? 'ABCDEFGHJKLMNPQRSTUVWXYZ' : 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';\n    password += uppercaseChars[crypto.randomInt(uppercaseChars.length)];\n  }\n  \n  if (includeLowercase) {\n    const lowercaseChars = excludeSimilar ? 'abcdefghijkmnpqrstuvwxyz' : 'abcdefghijklmnopqrstuvwxyz';\n    password += lowercaseChars[crypto.randomInt(lowercaseChars.length)];\n  }\n  \n  if (includeNumbers) {\n    const numberChars = excludeSimilar ? '23456789' : '0123456789';\n    password += numberChars[crypto.randomInt(numberChars.length)];\n  }\n  \n  if (includeSpecialChars) {\n    const specialChars = '!@#$%^&*()_+-=[]{}|;:,.<>?';\n    password += specialChars[crypto.randomInt(specialChars.length)];\n  }\n\n  // Fill the rest of the password\n  for (let i = password.length; i < length; i++) {\n    password += charset[crypto.randomInt(charset.length)];\n  }\n\n  // Shuffle the password to avoid predictable patterns\n  return shuffleString(password);\n};\n\n/**\n * Shuffle a string randomly\n * @param {string} str - String to shuffle\n * @returns {string} Shuffled string\n */\nconst shuffleString = (str) => {\n  const array = str.split('');\n  for (let i = array.length - 1; i > 0; i--) {\n    const j = crypto.randomInt(i + 1);\n    [array[i], array[j]] = [array[j], array[i]];\n  }\n  return array.join('');\n};\n\n/**\n * Generate a simple memorable password (for temporary use)\n * @returns {string} Simple 8-character password\n */\nexport const generateSimplePassword = () => {\n  const adjectives = ['Quick', 'Bright', 'Swift', 'Smart', 'Cool', 'Fast', 'Blue', 'Red', 'Green'];\n  const numbers = [123, 456, 789, 321, 654, 987, 111, 222, 333];\n  \n  const adjective = adjectives[crypto.randomInt(adjectives.length)];\n  const number = numbers[crypto.randomInt(numbers.length)];\n  \n  return `${adjective}${number}`;\n};\n\n/**\n * Validate password strength\n * @param {string} password - Password to validate\n * @returns {object} Validation result with score and feedback\n */\nexport const validatePasswordStrength = (password) => {\n  let score = 0;\n  const feedback = [];\n\n  if (!password) {\n    return { score: 0, strength: 'Invalid', feedback: ['Password is required'] };\n  }\n\n  // Length check\n  if (password.length >= 8) {\n    score += 1;\n  } else {\n    feedback.push('Password should be at least 8 characters long');\n  }\n\n  if (password.length >= 12) {\n    score += 1;\n  }\n\n  // Character type checks\n  if (/[a-z]/.test(password)) {\n    score += 1;\n  } else {\n    feedback.push('Password should contain lowercase letters');\n  }\n\n  if (/[A-Z]/.test(password)) {\n    score += 1;\n  } else {\n    feedback.push('Password should contain uppercase letters');\n  }\n\n  if (/\\d/.test(password)) {\n    score += 1;\n  } else {\n    feedback.push('Password should contain numbers');\n  }\n\n  if (/[!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>?]/.test(password)) {\n    score += 1;\n  }\n\n  // Common patterns (subtract points)\n  if (/(.)\\1{2,}/.test(password)) {\n    score -= 1;\n    feedback.push('Avoid repeating characters');\n  }\n\n  if (/123|abc|qwe/i.test(password)) {\n    score -= 1;\n    feedback.push('Avoid common sequences');\n  }\n\n  // Determine strength\n  let strength;\n  if (score < 2) {\n    strength = 'Weak';\n  } else if (score < 4) {\n    strength = 'Fair';\n  } else if (score < 6) {\n    strength = 'Good';\n  } else {\n    strength = 'Strong';\n  }\n\n  return { score, strength, feedback };\n};\n\n/**\n * Format error messages for API responses\n * @param {Error} error - Error object\n * @returns {string} Formatted error message\n */\nexport const formatErrorMessage = (error) => {\n  if (error.name === 'ValidationError') {\n    const messages = Object.values(error.errors).map(err => err.message);\n    return messages.join(', ');\n  }\n  \n  if (error.code === 11000) {\n    const field = Object.keys(error.keyPattern)[0];\n    return `${field} already exists`;\n  }\n  \n  return error.message || 'An unexpected error occurred';\n};\n\n/**\n * Sanitize user input\n * @param {string} input - Input string to sanitize\n * @returns {string} Sanitized string\n */\nexport const sanitizeInput = (input) => {\n  if (typeof input !== 'string') return input;\n  \n  return input\n    .trim()\n    .replace(/[<>]/g, '') // Remove < and > to prevent XSS\n    .substring(0, 1000); // Limit length\n};\n\n/**\n * Generate a slug from text\n * @param {string} text - Text to convert to slug\n * @returns {string} URL-friendly slug\n */\nexport const generateSlug = (text) => {\n  return text\n    .toLowerCase()\n    .trim()\n    .replace(/[^\\w\\s-]/g, '') // Remove special characters\n    .replace(/[\\s_-]+/g, '-') // Replace spaces and underscores with hyphens\n    .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens\n};","path":null,"size_bytes":5845,"size_tokens":null},"frontend/src/pages/Employee/EmployeeLeaveRequests.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport axios from 'axios';\nimport EmployeeLayout from '../../components/Employee/EmployeeLayout/EmployeeLayout';\nimport {\n  Calendar as CalendarIcon,\n  Plus,\n  Clock,\n  CheckCircle,\n  XCircle,\n  Eye,\n  AlertCircle,\n  FileText,\n  User,\n  X,\n  Save,\n  Loader\n} from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport Calendar from 'react-calendar';\nimport 'react-calendar/dist/Calendar.css';\n\nconst EmployeeLeaveRequests = () => {\n  const [leaveRequests, setLeaveRequests] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [submitLoading, setSubmitLoading] = useState(false);\n const [leaveBalance, setLeaveBalance] = useState({\n  total: 30,\n  used: 0,\n  remaining: 30\n});\n\n  const [showModal, setShowModal] = useState(false);\n  const [showViewModal, setShowViewModal] = useState(false);\n  const [showCalendarModal, setShowCalendarModal] = useState(false);\n  const [selectedLeave, setSelectedLeave] = useState(null);\n  const [newLeave, setNewLeave] = useState({\n    leaveType: 'casual',\n    startDate: '',\n    endDate: '',\n    reason: '',\n    isHalfDay: false,\n    halfDaySession: 'Morning'\n  });\n\n  const leaveTypes = ['casual', 'sick', 'earned', 'emergency', 'personal'];\n\n  // Fetch employee's leave requests\n  const fetchLeaveRequests = async () => {\n    try {\n      setLoading(true);\n      const token = localStorage.getItem('token');\n      const response = await axios.get('/api/leaves', {\n        headers: { Authorization: `Bearer ${token}` }\n      });\n      \n      if (response.data.success) {\n        setLeaveRequests(response.data.leaves || []);\n      }\n    } catch (error) {\n      console.error('Error fetching leave requests:', error);\n      toast.error('Failed to fetch leave requests');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n// Update the fetchLeaveBalance function\nconst fetchLeaveBalance = async () => {\n  try {\n    const token = localStorage.getItem('token');\n    const response = await axios.get('/api/leaves/balance', {\n      headers: { Authorization: `Bearer ${token}` }\n    });\n    \n    if (response.data.success) {\n      setLeaveBalance(response.data.balance);\n    }\n  } catch (error) {\n    console.error('Error fetching leave balance:', error);\n    toast.error('Failed to fetch leave balance');\n  }\n};\n\n  useEffect(() => {\n    fetchLeaveRequests();\n    fetchLeaveBalance();\n  }, []);\n\n  const calculateDays = (start, end, isHalfDay) => {\n    if (isHalfDay) return 0.5;\n    if (!start || !end) return 0;\n    \n    const startDate = new Date(start);\n    const endDate = new Date(end);\n    const diffTime = Math.abs(endDate - startDate);\n    return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;\n  };\n\n// Update the leave validation in handleApplyLeave\nconst handleApplyLeave = async (e) => {\n  e.preventDefault();\n\n  // Validate reason length\n  if (newLeave.reason.trim().length < 10) {\n    toast.error('Reason must be at least 10 characters long');\n    return;\n  }\n\n  const totalDays = calculateDays(newLeave.startDate, newLeave.endDate, newLeave.isHalfDay);\n  const availableBalance = leaveBalance.remaining || 0;\n\n  if (totalDays > availableBalance) {\n    toast.error(`Insufficient leave balance. Available: ${availableBalance} days`);\n    return;\n  }\n\n  try {\n    setSubmitLoading(true);\n    const token = localStorage.getItem('token');\n    \n    const leaveData = {\n      ...newLeave,\n      leaveType: newLeave.leaveType.toLowerCase(),\n      totalDays,\n      endDate: newLeave.isHalfDay ? newLeave.startDate : newLeave.endDate\n    };\n\n    if (!newLeave.isHalfDay) delete leaveData.halfDaySession;\n\n    console.log('Sending leave data:', leaveData); // Debug log\n\n    const response = await axios.post('/api/leaves', leaveData, {\n      headers: { Authorization: `Bearer ${token}` }\n    });\n\n    if (response.data.success) {\n      toast.success('Leave application submitted successfully!');\n      setNewLeave({\n        leaveType: 'casual',\n        startDate: '',\n        endDate: '',\n        reason: '',\n        isHalfDay: false,\n        halfDaySession: 'Morning'\n      });\n      setShowModal(false);\n      fetchLeaveRequests();\n      fetchLeaveBalance();\n    }\n  } catch (error) {\n    console.error('Error applying for leave:', error);\n    console.error('Error response data:', error.response?.data); // Debug log\n    console.error('Error response status:', error.response?.status); // Debug log\n    if (error.response?.data?.errors) {\n      console.error('Validation errors:', error.response.data.errors); // Debug log\n      // Log each individual error\n      error.response.data.errors.forEach((err, index) => {\n        console.error(`Validation error ${index + 1}:`, err);\n      });\n    }\n    toast.error(error.response?.data?.message || 'Failed to submit leave application');\n  } finally {\n    setSubmitLoading(false);\n  }\n};\n\n  const handleCancelLeave = async (leaveId) => {\n    if (window.confirm('Are you sure you want to cancel this leave request?')) {\n      try {\n        const token = localStorage.getItem('token');\n        await axios.put(`/api/leaves/${leaveId}/cancel`, {}, {\n          headers: { Authorization: `Bearer ${token}` }\n        });\n        \n        toast.success('Leave request cancelled!');\n        fetchLeaveRequests();\n        fetchLeaveBalance();\n      } catch (error) {\n        console.error('Error cancelling leave:', error);\n        toast.error(error.response?.data?.message || 'Failed to cancel leave request');\n      }\n    }\n  };\n\n  const getStatusColor = (status) => {\n    switch (status.toLowerCase()) {\n      case 'pending': return 'text-yellow-400 bg-yellow-400/20';\n      case 'approved': return 'text-green-400 bg-green-400/20';\n      case 'rejected': return 'text-red-400 bg-red-400/20';\n      case 'cancelled': return 'text-gray-400 bg-gray-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  const getLeaveTypeColor = (type) => {\n    switch (type.toLowerCase()) {\n      case 'casual': return 'bg-blue-500/20 text-blue-400';\n      case 'sick': return 'bg-red-500/20 text-red-400';\n      case 'earned': return 'bg-green-500/20 text-green-400';\n      case 'emergency': return 'bg-orange-500/20 text-orange-400';\n      default: return 'bg-purple-500/20 text-purple-400';\n    }\n  };\n\n  const ApplyLeaveModal = () => (\n    <div className=\"fixed inset-0 z-[9999] flex items-center justify-center p-4\">\n      {/* Enhanced backdrop with blur */}\n      <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" onClick={() => !submitLoading && setShowModal(false)} />\n\n      {/* Modal content */}\n      <div className=\"relative glass-morphism neon-border rounded-2xl p-4 sm:p-6 w-full max-w-full sm:max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h2 className=\"text-2xl font-bold text-white\">Apply for Leave</h2>\n          <button \n            onClick={() => setShowModal(false)}\n            className=\"text-secondary-400 hover:text-white\"\n            disabled={submitLoading}\n          >\n            <X className=\"w-6 h-6\" />\n          </button>\n        </div>\n\n        <form onSubmit={handleApplyLeave} className=\"space-y-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Leave Type</label>\n              <select\n                value={newLeave.leaveType}\n                onChange={(e) => setNewLeave({...newLeave, leaveType: e.target.value})}\n                className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                required\n                disabled={submitLoading}\n              >\n                {leaveTypes.map(type => (\n                  <option key={type} value={type}>{type}</option>\n                ))}\n              </select>\n              <p className=\"text-sm text-secondary-400 mt-1\">\n  Available: {leaveBalance.remaining || 0} days\n              </p>\n            </div>\n\n            <div className=\"flex items-center space-x-2 pt-8\">\n              <input\n                type=\"checkbox\"\n                id=\"halfDay\"\n                checked={newLeave.isHalfDay}\n                onChange={(e) => setNewLeave({...newLeave, isHalfDay: e.target.checked})}\n                className=\"w-4 h-4 rounded border-secondary-600 bg-secondary-800 text-neon-pink focus:ring-neon-pink\"\n                disabled={submitLoading}\n              />\n              <label htmlFor=\"halfDay\" className=\"text-sm text-secondary-300\">Half Day Leave</label>\n            </div>\n          </div>\n\n          {newLeave.isHalfDay && (\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Half Day Session</label>\n              <div className=\"flex space-x-4\">\n                <label className=\"flex items-center\">\n                  <input\n                    type=\"radio\"\n                    name=\"halfDaySession\"\n                    value=\"Morning\"\n                    checked={newLeave.halfDaySession === 'Morning'}\n                    onChange={(e) => setNewLeave({...newLeave, halfDaySession: e.target.value})}\n                    className=\"w-4 h-4 text-neon-pink\"\n                    disabled={submitLoading}\n                  />\n                  <span className=\"ml-2 text-white\">Morning</span>\n                </label>\n                <label className=\"flex items-center\">\n                  <input\n                    type=\"radio\"\n                    name=\"halfDaySession\"\n                    value=\"Evening\"\n                    checked={newLeave.halfDaySession === 'Evening'}\n                    onChange={(e) => setNewLeave({...newLeave, halfDaySession: e.target.value})}\n                    className=\"w-4 h-4 text-neon-pink\"\n                    disabled={submitLoading}\n                  />\n                  <span className=\"ml-2 text-white\">Evening</span>\n                </label>\n              </div>\n            </div>\n          )}\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Start Date</label>\n              <input\n                type=\"date\"\n                value={newLeave.startDate}\n                onChange={(e) => setNewLeave({...newLeave, startDate: e.target.value})}\n                min={new Date().toISOString().split('T')[0]}\n                className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                required\n                disabled={submitLoading}\n              />\n            </div>\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                {newLeave.isHalfDay ? 'Date' : 'End Date'}\n              </label>\n              <input\n                type=\"date\"\n                value={newLeave.isHalfDay ? newLeave.startDate : newLeave.endDate}\n                onChange={(e) => setNewLeave({...newLeave, endDate: newLeave.isHalfDay ? newLeave.startDate : e.target.value})}\n                min={newLeave.startDate || new Date().toISOString().split('T')[0]}\n                className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                required\n                disabled={newLeave.isHalfDay || submitLoading}\n              />\n            </div>\n          </div>\n\n          {newLeave.startDate && (newLeave.endDate || newLeave.isHalfDay) && (\n            <div className=\"p-4 bg-secondary-800/30 rounded-lg\">\n              <p className=\"text-sm text-secondary-400\">Total Days: \n                <span className=\"text-neon-pink font-medium ml-2\">\n                  {calculateDays(newLeave.startDate, newLeave.endDate || newLeave.startDate, newLeave.isHalfDay)} \n                  {newLeave.isHalfDay ? ' (Half Day)' : ' days'}\n                </span>\n              </p>\n            </div>\n          )}\n\n          <div>\n            <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Reason for Leave</label>\n            <input\n              type=\"text\"\n              value={newLeave.reason}\n              onChange={(e) => setNewLeave({...newLeave, reason: e.target.value})}\n              className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n              placeholder=\"Please provide reason for your leave request...\"\n              required\n              disabled={submitLoading}\n              maxLength={500}\n              autoFocus\n            />\n            <p className=\"text-xs text-secondary-500 mt-1\">{newLeave.reason.length}/500 characters (minimum 10)</p>\n          </div>\n\n          <div className=\"flex justify-end space-x-4\">\n            <button\n              type=\"button\"\n              onClick={() => setShowModal(false)}\n              className=\"px-6 py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700/50 transition-colors\"\n              disabled={submitLoading}\n            >\n              Cancel\n            </button>\n            <button\n              type=\"submit\"\n              className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 disabled:opacity-50 flex items-center\"\n              disabled={submitLoading}\n            >\n              {submitLoading ? (\n                <Loader className=\"w-4 h-4 mr-2 animate-spin\" />\n              ) : (\n                <Save className=\"w-4 h-4 mr-2\" />\n              )}\n              {submitLoading ? 'Submitting...' : 'Submit Application'}\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  );\n\n  const ViewLeaveModal = () => (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"glass-morphism neon-border rounded-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h2 className=\"text-2xl font-bold text-white\">Leave Request Details</h2>\n          <button\n            onClick={() => setShowViewModal(false)}\n            className=\"text-secondary-400 hover:text-white\"\n          >\n            <X className=\"w-6 h-6\" />\n          </button>\n        </div>\n\n        {selectedLeave && (\n          <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between p-4 bg-secondary-800/30 rounded-lg\">\n              <div>\n                <h3 className=\"text-lg font-bold text-white\">{selectedLeave.leaveType} Leave</h3>\n                <p className=\"text-secondary-400\">Applied on {new Date(selectedLeave.appliedDate).toLocaleDateString()}</p>\n              </div>\n              <span className={`px-3 py-1 text-sm rounded-full ${getStatusColor(selectedLeave.status)}`}>\n                {selectedLeave.status}\n              </span>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              <div className=\"space-y-4\">\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Start Date</label>\n                  <p className=\"text-white font-medium\">{new Date(selectedLeave.startDate).toLocaleDateString()}</p>\n                </div>\n                <div>\n                  <label className=\"text-sm text-secondary-400\">End Date</label>\n                  <p className=\"text-white font-medium\">{new Date(selectedLeave.endDate).toLocaleDateString()}</p>\n                </div>\n              </div>\n              <div className=\"space-y-4\">\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Total Days</label>\n                  <p className=\"text-white font-medium\">\n                    {selectedLeave.isHalfDay ? `0.5 day (${selectedLeave.halfDaySession})` : `${selectedLeave.totalDays} days`}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Status</label>\n                  <span className={`inline-block px-3 py-1 text-xs rounded-full ${getStatusColor(selectedLeave.status)}`}>\n                    {selectedLeave.status}\n                  </span>\n                </div>\n              </div>\n            </div>\n\n            <div>\n              <label className=\"text-sm text-secondary-400\">Reason</label>\n              <p className=\"text-white bg-secondary-800/30 p-3 rounded-lg mt-1\">{selectedLeave.reason}</p>\n            </div>\n\n            {selectedLeave.adminComments && (\n              <div>\n                <label className=\"text-sm text-secondary-400\">Admin Comments</label>\n                <p className=\"text-white bg-secondary-800/30 p-3 rounded-lg mt-1\">{selectedLeave.adminComments}</p>\n              </div>\n            )}\n\n            {selectedLeave.actionDate && selectedLeave.status !== 'pending' && (\n              <div>\n                <label className=\"text-sm text-secondary-400\">Action Date</label>\n                <p className=\"text-white font-medium\">{new Date(selectedLeave.actionDate).toLocaleDateString()}</p>\n              </div>\n            )}\n\n            {selectedLeave.status === 'Pending' && (\n              <div className=\"flex justify-end\">\n                <button\n                  onClick={() => {\n                    handleCancelLeave(selectedLeave._id);\n                    setShowViewModal(false);\n                  }}\n                  className=\"px-6 py-3 border border-red-500 text-red-400 rounded-lg hover:bg-red-500/10 transition-colors\"\n                >\n                  Cancel Request\n                </button>\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n\n  const CalendarModal = () => {\n    const getLeaveDates = () => {\n      const dates = [];\n      leaveRequests.forEach(leave => {\n        const start = new Date(leave.startDate);\n        const end = new Date(leave.endDate);\n        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {\n          dates.push({\n            date: new Date(d),\n            status: leave.status,\n            type: leave.leaveType\n          });\n        }\n      });\n      return dates;\n    };\n\n    const leaveDates = getLeaveDates();\n\n    const tileClassName = ({ date, view }) => {\n      if (view === 'month') {\n        const leaveDate = leaveDates.find(d =>\n          d.date.toDateString() === date.toDateString()\n        );\n        if (leaveDate) {\n          switch (leaveDate.status.toLowerCase()) {\n            case 'approved': return 'bg-green-500/20 text-green-400';\n            case 'pending': return 'bg-yellow-500/20 text-yellow-400';\n            case 'rejected': return 'bg-red-500/20 text-red-400';\n            case 'cancelled': return 'bg-gray-500/20 text-gray-400';\n            default: return '';\n          }\n        }\n      }\n      return '';\n    };\n\n    return (\n      <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n        <div className=\"glass-morphism neon-border rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <h2 className=\"text-2xl font-bold text-white\">Leave Calendar</h2>\n            <button\n              onClick={() => setShowCalendarModal(false)}\n              className=\"text-secondary-400 hover:text-white\"\n            >\n              <X className=\"w-6 h-6\" />\n            </button>\n          </div>\n\n          <div className=\"mb-4\">\n            <div className=\"flex flex-wrap gap-4 text-sm\">\n              <div className=\"flex items-center\">\n                <div className=\"w-4 h-4 bg-green-500/20 rounded mr-2\"></div>\n                <span className=\"text-secondary-400\">Approved</span>\n              </div>\n              <div className=\"flex items-center\">\n                <div className=\"w-4 h-4 bg-yellow-500/20 rounded mr-2\"></div>\n                <span className=\"text-secondary-400\">Pending</span>\n              </div>\n              <div className=\"flex items-center\">\n                <div className=\"w-4 h-4 bg-red-500/20 rounded mr-2\"></div>\n                <span className=\"text-secondary-400\">Rejected</span>\n              </div>\n              <div className=\"flex items-center\">\n                <div className=\"w-4 h-4 bg-gray-500/20 rounded mr-2\"></div>\n                <span className=\"text-secondary-400\">Cancelled</span>\n              </div>\n            </div>\n          </div>\n\n          <Calendar\n            tileClassName={tileClassName}\n            className=\"w-full bg-secondary-800/50 rounded-lg p-4\"\n          />\n        </div>\n      </div>\n    );\n  };\n\n  const getLeaveStats = () => {\n    const approved = leaveRequests.filter(l => l.status === 'Approved').length;\n    const pending = leaveRequests.filter(l => l.status === 'Pending').length;\n    const rejected = leaveRequests.filter(l => l.status === 'Rejected').length;\n    const cancelled = leaveRequests.filter(l => l.status === 'Cancelled').length;\n    \n    return { approved, pending, rejected, cancelled, total: leaveRequests.length };\n  };\n\n  const stats = getLeaveStats();\n\n  return (\n    <EmployeeLayout>\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-white\">Leave Requests</h1>\n            <p className=\"text-secondary-400\">Manage your leave applications</p>\n          </div>\n          <button\n            onClick={() => setShowModal(true)}\n            className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 flex items-center\"\n          >\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Apply for Leave\n          </button>\n        </div>\n{/* // Update the JSX for Leave Balance Card (keep only one card) */}\n{/* Leave Balance Card - Single Total Card */}\n<div className=\"grid grid-cols-1 gap-6\">\n  <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n    <div className=\"flex items-center justify-between mb-4\">\n      <h3 className=\"text-lg font-bold text-white\">Total Leave Balance</h3>\n      <CalendarIcon className=\"w-6 h-6 text-neon-pink cursor-pointer\" onClick={() => setShowCalendarModal(true)} />\n    </div>\n    <div className=\"space-y-2\">\n      <div className=\"flex justify-between\">\n        <span className=\"text-secondary-400\">Total Allocated</span>\n        <span className=\"text-white font-medium\">{leaveBalance.total}</span>\n      </div>\n      <div className=\"flex justify-between\">\n        <span className=\"text-secondary-400\">Used</span>\n        <span className=\"text-red-400 font-medium\">{leaveBalance.used}</span>\n      </div>\n      <div className=\"flex justify-between\">\n        <span className=\"text-secondary-400\">Remaining</span>\n        <span className=\"text-green-400 font-medium\">{leaveBalance.remaining}</span>\n      </div>\n      <div className=\"w-full bg-secondary-700 rounded-full h-2 mt-3\">\n        <div \n          className=\"bg-gradient-to-r from-neon-pink to-neon-purple h-2 rounded-full transition-all duration-500\"\n          style={{ width: `${leaveBalance.total > 0 ? (leaveBalance.used / leaveBalance.total) * 100 : 0}%` }}\n        />\n      </div>\n    </div>\n  </div>\n</div>\n\n        {/* Leave Requests Table */}\n        <div className=\"glass-morphism neon-border rounded-2xl overflow-hidden\">\n          <div className=\"p-6 border-b border-secondary-700\">\n            <h2 className=\"text-xl font-bold text-white\">My Leave Requests</h2>\n          </div>\n          \n          {loading ? (\n            <div className=\"p-12 text-center\">\n              <Loader className=\"w-8 h-8 text-neon-pink mx-auto mb-4 animate-spin\" />\n              <p className=\"text-secondary-400\">Loading your leave requests...</p>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n          <table className=\"w-full min-w-[320px] sm:min-w-full\">\n            <thead className=\"border-b border-secondary-700\">\n              <tr>\n                <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Leave Type</th>\n                <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Duration</th>\n                <th className=\"hidden sm:table-cell text-left p-4 sm:p-6 text-secondary-300 font-medium\">Applied Date</th>\n                <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Status</th>\n                <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {leaveRequests.map((leave) => (\n                <tr key={leave._id} className=\"border-b border-secondary-800 hover:bg-secondary-800/30 transition-colors\">\n                  <td className=\"p-4 sm:p-6\">\n                    <span className={`px-2 sm:px-3 py-1 text-sm rounded-full ${getLeaveTypeColor(leave.leaveType)}`}>\n                      {leave.leaveType}\n                    </span>\n                  </td>\n                  <td className=\"p-4 sm:p-6 text-white\">\n                    <div>\n                      <p>{new Date(leave.startDate).toLocaleDateString()} - {new Date(leave.endDate).toLocaleDateString()}</p>\n                      <p className=\"text-sm text-secondary-400\">\n                        {leave.isHalfDay ? `0.5 day (${leave.halfDaySession})` : `${leave.totalDays} days`}\n                      </p>\n                    </div>\n                  </td>\n                  <td className=\"hidden sm:table-cell p-4 sm:p-6 text-secondary-400\">\n                    {new Date(leave.appliedDate).toLocaleDateString()}\n                  </td>\n                  <td className=\"p-4 sm:p-6\">\n                    <span className={`px-2 sm:px-3 py-1 text-xs rounded-full ${getStatusColor(leave.status)}`}>\n                      {leave.status}\n                    </span>\n                  </td>\n                  <td className=\"p-4 sm:p-6\">\n                    <div className=\"flex items-center space-x-2\">\n                      <button\n                        onClick={() => {\n                          setSelectedLeave(leave);\n                          setShowViewModal(true);\n                        }}\n                        className=\"p-2 text-secondary-400 hover:text-blue-400 hover:bg-blue-400/10 rounded-lg transition-colors\"\n                        title=\"View Details\"\n                      >\n                        <Eye className=\"w-4 h-4\" />\n                      </button>\n                      {leave.status === 'Pending' && (\n                        <button\n                          onClick={() => handleCancelLeave(leave._id)}\n                          className=\"p-2 text-secondary-400 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-colors\"\n                          title=\"Cancel Request\"\n                        >\n                          <XCircle className=\"w-4 h-4\" />\n                        </button>\n                      )}\n                    </div>\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n            </div>\n          )}\n\n          {!loading && leaveRequests.length === 0 && (\n            <div className=\"p-12 text-center\">\n              <CalendarIcon className=\"w-12 h-12 text-secondary-600 mx-auto mb-4\" />\n              <h3 className=\"text-lg font-medium text-secondary-400 mb-2\">No leave requests</h3>\n              <p className=\"text-secondary-500\">You haven't applied for any leaves yet.</p>\n            </div>\n          )}\n        </div>\n\n        {/* Quick Stats */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between mb-6\">\n              <h2 className=\"text-xl font-bold text-white\">Leave Statistics</h2>\n              <FileText className=\"w-5 h-5 text-neon-pink\" />\n            </div>\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between p-3 bg-secondary-800/30 rounded-lg\">\n                <span className=\"text-secondary-400\">Total Applications</span>\n                <span className=\"text-white font-bold\">{stats.total}</span>\n              </div>\n              <div className=\"flex items-center justify-between p-3 bg-secondary-800/30 rounded-lg\">\n                <span className=\"text-secondary-400\">Approved</span>\n                <span className=\"text-green-400 font-bold\">{stats.approved}</span>\n              </div>\n              <div className=\"flex items-center justify-between p-3 bg-secondary-800/30 rounded-lg\">\n                <span className=\"text-secondary-400\">Pending</span>\n                <span className=\"text-yellow-400 font-bold\">{stats.pending}</span>\n              </div>\n              <div className=\"flex items-center justify-between p-3 bg-secondary-800/30 rounded-lg\">\n                <span className=\"text-secondary-400\">Rejected</span>\n                <span className=\"text-red-400 font-bold\">{stats.rejected}</span>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between mb-6\">\n              <h2 className=\"text-xl font-bold text-white\">Recent Activity</h2>\n              <Clock className=\"w-5 h-5 text-neon-purple\" />\n            </div>\n            <div className=\"space-y-4\">\n              {leaveRequests.slice(0, 4).map((leave) => (\n                <div key={leave._id} className=\"flex items-center justify-between p-3 bg-secondary-800/30 rounded-lg\">\n                  <div>\n                    <p className=\"text-white font-medium\">{leave.leaveType} Leave</p>\n                    <p className=\"text-sm text-secondary-400\">\n                      {leave.isHalfDay ? `0.5 day` : `${leave.totalDays} days`} • {new Date(leave.appliedDate).toLocaleDateString()}\n                    </p>\n                  </div>\n                  <span className={`px-2 py-1 text-xs rounded-full ${getStatusColor(leave.status)}`}>\n                    {leave.status}\n                  </span>\n                </div>\n              ))}\n              {leaveRequests.length === 0 && (\n                <div className=\"text-center py-8\">\n                  <p className=\"text-secondary-500\">No recent activity</p>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Modals */}\n      {showModal && <ApplyLeaveModal />}\n      {showViewModal && <ViewLeaveModal />}\n      {showCalendarModal && <CalendarModal />}\n    </EmployeeLayout>\n  );\n};\n\nexport default EmployeeLeaveRequests;","path":null,"size_bytes":31126,"size_tokens":null},"frontend/src/utils/faceAPI.js":{"content":"import api from './api';\n\nexport const faceAPI = {\n  saveEmployeeFace: async (employeeId, imageBlob) => {\n    try {\n      const formData = new FormData();\n      formData.append('employeeId', employeeId);\n      formData.append('file', imageBlob, 'face.jpg');\n\n      return await api.post('/face-detection/save-face', formData, {\n        headers: { 'Content-Type': 'multipart/form-data' }\n      });\n    } catch (error) {\n      console.error('Error saving face data:', error);\n      throw error;\n    }\n  },\n\n  registerMultiAngleFace: async (employeeId, frontImage, leftImage, rightImage) => {\n    try {\n      return await api.post('/face-detection/register-multi-angle', {\n        employeeId,\n        frontImage,\n        leftImage,\n        rightImage\n      });\n    } catch (error) {\n      console.error('Error registering multi-angle face:', error);\n      throw error;\n    }\n  },\n\n  analyzeFrameBase64: async (imageBase64) => {\n    try {\n      console.log('faceAPI.analyzeFrameBase64 called, image size:', imageBase64.length);\n      return await api.post('/face-detection/analyze-frame-base64', {\n        image: imageBase64\n      }, {\n        timeout: 30000, // 30 second timeout for face analysis\n        headers: {\n          'Content-Type': 'application/json'\n        }\n      });\n    } catch (error) {\n      console.error('Error analyzing frame:', error);\n      console.error('Error details:', {\n        message: error.message,\n        code: error.code,\n        response: error.response?.data\n      });\n      throw error;\n    }\n  },\n\n  getEmployeeFace: async (employeeId) => {\n    return await api.get(`/face-detection/employee/${employeeId}`);\n  },\n\n  verifyFaceAttendance: async (imageBlob, location) => {\n    try {\n      const formData = new FormData();\n      formData.append('file', imageBlob, 'face.jpg');\n      formData.append('location', JSON.stringify(location));\n\n      console.log('Verifying face attendance, image size:', imageBlob.size, 'bytes');\n\n      return await api.post('/face-detection/verify-attendance', formData, {\n        headers: { 'Content-Type': 'multipart/form-data' },\n        timeout: 30000 // 30 second timeout\n      });\n    } catch (error) {\n      console.error('Error verifying face:', error);\n      console.error('Error details:', {\n        message: error.message,\n        code: error.code,\n        response: error.response?.data\n      });\n      throw error;\n    }\n  },\n\n  verifyVideoFace: async (frames, location) => {\n    try {\n      return await api.post('/face-detection/verify-video', {\n        frames,\n        location\n      });\n    } catch (error) {\n      console.error('Error verifying video face:', error);\n      throw error;\n    }\n  },\n\n  checkLiveness: async (frames) => {\n    try {\n      return await api.post('/face-detection/check-liveness', { frames });\n    } catch (error) {\n      console.error('Error checking liveness:', error);\n      throw error;\n    }\n  },\n\n  registerContinuousVideo: async (employeeId, frames) => {\n    try {\n      return await api.post('/face-detection/register-continuous-video', {\n        employeeId,\n        frames\n      });\n    } catch (error) {\n      console.error('Error registering continuous video:', error);\n      throw error;\n    }\n  },\n\n  verifyLiveVideo: async (frames, location) => {\n    try {\n      return await api.post('/face-detection/verify-live-video', {\n        frames,\n        location\n      });\n    } catch (error) {\n      console.error('Error verifying live video:', error);\n      throw error;\n    }\n  },\n\n  deleteEmployeeFace: async (employeeId) => {\n    return await api.delete(`/face-detection/employee/${employeeId}`);\n  },\n\n  getEmployeesWithoutFace: async () => {\n    return await api.get('/face-detection/employees-without-face');\n  },\n\n  detectFaces: async (imageBlob) => {\n    try {\n      const formData = new FormData();\n      formData.append('file', imageBlob, 'face.jpg');\n\n      return await api.post('/face-detection/detect', formData, {\n        headers: { 'Content-Type': 'multipart/form-data' }\n      });\n    } catch (error) {\n      console.error('Error detecting faces:', error);\n      throw error;\n    }\n  }\n};\n\nexport class CameraHelper {\n  constructor() {\n    this.stream = null;\n    this.videoElement = null;\n  }\n\n  async startCamera(videoElement, constraints = {}) {\n    if (!videoElement) throw new Error('videoElement is required');\n\n    videoElement.autoplay = true;\n    videoElement.muted = true;\n    videoElement.playsInline = true;\n\n    const defaultConstraints = {\n      video: {\n        width: { ideal: 640 },\n        height: { ideal: 480 },\n        facingMode: 'user',\n        frameRate: { ideal: 30 }\n      },\n      audio: false\n    };\n\n    const merged = {\n      video: { ...defaultConstraints.video, ...(constraints.video || {}) },\n      audio: constraints.audio ?? defaultConstraints.audio\n    };\n\n    try {\n      this.stream = await navigator.mediaDevices.getUserMedia(merged);\n      this.videoElement = videoElement;\n      videoElement.srcObject = this.stream;\n\n      await videoElement.play().catch(err => {\n        console.warn('videoElement.play() failed:', err);\n      });\n\n      console.log('Camera started');\n      return true;\n    } catch (error) {\n      console.error('Camera access error:', error);\n      if (error.name === 'NotAllowedError') {\n        throw new Error('Camera permission denied. Please allow camera access.');\n      } else if (error.name === 'NotFoundError') {\n        throw new Error('No camera device found.');\n      } else if (error.name === 'NotReadableError') {\n        throw new Error('Camera is in use by another application.');\n      }\n      throw error;\n    }\n  }\n\n  stopCamera() {\n    if (this.stream) {\n      this.stream.getTracks().forEach(t => t.stop());\n      this.stream = null;\n    }\n    if (this.videoElement) {\n      this.videoElement.srcObject = null;\n      this.videoElement = null;\n    }\n  }\n\n  captureImage(videoElement) {\n    if (!videoElement) return null;\n    \n    const canvas = document.createElement('canvas');\n    canvas.width = videoElement.videoWidth || 640;\n    canvas.height = videoElement.videoHeight || 480;\n    \n    const ctx = canvas.getContext('2d');\n    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);\n    \n    return canvas.toDataURL('image/jpeg', 0.9);\n  }\n\n  async captureImageBlob(videoElement) {\n    if (!videoElement) return null;\n    \n    const canvas = document.createElement('canvas');\n    canvas.width = videoElement.videoWidth || 640;\n    canvas.height = videoElement.videoHeight || 480;\n    \n    const ctx = canvas.getContext('2d');\n    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);\n    \n    return new Promise((resolve) => {\n      canvas.toBlob((blob) => {\n        resolve(blob);\n      }, 'image/jpeg', 0.9);\n    });\n  }\n\n  captureMultipleFrames(videoElement, count = 5, intervalMs = 200) {\n    return new Promise((resolve) => {\n      const frames = [];\n      let captured = 0;\n      \n      const captureFrame = () => {\n        if (captured >= count) {\n          resolve(frames);\n          return;\n        }\n        \n        const image = this.captureImage(videoElement);\n        if (image) {\n          frames.push(image);\n          captured++;\n        }\n        \n        if (captured < count) {\n          setTimeout(captureFrame, intervalMs);\n        } else {\n          resolve(frames);\n        }\n      };\n      \n      captureFrame();\n    });\n  }\n}\n\nexport const cameraHelper = new CameraHelper();\n\nexport default {\n  faceAPI,\n  CameraHelper,\n  cameraHelper\n};\n","path":null,"size_bytes":7505,"size_tokens":null},"backend/config/createIndexes.js":{"content":"const createIndexes = async () => {\n  try {\n    // Import models for index creation\n    const User = require('../models/User');\n    const Employee = require('../models/Employee');\n    // const Attendance = require('../models/Attendance');\n    // const Leave = require('../models/Leave');\n\n    // Create indexes\n    await User.createIndexes();\n    await Employee.createIndexes();\n    // await Attendance.createIndexes();\n    // await Leave.createIndexes();\n\n    console.log('✅ Database indexes created successfully');\n  } catch (error) {\n    console.error('❌ Error creating indexes:', error);\n  }\n};\n\nmodule.exports = createIndexes;\n","path":null,"size_bytes":636,"size_tokens":null},"frontend/src/pages/Admin/admin-employees.ts":{"content":"import React, { useState, useEffect, useRef } from 'react';\nimport { employeeAPI } from '../../utils/api';\nimport AdminLayout from '../../components/Admin/layout/AdminLayout';\nimport { \n  Plus, \n  Search, \n  Filter, \n  Edit, \n  Eye, \n  Trash2, \n  Mail, \n  Phone, \n  MapPin,\n  User,\n  X,\n  Save,\n  UserPlus,\n  Camera,\n  AlertCircle,\n  CheckCircle\n} from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport { useFaceRegistration } from '../../hooks/useFaceRegistration';\n\nconst EmployeeManagement = () => {\n  const [employees, setEmployees] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [filterDepartment, setFilterDepartment] = useState('');\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [showViewModal, setShowViewModal] = useState(false);\n  const [showEditModal, setShowEditModal] = useState(false);\n  const [selectedEmployee, setSelectedEmployee] = useState(null);\n  \n  // Face detection states\n  const [currentStep, setCurrentStep] = useState(1); // 1: Employee Form, 2: Face Registration\n  const [faceRegistrationEnabled, setFaceRegistrationEnabled] = useState(true);\n\n  // Use the face registration hook\n  const {\n    videoRef,\n    canvasRef,\n    isInitialized,\n    faceDetected,\n    isCapturing,\n    capturedFaceData,\n    error: faceError,\n    initialize,\n    captureFace,\n    reset\n  } = useFaceRegistration();\n\n  const [newEmployee, setNewEmployee] = useState({\n    personalInfo: {\n      firstName: '',\n      lastName: '',\n      dateOfBirth: '',\n      gender: '',\n      nationality: 'Indian',\n      maritalStatus: 'Single',\n      bloodGroup: ''\n    },\n    contactInfo: {\n      phone: '',\n      alternatePhone: '',\n      personalEmail: '',\n      address: {\n        street: '',\n        city: '',\n        state: '',\n        pincode: '',\n        country: 'India'\n      },\n      emergencyContact: {\n        name: '',\n        relationship: '',\n        phone: ''\n      }\n    },\n    workInfo: {\n      position: '',\n      department: '',\n      joiningDate: new Date().toISOString().split('T')[0],\n      employmentType: 'Full-time',\n      workLocation: 'Office',\n      team: '',\n      skills: [],\n      workShift: 'Morning'\n    },\n    salaryInfo: {\n      basicSalary: 0,\n      allowances: {\n        hra: 0,\n        medical: 0,\n        transport: 0,\n        other: 0\n      },\n      deductions: {\n        pf: 0,\n        esi: 0,\n        tax: 0,\n        other: 0\n      },\n      currency: 'INR',\n      payFrequency: 'Monthly'\n    },\n    bankInfo: {\n      accountHolderName: '',\n      accountNumber: '',\n      bankName: '',\n      branchName: '',\n      ifscCode: '',\n      accountType: 'Savings'\n    }\n  });\n\n  const departments = ['Engineering', 'Product', 'Design', 'HR', 'Marketing', 'Sales', 'Finance', 'Operations'];\n  const genders = ['Male', 'Female', 'Other'];\n  const bloodGroups = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'];\n  const maritalStatuses = ['Single', 'Married', 'Divorced', 'Widowed'];\n  const employmentTypes = ['Full-time', 'Part-time', 'Contract', 'Intern'];\n  const workLocations = ['Office', 'Remote', 'Hybrid'];\n  const workShifts = ['Morning', 'Afternoon', 'Evening', 'Night', 'Flexible'];\n  const accountTypes = ['Savings', 'Current'];\n\n  // Fetch employees from backend\n  const fetchEmployees = async () => {\n    try {\n      setLoading(true);\n      const response = await employeeAPI.getEmployees();\n      if (response.data.success) {\n        const employeeData = response.data.data?.employees || [];\n        setEmployees(employeeData);\n      }\n    } catch (error) {\n      console.error('Error fetching employees:', error);\n      toast.error('Failed to fetch employees');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchEmployees();\n  }, []);\n\n  // Initialize face detection when modal opens\n  useEffect(() => {\n    if (showAddModal && currentStep === 2 && faceRegistrationEnabled) {\n      initialize();\n    }\n  }, [showAddModal, currentStep, faceRegistrationEnabled, initialize]);\n\n  const filteredEmployees = employees.filter(emp => {\n    const fullName = `${emp.personalInfo?.firstName || ''} ${emp.personalInfo?.lastName || ''}`.toLowerCase();\n    const userEmail = emp.user?.email?.toLowerCase() || '';\n    const position = emp.workInfo?.position?.toLowerCase() || '';\n    const employeeId = emp.employeeId?.toLowerCase() || emp.user?.employeeId?.toLowerCase() || '';\n    \n    const matchesSearch = fullName.includes(searchTerm.toLowerCase()) ||\n                         userEmail.includes(searchTerm.toLowerCase()) ||\n                         position.includes(searchTerm.toLowerCase()) ||\n                         employeeId.includes(searchTerm.toLowerCase());\n    \n    const matchesDepartment = !filterDepartment || emp.workInfo?.department === filterDepartment;\n    return matchesSearch && matchesDepartment;\n  });\n\n  // Handle form submission (Step 1)\n  const handleFormNext = (e) => {\n    e.preventDefault();\n    \n    // Validate required fields\n    if (!newEmployee.personalInfo.firstName || !newEmployee.personalInfo.lastName) {\n      toast.error('First name and last name are required');\n      return;\n    }\n    \n    if (!newEmployee.contactInfo.personalEmail) {\n      toast.error('Email is required');\n      return;\n    }\n    \n    if (!newEmployee.workInfo.position || !newEmployee.workInfo.department) {\n      toast.error('Position and department are required');\n      return;\n    }\n\n    if (faceRegistrationEnabled) {\n      setCurrentStep(2);\n    } else {\n      handleCreateEmployee();\n    }\n  };\n\n  // Handle face capture using the hook\n  const handleCaptureFace = async () => {\n    const faceData = await captureFace();\n    if (faceData) {\n      // Face data is already set in the hook's capturedFaceData state\n      // No additional processing needed here\n    }\n  };\n\n  // Handle final employee creation\n  const handleCreateEmployee = async () => {\n    try {\n      let employeeDataWithFace = { ...newEmployee };\n      \n      // Add face data if captured\n      if (capturedFaceData) {\n        employeeDataWithFace.faceDescriptor = capturedFaceData.descriptor;\n        employeeDataWithFace.faceImage = capturedFaceData.thumbnail;\n        employeeDataWithFace.hasFaceRegistered = true;\n      }\n\n      const response = await employeeAPI.createEmployee(employeeDataWithFace);\n      \n      if (response.data.success) {\n        await fetchEmployees();\n        resetForm();\n        setShowAddModal(false);\n        \n        const employeeName = `${newEmployee.personalInfo.firstName} ${newEmployee.personalInfo.lastName}`;\n        toast.success(`Employee ${employeeName} added successfully${capturedFaceData ? ' with face registration' : ''}!`);\n      }\n    } catch (error) {\n      console.error('Error creating employee:', error);\n      toast.error(error.response?.data?.message || 'Failed to create employee');\n    }\n  };\n\n  const resetForm = () => {\n    setNewEmployee({\n      personalInfo: {\n        firstName: '',\n        lastName: '',\n        dateOfBirth: '',\n        gender: '',\n        nationality: 'Indian',\n        maritalStatus: 'Single',\n        bloodGroup: ''\n      },\n      contactInfo: {\n        phone: '',\n        alternatePhone: '',\n        personalEmail: '',\n        address: {\n          street: '',\n          city: '',\n          state: '',\n          pincode: '',\n          country: 'India'\n        },\n        emergencyContact: {\n          name: '',\n          relationship: '',\n          phone: ''\n        }\n      },\n      workInfo: {\n        position: '',\n        department: '',\n        joiningDate: new Date().toISOString().split('T')[0],\n        employmentType: 'Full-time',\n        workLocation: 'Office',\n        team: '',\n        skills: [],\n        workShift: 'Morning'\n      },\n      salaryInfo: {\n        basicSalary: 0,\n        allowances: {\n          hra: 0,\n          medical: 0,\n          transport: 0,\n          other: 0\n        },\n        deductions: {\n          pf: 0,\n          esi: 0,\n          tax: 0,\n          other: 0\n        },\n        currency: 'INR',\n        payFrequency: 'Monthly'\n      },\n      bankInfo: {\n        accountHolderName: '',\n        accountNumber: '',\n        bankName: '',\n        branchName: '',\n        ifscCode: '',\n        accountType: 'Savings'\n      }\n    });\n    setCurrentStep(1);\n    reset(); // Use the hook's reset function\n  };\n\n  const handleEditEmployee = async (e) => {\n    e.preventDefault();\n    \n    try {\n      const response = await employeeAPI.updateEmployee(selectedEmployee._id, selectedEmployee);\n      if (response.data.success) {\n        await fetchEmployees();\n        setShowEditModal(false);\n        toast.success('Employee updated successfully!');\n      }\n    } catch (error) {\n      console.error('Error updating employee:', error);\n      toast.error(error.response?.data?.message || 'Failed to update employee');\n    }\n  };\n\n  const handleDeleteEmployee = async (id) => {\n    if (window.confirm('Are you sure you want to delete this employee? This will also delete their user account.')) {\n      try {\n        const response = await employeeAPI.deleteEmployee(id);\n        if (response.data.success) {\n          await fetchEmployees();\n          toast.success('Employee deleted successfully!');\n        }\n      } catch (error) {\n        console.error('Error deleting employee:', error);\n        toast.error(error.response?.data?.message || 'Failed to delete employee');\n      }\n    }\n  };\n\n  const AddEmployeeModal = () => {\n    const updateEmployee = (field, value, nestedField = null, subNestedField = null) => {\n      if (subNestedField) {\n        setNewEmployee({\n          ...newEmployee,\n          [field]: {\n            ...newEmployee[field],\n            [nestedField]: {\n              ...newEmployee[field][nestedField],\n              [subNestedField]: value\n            }\n          }\n        });\n      } else if (nestedField) {\n        setNewEmployee({\n          ...newEmployee,\n          [field]: {\n            ...newEmployee[field],\n            [nestedField]: value\n          }\n        });\n      } else {\n        setNewEmployee({\n          ...newEmployee,\n          [field]: value\n        });\n      }\n    };\n\n    return (\n      <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n        <div className=\"bg-gray-900 neon-border rounded-2xl p-6 w-full max-w-6xl max-h-[90vh] overflow-y-auto\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <div className=\"flex items-center space-x-4\">\n              <h2 className=\"text-2xl font-bold text-white\">Add New Employee</h2>\n              <div className=\"flex items-center space-x-2\">\n                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${\n                  currentStep >= 1 ? 'bg-neon-pink text-white' : 'bg-secondary-600 text-secondary-400'\n                }`}>\n                  1\n                </div>\n                <div className={`w-8 h-1 ${currentStep >= 2 ? 'bg-neon-pink' : 'bg-secondary-600'}`}></div>\n                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${\n                  currentStep >= 2 ? 'bg-neon-pink text-white' : 'bg-secondary-600 text-secondary-400'\n                }`}>\n                  2\n                </div>\n              </div>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <label className=\"flex items-center space-x-2 text-sm text-secondary-300\">\n                <input\n                  type=\"checkbox\"\n                  checked={faceRegistrationEnabled}\n                  onChange={(e) => setFaceRegistrationEnabled(e.target.checked)}\n                  className=\"rounded border-secondary-600 text-neon-pink focus:ring-neon-pink focus:ring-offset-0\"\n                />\n                <span>Enable Face Registration</span>\n              </label>\n              <button \n                onClick={resetForm}\n                className=\"text-secondary-400 hover:text-white\"\n              >\n                <X className=\"w-6 h-6\" />\n              </button>\n            </div>\n          </div>\n\n          {currentStep === 1 ? (\n            // Employee Form\n            <form onSubmit={handleFormNext} className=\"space-y-8\">\n              {/* Personal Information */}\n              <div className=\"space-y-4\">\n                <h3 className=\"text-lg font-bold text-white border-b border-secondary-600 pb-2\">Personal Information</h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">First Name *</label>\n                    <input\n                      type=\"text\"\n                      value={newEmployee.personalInfo.firstName}\n                      onChange={(e) => updateEmployee('personalInfo', e.target.value, 'firstName')}\n                      className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                      required\n                    />\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Last Name *</label>\n                    <input\n                      type=\"text\"\n                      value={newEmployee.personalInfo.lastName}\n                      onChange={(e) => updateEmployee('personalInfo', e.target.value, 'lastName')}\n                      className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                      required\n                    />\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Date of Birth *</label>\n                    <input\n                      type=\"date\"\n                      value={newEmployee.personalInfo.dateOfBirth}\n                      onChange={(e) => updateEmployee('personalInfo', e.target.value, 'dateOfBirth')}\n                      className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                      required\n                    />\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Gender *</label>\n                    <select\n                      value={newEmployee.personalInfo.gender}\n                      onChange={(e) => updateEmployee('personalInfo', e.target.value, 'gender')}\n                      className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                      required\n                    >\n                      <option value=\"\">Select Gender</option>\n                      {genders.map(gender => (\n                        <option key={gender} value={gender}>{gender}</option>\n                      ))}\n                    </select>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Blood Group</label>\n                    <select\n                      value={newEmployee.personalInfo.bloodGroup}\n                      onChange={(e) => updateEmployee('personalInfo', e.target.value, 'bloodGroup')}\n                      className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    >\n                      <option value=\"\">Select Blood Group</option>\n                      {bloodGroups.map(bg => (\n                        <option key={bg} value={bg}>{bg}</option>\n                      ))}\n                    </select>\n                  </div>\n                </div>\n              </div>\n\n              {/* Contact Information */}\n              <div className=\"space-y-4\">\n                <h3 className=\"text-lg font-bold text-white border-b border-secondary-600 pb-2\">Contact Information</h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Email *</label>\n                    <input\n                      type=\"email\"\n                      value={newEmployee.contactInfo.personalEmail}\n                      onChange={(e) => updateEmployee('contactInfo', e.target.value, 'personalEmail')}\n                      className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                      required\n                    />\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Phone *</label>\n                    <input\n                      type=\"tel\"\n                      value={newEmployee.contactInfo.phone}\n                      onChange={(e) => updateEmployee('contactInfo', e.target.value, 'phone')}\n                      className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                      required\n                    />\n                  </div>\n                  <div className=\"md:col-span-2\">\n                    <h4 className=\"text-md font-semibold text-white mb-3\">Emergency Contact</h4>\n                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                      <div>\n                        <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Name *</label>\n                        <input\n                          type=\"text\"\n                          value={newEmployee.contactInfo.emergencyContact.name}\n                          onChange={(e) => updateEmployee('contactInfo', e.target.value, 'emergencyContact', 'name')}\n                          className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                          required\n                        />\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Relationship *</label>\n                        <input\n                          type=\"text\"\n                          value={newEmployee.contactInfo.emergencyContact.relationship}\n                          onChange={(e) => updateEmployee('contactInfo', e.target.value, 'emergencyContact', 'relationship')}\n                          className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                          required\n                        />\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Phone *</label>\n                        <input\n                          type=\"tel\"\n                          value={newEmployee.contactInfo.emergencyContact.phone}\n                          onChange={(e) => updateEmployee('contactInfo', e.target.value, 'emergencyContact', 'phone')}\n                          className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                          required\n                        />\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              {/* Work Information */}\n              <div className=\"space-y-4\">\n                <h3 className=\"text-lg font-bold text-white border-b border-secondary-600 pb-2\">Work Information</h3>\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Position *</label>\n                    <input\n                      type=\"text\"\n                      value={newEmployee.workInfo.position}\n                      onChange={(e) => updateEmployee('workInfo', e.target.value, 'position')}\n                      className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                      required\n                    />\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Department *</label>\n                    <select\n                      value={newEmployee.workInfo.department}\n                      onChange={(e) => updateEmployee('workInfo', e.target.value, 'department')}\n                      className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                      required\n                    >\n                      <option value=\"\">Select Department</option>\n                      {departments.map(dept => (\n                        <option key={dept} value={dept}>{dept}</option>\n                      ))}\n                    </select>\n                  </div>\n                  <div>\n                    <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Basic Salary *</label>\n                    <input\n                      type=\"number\"\n                      value={newEmployee.salaryInfo.basicSalary}\n                      onChange={(e) => updateEmployee('salaryInfo', parseFloat(e.target.value) || 0, 'basicSalary')}\n                      className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                      required\n                      min=\"0\"\n                    />\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"flex justify-end space-x-4 pt-6 border-t border-secondary-600\">\n                <button\n                  type=\"button\"\n                  onClick={resetForm}\n                  className=\"px-6 py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700/50 transition-colors\"\n                >\n                  Cancel\n                </button>\n                <button\n                  type=\"submit\"\n                  className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300\"\n                >\n                  {faceRegistrationEnabled ? 'Next: Face Registration' : 'Create Employee'}\n                </button>\n              </div>\n            </form>\n          ) : (\n            // Face Registration Step\n            <div className=\"space-y-6\">\n              <div className=\"text-center\">\n                <h3 className=\"text-lg font-bold text-white mb-2\">\n                  Face Registration for {newEmployee.personalInfo.firstName} {newEmployee.personalInfo.lastName}\n                </h3>\n                <p className=\"text-secondary-400\">Position your face in the frame to capture biometric data</p>\n              </div>\n\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                {/* Camera Feed */}\n                <div className=\"space-y-4\">\n                  <div className=\"relative bg-black rounded-lg overflow-hidden aspect-video\">\n                    <video\n                      ref={videoRef}\n                      width=\"640\"\n                      height=\"480\"\n                      className=\"w-full h-full object-cover\"\n                      autoPlay\n                      muted\n                      playsInline\n                    />\n                    <canvas\n                      ref={canvasRef}\n                      width=\"640\"\n                      height=\"480\"\n                      className=\"absolute top-0 left-0 w-full h-full\"\n                    />\n                    \n                    {!isInitialized && (\n                      <div className=\"absolute inset-0 bg-black/50 flex items-center justify-center\">\n                        <div className=\"text-white text-center\">\n                          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-neon-pink mx-auto mb-2\"></div>\n                          <p>Initializing camera and face models...</p>\n                        </div>\n                      </div>\n                    )}\n                  </div>\n\n                  <div className=\"flex items-center justify-between p-3 bg-secondary-800/50 rounded-lg\">\n                    <div className=\"flex items-center space-x-2\">\n                      <div className={`w-3 h-3 rounded-full ${faceDetected ? 'bg-green-400' : 'bg-red-400'} animate-pulse`}></div>\n                      <span className=\"text-sm text-secondary-400\">\n                        {faceError ? `Error: ${faceError}` : \n                         !isInitialized ? 'Initializing camera...' :\n                         faceDetected ? 'Face detected - Ready to capture' : \n                         'No face detected - Position face in frame'}\n                      </span>\n                    </div>\n                    <div className=\"text-xs text-secondary-500\">\n                      {isInitialized ? 'Ready' : 'Loading...'}\n                    </div>\n                  </div>\n                </div>\n\n                {/* Instructions & Actions */}\n                <div className=\"space-y-6\">\n                  {/* Captured Face Preview */}\n                  {capturedFaceData && (\n                    <div className=\"bg-secondary-800/30 rounded-lg p-4\">\n                      <div className=\"flex items-center space-x-3 mb-3\">\n                        <CheckCircle className=\"w-5 h-5 text-green-400\" />\n                        <span className=\"text-white font-medium\">Face Captured Successfully</span>\n                      </div>\n                      <div className=\"flex items-center space-x-4\">\n                        <img \n                          src={capturedFaceData.thumbnail} \n                          alt=\"Captured face\"\n                          className=\"w-16 h-16 rounded-lg object-cover border border-secondary-600\"\n                        />\n                        <div className=\"text-sm\">\n                          <p className=\"text-white\">Confidence: {capturedFaceData.confidence}%</p>\n                          <p className=\"text-secondary-400\">Descriptor: 128 dimensions</p>\n                        </div>\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Instructions */}\n                  <div className=\"space-y-3\">\n                    <h4 className=\"text-white font-medium\">Face Registration Guidelines</h4>\n                    <div className=\"grid grid-cols-1 gap-3 text-sm\">\n                      <div className=\"flex items-start space-x-2\">\n                        <AlertCircle className=\"w-4 h-4 text-neon-pink mt-0.5 flex-shrink-0\" />\n                        <div>\n                          <p className=\"text-white\">Good Lighting</p>\n                          <p className=\"text-secondary-400\">Ensure face is well-lit and clearly visible</p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-start space-x-2\">\n                        <AlertCircle className=\"w-4 h-4 text-neon-pink mt-0.5 flex-shrink-0\" />\n                        <div>\n                          <p className=\"text-white\">Center Your Face</p>\n                          <p className=\"text-secondary-400\">Look directly at camera with neutral expression</p>\n                        </div>\n                      </div>\n                      <div className=\"flex items-start space-x-2\">\n                        <AlertCircle className=\"w-4 h-4 text-neon-pink mt-0.5 flex-shrink-0\" />\n                        <div>\n                          <p className=\"text-white\">No Obstructions</p>\n                          <p className=\"text-secondary-400\">Remove glasses, hats, or face coverings</p>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* Action Button */}\n                  {!capturedFaceData ? (\n                    <button\n                      onClick={handleCaptureFace}\n                      disabled={!faceDetected || isCapturing || !isInitialized}\n                      className=\"w-full py-4 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed\"\n                    >\n                      <Camera className=\"w-5 h-5\" />\n                      <span>{isCapturing ? 'Capturing Face...' : 'Capture Face'}</span>\n                    </button>\n                  ) : (\n                    <button\n                      onClick={reset}\n                      className=\"w-full py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700/50 transition-colors flex items-center justify-center space-x-2\"\n                    >\n                      <Camera className=\"w-4 h-4\" />\n                      <span>Recapture Face</span>\n                    </button>\n                  )}\n                </div>\n              </div>\n\n              <div className=\"flex justify-end space-x-4 pt-6 border-t border-secondary-600\">\n                <button\n                  type=\"button\"\n                  onClick={() => setCurrentStep(1)}\n                  className=\"px-6 py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700/50 transition-colors\"\n                >\n                  Back\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleCreateEmployee}\n                  className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 flex items-center space-x-2\"\n                >\n                  <Save className=\"w-4 h-4\" />\n                  <span>Create Employee {capturedFaceData ? 'with Face Data' : ''}</span>\n                </button>\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n    );\n  };\n\n  // View Modal (existing)\n  const ViewModal = () => (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-gray-900 neon-border rounded-2xl p-6 w-full max-w-6xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h2 className=\"text-2xl font-bold text-white\">Employee Details</h2>\n          <button \n            onClick={() => setShowViewModal(false)}\n            className=\"text-secondary-400 hover:text-white\"\n          >\n            <X className=\"w-6 h-6\" />\n          </button>\n        </div>\n        \n        {selectedEmployee && (\n          <div className=\"space-y-6\">\n            <div className=\"flex items-center space-x-4 p-4 bg-secondary-800/30 rounded-lg\">\n              <div className=\"w-16 h-16 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                <User className=\"w-8 h-8 text-white\" />\n              </div>\n              <div>\n                <h3 className=\"text-xl font-bold text-white\">{selectedEmployee.fullName}</h3>\n                <p className=\"text-neon-pink\">{selectedEmployee.workInfo?.position}</p>\n                <p className=\"text-secondary-400\">{selectedEmployee.workInfo?.department}</p>\n                <p className=\"text-secondary-400 text-sm\">ID: {selectedEmployee.employeeId || selectedEmployee.user?.employeeId}</p>\n                {selectedEmployee.hasFaceRegistered && (\n                  <span className=\"inline-block px-2 py-1 text-xs rounded-full bg-green-400/20 text-green-400 mt-1\">\n                    Face Registered\n                  </span>\n                )}\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n\n  // Edit Modal (simplified version)\n  const EditModal = () => (\n    <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n      <div className=\"bg-gray-900 neon-border rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h2 className=\"text-2xl font-bold text-white\">Edit Employee</h2>\n          <button \n            onClick={() => setShowEditModal(false)}\n            className=\"text-secondary-400 hover:text-white\"\n          >\n            <X className=\"w-6 h-6\" />\n          </button>\n        </div>\n        <form onSubmit={handleEditEmployee}>\n          <div className=\"text-center py-8\">\n            <p className=\"text-secondary-400\">Edit functionality simplified for this demo</p>\n          </div>\n          <div className=\"flex justify-end space-x-4 pt-6 border-t border-secondary-600\">\n            <button\n              type=\"button\"\n              onClick={() => setShowEditModal(false)}\n              className=\"px-6 py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700/50 transition-colors\"\n            >\n              Cancel\n            </button>\n            <button\n              type=\"submit\"\n              className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300\"\n            >\n              Update Employee\n            </button>\n          </div>\n        </form>\n      </div>\n    </div>\n  );\n\n  if (loading) {\n    return (\n      <AdminLayout>\n        <div className=\"flex items-center justify-center min-h-screen\">\n          <div className=\"text-white text-xl\">Loading employees...</div>\n        </div>\n      </AdminLayout>\n    );\n  }\n\n  return (\n    <AdminLayout>\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n          <div>\n            <p className=\"text-2xl font-bold text-white\">Employee Management</p>\n            <p className=\"text-secondary-400\">Manage your company's workforce with integrated face registration</p>\n          </div>\n          <button\n            onClick={() => setShowAddModal(true)}\n            className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 flex items-center\"\n          >\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Add Employee\n          </button>\n        </div>\n\n        {/* Filters */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <div className=\"flex flex-col md:flex-row gap-4\">\n            <div className=\"relative flex-1\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n              <input\n                type=\"text\"\n                placeholder=\"Search employees...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n              />\n            </div>\n            <div className=\"relative\">\n              <Filter className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n              <select\n                value={filterDepartment}\n                onChange={(e) => setFilterDepartment(e.target.value)}\n                className=\"pl-10 pr-8 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n              >\n                <option value=\"\">All Departments</option>\n                {departments.map(dept => (\n                  <option key={dept} value={dept}>{dept}</option>\n                ))}\n              </select>\n            </div>\n          </div>\n        </div>\n\n        {/* Employee Stats */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-2xl font-bold text-white\">{employees.length}</h3>\n                <p className=\"text-secondary-400\">Total Employees</p>\n              </div>\n              <div className=\"w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center\">\n                <User className=\"w-6 h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-2xl font-bold text-white\">\n                  {employees.filter(e => e.hasFaceRegistered).length}\n                </h3>\n                <p className=\"text-secondary-400\">Face Registered</p>\n              </div>\n              <div className=\"w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center\">\n                <Camera className=\"w-6 h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-2xl font-bold text-white\">\n                  {new Set(employees.map(e => e.workInfo?.department).filter(Boolean)).size}\n                </h3>\n                <p className=\"text-secondary-400\">Departments</p>\n              </div>\n              <div className=\"w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg flex items-center justify-center\">\n                <UserPlus className=\"w-6 h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-2xl font-bold text-white\">\n                  {employees.filter(e => e.status === 'Active' || !e.status).length}\n                </h3>\n                <p className=\"text-secondary-400\">Active</p>\n              </div>\n              <div className=\"w-12 h-12 bg-gradient-to-r from-pink-500 to-pink-600 rounded-lg flex items-center justify-center\">\n                <UserPlus className=\"w-6 h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Employee Table */}\n        <div className=\"glass-morphism neon-border rounded-2xl overflow-hidden\">\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full\">\n              <thead className=\"border-b border-secondary-700\">\n                <tr>\n                  <th className=\"text-left p-6 text-secondary-300 font-medium\">Employee</th>\n                  <th className=\"text-left p-6 text-secondary-300 font-medium\">Position</th>\n                  <th className=\"text-left p-6 text-secondary-300 font-medium\">Department</th>\n                  <th className=\"text-left p-6 text-secondary-300 font-medium\">Face Status</th>\n                  <th className=\"text-left p-6 text-secondary-300 font-medium\">Status</th>\n                  <th className=\"text-left p-6 text-secondary-300 font-medium\">Actions</th>\n                </tr>\n              </thead>\n              <tbody>\n                {filteredEmployees.map((employee) => (\n                  <tr key={employee._id} className=\"border-b border-secondary-800 hover:bg-secondary-800/30 transition-colors\">\n                    <td className=\"p-6\">\n                      <div className=\"flex items-center space-x-3\">\n                        <div className=\"w-10 h-10 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                          <User className=\"w-5 h-5 text-white\" />\n                        </div>\n                        <div>\n                          <p className=\"text-white font-medium\">{employee.fullName}</p>\n                          <p className=\"text-secondary-400 text-sm flex items-center\">\n                            <Mail className=\"w-3 h-3 mr-1\" />\n                            {employee.user?.email || employee.contactInfo?.personalEmail}\n                          </p>\n                          <p className=\"text-secondary-400 text-xs\">ID: {employee.employeeId || employee.user?.employeeId}</p>\n                        </div>\n                      </div>\n                    </td>\n                    <td className=\"p-6 text-white\">{employee.workInfo?.position}</td>\n                    <td className=\"p-6\">\n                      <span className=\"px-3 py-1 text-xs rounded-full bg-secondary-700 text-secondary-300\">\n                        {employee.workInfo?.department}\n                      </span>\n                    </td>\n                    <td className=\"p-6\">\n                      <span className={`px-3 py-1 text-xs rounded-full flex items-center space-x-1 w-fit ${\n                        employee.hasFaceRegistered\n                          ? 'bg-green-400/20 text-green-400' \n                          : 'bg-yellow-400/20 text-yellow-400'\n                      }`}>\n                        <Camera className=\"w-3 h-3\" />\n                        <span>{employee.hasFaceRegistered ? 'Registered' : 'Pending'}</span>\n                      </span>\n                    </td>\n                    <td className=\"p-6\">\n                      <span className={`px-3 py-1 text-xs rounded-full ${\n                        employee.status === 'Active' || !employee.status\n                          ? 'bg-green-400/20 text-green-400' \n                          : 'bg-red-400/20 text-red-400'\n                      }`}>\n                        {employee.status || 'Active'}\n                      </span>\n                    </td>\n                    <td className=\"p-6\">\n                      <div className=\"flex items-center space-x-2\">\n                        <button\n                          onClick={() => {\n                            setSelectedEmployee(employee);\n                            setShowViewModal(true);\n                          }}\n                          className=\"p-2 text-secondary-400 hover:text-blue-400 hover:bg-blue-400/10 rounded-lg transition-colors\"\n                          title=\"View Details\"\n                        >\n                          <Eye className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                          onClick={() => {\n                            setSelectedEmployee(employee);\n                            setShowEditModal(true);\n                          }}\n                          className=\"p-2 text-secondary-400 hover:text-neon-pink hover:bg-neon-pink/10 rounded-lg transition-colors\"\n                          title=\"Edit\"\n                        >\n                          <Edit className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                          onClick={() => handleDeleteEmployee(employee._id)}\n                          className=\"p-2 text-secondary-400 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-colors\"\n                          title=\"Delete\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </button>\n                      </div>\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n\n          {filteredEmployees.length === 0 && (\n            <div className=\"p-12 text-center\">\n              <User className=\"w-12 h-12 text-secondary-600 mx-auto mb-4\" />\n              <h3 className=\"text-lg font-medium text-secondary-400 mb-2\">No employees found</h3>\n              <p className=\"text-secondary-500\">\n                {searchTerm || filterDepartment \n                  ? 'Try adjusting your search filters' \n                  : 'Start by adding your first employee'}\n              </p>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Modals */}\n      {showAddModal && <AddEmployeeModal />}\n      {showEditModal && <EditModal />}\n      {showViewModal && <ViewModal />}\n    </AdminLayout>\n  );\n};\n\nexport default EmployeeManagement;","path":null,"size_bytes":45223,"size_tokens":null},"frontend/src/pages/Employee/ProblemStatementPage.jsx":{"content":"// src/pages/Employee/ProblemStatementPage.js\nimport React, { useState, useEffect } from 'react';\nimport EmployeeLayout from '../../components/Employee/EmployeeLayout/EmployeeLayout';\nimport { \n  AlertCircle, \n  Plus, \n  CheckCircle, \n  User,\n  X\n} from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport axios from 'axios';\n\nconst ProblemStatementPage = () => {\n  const [problems, setProblems] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [newProblem, setNewProblem] = useState('');\n  const [employeeData, setEmployeeData] = useState(null);\n\n  // Use relative path for Vite proxy\n  const API_BASE = '/api';\n  const getAuthToken = () => localStorage.getItem('token');\n\n  useEffect(() => {\n    const fetchData = async () => {\n      try {\n        setLoading(true);\n        \n        // Get employee data\n        const profileRes = await axios.get(`${API_BASE}/auth/me`, {\n          headers: { Authorization: `Bearer ${getAuthToken()}` }\n        });\n        if (profileRes.data?.success) {\n          setEmployeeData(profileRes.data.data);\n        }\n\n        // Get all problems\n        const problemsRes = await axios.get(`${API_BASE}/problems`, {\n          headers: { Authorization: `Bearer ${getAuthToken()}` }\n        });\n        if (problemsRes.data?.success) {\n          setProblems(problemsRes.data.data || []);\n        }\n      } catch (err) {\n        console.error('Failed to load problems:', err);\n        toast.error('Failed to load problems');\n      } finally {\n        setLoading(false);\n      }\n    };\n    fetchData();\n  }, []);\n\n  const handleAddProblem = async () => {\n    if (!newProblem.trim()) {\n      toast.error('Please enter a problem description');\n      return;\n    }\n\n    try {\n      const res = await axios.post(`${API_BASE}/problems`, \n        { description: newProblem },\n        { headers: { Authorization: `Bearer ${getAuthToken()}` } }\n      );\n      if (res.data?.success) {\n        setProblems(prev => [res.data.data, ...prev]);\n        setNewProblem('');\n        setShowAddModal(false);\n        toast.success('Problem reported successfully!');\n      }\n    } catch (err) {\n      toast.error(err.response?.data?.message || 'Failed to report problem');\n    }\n  };\n\n  const handleSolveProblem = async (problemId) => {\n    try {\n      const res = await axios.patch(`${API_BASE}/problems/${problemId}/solve`, \n        {},\n        { headers: { Authorization: `Bearer ${getAuthToken()}` } }\n      );\n      if (res.data?.success) {\n        setProblems(prev =>\n          prev.map(p => p._id === problemId ? res.data.data : p)\n        );\n        toast.success('Problem marked as solved!');\n      }\n    } catch (err) {\n      toast.error(err.response?.data?.message || 'Failed to solve problem');\n    }\n  };\n\n  // ... rest of your JSX remains unchanged ...\n\n  if (loading) {\n    return (\n      <EmployeeLayout>\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"text-white\">Loading problems...</div>\n        </div>\n      </EmployeeLayout>\n    );\n  }\n\n  return (\n    <EmployeeLayout employeeData={employeeData}>\n      <div className=\"space-y-6\">\n        <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n          <div>\n            <h1 className=\"text-2xl font-bold text-white\">Problem Statement</h1>\n            <p className=\"text-secondary-400\">Report issues and track resolutions</p>\n          </div>\n          <button\n            onClick={() => setShowAddModal(true)}\n            className=\"px-4 py-2 bg-gradient-to-r from-neon-pink to-neon-purple text-white rounded-lg flex items-center\"\n          >\n            <Plus className=\"w-4 h-4 mr-2\" />\n            Add Problem\n          </button>\n        </div>\n\n        {/* Problems Table */}\n        <div className=\"glass-morphism neon-border rounded-2xl overflow-hidden\">\n          {problems.length === 0 ? (\n            <div className=\"p-6 sm:p-12 text-center\">\n              <AlertCircle className=\"w-12 h-12 text-secondary-600 mx-auto mb-4\" />\n              <h3 className=\"text-lg font-medium text-secondary-400 mb-2\">No problems reported</h3>\n              <p className=\"text-secondary-500\">Click \"Add Problem\" to report an issue</p>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n                {/* Responsive card view for small screens */}\n                <div className=\"block sm:hidden space-y-4\">\n                  {problems.map(problem => (\n                    <div key={problem._id} className=\"glass-morphism neon-border rounded-2xl p-4 space-y-2\">\n                      <div className=\"flex items-center space-x-2\">\n                        <AlertCircle className={`w-5 h-5 ${problem.status === 'Solved' ? 'text-green-400' : 'text-yellow-400'}`} />\n                        <span className=\"text-white font-semibold break-words\">{problem.description}</span>\n                      </div>\n                      <div className=\"flex items-center space-x-2\">\n                        <div className=\"w-8 h-8 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center\">\n                          <User className=\"w-4 h-4 text-white\" />\n                        </div>\n                        <span className=\"text-white\">\n                          {problem.reportedBy?.personalInfo?.firstName} {problem.reportedBy?.personalInfo?.lastName}\n                        </span>\n                      </div>\n                      <div>\n                        {problem.status === 'Solved' ? (\n                          <span className=\"inline-flex items-center space-x-1 px-3 py-1 rounded-full bg-green-400/20 text-green-400 text-sm\">\n                            <CheckCircle className=\"w-4 h-4\" />\n                            <span>Solved</span>\n                            {problem.solvedBy && (\n                              <span className=\"ml-2\">\n                                by {problem.solvedBy.personalInfo?.firstName} {problem.solvedBy.personalInfo?.lastName}\n                              </span>\n                            )}\n                          </span>\n                        ) : (\n                          <span className=\"px-3 py-1 rounded-full bg-yellow-400/20 text-yellow-400 text-sm\">\n                            Pending\n                          </span>\n                        )}\n                      </div>\n                      <div>\n                        {problem.status !== 'Solved' && (\n                          <button\n                            onClick={() => handleSolveProblem(problem._id)}\n                            className=\"w-full px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-center\"\n                          >\n                            Mark as Solved\n                          </button>\n                        )}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n\n                {/* Table view for sm and larger screens */}\n                <div className=\"hidden sm:block overflow-x-auto\">\n                  <table className=\"w-full min-w-[600px]\">\n                    <thead className=\"border-b border-secondary-700\">\n                      <tr>\n                        <th className=\"text-left p-2 sm:p-4 text-secondary-300 font-medium\">Problem</th>\n                        <th className=\"text-left p-2 sm:p-4 text-secondary-300 font-medium\">Reported By</th>\n                        <th className=\"text-left p-2 sm:p-4 text-secondary-300 font-medium\">Status</th>\n                        <th className=\"text-left p-2 sm:p-4 text-secondary-300 font-medium\">Actions</th>\n                      </tr>\n                    </thead>\n                    <tbody>\n                      {problems.map(problem => (\n                        <tr key={problem._id} className=\"border-b border-secondary-800 hover:bg-secondary-800/30\">\n                          <td className=\"p-2 sm:p-4 text-white max-w-xs sm:max-w-md\">\n                            <div className=\"flex items-start space-x-2 sm:space-x-3\">\n                              <AlertCircle className={`w-4 h-4 sm:w-5 sm:h-5 mt-0.5 ${problem.status === 'Solved' ? 'text-green-400' : 'text-yellow-400'}`} />\n                              <span className=\"text-sm sm:text-base break-words\">{problem.description}</span>\n                            </div>\n                          </td>\n                          <td className=\"p-2 sm:p-4\">\n                            <div className=\"flex items-center space-x-2\">\n                              <div className=\"w-6 h-6 sm:w-8 sm:h-8 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center\">\n                                <User className=\"w-3 h-3 sm:w-4 sm:h-4 text-white\" />\n                              </div>\n                              <span className=\"text-white text-sm sm:text-base\">\n                                {problem.reportedBy?.personalInfo?.firstName} {problem.reportedBy?.personalInfo?.lastName}\n                              </span>\n                            </div>\n                          </td>\n                          <td className=\"p-2 sm:p-4\">\n                            {problem.status === 'Solved' ? (\n                              <span className=\"inline-flex items-center space-x-1 px-2 sm:px-3 py-1 rounded-full bg-green-400/20 text-green-400 text-xs sm:text-sm\">\n                                <CheckCircle className=\"w-2 h-2 sm:w-3 sm:h-3\" />\n                                <span>Solved</span>\n                                {problem.solvedBy && (\n                                  <span className=\"ml-1 sm:ml-2 hidden sm:inline\">\n                                    by {problem.solvedBy.personalInfo?.firstName} {problem.solvedBy.personalInfo?.lastName}\n                                  </span>\n                                )}\n                              </span>\n                            ) : (\n                              <span className=\"px-2 sm:px-3 py-1 rounded-full bg-yellow-400/20 text-yellow-400 text-xs sm:text-sm\">\n                                Pending\n                              </span>\n                            )}\n                          </td>\n                          <td className=\"p-2 sm:p-4\">\n                            {problem.status !== 'Solved' && (\n                              <button\n                                onClick={() => handleSolveProblem(problem._id)}\n                                className=\"px-2 sm:px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-xs sm:text-sm rounded-lg whitespace-nowrap\"\n                              >\n                                Mark as Solved\n                              </button>\n                            )}\n                          </td>\n                        </tr>\n                      ))}\n                    </tbody>\n                  </table>\n                </div>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Add Problem Modal */}\n          {showAddModal && (\n            <div className=\"fixed inset-0 z-[9999] flex items-center justify-center p-4\">\n              {/* Enhanced backdrop with blur */}\n              <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" onClick={() => setShowAddModal(false)} />\n\n              {/* Modal content */}\n              <div className=\"relative glass-morphism neon-border rounded-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto shadow-2xl\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <h2 className=\"text-xl font-bold text-white\">Report a Problem</h2>\n                  <button onClick={() => setShowAddModal(false)} className=\"text-secondary-400 hover:text-white\">\n                    <X className=\"w-6 h-6\" /> {/* Now defined */}\n                  </button>\n                </div>\n                <textarea\n                  value={newProblem}\n                  onChange={(e) => setNewProblem(e.target.value)}\n                  placeholder=\"Describe the problem you're facing...\"\n                  className=\"w-full p-3 bg-secondary-800 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-1 focus:ring-neon-pink\"\n                  rows=\"4\"\n                />\n                <div className=\"flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3 mt-4\">\n                  <button\n                    onClick={() => setShowAddModal(false)}\n                    className=\"px-4 py-2 border border-secondary-600 text-secondary-300 rounded-lg w-full sm:w-auto\"\n                  >\n                    Cancel\n                  </button>\n                  <button\n                    onClick={handleAddProblem}\n                    className=\"px-4 py-2 bg-gradient-to-r from-neon-pink to-neon-purple text-white rounded-lg w-full sm:w-auto\"\n                  >\n                    Submit\n                  </button>\n                </div>\n              </div>\n            </div>\n          )}\n    </EmployeeLayout>\n  );\n};\nexport default ProblemStatementPage;","path":null,"size_bytes":13133,"size_tokens":null},"backend/routes/leaveRoutes.js":{"content":"// routes/leaveRoutes.js\nimport express from 'express';\nimport { body } from 'express-validator';\nimport {\n  applyLeave,\n  getLeaves,\n  getLeaveById,\n  approveLeave,\n  rejectLeave,\n  cancelLeave,\n  getLeaveStats,\n  getLeaveBalance\n} from '../controllers/leaveController.js';\nimport { protect } from '../middleware/auth.js';\n\nconst router = express.Router();\n\n// Validation middleware for leave application\nconst leaveValidation = [\n  body('leaveType')\n    .isIn(['casual', 'sick', 'earned', 'maternity', 'paternity', 'emergency', 'personal'])\n    .withMessage('Please select a valid leave type'),\n  body('startDate')\n    .isISO8601()\n    .withMessage('Please provide a valid start date'),\n  body('endDate')\n    .optional()\n    .isISO8601()\n    .withMessage('Please provide a valid end date'),\n  body('reason')\n    .trim()\n    .isLength({ min: 10, max: 500 })\n    .withMessage('Reason must be between 10 and 500 characters'),\n  body('isHalfDay')\n    .optional()\n    .isBoolean()\n    .withMessage('isHalfDay must be a boolean'),\n  body('halfDaySession')\n    .optional()\n    .isIn(['Morning', 'Evening'])\n    .withMessage('Half day session must be Morning or Evening'),\n  // body('totalDays')\n  //   .optional()\n  //   .isNumeric()\n  //   .withMessage('Total days must be a number')\n];\n\nconst approveRejectValidation = [\n  body('comments')\n    .optional()\n    .trim()\n    .isLength({ max: 300 })\n    .withMessage('Comments cannot exceed 300 characters')\n];\n\n// Apply auth middleware to all routes\nrouter.use(protect);\n\n// Routes\nrouter.route('/')\n  .get(getLeaves)\n  .post(leaveValidation, applyLeave);\n\n// Stats and balance routes (must come before /:id routes)\nrouter.get('/stats', getLeaveStats);\nrouter.get('/balance', getLeaveBalance);\n\n// Individual leave routes\nrouter.route('/:id')\n  .get(getLeaveById);\n\n// Action routes\nrouter.put('/:id/approve', approveRejectValidation, approveLeave)\nrouter.put('/:id/reject', approveRejectValidation, rejectLeave);\nrouter.put('/:id/cancel', cancelLeave);\n\nexport default router;","path":null,"size_bytes":2021,"size_tokens":null},"frontend/src/constants/dashboard.js":{"content":"// constants/dashboard.js\nexport const DASHBOARD_CONSTANTS = {\n  REFRESH_INTERVALS: {\n    FAST: 60000,      // 1 minute\n    NORMAL: 300000,   // 5 minutes\n    SLOW: 600000      // 10 minutes\n  },\n  \n  STATS_CONFIG: {\n    DEFAULT_COLORS: [\n      \"from-pink-500 to-purple-500\",\n      \"from-green-500 to-emerald-500\", \n      \"from-blue-500 to-indigo-500\",\n      \"from-yellow-500 to-orange-500\",\n      \"from-purple-500 to-pink-500\",\n      \"from-emerald-500 to-teal-500\"\n    ],\n    \n    CHANGE_TYPES: {\n      POSITIVE: 'positive',\n      NEGATIVE: 'negative',\n      NEUTRAL: 'neutral'\n    }\n  },\n\n  ACTIVITY_TYPES: {\n    SUCCESS: 'success',\n    WARNING: 'warning',\n    INFO: 'info',\n    ERROR: 'error'\n  },\n\n  EVENT_CATEGORIES: {\n    MEETING: 'meeting',\n    TRAINING: 'training',\n    HOLIDAY: 'holiday',\n    DEADLINE: 'deadline',\n    BIRTHDAY: 'birthday',\n    ANNOUNCEMENT: 'announcement'\n  },\n\n  DEPARTMENT_COLORS: {\n    'HR': 'bg-pink-500/20 text-pink-400',\n    'IT': 'bg-blue-500/20 text-blue-400',\n    'Finance': 'bg-green-500/20 text-green-400',\n    'Marketing': 'bg-purple-500/20 text-purple-400',\n    'Operations': 'bg-orange-500/20 text-orange-400',\n    'Sales': 'bg-yellow-500/20 text-yellow-400',\n    'Support': 'bg-teal-500/20 text-teal-400',\n    'Legal': 'bg-red-500/20 text-red-400'\n  },\n\n  MAX_ITEMS: {\n    RECENT_ACTIVITIES: 10,\n    UPCOMING_EVENTS: 8,\n    NOTIFICATIONS: 50\n  },\n\n  DATE_FORMATS: {\n    DISPLAY: {\n      weekday: 'long',\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric'\n    },\n    TIME: {\n      hour: '2-digit',\n      minute: '2-digit'\n    },\n    SHORT: {\n      month: 'short',\n      day: 'numeric'\n    }\n  }\n};\n\n// constants/api.js\nexport const API_CONSTANTS = {\n  ENDPOINTS: {\n    AUTH: '/auth',\n    DASHBOARD: '/dashboard',\n    EMPLOYEES: '/employees',\n    ATTENDANCE: '/attendance',\n    LEAVES: '/leaves',\n    TASKS: '/tasks',\n    NOTIFICATIONS: '/notifications'\n  },\n\n  HTTP_STATUS: {\n    OK: 200,\n    CREATED: 201,\n    BAD_REQUEST: 400,\n    UNAUTHORIZED: 401,\n    FORBIDDEN: 403,\n    NOT_FOUND: 404,\n    INTERNAL_SERVER_ERROR: 500\n  },\n\n  TIMEOUTS: {\n    DEFAULT: 10000,\n    UPLOAD: 30000,\n    DOWNLOAD: 60000\n  }\n};\n\n// constants/roles.js\nexport const ROLES = {\n  ADMIN: 'admin',\n  HR: 'hr',\n  MANAGER: 'manager',\n  EMPLOYEE: 'employee',\n  INTERN: 'intern'\n};\n\nexport const PERMISSIONS = {\n  [ROLES.ADMIN]: [\n    'view_dashboard',\n    'manage_employees',\n    'manage_departments',\n    'view_reports',\n    'manage_system',\n    'manage_roles',\n    'manage_attendance',\n    'manage_leaves'\n  ],\n  [ROLES.HR]: [\n    'view_dashboard',\n    'manage_employees',\n    'view_reports',\n    'manage_attendance',\n    'manage_leaves'\n  ],\n  [ROLES.MANAGER]: [\n    'view_dashboard',\n    'view_team',\n    'approve_leaves',\n    'assign_tasks',\n    'view_team_reports'\n  ],\n  [ROLES.EMPLOYEE]: [\n    'view_profile',\n    'update_profile',\n    'mark_attendance',\n    'apply_leave',\n    'view_tasks'\n  ],\n  [ROLES.INTERN]: [\n    'view_profile',\n    'update_profile',\n    'mark_attendance',\n    'view_tasks'\n  ]\n};","path":null,"size_bytes":3039,"size_tokens":null},"frontend/src/hooks/useRealTimeUpdates.js":{"content":"// hooks/useRealTimeUpdates.js\nimport { useState, useEffect, useCallback } from 'react';\n\nexport const useRealTimeUpdates = (refreshCallback, interval = 300000) => { // 5 minutes default\n  const [lastUpdated, setLastUpdated] = useState(new Date());\n  const [isAutoRefreshEnabled, setIsAutoRefreshEnabled] = useState(true);\n\n  const handleRefresh = useCallback(() => {\n    if (refreshCallback) {\n      refreshCallback();\n      setLastUpdated(new Date());\n    }\n  }, [refreshCallback]);\n\n  useEffect(() => {\n    if (!isAutoRefreshEnabled) return;\n\n    const intervalId = setInterval(() => {\n      handleRefresh();\n    }, interval);\n\n    return () => clearInterval(intervalId);\n  }, [handleRefresh, interval, isAutoRefreshEnabled]);\n\n  const toggleAutoRefresh = useCallback(() => {\n    setIsAutoRefreshEnabled(prev => !prev);\n  }, []);\n\n  return {\n    lastUpdated,\n    isAutoRefreshEnabled,\n    toggleAutoRefresh,\n    manualRefresh: handleRefresh\n  };\n};\n","path":null,"size_bytes":952,"size_tokens":null},"frontend/src/utils/geolocationUtils.js":{"content":"// utils/geolocationUtils.js\n\nexport const geolocationUtils = {\n  // Get current position with promise\n  getCurrentPosition: (options = {}) => {\n    const defaultOptions = {\n      enableHighAccuracy: true,\n      timeout: 10000,\n      maximumAge: 60000 // 1 minute cache\n    };\n\n    const finalOptions = { ...defaultOptions, ...options };\n\n    return new Promise((resolve, reject) => {\n      if (!navigator.geolocation) {\n        reject(new Error('Geolocation is not supported by this browser'));\n        return;\n      }\n\n      navigator.geolocation.getCurrentPosition(\n        (position) => {\n          resolve({\n            latitude: position.coords.latitude,\n            longitude: position.coords.longitude,\n            accuracy: position.coords.accuracy,\n            timestamp: position.timestamp,\n            altitude: position.coords.altitude,\n            heading: position.coords.heading,\n            speed: position.coords.speed\n          });\n        },\n        (error) => {\n          const errorMessages = {\n            [error.PERMISSION_DENIED]: 'Location access denied by user',\n            [error.POSITION_UNAVAILABLE]: 'Location information is unavailable',\n            [error.TIMEOUT]: 'Location request timed out',\n            default: 'An unknown error occurred while retrieving location'\n          };\n          \n          const message = errorMessages[error.code] || errorMessages.default;\n          reject(new Error(message));\n        },\n        finalOptions\n      );\n    });\n  },\n\n  // Watch position changes\n  watchPosition: (successCallback, errorCallback, options = {}) => {\n    if (!navigator.geolocation) {\n      throw new Error('Geolocation is not supported by this browser');\n    }\n\n    const defaultOptions = {\n      enableHighAccuracy: true,\n      timeout: 10000,\n      maximumAge: 60000\n    };\n\n    const finalOptions = { ...defaultOptions, ...options };\n\n    return navigator.geolocation.watchPosition(\n      successCallback,\n      errorCallback,\n      finalOptions\n    );\n  },\n\n  // Clear position watch\n  clearWatch: (watchId) => {\n    if (navigator.geolocation && watchId) {\n      navigator.geolocation.clearWatch(watchId);\n    }\n  },\n\n  // Get address from coordinates (reverse geocoding)\n  getAddressFromCoords: async (latitude, longitude) => {\n    try {\n      const response = await fetch(\n        `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`,\n        { timeout: 5000 }\n      );\n      \n      if (!response.ok) {\n        throw new Error('Geocoding service unavailable');\n      }\n      \n      const data = await response.json();\n      return {\n        address: data.display_name || data.locality || 'Unknown location',\n        city: data.city || data.locality,\n        country: data.countryName,\n        countryCode: data.countryCode,\n        postcode: data.postcode\n      };\n    } catch (error) {\n      console.warn('Geocoding failed:', error);\n      return {\n        address: `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`,\n        city: 'Unknown',\n        country: 'Unknown',\n        countryCode: 'XX',\n        postcode: ''\n      };\n    }\n  },\n\n  // Get device information\n  getDeviceInfo: () => {\n    const userAgent = navigator.userAgent;\n    \n    // Browser detection\n    let browser = 'Unknown';\n    if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) browser = 'Chrome';\n    else if (userAgent.includes('Firefox')) browser = 'Firefox';\n    else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) browser = 'Safari';\n    else if (userAgent.includes('Edg')) browser = 'Edge';\n    else if (userAgent.includes('Opera') || userAgent.includes('OPR')) browser = 'Opera';\n\n    // OS detection\n    let os = 'Unknown';\n    if (userAgent.includes('Windows')) os = 'Windows';\n    else if (userAgent.includes('Mac')) os = 'MacOS';\n    else if (userAgent.includes('Linux')) os = 'Linux';\n    else if (userAgent.includes('Android')) os = 'Android';\n    else if (userAgent.includes('iOS')) os = 'iOS';\n\n    return {\n      userAgent,\n      platform: navigator.platform || 'Unknown',\n      browser,\n      os,\n      language: navigator.language,\n      cookieEnabled: navigator.cookieEnabled,\n      onLine: navigator.onLine,\n      screen: {\n        width: screen.width,\n        height: screen.height,\n        colorDepth: screen.colorDepth\n      },\n      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone\n    };\n  },\n\n  // Calculate distance between two coordinates (Haversine formula)\n  calculateDistance: (lat1, lon1, lat2, lon2) => {\n    const R = 6371e3; // Earth's radius in meters\n    const φ1 = (lat1 * Math.PI) / 180;\n    const φ2 = (lat2 * Math.PI) / 180;\n    const Δφ = ((lat2 - lat1) * Math.PI) / 180;\n    const Δλ = ((lon2 - lon1) * Math.PI) / 180;\n\n    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +\n              Math.cos(φ1) * Math.cos(φ2) *\n              Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\n    \n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n    return R * c; // Distance in meters\n  },\n\n  // Format distance for display\n  formatDistance: (meters) => {\n    if (meters < 1000) {\n      return `${Math.round(meters)} m`;\n    } else {\n      return `${(meters / 1000).toFixed(1)} km`;\n    }\n  },\n\n  // Check if coordinates are within a certain radius\n  isWithinRadius: (lat1, lon1, lat2, lon2, radiusInMeters) => {\n    const distance = geolocationUtils.calculateDistance(lat1, lon1, lat2, lon2);\n    return distance <= radiusInMeters;\n  },\n\n  // Get location accuracy description\n  getAccuracyDescription: (accuracy) => {\n    if (accuracy <= 5) return 'Very High';\n    if (accuracy <= 20) return 'High';\n    if (accuracy <= 50) return 'Medium';\n    if (accuracy <= 100) return 'Low';\n    return 'Very Low';\n  }\n};","path":null,"size_bytes":5798,"size_tokens":null},"frontend/src/App.css":{"content":"/* #root {\n  max-width: 1280px;\n  margin: 0 auto;\n  padding: 2rem;\n  text-align: center;\n}\n\n.logo {\n  height: 6em;\n  padding: 1.5em;\n  will-change: filter;\n  transition: filter 300ms;\n}\n.logo:hover {\n  filter: drop-shadow(0 0 2em #646cffaa);\n}\n.logo.react:hover {\n  filter: drop-shadow(0 0 2em #61dafbaa);\n}\n\n@keyframes logo-spin {\n  from {\n    transform: rotate(0deg);\n  }\n  to {\n    transform: rotate(360deg);\n  }\n}\n\n@media (prefers-reduced-motion: no-preference) {\n  a:nth-of-type(2) .logo {\n    animation: logo-spin infinite 20s linear;\n  }\n}\n\n.card {\n  padding: 2em;\n}\n\n.read-the-docs {\n  color: #888;\n} */\n","path":null,"size_bytes":612,"size_tokens":null},"frontend/src/components/Employee/EmployeeLayout/EmployeeLayout.jsx":{"content":"import React, { useState, useEffect, useRef } from \"react\";\nimport { Link, useLocation, useNavigate } from \"react-router-dom\";\nimport {\n  Building2,\n  LayoutDashboard,\n  User,\n  Calendar,\n  Clock,\n  FileText,\n  Bell,\n  LogOut,\n  ChevronDown,\n  Menu,\n  X,\n  CreditCard,\n  Phone,\n  MapPin,\n  AlertCircle,\n  TrendingUp,\n} from \"lucide-react\";\nimport toast from \"react-hot-toast\";\nimport { authAPI } from '../../../utils/api';\n\nconst EmployeeLayout = ({ children, employeeData }) => {\n  // 👈 Accept prop\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [profileDropdown, setProfileDropdown] = useState(false);\n  const [notificationDropdown, setNotificationDropdown] = useState(false);\n  const [fetchedEmployeeData, setFetchedEmployeeData] = useState(null);\n  const [loading, setLoading] = useState(false);\n  const [notifications, setNotifications] = useState([\n    {\n      id: 1,\n      message: \"Welcome to the company!\",\n      time: \"1 hour ago\",\n      unread: true,\n    },\n    {\n      id: 2,\n      message: \"Please complete your profile\",\n      time: \"2 hours ago\",\n      unread: true,\n    },\n    {\n      id: 3,\n      message: \"Team meeting scheduled for tomorrow\",\n      time: \"1 day ago\",\n      unread: false,\n    },\n  ]);\n\n  const location = useLocation();\n  const navigate = useNavigate();\n  const notificationRef = useRef(null);\n  const profileRef = useRef(null);\n\n  // Fetch employee data on mount if not provided via props\n  useEffect(() => {\n    const fetchEmployeeData = async () => {\n      // If employeeData is already provided via props, don't fetch\n      if (employeeData) {\n        setFetchedEmployeeData(employeeData);\n        return;\n      }\n\n      try {\n        setLoading(true);\n        const response = await authAPI.getProfile();\n\n        if (response.data.success) {\n          const userData = response.data.data.user;\n          const employeeDataFromAPI = response.data.data.employee;\n\n          // Combine user and employee data\n          const combinedData = {\n            personalInfo: {\n              firstName: employeeDataFromAPI?.personalInfo?.firstName || userData.name?.split(' ')[0] || 'Unknown',\n              lastName: employeeDataFromAPI?.personalInfo?.lastName || userData.name?.split(' ')[1] || 'User',\n            },\n            workInfo: {\n              position: employeeDataFromAPI?.workInfo?.position || 'Employee',\n              department: employeeDataFromAPI?.workInfo?.department?.name || 'N/A',\n            },\n            employeeId: userData.employeeId || employeeDataFromAPI?.employeeId || 'N/A',\n            contactInfo: {\n              personalEmail: userData.email || employeeDataFromAPI?.contactInfo?.personalEmail || localStorage.getItem(\"userEmail\") || 'user@company.com',\n            },\n            user: userData,\n          };\n\n          setFetchedEmployeeData(combinedData);\n\n          // Update localStorage with fresh data\n          if (userData.name) localStorage.setItem('userName', userData.name);\n          if (userData.email) localStorage.setItem('userEmail', userData.email);\n          if (userData.employeeId) localStorage.setItem('employeeId', userData.employeeId);\n        }\n      } catch (error) {\n        console.error('Error fetching employee data in layout:', error);\n        // Set fallback data from localStorage\n        setFetchedEmployeeData({\n          personalInfo: {\n            firstName: localStorage.getItem('userName')?.split(' ')[0] || 'Unknown',\n            lastName: localStorage.getItem('userName')?.split(' ')[1] || 'User',\n          },\n          workInfo: {\n            position: 'Employee',\n            department: localStorage.getItem('userDepartment') || 'N/A',\n          },\n          employeeId: localStorage.getItem('employeeId') || 'N/A',\n          contactInfo: {\n            personalEmail: localStorage.getItem(\"userEmail\") || 'user@company.com',\n          },\n        });\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    fetchEmployeeData();\n  }, [employeeData]);\n\n  // Close dropdowns when clicking outside\n  useEffect(() => {\n    const handleClickOutside = (event) => {\n      if (notificationRef.current && !notificationRef.current.contains(event.target)) {\n        setNotificationDropdown(false);\n      }\n      if (profileRef.current && !profileRef.current.contains(event.target)) {\n        setProfileDropdown(false);\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => {\n      document.removeEventListener('mousedown', handleClickOutside);\n    };\n  }, []);\n\n // In EmployeeLayout.js\nconst sidebarItems = [\n  { name: \"Dashboard\", icon: LayoutDashboard, path: \"/employee/dashboard\" },\n  { name: \"Attendance\", icon: Clock, path: \"/employee/attendance\" },\n  { name: \"Leave Requests\", icon: Calendar, path: \"/employee/leaves\" },\n  { name: \"Tasks\", icon: FileText, path: \"/employee/tasks\" },\n  { name: \"Problem Statement\", icon: AlertCircle, path: \"/employee/problems\" },\n  { name: \"Sales\", icon: TrendingUp, path: \"/employee/sales\" },\n];\n\n  // Use fetched data, passed employeeData prop, or fallback\n  const emp = fetchedEmployeeData || employeeData || {\n    personalInfo: { firstName: \"Unknown\", lastName: \"User\" },\n    workInfo: { position: \"Employee\", department: \"N/A\" },\n    employeeId: \"N/A\",\n    contactInfo: {\n      personalEmail: localStorage.getItem(\"userEmail\") || \"user@company.com\",\n    },\n  };\n\n  const handleLogout = () => {\n    localStorage.removeItem(\"userRole\");\n    localStorage.removeItem(\"userEmail\");\n    localStorage.removeItem(\"token\");\n    toast.success(\"Logged out successfully!\");\n    navigate(\"/login\");\n  };\n\n  const markAsRead = (notificationId) => {\n    setNotifications(notifications.map(n =>\n      n.id === notificationId ? { ...n, unread: false } : n\n    ));\n  };\n\n  const markAllAsRead = () => {\n    setNotifications(notifications.map(n => ({ ...n, unread: false })));\n    toast.success('All notifications marked as read');\n  };\n\n  const unreadNotifications = notifications.filter((n) => n.unread).length;\n\n  return (\n    <div className=\"min-h-screen flex bg-gradient-to-br from-secondary-900 via-secondary-800 to-secondary-900 relative\">\n      {/* Background Effects */}\n      <div className=\"absolute inset-0 overflow-hidden pointer-events-none\">\n        <div className=\"absolute -top-10 -left-10 w-72 h-72 bg-neon-pink opacity-5 rounded-full blur-3xl animate-pulse\"></div>\n        <div className=\"absolute -bottom-10 -right-10 w-72 h-72 bg-neon-purple opacity-5 rounded-full blur-3xl animate-pulse delay-1000\"></div>\n      </div>\n\n      {/* Sidebar */}\n      <div\n        className={`fixed inset-y-0 left-0 z-50 w-64 transform ${\n          sidebarOpen ? \"translate-x-0\" : \"-translate-x-full\"\n        } transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0`}\n      >\n        <div className=\"glass-morphism h-full border-r border-secondary-700\">\n          {/* Logo */}\n          <div className=\"flex items-center justify-between h-16 px-6 border-b border-secondary-700\">\n            <div className=\"flex items-center space-x-3\">\n              {/* Logo Container - Fixed aspect ratio */}\n              <div className=\"w-12 h-12 rounded-lg overflow-hidden flex items-center justify-center bg-gradient-to-br from-neon-pink/10 to-neon-purple/10 border border-neon-pink/20 flex-shrink-0\">\n                <img\n                  src=\"/src/assets/logo.jpg\"\n                  alt=\"Taruna Technology Logo\"\n                  className=\"w-full h-full object-contain p-1\"\n                />\n              </div>\n\n              {/* Text Container */}\n              <div className=\"flex flex-col justify-center min-w-0\">\n                <h1 className=\"text-base font-bold text-white leading-tight tracking-wide\">\n                  Taruna Technology\n                </h1>\n                <p className=\"text-xs text-secondary-400 leading-tight mt-0.5\">\n                  Employee Portal\n                </p>\n              </div>\n            </div>\n\n            {/* Close button for mobile */}\n            <button\n              onClick={() => setSidebarOpen(false)}\n              className=\"lg:hidden text-secondary-400 hover:text-white transition-colors flex-shrink-0\"\n              aria-label=\"Close sidebar\"\n            >\n              <X className=\"w-5 h-5\" />\n            </button>\n          </div>\n\n          {/* Navigation */}\n          <nav className=\"mt-8 px-4\">\n            <div className=\"space-y-2\">\n              {sidebarItems.map((item) => {\n                const isActive = location.pathname === item.path;\n                return (\n                  <Link\n                    key={item.name}\n                    to={item.path}\n                    className={`flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-300 ${\n                      isActive\n                        ? \"bg-gradient-to-r from-neon-pink/20 to-neon-purple/20 border border-neon-pink/30 text-white\"\n                        : \"text-secondary-400 hover:text-white hover:bg-secondary-700/50\"\n                    }`}\n                  >\n                    <item.icon\n                      className={`w-5 h-5 ${isActive ? \"text-neon-pink\" : \"\"}`}\n                    />\n                    <span className=\"font-medium\">{item.name}</span>\n                  </Link>\n                );\n              })}\n            </div>\n          </nav>\n        </div>\n      </div>\n\n      {/* Main Content */}\n      <div className=\"flex-1 flex flex-col\">\n        {/* Header */}\n    <header className=\"bg-gray-900 border-b border-secondary-700 h-16 z-40 sticky top-0\">\n      <div className=\"flex items-center justify-between h-full px-6\">\n            {/* Mobile menu button */}\n            <button\n              onClick={() => setSidebarOpen(true)}\n              className=\"lg:hidden text-secondary-400 hover:text-white\"\n            >\n              <Menu className=\"w-6 h-6\" />\n            </button>\n\n            {/* Page Title */}\n            <div className=\"hidden lg:block\">\n              <h2 className=\"text-xl font-semibold text-white\">\n                {sidebarItems.find((item) => item.path === location.pathname)\n                  ?.name || \"Dashboard\"}\n              </h2>\n            </div>\n\n            {/* Right Section */}\n            <div className=\"flex items-center space-x-4\">\n              {/* Notifications */}\n              <div className=\"relative\" ref={notificationRef}>\n                <button\n                  onClick={() => setNotificationDropdown(!notificationDropdown)}\n                  className=\"relative p-2 text-secondary-400 hover:text-white transition-colors\"\n                >\n                  <Bell className=\"w-6 h-6\" />\n                  {unreadNotifications > 0 && (\n                    <span className=\"absolute -top-1 -right-1 w-5 h-5 bg-neon-pink rounded-full text-xs text-white flex items-center justify-center animate-pulse\">\n                      {unreadNotifications}\n                    </span>\n                  )}\n                </button>\n\n                {/* Notification Dropdown */}\n                {notificationDropdown && (\n                  <div className=\"absolute right-0 mt-2 w-80 glass-morphism rounded-lg border border-secondary-600 shadow-lg z-50 max-h-96 overflow-hidden\">\n                    <div className=\"p-4 border-b border-secondary-600 flex items-center justify-between\">\n                      <h3 className=\"text-sm font-semibold text-white\">Notifications</h3>\n                      {unreadNotifications > 0 && (\n                        <button\n                          onClick={markAllAsRead}\n                          className=\"text-xs text-neon-pink hover:text-neon-purple transition-colors\"\n                        >\n                          Mark all as read\n                        </button>\n                      )}\n                    </div>\n\n                    <div className=\"max-h-80 overflow-y-auto\">\n                      {notifications.length > 0 ? (\n                        notifications.map((notification) => (\n                          <div\n                            key={notification.id}\n                            onClick={() => markAsRead(notification.id)}\n                            className={`p-4 border-b border-secondary-700 hover:bg-secondary-700/30 cursor-pointer transition-colors ${\n                              notification.unread ? 'bg-neon-pink/5' : ''\n                            }`}\n                          >\n                            <div className=\"flex items-start space-x-3\">\n                              <div className={`w-2 h-2 rounded-full mt-2 flex-shrink-0 ${\n                                notification.unread ? 'bg-neon-pink' : 'bg-secondary-600'\n                              }`} />\n                              <div className=\"flex-1 min-w-0\">\n                                <p className={`text-sm ${\n                                  notification.unread ? 'text-white font-medium' : 'text-secondary-300'\n                                }`}>\n                                  {notification.message}\n                                </p>\n                                <p className=\"text-xs text-secondary-500 mt-1\">\n                                  {notification.time}\n                                </p>\n                              </div>\n                            </div>\n                          </div>\n                        ))\n                      ) : (\n                        <div className=\"p-8 text-center\">\n                          <Bell className=\"w-12 h-12 text-secondary-600 mx-auto mb-3\" />\n                          <p className=\"text-secondary-400 text-sm\">No notifications</p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                )}\n              </div>\n\n              {/* Profile Dropdown */}\n              <div className=\"relative\" ref={profileRef}>\n                <button\n                  onClick={() => setProfileDropdown(!profileDropdown)}\n                  className=\"flex items-center space-x-3 p-2 rounded-lg hover:bg-secondary-700/50 transition-colors\"\n                >\n                  <div className=\"w-8 h-8 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                    <User className=\"w-4 h-4 text-white\" />\n                  </div>\n                  <div className=\"hidden md:block text-left\">\n                    <p className=\"text-sm font-medium text-white\">\n                      {emp.personalInfo?.firstName} {emp.personalInfo?.lastName}\n                    </p>\n                    <p className=\"text-xs text-secondary-400\">\n                      {emp.contactInfo?.personalEmail || emp.user?.email}\n                    </p>\n                  </div>\n                  <ChevronDown className=\"w-4 h-4 text-secondary-400\" />\n                </button>\n\n                {/* Dropdown Menu */}\n                {profileDropdown && (\n                  <div className=\"absolute right-0 mt-2 w-64 glass-morphism rounded-lg border border-secondary-600 shadow-lg z-50\">\n                    <div className=\"p-4 border-b border-secondary-600\">\n                      <div className=\"flex items-center space-x-3\">\n                        <div className=\"w-12 h-12 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                          <User className=\"w-6 h-6 text-white\" />\n                        </div>\n                        <div>\n                          <p className=\"text-sm font-medium text-white\">\n                            {emp.personalInfo?.firstName}{\" \"}\n                            {emp.personalInfo?.lastName}\n                          </p>\n                          <p className=\"text-xs text-neon-pink\">\n                            {emp.workInfo?.position}\n                          </p>\n                          <p className=\"text-xs text-secondary-400\">\n                            {emp.employeeId}\n                          </p>{\" \"}\n                          {/* ✅ REAL ID */}\n                        </div>\n                      </div>\n                    </div>\n\n                    <div className=\"py-2\">\n                      <Link\n                        to=\"/employee/profile\"\n                        className=\"flex items-center px-4 py-2 text-sm text-secondary-300 hover:text-white hover:bg-secondary-700/50\"\n                        onClick={() => setProfileDropdown(false)}\n                      >\n                        <User className=\"w-4 h-4 mr-3\" />\n                        Profile Information\n                      </Link>\n                      <Link\n                        to=\"/employee/attendance\"\n                        className=\"flex items-center px-4 py-2 text-sm text-secondary-300 hover:text-white hover:bg-secondary-700/50\"\n                        onClick={() => setProfileDropdown(false)}\n                      >\n                        <Clock className=\"w-4 h-4 mr-3\" />\n                        My Attendance\n                      </Link>\n                      <hr className=\"my-2 border-secondary-600\" />\n                      <button\n                        onClick={handleLogout}\n                        className=\"flex items-center w-full px-4 py-2 text-sm text-red-400 hover:text-red-300 hover:bg-secondary-700/50\"\n                      >\n                        <LogOut className=\"w-4 h-4 mr-3\" />\n                        Logout\n                      </button>\n                    </div>\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n        </header>\n\n        {/* Page Content */}\n        <main className=\"p-6 relative z-10\">{children}</main>\n      </div>\n\n      {/* Mobile Sidebar Overlay */}\n      {sidebarOpen && (\n        <div\n          className=\"fixed inset-0 z-40 bg-black bg-opacity-50 lg:hidden\"\n          onClick={() => setSidebarOpen(false)}\n        ></div>\n      )}\n    </div>\n  );\n};\n\nexport default EmployeeLayout;\n","path":null,"size_bytes":17998,"size_tokens":null},"LOCAL_SETUP.md":{"content":"# Local Setup Guide - Employee Management System\n\nThis guide explains how to run the Employee Management System locally, including Groq API configuration for the AI chatbot.\n\n## Prerequisites\n\n- Node.js v18+ (recommended v20)\n- MongoDB database (local or cloud like MongoDB Atlas)\n- npm or yarn package manager\n\n## Environment Variables\n\n### Backend Environment Variables\n\nCreate a `.env` file in the `backend/` directory with the following variables:\n\n```env\n# Database Configuration\nMONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/database_name\n\n# Server Configuration\nPORT=3001\nNODE_ENV=development\n\n# Frontend URL (for CORS and email links)\nFRONTEND_URL=http://localhost:5000\n\n# JWT Configuration\nJWT_SECRET=your-super-secure-jwt-secret-key-here\nJWT_EXPIRES_IN=7d\n\n# Groq API Configuration (for AI Chatbot)\nGROQ_API_KEY=your-groq-api-key-here\n\n# Email Configuration (optional - for welcome emails)\nSMTP_HOST=smtp.gmail.com\nSMTP_PORT=587\nSMTP_USER=your-email@gmail.com\nSMTP_PASS=your-app-password\nEMAIL_FROM=noreply@companyname.com\n```\n\n### Frontend Environment Variables\n\nCreate a `.env` file in the `frontend/` directory:\n\n```env\nVITE_API_URL=http://localhost:3001/api\nVITE_BACKEND_URL=http://localhost:3001\n```\n\n## Getting Your Groq API Key\n\nThe AI chatbot uses Groq's LLaMA model for intelligent HR assistance. To enable this feature:\n\n1. Visit [Groq Console](https://console.groq.com/)\n2. Sign up for a free account or log in\n3. Navigate to **API Keys** section\n4. Click **Create API Key**\n5. Copy the generated key\n6. Add it to your backend `.env` file as `GROQ_API_KEY`\n\n**Note:** The chatbot will work without a Groq API key using fallback responses, but AI-powered responses require the API key.\n\n## Installation Steps\n\n### 1. Clone the Repository\n\n```bash\ngit clone <repository-url>\ncd employee-management-system\n```\n\n### 2. Install Backend Dependencies\n\n```bash\ncd backend\nnpm install\n```\n\n### 3. Install Frontend Dependencies\n\n```bash\ncd ../frontend\nnpm install\n```\n\n### 4. Setup MongoDB\n\n**Option A: MongoDB Atlas (Cloud)**\n1. Create account at [MongoDB Atlas](https://www.mongodb.com/atlas)\n2. Create a new cluster\n3. Get the connection string\n4. Add to `MONGODB_URI` in backend `.env`\n\n**Option B: Local MongoDB**\n1. Install MongoDB locally\n2. Start MongoDB service\n3. Use `mongodb://localhost:27017/employee_management` as `MONGODB_URI`\n\n### 5. Initialize Database (Optional)\n\n```bash\ncd backend\nnpm run init-db\nnpm run seed-admin\n```\n\nThis creates an admin user with default credentials:\n- Email: admin@company.com\n- Password: admin123\n\n## Running the Application\n\n### Development Mode\n\n**Terminal 1 - Backend:**\n```bash\ncd backend\nnpm start\n# or\nnode server.js\n```\nBackend runs on: http://localhost:3001\n\n**Terminal 2 - Frontend:**\n```bash\ncd frontend\nnpm run dev\n```\nFrontend runs on: http://localhost:5000\n\n### Production Mode\n\n**Build Frontend:**\n```bash\ncd frontend\nnpm run build\n```\n\n**Start Backend with Production Mode:**\n```bash\ncd backend\nNODE_ENV=production node server.js\n```\n\n## Features Configuration\n\n### Face Recognition\nFace recognition models are included in `backend/models/face-models/`. No additional setup required.\n\n### AI Chatbot (Groq)\n- Add `GROQ_API_KEY` to enable AI-powered responses\n- Without the key, the chatbot uses rule-based fallback responses\n- The chatbot handles HR queries, leave policies, salary information, and document generation\n\n### Email Notifications\nConfigure SMTP settings for:\n- Welcome emails to new employees\n- Password reset emails\n- Leave approval notifications\n\n## Troubleshooting\n\n### Common Issues\n\n1. **MongoDB Connection Failed**\n   - Verify `MONGODB_URI` is correct\n   - Check network connectivity\n   - Ensure MongoDB Atlas IP whitelist includes your IP\n\n2. **Groq API Not Working**\n   - Verify `GROQ_API_KEY` is set correctly\n   - Check API key has not expired\n   - Ensure you have API quota remaining\n\n3. **Face Models Not Loading**\n   - Models are in `backend/models/face-models/`\n   - If missing, run: `npm run download-models`\n\n4. **CORS Errors**\n   - Ensure `FRONTEND_URL` matches your frontend URL\n   - Backend must be running for frontend to work\n\n### Logs Location\n- Backend logs: Console output\n- Temp files (PDFs): `backend/temp/`\n\n## API Documentation\n\n### Authentication\n- POST `/api/auth/login` - User login\n- POST `/api/auth/register` - Admin registration\n\n### Employees\n- GET `/api/employees` - List all employees (Admin)\n- GET `/api/employees/:id` - Get employee details\n- POST `/api/employees` - Create employee (Admin)\n- PUT `/api/employees/:id` - Update employee\n- DELETE `/api/employees/:id` - Delete employee (Admin)\n\n### Payslips\n- GET `/api/payslips` - List all payslips\n- GET `/api/payslips/employee/:employeeId` - Get employee payslips\n- POST `/api/payslips/generate` - Generate payslip (Admin)\n- GET `/api/payslips/:id/download` - Download payslip PDF\n\n### AI Chatbot\n- POST `/api/bot/message` - Send message to chatbot\n- GET `/api/bot/history/:userId` - Get chat history\n\n## Support\n\nFor issues or questions:\n- Check the troubleshooting section above\n- Review console logs for error messages\n- Contact HR department for access-related issues\n","path":null,"size_bytes":5166,"size_tokens":null},"frontend/src/pages/Sales/LeadManagement.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { \n  Plus, \n  Search, \n  Users,\n  Clock,\n  Target,\n  Phone,\n  Mail,\n  Building,\n  Calendar,\n  DollarSign,\n  AlertTriangle,\n  CheckCircle2,\n  Eye,\n  Edit,\n  MessageSquare,\n  X,\n  Save,\n  User,\n  Award,\n  Star,\n  Video,\n  PhoneCall,\n  UserCheck,\n  FileText,\n  AlertCircle\n} from 'lucide-react';\n\n// Import your API functions\nimport { leadAPI } from '../../utils/api';\n\n// Toast notification system (simple implementation)\nconst toast = {\n  success: (message) => {\n    console.log('✅ SUCCESS:', message);\n    // In a real app, you'd show a toast notification\n  },\n  error: (message) => {\n    console.log('❌ ERROR:', message);\n    // In a real app, you'd show an error toast\n  }\n};\n\nconst LeadManagement = () => {\n  const [leads, setLeads] = useState([]);\n  const [stats, setStats] = useState({});\n  const [upcomingMeetings, setUpcomingMeetings] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [submitting, setSubmitting] = useState(false);\n  const [error, setError] = useState(null);\n  const [filters, setFilters] = useState({\n    status: 'all',\n    priority: 'all',\n    source: 'all',\n    search: '',\n    page: 1,\n    limit: 20\n  });\n  const [pagination, setPagination] = useState({});\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [showEditModal, setShowEditModal] = useState(false);\n  const [showViewModal, setShowViewModal] = useState(false);\n  const [showWonModal, setShowWonModal] = useState(false);\n  const [showMeetingModal, setShowMeetingModal] = useState(false);\n  const [selectedLead, setSelectedLead] = useState(null);\n\n  // Data fetching functions\n  const fetchLeads = async () => {\n    try {\n      setLoading(true);\n      const response = await leadAPI.getLeads(filters);\n      if (response.data.success) {\n        setLeads(response.data.data.leads || []);\n        setPagination(response.data.data.pagination || {});\n      }\n    } catch (error) {\n      console.error('Failed to load leads:', error);\n      setError('Failed to load leads');\n      toast.error('Failed to load leads');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const fetchStats = async () => {\n    try {\n      const response = await leadAPI.getLeadStats();\n      if (response.data.success) {\n        setStats(response.data.data);\n      }\n    } catch (error) {\n      console.error('Failed to fetch stats:', error);\n    }\n  };\n\n  const fetchUpcomingMeetings = async () => {\n    try {\n      const response = await leadAPI.getUpcomingMeetings();\n      if (response.data.success) {\n        setUpcomingMeetings(response.data.data || []);\n      }\n    } catch (error) {\n      console.error('Failed to fetch upcoming meetings:', error);\n    }\n  };\n\n  useEffect(() => {\n    const loadData = async () => {\n      await Promise.all([fetchLeads(), fetchStats(), fetchUpcomingMeetings()]);\n    };\n    loadData();\n  }, [filters]);\n\n  // Helper functions\n  const getStatusColor = (status) => {\n    const colors = {\n      'New': 'bg-blue-100 text-blue-800 border-blue-200',\n      'Contacted': 'bg-yellow-100 text-yellow-800 border-yellow-200',\n      'Qualified': 'bg-purple-100 text-purple-800 border-purple-200',\n      'Proposal': 'bg-orange-100 text-orange-800 border-orange-200',\n      'Negotiation': 'bg-indigo-100 text-indigo-800 border-indigo-200',\n      'Won': 'bg-green-100 text-green-800 border-green-200',\n      'Lost': 'bg-red-100 text-red-800 border-red-200'\n    };\n    return colors[status] || 'bg-gray-100 text-gray-800 border-gray-200';\n  };\n\n  const getPriorityColor = (priority) => {\n    const colors = {\n      'Low': 'bg-green-100 text-green-800 border-green-200',\n      'Medium': 'bg-yellow-100 text-yellow-800 border-yellow-200',\n      'High': 'bg-orange-100 text-orange-800 border-orange-200',\n      'Hot': 'bg-red-100 text-red-800 border-red-200'\n    };\n    return colors[priority] || 'bg-gray-100 text-gray-800 border-gray-200';\n  };\n\n  const getMeetingTypeIcon = (type) => {\n    const icons = {\n      'Call': PhoneCall,\n      'Video Meeting': Video,\n      'In-Person': UserCheck,\n      'Demo': Award,\n      'Presentation': FileText\n    };\n    return icons[type] || Calendar;\n  };\n\n  // Stats cards calculation\n  const calculateStatsCards = () => {\n    const wonStats = stats.wonStats || {};\n    const totalRevenue = wonStats.totalRevenue || 0;\n    const avgDealSize = wonStats.avgDealSize || 0;\n    const todayMeetings = stats.todayMeetings || 0;\n    const upcomingMeetingsCount = stats.upcomingMeetingsCount || 0;\n    const overdueCount = stats.overdueCount || 0;\n    const todayFollowUps = stats.todayFollowUps || 0;\n\n    return [\n      {\n        title: 'Total Revenue',\n        value: `$${totalRevenue.toLocaleString()}`,\n        icon: DollarSign,\n        color: 'from-green-500 to-green-600',\n        subtitle: `Avg: $${avgDealSize.toLocaleString()}`\n      },\n      {\n        title: 'Meetings Today',\n        value: todayMeetings,\n        icon: Calendar,\n        color: 'from-purple-500 to-purple-600',\n        subtitle: `${upcomingMeetingsCount} upcoming this week`\n      },\n      {\n        title: 'Pending Follow-ups',\n        value: overdueCount + todayFollowUps,\n        icon: AlertCircle,\n        color: 'from-orange-500 to-orange-600',\n        subtitle: `${overdueCount} overdue, ${todayFollowUps} today`\n      },\n      {\n        title: 'Won Deals',\n        value: wonStats.totalWon || 0,\n        icon: Award,\n        color: 'from-blue-500 to-blue-600',\n        subtitle: `Avg satisfaction: ${(wonStats.avgSatisfactionScore || 0).toFixed(1)}/10`\n      }\n    ];\n  };\n\n  const statsCards = calculateStatsCards();\n\n  // Add Lead Form Modal\n  const AddLeadModal = () => {\n    const [formData, setFormData] = useState({\n      firstName: '',\n      lastName: '',\n      email: '',\n      phone: '',\n      company: '',\n      position: '',\n      source: 'Website',\n      priority: 'Medium',\n      estimatedValue: '',\n      expectedCloseDate: '',\n      nextFollowUpDate: new Date(Date.now() + 24*60*60*1000).toISOString().split('T')[0],\n      interestedProducts: [],\n      notes: ''\n    });\n\n    const handleSubmit = async (e) => {\n      e.preventDefault();\n      setSubmitting(true);\n      \n      try {\n        const leadData = {\n          ...formData,\n          estimatedValue: formData.estimatedValue ? Number(formData.estimatedValue) : undefined,\n          expectedCloseDate: formData.expectedCloseDate || undefined,\n          nextFollowUpDate: formData.nextFollowUpDate || undefined\n        };\n\n        const response = await leadAPI.createLead(leadData);\n        \n        if (response.data.success) {\n          setShowAddModal(false);\n          setFormData({\n            firstName: '',\n            lastName: '',\n            email: '',\n            phone: '',\n            company: '',\n            position: '',\n            source: 'Website',\n            priority: 'Medium',\n            estimatedValue: '',\n            expectedCloseDate: '',\n            nextFollowUpDate: new Date(Date.now() + 24*60*60*1000).toISOString().split('T')[0],\n            interestedProducts: [],\n            notes: ''\n          });\n          toast.success('Lead created successfully!');\n          fetchLeads();\n          fetchStats();\n        }\n      } catch (error) {\n        console.error('Create lead error:', error);\n        toast.error('Failed to create lead');\n      } finally {\n        setSubmitting(false);\n      }\n    };\n\n    if (!showAddModal) return null;\n\n    return (\n      <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n        <div className=\"bg-gray-900 rounded-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto border border-gray-700\">\n          <div className=\"p-6 border-b border-gray-700\">\n            <div className=\"flex items-center justify-between\">\n              <h2 className=\"text-xl font-bold text-white\">Add New Lead</h2>\n              <button\n                onClick={() => setShowAddModal(false)}\n                className=\"p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg\"\n              >\n                <X className=\"w-5 h-5\" />\n              </button>\n            </div>\n          </div>\n\n          <form onSubmit={handleSubmit} className=\"p-6 space-y-6\">\n            {/* Basic Information */}\n            <div>\n              <h3 className=\"text-lg font-semibold text-white mb-4\">Basic Information</h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    First Name *\n                  </label>\n                  <input\n                    type=\"text\"\n                    required\n                    value={formData.firstName}\n                    onChange={(e) => setFormData(prev => ({ ...prev, firstName: e.target.value }))}\n                    className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Last Name *\n                  </label>\n                  <input\n                    type=\"text\"\n                    required\n                    value={formData.lastName}\n                    onChange={(e) => setFormData(prev => ({ ...prev, lastName: e.target.value }))}\n                    className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Email *\n                  </label>\n                  <input\n                    type=\"email\"\n                    required\n                    value={formData.email}\n                    onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}\n                    className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Phone *\n                  </label>\n                  <input\n                    type=\"tel\"\n                    required\n                    value={formData.phone}\n                    onChange={(e) => setFormData(prev => ({ ...prev, phone: e.target.value }))}\n                    className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Company\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={formData.company}\n                    onChange={(e) => setFormData(prev => ({ ...prev, company: e.target.value }))}\n                    className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Position\n                  </label>\n                  <input\n                    type=\"text\"\n                    value={formData.position}\n                    onChange={(e) => setFormData(prev => ({ ...prev, position: e.target.value }))}\n                    className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            {/* Lead Details */}\n            <div>\n              <h3 className=\"text-lg font-semibold text-white mb-4\">Lead Details</h3>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Source *\n                  </label>\n                  <select\n                    required\n                    value={formData.source}\n                    onChange={(e) => setFormData(prev => ({ ...prev, source: e.target.value }))}\n                    className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                  >\n                    <option value=\"Website\">Website</option>\n                    <option value=\"Social Media\">Social Media</option>\n                    <option value=\"Email Campaign\">Email Campaign</option>\n                    <option value=\"Cold Call\">Cold Call</option>\n                    <option value=\"Referral\">Referral</option>\n                    <option value=\"Trade Show\">Trade Show</option>\n                    <option value=\"Advertisement\">Advertisement</option>\n                    <option value=\"Other\">Other</option>\n                  </select>\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Priority\n                  </label>\n                  <select\n                    value={formData.priority}\n                    onChange={(e) => setFormData(prev => ({ ...prev, priority: e.target.value }))}\n                    className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                  >\n                    <option value=\"Low\">Low</option>\n                    <option value=\"Medium\">Medium</option>\n                    <option value=\"High\">High</option>\n                    <option value=\"Hot\">Hot</option>\n                  </select>\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Estimated Value ($)\n                  </label>\n                  <input\n                    type=\"number\"\n                    min=\"0\"\n                    step=\"0.01\"\n                    value={formData.estimatedValue}\n                    onChange={(e) => setFormData(prev => ({ ...prev, estimatedValue: e.target.value }))}\n                    className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Expected Close Date\n                  </label>\n                  <input\n                    type=\"date\"\n                    value={formData.expectedCloseDate}\n                    onChange={(e) => setFormData(prev => ({ ...prev, expectedCloseDate: e.target.value }))}\n                    className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                  />\n                </div>\n                <div className=\"md:col-span-2\">\n                  <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                    Next Follow-up Date\n                  </label>\n                  <input\n                    type=\"date\"\n                    value={formData.nextFollowUpDate}\n                    onChange={(e) => setFormData(prev => ({ ...prev, nextFollowUpDate: e.target.value }))}\n                    className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            <div className=\"flex justify-end space-x-4 pt-4 border-t border-gray-700\">\n              <button\n                type=\"button\"\n                onClick={() => setShowAddModal(false)}\n                className=\"px-6 py-2 text-gray-300 border border-gray-600 rounded-lg hover:bg-gray-800 transition-colors\"\n              >\n                Cancel\n              </button>\n              <button\n                type=\"submit\"\n                disabled={submitting}\n                className=\"px-6 py-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all duration-300 flex items-center disabled:opacity-50\"\n              >\n                {submitting ? (\n                  <div className=\"w-4 h-4 mr-2 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\n                ) : (\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                )}\n                {submitting ? 'Creating...' : 'Create Lead'}\n              </button>\n            </div>\n          </form>\n        </div>\n      </div>\n    );\n  };\n\n  // Won Lead Modal\n  const WonLeadModal = () => {\n    const [formData, setFormData] = useState({\n      finalValue: selectedLead?.wonDetails?.finalValue || selectedLead?.actualValue || '',\n      recurringRevenue: selectedLead?.wonDetails?.recurringRevenue || '',\n      onboardingStatus: selectedLead?.wonDetails?.onboardingStatus || 'Not Started',\n      satisfactionScore: selectedLead?.wonDetails?.satisfactionScore || '',\n      renewalDate: selectedLead?.wonDetails?.renewalDate ? \n        new Date(selectedLead.wonDetails.renewalDate).toISOString().split('T')[0] : '',\n      discount: selectedLead?.wonDetails?.discount || '',\n      contractDuration: selectedLead?.wonDetails?.contractDuration || '',\n      paymentTerms: selectedLead?.wonDetails?.paymentTerms || '',\n      deliveryDate: selectedLead?.wonDetails?.deliveryDate ?\n        new Date(selectedLead.wonDetails.deliveryDate).toISOString().split('T')[0] : ''\n    });\n\n    const handleSubmit = async (e) => {\n      e.preventDefault();\n      setSubmitting(true);\n      \n      try {\n        const response = await leadAPI.updateWonLead(selectedLead._id, formData);\n        \n        if (response.data.success) {\n          setShowWonModal(false);\n          toast.success('Won lead details updated successfully!');\n          fetchLeads();\n          fetchStats();\n        }\n      } catch (error) {\n        console.error('Update won lead error:', error);\n        toast.error('Failed to update won lead details');\n      } finally {\n        setSubmitting(false);\n      }\n    };\n\n    if (!showWonModal || !selectedLead) return null;\n\n    return (\n      <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n        <div className=\"bg-gray-900 rounded-xl w-full max-w-2xl border border-gray-700\">\n          <div className=\"p-6 border-b border-gray-700\">\n            <div className=\"flex items-center justify-between\">\n              <h2 className=\"text-xl font-bold text-white\">Won Lead Details</h2>\n              <button\n                onClick={() => setShowWonModal(false)}\n                className=\"p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg\"\n              >\n                <X className=\"w-5 h-5\" />\n              </button>\n            </div>\n          </div>\n\n          <form onSubmit={handleSubmit} className=\"p-6 space-y-4\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                  Final Deal Value ($)\n                </label>\n                <input\n                  type=\"number\"\n                  min=\"0\"\n                  step=\"0.01\"\n                  value={formData.finalValue}\n                  onChange={(e) => setFormData(prev => ({ ...prev, finalValue: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                  Monthly Recurring Revenue ($)\n                </label>\n                <input\n                  type=\"number\"\n                  min=\"0\"\n                  step=\"0.01\"\n                  value={formData.recurringRevenue}\n                  onChange={(e) => setFormData(prev => ({ ...prev, recurringRevenue: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                  Onboarding Status\n                </label>\n                <select\n                  value={formData.onboardingStatus}\n                  onChange={(e) => setFormData(prev => ({ ...prev, onboardingStatus: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                >\n                  <option value=\"Not Started\">Not Started</option>\n                  <option value=\"In Progress\">In Progress</option>\n                  <option value=\"Completed\">Completed</option>\n                </select>\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                  Satisfaction Score (1-10)\n                </label>\n                <input\n                  type=\"number\"\n                  min=\"1\"\n                  max=\"10\"\n                  value={formData.satisfactionScore}\n                  onChange={(e) => setFormData(prev => ({ ...prev, satisfactionScore: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                  Contract Duration (months)\n                </label>\n                <input\n                  type=\"number\"\n                  min=\"1\"\n                  value={formData.contractDuration}\n                  onChange={(e) => setFormData(prev => ({ ...prev, contractDuration: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                  Discount ($)\n                </label>\n                <input\n                  type=\"number\"\n                  min=\"0\"\n                  step=\"0.01\"\n                  value={formData.discount}\n                  onChange={(e) => setFormData(prev => ({ ...prev, discount: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                  Delivery Date\n                </label>\n                <input\n                  type=\"date\"\n                  value={formData.deliveryDate}\n                  onChange={(e) => setFormData(prev => ({ ...prev, deliveryDate: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                  Renewal Date\n                </label>\n                <input\n                  type=\"date\"\n                  value={formData.renewalDate}\n                  onChange={(e) => setFormData(prev => ({ ...prev, renewalDate: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                />\n              </div>\n              <div className=\"md:col-span-2\">\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                  Payment Terms\n                </label>\n                <input\n                  type=\"text\"\n                  value={formData.paymentTerms}\n                  onChange={(e) => setFormData(prev => ({ ...prev, paymentTerms: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                  placeholder=\"e.g., Net 30, Monthly, Quarterly\"\n                />\n              </div>\n            </div>\n\n            <div className=\"flex justify-end space-x-4 pt-4 border-t border-gray-700\">\n              <button\n                type=\"button\"\n                onClick={() => setShowWonModal(false)}\n                className=\"px-6 py-2 text-gray-300 border border-gray-600 rounded-lg hover:bg-gray-800 transition-colors\"\n              >\n                Cancel\n              </button>\n              <button\n                type=\"submit\"\n                disabled={submitting}\n                className=\"px-6 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:shadow-lg transition-all duration-300 flex items-center disabled:opacity-50\"\n              >\n                {submitting ? (\n                  <div className=\"w-4 h-4 mr-2 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\n                ) : (\n                  <Save className=\"w-4 h-4 mr-2\" />\n                )}\n                {submitting ? 'Updating...' : 'Update Details'}\n              </button>\n            </div>\n          </form>\n        </div>\n      </div>\n    );\n  };\n\n  // Meeting Modal\n  const MeetingModal = () => {\n    const [formData, setFormData] = useState({\n      type: 'Video Meeting',\n      scheduledDate: new Date(Date.now() + 86400000).toISOString().slice(0, 16),\n      duration: 60,\n      agenda: ''\n    });\n\n    const handleSubmit = async (e) => {\n      e.preventDefault();\n      setSubmitting(true);\n      \n      try {\n        const response = await leadAPI.addMeeting(selectedLead._id, formData);\n        \n        if (response.data.success) {\n          setShowMeetingModal(false);\n          toast.success('Meeting scheduled successfully!');\n          fetchLeads();\n          fetchUpcomingMeetings();\n        }\n      } catch (error) {\n        console.error('Add meeting error:', error);\n        toast.error('Failed to schedule meeting');\n      } finally {\n        setSubmitting(false);\n      }\n    };\n\n    if (!showMeetingModal) return null;\n\n    return (\n      <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n        <div className=\"bg-gray-900 rounded-xl w-full max-w-2xl border border-gray-700\">\n          <div className=\"p-6 border-b border-gray-700\">\n            <div className=\"flex items-center justify-between\">\n              <h2 className=\"text-xl font-bold text-white\">Schedule Meeting</h2>\n              <button\n                onClick={() => setShowMeetingModal(false)}\n                className=\"p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg\"\n              >\n                <X className=\"w-5 h-5\" />\n              </button>\n            </div>\n          </div>\n\n          <form onSubmit={handleSubmit} className=\"p-6 space-y-4\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                  Meeting Type\n                </label>\n                <select\n                  value={formData.type}\n                  onChange={(e) => setFormData(prev => ({ ...prev, type: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                >\n                  <option value=\"Call\">Call</option>\n                  <option value=\"Video Meeting\">Video Meeting</option>\n                  <option value=\"In-Person\">In-Person</option>\n                  <option value=\"Demo\">Demo</option>\n                  <option value=\"Presentation\">Presentation</option>\n                  <option value=\"Negotiation\">Negotiation</option>\n                </select>\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                  Duration (minutes)\n                </label>\n                <input\n                  type=\"number\"\n                  min=\"15\"\n                  max=\"480\"\n                  value={formData.duration}\n                  onChange={(e) => setFormData(prev => ({ ...prev, duration: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                />\n              </div>\n              <div className=\"md:col-span-2\">\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                  Scheduled Date & Time\n                </label>\n                <input\n                  type=\"datetime-local\"\n                  value={formData.scheduledDate}\n                  onChange={(e) => setFormData(prev => ({ ...prev, scheduledDate: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20\"\n                />\n              </div>\n              <div className=\"md:col-span-2\">\n                <label className=\"block text-sm font-medium text-gray-300 mb-2\">\n                  Agenda\n                </label>\n                <textarea\n                  rows={3}\n                  value={formData.agenda}\n                  onChange={(e) => setFormData(prev => ({ ...prev, agenda: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20 resize-none\"\n                  placeholder=\"Meeting agenda and topics to discuss...\"\n                />\n              </div>\n            </div>\n\n            <div className=\"flex justify-end space-x-4 pt-4 border-t border-gray-700\">\n              <button\n                type=\"button\"\n                onClick={() => setShowMeetingModal(false)}\n                className=\"px-6 py-2 text-gray-300 border border-gray-600 rounded-lg hover:bg-gray-800 transition-colors\"\n              >\n                Cancel\n              </button>\n              <button\n                type=\"submit\"\n                disabled={submitting}\n                className=\"px-6 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all duration-300 flex items-center disabled:opacity-50\"\n              >\n                {submitting ? (\n                  <div className=\"w-4 h-4 mr-2 border-2 border-white/30 border-t-white rounded-full animate-spin\" />\n                ) : (\n                  <Calendar className=\"w-4 h-4 mr-2\" />\n                )}\n                {submitting ? 'Scheduling...' : 'Schedule Meeting'}\n              </button>\n            </div>\n          </form>\n        </div>\n      </div>\n    );\n  };\n\n  // View Lead Modal\n  const ViewLeadModal = () => {\n    const [activeTab, setActiveTab] = useState('overview');\n    const [newNote, setNewNote] = useState('');\n\n    const handleAddNote = async (e) => {\n      e.preventDefault();\n      if (!newNote.trim()) return;\n\n      try {\n        const response = await leadAPI.addLeadNote(selectedLead._id, newNote.trim());\n        \n        if (response.data.success) {\n          setNewNote('');\n          toast.success('Note added successfully!');\n          // Refresh the selected lead data\n          const updatedLead = await leadAPI.getLeadById(selectedLead._id);\n          if (updatedLead.data.success) {\n            setSelectedLead(updatedLead.data.data);\n          }\n        }\n      } catch (error) {\n        console.error('Add note error:', error);\n        toast.error('Failed to add note');\n      }\n    };\n\n    if (!showViewModal || !selectedLead) return null;\n\n    return (\n      <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n        <div className=\"bg-gray-900 rounded-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto border border-gray-700\">\n          <div className=\"p-6 border-b border-gray-700\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h2 className=\"text-xl font-bold text-white\">{selectedLead.firstName} {selectedLead.lastName}</h2>\n                <div className=\"flex items-center space-x-4 mt-2\">\n                  <p className=\"text-gray-400\">{selectedLead.leadId}</p>\n                  <span className={`px-3 py-1 text-sm font-semibold rounded-full border ${getStatusColor(selectedLead.status)}`}>\n                    {selectedLead.status}\n                  </span>\n                  {selectedLead.status === 'Won' && (\n                    <button\n                      onClick={() => setShowWonModal(true)}\n                      className=\"px-3 py-1 text-sm bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors\"\n                    >\n                      Won Details\n                    </button>\n                  )}\n                </div>\n              </div>\n              <div className=\"flex items-center space-x-2\">\n                <button\n                  onClick={() => setShowMeetingModal(true)}\n                  className=\"p-2 text-gray-400 hover:text-purple-400 hover:bg-gray-800 rounded-lg transition-all duration-300\"\n                  title=\"Schedule Meeting\"\n                >\n                  <Calendar className=\"w-5 h-5\" />\n                </button>\n                <button\n                  onClick={() => setShowViewModal(false)}\n                  className=\"p-2 text-gray-400 hover:text-white hover:bg-gray-800 rounded-lg\"\n                >\n                  <X className=\"w-5 h-5\" />\n                </button>\n              </div>\n            </div>\n\n            {/* Tab Navigation */}\n            <div className=\"flex space-x-1 mt-4\">\n              {['overview', 'meetings', 'notes'].map((tab) => (\n                <button\n                  key={tab}\n                  onClick={() => setActiveTab(tab)}\n                  className={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${\n                    activeTab === tab\n                      ? 'bg-pink-500/20 text-pink-400 border border-pink-500/30'\n                      : 'text-gray-400 hover:text-white hover:bg-gray-800'\n                  }`}\n                >\n                  {tab.charAt(0).toUpperCase() + tab.slice(1)}\n                </button>\n              ))}\n            </div>\n          </div>\n\n          <div className=\"p-6\">\n            {/* Overview Tab */}\n            {activeTab === 'overview' && (\n              <div className=\"space-y-6\">\n                {/* Meeting Stats */}\n                <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n                  <div className=\"bg-gray-800/50 rounded-lg p-4 border border-gray-700\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <p className=\"text-gray-400 text-sm\">Total Meetings</p>\n                        <p className=\"text-2xl font-bold text-white\">{selectedLead.totalMeetings || 0}</p>\n                      </div>\n                      <Calendar className=\"w-8 h-8 text-blue-400\" />\n                    </div>\n                  </div>\n                  <div className=\"bg-gray-800/50 rounded-lg p-4 border border-gray-700\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <p className=\"text-gray-400 text-sm\">Completed</p>\n                        <p className=\"text-2xl font-bold text-white\">{selectedLead.completedMeetings || 0}</p>\n                      </div>\n                      <CheckCircle2 className=\"w-8 h-8 text-green-400\" />\n                    </div>\n                  </div>\n                  <div className=\"bg-gray-800/50 rounded-lg p-4 border border-gray-700\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <p className=\"text-gray-400 text-sm\">Upcoming</p>\n                        <p className=\"text-2xl font-bold text-white\">{selectedLead.upcomingMeetings || 0}</p>\n                      </div>\n                      <Clock className=\"w-8 h-8 text-orange-400\" />\n                    </div>\n                  </div>\n                  <div className=\"bg-gray-800/50 rounded-lg p-4 border border-gray-700\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <p className=\"text-gray-400 text-sm\">Deal Value</p>\n                        <p className=\"text-2xl font-bold text-white\">\n                          ${(selectedLead.actualValue || selectedLead.estimatedValue || 0).toLocaleString()}\n                        </p>\n                      </div>\n                      <DollarSign className=\"w-8 h-8 text-green-400\" />\n                    </div>\n                  </div>\n                </div>\n\n                {/* Contact Information */}\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                  <div className=\"space-y-4\">\n                    <h3 className=\"text-lg font-semibold text-white border-b border-gray-700 pb-2\">\n                      Contact Information\n                    </h3>\n                    <div className=\"space-y-3\">\n                      <div className=\"flex items-center text-gray-300\">\n                        <Mail className=\"w-4 h-4 mr-3 text-gray-400\" />\n                        <span>{selectedLead.email}</span>\n                      </div>\n                      <div className=\"flex items-center text-gray-300\">\n                        <Phone className=\"w-4 h-4 mr-3 text-gray-400\" />\n                        <span>{selectedLead.phone}</span>\n                      </div>\n                      {selectedLead.company && (\n                        <div className=\"flex items-center text-gray-300\">\n                          <Building className=\"w-4 h-4 mr-3 text-gray-400\" />\n                          <span>{selectedLead.company}</span>\n                        </div>\n                      )}\n                      {selectedLead.position && (\n                        <div className=\"flex items-center text-gray-300\">\n                          <User className=\"w-4 h-4 mr-3 text-gray-400\" />\n                          <span>{selectedLead.position}</span>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-4\">\n                    <h3 className=\"text-lg font-semibold text-white border-b border-gray-700 pb-2\">\n                      Lead Details\n                    </h3>\n                    <div className=\"space-y-3\">\n                      <div className=\"flex items-center text-gray-300\">\n                        <Target className=\"w-4 h-4 mr-3 text-gray-400\" />\n                        <span>Source: {selectedLead.source}</span>\n                      </div>\n                      <div className=\"flex items-center text-gray-300\">\n                        <span className={`px-2 py-1 text-xs rounded-full border mr-3 ${getPriorityColor(selectedLead.priority)}`}>\n                          {selectedLead.priority}\n                        </span>\n                        <span>Priority</span>\n                      </div>\n                      <div className=\"flex items-center text-gray-300\">\n                        <span className=\"text-gray-400\">Assigned to:</span>\n                        <span className=\"ml-2\">\n                          {selectedLead.assignedTo?.personalInfo?.firstName} {selectedLead.assignedTo?.personalInfo?.lastName}\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Won Lead Details */}\n                {selectedLead.status === 'Won' && selectedLead.wonDetails && (\n                  <div className=\"bg-green-900/20 border border-green-700 rounded-lg p-6\">\n                    <h3 className=\"text-lg font-semibold text-green-400 mb-4 flex items-center\">\n                      <Award className=\"w-5 h-5 mr-2\" />\n                      Won Lead Details\n                    </h3>\n                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm\">\n                      <div>\n                        <p className=\"text-gray-400\">Final Value</p>\n                        <p className=\"text-white font-semibold\">${(selectedLead.wonDetails.finalValue || 0).toLocaleString()}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-gray-400\">Won Date</p>\n                        <p className=\"text-white font-semibold\">\n                          {selectedLead.wonDetails.wonDate ? new Date(selectedLead.wonDetails.wonDate).toLocaleDateString() : 'N/A'}\n                        </p>\n                      </div>\n                      <div>\n                        <p className=\"text-gray-400\">Onboarding Status</p>\n                        <span className={`px-2 py-1 text-xs rounded-full ${\n                          selectedLead.wonDetails.onboardingStatus === 'Completed' \n                            ? 'bg-green-100 text-green-800 border-green-200'\n                            : selectedLead.wonDetails.onboardingStatus === 'In Progress'\n                            ? 'bg-yellow-100 text-yellow-800 border-yellow-200'\n                            : 'bg-gray-100 text-gray-800 border-gray-200'\n                        }`}>\n                          {selectedLead.wonDetails.onboardingStatus || 'Not Started'}\n                        </span>\n                      </div>\n                      {selectedLead.wonDetails.satisfactionScore && (\n                        <div>\n                          <p className=\"text-gray-400\">Satisfaction Score</p>\n                          <div className=\"flex items-center\">\n                            <p className=\"text-white font-semibold mr-2\">{selectedLead.wonDetails.satisfactionScore}/10</p>\n                            <Star className=\"w-4 h-4 text-yellow-400\" />\n                          </div>\n                        </div>\n                      )}\n                      {selectedLead.wonDetails.recurringRevenue && (\n                        <div>\n                          <p className=\"text-gray-400\">Monthly Recurring Revenue</p>\n                          <p className=\"text-white font-semibold\">${selectedLead.wonDetails.recurringRevenue.toLocaleString()}</p>\n                        </div>\n                      )}\n                      {selectedLead.wonDetails.renewalDate && (\n                        <div>\n                          <p className=\"text-gray-400\">Renewal Date</p>\n                          <p className=\"text-white font-semibold\">\n                            {new Date(selectedLead.wonDetails.renewalDate).toLocaleDateString()}\n                          </p>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                )}\n              </div>\n            )}\n\n            {/* Meetings Tab */}\n            {activeTab === 'meetings' && (\n              <div className=\"space-y-6\">\n                <div className=\"flex justify-between items-center\">\n                  <h3 className=\"text-lg font-semibold text-white\">Meetings & Calls</h3>\n                  <button\n                    onClick={() => setShowMeetingModal(true)}\n                    className=\"px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:shadow-lg hover:shadow-purple-500/25 transition-all duration-300 flex items-center\"\n                  >\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Schedule Meeting\n                  </button>\n                </div>\n\n                <div className=\"space-y-3\">\n                  {selectedLead.meetings && selectedLead.meetings.length > 0 ? (\n                    selectedLead.meetings.map((meeting) => {\n                      const MeetingIcon = getMeetingTypeIcon(meeting.type);\n                      return (\n                        <div key={meeting._id} className=\"bg-gray-800/50 border border-gray-700 rounded-lg p-4\">\n                          <div className=\"flex items-start justify-between\">\n                            <div className=\"flex items-start space-x-3\">\n                              <div className={`p-2 rounded-lg ${\n                                meeting.status === 'Completed' ? 'bg-green-500/20 text-green-400' :\n                                meeting.status === 'Scheduled' ? 'bg-blue-500/20 text-blue-400' :\n                                'bg-gray-500/20 text-gray-400'\n                              }`}>\n                                <MeetingIcon className=\"w-5 h-5\" />\n                              </div>\n                              <div className=\"flex-1\">\n                                <div className=\"flex items-center space-x-2 mb-1\">\n                                  <h4 className=\"font-semibold text-white\">{meeting.type}</h4>\n                                  <span className={`px-2 py-1 text-xs rounded-full ${\n                                    meeting.status === 'Completed' ? 'bg-green-100 text-green-800' :\n                                    meeting.status === 'Scheduled' ? 'bg-blue-100 text-blue-800' :\n                                    'bg-gray-100 text-gray-800'\n                                  }`}>\n                                    {meeting.status}\n                                  </span>\n                                </div>\n                                <p className=\"text-gray-400 text-sm mb-2\">\n                                  {new Date(meeting.scheduledDate).toLocaleString()} • {meeting.duration} min\n                                </p>\n                                {meeting.agenda && (\n                                  <p className=\"text-gray-300 text-sm\">{meeting.agenda}</p>\n                                )}\n                                {meeting.outcome && (\n                                  <p className=\"text-gray-300 text-sm mt-2\"><strong>Outcome:</strong> {meeting.outcome}</p>\n                                )}\n                              </div>\n                            </div>\n                            <button className=\"p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors\">\n                              <Edit className=\"w-4 h-4\" />\n                            </button>\n                          </div>\n                        </div>\n                      );\n                    })\n                  ) : (\n                    <div className=\"text-center py-8\">\n                      <Calendar className=\"w-16 h-16 text-gray-600 mx-auto mb-4\" />\n                      <h4 className=\"text-lg font-medium text-white mb-2\">No meetings scheduled</h4>\n                      <p className=\"text-gray-400 mb-4\">Schedule your first meeting with this lead</p>\n                      <button\n                        onClick={() => setShowMeetingModal(true)}\n                        className=\"px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg hover:shadow-lg hover:shadow-purple-500/25 transition-all duration-300 flex items-center mx-auto\"\n                      >\n                        <Plus className=\"w-4 h-4 mr-2\" />\n                        Schedule First Meeting\n                      </button>\n                    </div>\n                  )}\n                </div>\n              </div>\n            )}\n\n            {/* Notes Tab */}\n            {activeTab === 'notes' && (\n              <div className=\"space-y-6\">\n                <h3 className=\"text-lg font-semibold text-white\">Notes & Communication History</h3>\n                \n                {/* Add Note Form */}\n                <form onSubmit={handleAddNote} className=\"space-y-3\">\n                  <textarea\n                    value={newNote}\n                    onChange={(e) => setNewNote(e.target.value)}\n                    placeholder=\"Add a note about this lead...\"\n                    rows={3}\n                    className=\"w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20 resize-none\"\n                  />\n                  <div className=\"flex justify-end\">\n                    <button\n                      type=\"submit\"\n                      disabled={!newNote.trim()}\n                      className=\"px-4 py-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-lg hover:shadow-lg hover:shadow-pink-500/25 transition-all duration-300 flex items-center disabled:opacity-50 disabled:cursor-not-allowed\"\n                    >\n                      <MessageSquare className=\"w-4 h-4 mr-2\" />\n                      Add Note\n                    </button>\n                  </div>\n                </form>\n\n                {/* Existing Notes */}\n                <div className=\"space-y-3\">\n                  {selectedLead.notes && selectedLead.notes.length > 0 ? (\n                    selectedLead.notes.map((note) => (\n                      <div key={note._id} className=\"bg-gray-800/50 border border-gray-700 rounded-lg p-4\">\n                        <div className=\"flex items-start justify-between mb-2\">\n                          <span className=\"text-sm text-gray-400\">\n                            {note.addedBy?.name || 'Unknown User'}\n                          </span>\n                          <span className=\"text-xs text-gray-500\">\n                            {new Date(note.addedAt).toLocaleString()}\n                          </span>\n                        </div>\n                        <p className=\"text-gray-300\">{note.content}</p>\n                        {note.type && note.type !== 'General' && (\n                          <span className=\"inline-block mt-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full\">\n                            {note.type}\n                          </span>\n                        )}\n                      </div>\n                    ))\n                  ) : (\n                    <div className=\"text-center py-8\">\n                      <MessageSquare className=\"w-16 h-16 text-gray-600 mx-auto mb-4\" />\n                      <h4 className=\"text-lg font-medium text-white mb-2\">No notes available</h4>\n                      <p className=\"text-gray-400\">Add your first note about this lead</p>\n                    </div>\n                  )}\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    );\n  };\n\n  const handleSearch = (e) => {\n    e.preventDefault();\n    setFilters(prev => ({ ...prev, page: 1 }));\n  };\n\n  const handleFilterChange = (filterType, value) => {\n    setFilters(prev => ({ ...prev, [filterType]: value, page: 1 }));\n  };\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black text-white\">\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"flex items-center space-x-4\">\n            <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-pink-500\"></div>\n            <span className=\"text-lg\">Loading leads...</span>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-black text-white\">\n      <div className=\"container mx-auto px-6 py-8 space-y-6\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <h1 className=\"text-3xl font-bold bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent\">\n              Lead Management System\n            </h1>\n            <p className=\"text-gray-400 mt-1\">Manage leads with advanced meeting tracking & follow-up monitoring</p>\n          </div>\n          <button\n            onClick={() => setShowAddModal(true)}\n            className=\"flex items-center px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-semibold rounded-xl hover:shadow-lg hover:shadow-pink-500/25 transition-all duration-300 transform hover:scale-105\"\n          >\n            <Plus className=\"w-5 h-5 mr-2\" />\n            Add New Lead\n          </button>\n        </div>\n\n        {/* Error Display */}\n        {error && (\n          <div className=\"bg-red-900/50 border border-red-500 rounded-xl p-4 flex items-center\">\n            <AlertTriangle className=\"w-5 h-5 text-red-400 mr-3\" />\n            <span className=\"text-red-200\">{error}</span>\n            <button\n              onClick={() => setError(null)}\n              className=\"ml-auto text-red-400 hover:text-red-200\"\n            >\n              <X className=\"w-5 h-5\" />\n            </button>\n          </div>\n        )}\n\n        {/* Stats Cards */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n          {statsCards.map((stat, index) => {\n            const Icon = stat.icon;\n            return (\n              <div key={index} className=\"bg-gray-800/50 backdrop-blur-sm border border-gray-700 rounded-xl p-6 hover:border-pink-500/30 transition-all duration-300\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <p className=\"text-gray-400 text-sm font-medium\">{stat.title}</p>\n                    <p className=\"text-2xl font-bold text-white mt-1\">{stat.value}</p>\n                    {stat.subtitle && (\n                      <p className=\"text-gray-500 text-xs mt-1\">{stat.subtitle}</p>\n                    )}\n                  </div>\n                  <div className={`p-3 bg-gradient-to-r ${stat.color} rounded-lg shadow-lg`}>\n                    <Icon className=\"w-6 h-6 text-white\" />\n                  </div>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n\n        {/* Upcoming Meetings Widget */}\n        {upcomingMeetings.length > 0 && (\n          <div className=\"bg-gray-800/50 backdrop-blur-sm border border-gray-700 rounded-xl p-6\">\n            <h3 className=\"text-lg font-semibold text-white mb-4 flex items-center\">\n              <Calendar className=\"w-5 h-5 mr-2 text-purple-400\" />\n              Upcoming Meetings\n            </h3>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n              {upcomingMeetings.map((meeting) => {\n                const MeetingIcon = getMeetingTypeIcon(meeting.meeting.type);\n                return (\n                  <div key={meeting.meeting._id} className=\"bg-gray-700/50 border border-gray-600 rounded-lg p-4\">\n                    <div className=\"flex items-start space-x-3\">\n                      <div className=\"p-2 bg-purple-500/20 text-purple-400 rounded-lg\">\n                        <MeetingIcon className=\"w-4 h-4\" />\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <h4 className=\"font-semibold text-white truncate\">{meeting.fullName}</h4>\n                        <p className=\"text-gray-400 text-sm truncate\">{meeting.company}</p>\n                        <p className=\"text-gray-300 text-sm mt-1\">\n                          {meeting.meeting.type} • {new Date(meeting.meeting.scheduledDate).toLocaleString()}\n                        </p>\n                        {meeting.meeting.agenda && (\n                          <p className=\"text-gray-400 text-xs mt-1 truncate\">{meeting.meeting.agenda}</p>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        )}\n\n        {/* Filters */}\n        <div className=\"bg-gray-800/50 backdrop-blur-sm border border-gray-700 rounded-xl p-6\">\n          <form onSubmit={handleSearch} className=\"grid grid-cols-1 md:grid-cols-5 gap-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400\" />\n              <input\n                type=\"text\"\n                placeholder=\"Search leads...\"\n                value={filters.search}\n                onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}\n                className=\"w-full pl-10 pr-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20 transition-all duration-300\"\n              />\n            </div>\n\n            <select\n              value={filters.status}\n              onChange={(e) => handleFilterChange('status', e.target.value)}\n              className=\"w-full px-3 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20 transition-all duration-300\"\n            >\n              <option value=\"all\">All Status</option>\n              <option value=\"New\">New</option>\n              <option value=\"Contacted\">Contacted</option>\n              <option value=\"Qualified\">Qualified</option>\n              <option value=\"Proposal\">Proposal</option>\n              <option value=\"Negotiation\">Negotiation</option>\n              <option value=\"Won\">Won</option>\n              <option value=\"Lost\">Lost</option>\n            </select>\n\n            <select\n              value={filters.priority}\n              onChange={(e) => handleFilterChange('priority', e.target.value)}\n              className=\"w-full px-3 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20 transition-all duration-300\"\n            >\n              <option value=\"all\">All Priority</option>\n              <option value=\"High\">High</option>\n              <option value=\"Medium\">Medium</option>\n              <option value=\"Low\">Low</option>\n              <option value=\"Hot\">Hot</option>\n            </select>\n\n            <select\n              value={filters.source}\n              onChange={(e) => handleFilterChange('source', e.target.value)}\n              className=\"w-full px-3 py-3 bg-gray-700 border border-gray-600 rounded-lg text-white focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20 transition-all duration-300\"\n            >\n              <option value=\"all\">All Sources</option>\n              <option value=\"Website\">Website</option>\n              <option value=\"Social Media\">Social Media</option>\n              <option value=\"Email Campaign\">Email Campaign</option>\n              <option value=\"Cold Call\">Cold Call</option>\n              <option value=\"Referral\">Referral</option>\n              <option value=\"Trade Show\">Trade Show</option>\n              <option value=\"Advertisement\">Advertisement</option>\n              <option value=\"Other\">Other</option>\n            </select>\n\n            <button\n              type=\"submit\"\n              className=\"px-4 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-lg hover:shadow-lg hover:shadow-pink-500/25 transition-all duration-300\"\n            >\n              Search\n            </button>\n          </form>\n        </div>\n\n        {/* Leads Table */}\n        <div className=\"bg-gray-800/50 backdrop-blur-sm border border-gray-700 rounded-xl overflow-hidden\">\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full\">\n              <thead className=\"bg-gray-700/50\">\n                <tr>\n                  <th className=\"px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider\">\n                    Lead Details\n                  </th>\n                  <th className=\"px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider\">\n                    Status & Priority\n                  </th>\n                  <th className=\"px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider\">\n                    Meetings & Value\n                  </th>\n                  <th className=\"px-6 py-4 text-left text-xs font-medium text-gray-300 uppercase tracking-wider\">\n                    Follow-up Status\n                  </th>\n                  <th className=\"px-6 py-4 text-right text-xs font-medium text-gray-300 uppercase tracking-wider\">\n                    Actions\n                  </th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-gray-700\">\n                {leads.map((lead) => {\n                  const isOverdue = lead.nextFollowUpDate && new Date(lead.nextFollowUpDate) < new Date();\n                  const assignedTo = lead.assignedTo?.personalInfo || {};\n                  \n                  return (\n                    <tr key={lead._id} className=\"hover:bg-gray-700/30 transition-colors duration-200\">\n                      <td className=\"px-6 py-4\">\n                        <div className=\"flex items-center\">\n                          <div className=\"flex-shrink-0 h-10 w-10\">\n                            <div className=\"h-10 w-10 rounded-full bg-gradient-to-r from-pink-500 to-purple-600 flex items-center justify-center\">\n                              <span className=\"text-white font-semibold\">\n                                {lead.firstName?.[0] || ''}{lead.lastName?.[0] || ''}\n                              </span>\n                            </div>\n                          </div>\n                          <div className=\"ml-4\">\n                            <div className=\"text-sm font-medium text-white\">\n                              {lead.firstName} {lead.lastName}\n                            </div>\n                            <div className=\"text-sm text-gray-400\">{lead.email}</div>\n                            {lead.company && (\n                              <div className=\"text-xs text-gray-500\">{lead.company}</div>\n                            )}\n                            <div className=\"text-xs text-gray-500\">\n                              ID: {lead.leadId}\n                            </div>\n                          </div>\n                        </div>\n                      </td>\n                      <td className=\"px-6 py-4\">\n                        <div className=\"space-y-2\">\n                          <span className={`inline-flex px-3 py-1 text-xs font-semibold rounded-full border ${getStatusColor(lead.status)}`}>\n                            {lead.status}\n                          </span>\n                          <br />\n                          <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full border ${getPriorityColor(lead.priority)}`}>\n                            {lead.priority}\n                          </span>\n                          <div className=\"text-xs text-gray-500 mt-1\">\n                            by {assignedTo.firstName || 'Unknown'} {assignedTo.lastName || ''}\n                          </div>\n                        </div>\n                      </td>\n                      <td className=\"px-6 py-4\">\n                        <div className=\"text-sm\">\n                          <div className=\"text-white font-medium mb-1\">\n                            ${(lead.actualValue || lead.estimatedValue || 0).toLocaleString()}\n                          </div>\n                          <div className=\"text-gray-400 text-xs\">\n                            {lead.totalMeetings || 0} meetings ({lead.completedMeetings || 0} completed)\n                          </div>\n                          {lead.status === 'Won' && lead.wonDetails?.satisfactionScore && (\n                            <div className=\"flex items-center mt-1\">\n                              <Star className=\"w-3 h-3 text-yellow-400 mr-1\" />\n                              <span className=\"text-xs text-gray-400\">{lead.wonDetails.satisfactionScore}/10</span>\n                            </div>\n                          )}\n                        </div>\n                      </td>\n                      <td className=\"px-6 py-4\">\n                        <div className=\"text-sm\">\n                          {lead.nextFollowUpDate ? (\n                            <div className={`${isOverdue ? 'text-red-400' : 'text-orange-400'}`}>\n                              <div className=\"font-medium flex items-center\">\n                                <AlertCircle className={`w-3 h-3 mr-1 ${isOverdue ? 'text-red-400' : 'text-orange-400'}`} />\n                                {isOverdue ? 'Overdue' : 'Follow-up Due'}\n                              </div>\n                              <div className=\"text-xs\">\n                                {new Date(lead.nextFollowUpDate).toLocaleDateString()}\n                              </div>\n                            </div>\n                          ) : (\n                            <div className=\"text-gray-500\">\n                              No follow-up scheduled\n                            </div>\n                          )}\n                          {lead.nextMeetingDate && (\n                            <div className=\"text-purple-400 text-xs mt-1\">\n                              Next meeting: {new Date(lead.nextMeetingDate).toLocaleDateString()}\n                            </div>\n                          )}\n                        </div>\n                      </td>\n                      <td className=\"px-6 py-4 text-right\">\n                        <div className=\"flex items-center justify-end space-x-2\">\n                          <button\n                            onClick={() => {\n                              setSelectedLead(lead);\n                              setShowViewModal(true);\n                            }}\n                            className=\"p-2 text-gray-400 hover:text-blue-400 hover:bg-gray-700 rounded-lg transition-all duration-300\"\n                            title=\"View Lead\"\n                          >\n                            <Eye className=\"w-4 h-4\" />\n                          </button>\n                          {lead.status === 'Won' && (\n                            <button\n                              onClick={() => {\n                                setSelectedLead(lead);\n                                setShowWonModal(true);\n                              }}\n                              className=\"p-2 text-gray-400 hover:text-green-400 hover:bg-gray-700 rounded-lg transition-all duration-300\"\n                              title=\"Won Details\"\n                            >\n                              <Award className=\"w-4 h-4\" />\n                            </button>\n                          )}\n                          <button\n                            onClick={() => {\n                              setSelectedLead(lead);\n                              setShowMeetingModal(true);\n                            }}\n                            className=\"p-2 text-gray-400 hover:text-purple-400 hover:bg-gray-700 rounded-lg transition-all duration-300\"\n                            title=\"Schedule Meeting\"\n                          >\n                            <Calendar className=\"w-4 h-4\" />\n                          </button>\n                        </div>\n                      </td>\n                    </tr>\n                  );\n                })}\n              </tbody>\n            </table>\n          </div>\n\n          {/* Pagination */}\n          {pagination.totalPages > 1 && (\n            <div className=\"px-6 py-4 bg-gray-700/30 border-t border-gray-600 flex items-center justify-between\">\n              <div className=\"text-sm text-gray-400\">\n                Showing {((pagination.currentPage - 1) * filters.limit) + 1} to {Math.min(pagination.currentPage * filters.limit, pagination.totalLeads)} of {pagination.totalLeads} leads\n              </div>\n              <div className=\"flex space-x-2\">\n                <button\n                  onClick={() => setFilters(prev => ({ ...prev, page: prev.page - 1 }))}\n                  disabled={!pagination.hasPrev}\n                  className=\"px-3 py-2 text-sm bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed\"\n                >\n                  Previous\n                </button>\n                <span className=\"px-3 py-2 text-sm text-gray-300\">\n                  Page {pagination.currentPage} of {pagination.totalPages}\n                </span>\n                <button\n                  onClick={() => setFilters(prev => ({ ...prev, page: prev.page + 1 }))}\n                  disabled={!pagination.hasNext}\n                  className=\"px-3 py-2 text-sm bg-gray-700 text-gray-300 rounded-lg hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed\"\n                >\n                  Next\n                </button>\n              </div>\n            </div>\n          )}\n        </div>\n\n        {/* Empty State */}\n        {leads.length === 0 && !loading && (\n          <div className=\"text-center py-12\">\n            <Users className=\"w-16 h-16 text-gray-600 mx-auto mb-4\" />\n            <h3 className=\"text-lg font-medium text-white mb-2\">No leads found</h3>\n            <p className=\"text-gray-400 mb-6\">\n              {filters.search || filters.status !== 'all' || filters.priority !== 'all' || filters.source !== 'all'\n                ? 'Try adjusting your filters or search terms'\n                : 'Get started by adding your first lead'\n              }\n            </p>\n            {!filters.search && filters.status === 'all' && filters.priority === 'all' && filters.source === 'all' && (\n              <button\n                onClick={() => setShowAddModal(true)}\n                className=\"inline-flex items-center px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-semibold rounded-xl hover:shadow-lg hover:shadow-pink-500/25 transition-all duration-300\"\n              >\n                <Plus className=\"w-5 h-5 mr-2\" />\n                Add Your First Lead\n              </button>\n            )}\n          </div>\n        )}\n      </div>\n\n      {/* Modals */}\n      <AddLeadModal />\n      <WonLeadModal />\n      <MeetingModal />\n      <ViewLeadModal />\n    </div>\n  );\n};\n\nexport default LeadManagement;","path":null,"size_bytes":71225,"size_tokens":null},"backend/models/PurchaseOrder.js":{"content":"import mongoose from 'mongoose';\n\nconst lineItemSchema = new mongoose.Schema({\n  item: {\n    type: String,\n    required: true,\n    trim: true\n  },\n  description: {\n    type: String,\n    trim: true\n  },\n  quantity: {\n    type: Number,\n    required: true,\n    min: 1\n  },\n  unitPrice: {\n    type: Number,\n    required: true,\n    min: 0\n  },\n  total: {\n    type: Number,\n    default: 0\n  }\n});\n\nconst purchaseOrderSchema = new mongoose.Schema({\n  poNumber: {\n    type: String,\n    required: true,\n    trim: true\n  },\n  supplier: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'Supplier',\n    required: true\n  },\n  status: {\n    type: String,\n    enum: ['Draft', 'PendingApproval', 'Approved', 'Ordered', 'Received', 'Closed'],\n    default: 'Draft'\n  },\n  deliveryDate: {\n    type: Date,\n    required: true\n  },\n  paymentTerms: {\n    type: String,\n    trim: true\n  },\n  notes: {\n    type: String,\n    trim: true\n  },\n  lineItems: [lineItemSchema],\n  totalAmount: {\n    type: Number,\n    default: 0\n  },\n  grandTotal: {\n    type: Number,\n    default: 0\n  },\n  createdBy: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true\n  }\n}, {\n  timestamps: true\n});\n\n// Indexes for performance - poNumber is unique\npurchaseOrderSchema.index({ poNumber: 1 }, { unique: true });\npurchaseOrderSchema.index({ status: 1 });\npurchaseOrderSchema.index({ supplier: 1 });\npurchaseOrderSchema.index({ createdAt: -1 });\n\n// Pre-save middleware to calculate totals\npurchaseOrderSchema.pre('save', function(next) {\n  this.totalAmount = this.lineItems.reduce((sum, item) => sum + (item.total || 0), 0);\n  this.grandTotal = this.totalAmount; // Add tax logic here if needed\n  next();\n});\n\nconst PurchaseOrder = mongoose.model('PurchaseOrder', purchaseOrderSchema);\n\nexport default PurchaseOrder;\n","path":null,"size_bytes":1799,"size_tokens":null},"backend/routes/botRoutes.js":{"content":"import express from 'express';\nimport { processMessage, processAdminMessage, getBotHistory } from '../controllers/botController.js';\nimport { protect } from '../middleware/auth.js';\nimport fs from 'fs';\nimport path from 'path';\n\nconst router = express.Router();\nrouter.use(protect);\n\nrouter.post('/message', processMessage);\nrouter.post('/admin-message', processAdminMessage);\nrouter.get('/history/:userId', getBotHistory);\n\nrouter.get('/download/:filename', protect, (req, res) => {\n  const { filename } = req.params;\n  if (!filename.endsWith('.pdf') || filename.includes('..')) {\n    return res.status(400).json({ success: false, message: 'Invalid file' });\n  }\n\n  const filePath = path.join(process.cwd(), 'temp', filename);\n  if (!fs.existsSync(filePath)) {\n    return res.status(404).json({ success: false, message: 'File not found' });\n  }\n\n  res.download(filePath, (err) => {\n    if (!err) {\n      setTimeout(() => {\n        if (fs.existsSync(filePath)) {\n          fs.unlinkSync(filePath);\n        }\n      }, 30000);\n    }\n  });\n});\n\nexport default router;\n","path":null,"size_bytes":1065,"size_tokens":null},"backend/models/Department.js":{"content":"import mongoose from 'mongoose';\n\nconst departmentSchema = new mongoose.Schema({\n  name: { type: String, required: true, unique: true, trim: true },\n  code: { type: String, required: true, unique: true, uppercase: true, trim: true },\n  description: { type: String, default: '' },\n  manager: { type: String, default: '' },\n  location: { type: String, default: '' },\n  budget: { type: Number, default: 0 },\n  status: { type: String, enum: ['Active', 'Inactive', 'Restructuring'], default: 'Active' },\n  establishedDate: { type: Date, default: Date.now },\n  goals: [{ type: String, trim: true }],\n  parentDepartment: { type: mongoose.Schema.Types.ObjectId, ref: 'Department', default: null },\n  employeeCount: { type: Number, default: 0 }\n}, {\n  timestamps: true\n});\n\n// FIXED: Method to update employee count using ObjectId instead of name\ndepartmentSchema.methods.updateEmployeeCount = async function () {\n  try {\n    const Employee = mongoose.model('Employee');\n    // Use ObjectId (_id) instead of name for matching\n    const count = await Employee.countDocuments({ \n      'workInfo.department': this._id, // Changed from this.name to this._id\n      status: { $ne: 'Terminated' } \n    });\n    this.employeeCount = count;\n    await this.save();\n    return this.employeeCount;\n  } catch (error) {\n    console.error('Error updating employee count for department', this.name, ':', error);\n    return 0;\n  }\n};\n\n// Static method to get departments with employee counts\ndepartmentSchema.statics.getWithEmployeeCounts = async function () {\n  const departments = await this.find().sort({ name: 1 });\n  for (const dept of departments) {\n    await dept.updateEmployeeCount();\n  }\n  return departments;\n};\n\n// Static method for getting department statistics\ndepartmentSchema.statics.getDepartmentStats = async function() {\n  try {\n    const Employee = mongoose.model('Employee');\n    \n    const totalDepartments = await this.countDocuments();\n    const activeDepartments = await this.countDocuments({ status: 'Active' });\n    const inactiveDepartments = await this.countDocuments({ status: 'Inactive' });\n    \n    // Get department with most employees\n    const deptWithMostEmployees = await this.aggregate([\n      {\n        $lookup: {\n          from: 'employees',\n          localField: '_id',\n          foreignField: 'workInfo.department',\n          as: 'employees'\n        }\n      },\n      {\n        $project: {\n          name: 1,\n          code: 1,\n          employeeCount: { $size: '$employees' }\n        }\n      },\n      { $sort: { employeeCount: -1 } },\n      { $limit: 1 }\n    ]);\n\n    return {\n      total: totalDepartments,\n      active: activeDepartments,\n      inactive: inactiveDepartments,\n      restructuring: totalDepartments - activeDepartments - inactiveDepartments,\n      largestDepartment: deptWithMostEmployees[0] || null\n    };\n  } catch (error) {\n    console.error('Error getting department stats:', error);\n    return {\n      total: 0,\n      active: 0,\n      inactive: 0,\n      restructuring: 0,\n      largestDepartment: null\n    };\n  }\n};\n\nconst Department = mongoose.model('Department', departmentSchema);\n\nexport default Department;","path":null,"size_bytes":3148,"size_tokens":null},"backend/controllers/taskController.js":{"content":"// controllers/taskController.js\nimport { validationResult } from 'express-validator';\nimport Task from '../models/Task.js';\nimport Employee from '../models/Employee.js';\nimport User from '../models/User.js';\n\n// @desc    Create new task\n// @route   POST /api/tasks\n// @access  Private (Admin)\nexport const createTask = async (req, res) => {\n  try {\n    // Check if user is admin\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      console.log('Validation errors details:', errors.array());\n      console.log('Request body:', req.body);\n      return res.status(400).json({\n        success: false,\n        message: 'Validation errors',\n        errors: errors.array()\n      });\n    }\n\n    // Create the task\n    const taskData = {\n      title: req.body.title,\n      description: req.body.description,\n      assignedTo: req.body.assignedTo,\n      assignedBy: req.user.id,\n      project: req.body.project || '',\n      priority: req.body.priority || 'Medium',\n      dueDate: req.body.dueDate,\n      category: req.body.category || 'Other',\n      estimatedHours: req.body.estimatedHours || 0,\n      status: 'Not Started',\n      progress: 0\n    };\n\n    console.log('Creating task with data:', taskData);\n\n    const task = await Task.create(taskData);\n\n    // Populate the created task\n    const populatedTask = await Task.findById(task._id)\n      .populate([\n        {\n          path: 'assignedTo',\n          populate: {\n            path: 'user',\n            select: 'name email employeeId'\n          }\n        },\n        {\n          path: 'assignedBy',\n          select: 'name email'\n        }\n      ]);\n\n    console.log('Task created successfully:', populatedTask._id);\n\n    res.status(201).json({\n      success: true,\n      message: 'Task created successfully',\n      task: populatedTask\n    });\n\n  } catch (error) {\n    console.error('Create task error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// @desc    Get all tasks\n// @route   GET /api/tasks\n// @access  Private\n\nexport const getTasks = async (req, res) => {\n  try {\n    const { \n      page = 1, \n      limit = 50, \n      status, \n      priority, \n      project, \n      assignedTo, \n      search,\n      category,\n      overdue\n    } = req.query;\n\n    let query = {};\n\n    // Build query based on user role\n    if (req.user.role === 'employee') {\n      // Employees can only see their own tasks\n      const employee = await Employee.findOne({ user: req.user.id });\n      console.log('Employee lookup - User ID:', req.user.id);\n      console.log('Employee found:', employee);\n      \n      if (employee) {\n        query.assignedTo = employee._id;\n        console.log('Employee query filter:', query);\n      } else {\n        console.log('No employee record found for user:', req.user.id);\n        return res.json({\n          success: true,\n          tasks: [],\n          pagination: {\n            currentPage: parseInt(page),\n            totalPages: 0,\n            totalTasks: 0,\n            hasNext: false,\n            hasPrev: false\n          }\n        });\n      }\n    }\n\n    // Apply other filters\n    if (status) query.status = status;\n    if (priority) query.priority = priority;\n    if (project) query.project = project;\n    if (category) query.category = category;\n    if (assignedTo && req.user.role === 'admin') query.assignedTo = assignedTo;\n\n    // Handle overdue filter\n    if (overdue === 'true') {\n      query.dueDate = { $lt: new Date() };\n      query.status = { $nin: ['Completed', 'Cancelled'] };\n    }\n\n    // Handle search - move to database level\n    if (search) {\n      const searchRegex = new RegExp(search, 'i');\n      query.$or = [\n        { title: searchRegex },\n        { description: searchRegex },\n        { project: searchRegex }\n      ];\n    }\n\n    console.log('Final MongoDB query:', query);\n\n    // Execute the query\n    const tasks = await Task.find(query)\n      .populate([\n        {\n          path: 'assignedTo',\n          populate: {\n            path: 'user',\n            select: 'name email employeeId'\n          }\n        },\n        {\n          path: 'assignedBy',\n          select: 'name email'\n        }\n      ])\n      .sort({ createdAt: -1 })\n      .limit(limit * 1)\n      .skip((page - 1) * limit);\n\n    console.log('Found tasks count:', tasks.length);\n\n    const total = await Task.countDocuments(query);\n    console.log('Total tasks matching query:', total);\n\n    res.json({\n      success: true,\n      tasks,\n      pagination: {\n        currentPage: parseInt(page),\n        totalPages: Math.ceil(total / limit),\n        totalTasks: total,\n        hasNext: page < Math.ceil(total / limit),\n        hasPrev: page > 1\n      }\n    });\n\n  } catch (error) {\n    console.error('Get tasks error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n\n// @desc    Get task by ID\n// @route   GET /api/tasks/:id\n// @access  Private\nexport const getTaskById = async (req, res) => {\n  try {\n    const task = await Task.findById(req.params.id)\n      .populate([\n        {\n          path: 'assignedTo',\n          populate: {\n            path: 'user',\n            select: 'name email employeeId'\n          }\n        },\n        {\n          path: 'assignedBy',\n          select: 'name email'\n        },\n        {\n          path: 'comments.user',\n          select: 'name email'\n        }\n      ]);\n\n    if (!task) {\n      return res.status(404).json({\n        success: false,\n        message: 'Task not found'\n      });\n    }\n\n    // Check permissions - employees can only view their own tasks\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee || task.assignedTo._id.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied'\n        });\n      }\n    }\n\n    res.json({\n      success: true,\n      task\n    });\n\n  } catch (error) {\n    console.error('Get task by ID error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// @desc    Update task\n// @route   PUT /api/tasks/:id\n// @access  Private\nexport const updateTask = async (req, res) => {\n  try {\n    const task = await Task.findById(req.params.id);\n\n    if (!task) {\n      return res.status(404).json({\n        success: false,\n        message: 'Task not found'\n      });\n    }\n\n    // Check permissions\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee || task.assignedTo.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied'\n        });\n      }\n      \n      // Employees can only update specific fields\n      const allowedUpdates = ['status', 'progress', 'actualHours', 'comments', 'subtasks'];\n      const updates = {};\n      \n      Object.keys(req.body).forEach(key => {\n        if (allowedUpdates.includes(key)) {\n          updates[key] = req.body[key];\n        }\n      });\n      \n      req.body = updates;\n    }\n\n    const updatedTask = await Task.findByIdAndUpdate(\n      req.params.id,\n      req.body,\n      { new: true, runValidators: true }\n    ).populate([\n      {\n        path: 'assignedTo',\n        populate: {\n          path: 'user',\n          select: 'name email employeeId'\n        }\n      },\n      {\n        path: 'assignedBy',\n        select: 'name email'\n      }\n    ]);\n\n    res.json({\n      success: true,\n      message: 'Task updated successfully',\n      task: updatedTask\n    });\n\n  } catch (error) {\n    console.error('Update task error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// @desc    Delete task\n// @route   DELETE /api/tasks/:id\n// @access  Private (Admin)\nexport const deleteTask = async (req, res) => {\n  try {\n    // Check if user is admin\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const task = await Task.findById(req.params.id);\n    if (!task) {\n      return res.status(404).json({\n        success: false,\n        message: 'Task not found'\n      });\n    }\n\n    await Task.findByIdAndDelete(req.params.id);\n\n    res.json({\n      success: true,\n      message: 'Task deleted successfully'\n    });\n\n  } catch (error) {\n    console.error('Delete task error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// @desc    Add comment to task\n// @route   POST /api/tasks/:id/comments\n// @access  Private\nexport const addComment = async (req, res) => {\n  try {\n    const { text } = req.body;\n\n    if (!text || !text.trim()) {\n      return res.status(400).json({\n        success: false,\n        message: 'Comment text is required'\n      });\n    }\n\n    const task = await Task.findById(req.params.id);\n    if (!task) {\n      return res.status(404).json({\n        success: false,\n        message: 'Task not found'\n      });\n    }\n\n    // Check permissions\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee || task.assignedTo.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied'\n        });\n      }\n    }\n\n    await task.addComment(req.user.id, text.trim());\n\n    // Populate and return updated task\n    const updatedTask = await Task.findById(req.params.id)\n      .populate([\n        {\n          path: 'assignedTo',\n          populate: {\n            path: 'user',\n            select: 'name email employeeId'\n          }\n        },\n        {\n          path: 'comments.user',\n          select: 'name email'\n        }\n      ]);\n\n    res.json({\n      success: true,\n      message: 'Comment added successfully',\n      task: updatedTask\n    });\n\n  } catch (error) {\n    console.error('Add comment error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// @desc    Update task progress\n// @route   PUT /api/tasks/:id/progress\n// @access  Private\nexport const updateProgress = async (req, res) => {\n  try {\n    const { progress } = req.body;\n\n    if (progress < 0 || progress > 100) {\n      return res.status(400).json({\n        success: false,\n        message: 'Progress must be between 0 and 100'\n      });\n    }\n\n    const task = await Task.findById(req.params.id);\n    if (!task) {\n      return res.status(404).json({\n        success: false,\n        message: 'Task not found'\n      });\n    }\n\n    // Check permissions\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee || task.assignedTo.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied'\n        });\n      }\n    }\n\n    await task.updateProgress(progress);\n\n    const updatedTask = await Task.findById(req.params.id)\n      .populate([\n        {\n          path: 'assignedTo',\n          populate: {\n            path: 'user',\n            select: 'name email employeeId'\n          }\n        }\n      ]);\n\n    res.json({\n      success: true,\n      message: 'Progress updated successfully',\n      task: updatedTask\n    });\n\n  } catch (error) {\n    console.error('Update progress error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// @desc    Change task status\n// @route   PUT /api/tasks/:id/status\n// @access  Private\nexport const changeStatus = async (req, res) => {\n  try {\n    const { status } = req.body;\n\n    const validStatuses = ['Not Started', 'In Progress', 'Review', 'Completed', 'On Hold', 'Cancelled'];\n    if (!validStatuses.includes(status)) {\n      return res.status(400).json({\n        success: false,\n        message: 'Invalid status'\n      });\n    }\n\n    const task = await Task.findById(req.params.id);\n    if (!task) {\n      return res.status(404).json({\n        success: false,\n        message: 'Task not found'\n      });\n    }\n\n    // Check permissions\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee || task.assignedTo.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied'\n        });\n      }\n    }\n\n    await task.changeStatus(status);\n\n    const updatedTask = await Task.findById(req.params.id)\n      .populate([\n        {\n          path: 'assignedTo',\n          populate: {\n            path: 'user',\n            select: 'name email employeeId'\n          }\n        }\n      ]);\n\n    res.json({\n      success: true,\n      message: 'Status updated successfully',\n      task: updatedTask\n    });\n\n  } catch (error) {\n    console.error('Change status error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// @desc    Get task statistics\n// @route   GET /api/tasks/stats\n// @access  Private\nexport const getTaskStats = async (req, res) => {\n  try {\n    let query = {};\n\n    // If employee, only show their stats\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (employee) {\n        query.assignedTo = employee._id;\n      }\n    }\n\n    const totalTasks = await Task.countDocuments(query);\n    const inProgressTasks = await Task.countDocuments({ ...query, status: 'In Progress' });\n    const completedTasks = await Task.countDocuments({ ...query, status: 'Completed' });\n    const overdueTasks = await Task.countDocuments({\n      ...query,\n      status: { $nin: ['Completed', 'Cancelled'] },\n      dueDate: { $lt: new Date() }\n    });\n\n    // Project-wise task distribution\n    const projectStats = await Task.aggregate([\n      { $match: query },\n      { $group: { _id: '$project', count: { $sum: 1 } } },\n      { $sort: { count: -1 } },\n      { $limit: 10 }\n    ]);\n\n    // Priority-wise distribution\n    const priorityStats = await Task.aggregate([\n      { $match: query },\n      { $group: { _id: '$priority', count: { $sum: 1 } } }\n    ]);\n\n    // Status-wise distribution\n    const statusStats = await Task.aggregate([\n      { $match: query },\n      { $group: { _id: '$status', count: { $sum: 1 } } }\n    ]);\n\n    res.json({\n      success: true,\n      stats: {\n        total: totalTasks,\n        inProgress: inProgressTasks,\n        completed: completedTasks,\n        overdue: overdueTasks,\n        projectDistribution: projectStats,\n        priorityDistribution: priorityStats,\n        statusDistribution: statusStats\n      }\n    });\n\n  } catch (error) {\n    console.error('Get task stats error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// @desc    Toggle subtask completion\n// @route   PUT /api/tasks/:id/subtasks/:subtaskId\n// @access  Private\nexport const toggleSubtask = async (req, res) => {\n  try {\n    const { id: taskId, subtaskId } = req.params;\n\n    const task = await Task.findById(taskId);\n    if (!task) {\n      return res.status(404).json({\n        success: false,\n        message: 'Task not found'\n      });\n    }\n\n    // Check permissions\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee || task.assignedTo.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied'\n        });\n      }\n    }\n\n    await task.toggleSubtask(subtaskId);\n\n    const updatedTask = await Task.findById(taskId)\n      .populate([\n        {\n          path: 'assignedTo',\n          populate: {\n            path: 'user',\n            select: 'name email employeeId'\n          }\n        }\n      ]);\n\n    res.json({\n      success: true,\n      message: 'Subtask updated successfully',\n      task: updatedTask\n    });\n\n  } catch (error) {\n    console.error('Toggle subtask error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};","path":null,"size_bytes":16473,"size_tokens":null},"backend/controllers/aiController.js":{"content":"import { GoogleGenerativeAI } from '@google/generative-ai';\n\n// Initialize Gemini AI\nconst genAI = new GoogleGenerativeAI(process.env.GOOGLE_AI_API_KEY);\n\n// @desc    Handle AI chat requests\n// @route   POST /api/ai/chat\n// @access  Private (Admin)\nconst chat = async (req, res) => {\n  try {\n    const { message } = req.body;\n\n    if (!message || typeof message !== 'string' || message.trim() === '') {\n      return res.status(400).json({\n        success: false,\n        message: 'Message is required and must be a non-empty string'\n      });\n    }\n\n    // Get the generative model\n    const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });\n\n    // System prompt for EMS context\n    const systemPrompt = `You are an AI assistant for an Employee Management System (EMS). You help administrators with HR operations, employee management, leave requests, tasks, departments, attendance, and general questions about the system.\n\nKey features of the EMS:\n- Employee management (add, update, view employees)\n- Department management\n- Leave management and approvals\n- Task/project management\n- Attendance tracking\n- Face recognition for biometric login\n- Admin dashboard with statistics\n- User roles: Admin and Employee\n\nAlways provide helpful, accurate responses. If asked about specific data, remind that you can help with general guidance but actual data queries should be done through the system interface.\n\nKeep responses concise but informative.`;\n\n    // Generate content\n    const result = await model.generateContent([\n      { text: systemPrompt },\n      { text: `User question: ${message}` }\n    ]);\n\n    const response = await result.response;\n    const aiResponse = response.text();\n\n    res.status(200).json({\n      success: true,\n      message: aiResponse\n    });\n\n  } catch (error) {\n    console.error('AI Chat error:', error);\n\n    // Handle specific Gemini API errors\n    if (error.message?.includes('API_KEY')) {\n      return res.status(500).json({\n        success: false,\n        message: 'AI service configuration error. Please check API key.'\n      });\n    }\n\n    if (error.message?.includes('quota') || error.message?.includes('rate limit')) {\n      return res.status(429).json({\n        success: false,\n        message: 'AI service temporarily unavailable due to high demand. Please try again later.'\n      });\n    }\n\n    res.status(500).json({\n      success: false,\n      message: 'AI service temporarily unavailable. Please try again later.'\n    });\n  }\n};\n\nexport { chat };\n","path":null,"size_bytes":2508,"size_tokens":null},"backend/models/Supplier.js":{"content":"import mongoose from 'mongoose';\n\nconst supplierSchema = new mongoose.Schema({\n  name: {\n    type: String,\n    required: true,\n    trim: true\n  },\n  email: {\n    type: String,\n    trim: true,\n    lowercase: true\n  },\n  phone: {\n    type: String,\n    trim: true\n  },\n  address: {\n    type: String,\n    trim: true\n  },\n  isActive: {\n    type: Boolean,\n    default: true\n  }\n}, {\n  timestamps: true\n});\n\n// Index for faster queries\nsupplierSchema.index({ name: 1 });\nsupplierSchema.index({ isActive: 1 });\n\nconst Supplier = mongoose.model('Supplier', supplierSchema);\n\nexport default Supplier;\n","path":null,"size_bytes":591,"size_tokens":null},"backend/controllers/purchaseController.js":{"content":"import mongoose from 'mongoose';\nimport PurchaseOrder from '../models/PurchaseOrder.js';\nimport Supplier from '../models/Supplier.js';\n\n// Get all purchase orders with filters\nexport const getPurchaseOrders = async (req, res) => {\n  try {\n    const { status, supplier, startDate, endDate, search, page = 1, limit = 50 } = req.query;\n\n    const query = {};\n\n    // Status filter\n    if (status && status !== 'all') {\n      query.status = status;\n    }\n\n    // Supplier filter\n    if (supplier && supplier.trim() !== '' && mongoose.Types.ObjectId.isValid(supplier.trim())) {\n      query.supplier = supplier.trim();\n    }\n\n    // Date range filter (on createdAt)\n    if (startDate || endDate) {\n      query.createdAt = {};\n      if (startDate) {\n        const start = new Date(startDate);\n        if (!isNaN(start.getTime())) {\n          query.createdAt.$gte = start;\n        }\n      }\n      if (endDate) {\n        const end = new Date(endDate);\n        if (!isNaN(end.getTime())) {\n          query.createdAt.$lte = end;\n        }\n      }\n    }\n\n    // Search filter\n    if (search) {\n      query.$or = [\n        { poNumber: { $regex: search, $options: 'i' } },\n        { 'lineItems.item': { $regex: search, $options: 'i' } },\n        { 'lineItems.description': { $regex: search, $options: 'i' } }\n      ];\n    }\n\n    const purchaseOrders = await PurchaseOrder.find(query)\n      .populate('supplier', 'name email phone')\n      .populate('createdBy', 'name email')\n      .sort({ createdAt: -1 })\n      .limit(limit * 1)\n      .skip((page - 1) * limit);\n\n    const total = await PurchaseOrder.countDocuments(query);\n\n    res.json({\n      success: true,\n      data: {\n        purchaseOrders,\n        pagination: {\n          currentPage: parseInt(page),\n          totalPages: Math.ceil(total / limit),\n          totalPurchaseOrders: total,\n          hasNext: page < Math.ceil(total / limit),\n          hasPrev: page > 1\n        }\n      }\n    });\n\n  } catch (error) {\n    console.error('Get purchase orders error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get all suppliers\nexport const getSuppliers = async (req, res) => {\n  try {\n    const suppliers = await Supplier.find({ isActive: true })\n      .select('name email phone address')\n      .sort({ name: 1 });\n\n    res.json({\n      success: true,\n      data: {\n        suppliers\n      }\n    });\n\n  } catch (error) {\n    console.error('Get suppliers error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Create new supplier\nexport const createSupplier = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { name, email, phone, address } = req.body;\n\n    // Validate required fields\n    if (!name) {\n      return res.status(400).json({\n        success: false,\n        message: 'Supplier name is required'\n      });\n    }\n\n    // Check if supplier already exists (only check provided fields)\n    const orConditions = [];\n    if (email) orConditions.push({ email });\n    if (phone) orConditions.push({ phone });\n\n    if (orConditions.length > 0) {\n      const existingSupplier = await Supplier.findOne({ $or: orConditions });\n      if (existingSupplier) {\n        return res.status(400).json({\n          success: false,\n          message: 'Supplier with this email or phone already exists'\n        });\n      }\n    }\n\n    const supplier = new Supplier({\n      name,\n      email,\n      phone,\n      address,\n      createdBy: req.user.id\n    });\n\n    await supplier.save();\n\n    res.status(201).json({\n      success: true,\n      message: 'Supplier created successfully',\n      data: supplier\n    });\n\n  } catch (error) {\n    console.error('Create supplier error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Create new purchase order\nexport const createPurchaseOrder = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { supplier, ...poData } = req.body;\n\n    // Validate supplier exists\n    const supplierDoc = await Supplier.findById(supplier);\n    if (!supplierDoc) {\n      return res.status(400).json({\n        success: false,\n        message: 'Invalid supplier'\n      });\n    }\n\n    // Generate PO number\n    const poNumber = `PO-${Date.now()}`;\n\n    const purchaseOrder = new PurchaseOrder({\n      ...poData,\n      poNumber,\n      supplier,\n      createdBy: req.user.id\n    });\n\n    await purchaseOrder.save();\n    await purchaseOrder.populate('supplier', 'name email phone');\n    await purchaseOrder.populate('createdBy', 'name email');\n\n    res.status(201).json({\n      success: true,\n      message: 'Purchase order created successfully',\n      data: purchaseOrder\n    });\n\n  } catch (error) {\n    console.error('Create purchase order error:', error);\n    if (error.code === 11000) { // Duplicate key\n      res.status(400).json({\n        success: false,\n        message: 'PO number already exists'\n      });\n    } else {\n      res.status(400).json({\n        success: false,\n        message: error.message\n      });\n    }\n  }\n};\n\n// Update purchase order\nexport const updatePurchaseOrder = async (req, res) => {\n  try {\n    const purchaseOrder = await PurchaseOrder.findById(req.params.id);\n\n    if (!purchaseOrder) {\n      return res.status(404).json({\n        success: false,\n        message: 'Purchase order not found'\n      });\n    }\n\n    // Check ownership or admin access\n    if (purchaseOrder.createdBy.toString() !== req.user.id.toString() && req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. You can only update your own purchase orders.'\n      });\n    }\n\n    const { supplier, ...updateData } = req.body;\n\n    // Validate supplier if provided\n    if (supplier) {\n      const supplierDoc = await Supplier.findById(supplier);\n      if (!supplierDoc) {\n        return res.status(400).json({\n          success: false,\n          message: 'Invalid supplier'\n        });\n      }\n      updateData.supplier = supplier;\n    }\n\n    Object.assign(purchaseOrder, updateData);\n    await purchaseOrder.save();\n    await purchaseOrder.populate('supplier', 'name email phone');\n    await purchaseOrder.populate('createdBy', 'name email');\n\n    res.json({\n      success: true,\n      message: 'Purchase order updated successfully',\n      data: purchaseOrder\n    });\n\n  } catch (error) {\n    console.error('Update purchase order error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Delete purchase order\nexport const deletePurchaseOrder = async (req, res) => {\n  try {\n    const purchaseOrder = await PurchaseOrder.findById(req.params.id);\n\n    if (!purchaseOrder) {\n      return res.status(404).json({\n        success: false,\n        message: 'Purchase order not found'\n      });\n    }\n\n    // Check ownership or admin access\n    if (purchaseOrder.createdBy.toString() !== req.user.id.toString() && req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. You can only delete your own purchase orders.'\n      });\n    }\n\n    await PurchaseOrder.findByIdAndDelete(req.params.id);\n\n    res.json({\n      success: true,\n      message: 'Purchase order deleted successfully'\n    });\n\n  } catch (error) {\n    console.error('Delete purchase order error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n","path":null,"size_bytes":7767,"size_tokens":null},"backend/middleware/authSocket.js":{"content":"// backend/middleware/authSocket.js\nimport jwt from 'jsonwebtoken';\nimport User from '../models/User.js';\n\nconst authSocket = async (socket, next) => {\n  try {\n    const token = socket.handshake.auth.token;\n    if (!token) return next(new Error('Authentication error'));\n\n    const decoded = jwt.verify(token, process.env.JWT_SECRET);\n    const user = await User.findById(decoded.id).select('role fullName');\n    if (!user) return next(new Error('User not found'));\n\n    socket.user = user;\n    next();\n  } catch (err) {\n    next(new Error('Authentication error'));\n  }\n};\n\nexport default authSocket;","path":null,"size_bytes":600,"size_tokens":null},"backend/socket/chat.js":{"content":"// backend/socket/chat.js\nimport User from '../models/User.js';\nimport Message from '../models/Message.js';\nimport Group from '../models/Group.js';\nimport GroupMessage from '../models/GroupMessage.js';\nimport { processBotMessage } from '../controllers/botController.js';\nimport authSocket from '../middleware/authSocket.js';\n\nconst onlineUsers = new Map();\nconst userSockets = new Map();\nconst processedMessages = new Map();\nconst MESSAGE_DEDUP_TTL = 60000;\n\nconst cleanupProcessedMessages = () => {\n  const now = Date.now();\n  for (const [key, timestamp] of processedMessages.entries()) {\n    if (now - timestamp > MESSAGE_DEDUP_TTL) {\n      processedMessages.delete(key);\n    }\n  }\n};\n\nsetInterval(cleanupProcessedMessages, 30000);\n\nconst getOnlineUserIds = () => {\n  return Array.from(onlineUsers.keys());\n};\n\nconst broadcastPresence = (io, namespace) => {\n  const onlineUserIds = getOnlineUserIds();\n  namespace.emit('presence:sync', { onlineUsers: onlineUserIds });\n};\n\nconst setupChatSocket = (io) => {\n  const employeeNamespace = io.of('/employee');\n  employeeNamespace.use(authSocket);\n\n  employeeNamespace.on('connection', async (socket) => {\n    const userId = socket.user._id.toString();\n    const userName = socket.user.fullName;\n    \n    console.log(`Employee connected: ${userName} (${socket.id})`);\n    \n    const existingSocketId = userSockets.get(userId);\n    if (existingSocketId && existingSocketId !== socket.id) {\n      const existingSocket = employeeNamespace.sockets.get(existingSocketId);\n      if (existingSocket) {\n        console.log(`Disconnecting previous socket for user ${userId}`);\n        existingSocket.disconnect(true);\n      }\n    }\n    \n    userSockets.set(userId, socket.id);\n    onlineUsers.set(userId, {\n      socketId: socket.id,\n      name: userName,\n      lastSeen: new Date()\n    });\n\n    try {\n      const userGroups = await Group.find({\n        'members.user': userId,\n        isActive: true\n      }).select('_id');\n      \n      userGroups.forEach(group => {\n        socket.join(`group:${group._id}`);\n      });\n      console.log(`User ${userName} joined ${userGroups.length} group rooms`);\n    } catch (err) {\n      console.error('Error joining group rooms:', err);\n    }\n\n    socket.emit('presence:sync', { onlineUsers: getOnlineUserIds() });\n    \n    socket.broadcast.emit('presence:update', {\n      userId: userId,\n      status: 'online',\n      name: userName\n    });\n\n    socket.on('message', async (payload) => {\n      const { from, fromName, to, text, clientMessageId } = payload;\n      \n      if (!from || !text?.trim()) {\n        console.warn('Invalid message payload:', payload);\n        socket.emit('error', { type: 'INVALID_PAYLOAD', message: 'Message requires sender and text' });\n        return;\n      }\n\n      if (to !== 'bot' && from === to) {\n        console.warn('Self-chat attempted:', { from, to });\n        socket.emit('error', { type: 'SELF_CHAT_PREVENTED', message: 'Cannot send message to yourself' });\n        return;\n      }\n\n      const dedupKey = clientMessageId || `${from}-${to}-${text.trim()}-${Math.floor(Date.now() / 1000)}`;\n      if (processedMessages.has(dedupKey)) {\n        console.warn('Duplicate message detected:', dedupKey);\n        return;\n      }\n      processedMessages.set(dedupKey, Date.now());\n\n      try {\n        if (to === 'bot') {\n          const userMessageDoc = new Message({\n            from,\n            to: from,\n            text: text.trim()\n          });\n          await userMessageDoc.save();\n\n          socket.emit('message', {\n            _id: userMessageDoc._id,\n            clientMessageId,\n            from,\n            to: from,\n            text: userMessageDoc.text,\n            timestamp: userMessageDoc.timestamp,\n            self: true,\n            fromBot: false\n          });\n\n          const { response } = await processBotMessage(text.trim(), from);\n\n          const botMessageDoc = new Message({\n            from: null,\n            to: from,\n            text: response,\n            fromBot: true\n          });\n          await botMessageDoc.save();\n\n          socket.emit('message', {\n            _id: botMessageDoc._id,\n            from: null,\n            to: from,\n            text: response,\n            timestamp: botMessageDoc.timestamp,\n            self: false,\n            fromBot: true\n          });\n          return;\n        }\n\n        const messageDoc = new Message({\n          from,\n          to,\n          text: text.trim()\n        });\n        await messageDoc.save();\n\n        const recipientSocketId = userSockets.get(to);\n        if (recipientSocketId) {\n          io.of('/employee').to(recipientSocketId).emit('message', {\n            _id: messageDoc._id,\n            from,\n            fromName: fromName || socket.user.fullName,\n            to,\n            text: messageDoc.text,\n            timestamp: messageDoc.timestamp,\n            self: false,\n            fromBot: false\n          });\n        }\n\n        socket.emit('message', {\n          _id: messageDoc._id,\n          clientMessageId,\n          from,\n          fromName: fromName || socket.user.fullName,\n          to,\n          text: messageDoc.text,\n          timestamp: messageDoc.timestamp,\n          self: true,\n          fromBot: false\n        });\n\n      } catch (err) {\n        console.error('Socket message error:', err);\n        processedMessages.delete(dedupKey);\n        socket.emit('error', { type: 'MESSAGE_FAILED', message: 'Failed to send message' });\n      }\n    });\n\n    socket.on('group:message', async (payload) => {\n      const { groupId, text, clientMessageId } = payload;\n      \n      if (!groupId || !text || typeof text !== 'string' || !text.trim()) {\n        socket.emit('error', { type: 'INVALID_PAYLOAD', message: 'Group message requires groupId and text' });\n        return;\n      }\n\n      const sanitizedText = text.trim().substring(0, 5000);\n      const dedupKey = clientMessageId || `group-${groupId}-${userId}-${sanitizedText.substring(0, 50)}-${Math.floor(Date.now() / 1000)}`;\n      if (processedMessages.has(dedupKey)) {\n        return;\n      }\n      processedMessages.set(dedupKey, Date.now());\n\n      try {\n        const group = await Group.findById(groupId);\n        if (!group) {\n          socket.emit('error', { type: 'GROUP_NOT_FOUND', message: 'Group not found' });\n          processedMessages.delete(dedupKey);\n          return;\n        }\n\n        if (!group.isMember(userId)) {\n          socket.emit('error', { type: 'NOT_A_MEMBER', message: 'You are not a member of this group' });\n          processedMessages.delete(dedupKey);\n          return;\n        }\n\n        if (!group.canSendMessage(userId)) {\n          socket.emit('error', { type: 'PERMISSION_DENIED', message: 'You cannot send messages in this group' });\n          processedMessages.delete(dedupKey);\n          return;\n        }\n\n        const messageDoc = new GroupMessage({\n          group: groupId,\n          sender: userId,\n          text: sanitizedText\n        });\n        await messageDoc.save();\n        await messageDoc.populate('sender', 'name email profileImage');\n\n        group.lastMessage = {\n          text: sanitizedText.substring(0, 100),\n          sender: userId,\n          timestamp: new Date()\n        };\n        await group.save();\n\n        const messagePayload = {\n          _id: messageDoc._id,\n          clientMessageId,\n          groupId,\n          sender: {\n            _id: userId,\n            name: userName,\n            profileImage: socket.user.profileImage || null\n          },\n          text: messageDoc.text,\n          timestamp: messageDoc.createdAt,\n          type: 'text'\n        };\n\n        io.of('/employee').to(`group:${groupId}`).emit('group:message', messagePayload);\n\n      } catch (err) {\n        console.error('Group message error:', err);\n        processedMessages.delete(dedupKey);\n        socket.emit('error', { type: 'MESSAGE_FAILED', message: 'Failed to send group message' });\n      }\n    });\n\n    socket.on('group:join', async (data) => {\n      const { groupId } = data;\n      if (!groupId) return;\n      try {\n        const group = await Group.findById(groupId).select('members');\n        if (!group) {\n          socket.emit('error', { type: 'GROUP_NOT_FOUND', message: 'Group not found' });\n          return;\n        }\n        if (!group.isMember(userId)) {\n          socket.emit('error', { type: 'NOT_A_MEMBER', message: 'You are not a member of this group' });\n          return;\n        }\n        socket.join(`group:${groupId}`);\n        console.log(`User ${userName} joined group room: ${groupId}`);\n      } catch (err) {\n        console.error('Error joining group room:', err);\n        socket.emit('error', { type: 'JOIN_FAILED', message: 'Failed to join group' });\n      }\n    });\n\n    socket.on('group:leave', (data) => {\n      const { groupId } = data;\n      socket.leave(`group:${groupId}`);\n      console.log(`User ${userName} left group room: ${groupId}`);\n    });\n\n    socket.on('group:typing:start', (data) => {\n      const { groupId } = data;\n      if (groupId) {\n        socket.to(`group:${groupId}`).emit('group:typing:start', {\n          groupId,\n          userId,\n          userName\n        });\n      }\n    });\n\n    socket.on('group:typing:stop', (data) => {\n      const { groupId } = data;\n      if (groupId) {\n        socket.to(`group:${groupId}`).emit('group:typing:stop', {\n          groupId,\n          userId\n        });\n      }\n    });\n\n    socket.on('group:member:added', async (data) => {\n      const { groupId, memberIds } = data;\n      if (!groupId || !memberIds) return;\n\n      memberIds.forEach(memberId => {\n        const memberSocketId = userSockets.get(memberId);\n        if (memberSocketId) {\n          const memberSocket = employeeNamespace.sockets.get(memberSocketId);\n          if (memberSocket) {\n            memberSocket.join(`group:${groupId}`);\n            memberSocket.emit('group:added', { groupId });\n          }\n        }\n      });\n    });\n\n    socket.on('group:member:removed', async (data) => {\n      const { groupId, memberId } = data;\n      if (!groupId || !memberId) return;\n\n      const memberSocketId = userSockets.get(memberId);\n      if (memberSocketId) {\n        const memberSocket = employeeNamespace.sockets.get(memberSocketId);\n        if (memberSocket) {\n          memberSocket.leave(`group:${groupId}`);\n          memberSocket.emit('group:removed', { groupId });\n        }\n      }\n    });\n\n    socket.on('typing:start', (data) => {\n      const { to } = data;\n      if (to && to !== userId) {\n        const recipientSocketId = userSockets.get(to);\n        if (recipientSocketId) {\n          io.of('/employee').to(recipientSocketId).emit('typing:start', {\n            from: userId,\n            fromName: userName\n          });\n        }\n      }\n    });\n\n    socket.on('typing:stop', (data) => {\n      const { to } = data;\n      if (to && to !== userId) {\n        const recipientSocketId = userSockets.get(to);\n        if (recipientSocketId) {\n          io.of('/employee').to(recipientSocketId).emit('typing:stop', {\n            from: userId\n          });\n        }\n      }\n    });\n\n    socket.on('disconnect', () => {\n      console.log(`Employee disconnected: ${userName} (${socket.id})`);\n      \n      if (userSockets.get(userId) === socket.id) {\n        userSockets.delete(userId);\n        onlineUsers.delete(userId);\n        \n        socket.broadcast.emit('presence:update', {\n          userId: userId,\n          status: 'offline',\n          name: userName,\n          lastSeen: new Date()\n        });\n      }\n    });\n  });\n\n  const adminNamespace = io.of('/admin');\n  adminNamespace.use(authSocket);\n  adminNamespace.on('connection', (socket) => {\n    console.log(`Admin connected: ${socket.user.fullName} (${socket.id})`);\n    socket.on('disconnect', () => {\n      console.log(`Admin disconnected: ${socket.user.fullName} (${socket.id})`);\n    });\n  });\n};\n\nexport { getOnlineUserIds };\nexport default setupChatSocket;\n","path":null,"size_bytes":11933,"size_tokens":null},"frontend/src/components/Admin/Header/NotificationBell.jsx":{"content":"import React, { useState, useRef, useEffect } from \"react\";\nimport { Bell, RefreshCw, CheckCheck, Clock, User, Settings, AlertTriangle, X } from \"lucide-react\";\n\nconst NotificationBell = ({ unreadCount, notifications = [], onNotificationRead, onRefresh }) => {\n  const [dropdownOpen, setDropdownOpen] = useState(false);\n  const [refreshing, setRefreshing] = useState(false);\n  const [isMobile, setIsMobile] = useState(false);\n  const dropdownRef = useRef(null);\n\n  // Check if device is mobile\n  useEffect(() => {\n    const checkMobile = () => {\n      setIsMobile(window.innerWidth < 768);\n    };\n    \n    checkMobile();\n    window.addEventListener('resize', checkMobile);\n    \n    return () => window.removeEventListener('resize', checkMobile);\n  }, []);\n\n  // Close dropdown when clicking outside\n  useEffect(() => {\n    const handleClickOutside = (event) => {\n      if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {\n        setDropdownOpen(false);\n      }\n    };\n\n    const handleEscape = (event) => {\n      if (event.key === 'Escape') {\n        setDropdownOpen(false);\n      }\n    };\n\n    if (dropdownOpen) {\n      document.addEventListener('mousedown', handleClickOutside);\n      document.addEventListener('keydown', handleEscape);\n      \n      // Prevent body scroll on mobile when dropdown is open\n      if (isMobile) {\n        document.body.style.overflow = 'hidden';\n      }\n    }\n\n    return () => {\n      document.removeEventListener('mousedown', handleClickOutside);\n      document.removeEventListener('keydown', handleEscape);\n      document.body.style.overflow = 'unset';\n    };\n  }, [dropdownOpen, isMobile]);\n\n  // Handle refresh notifications\n  const handleRefresh = async () => {\n    setRefreshing(true);\n    try {\n      await onRefresh();\n    } finally {\n      setTimeout(() => setRefreshing(false), 1000);\n    }\n  };\n\n  // Mark all as read\n  const handleMarkAllRead = () => {\n    notifications.filter(n => n.unread).forEach(n => onNotificationRead(n.id));\n  };\n\n  // Get notification icon based on type\n  const getNotificationIcon = (type, category) => {\n    const iconProps = { className: \"w-4 h-4 flex-shrink-0\" };\n    \n    switch (category) {\n      case 'employee':\n        return <User {...iconProps} className=\"w-4 h-4 text-blue-400 flex-shrink-0\" />;\n      case 'leave':\n      case 'leaves':\n        return <Clock {...iconProps} className=\"w-4 h-4 text-yellow-400 flex-shrink-0\" />;\n      case 'task':\n        return <Settings {...iconProps} className=\"w-4 h-4 text-green-400 flex-shrink-0\" />;\n      case 'tasks':\n        return type === 'error' \n          ? <AlertTriangle {...iconProps} className=\"w-4 h-4 text-red-400 flex-shrink-0\" />\n          : <Settings {...iconProps} className=\"w-4 h-4 text-yellow-400 flex-shrink-0\" />;\n      default:\n        return <Bell {...iconProps} className=\"w-4 h-4 text-gray-400 flex-shrink-0\" />;\n    }\n  };\n\n  // Get notification color based on type\n  const getNotificationColor = (type, unread) => {\n    if (!unread) return 'text-secondary-400';\n    \n    switch (type) {\n      case 'success':\n        return 'text-green-400';\n      case 'error':\n        return 'text-red-400';\n      case 'warning':\n        return 'text-yellow-400';\n      case 'info':\n        return 'text-blue-400';\n      default:\n        return 'text-white';\n    }\n  };\n\n  // Close dropdown\n  const closeDropdown = () => {\n    setDropdownOpen(false);\n  };\n\n  return (\n    <>\n      <div className=\"relative\" ref={dropdownRef}>\n        <button \n          onClick={() => setDropdownOpen(!dropdownOpen)}\n          className=\"relative p-1.5 sm:p-2 text-secondary-400 hover:text-white transition-colors rounded-md\"\n          aria-label=\"Notifications\"\n        >\n          <Bell className=\"w-5 h-5 sm:w-6 sm:h-6\" />\n          {unreadCount > 0 && (\n            <span className=\"absolute -top-1 -right-1 w-4 h-4 sm:w-5 sm:h-5 bg-neon-pink rounded-full text-xs text-white flex items-center justify-center animate-pulse font-medium\">\n              {unreadCount > 99 ? '99+' : unreadCount}\n            </span>\n          )}\n        </button>\n\n        {dropdownOpen && !isMobile && (\n          // Desktop dropdown\n          <div className=\"absolute right-0 mt-2 w-80 xl:w-96 glass-morphism rounded-lg border border-secondary-600 shadow-xl z-50 max-h-96 overflow-hidden\">\n            {/* Header */}\n            <div className=\"flex items-center justify-between p-4 border-b border-secondary-600\">\n              <div className=\"flex items-center space-x-2\">\n                <Bell className=\"w-5 h-5 text-white flex-shrink-0\" />\n                <h3 className=\"text-lg font-semibold text-white\">Notifications</h3>\n              </div>\n              <div className=\"flex items-center space-x-2\">\n                {unreadCount > 0 && (\n                  <button\n                    onClick={handleMarkAllRead}\n                    className=\"text-xs text-secondary-400 hover:text-white transition-colors flex items-center space-x-1 px-2 py-1 rounded hover:bg-secondary-700/30\"\n                    title=\"Mark all as read\"\n                  >\n                    <CheckCheck className=\"w-3 h-3\" />\n                    <span className=\"hidden sm:inline\">Mark all read</span>\n                  </button>\n                )}\n                <button\n                  onClick={handleRefresh}\n                  disabled={refreshing}\n                  className=\"text-secondary-400 hover:text-white transition-colors disabled:opacity-50 p-1 rounded hover:bg-secondary-700/30\"\n                  title=\"Refresh notifications\"\n                >\n                  <RefreshCw className={`w-4 h-4 ${refreshing ? 'animate-spin' : ''}`} />\n                </button>\n              </div>\n            </div>\n\n            {/* Notifications List */}\n            <div className=\"max-h-64 overflow-y-auto\">\n              {notifications.length === 0 ? (\n                <div className=\"p-8 text-center\">\n                  <Bell className=\"w-12 h-12 text-secondary-600 mx-auto mb-3\" />\n                  <p className=\"text-secondary-400 text-sm\">No notifications yet</p>\n                  <p className=\"text-secondary-500 text-xs mt-1\">\n                    You'll see updates about activities here\n                  </p>\n                </div>\n              ) : (\n                notifications.map((notification) => (\n                  <div\n                    key={notification.id}\n                    onClick={() => {\n                      if (notification.unread) {\n                        onNotificationRead(notification.id);\n                      }\n                    }}\n                    className={`p-4 border-b border-secondary-700 last:border-b-0 cursor-pointer transition-colors hover:bg-secondary-700/30 ${\n                      notification.unread ? 'bg-secondary-800/30' : ''\n                    }`}\n                  >\n                    <div className=\"flex items-start space-x-3\">\n                      <div className=\"mt-1 flex-shrink-0\">\n                        {getNotificationIcon(notification.type, notification.category)}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <p className={`text-sm font-medium ${getNotificationColor(notification.type, notification.unread)} break-words`}>\n                          {notification.message}\n                        </p>\n                        {notification.user && (\n                          <p className=\"text-xs text-secondary-500 mt-1 truncate\">\n                            {notification.user}\n                          </p>\n                        )}\n                        <div className=\"flex items-center justify-between mt-2\">\n                          <span className=\"text-xs text-secondary-500\">\n                            {notification.time}\n                          </span>\n                          {notification.unread && (\n                            <div className=\"w-2 h-2 bg-neon-pink rounded-full flex-shrink-0\"></div>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                ))\n              )}\n            </div>\n\n            {/* Footer */}\n            {notifications.length > 0 && (\n              <div className=\"p-3 border-t border-secondary-600 bg-secondary-800/20\">\n                <button className=\"w-full text-xs text-secondary-400 hover:text-white transition-colors text-center py-1\">\n                  View All Notifications\n                </button>\n              </div>\n            )}\n          </div>\n        )}\n      </div>\n\n      {/* Mobile Modal */}\n      {dropdownOpen && isMobile && (\n        <div className=\"fixed inset-0 z-50 overflow-hidden\">\n          {/* Backdrop */}\n          <div \n            className=\"fixed inset-0 bg-black/50 backdrop-blur-sm\"\n            onClick={closeDropdown}\n          />\n          \n          {/* Modal */}\n          <div className=\"fixed bottom-0 left-0 right-0 max-h-[80vh] bg-gray-900 rounded-t-2xl border-t border-secondary-600 shadow-2xl\">\n            {/* Header */}\n            <div className=\"flex items-center justify-between p-4 border-b border-secondary-600\">\n              <div className=\"flex items-center space-x-2\">\n                <Bell className=\"w-5 h-5 text-white\" />\n                <h3 className=\"text-lg font-semibold text-white\">Notifications</h3>\n                {unreadCount > 0 && (\n                  <span className=\"bg-neon-pink text-white text-xs px-2 py-1 rounded-full\">\n                    {unreadCount}\n                  </span>\n                )}\n              </div>\n              <div className=\"flex items-center space-x-2\">\n                {unreadCount > 0 && (\n                  <button\n                    onClick={handleMarkAllRead}\n                    className=\"text-xs text-secondary-400 hover:text-white transition-colors flex items-center space-x-1 px-3 py-2 rounded-lg hover:bg-secondary-700/30\"\n                    title=\"Mark all as read\"\n                  >\n                    <CheckCheck className=\"w-4 h-4\" />\n                    <span>Mark all read</span>\n                  </button>\n                )}\n                <button\n                  onClick={closeDropdown}\n                  className=\"text-secondary-400 hover:text-white transition-colors p-2 rounded-lg hover:bg-secondary-700/30\"\n                  aria-label=\"Close notifications\"\n                >\n                  <X className=\"w-5 h-5\" />\n                </button>\n              </div>\n            </div>\n\n            {/* Notifications List */}\n            <div className=\"max-h-[60vh] overflow-y-auto\">\n              {notifications.length === 0 ? (\n                <div className=\"p-8 text-center\">\n                  <Bell className=\"w-16 h-16 text-secondary-600 mx-auto mb-4\" />\n                  <p className=\"text-secondary-400 text-base mb-2\">No notifications yet</p>\n                  <p className=\"text-secondary-500 text-sm\">\n                    You'll see updates about activities here\n                  </p>\n                </div>\n              ) : (\n                <>\n                  {notifications.map((notification) => (\n                    <div\n                      key={notification.id}\n                      onClick={() => {\n                        if (notification.unread) {\n                          onNotificationRead(notification.id);\n                        }\n                      }}\n                      className={`p-4 border-b border-secondary-700 last:border-b-0 active:bg-secondary-700/50 transition-colors ${\n                        notification.unread ? 'bg-secondary-800/30' : ''\n                      }`}\n                    >\n                      <div className=\"flex items-start space-x-3\">\n                        <div className=\"mt-1 flex-shrink-0\">\n                          {getNotificationIcon(notification.type, notification.category)}\n                        </div>\n                        <div className=\"flex-1 min-w-0\">\n                          <p className={`text-sm font-medium ${getNotificationColor(notification.type, notification.unread)} leading-relaxed`}>\n                            {notification.message}\n                          </p>\n                          {notification.user && (\n                            <p className=\"text-sm text-secondary-500 mt-1\">\n                              {notification.user}\n                            </p>\n                          )}\n                          <div className=\"flex items-center justify-between mt-3\">\n                            <span className=\"text-sm text-secondary-500\">\n                              {notification.time}\n                            </span>\n                            {notification.unread && (\n                              <div className=\"w-3 h-3 bg-neon-pink rounded-full flex-shrink-0\"></div>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                  \n                  {/* Refresh Button for Mobile */}\n                  <div className=\"p-4 border-t border-secondary-600\">\n                    <button\n                      onClick={handleRefresh}\n                      disabled={refreshing}\n                      className=\"w-full py-3 text-secondary-400 hover:text-white transition-colors disabled:opacity-50 flex items-center justify-center space-x-2 rounded-lg hover:bg-secondary-700/30\"\n                    >\n                      <RefreshCw className={`w-4 h-4 ${refreshing ? 'animate-spin' : ''}`} />\n                      <span>{refreshing ? 'Refreshing...' : 'Refresh Notifications'}</span>\n                    </button>\n                  </div>\n                </>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n    </>\n  );\n};\n\nexport default NotificationBell;","path":null,"size_bytes":13910,"size_tokens":null},"backend/models/Leave.js":{"content":"import mongoose from 'mongoose';\n\nconst leaveSchema = new mongoose.Schema({\n  employee: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'Employee',\n    required: true\n  },\n  user: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true\n  },\nleaveType: {\n  type: String,\n  enum: ['casual', 'sick', 'earned', 'maternity', 'paternity', 'emergency', 'personal'],\n  required: [true, 'Leave type is required']\n},\n\n  startDate: {\n    type: Date,\n    required: [true, 'Start date is required']\n  },\n  endDate: {\n    type: Date,\n    required: [true, 'End date is required']\n  },\n  totalDays: {\n    type: Number,\n    required: true\n  },\n  reason: {\n    type: String,\n    required: [true, 'Reason is required'],\n    trim: true,\n    maxlength: [500, 'Reason cannot exceed 500 characters']\n  },\n  status: {\n    type: String,\n    enum: ['Pending', 'Approved', 'Rejected', 'Cancelled'],\n    default: 'Pending'\n  },\n  appliedDate: {\n    type: Date,\n    default: Date.now\n  },\n  actionDate: {\n    type: Date\n  },\n  actionBy: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User'\n  },\n  approverComments: {\n    type: String,\n    trim: true,\n    maxlength: [300, 'Comments cannot exceed 300 characters']\n  },\n  attachment: {\n    fileName: String,\n    filePath: String,\n    fileSize: Number,\n    mimeType: String\n  },\n  isHalfDay: {\n    type: Boolean,\n    default: false\n  },\n  halfDaySession: {\n    type: String,\n    enum: ['Morning', 'Evening'],\n    required: function() {\n      return this.isHalfDay;\n    }\n  },\n  contactDuringLeave: {\n    phone: String,\n    address: String\n  },\n  workHandover: {\n    handoverTo: {\n      type: mongoose.Schema.Types.ObjectId,\n      ref: 'Employee'\n    },\n    instructions: String\n  },\n  priority: {\n    type: String,\n    enum: ['Low', 'Medium', 'High', 'Emergency'],\n    default: 'Medium'\n  }\n}, {\n  timestamps: true,\n  toJSON: { virtuals: true },\n  toObject: { virtuals: true }\n});\n\n// Indexes for better query performance\nleaveSchema.index({ employee: 1 });\nleaveSchema.index({ user: 1 });\nleaveSchema.index({ status: 1 });\nleaveSchema.index({ leaveType: 1 });\nleaveSchema.index({ startDate: 1, endDate: 1 });\nleaveSchema.index({ appliedDate: 1 });\n\n// Virtual for leave duration in readable format\nleaveSchema.virtual('duration').get(function() {\n  if (this.isHalfDay) {\n    return `0.5 day (${this.halfDaySession})`;\n  }\n  return `${this.totalDays} ${this.totalDays === 1 ? 'day' : 'days'}`;\n});\n\n// Virtual for status color coding\nleaveSchema.virtual('statusColor').get(function() {\n  const colors = {\n    'Pending': 'yellow',\n    'Approved': 'green',\n    'Rejected': 'red',\n    'Cancelled': 'gray'\n  };\n  return colors[this.status] || 'gray';\n});\n\n// Pre-save middleware to calculate total days\nleaveSchema.pre('save', function(next) {\n  if (this.startDate && this.endDate) {\n    const start = new Date(this.startDate);\n    const end = new Date(this.endDate);\n    \n    if (this.isHalfDay) {\n      this.totalDays = 0.5;\n    } else {\n      const diffTime = Math.abs(end - start);\n      this.totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;\n    }\n  }\n  next();\n});\n\n// Pre-save middleware to set action date when status changes\nleaveSchema.pre('save', function(next) {\n  if (this.isModified('status') && this.status !== 'Pending') {\n    this.actionDate = new Date();\n  }\n  next();\n});\n\n// Static method to get leave statistics\nleaveSchema.statics.getLeaveStats = async function(employeeId, year = new Date().getFullYear()) {\n  const startDate = new Date(year, 0, 1);\n  const endDate = new Date(year, 11, 31);\n  \n  const stats = await this.aggregate([\n    {\n      $match: {\n        employee: new mongoose.Types.ObjectId(employeeId),\n        status: 'Approved',\n        startDate: { $gte: startDate, $lte: endDate }\n      }\n    },\n    {\n      $group: {\n        _id: '$leaveType',\n        totalDays: { $sum: '$totalDays' },\n        count: { $sum: 1 }\n      }\n    }\n  ]);\n  \n  return stats;\n};\n\n// Static method to check leave conflicts\nleaveSchema.statics.checkConflicts = async function(employeeId, startDate, endDate, excludeId = null) {\n  const query = {\n    employee: employeeId,\n    status: { $in: ['Pending', 'Approved'] },\n    $or: [\n      {\n        startDate: { $lte: endDate },\n        endDate: { $gte: startDate }\n      }\n    ]\n  };\n  \n  if (excludeId) {\n    query._id = { $ne: excludeId };\n  }\n  \n  const conflicts = await this.find(query);\n  return conflicts;\n};\n\n// Instance method to approve leave\nleaveSchema.methods.approve = function(approver, comments = '') {\n  this.status = 'Approved';\n  this.actionBy = approver._id;\n  this.actionDate = new Date();\n  this.approverComments = comments;\n  return this.save();\n};\n\n// Instance method to reject leave\nleaveSchema.methods.reject = function(approver, comments = '') {\n  this.status = 'Rejected';\n  this.actionBy = approver._id;\n  this.actionDate = new Date();\n  this.approverComments = comments;\n  return this.save();\n};\n\n// Instance method to cancel leave\nleaveSchema.methods.cancel = function() {\n  if (this.status === 'Pending') {\n    this.status = 'Cancelled';\n    this.actionDate = new Date();\n    return this.save();\n  }\n  throw new Error('Only pending leaves can be cancelled');\n};\n\nexport default mongoose.model('Leave', leaveSchema);","path":null,"size_bytes":5270,"size_tokens":null},"frontend/src/hooks/useDashboardData.js":{"content":"// hooks/useDashboardData.js\nimport { useState, useEffect, useCallback } from 'react';\nimport { dashboardAPI } from '../utils/api';\nimport { Users, Building2, Calendar, UserCheck } from 'lucide-react';\nimport toast from 'react-hot-toast';\n\nexport const useDashboardData = () => {\n  const [state, setState] = useState({\n    stats: [],\n    recentActivities: [],\n    upcomingEvents: [],\n    loading: true,\n    error: null\n  });\n\n  const createDefaultStats = useCallback((data = {}) => [\n    {\n      title: \"Total Employees\",\n      value: data.totalEmployees || 0,\n      icon: Users,\n      color: \"from-pink-500 to-purple-500\",\n      changeType: \"positive\"\n    },\n    {\n      title: \"Active Employees\", \n      value: data.activeEmployees || 0,\n      icon: UserCheck,\n      color: \"from-green-500 to-emerald-500\",\n      changeType: \"negative\"\n    },\n    {\n      title: \"Departments\",\n      value: data.departments || 0,\n      icon: Building2,\n      color: \"from-blue-500 to-indigo-500\",\n      changeType: \"positive\"\n    },\n    {\n      title: \"Leaves Today\",\n      value: data.leavesToday || 0,\n      icon: Calendar,\n      color: \"from-yellow-500 to-orange-500\",\n      changeType: \"neutral\"\n    }\n  ], []);\n\n  const fetchDashboardData = useCallback(async () => {\n    try {\n      setState(prev => ({ ...prev, loading: true, error: null }));\n      \n      const [statsResponse, activitiesResponse, eventsResponse] = await Promise.all([\n        dashboardAPI.getAdminStats(),\n        dashboardAPI.getRecentActivities(),\n        dashboardAPI.getUpcomingEvents()\n      ]);\n\n      const newState = {\n        loading: false,\n        error: null\n      };\n\n      // Process stats data\n      if (statsResponse.data.success) {\n        const data = statsResponse.data;\n        newState.stats = createDefaultStats(data);\n      } else {\n        newState.stats = createDefaultStats();\n      }\n\n      // Process activities data\n      if (activitiesResponse.data.success) {\n        newState.recentActivities = activitiesResponse.data.activities || [];\n      } else {\n        newState.recentActivities = [];\n      }\n\n      // Process events data\n      if (eventsResponse.data.success) {\n        newState.upcomingEvents = eventsResponse.data.events || [];\n      } else {\n        newState.upcomingEvents = [];\n      }\n\n      setState(prev => ({ ...prev, ...newState }));\n\n    } catch (error) {\n      console.error('Error fetching dashboard data:', error);\n      \n      const errorMessage = error.response?.data?.message || 'Failed to load dashboard data';\n      toast.error(errorMessage);\n      \n      setState(prev => ({\n        ...prev,\n        loading: false,\n        error: errorMessage,\n        stats: createDefaultStats(),\n        recentActivities: [],\n        upcomingEvents: []\n      }));\n    }\n  }, [createDefaultStats]);\n\n  const refreshData = useCallback(() => {\n    fetchDashboardData();\n  }, [fetchDashboardData]);\n\n  useEffect(() => {\n    fetchDashboardData();\n  }, [fetchDashboardData]);\n\n  return {\n    ...state,\n    refreshData,\n    isLoading: state.loading\n  };\n};\n\n","path":null,"size_bytes":3056,"size_tokens":null},"backend/routes/attendanceRoutes.js":{"content":"// routes/attendanceRoutes.js\nimport express from 'express';\nimport { protect, adminOnly, employeeOnly } from '../middleware/authMiddleware.js';\nimport {\n  checkIn,\n  checkOut,\n  checkInWithFace,\n  getTodayAttendance,\n  getAttendanceHistory,\n  getAllAttendance,\n  getAttendanceSummary,\n  updateAttendance,\n  deleteAttendance,\n  verifyFace,\n\n} from '../controllers/attendanceController.js';\n\nconst router = express.Router();\n\n// All routes require authentication\nrouter.use(protect);\n\n// Employee routes\nrouter.post('/verify-face', employeeOnly, verifyFace);\nrouter.post('/checkin', employeeOnly, checkIn);                    // Mark attendance (check-in)\nrouter.post('/checkin-with-face', employeeOnly, checkInWithFace);  // Combined face and location validation\nrouter.put('/checkout', employeeOnly, checkOut);                  // Mark checkout\nrouter.get('/today', employeeOnly, getTodayAttendance);            // Get today's attendance status\nrouter.get('/history', employeeOnly, getAttendanceHistory);        // Get employee attendance history\n\n// Admin routes\nrouter.get('/all', adminOnly, getAllAttendance);     // Get all attendance records\nrouter.get('/summary', adminOnly, getAttendanceSummary); // Get attendance summary for dashboard\nrouter.put('/:id', adminOnly, updateAttendance);     // Update attendance record\nrouter.delete('/:id', adminOnly, deleteAttendance); \n// router.post('/verify-face', auth, verifyFace); // Delete attendance record\n\nexport default router;","path":null,"size_bytes":1480,"size_tokens":null},"frontend/src/utils/attendanceAPI.js":{"content":"// utils/attendanceAPI.js\nimport API from './api';\n\n// Office location constant - Make sure this matches your controller\nexport const OFFICE_LOCATION = {\n  latitude: 22.29867,\n  longitude: 73.13130,\n  radius: 100 // meters - Strict office location enforcement\n};\n\n// Geolocation utility functions\nexport const geolocationUtils = {\n  getCurrentPosition: () => {\n    return new Promise((resolve, reject) => {\n      if (!navigator.geolocation) {\n        reject(new Error('Geolocation is not supported by this browser'));\n        return;\n      }\n\n      const options = {\n        enableHighAccuracy: true,\n        timeout: 10000,\n        maximumAge: 60000 // 1 minute cache\n      };\n\n      navigator.geolocation.getCurrentPosition(\n        (position) => {\n          resolve({\n            latitude: position.coords.latitude,\n            longitude: position.coords.longitude,\n            accuracy: position.coords.accuracy,\n            timestamp: position.timestamp\n          });\n        },\n        (error) => {\n          let errorMessage = 'Unable to retrieve your location';\n          \n          switch (error.code) {\n            case error.PERMISSION_DENIED:\n              errorMessage = 'Location access is required for attendance. Please enable location services in your browser settings and refresh the page.';\n              break;\n            case error.POSITION_UNAVAILABLE:\n              errorMessage = 'Location information is unavailable';\n              break;\n            case error.TIMEOUT:\n              errorMessage = 'Location request timed out';\n              break;\n            default:\n              errorMessage = 'An unknown error occurred while retrieving location';\n              break;\n          }\n          \n          reject(new Error(errorMessage));\n        },\n        options\n      );\n    });\n  },\n\n  // Get address from coordinates (reverse geocoding)\n  getAddressFromCoords: async (latitude, longitude) => {\n    try {\n      // Using a free geocoding service - you can replace with your preferred service\n      const response = await fetch(\n        `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`\n      );\n      \n      if (!response.ok) {\n        throw new Error('Geocoding service unavailable');\n      }\n      \n      const data = await response.json();\n      return data.display_name || data.locality || `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;\n    } catch (error) {\n      console.warn('Geocoding failed:', error);\n      return `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;\n    }\n  },\n\n  // Get device information\n  getDeviceInfo: () => {\n    const userAgent = navigator.userAgent;\n    let browser = 'Unknown';\n    let platform = navigator.platform || 'Unknown';\n\n    // Simple browser detection\n    if (userAgent.includes('Chrome')) browser = 'Chrome';\n    else if (userAgent.includes('Firefox')) browser = 'Firefox';\n    else if (userAgent.includes('Safari')) browser = 'Safari';\n    else if (userAgent.includes('Edge')) browser = 'Edge';\n    else if (userAgent.includes('Opera')) browser = 'Opera';\n\n    return {\n      userAgent,\n      platform,\n      browser,\n      language: navigator.language,\n      cookieEnabled: navigator.cookieEnabled,\n      onLine: navigator.onLine\n    };\n  },\n\n  // Calculate distance between two coordinates (in meters) - Fixed formula\n  calculateDistance: (lat1, lon1, lat2, lon2) => {\n    const R = 6371e3; // Earth's radius in meters\n    const toRad = (deg) => (deg * Math.PI) / 180;\n\n    const φ1 = toRad(lat1);\n    const φ2 = toRad(lat2);\n    const Δφ = toRad(lat2 - lat1);\n    const Δλ = toRad(lon2 - lon1);\n\n    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +\n              Math.cos(φ1) * Math.cos(φ2) *\n              Math.sin(Δλ/2) * Math.sin(Δλ/2);\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));\n\n    return R * c; // Distance in meters\n  },\n\n  // Check if location is within office radius\n  isWithinOfficeRadius: (userLat, userLon) => {\n    const distance = geolocationUtils.calculateDistance(\n      userLat, \n      userLon, \n      OFFICE_LOCATION.latitude, \n      OFFICE_LOCATION.longitude\n    );\n    return {\n      isWithin: distance <= OFFICE_LOCATION.radius,\n      distance: Math.round(distance),\n      maxDistance: OFFICE_LOCATION.radius\n    };\n  }\n};\n\n// Attendance API endpoints\nexport const attendanceAPI = {\n  // Employee attendance functions\n  checkInWithFace: async (faceData, locationData = {}) => {\n    try {\n      const position = await geolocationUtils.getCurrentPosition();\n      const address = await geolocationUtils.getAddressFromCoords(\n        position.latitude,\n        position.longitude\n      );\n      const deviceInfo = geolocationUtils.getDeviceInfo();\n\n      // Check distance on client side for better UX\n      const locationCheck = geolocationUtils.isWithinOfficeRadius(\n        position.latitude,\n        position.longitude\n      );\n\n      if (!locationCheck.isWithin) {\n        throw new Error(`You are not within office premises. Distance: ${locationCheck.distance}m (Max: ${locationCheck.maxDistance}m)`);\n      }\n\n      return API.post('/attendance/checkin-with-face', {\n        faceDescriptor: faceData.descriptor,\n        location: {\n          latitude: position.latitude,\n          longitude: position.longitude,\n          accuracy: position.accuracy,\n          address: typeof address === 'object' ? address.address : address\n        },\n        deviceInfo\n      });\n    } catch (error) {\n      console.error('Check-in with face error:', error);\n      throw error;\n    }\n  },\n\n  checkIn: async (attendanceData = {}) => {\n    try {\n      const position = await geolocationUtils.getCurrentPosition();\n      const address = await geolocationUtils.getAddressFromCoords(\n        position.latitude,\n        position.longitude\n      );\n      const deviceInfo = geolocationUtils.getDeviceInfo();\n\n      // Check distance on client side for better UX\n      const locationCheck = geolocationUtils.isWithinOfficeRadius(\n        position.latitude,\n        position.longitude\n      );\n\n      if (!locationCheck.isWithin) {\n        throw new Error(`You are not within office premises. Distance: ${locationCheck.distance}m (Max: ${locationCheck.maxDistance}m)`);\n      }\n\n      return API.post('/attendance/checkin', {\n        ...attendanceData,\n        location: {\n          latitude: position.latitude,\n          longitude: position.longitude,\n          accuracy: position.accuracy,\n          address: typeof address === 'object' ? address.address : address\n        },\n        deviceInfo\n      });\n    } catch (error) {\n      console.error('Check-in error:', error);\n      throw error;\n    }\n  },\n\n  checkOut: async (attendanceData = {}) => {\n    try {\n      const position = await geolocationUtils.getCurrentPosition();\n      const address = await geolocationUtils.getAddressFromCoords(\n        position.latitude,\n        position.longitude\n      );\n\n      // Check distance on client side for better UX\n      const locationCheck = geolocationUtils.isWithinOfficeRadius(\n        position.latitude,\n        position.longitude\n      );\n\n      if (!locationCheck.isWithin) {\n        throw new Error(`You are not within office premises. Distance: ${locationCheck.distance}m (Max: ${locationCheck.maxDistance}m)`);\n      }\n\n      return API.put('/attendance/checkout', {\n        ...attendanceData,\n        location: {\n          latitude: position.latitude,\n          longitude: position.longitude,\n          accuracy: position.accuracy,\n          address: typeof address === 'object' ? address.address : address\n        }\n      });\n    } catch (error) {\n      console.error('Check-out error:', error);\n      throw error;\n    }\n  },\nverifyFace: (faceData) => API.post('/attendance/verify-face', faceData),\n  getTodayAttendance: () => API.get('/attendance/today'),\n  getAttendanceHistory: (params = {}) => API.get('/attendance/history', { params }),\n  getAllAttendance: (params = {}) => API.get('/attendance/all', { params }),\n  getAttendanceSummary: (params = {}) => API.get('/attendance/summary', { params }),\n  updateAttendance: (id, attendanceData) => API.put(`/attendance/${id}`, attendanceData),\n  deleteAttendance: (id) => API.delete(`/attendance/${id}`)\n};\n\nexport default attendanceAPI;","path":null,"size_bytes":8290,"size_tokens":null},"backend/controllers/leadController.js":{"content":"import mongoose from 'mongoose';\nimport Lead from '../models/Lead.js';\nimport Employee from '../models/Employee.js';\nimport { validationResult } from 'express-validator';\nimport { sendEmail } from '../utils/email.js';\n\n// Create new lead - ENHANCED ERROR HANDLING\nexport const createLead = async (req, res) => {\n  try {\n    // Check for validation errors\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      console.log('Validation errors:', errors.array());\n      return res.status(400).json({\n        success: false,\n        message: 'Validation failed',\n        errors: errors.array(),\n        details: errors.array().map(error => ({\n          field: error.param,\n          message: error.msg,\n          value: error.value\n        }))\n      });\n    }\n\n    let leadData = { ...req.body };\n    console.log('Creating lead with data:', leadData);\n\n    // If employee is creating lead, assign to themselves\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee) {\n        console.log('Employee not found for user:', req.user.id);\n        return res.status(404).json({\n          success: false,\n          message: 'Employee record not found'\n        });\n      }\n      leadData.assignedTo = employee._id;\n      console.log('Assigned lead to employee:', employee._id);\n    } else {\n      // For admin/manager, they need to specify assignedTo or we'll assign to them if they have an employee record\n      if (!leadData.assignedTo) {\n        const employee = await Employee.findOne({ user: req.user.id });\n        if (employee) {\n          leadData.assignedTo = employee._id;\n        } else {\n          // If no assignedTo specified and user has no employee record, return error\n          return res.status(400).json({\n            success: false,\n            message: 'Please specify an employee to assign this lead to'\n          });\n        }\n      }\n    }\n\n    // Set assignedBy\n    leadData.assignedBy = req.user.id;\n\n    // Clean the data - remove empty strings and convert types\n    Object.keys(leadData).forEach(key => {\n      if (leadData[key] === '' || leadData[key] === null) {\n        delete leadData[key];\n      }\n    });\n\n    // Convert numeric fields\n    if (leadData.estimatedValue !== undefined) {\n      leadData.estimatedValue = Number(leadData.estimatedValue);\n    }\n\n    // Ensure dates are properly formatted\n    if (leadData.expectedCloseDate) {\n      leadData.expectedCloseDate = new Date(leadData.expectedCloseDate);\n    }\n    if (leadData.nextFollowUpDate) {\n      leadData.nextFollowUpDate = new Date(leadData.nextFollowUpDate);\n    }\n\n    console.log('Final lead data before save:', leadData);\n\n    // Check for duplicate email\n    const existingLead = await Lead.findOne({ email: leadData.email });\n    if (existingLead) {\n      return res.status(400).json({\n        success: false,\n        message: 'A lead with this email already exists',\n        existingLeadId: existingLead._id\n      });\n    }\n\n    // Create the lead\n    const lead = await Lead.create(leadData);\n    console.log('Lead created successfully:', lead._id);\n\n    // Populate the created lead\n    await lead.populate('assignedTo', 'personalInfo.firstName personalInfo.lastName employeeId');\n    await lead.populate('assignedBy', 'name email');\n\n    // Add initial note if provided\n    if (req.body.notes && req.body.notes.trim()) {\n      lead.notes.push({\n        content: req.body.notes.trim(),\n        addedBy: req.user.id,\n        addedAt: new Date(),\n        type: 'General'\n      });\n      await lead.save();\n    }\n\n    res.status(201).json({\n      success: true,\n      message: 'Lead created successfully',\n      data: lead\n    });\n\n  } catch (error) {\n    console.error('Create lead error:', error);\n    \n    // Handle specific MongoDB errors\n    if (error.code === 11000) {\n      const field = Object.keys(error.keyValue)[0];\n      const value = error.keyValue[field];\n      return res.status(400).json({\n        success: false,\n        message: `A lead with this ${field} (${value}) already exists`,\n        field: field,\n        value: value\n      });\n    }\n\n    // Handle validation errors\n    if (error.name === 'ValidationError') {\n      const validationErrors = Object.values(error.errors).map(err => ({\n        field: err.path,\n        message: err.message,\n        value: err.value\n      }));\n      \n      return res.status(400).json({\n        success: false,\n        message: 'Lead validation failed',\n        errors: validationErrors\n      });\n    }\n\n    res.status(500).json({\n      success: false,\n      message: 'Internal server error while creating lead',\n      error: process.env.NODE_ENV === 'development' ? error.message : 'Please try again later'\n    });\n  }\n};\n\n// Update won lead details - ENHANCED VERSION\nexport const updateWonLead = async (req, res) => {\n  try {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation failed',\n        errors: errors.array()\n      });\n    }\n\n    const leadId = req.params.id;\n    const wonData = { ...req.body };\n\n    console.log('Updating won lead:', leadId, wonData);\n\n    const lead = await Lead.findById(leadId);\n    if (!lead) {\n      return res.status(404).json({\n        success: false,\n        message: 'Lead not found'\n      });\n    }\n\n    // Check if lead is won\n    if (lead.status !== 'Won') {\n      return res.status(400).json({\n        success: false,\n        message: 'Only won leads can have their won details updated'\n      });\n    }\n\n    // Check permissions for employee\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee || lead.assignedTo.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied. You can only update your assigned leads.'\n        });\n      }\n    }\n\n    // Initialize wonDetails if it doesn't exist\n    if (!lead.wonDetails) {\n      lead.wonDetails = {};\n    }\n    \n    // Clean and convert data\n    Object.keys(wonData).forEach(key => {\n      if (wonData[key] !== undefined && wonData[key] !== '') {\n        // Convert numeric fields\n        if (['finalValue', 'recurringRevenue', 'discount', 'contractDuration', 'satisfactionScore'].includes(key)) {\n          lead.wonDetails[key] = Number(wonData[key]);\n        }\n        // Convert date fields\n        else if (['deliveryDate', 'renewalDate'].includes(key)) {\n          lead.wonDetails[key] = new Date(wonData[key]);\n        }\n        // String fields\n        else {\n          lead.wonDetails[key] = wonData[key];\n        }\n      }\n    });\n\n    // Mark the wonDetails path as modified for Mongoose\n    lead.markModified('wonDetails');\n\n    // Update actual value if final value is provided\n    if (wonData.finalValue) {\n      lead.actualValue = Number(wonData.finalValue);\n    }\n\n    await lead.save();\n\n    await lead.populate('assignedTo', 'personalInfo.firstName personalInfo.lastName employeeId');\n    await lead.populate('wonDetails.customerSuccessManager', 'personalInfo.firstName personalInfo.lastName');\n\n    console.log('Won lead updated successfully:', lead._id);\n\n    res.json({\n      success: true,\n      message: 'Won lead details updated successfully',\n      data: lead\n    });\n\n  } catch (error) {\n    console.error('Update won lead error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get all leads (with filters for sales employees)\nexport const getLeads = async (req, res) => {\n  try {\n    const { page = 1, limit = 20, status, priority, source, search } = req.query;\n\n    let query = {};\n\n    // If user is employee (sales), only show their assigned leads\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee) {\n        return res.status(404).json({\n          success: false,\n          message: 'Employee record not found'\n        });\n      }\n      query.assignedTo = employee._id;\n    }\n\n    // Apply filters\n    if (status && status !== 'all') {\n      query.status = status;\n    }\n    if (priority && priority !== 'all') {\n      query.priority = priority;\n    }\n    if (source && source !== 'all') {\n      query.source = source;\n    }\n\n    let leads = await Lead.find(query)\n      .populate('assignedTo', 'personalInfo.firstName personalInfo.lastName employeeId')\n      .populate('assignedBy', 'name email')\n      .populate('wonDetails.customerSuccessManager', 'personalInfo.firstName personalInfo.lastName')\n      .sort({ createdAt: -1 })\n      .limit(limit * 1)\n      .skip((page - 1) * limit);\n\n    // Apply search filter after population\n    if (search) {\n      const searchTerm = search.toLowerCase();\n      leads = leads.filter(lead => {\n        const fullName = lead.fullName?.toLowerCase() || '';\n        const email = lead.email?.toLowerCase() || '';\n        const company = lead.company?.toLowerCase() || '';\n        const phone = lead.phone?.toLowerCase() || '';\n        const leadId = lead.leadId?.toLowerCase() || '';\n        \n        return fullName.includes(searchTerm) || \n               email.includes(searchTerm) || \n               company.includes(searchTerm) ||\n               phone.includes(searchTerm) ||\n               leadId.includes(searchTerm);\n      });\n    }\n\n    const total = await Lead.countDocuments(query);\n\n    res.json({\n      success: true,\n      data: {\n        leads,\n        pagination: {\n          currentPage: parseInt(page),\n          totalPages: Math.ceil(total / limit),\n          totalLeads: total,\n          hasNext: page < Math.ceil(total / limit),\n          hasPrev: page > 1\n        }\n      }\n    });\n\n  } catch (error) {\n    console.error('Get leads error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get single lead by ID\nexport const getLeadById = async (req, res) => {\n  try {\n    const lead = await Lead.findById(req.params.id)\n      .populate('assignedTo', 'personalInfo.firstName personalInfo.lastName employeeId')\n      .populate('assignedBy', 'name email')\n      .populate('notes.addedBy', 'name email')\n      .populate('wonDetails.customerSuccessManager', 'personalInfo.firstName personalInfo.lastName')\n      .populate('meetings.createdBy', 'name email');\n\n    if (!lead) {\n      return res.status(404).json({\n        success: false,\n        message: 'Lead not found'\n      });\n    }\n\n    // Check if employee can access this lead\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (lead.assignedTo._id.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied. You can only view your assigned leads.'\n        });\n      }\n    }\n\n    res.json({\n      success: true,\n      data: lead\n    });\n\n  } catch (error) {\n    console.error('Get lead error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Update lead\nexport const updateLead = async (req, res) => {\n  try {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation failed',\n        errors: errors.array()\n      });\n    }\n\n    const leadId = req.params.id;\n    let updateData = req.body;\n\n    // Find the lead first\n    const existingLead = await Lead.findById(leadId);\n    if (!existingLead) {\n      return res.status(404).json({\n        success: false,\n        message: 'Lead not found'\n      });\n    }\n\n    // Check permissions for employee\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (existingLead.assignedTo.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied. You can only update your assigned leads.'\n        });\n      }\n      \n      // Employees cannot reassign leads\n      delete updateData.assignedTo;\n      delete updateData.assignedBy;\n    }\n\n    const lead = await Lead.findByIdAndUpdate(\n      leadId,\n      updateData,\n      { new: true, runValidators: true }\n    ).populate('assignedTo', 'personalInfo.firstName personalInfo.lastName employeeId')\n     .populate('assignedBy', 'name email')\n     .populate('wonDetails.customerSuccessManager', 'personalInfo.firstName personalInfo.lastName');\n\n    res.json({\n      success: true,\n      message: 'Lead updated successfully',\n      data: lead\n    });\n\n  } catch (error) {\n    console.error('Update lead error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Add meeting to lead\nexport const addMeeting = async (req, res) => {\n  try {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation failed',\n        errors: errors.array()\n      });\n    }\n\n    const leadId = req.params.id;\n    const meetingData = {\n      ...req.body,\n      createdBy: req.user.id\n    };\n\n    const lead = await Lead.findById(leadId);\n    if (!lead) {\n      return res.status(404).json({\n        success: false,\n        message: 'Lead not found'\n      });\n    }\n\n    // Check permissions for employee\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (lead.assignedTo.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied. You can only add meetings to your assigned leads.'\n        });\n      }\n    }\n\n    lead.meetings.push(meetingData);\n    await lead.save();\n\n    await lead.populate('meetings.createdBy', 'name email');\n\n    // Send meeting notification email (optional)\n    if (meetingData.type === 'Video Meeting' || meetingData.type === 'Call') {\n      try {\n        await sendEmail({\n          to: lead.email,\n          subject: `Meeting Scheduled - ${meetingData.type}`,\n          html: `\n            <h3>Meeting Scheduled</h3>\n            <p>Dear ${lead.firstName},</p>\n            <p>A ${meetingData.type.toLowerCase()} has been scheduled with you.</p>\n            <p><strong>Date:</strong> ${new Date(meetingData.scheduledDate).toLocaleString()}</p>\n            <p><strong>Duration:</strong> ${meetingData.duration} minutes</p>\n            <p><strong>Agenda:</strong> ${meetingData.agenda || 'To be discussed'}</p>\n            <p>We look forward to speaking with you.</p>\n          `\n        });\n      } catch (emailError) {\n        console.warn('Failed to send meeting notification email:', emailError);\n      }\n    }\n\n    res.json({\n      success: true,\n      message: 'Meeting added successfully',\n      data: lead\n    });\n\n  } catch (error) {\n    console.error('Add meeting error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Update meeting\nexport const updateMeeting = async (req, res) => {\n  try {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation failed',\n        errors: errors.array()\n      });\n    }\n\n    const { leadId, meetingId } = req.params;\n    const meetingData = req.body;\n\n    const lead = await Lead.findById(leadId);\n    if (!lead) {\n      return res.status(404).json({\n        success: false,\n        message: 'Lead not found'\n      });\n    }\n\n    const meetingIndex = lead.meetings.findIndex(m => m._id.toString() === meetingId);\n    if (meetingIndex === -1) {\n      return res.status(404).json({\n        success: false,\n        message: 'Meeting not found'\n      });\n    }\n\n    // Check permissions for employee\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (lead.assignedTo.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied. You can only update meetings for your assigned leads.'\n        });\n      }\n    }\n\n    // Update meeting\n    lead.meetings[meetingIndex] = {\n      ...lead.meetings[meetingIndex].toObject(),\n      ...meetingData,\n      updatedAt: new Date()\n    };\n\n    await lead.save();\n    await lead.populate('meetings.createdBy', 'name email');\n\n    res.json({\n      success: true,\n      message: 'Meeting updated successfully',\n      data: lead\n    });\n\n  } catch (error) {\n    console.error('Update meeting error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Add note to lead\nexport const addLeadNote = async (req, res) => {\n  try {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation failed',\n        errors: errors.array()\n      });\n    }\n\n    const { content, type = 'General' } = req.body;\n    const leadId = req.params.id;\n\n    if (!content || content.trim() === '') {\n      return res.status(400).json({\n        success: false,\n        message: 'Note content is required'\n      });\n    }\n\n    const lead = await Lead.findById(leadId);\n    if (!lead) {\n      return res.status(404).json({\n        success: false,\n        message: 'Lead not found'\n      });\n    }\n\n    // Check permissions for employee\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (lead.assignedTo.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied. You can only add notes to your assigned leads.'\n        });\n      }\n    }\n\n    lead.notes.push({\n      content: content.trim(),\n      addedBy: req.user.id,\n      addedAt: new Date(),\n      type: type\n    });\n\n    // Update last contact date\n    lead.lastContactDate = new Date();\n\n    await lead.save();\n\n    // Populate the updated lead with notes\n    await lead.populate('notes.addedBy', 'name email');\n\n    res.json({\n      success: true,\n      message: 'Note added successfully',\n      data: lead\n    });\n\n  } catch (error) {\n    console.error('Add note error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get upcoming meetings\nexport const getUpcomingMeetings = async (req, res) => {\n  try {\n    const { days = 7 } = req.query;\n    let employeeId = null;\n\n    // If employee, only show their meetings\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee) {\n        return res.status(404).json({\n          success: false,\n          message: 'Employee record not found'\n        });\n      }\n      employeeId = employee._id;\n    }\n\n    const upcomingMeetings = await Lead.getUpcomingMeetings(employeeId, parseInt(days));\n\n    res.json({\n      success: true,\n      data: upcomingMeetings\n    });\n\n  } catch (error) {\n    console.error('Get upcoming meetings error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get lead statistics\nexport const getLeadStats = async (req, res) => {\n  try {\n    let matchQuery = {};\n\n    // If employee, only show their stats\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee) {\n        return res.status(404).json({\n          success: false,\n          message: 'Employee record not found'\n        });\n      }\n      matchQuery.assignedTo = employee._id;\n    }\n\n    const [statusStats, priorityStats, sourceStats, monthlyStats, wonStats, meetingStats] = await Promise.all([\n      // Status statistics\n      Lead.aggregate([\n        { $match: matchQuery },\n        {\n          $group: {\n            _id: '$status',\n            count: { $sum: 1 },\n            totalValue: { $sum: { $ifNull: ['$estimatedValue', 0] } },\n            actualValue: { $sum: { $ifNull: ['$actualValue', 0] } }\n          }\n        }\n      ]),\n\n      // Priority statistics\n      Lead.aggregate([\n        { $match: matchQuery },\n        {\n          $group: {\n            _id: '$priority',\n            count: { $sum: 1 }\n          }\n        }\n      ]),\n\n      // Source statistics\n      Lead.aggregate([\n        { $match: matchQuery },\n        {\n          $group: {\n            _id: '$source',\n            count: { $sum: 1 }\n          }\n        }\n      ]),\n\n      // Monthly statistics (last 6 months)\n      Lead.aggregate([\n        { \n          $match: {\n            ...matchQuery,\n            createdAt: { $gte: new Date(Date.now() - 6 * 30 * 24 * 60 * 60 * 1000) }\n          }\n        },\n        {\n          $group: {\n            _id: {\n              year: { $year: '$createdAt' },\n              month: { $month: '$createdAt' }\n            },\n            count: { $sum: 1 },\n            won: { $sum: { $cond: [{ $eq: ['$status', 'Won'] }, 1, 0] } },\n            lost: { $sum: { $cond: [{ $eq: ['$status', 'Lost'] }, 1, 0] } },\n            totalRevenue: { $sum: { $cond: [{ $eq: ['$status', 'Won'] }, '$actualValue', 0] } }\n          }\n        },\n        { $sort: { '_id.year': 1, '_id.month': 1 } }\n      ]),\n\n      // Won leads statistics\n      Lead.getWonLeadsStats(matchQuery.assignedTo),\n\n      // Meeting statistics\n      Lead.getMeetingStats(matchQuery.assignedTo)\n    ]);\n\n    // Get overdue follow-ups count\n    const overdueCount = await Lead.countDocuments({\n      ...matchQuery,\n      nextFollowUpDate: { $lt: new Date() },\n      status: { $nin: ['Won', 'Lost'] }\n    });\n\n    // Get today's follow-ups\n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    const tomorrow = new Date(today);\n    tomorrow.setDate(tomorrow.getDate() + 1);\n\n    const todayFollowUps = await Lead.countDocuments({\n      ...matchQuery,\n      nextFollowUpDate: { $gte: today, $lt: tomorrow },\n      status: { $nin: ['Won', 'Lost'] }\n    });\n\n    // Get today's meetings\n    const todayMeetings = await Lead.countDocuments({\n      ...matchQuery,\n      'meetings.scheduledDate': { $gte: today, $lt: tomorrow },\n      'meetings.status': 'Scheduled'\n    });\n\n    // Get upcoming meetings count (next 7 days)\n    const nextWeek = new Date(today);\n    nextWeek.setDate(nextWeek.getDate() + 7);\n\n    const upcomingMeetingsCount = await Lead.countDocuments({\n      ...matchQuery,\n      'meetings.scheduledDate': { $gte: today, $lte: nextWeek },\n      'meetings.status': 'Scheduled'\n    });\n\n    res.json({\n      success: true,\n      data: {\n        statusStats,\n        priorityStats,\n        sourceStats,\n        monthlyStats,\n        wonStats: wonStats[0] || {\n          totalWon: 0,\n          totalRevenue: 0,\n          avgDealSize: 0,\n          totalRecurringRevenue: 0,\n          avgMeetingsToClose: 0,\n          avgSatisfactionScore: 0\n        },\n        meetingStats,\n        overdueCount,\n        todayFollowUps,\n        todayMeetings,\n        upcomingMeetingsCount\n      }\n    });\n\n  } catch (error) {\n    console.error('Get lead stats error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get won leads statistics\nexport const getWonLeadsStats = async (req, res) => {\n  try {\n    let employeeId = null;\n\n    // If employee, only show their stats\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee) {\n        return res.status(404).json({\n          success: false,\n          message: 'Employee record not found'\n        });\n      }\n      employeeId = employee._id;\n    }\n\n    const wonStats = await Lead.getWonLeadsStats(employeeId);\n\n    res.json({\n      success: true,\n      data: wonStats[0] || {\n        totalWon: 0,\n        totalRevenue: 0,\n        avgDealSize: 0,\n        totalRecurringRevenue: 0,\n        avgMeetingsToClose: 0,\n        avgSatisfactionScore: 0\n      }\n    });\n\n  } catch (error) {\n    console.error('Get won leads stats error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get meeting statistics\nexport const getMeetingStats = async (req, res) => {\n  try {\n    let employeeId = null;\n\n    // If employee, only show their stats\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee) {\n        return res.status(404).json({\n          success: false,\n          message: 'Employee record not found'\n        });\n      }\n      employeeId = employee._id;\n    }\n\n    const meetingStats = await Lead.getMeetingStats(employeeId);\n\n    res.json({\n      success: true,\n      data: meetingStats\n    });\n\n  } catch (error) {\n    console.error('Get meeting stats error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get upcoming follow-ups\nexport const getUpcomingFollowUps = async (req, res) => {\n  try {\n    let matchQuery = {};\n\n    // If employee, only show their leads\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee) {\n        return res.status(404).json({\n          success: false,\n          message: 'Employee record not found'\n        });\n      }\n      matchQuery.assignedTo = employee._id;\n    }\n\n    const upcomingLeads = await Lead.find({\n      ...matchQuery,\n      nextFollowUpDate: { $gte: new Date() },\n      status: { $nin: ['Won', 'Lost'] }\n    })\n    .populate('assignedTo', 'personalInfo.firstName personalInfo.lastName employeeId')\n    .sort({ nextFollowUpDate: 1 })\n    .limit(10);\n\n    res.json({\n      success: true,\n      data: upcomingLeads\n    });\n\n  } catch (error) {\n    console.error('Get upcoming follow-ups error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get overdue follow-ups\nexport const getOverdueFollowUps = async (req, res) => {\n  try {\n    let matchQuery = {};\n\n    // If employee, only show their leads\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee) {\n        return res.status(404).json({\n          success: false,\n          message: 'Employee record not found'\n        });\n      }\n      matchQuery.assignedTo = employee._id;\n    }\n\n    const overdueLeads = await Lead.find({\n      ...matchQuery,\n      nextFollowUpDate: { $lt: new Date() },\n      status: { $nin: ['Won', 'Lost'] }\n    })\n    .populate('assignedTo', 'personalInfo.firstName personalInfo.lastName employeeId')\n    .sort({ nextFollowUpDate: 1 });\n\n    res.json({\n      success: true,\n      data: overdueLeads\n    });\n\n  } catch (error) {\n    console.error('Get overdue follow-ups error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Delete lead (Admin only)\nexport const deleteLead = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const lead = await Lead.findByIdAndDelete(req.params.id);\n    if (!lead) {\n      return res.status(404).json({\n        success: false,\n        message: 'Lead not found'\n      });\n    }\n\n    res.json({\n      success: true,\n      message: 'Lead deleted successfully'\n    });\n\n  } catch (error) {\n    console.error('Delete lead error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n","path":null,"size_bytes":27852,"size_tokens":null},"frontend/src/pages/Admin/ContinuousFaceRegistration.jsx":{"content":"import React, { useState, useRef, useEffect, useCallback } from 'react';\nimport AdminLayout from '../../components/Admin/layout/AdminLayout';\nimport { Video, Square, Save, UserPlus, AlertCircle, CheckCircle, RotateCcw, Play, Loader2 } from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport { employeeAPI } from '../../utils/api';\nimport { faceAPI, CameraHelper } from '../../utils/faceAPI';\n\nconst REQUIRED_POSES = ['front', 'left', 'right'];\nconst MIN_RECORDING_TIME = 5000;\nconst MAX_RECORDING_TIME = 15000;\nconst FRAME_CAPTURE_INTERVAL = 200;\n\nconst POSE_INSTRUCTIONS = {\n  front: { text: 'Look directly at the camera', icon: '👤' },\n  left: { text: 'Turn head slightly LEFT', icon: '👈' },\n  right: { text: 'Turn head slightly RIGHT', icon: '👉' },\n  up: { text: 'Tilt head slightly UP', icon: '👆' },\n  down: { text: 'Tilt head slightly DOWN', icon: '👇' }\n};\n\nconst ContinuousFaceRegistration = () => {\n  const videoRef = useRef();\n  const localCameraHelper = useRef(null);\n  const recordingInterval = useRef(null);\n  const capturedFrames = useRef([]);\n  const recordingStartTime = useRef(null);\n\n  const [employees, setEmployees] = useState([]);\n  const [selectedEmployee, setSelectedEmployee] = useState(null);\n  const [cameraReady, setCameraReady] = useState(false);\n  const [loading, setLoading] = useState(false);\n  \n  const [isRecording, setIsRecording] = useState(false);\n  const [recordingProgress, setRecordingProgress] = useState(0);\n  const [currentPose, setCurrentPose] = useState(null);\n  const [detectedPoses, setDetectedPoses] = useState({ front: false, left: false, right: false });\n  const [qualityFeedback, setQualityFeedback] = useState(null);\n  \n  const [isProcessing, setIsProcessing] = useState(false);\n  const [registrationComplete, setRegistrationComplete] = useState(false);\n  const [registrationResult, setRegistrationResult] = useState(null);\n\n  useEffect(() => {\n    fetchEmployees();\n    startVideo();\n\n    return () => {\n      stopRecording();\n      if (localCameraHelper.current) {\n        localCameraHelper.current.stopCamera();\n      }\n    };\n  }, []);\n\n  const startVideo = async () => {\n    try {\n      setLoading(true);\n      if (!localCameraHelper.current) {\n        localCameraHelper.current = new CameraHelper();\n      }\n      await localCameraHelper.current.startCamera(videoRef.current);\n      setCameraReady(true);\n    } catch (error) {\n      console.error('Failed to start camera:', error);\n      toast.error(error.message || 'Failed to access camera');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const fetchEmployees = async () => {\n    try {\n      const response = await employeeAPI.getEmployees({ \n        limit: 100,\n        status: 'Active'\n      });\n\n      const employeesData = Array.isArray(response.data.data?.employees) \n        ? response.data.data.employees \n        : [];\n\n      setEmployees(employeesData);\n    } catch (error) {\n      console.error('Error fetching employees:', error);\n      toast.error('Failed to fetch employees');\n      setEmployees([]);\n    }\n  };\n\n  const analyzeCurrentFrame = useCallback(async () => {\n    if (!cameraReady || !videoRef.current) return null;\n\n    try {\n      const imageBase64 = localCameraHelper.current.captureImage(videoRef.current);\n      if (!imageBase64) return null;\n\n      const response = await faceAPI.analyzeFrameBase64(imageBase64);\n      \n      if (response.data.success && response.data.face_detected) {\n        const detectedPose = response.data.angle_estimate || 'front';\n        setCurrentPose(detectedPose);\n        setQualityFeedback({\n          passed: response.data.quality.passed,\n          score: response.data.quality.score,\n          issues: response.data.quality.issues || [],\n          pose: detectedPose\n        });\n\n        if (response.data.quality.passed || response.data.quality.score >= 0.6) {\n          setDetectedPoses(prev => ({\n            ...prev,\n            [detectedPose]: true\n          }));\n        }\n\n        return { imageBase64, pose: detectedPose, quality: response.data.quality };\n      } else {\n        setCurrentPose(null);\n        setQualityFeedback({\n          passed: false,\n          score: 0,\n          issues: [response.data.message || 'No face detected'],\n          pose: null\n        });\n        return null;\n      }\n    } catch (error) {\n      console.error('Frame analysis error:', error);\n      return null;\n    }\n  }, [cameraReady]);\n\n  const startRecording = useCallback(async () => {\n    if (!cameraReady || !selectedEmployee) {\n      toast.error('Please select an employee and ensure camera is ready');\n      return;\n    }\n\n    setIsRecording(true);\n    setDetectedPoses({ front: false, left: false, right: false });\n    capturedFrames.current = [];\n    recordingStartTime.current = Date.now();\n    setRecordingProgress(0);\n\n    toast.success('Recording started! Move your head slowly: front, left, right');\n\n    recordingInterval.current = setInterval(async () => {\n      const elapsed = Date.now() - recordingStartTime.current;\n      const progress = Math.min(100, (elapsed / MAX_RECORDING_TIME) * 100);\n      setRecordingProgress(progress);\n\n      if (!videoRef.current || !localCameraHelper.current) return;\n\n      try {\n        const imageBase64 = localCameraHelper.current.captureImage(videoRef.current);\n        if (imageBase64) {\n          capturedFrames.current.push(imageBase64);\n        }\n      } catch (e) {\n        console.error('Frame capture error:', e);\n      }\n\n      try {\n        const response = await faceAPI.analyzeFrameBase64(\n          localCameraHelper.current.captureImage(videoRef.current)\n        );\n        \n        if (response.data.success && response.data.face_detected) {\n          const pose = response.data.angle_estimate || 'front';\n          setCurrentPose(pose);\n          setQualityFeedback({\n            passed: response.data.quality.passed,\n            score: response.data.quality.score,\n            issues: response.data.quality.issues || [],\n            pose\n          });\n          \n          if (response.data.quality.passed || response.data.quality.score >= 0.6) {\n            setDetectedPoses(prev => ({ ...prev, [pose]: true }));\n          }\n        }\n      } catch (e) {\n        console.error('Analysis error:', e);\n      }\n\n      if (elapsed >= MAX_RECORDING_TIME) {\n        stopRecording();\n      }\n    }, FRAME_CAPTURE_INTERVAL);\n  }, [cameraReady, selectedEmployee]);\n\n  const stopRecording = useCallback(() => {\n    if (recordingInterval.current) {\n      clearInterval(recordingInterval.current);\n      recordingInterval.current = null;\n    }\n    \n    if (!isRecording) return;\n\n    const elapsed = Date.now() - (recordingStartTime.current || Date.now());\n    \n    if (elapsed < MIN_RECORDING_TIME) {\n      toast.error('Recording too short. Please record for at least 5 seconds.');\n      setIsRecording(false);\n      capturedFrames.current = [];\n      return;\n    }\n\n    setIsRecording(false);\n    setRecordingProgress(100);\n    \n    const allPosesCaptured = REQUIRED_POSES.every(pose => detectedPoses[pose]);\n    \n    if (!allPosesCaptured && capturedFrames.current.length > 20) {\n      toast('Processing video... We will check all poses automatically.', { icon: '🎬' });\n    }\n\n    if (capturedFrames.current.length >= 10) {\n      processRecording();\n    } else {\n      toast.error('Not enough frames captured. Please try again.');\n      capturedFrames.current = [];\n    }\n  }, [isRecording, detectedPoses]);\n\n  const processRecording = async () => {\n    if (capturedFrames.current.length < 10) {\n      toast.error('Not enough frames captured');\n      return;\n    }\n\n    setIsProcessing(true);\n    \n    try {\n      const response = await faceAPI.registerContinuousVideo(\n        selectedEmployee._id,\n        capturedFrames.current\n      );\n\n      if (response.data.success) {\n        setRegistrationComplete(true);\n        setRegistrationResult(response.data);\n        toast.success('Face registered successfully!');\n        fetchEmployees();\n      } else {\n        toast.error(response.data.message || 'Registration failed');\n        \n        if (response.data.poses_captured) {\n          setDetectedPoses(response.data.poses_captured);\n        }\n      }\n    } catch (error) {\n      console.error('Registration error:', error);\n      const errorMsg = error.response?.data?.message || error.message || 'Failed to process video';\n      toast.error(errorMsg);\n    } finally {\n      setIsProcessing(false);\n      capturedFrames.current = [];\n    }\n  };\n\n  const resetRegistration = () => {\n    setSelectedEmployee(null);\n    setIsRecording(false);\n    setRecordingProgress(0);\n    setCurrentPose(null);\n    setDetectedPoses({ front: false, left: false, right: false });\n    setQualityFeedback(null);\n    setRegistrationComplete(false);\n    setRegistrationResult(null);\n    capturedFrames.current = [];\n    \n    if (recordingInterval.current) {\n      clearInterval(recordingInterval.current);\n      recordingInterval.current = null;\n    }\n  };\n\n  const getMissingPoses = () => {\n    return REQUIRED_POSES.filter(pose => !detectedPoses[pose]);\n  };\n\n  const getNextPoseInstruction = () => {\n    const missing = getMissingPoses();\n    if (missing.length === 0) return null;\n    return POSE_INSTRUCTIONS[missing[0]];\n  };\n\n  return (\n    <AdminLayout>\n      <div className=\"max-w-screen-lg mx-auto px-4 sm:px-6 lg:px-8 space-y-6\">\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <h1 className=\"text-3xl font-bold text-white mb-2\">\n            Continuous Video <span className=\"neon-text\">Face Registration</span>\n          </h1>\n          <p className=\"text-secondary-400\">\n            Record a single continuous video - the system automatically captures all required poses\n          </p>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n            <h2 className=\"text-lg sm:text-xl font-bold text-white mb-4\">Select Employee</h2>\n            <div className=\"space-y-3 max-h-64 sm:max-h-96 overflow-y-auto\">\n              {employees.length === 0 ? (\n                <p className=\"text-secondary-400 text-center py-4\">No active employees found</p>\n              ) : (\n                employees.map(employee => (\n                  <div\n                    key={employee._id}\n                    onClick={() => {\n                      if (!isRecording && !isProcessing) {\n                        setSelectedEmployee(employee);\n                        resetRegistration();\n                        setSelectedEmployee(employee);\n                      }\n                    }}\n                    className={`p-3 rounded-lg cursor-pointer transition-colors ${\n                      selectedEmployee?._id === employee._id\n                        ? 'bg-neon-pink/20 border border-neon-pink'\n                        : 'bg-secondary-800/50 hover:bg-secondary-700'\n                    } ${isRecording || isProcessing ? 'opacity-50 cursor-not-allowed' : ''}`}\n                  >\n                    <div className=\"flex items-center space-x-3\">\n                      <div className=\"w-10 h-10 bg-gradient-to-r from-neon-pink to-neon-purple rounded-lg flex items-center justify-center\">\n                        {employee.hasFaceRegistered ? (\n                          <CheckCircle className=\"w-5 h-5 text-green-400\" />\n                        ) : (\n                          <UserPlus className=\"w-5 h-5 text-white\" />\n                        )}\n                      </div>\n                      <div className=\"flex-1\">\n                        <p className=\"text-white font-medium\">\n                          {employee.personalInfo?.firstName} {employee.personalInfo?.lastName}\n                        </p>\n                        <p className=\"text-xs text-secondary-400\">\n                          ID: {employee.employeeId}\n                        </p>\n                        {employee.hasFaceRegistered && (\n                          <p className=\"text-xs text-green-400\">Face registered</p>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                ))\n              )}\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6 lg:col-span-2\">\n            <div className=\"flex items-center justify-between mb-4\">\n              <h2 className=\"text-xl font-bold text-white\">Continuous Video Capture</h2>\n              {selectedEmployee && !isRecording && !isProcessing && (\n                <button\n                  onClick={resetRegistration}\n                  className=\"px-3 py-1 text-sm text-secondary-400 hover:text-white flex items-center space-x-1\"\n                >\n                  <RotateCcw className=\"w-4 h-4\" />\n                  <span>Reset</span>\n                </button>\n              )}\n            </div>\n\n            {!selectedEmployee ? (\n              <div className=\"text-center py-12 text-secondary-400\">\n                <UserPlus className=\"w-16 h-16 mx-auto mb-4 opacity-50\" />\n                <p>Select an employee to begin face registration</p>\n              </div>\n            ) : registrationComplete ? (\n              <div className=\"text-center py-12\">\n                <CheckCircle className=\"w-16 h-16 mx-auto mb-4 text-green-400\" />\n                <h3 className=\"text-xl font-bold text-white mb-2\">Registration Complete!</h3>\n                <p className=\"text-secondary-400 mb-4\">\n                  Face has been registered for {selectedEmployee.personalInfo?.firstName} {selectedEmployee.personalInfo?.lastName}\n                </p>\n                {registrationResult && (\n                  <div className=\"bg-secondary-800/50 rounded-lg p-4 mb-4 text-left max-w-md mx-auto\">\n                    <p className=\"text-sm text-secondary-300 mb-2\">Registration Details:</p>\n                    <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                      <span className=\"text-secondary-400\">Frames Processed:</span>\n                      <span className=\"text-white\">{registrationResult.total_frames_processed}</span>\n                      <span className=\"text-secondary-400\">Liveness Score:</span>\n                      <span className=\"text-green-400\">{(registrationResult.liveness_score * 100).toFixed(1)}%</span>\n                      <span className=\"text-secondary-400\">Poses Captured:</span>\n                      <span className=\"text-white\">\n                        {Object.entries(registrationResult.poses_captured || {})\n                          .filter(([_, v]) => v)\n                          .map(([k]) => k)\n                          .join(', ')}\n                      </span>\n                    </div>\n                  </div>\n                )}\n                <button\n                  onClick={resetRegistration}\n                  className=\"px-6 py-2 bg-neon-pink/20 text-neon-pink rounded-lg hover:bg-neon-pink/30 transition-colors\"\n                >\n                  Register Another Employee\n                </button>\n              </div>\n            ) : (\n              <>\n                <div className=\"mb-4\">\n                  <div className=\"flex justify-center space-x-6 mb-4\">\n                    {REQUIRED_POSES.map((pose) => (\n                      <div\n                        key={pose}\n                        className={`flex flex-col items-center transition-all ${\n                          currentPose === pose ? 'scale-110' : ''\n                        }`}\n                      >\n                        <div className={`w-14 h-14 rounded-full flex items-center justify-center border-2 transition-all ${\n                          detectedPoses[pose]\n                            ? 'bg-green-500/20 border-green-500'\n                            : currentPose === pose\n                            ? 'bg-neon-pink/30 border-neon-pink animate-pulse'\n                            : 'bg-secondary-800 border-secondary-600'\n                        }`}>\n                          {detectedPoses[pose] ? (\n                            <CheckCircle className=\"w-7 h-7 text-green-400\" />\n                          ) : (\n                            <span className=\"text-2xl\">{POSE_INSTRUCTIONS[pose].icon}</span>\n                          )}\n                        </div>\n                        <span className={`text-xs mt-1 capitalize ${\n                          currentPose === pose ? 'text-neon-pink font-bold' : 'text-secondary-400'\n                        }`}>{pose}</span>\n                      </div>\n                    ))}\n                  </div>\n                  \n                  {isRecording && (\n                    <div className=\"mb-4\">\n                      <div className=\"flex justify-between text-sm text-secondary-400 mb-1\">\n                        <span>Recording Progress</span>\n                        <span>{Math.round(recordingProgress)}%</span>\n                      </div>\n                      <div className=\"h-2 bg-secondary-700 rounded-full overflow-hidden\">\n                        <div \n                          className=\"h-full bg-gradient-to-r from-neon-pink to-neon-purple transition-all duration-200\"\n                          style={{ width: `${recordingProgress}%` }}\n                        />\n                      </div>\n                    </div>\n                  )}\n                  \n                  {isRecording && getNextPoseInstruction() && (\n                    <div className=\"text-center mb-4 p-3 bg-neon-pink/10 rounded-lg animate-pulse\">\n                      <p className=\"text-white font-medium\">\n                        <span className=\"text-2xl mr-2\">{getNextPoseInstruction().icon}</span>\n                        {getNextPoseInstruction().text}\n                      </p>\n                    </div>\n                  )}\n                  \n                  {isRecording && getMissingPoses().length === 0 && (\n                    <div className=\"text-center mb-4 p-3 bg-green-500/20 rounded-lg\">\n                      <p className=\"text-green-400 font-medium\">\n                        All poses captured! You can stop recording now.\n                      </p>\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"relative bg-black rounded-lg overflow-hidden\">\n                  <video\n                    ref={videoRef}\n                    width=\"640\"\n                    height=\"480\"\n                    className=\"w-full\"\n                    autoPlay\n                    muted\n                    playsInline\n                    style={{ objectFit: 'cover', transform: 'scaleX(-1)' }}\n                  />\n\n                  {loading && (\n                    <div className=\"absolute inset-0 bg-black/50 flex items-center justify-center\">\n                      <div className=\"text-white text-center\">\n                        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-neon-pink mx-auto mb-2\"></div>\n                        <p>Starting camera...</p>\n                      </div>\n                    </div>\n                  )}\n\n                  {isProcessing && (\n                    <div className=\"absolute inset-0 bg-black/70 flex items-center justify-center\">\n                      <div className=\"text-white text-center\">\n                        <Loader2 className=\"w-12 h-12 mx-auto mb-3 animate-spin text-neon-pink\" />\n                        <p className=\"text-lg font-medium\">Processing video...</p>\n                        <p className=\"text-sm text-secondary-400\">Analyzing faces and checking liveness</p>\n                      </div>\n                    </div>\n                  )}\n\n                  {isRecording && (\n                    <div className=\"absolute top-4 left-4 flex items-center space-x-2\">\n                      <div className=\"w-3 h-3 bg-red-500 rounded-full animate-pulse\" />\n                      <span className=\"text-white font-medium\">RECORDING</span>\n                    </div>\n                  )}\n\n                  {qualityFeedback && !isProcessing && (\n                    <div className={`absolute top-4 right-4 p-3 rounded-lg ${\n                      qualityFeedback.passed ? 'bg-green-500/80' : 'bg-yellow-500/80'\n                    }`}>\n                      <p className=\"text-white text-sm font-medium\">\n                        {qualityFeedback.passed ? 'Good quality!' : 'Adjust position'}\n                      </p>\n                      {qualityFeedback.issues?.length > 0 && (\n                        <p className=\"text-white text-xs mt-1\">{qualityFeedback.issues[0]}</p>\n                      )}\n                      {qualityFeedback.pose && (\n                        <p className=\"text-white text-xs mt-1\">\n                          Detected: <span className=\"font-bold capitalize\">{qualityFeedback.pose}</span>\n                        </p>\n                      )}\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"flex justify-center mt-6 space-x-4\">\n                  {!isRecording ? (\n                    <button\n                      onClick={startRecording}\n                      disabled={!cameraReady || isProcessing}\n                      className=\"px-8 py-4 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-xl flex items-center space-x-3 disabled:opacity-50 hover-glow transition-all duration-300\"\n                    >\n                      <Play className=\"w-6 h-6\" />\n                      <span>Start Recording</span>\n                    </button>\n                  ) : (\n                    <button\n                      onClick={stopRecording}\n                      className=\"px-8 py-4 bg-gradient-to-r from-red-500 to-red-600 text-white font-semibold rounded-xl flex items-center space-x-3 hover-glow transition-all duration-300\"\n                    >\n                      <Square className=\"w-6 h-6\" />\n                      <span>Stop Recording</span>\n                    </button>\n                  )}\n                </div>\n              </>\n            )}\n          </div>\n        </div>\n\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <h2 className=\"text-xl font-bold text-white mb-4\">How It Works</h2>\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 text-sm\">\n            <div className=\"flex items-start space-x-3\">\n              <div className=\"w-10 h-10 bg-neon-pink/20 rounded-full flex items-center justify-center flex-shrink-0\">\n                <span className=\"text-neon-pink font-bold\">1</span>\n              </div>\n              <div>\n                <p className=\"text-white font-medium\">Start Recording</p>\n                <p className=\"text-secondary-400\">Click the button to begin single continuous video capture</p>\n              </div>\n            </div>\n            <div className=\"flex items-start space-x-3\">\n              <div className=\"w-10 h-10 bg-neon-pink/20 rounded-full flex items-center justify-center flex-shrink-0\">\n                <span className=\"text-neon-pink font-bold\">2</span>\n              </div>\n              <div>\n                <p className=\"text-white font-medium\">Move Naturally</p>\n                <p className=\"text-secondary-400\">Slowly turn your head front, left, and right while recording</p>\n              </div>\n            </div>\n            <div className=\"flex items-start space-x-3\">\n              <div className=\"w-10 h-10 bg-neon-pink/20 rounded-full flex items-center justify-center flex-shrink-0\">\n                <span className=\"text-neon-pink font-bold\">3</span>\n              </div>\n              <div>\n                <p className=\"text-white font-medium\">Stop Recording</p>\n                <p className=\"text-secondary-400\">Click stop when all pose indicators turn green</p>\n              </div>\n            </div>\n            <div className=\"flex items-start space-x-3\">\n              <div className=\"w-10 h-10 bg-neon-pink/20 rounded-full flex items-center justify-center flex-shrink-0\">\n                <span className=\"text-neon-pink font-bold\">4</span>\n              </div>\n              <div>\n                <p className=\"text-white font-medium\">Auto Processing</p>\n                <p className=\"text-secondary-400\">System analyzes video, extracts best frames, and registers face</p>\n              </div>\n            </div>\n          </div>\n          <div className=\"mt-4 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg\">\n            <div className=\"flex items-start space-x-2\">\n              <AlertCircle className=\"w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5\" />\n              <p className=\"text-blue-300 text-sm\">\n                The continuous video capture includes automatic liveness detection and anti-spoofing checks, \n                ensuring only real faces from live video are registered. No photos or videos can bypass this system.\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n    </AdminLayout>\n  );\n};\n\nexport default ContinuousFaceRegistration;\n","path":null,"size_bytes":25122,"size_tokens":null},"backend/routes/dashboardRoutes.js":{"content":"// routes/dashboardRoutes.js\nimport express from 'express';\nimport { protect, adminOnly } from '../middleware/authMiddleware.js';\nimport {\n  getAdminStats,\n  getEmployeeStats,\n  getRecentActivities,\n  getUpcomingEvents,\n  getDashboardSummary,\n  getUserNotifications,\n  markNotificationAsRead,\n  markAllNotificationsAsRead\n} from '../controllers/dashboardController.js';\n\nconst router = express.Router();\n\n// All dashboard routes require authentication\nrouter.use(protect);\n\n// General dashboard summary (role-based)\nrouter.get('/summary', getDashboardSummary);\n\n// Admin specific routes\nrouter.get('/stats', adminOnly, getAdminStats);\nrouter.get('/activities', adminOnly, getRecentActivities);\n\n// Employee specific routes\nrouter.get('/employee-stats', getEmployeeStats);\n\n// Common routes (accessible to both)\nrouter.get('/events', getUpcomingEvents);\n\n// / New notification routes\nrouter.get('/notifications', protect, getUserNotifications);\nrouter.put('/notifications/:id/read', protect, markNotificationAsRead);\nrouter.put('/notifications/read-all', protect, markAllNotificationsAsRead);\n\nexport default router;\n\n","path":null,"size_bytes":1117,"size_tokens":null},"backend/controllers/departmentController.js":{"content":"// Fixed department controller with proper employee count handling and data consistency\n\nimport Department from '../models/Department.js';\nimport Employee from '../models/Employee.js';\n\n// Get all departments with employee counts\nexport const getDepartments = async (req, res) => {\n  try {\n    const { page = 1, limit = 50, status, search } = req.query;\n\n    let query = {};\n    if (status && status !== 'all') {\n      query.status = status;\n    }\n\n    // Get departments first\n    let departments = await Department.find(query)\n      .sort({ name: 1 })\n      .limit(limit * 1)\n      .skip((page - 1) * limit)\n      .lean(); // Use lean for better performance\n\n    // FIXED: Update employee counts efficiently with proper ObjectId matching\n    const departmentIds = departments.map(dept => dept._id);\n    const employeeCounts = await Employee.aggregate([\n      {\n        $match: {\n          'workInfo.department': { $in: departmentIds },\n          status: { $ne: 'Terminated' }\n        }\n      },\n      {\n        $group: {\n          _id: '$workInfo.department',\n          count: { $sum: 1 }\n        }\n      }\n    ]);\n\n    // Create a map for quick lookup\n    const countMap = {};\n    employeeCounts.forEach(count => {\n      countMap[count._id.toString()] = count.count;\n    });\n\n    // Add employee counts to departments\n    departments = departments.map(dept => ({\n      ...dept,\n      employeeCount: countMap[dept._id.toString()] || 0\n    }));\n\n    // Apply search filter if provided\n    if (search) {\n      const searchTerm = search.toLowerCase();\n      departments = departments.filter(dept => \n        dept.name.toLowerCase().includes(searchTerm) ||\n        dept.code.toLowerCase().includes(searchTerm) ||\n        (dept.manager && dept.manager.toLowerCase().includes(searchTerm)) ||\n        (dept.description && dept.description.toLowerCase().includes(searchTerm))\n      );\n    }\n\n    const total = await Department.countDocuments(query);\n\n    res.json({\n      success: true,\n      data: departments,\n      pagination: {\n        currentPage: parseInt(page),\n        totalPages: Math.ceil(total / limit),\n        totalDepartments: total,\n        hasNext: page < Math.ceil(total / limit),\n        hasPrev: page > 1\n      }\n    });\n\n  } catch (error) {\n    console.error('Get departments error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get department by ID with employee count\nexport const getDepartmentById = async (req, res) => {\n  try {\n    const department = await Department.findById(req.params.id).lean();\n    \n    if (!department) {\n      return res.status(404).json({\n        success: false,\n        message: 'Department not found'\n      });\n    }\n\n    // Get employee count for this department\n    const employeeCount = await Employee.countDocuments({\n      'workInfo.department': department._id,\n      status: { $ne: 'Terminated' }\n    });\n\n    res.json({\n      success: true,\n      data: {\n        ...department,\n        employeeCount\n      }\n    });\n\n  } catch (error) {\n    console.error('Get department error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Create new department\nexport const createDepartment = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const department = await Department.create(req.body);\n    \n    res.status(201).json({\n      success: true,\n      message: 'Department created successfully',\n      data: { ...department.toObject(), employeeCount: 0 }\n    });\n\n  } catch (error) {\n    console.error('Create department error:', error);\n    \n    if (error.code === 11000) {\n      const field = Object.keys(error.keyPattern)[0];\n      const value = error.keyValue[field];\n      return res.status(400).json({\n        success: false,\n        message: `Department ${field} '${value}' already exists`\n      });\n    }\n    \n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Update department\nexport const updateDepartment = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const department = await Department.findByIdAndUpdate(\n      req.params.id,\n      req.body,\n      { new: true, runValidators: true }\n    ).lean();\n\n    if (!department) {\n      return res.status(404).json({\n        success: false,\n        message: 'Department not found'\n      });\n    }\n\n    // Get current employee count\n    const employeeCount = await Employee.countDocuments({\n      'workInfo.department': department._id,\n      status: { $ne: 'Terminated' }\n    });\n\n    res.json({\n      success: true,\n      message: 'Department updated successfully',\n      data: {\n        ...department,\n        employeeCount\n      }\n    });\n\n  } catch (error) {\n    console.error('Update department error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Delete department\nexport const deleteDepartment = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const department = await Department.findById(req.params.id);\n    \n    if (!department) {\n      return res.status(404).json({\n        success: false,\n        message: 'Department not found'\n      });\n    }\n\n    // Check if department has employees\n    const employeeCount = await Employee.countDocuments({ \n      'workInfo.department': department._id,\n      status: { $ne: 'Terminated' }\n    });\n\n    if (employeeCount > 0) {\n      return res.status(400).json({\n        success: false,\n        message: `Cannot delete department. It has ${employeeCount} active employee(s). Please reassign employees first.`\n      });\n    }\n\n    await Department.findByIdAndDelete(req.params.id);\n\n    res.json({\n      success: true,\n      message: 'Department deleted successfully'\n    });\n\n  } catch (error) {\n    console.error('Delete department error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get department statistics\nexport const getDepartmentStats = async (req, res) => {\n  try {\n    const stats = await Department.getDepartmentStats();\n    \n    res.json({\n      success: true,\n      data: stats\n    });\n\n  } catch (error) {\n    console.error('Get department stats error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get department list (lightweight - for dropdowns)\nexport const getDepartmentList = async (req, res) => {\n  try {\n    const departments = await Department.find({ status: 'Active' })\n      .select('_id name code')\n      .sort({ name: 1 })\n      .lean();\n\n    res.json({\n      success: true,\n      data: departments\n    });\n\n  } catch (error) {\n    console.error('Get department list error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get employees by department\nexport const getDepartmentEmployees = async (req, res) => {\n  try {\n    const { id } = req.params;\n    \n    const department = await Department.findById(id).lean();\n    if (!department) {\n      return res.status(404).json({\n        success: false,\n        message: 'Department not found'\n      });\n    }\n\n    const employees = await Employee.find({ \n      'workInfo.department': id,\n      status: { $ne: 'Terminated' }\n    })\n    .populate('user', 'name email role employeeId isActive')\n    .select('personalInfo workInfo user employeeId status')\n    .sort({ 'personalInfo.firstName': 1 })\n    .lean();\n\n    res.json({\n      success: true,\n      data: {\n        department: {\n          _id: department._id,\n          name: department.name,\n          code: department.code\n        },\n        employees,\n        count: employees.length\n      }\n    });\n\n  } catch (error) {\n    console.error('Get department employees error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};","path":null,"size_bytes":8295,"size_tokens":null},"frontend/src/components/Admin/Dashboard/StatCard.jsx":{"content":"// components/Dashboard/StatCard.js\nimport React from 'react';\n\nconst StatCard = ({ stat, index }) => {\n  const getChangeStyles = (changeType) => {\n    const styles = {\n      positive: 'text-green-400 bg-green-400/10',\n      negative: 'text-red-400 bg-red-400/10',\n      neutral: 'text-gray-400 bg-gray-400/10'\n    };\n    return styles[changeType] || styles.neutral;\n  };\n\n  return (\n    <div className=\"glass-morphism neon-border rounded-2xl p-6 hover-glow transition-all duration-300\">\n      <div className=\"flex items-center justify-between mb-4\">\n        <div className={`w-12 h-12 bg-gradient-to-r ${stat.color} rounded-lg flex items-center justify-center shadow-lg`}>\n          <stat.icon className=\"w-6 h-6 text-white\" />\n        </div>\n        {stat.change && (\n          <span className={`text-sm font-medium px-2 py-1 rounded-full transition-colors ${getChangeStyles(stat.changeType)}`}>\n            {stat.change}\n          </span>\n        )}\n      </div>\n      <div>\n        <h3 className=\"text-2xl font-bold text-white mb-1 transition-colors\">\n          {typeof stat.value === 'number' ? stat.value.toLocaleString() : stat.value}\n        </h3>\n        <p className=\"text-secondary-400 text-sm\">{stat.title}</p>\n      </div>\n    </div>\n  );\n};\n\nexport default StatCard;","path":null,"size_bytes":1280,"size_tokens":null},"frontend/src/services/authService.js":{"content":"// services/authService.js - Updated with getMyProfile method\nimport api from './api';\n\nexport const authService = {\n  // Login user\n  login: async (credentials) => {\n    try {\n      const response = await api.post('/auth/login', credentials);\n      const { token, user } = response.data;\n      \n      // Store token and user data\n      localStorage.setItem('token', token);\n      localStorage.setItem('user', JSON.stringify(user));\n      \n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Login failed' };\n    }\n  },\n\n  // Register user (Admin only)\n  register: async (userData) => {\n    try {\n      const response = await api.post('/auth/register', userData);\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Registration failed' };\n    }\n  },\n\n  // Forgot password\n  forgotPassword: async (email) => {\n    try {\n      const response = await api.post('/auth/forgot-password', { email });\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Request failed' };\n    }\n  },\n\n  // Reset password\n  resetPassword: async (token, password) => {\n    try {\n      const response = await api.put(`/auth/reset-password/${token}`, { password });\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Password reset failed' };\n    }\n  },\n\n  // Get user profile (basic user info)\n  getProfile: async () => {\n    try {\n      const response = await api.get('/auth/profile');\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to get profile' };\n    }\n  },\n\n  // ADDED: Get current employee's detailed profile (for employees)\n  getMyProfile: async () => {\n    try {\n      const response = await api.get('/auth/me');\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to get employee profile' };\n    }\n  },\n\n  // Update profile\n  updateProfile: async (profileData) => {\n    try {\n      const response = await api.put('/auth/profile', profileData);\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Profile update failed' };\n    }\n  },\n\n  // Change password (Admin only)\n  changePassword: async (passwordData) => {\n    try {\n      const response = await api.put('/auth/change-password', passwordData);\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Password change failed' };\n    }\n  },\n\n  // Logout\n  logout: async () => {\n    try {\n      await api.post('/auth/logout');\n    } catch (error) {\n      // Even if API call fails, clear local storage\n    } finally {\n      localStorage.removeItem('token');\n      localStorage.removeItem('user');\n    }\n  },\n\n  // Get all users (Admin only)\n  getAllUsers: async (params = {}) => {\n    try {\n      const response = await api.get('/auth/users', { params });\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to get users' };\n    }\n  },\n\n  // Update user status (Admin only)\n  updateUserStatus: async (userId, isActive) => {\n    try {\n      const response = await api.put(`/auth/users/${userId}/status`, { isActive });\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Status update failed' };\n    }\n  },\n\n  // Initialize admin\n  initializeAdmin: async () => {\n    try {\n      const response = await api.post('/auth/init-admin');\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Admin initialization failed' };\n    }\n  },\n\n  // Get current user from localStorage\n  getCurrentUser: () => {\n    const user = localStorage.getItem('user');\n    return user ? JSON.parse(user) : null;\n  },\n\n  // Check if user is authenticated\n  isAuthenticated: () => {\n    return !!localStorage.getItem('token');\n  },\n\n  // Check if user is admin\n  isAdmin: () => {\n    const user = authService.getCurrentUser();\n    return user?.role === 'admin';\n  }\n};","path":null,"size_bytes":4102,"size_tokens":null},"frontend/src/pages/Employee/EmployeeAttendance.jsx":{"content":"import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport EmployeeLayout from '../../components/Employee/EmployeeLayout/EmployeeLayout';\nimport {\n  Clock,\n  MapPin,\n  CheckCircle,\n  XCircle,\n  AlertCircle,\n  Timer,\n  TrendingUp,\n  Camera,\n  ShieldCheck,\n  X,\n  Video\n} from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport { attendanceAPI, geolocationUtils, OFFICE_LOCATION } from '../../utils/attendanceAPI';\nimport { faceAPI, CameraHelper } from '../../utils/faceAPI';\n\nconst EmployeeAttendance = () => {\n  const [currentTime, setCurrentTime] = useState(new Date());\n  const [todayAttendance, setTodayAttendance] = useState(null);\n  const [attendanceHistory, setAttendanceHistory] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [locationLoading, setLocationLoading] = useState(false);\n  const [currentLocation, setCurrentLocation] = useState(null);\n  const [hasCheckedIn, setHasCheckedIn] = useState(false);\n  const [hasCheckedOut, setHasCheckedOut] = useState(false);\n  const [workingTime, setWorkingTime] = useState(null);\n  const [attendanceStats, setAttendanceStats] = useState(null);\n  const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));\n  const [realTimeWorkingTime, setRealTimeWorkingTime] = useState(0);\n\n  const [showFaceVerification, setShowFaceVerification] = useState(false);\n  const [cameraReady, setCameraReady] = useState(false);\n  const [isVerifying, setIsVerifying] = useState(false);\n  const [verificationStatus, setVerificationStatus] = useState(null);\n  const [verificationProgress, setVerificationProgress] = useState(0);\n  const [livenessMessage, setLivenessMessage] = useState('');\n  \n  const videoRef = useRef(null);\n  const localCameraHelper = useRef(null);\n\n  useEffect(() => {\n    const timer = setInterval(() => setCurrentTime(new Date()), 1000);\n    return () => clearInterval(timer);\n  }, []);\n\n  useEffect(() => {\n    fetchTodayAttendance();\n    fetchAttendanceHistory();\n  }, []);\n\n  useEffect(() => {\n    getCurrentLocation();\n  }, []);\n\n  useEffect(() => {\n    let interval;\n    if (hasCheckedIn && !hasCheckedOut && todayAttendance?.checkInTime) {\n      interval = setInterval(() => {\n        const checkInTime = new Date(todayAttendance.checkInTime);\n        const now = new Date();\n        const diffMs = now - checkInTime;\n        const minutes = Math.floor(diffMs / (1000 * 60));\n        setRealTimeWorkingTime(minutes);\n      }, 1000);\n    } else {\n      setRealTimeWorkingTime(0);\n    }\n    return () => clearInterval(interval);\n  }, [hasCheckedIn, hasCheckedOut, todayAttendance]);\n\n  const startCamera = async () => {\n    try {\n      if (!localCameraHelper.current) {\n        localCameraHelper.current = new CameraHelper();\n      }\n      \n      // Wait for video element to be ready\n      if (!videoRef.current) {\n        // Wait a bit for the video element to mount\n        await new Promise(resolve => setTimeout(resolve, 100));\n      }\n      \n      if (!videoRef.current) {\n        throw new Error('Video element not available. Please try again.');\n      }\n      \n      await localCameraHelper.current.startCamera(videoRef.current);\n      setCameraReady(true);\n    } catch (error) {\n      console.error('Camera error:', error);\n      toast.error(error.message || 'Failed to access camera');\n    }\n  };\n\n  const stopCamera = useCallback(() => {\n    if (localCameraHelper.current) {\n      localCameraHelper.current.stopCamera();\n    }\n    setCameraReady(false);\n  }, []);\n\n  const captureVideoFramesAndVerify = async () => {\n    if (!cameraReady || !videoRef.current) {\n      toast.error('Camera not ready. Please wait.');\n      return;\n    }\n\n    setIsVerifying(true);\n    setVerificationStatus(null);\n    setVerificationProgress(0);\n    setLivenessMessage('Capturing your photo...');\n\n    try {\n      setVerificationProgress(20);\n      setLivenessMessage('Please look at the camera...');\n\n      // Use single photo capture instead of video frames for faster verification\n      const imageBlob = await localCameraHelper.current.captureImageBlob(videoRef.current);\n\n      if (!imageBlob) {\n        toast.error('Failed to capture image. Please try again.');\n        setIsVerifying(false);\n        return;\n      }\n\n      setVerificationProgress(50);\n      setLivenessMessage('Verifying your face...');\n\n      // Use photo-based verification instead of video\n      const response = await faceAPI.verifyFaceAttendance(imageBlob, currentLocation);\n\n      setVerificationProgress(80);\n\n      if (response.data.success) {\n        setVerificationStatus('success');\n        setVerificationProgress(100);\n        setLivenessMessage('Verification successful!');\n        toast.success('Face verified! Marking attendance...');\n\n        const checkInResponse = await attendanceAPI.checkIn({\n          notes: 'Check-in via face verification',\n          faceVerified: true  // Flag to indicate face verification was successful\n        });\n\n        if (checkInResponse.data.success) {\n          toast.success('Attendance marked successfully!');\n          setTodayAttendance(checkInResponse.data.data);\n          setHasCheckedIn(true);\n          setHasCheckedOut(false);\n          fetchAttendanceHistory();\n\n          setTimeout(() => {\n            closeFaceVerification();\n          }, 1500);\n        } else {\n          toast.error(checkInResponse.data.message || 'Failed to mark attendance');\n        }\n      } else {\n        setVerificationStatus('failed');\n        setVerificationProgress(100);\n\n        const errorMessage = response.data.message || 'Face verification failed';\n        setLivenessMessage(errorMessage);\n        toast.error(errorMessage);\n      }\n    } catch (error) {\n      console.error('Face verification error:', error);\n      setVerificationStatus('failed');\n      setVerificationProgress(100);\n\n      // Handle timeout errors specifically\n      let errorMsg = 'Face verification failed';\n      if (error.code === 'ECONNABORTED' || error.message?.includes('timeout')) {\n        errorMsg = 'Verification timeout. Please try again.';\n      } else if (error.response?.data?.message) {\n        errorMsg = error.response.data.message;\n      } else if (error.message) {\n        errorMsg = error.message;\n      }\n\n      setLivenessMessage(errorMsg);\n      toast.error(errorMsg);\n    } finally {\n      setIsVerifying(false);\n    }\n  };\n\n  const openFaceVerification = () => {\n    if (!currentLocation) {\n      toast.error('Location is required. Please enable location services.');\n      getCurrentLocation();\n      return;\n    }\n\n    const locationCheck = geolocationUtils.isWithinOfficeRadius(\n      currentLocation.latitude,\n      currentLocation.longitude\n    );\n\n    if (!locationCheck.isWithin) {\n      toast.error(`You are not within office premises. Distance: ${locationCheck.distance}m`);\n      return;\n    }\n\n    setShowFaceVerification(true);\n    setVerificationStatus(null);\n    setVerificationProgress(0);\n    setLivenessMessage('');\n    startCamera();\n  };\n\n  const closeFaceVerification = () => {\n    stopCamera();\n    setShowFaceVerification(false);\n    setVerificationStatus(null);\n    setCameraReady(false);\n    setVerificationProgress(0);\n    setLivenessMessage('');\n  };\n\n  useEffect(() => {\n    return () => {\n      stopCamera();\n    };\n  }, [stopCamera]);\n\n  const getCurrentLocation = async () => {\n    try {\n      setLocationLoading(true);\n      const position = await geolocationUtils.getCurrentPosition();\n      const addressData = await geolocationUtils.getAddressFromCoords(position.latitude, position.longitude);\n      // Format address as string for display\n      const addressString = typeof addressData === 'object' ? addressData.address : addressData;\n      setCurrentLocation({ ...position, address: addressString });\n    } catch (error) {\n      console.error('Location error:', error);\n      toast.error(error.message);\n    } finally {\n      setLocationLoading(false);\n    }\n  };\n\n  const fetchTodayAttendance = async () => {\n    try {\n      const response = await attendanceAPI.getTodayAttendance();\n      if (response.data.success) {\n        const data = response.data;\n        setTodayAttendance(data.data);\n        setHasCheckedIn(data.hasCheckedIn);\n        setHasCheckedOut(data.hasCheckedOut);\n        setWorkingTime(data.workingTime);\n      }\n    } catch (error) {\n      console.error('Error fetching today attendance:', error);\n      if (error.response?.status !== 404) {\n        toast.error('Failed to fetch today\\'s attendance status');\n      }\n    }\n  };\n\n  const fetchAttendanceHistory = async () => {\n    try {\n      setLoading(true);\n      const startDate = new Date(selectedMonth + '-01');\n      const endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);\n      const response = await attendanceAPI.getAttendanceHistory({\n        startDate: startDate.toISOString(),\n        endDate: endDate.toISOString(),\n        limit: 31\n      });\n      if (response.data.success) {\n        setAttendanceHistory(response.data.data);\n        setAttendanceStats(response.data.summary);\n      }\n    } catch (error) {\n      console.error('Error fetching attendance history:', error);\n      toast.error('Failed to fetch attendance history');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleCheckOut = async () => {\n    if (!currentLocation) {\n      toast.error('Location is required for checkout.');\n      getCurrentLocation();\n      return;\n    }\n\n    try {\n      setLoading(true);\n      const locationCheck = geolocationUtils.isWithinOfficeRadius(\n        currentLocation.latitude,\n        currentLocation.longitude\n      );\n\n      if (!locationCheck.isWithin) {\n        toast.error(`You are not within office premises. Distance: ${locationCheck.distance}m`);\n        return;\n      }\n\n      const response = await attendanceAPI.checkOut({ notes: 'Check-out via web' });\n      if (response.data.success) {\n        toast.success('Checkout marked successfully!');\n        setTodayAttendance(response.data.data);\n        setHasCheckedOut(true);\n        setWorkingTime(response.data.workingTime);\n        fetchAttendanceHistory();\n        fetchTodayAttendance();\n      }\n    } catch (error) {\n      console.error('Checkout error:', error);\n      toast.error(error.response?.data?.message || 'Failed to mark checkout');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const getStatusColor = (status) => {\n    switch (status?.toLowerCase()) {\n      case 'present': return 'text-green-400 bg-green-400/20';\n      case 'late': return 'text-yellow-400 bg-yellow-400/20';\n      case 'half day': return 'text-orange-400 bg-orange-400/20';\n      case 'absent': return 'text-red-400 bg-red-400/20';\n      case 'work from home': return 'text-blue-400 bg-blue-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  const formatTime = (dateString) => {\n    if (!dateString) return '--:--';\n    return new Date(dateString).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });\n  };\n\n  const formatDate = (dateString) => {\n    if (!dateString) return '--';\n    return new Date(dateString).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });\n  };\n\n  const formatWorkingTime = (minutes) => {\n    if (!minutes || minutes === 0) return '0h 0m';\n    const hours = Math.floor(minutes / 60);\n    const mins = minutes % 60;\n    return `${hours}h ${mins}m`;\n  };\n\n  return (\n    <EmployeeLayout>\n      <div className=\"max-w-screen-lg mx-auto px-4 sm:px-6 lg:px-8 space-y-6\">\n        <div className=\"glass-morphism neon-border rounded-2xl p-4 md:p-6\">\n          <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4\">\n            <div>\n              <h1 className=\"text-2xl md:text-3xl font-bold text-white mb-2\">\n                My <span className=\"neon-text\">Attendance</span>\n              </h1>\n              <p className=\"text-secondary-400 text-sm md:text-base\">Track your daily attendance with video face verification</p>\n            </div>\n            <div className=\"text-left md:text-right\">\n              <p className=\"text-lg md:text-2xl font-bold text-white\">{currentTime.toLocaleTimeString()}</p>\n              <p className=\"text-secondary-400 text-xs md:text-sm\">\n                {currentTime.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n              </p>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <h2 className=\"text-xl font-bold text-white\">Today's Attendance</h2>\n            <div className=\"flex items-center space-x-2\">\n              <div className={`w-3 h-3 rounded-full ${hasCheckedIn ? 'bg-green-400' : 'bg-red-400'} animate-pulse`}></div>\n              <span className=\"text-sm text-secondary-400\">\n                {hasCheckedIn ? (hasCheckedOut ? 'Completed' : 'Checked In') : 'Not Marked'}\n              </span>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center space-x-3 p-3 bg-secondary-800/30 rounded-lg\">\n                <MapPin className={`w-5 h-5 ${currentLocation ? 'text-green-400' : 'text-red-400'}`} />\n                <div className=\"flex-1\">\n                  <p className=\"text-white text-sm font-medium\">\n                    {locationLoading ? 'Getting location...' : currentLocation ? 'Location Ready' : 'Location Required'}\n                  </p>\n                  <p className=\"text-xs text-secondary-400\">\n                    {currentLocation ? currentLocation.address : 'Enable location services'}\n                  </p>\n                </div>\n                {!currentLocation && (\n                  <button\n                    onClick={getCurrentLocation}\n                    className=\"px-3 py-1 bg-neon-pink/20 text-neon-pink rounded text-xs hover:bg-neon-pink/30 transition-colors\"\n                  >\n                    {locationLoading ? 'Getting...' : 'Get Location'}\n                  </button>\n                )}\n              </div>\n\n              <div className=\"space-y-3\">\n                {!hasCheckedIn ? (\n                  <button\n                    onClick={openFaceVerification}\n                    disabled={!currentLocation || loading}\n                    className=\"w-full px-4 md:px-6 py-3 md:py-4 bg-gradient-to-r from-neon-purple to-neon-pink text-white font-semibold rounded-lg hover-glow transition-all duration-300 flex items-center justify-center space-x-2 disabled:opacity-50 text-sm md:text-base min-h-[48px] touch-manipulation\"\n                  >\n                    <Video className=\"w-5 h-5 flex-shrink-0\" />\n                    <span>{loading ? 'Processing...' : 'Check In with Video Verification'}</span>\n                  </button>\n                ) : !hasCheckedOut ? (\n                  <button\n                    onClick={handleCheckOut}\n                    disabled={!currentLocation || loading}\n                    className=\"w-full px-4 md:px-6 py-3 md:py-4 bg-gradient-to-r from-red-500 to-red-600 text-white font-semibold rounded-lg hover-glow transition-all duration-300 flex items-center justify-center space-x-2 disabled:opacity-50 text-sm md:text-base min-h-[48px] touch-manipulation\"\n                  >\n                    <XCircle className=\"w-5 h-5 flex-shrink-0\" />\n                    <span>{loading ? 'Checking out...' : 'Check Out'}</span>\n                  </button>\n                ) : (\n                  <div className=\"w-full px-4 md:px-6 py-3 md:py-4 bg-gradient-to-r from-neon-purple/20 to-neon-pink/20 border border-neon-purple/30 text-white font-semibold rounded-lg flex items-center justify-center space-x-2 text-sm md:text-base min-h-[48px]\">\n                    <CheckCircle className=\"w-5 h-5 text-green-400 flex-shrink-0\" />\n                    <span>Attendance Completed</span>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg\">\n                <div className=\"flex items-start space-x-2\">\n                  <ShieldCheck className=\"w-4 h-4 text-blue-400 mt-0.5 flex-shrink-0\" />\n                  <div className=\"text-xs text-blue-300\">\n                    <p className=\"font-medium mb-1\">Video Verification with Liveness Detection</p>\n                    <p>Your live video is analyzed to ensure you are physically present. Static images and spoofing attempts are blocked.</p>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"p-3 bg-secondary-800/30 rounded-lg text-center\">\n                  <p className=\"text-secondary-400 text-xs\">Check In</p>\n                  <p className=\"text-white font-bold\">\n                    {todayAttendance ? formatTime(todayAttendance.checkInTime) : '--:--'}\n                  </p>\n                </div>\n                <div className=\"p-3 bg-secondary-800/30 rounded-lg text-center\">\n                  <p className=\"text-secondary-400 text-xs\">Check Out</p>\n                  <p className=\"text-white font-bold\">\n                    {todayAttendance ? formatTime(todayAttendance.checkOutTime) : '--:--'}\n                  </p>\n                </div>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"p-3 bg-secondary-800/30 rounded-lg text-center\">\n                  <p className=\"text-secondary-400 text-xs\">Working Time</p>\n                  <p className=\"text-neon-pink font-bold\">\n                    {hasCheckedIn && !hasCheckedOut ? formatWorkingTime(realTimeWorkingTime) : (workingTime ? workingTime.total : '00:00')}\n                  </p>\n                </div>\n                <div className=\"p-3 bg-secondary-800/30 rounded-lg text-center\">\n                  <p className=\"text-secondary-400 text-xs\">Status</p>\n                  <span className={`text-xs px-2 py-1 rounded-full ${getStatusColor(todayAttendance?.status)}`}>\n                    {todayAttendance?.status || 'Not Marked'}\n                  </span>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {attendanceStats && (\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 md:gap-6\">\n            <div className=\"glass-morphism neon-border rounded-2xl p-4 md:p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-secondary-400 text-xs md:text-sm\">Total Days</p>\n                  <p className=\"text-xl md:text-2xl font-bold text-white\">{attendanceStats.totalDays}</p>\n                </div>\n                <TrendingUp className=\"w-6 h-6 md:w-8 md:h-8 text-neon-pink flex-shrink-0\" />\n              </div>\n            </div>\n            <div className=\"glass-morphism neon-border rounded-2xl p-4 md:p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-secondary-400 text-xs md:text-sm\">Present Days</p>\n                  <p className=\"text-xl md:text-2xl font-bold text-green-400\">{attendanceStats.presentDays}</p>\n                </div>\n                <CheckCircle className=\"w-6 h-6 md:w-8 md:h-8 text-green-400 flex-shrink-0\" />\n              </div>\n            </div>\n            <div className=\"glass-morphism neon-border rounded-2xl p-4 md:p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-secondary-400 text-xs md:text-sm\">Late Days</p>\n                  <p className=\"text-xl md:text-2xl font-bold text-yellow-400\">{attendanceStats.lateDays}</p>\n                </div>\n                <AlertCircle className=\"w-6 h-6 md:w-8 md:h-8 text-yellow-400 flex-shrink-0\" />\n              </div>\n            </div>\n            <div className=\"glass-morphism neon-border rounded-2xl p-4 md:p-6\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-secondary-400 text-xs md:text-sm\">Half Days</p>\n                  <p className=\"text-xl md:text-2xl font-bold text-orange-400\">{attendanceStats.halfDays}</p>\n                </div>\n                <Timer className=\"w-6 h-6 md:w-8 md:h-8 text-orange-400 flex-shrink-0\" />\n              </div>\n            </div>\n          </div>\n        )}\n\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <h2 className=\"text-xl font-bold text-white\">Attendance History</h2>\n            <input\n              type=\"month\"\n              value={selectedMonth}\n              onChange={(e) => {\n                setSelectedMonth(e.target.value);\n                setTimeout(fetchAttendanceHistory, 100);\n              }}\n              className=\"bg-secondary-800 text-white border border-secondary-600 rounded-lg px-3 py-2 text-sm\"\n            />\n          </div>\n\n          {loading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-neon-pink\"></div>\n            </div>\n          ) : attendanceHistory.length === 0 ? (\n            <div className=\"text-center py-8 text-secondary-400\">\n              <Clock className=\"w-12 h-12 mx-auto mb-2 opacity-50\" />\n              <p>No attendance records for this month</p>\n            </div>\n          ) : (\n            <div className=\"space-y-3 max-h-96 overflow-y-auto\">\n              {attendanceHistory.map((record) => (\n                <div key={record._id} className=\"flex items-center justify-between p-3 bg-secondary-800/30 rounded-lg\">\n                  <div className=\"flex items-center space-x-3\">\n                    <div className=\"text-center\">\n                      <p className=\"text-white font-medium\">{formatDate(record.date)}</p>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center space-x-4 text-sm\">\n                    <div className=\"text-center\">\n                      <p className=\"text-secondary-400 text-xs\">In</p>\n                      <p className=\"text-white\">{formatTime(record.checkInTime)}</p>\n                    </div>\n                    <div className=\"text-center\">\n                      <p className=\"text-secondary-400 text-xs\">Out</p>\n                      <p className=\"text-white\">{formatTime(record.checkOutTime)}</p>\n                    </div>\n                    <span className={`text-xs px-2 py-1 rounded-full ${getStatusColor(record.status)}`}>\n                      {record.status || 'Present'}\n                    </span>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      </div>\n\n      {showFaceVerification && (\n        <div className=\"fixed inset-0 z-[9999] flex items-center justify-center p-4\">\n          {/* Enhanced backdrop with blur */}\n          <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" onClick={closeFaceVerification} />\n\n          {/* Modal content */}\n          <div className=\"relative glass-morphism neon-border rounded-2xl p-6 max-w-lg w-full shadow-2xl\">\n            <div className=\"flex items-center justify-between mb-4\">\n              <h3 className=\"text-xl font-bold text-white flex items-center space-x-2\">\n                <Camera className=\"w-5 h-5 text-neon-pink\" />\n                <span>Face Verification</span>\n              </h3>\n              <button\n                onClick={closeFaceVerification}\n                disabled={isVerifying}\n                className=\"p-2 hover:bg-secondary-700 rounded-lg transition-colors disabled:opacity-50\"\n              >\n                <X className=\"w-5 h-5 text-white\" />\n              </button>\n            </div>\n\n            <div className=\"relative bg-black rounded-lg overflow-hidden mb-4\">\n              <video\n                ref={videoRef}\n                autoPlay\n                muted\n                playsInline\n                className=\"w-full\"\n                style={{ transform: 'scaleX(-1)' }}\n              />\n              \n              {!cameraReady && (\n                <div className=\"absolute inset-0 flex items-center justify-center bg-black/50\">\n                  <div className=\"text-white text-center\">\n                    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-neon-pink mx-auto mb-2\"></div>\n                    <p>Starting camera...</p>\n                  </div>\n                </div>\n              )}\n\n              {isVerifying && (\n                <div className=\"absolute inset-0 flex items-center justify-center bg-black/70\">\n                  <div className=\"text-white text-center\">\n                    <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-neon-pink mx-auto mb-4\"></div>\n                    <p className=\"font-medium\">{livenessMessage}</p>\n                    <div className=\"w-48 h-2 bg-secondary-700 rounded-full mt-4 mx-auto\">\n                      <div \n                        className=\"h-full bg-neon-pink rounded-full transition-all duration-300\"\n                        style={{ width: `${verificationProgress}%` }}\n                      ></div>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {verificationStatus === 'success' && (\n                <div className=\"absolute inset-0 flex items-center justify-center bg-green-500/50\">\n                  <div className=\"text-center\">\n                    <CheckCircle className=\"w-16 h-16 text-white mx-auto\" />\n                    <p className=\"text-white font-bold mt-2\">Verified!</p>\n                  </div>\n                </div>\n              )}\n\n              {verificationStatus === 'failed' && (\n                <div className=\"absolute inset-0 flex items-center justify-center bg-red-500/50\">\n                  <div className=\"text-center\">\n                    <XCircle className=\"w-16 h-16 text-white mx-auto\" />\n                    <p className=\"text-white font-bold mt-2\">Verification Failed</p>\n                    <p className=\"text-white text-sm mt-1\">{livenessMessage}</p>\n                  </div>\n                </div>\n              )}\n            </div>\n\n            <div className=\"flex items-center space-x-2 mb-4 p-3 bg-secondary-800/50 rounded-lg\">\n              <div className={`w-3 h-3 rounded-full ${cameraReady ? 'bg-green-400' : 'bg-yellow-400'} animate-pulse`}></div>\n              <span className=\"text-sm text-secondary-400\">\n                {cameraReady ? 'Look at the camera and click verify' : 'Starting camera...'}\n              </span>\n            </div>\n\n            <button\n              onClick={captureVideoFramesAndVerify}\n              disabled={!cameraReady || isVerifying}\n              className=\"w-full px-6 py-4 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              {isVerifying ? (\n                <>\n                  <div className=\"animate-spin rounded-full h-5 w-5 border-b-2 border-white\"></div>\n                  <span>Verifying...</span>\n                </>\n              ) : (\n                <>\n                  <ShieldCheck className=\"w-5 h-5\" />\n                  <span>Verify & Check In</span>\n                </>\n              )}\n            </button>\n\n            <p className=\"text-xs text-secondary-400 mt-3 text-center\">\n              Your face will be verified against your registered profile\n            </p>\n          </div>\n        </div>\n      )}\n    </EmployeeLayout>\n  );\n};\n\nexport default EmployeeAttendance;\n","path":null,"size_bytes":28124,"size_tokens":null},"frontend/src/hooks/useFaceRegistration.js":{"content":"// hooks/useFaceRegistration.js - Custom React hook for face registration\n\nimport { useState, useEffect, useRef, useCallback } from 'react';\nimport { FaceRegistrationWorkflow, faceAPI } from '../utils/faceAPI';\nimport toast from 'react-hot-toast';\n\nexport const useFaceRegistration = () => {\n  const [isInitialized, setIsInitialized] = useState(false);\n  const [faceDetected, setFaceDetected] = useState(false);\n  const [isCapturing, setIsCapturing] = useState(false);\n  const [capturedFaceData, setCapturedFaceData] = useState(null);\n  const [error, setError] = useState(null);\n  \n  const videoRef = useRef();\n  const canvasRef = useRef();\n  const workflowRef = useRef();\n\n  // Initialize face registration workflow\n  const initialize = useCallback(async () => {\n    if (!videoRef.current || !canvasRef.current) {\n      setError('Video or canvas element not available');\n      return false;\n    }\n\n    try {\n      setError(null);\n      workflowRef.current = new FaceRegistrationWorkflow();\n      \n      await workflowRef.current.initialize(\n        videoRef.current,\n        canvasRef.current,\n        {\n          onFaceDetected: (detections) => {\n            setFaceDetected(true);\n          },\n          onNoFaceDetected: () => {\n            setFaceDetected(false);\n          }\n        }\n      );\n\n      setIsInitialized(true);\n      return true;\n    } catch (error) {\n      console.error('Face registration initialization error:', error);\n      setError(error.message);\n      toast.error(`Camera initialization failed: ${error.message}`);\n      return false;\n    }\n  }, []);\n\n  // Capture face data\n  const captureFace = useCallback(async () => {\n    if (!workflowRef.current || !videoRef.current) {\n      toast.error('Face registration not initialized');\n      return null;\n    }\n\n    if (!faceDetected) {\n      toast.error('No face detected. Please position your face in the frame.');\n      return null;\n    }\n\n    setIsCapturing(true);\n    setError(null);\n\n    try {\n      const faceData = await workflowRef.current.captureFaceData(videoRef.current);\n      setCapturedFaceData(faceData);\n      toast.success('Face captured successfully!');\n      return faceData;\n    } catch (error) {\n      console.error('Face capture error:', error);\n      setError(error.message);\n      toast.error(`Face capture failed: ${error.message}`);\n      return null;\n    } finally {\n      setIsCapturing(false);\n    }\n  }, [faceDetected]);\n\n  // Reset captured data and restart detection\n  const reset = useCallback(() => {\n    setCapturedFaceData(null);\n    setError(null);\n    if (workflowRef.current) {\n      // Restart detection if already initialized\n      initialize();\n    }\n  }, [initialize]);\n\n  // Cleanup on unmount\n  useEffect(() => {\n    return () => {\n      if (workflowRef.current) {\n        workflowRef.current.cleanup();\n      }\n    };\n  }, []);\n\n  return {\n    // Refs\n    videoRef,\n    canvasRef,\n    \n    // State\n    isInitialized,\n    faceDetected,\n    isCapturing,\n    capturedFaceData,\n    error,\n    \n    // Actions\n    initialize,\n    captureFace,\n    reset\n  };\n};\n\n// Enhanced Employee Form Component with Face Registration\n// Replace the simulation code in your component with this:\n\n/*\nUsage in your EmployeeManagement component:\n\nimport { useFaceRegistration } from '../hooks/useFaceRegistration';\n\n// Inside your component:\nconst {\n  videoRef,\n  canvasRef,\n  isInitialized,\n  faceDetected,\n  isCapturing,\n  capturedFaceData,\n  error,\n  initialize,\n  captureFace,\n  reset\n} = useFaceRegistration();\n\n// Replace the existing face detection setup with:\nuseEffect(() => {\n  if (showAddModal && currentStep === 2 && faceRegistrationEnabled) {\n    initialize();\n  }\n}, [showAddModal, currentStep, faceRegistrationEnabled, initialize]);\n\n// Replace the captureFaceData function with:\nconst handleCaptureFace = async () => {\n  const faceData = await captureFace();\n  if (faceData) {\n    setCapturedFaceData(faceData);\n  }\n};\n\n// Update your video/canvas JSX:\n<video\n  ref={videoRef}\n  width=\"640\"\n  height=\"480\"\n  className=\"w-full h-full object-cover\"\n  autoPlay\n  muted\n  playsInline\n/>\n<canvas\n  ref={canvasRef}\n  width=\"640\"\n  height=\"480\"\n  className=\"absolute top-0 left-0 w-full h-full\"\n/>\n\n// Replace the capture button onClick with:\nonClick={handleCaptureFace}\ndisabled={!faceDetected || isCapturing || !isInitialized}\n\n// Replace the status indicator with:\n<div className={`w-3 h-3 rounded-full ${faceDetected ? 'bg-green-400' : 'bg-red-400'} animate-pulse`}></div>\n<span className=\"text-sm text-secondary-400\">\n  {error ? `Error: ${error}` : \n   !isInitialized ? 'Initializing camera...' :\n   faceDetected ? 'Face detected - Ready to capture' : \n   'No face detected - Position face in frame'}\n</span>\n*/","path":null,"size_bytes":4725,"size_tokens":null},"backend/utils/shutdown.js":{"content":"// / utils/shutdown.js - NEW FILE\n// ==============================\n\nconst setupShutdown = () => {\n  const gracefulShutdown = (signal) => {\n    console.log(`\\n🛑 Received ${signal}. Graceful shutdown initiated...`);\n    \n    // Close server\n    if (global.server) {\n      global.server.close(() => {\n        console.log('✅ HTTP server closed');\n      });\n    }\n    \n    // Close database connection\n    if (require('mongoose').connection.readyState === 1) {\n      require('mongoose').connection.close(() => {\n        console.log('✅ MongoDB connection closed');\n        process.exit(0);\n      });\n    } else {\n      process.exit(0);\n    }\n  };\n\n  // Handle shutdown signals\n  process.on('SIGINT', () => gracefulShutdown('SIGINT'));\n  process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));\n\n  // Handle uncaught exceptions\n  process.on('uncaughtException', (err) => {\n    console.error('Uncaught Exception:', err);\n    process.exit(1);\n  });\n\n  process.on('unhandledRejection', (err) => {\n    console.error('Unhandled Rejection:', err);\n    process.exit(1);\n  });\n};\n\nexport default setupShutdown;","path":null,"size_bytes":1104,"size_tokens":null},"backend/middleware/rateLimiter.js":{"content":"","path":null,"size_bytes":0,"size_tokens":null},"backend/models/Notification.js":{"content":"import mongoose from 'mongoose';\n\nconst notificationSchema = new mongoose.Schema({\n  title: {\n    type: String,\n    required: true,\n    trim: true\n  },\n  message: {\n    type: String,\n    required: true,\n    trim: true\n  },\n  type: {\n    type: String,\n    enum: ['info', 'success', 'warning', 'error'],\n    default: 'info'\n  },\n  category: {\n    type: String,\n    enum: ['attendance', 'leave', 'task', 'employee', 'system'],\n    required: true\n  },\n  // Who should receive this notification\n  targetUsers: [{\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true\n  }],\n  // Who sent this notification\n  sender: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true\n  },\n  // Related entity (attendance, leave, task, etc.)\n  relatedEntity: {\n    model: {\n      type: String,\n      enum: ['Attendance', 'Leave', 'Task', 'Employee']\n    },\n    id: {\n      type: mongoose.Schema.Types.ObjectId,\n      refPath: 'relatedEntity.model'\n    }\n  },\n  // Notification status\n  isRead: {\n    type: Boolean,\n    default: false\n  },\n  readBy: [{\n    user: {\n      type: mongoose.Schema.Types.ObjectId,\n      ref: 'User'\n    },\n    readAt: {\n      type: Date,\n      default: Date.now\n    }\n  }],\n  // Priority level\n  priority: {\n    type: String,\n    enum: ['low', 'medium', 'high', 'urgent'],\n    default: 'medium'\n  },\n  // Additional data for specific notification types\n  metadata: {\n    type: mongoose.Schema.Types.Mixed,\n    default: {}\n  }\n}, {\n  timestamps: true\n});\n\n// Index for better query performance\nnotificationSchema.index({ targetUsers: 1, isRead: 1, createdAt: -1 });\nnotificationSchema.index({ category: 1, type: 1 });\nnotificationSchema.index({ 'relatedEntity.model': 1, 'relatedEntity.id': 1 });\n\n// Static method to create notification\nnotificationSchema.statics.createNotification = async function(data) {\n  try {\n    const notification = new this(data);\n    await notification.save();\n\n    // Populate sender info for immediate use\n    await notification.populate('sender', 'name email');\n\n    return notification;\n  } catch (error) {\n    console.error('Error creating notification:', error);\n    throw error;\n  }\n};\n\n// Instance method to mark as read\nnotificationSchema.methods.markAsRead = async function(userId) {\n  try {\n    if (!this.isRead) {\n      this.isRead = true;\n      this.readBy.push({\n        user: userId,\n        readAt: new Date()\n      });\n      await this.save();\n    }\n    return this;\n  } catch (error) {\n    console.error('Error marking notification as read:', error);\n    throw error;\n  }\n};\n\n// Static method to get user notifications\nnotificationSchema.statics.getUserNotifications = async function(userId, options = {}) {\n  try {\n    const { page = 1, limit = 20, category, isRead, type } = options;\n\n    const query = { targetUsers: userId };\n\n    if (category) query.category = category;\n    if (typeof isRead === 'boolean') query.isRead = isRead;\n    if (type) query.type = type;\n\n    const notifications = await this.find(query)\n      .populate('sender', 'name email')\n      .populate('relatedEntity.id')\n      .sort({ createdAt: -1 })\n      .limit(limit * 1)\n      .skip((page - 1) * limit);\n\n    const total = await this.countDocuments(query);\n\n    return {\n      notifications,\n      pagination: {\n        current: parseInt(page),\n        pages: Math.ceil(total / limit),\n        total,\n        hasNext: page < Math.ceil(total / limit),\n        hasPrev: page > 1\n      }\n    };\n  } catch (error) {\n    console.error('Error getting user notifications:', error);\n    throw error;\n  }\n};\n\n// Static method to get unread count\nnotificationSchema.statics.getUnreadCount = async function(userId) {\n  try {\n    return await this.countDocuments({\n      targetUsers: userId,\n      isRead: false\n    });\n  } catch (error) {\n    console.error('Error getting unread count:', error);\n    throw error;\n  }\n};\n\nconst Notification = mongoose.model('Notification', notificationSchema);\n\nexport default Notification;\n","path":null,"size_bytes":3993,"size_tokens":null},"frontend/src/pages/Admin/AdminFaceRegistration.jsx":{"content":"import React, { useState, useRef, useEffect, useCallback } from 'react';\nimport AdminLayout from '../../components/Admin/layout/AdminLayout';\nimport { Camera, Save, UserPlus, AlertCircle, CheckCircle, RotateCcw, ArrowLeft, ArrowRight } from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport { employeeAPI } from '../../utils/api';\nimport { faceAPI, CameraHelper } from '../../utils/faceAPI';\n\nconst ANGLES = ['front'];\nconst ANGLE_INSTRUCTIONS = {\n  front: 'Look straight ahead at the camera. Keep your head level and face the camera directly.'\n};\n\nconst AdminFaceRegistration = () => {\n  const videoRef = useRef();\n  const localCameraHelper = useRef(null);\n  const [employees, setEmployees] = useState([]);\n  const [selectedEmployee, setSelectedEmployee] = useState(null);\n  const [cameraReady, setCameraReady] = useState(false);\n  const [loading, setLoading] = useState(false);\n  \n  const [currentAngleIndex, setCurrentAngleIndex] = useState(0);\n  const [capturedImages, setCapturedImages] = useState({ front: null });\n  const [qualityFeedback, setQualityFeedback] = useState(null);\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\n  const [isRegistering, setIsRegistering] = useState(false);\n  const [registrationComplete, setRegistrationComplete] = useState(false);\n\n  const currentAngle = ANGLES[currentAngleIndex];\n\n  useEffect(() => {\n    fetchEmployees();\n    startVideo();\n\n    return () => {\n      if (localCameraHelper.current) {\n        localCameraHelper.current.stopCamera();\n      }\n    };\n  }, []);\n\n  const startVideo = async () => {\n    try {\n      setLoading(true);\n      if (!localCameraHelper.current) {\n        localCameraHelper.current = new CameraHelper();\n      }\n      await localCameraHelper.current.startCamera(videoRef.current);\n      setCameraReady(true);\n    } catch (error) {\n      console.error('Failed to start camera:', error);\n      toast.error(error.message || 'Failed to access camera');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const fetchEmployees = async () => {\n    try {\n      const response = await employeeAPI.getEmployees({ \n        limit: 100,\n        status: 'Active'\n      });\n\n      const employeesData = Array.isArray(response.data.data?.employees) \n        ? response.data.data.employees \n        : [];\n\n      setEmployees(employeesData);\n    } catch (error) {\n      console.error('Error fetching employees:', error);\n      toast.error('Failed to fetch employees');\n      setEmployees([]);\n    }\n  };\n\n  const analyzeCurrentFrame = useCallback(async () => {\n    if (!cameraReady || !videoRef.current || isAnalyzing) return;\n\n    setIsAnalyzing(true);\n    try {\n      const imageBase64 = localCameraHelper.current.captureImage(videoRef.current);\n      if (!imageBase64) return;\n\n      const response = await faceAPI.analyzeFrameBase64(imageBase64);\n      \n      if (response.data.success && response.data.face_detected) {\n        setQualityFeedback({\n          passed: response.data.quality.passed,\n          score: response.data.quality.score,\n          issues: response.data.quality.issues || [],\n          angle: response.data.angle_estimate\n        });\n      } else {\n        setQualityFeedback({\n          passed: false,\n          score: 0,\n          issues: [response.data.message || 'No face detected'],\n          angle: null\n        });\n      }\n    } catch (error) {\n      console.error('Frame analysis error:', error);\n    } finally {\n      setIsAnalyzing(false);\n    }\n  }, [cameraReady, isAnalyzing]);\n\n  useEffect(() => {\n    if (!selectedEmployee || !cameraReady) return;\n    \n    const interval = setInterval(analyzeCurrentFrame, 1000);\n    return () => clearInterval(interval);\n  }, [selectedEmployee, cameraReady, analyzeCurrentFrame]);\n\n  const captureCurrentAngle = async () => {\n    if (!cameraReady || !videoRef.current) {\n      toast.error('Camera not ready');\n      return;\n    }\n\n    const imageBase64 = localCameraHelper.current.captureImage(videoRef.current);\n    if (!imageBase64) {\n      toast.error('Failed to capture image');\n      return;\n    }\n\n    try {\n      const response = await faceAPI.analyzeFrameBase64(imageBase64);\n      \n      if (!response.data.success || !response.data.face_detected) {\n        toast.error(response.data.message || 'No face detected. Please try again.');\n        return;\n      }\n\n      if (!response.data.quality.passed && response.data.quality.score < 0.5) {\n        toast.error('Image quality too low. Please improve lighting and positioning.');\n        return;\n      }\n\n      setCapturedImages(prev => ({ ...prev, [currentAngle]: imageBase64 }));\n      toast.success(`${currentAngle.charAt(0).toUpperCase() + currentAngle.slice(1)} angle captured!`);\n\n      if (currentAngleIndex < ANGLES.length - 1) {\n        setCurrentAngleIndex(prev => prev + 1);\n      }\n    } catch (error) {\n      console.error('Capture error:', error);\n      toast.error('Failed to capture image');\n    }\n  };\n\n  const retakeCurrentAngle = () => {\n    setCapturedImages(prev => ({ ...prev, [currentAngle]: null }));\n    setQualityFeedback(null);\n  };\n\n  const handleRegisterFace = async () => {\n    if (!selectedEmployee) {\n      toast.error('Please select an employee');\n      return;\n    }\n\n    if (!capturedImages.front) {\n      toast.error('Please capture a front-facing image before registering');\n      return;\n    }\n\n    setIsRegistering(true);\n    try {\n      const response = await faceAPI.registerMultiAngleFace(\n        selectedEmployee._id,\n        capturedImages.front,\n        capturedImages.front,  // Use same front image for compatibility\n        capturedImages.front   // Use same front image for compatibility\n      );\n\n      if (response.data.success) {\n        toast.success('Face registered successfully!');\n        setRegistrationComplete(true);\n        fetchEmployees();\n      } else {\n        toast.error(response.data.message || 'Failed to register face');\n      }\n    } catch (error) {\n      console.error('Error registering face:', error);\n      const errorMsg = error.response?.data?.message || error.message || 'Failed to register face';\n      toast.error(errorMsg);\n    } finally {\n      setIsRegistering(false);\n    }\n  };\n\n  const resetRegistration = () => {\n    setSelectedEmployee(null);\n    setCapturedImages({ front: null });\n    setCurrentAngleIndex(0);\n    setQualityFeedback(null);\n    setRegistrationComplete(false);\n  };\n\n  const allAnglesCaptured = capturedImages.front;\n\n  return (\n    <AdminLayout>\n      <div className=\"max-w-screen-lg mx-auto px-4 sm:px-6 lg:px-8 space-y-6\">\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <h1 className=\"text-3xl font-bold text-white mb-2\">\n            Face <span className=\"neon-text\">Registration</span>\n          </h1>\n          <p className=\"text-secondary-400\">Register employee faces with high-accuracy front-facing capture for secure attendance verification</p>\n        </div>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n            <h2 className=\"text-lg sm:text-xl font-bold text-white mb-4\">Select Employee</h2>\n            <div className=\"space-y-3 max-h-64 sm:max-h-96 overflow-y-auto\">\n              {employees.length === 0 ? (\n                <p className=\"text-secondary-400 text-center py-4\">No active employees found</p>\n              ) : (\n                employees.map(employee => (\n                  <div\n                    key={employee._id}\n                    onClick={() => {\n                      if (!isRegistering) {\n                        setSelectedEmployee(employee);\n                        setCapturedImages({ front: null });\n                        setCurrentAngleIndex(0);\n                        setRegistrationComplete(false);\n                      }\n                    }}\n                    className={`p-3 rounded-lg cursor-pointer transition-colors ${\n                      selectedEmployee?._id === employee._id\n                        ? 'bg-neon-pink/20 border border-neon-pink'\n                        : 'bg-secondary-800/50 hover:bg-secondary-700'\n                    } ${isRegistering ? 'opacity-50 cursor-not-allowed' : ''}`}\n                  >\n                    <div className=\"flex items-center space-x-3\">\n                      <div className=\"w-10 h-10 bg-gradient-to-r from-neon-pink to-neon-purple rounded-lg flex items-center justify-center\">\n                        {employee.hasFaceRegistered ? (\n                          <CheckCircle className=\"w-5 h-5 text-green-400\" />\n                        ) : (\n                          <UserPlus className=\"w-5 h-5 text-white\" />\n                        )}\n                      </div>\n                      <div className=\"flex-1\">\n                        <p className=\"text-white font-medium\">\n                          {employee.personalInfo?.firstName} {employee.personalInfo?.lastName}\n                        </p>\n                        <p className=\"text-xs text-secondary-400\">\n                          ID: {employee.employeeId}\n                        </p>\n                        {employee.hasFaceRegistered && (\n                          <p className=\"text-xs text-green-400\">Face registered</p>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                ))\n              )}\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6 lg:col-span-2\">\n            <div className=\"flex items-center justify-between mb-4\">\n              <h2 className=\"text-xl font-bold text-white\">Front-Facing Face Capture</h2>\n              {selectedEmployee && (\n                <button\n                  onClick={resetRegistration}\n                  className=\"px-3 py-1 text-sm text-secondary-400 hover:text-white flex items-center space-x-1\"\n                >\n                  <RotateCcw className=\"w-4 h-4\" />\n                  <span>Reset</span>\n                </button>\n              )}\n            </div>\n\n            {!selectedEmployee ? (\n              <div className=\"text-center py-12 text-secondary-400\">\n                <UserPlus className=\"w-16 h-16 mx-auto mb-4 opacity-50\" />\n                <p>Select an employee to begin face registration</p>\n              </div>\n            ) : registrationComplete ? (\n              <div className=\"text-center py-12\">\n                <CheckCircle className=\"w-16 h-16 mx-auto mb-4 text-green-400\" />\n                <h3 className=\"text-xl font-bold text-white mb-2\">Registration Complete!</h3>\n                <p className=\"text-secondary-400 mb-4\">\n                  Face has been registered for {selectedEmployee.personalInfo?.firstName} {selectedEmployee.personalInfo?.lastName}\n                </p>\n                <button\n                  onClick={resetRegistration}\n                  className=\"px-6 py-2 bg-neon-pink/20 text-neon-pink rounded-lg hover:bg-neon-pink/30 transition-colors\"\n                >\n                  Register Another Employee\n                </button>\n              </div>\n            ) : (\n              <>\n                <div className=\"mb-4\">\n                  <div className=\"flex justify-center space-x-4 mb-4\">\n                    {ANGLES.map((angle, index) => (\n                      <div\n                        key={angle}\n                        onClick={() => setCurrentAngleIndex(index)}\n                        className={`flex flex-col items-center cursor-pointer ${\n                          index === currentAngleIndex ? 'opacity-100' : 'opacity-50'\n                        }`}\n                      >\n                        <div className={`w-12 h-12 rounded-full flex items-center justify-center border-2 ${\n                          capturedImages[angle]\n                            ? 'bg-green-500/20 border-green-500'\n                            : index === currentAngleIndex\n                            ? 'bg-neon-pink/20 border-neon-pink'\n                            : 'bg-secondary-800 border-secondary-600'\n                        }`}>\n                          {capturedImages[angle] ? (\n                            <CheckCircle className=\"w-6 h-6 text-green-400\" />\n                          ) : (\n                            <span className=\"text-white font-bold\">{index + 1}</span>\n                          )}\n                        </div>\n                        <span className=\"text-xs text-secondary-400 mt-1 capitalize\">{angle}</span>\n                      </div>\n                    ))}\n                  </div>\n                  \n                  <div className=\"text-center mb-4 p-3 bg-neon-pink/10 rounded-lg\">\n                    <p className=\"text-white font-medium\">Step {currentAngleIndex + 1} of 3: {ANGLE_INSTRUCTIONS[currentAngle]}</p>\n                  </div>\n                </div>\n\n                <div className=\"relative bg-black rounded-lg overflow-hidden\">\n                  {capturedImages[currentAngle] ? (\n                    <img \n                      src={capturedImages[currentAngle]} \n                      alt={`Captured ${currentAngle}`}\n                      className=\"w-full\"\n                      style={{ transform: 'scaleX(-1)' }}\n                    />\n                  ) : (\n                    <video\n                      ref={videoRef}\n                      width=\"640\"\n                      height=\"480\"\n                      className=\"w-full\"\n                      autoPlay\n                      muted\n                      playsInline\n                      style={{ objectFit: 'cover', transform: 'scaleX(-1)' }}\n                    />\n                  )}\n\n                  {loading && (\n                    <div className=\"absolute inset-0 bg-black/50 flex items-center justify-center\">\n                      <div className=\"text-white text-center\">\n                        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-neon-pink mx-auto mb-2\"></div>\n                        <p>Starting camera...</p>\n                      </div>\n                    </div>\n                  )}\n\n                  {qualityFeedback && !capturedImages[currentAngle] && (\n                    <div className={`absolute top-2 right-2 p-2 rounded-lg ${\n                      qualityFeedback.passed ? 'bg-green-500/80' : 'bg-red-500/80'\n                    }`}>\n                      <p className=\"text-white text-sm font-medium\">\n                        {qualityFeedback.passed ? 'Ready to capture' : 'Adjust position'}\n                      </p>\n                      {qualityFeedback.issues.length > 0 && (\n                        <p className=\"text-white text-xs\">{qualityFeedback.issues[0]}</p>\n                      )}\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"flex items-center justify-between mt-4\">\n                  <button\n                    onClick={() => setCurrentAngleIndex(prev => Math.max(0, prev - 1))}\n                    disabled={currentAngleIndex === 0}\n                    className=\"px-4 py-2 bg-secondary-700 text-white rounded-lg flex items-center space-x-2 disabled:opacity-50\"\n                  >\n                    <ArrowLeft className=\"w-4 h-4\" />\n                    <span>Previous</span>\n                  </button>\n\n                  {capturedImages[currentAngle] ? (\n                    <button\n                      onClick={retakeCurrentAngle}\n                      className=\"px-6 py-3 bg-yellow-600 text-white font-semibold rounded-lg flex items-center space-x-2\"\n                    >\n                      <RotateCcw className=\"w-5 h-5\" />\n                      <span>Retake</span>\n                    </button>\n                  ) : (\n                    <button\n                      onClick={captureCurrentAngle}\n                      disabled={!cameraReady}\n                      className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg flex items-center space-x-2 disabled:opacity-50\"\n                    >\n                      <Camera className=\"w-5 h-5\" />\n                      <span>Capture {currentAngle.charAt(0).toUpperCase() + currentAngle.slice(1)}</span>\n                    </button>\n                  )}\n\n                  <button\n                    onClick={() => setCurrentAngleIndex(prev => Math.min(ANGLES.length - 1, prev + 1))}\n                    disabled={currentAngleIndex === ANGLES.length - 1}\n                    className=\"px-4 py-2 bg-secondary-700 text-white rounded-lg flex items-center space-x-2 disabled:opacity-50\"\n                  >\n                    <span>Next</span>\n                    <ArrowRight className=\"w-4 h-4\" />\n                  </button>\n                </div>\n\n                {allAnglesCaptured && (\n                  <button\n                    onClick={handleRegisterFace}\n                    disabled={isRegistering}\n                    className=\"w-full mt-4 px-6 py-4 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-lg hover-glow transition-all duration-300 flex items-center justify-center space-x-2 disabled:opacity-50\"\n                  >\n                    <Save className=\"w-5 h-5\" />\n                    <span>{isRegistering ? 'Registering...' : 'Complete Registration'}</span>\n                  </button>\n                )}\n              </>\n            )}\n          </div>\n        </div>\n\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <h2 className=\"text-xl font-bold text-white mb-4\">Multi-Angle Registration Instructions</h2>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm\">\n            <div className=\"flex items-start space-x-2\">\n              <div className=\"w-8 h-8 bg-neon-pink/20 rounded-full flex items-center justify-center flex-shrink-0\">\n                <span className=\"text-neon-pink font-bold\">1</span>\n              </div>\n              <div>\n                <p className=\"text-white font-medium\">Front View</p>\n                <p className=\"text-secondary-400\">Look directly at the camera with a neutral expression</p>\n              </div>\n            </div>\n            <div className=\"flex items-start space-x-2\">\n              <div className=\"w-8 h-8 bg-neon-pink/20 rounded-full flex items-center justify-center flex-shrink-0\">\n                <span className=\"text-neon-pink font-bold\">2</span>\n              </div>\n              <div>\n                <p className=\"text-white font-medium\">Left Turn</p>\n                <p className=\"text-secondary-400\">Turn your head slightly to the left while facing camera</p>\n              </div>\n            </div>\n            <div className=\"flex items-start space-x-2\">\n              <div className=\"w-8 h-8 bg-neon-pink/20 rounded-full flex items-center justify-center flex-shrink-0\">\n                <span className=\"text-neon-pink font-bold\">3</span>\n              </div>\n              <div>\n                <p className=\"text-white font-medium\">Right Turn</p>\n                <p className=\"text-secondary-400\">Turn your head slightly to the right while facing camera</p>\n              </div>\n            </div>\n          </div>\n          <div className=\"mt-4 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg\">\n            <div className=\"flex items-start space-x-2\">\n              <AlertCircle className=\"w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5\" />\n              <p className=\"text-blue-300 text-sm\">\n                Multi-angle capture ensures more reliable face recognition during attendance verification, reducing false rejections and improving security.\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n    </AdminLayout>\n  );\n};\n\nexport default AdminFaceRegistration;\n","path":null,"size_bytes":19821,"size_tokens":null},"frontend/src/pages/Common/login.jsx":{"content":"import React, { useState } from 'react';\nimport { Link, useNavigate } from 'react-router-dom';\nimport { Eye, EyeOff, Mail, Lock, Building2, User } from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport axios from 'axios';\n\nconst Login = () => {\n  const [formData, setFormData] = useState({\n    email: '',\n    password: ''\n  });\n  const [showPassword, setShowPassword] = useState(false);\n  const [loading, setLoading] = useState(false);\n  const navigate = useNavigate();\n\n  const handleChange = (e) => {\n    setFormData({\n      ...formData,\n      [e.target.name]: e.target.value\n    });\n  };\n\n  const isEmployeeId = (value) => {\n    // Check if the input doesn't contain @ (not an email)\n    // and matches typical employee ID patterns (alphanumeric, possibly with hyphens/underscores)\n    return !value.includes('@') && /^[A-Z0-9_-]+$/i.test(value);\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setLoading(true);\n    \n    try {\n      const loginData = {\n        email: formData.email.trim(), // This field will be used for both email and employee ID\n        password: formData.password\n      };\n\n      console.log('Login attempt:', {\n        identifier: loginData.email,\n        isEmployeeId: isEmployeeId(loginData.email),\n        identifierType: isEmployeeId(loginData.email) ? 'Employee ID' : 'Email'\n      });\n\n      const response = await axios.post('/api/auth/login', loginData);\n\n      if (response.data.success) {\n        // Store authentication data - NEVER use localStorage in production Claude artifacts\n        // This is just for demonstration, use proper token management\n        const userData = {\n          token: response.data.token,\n          userRole: response.data.user.role,\n          userEmail: response.data.user.email,\n          userName: response.data.user.name,\n          userId: response.data.user.id,\n           userDepartment: response.data.user.department?.name || null,\n          departmentId: response.data.user.department?.id || null\n        };\n        \n        if (response.data.user.employeeId) {\n          userData.employeeId = response.data.user.employeeId;\n        }\n\n        // In a real application, store this securely\n        Object.keys(userData).forEach(key => {\n          sessionStorage.setItem(key, userData[key]);\n            localStorage.setItem(key, userData[key]);\n\n        });\n\n         console.log(\"User Department:\", userData.userDepartment);\n        console.log(\"Token stored:\", sessionStorage.getItem(\"token\"));\nconsole.log(\"Token in sessionStorage:\", sessionStorage.getItem(\"token\"));\nconsole.log(\"Token in localStorage:\", localStorage.getItem(\"token\"));\n\n        // Set axios default header for future requests\n        axios.defaults.headers.common['Authorization'] = `Bearer ${response.data.token}`;\n\n        // Show success message with user info\n        const loginType = isEmployeeId(formData.email) ? 'Employee ID' : 'Email';\n        toast.success(`Welcome back, ${response.data.user.name}! (${loginType} login)`);\n\n        // Role-based and department-based navigation\n        if (response.data.user.role === 'admin') {\n          navigate('/admin/dashboard');\n        } else if (response.data.user.role === 'employee') {\n          const department = response.data.user.department?.name?.toLowerCase();\n          \n          // Check if employee is from Sales department\n          if (department === 'sales' || department === 'sales department') {\n            navigate('/employee/leads'); // Navigate to Lead Management\n          } else {\n            navigate('/employee/dashboard'); // Default employee dashboard\n          }\n        } else {\n          toast.error('Unknown user role');\n        }\n      }\n    } catch (error) {\n      console.error('Login error:', error);\n      \n      if (error.response?.status === 401) {\n        if (error.response.data.message.includes('locked')) {\n          toast.error('Account temporarily locked due to too many failed attempts');\n        } else if (error.response.data.message.includes('deactivated')) {\n          toast.error('Account is deactivated. Please contact administrator.');\n        } else {\n          // Show specific error message for employee ID vs email\n          const loginType = isEmployeeId(formData.email) ? 'Employee ID' : 'Email';\n          toast.error(error.response.data.message || `Invalid ${loginType.toLowerCase()} or password`);\n        }\n      } else if (error.response?.status === 400) {\n        toast.error(error.response.data.message || 'Please check your input');\n      } else if (error.response?.status >= 500) {\n        toast.error('Server error. Please try again later.');\n      } else {\n        toast.error(error.response?.data?.message || 'Login failed. Please try again.');\n      }\n    }\n    \n    setLoading(false);\n  };\n\n  // Clear any existing auth data on component mount\n  React.useEffect(() => {\n    // Only clear if we're not already logged in\n    const token = sessionStorage.getItem('token');\n    if (!token) {\n      sessionStorage.clear();\n    }\n  }, []);\n\n  // Determine icon and placeholder based on input\n  const getInputIcon = () => {\n    if (!formData.email) return <Mail className=\"w-5 h-5 text-secondary-400\" />;\n    return isEmployeeId(formData.email) ? \n      <User className=\"w-5 h-5 text-secondary-400\" /> : \n      <Mail className=\"w-5 h-5 text-secondary-400\" />;\n  };\n\n  const getInputPlaceholder = () => {\n    if (!formData.email) return 'Enter your email or employee ID';\n    return isEmployeeId(formData.email) ? \n      'Enter your employee ID' : \n      'Enter your email address';\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-secondary-900 via-secondary-800 to-secondary-900\">\n      {/* Background Effects */}\n      <div className=\"absolute inset-0 overflow-hidden\">\n        <div className=\"absolute -top-10 -left-10 w-72 h-72 bg-neon-pink opacity-10 rounded-full blur-3xl animate-pulse\"></div>\n        <div className=\"absolute -bottom-10 -right-10 w-72 h-72 bg-neon-purple opacity-10 rounded-full blur-3xl animate-pulse delay-1000\"></div>\n      </div>\n\n      <div className=\"w-full max-w-md relative\">\n        {/* Company Logo */}\n        <div className=\"text-center mb-8\">\n          <div className=\"inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-neon-pink to-neon-purple rounded-2xl mb-4 animate-glow\">\n            <Building2 className=\"w-8 h-8 text-white\" />\n          </div>\n          <h1 className=\"text-3xl font-bold neon-text mb-2\">CompanyName</h1>\n          <p className=\"text-secondary-400\">Employee Management System</p>\n        </div>\n\n        {/* Login Form */}\n        <div className=\"glass-morphism neon-border p-8 rounded-2xl\">\n          <div className=\"text-center mb-6\">\n            <h2 className=\"text-2xl font-bold text-white mb-2\">Welcome Back</h2>\n            <p className=\"text-secondary-400\">Sign in to your account</p>\n          </div>\n\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            {/* Email/Employee ID Field */}\n            <div className=\"space-y-2\">\n              <label className=\"block text-sm font-medium text-secondary-300\">\n                Email or Employee ID\n              </label>\n              <div className=\"relative\">\n                <div className=\"absolute left-3 top-1/2 transform -translate-y-1/2\">\n                  {getInputIcon()}\n                </div>\n                <input\n                  type=\"text\"\n                  name=\"email\"\n                  value={formData.email}\n                  onChange={handleChange}\n                  className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 transition-all duration-300\"\n                  placeholder={getInputPlaceholder()}\n                  required\n                  disabled={loading}\n                />\n              </div>\n              {formData.email && (\n                <p className=\"text-xs text-secondary-400\">\n                  {isEmployeeId(formData.email) ? \n                    'Logging in with Employee ID' : \n                    'Logging in with Email Address'\n                  }\n                </p>\n              )}\n            </div>\n\n            {/* Password Field */}\n            <div className=\"space-y-2\">\n              <label className=\"block text-sm font-medium text-secondary-300\">\n                Password\n                {formData.email && isEmployeeId(formData.email) && (\n                  <span className=\"text-xs text-neon-pink ml-1\">(Use your Employee ID)</span>\n                )}\n                {formData.email && !isEmployeeId(formData.email) && formData.email.includes('@') && (\n                  <span className=\"text-xs text-neon-purple ml-1\">(Employees: Use Employee ID as password)</span>\n                )}\n              </label>\n              <div className=\"relative\">\n                <Lock className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                <input\n                  type={showPassword ? 'text' : 'password'}\n                  name=\"password\"\n                  value={formData.password}\n                  onChange={handleChange}\n                  className=\"w-full pl-10 pr-12 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 transition-all duration-300\"\n                  placeholder={\n                    isEmployeeId(formData.email) \n                      ? \"Enter your Employee ID\" \n                      : formData.email.includes('@') && !formData.email.includes('admin') \n                        ? \"Enter your Employee ID as password\" \n                        : \"Enter your password\"\n                  }\n                  required\n                  disabled={loading}\n                />\n                <button\n                  type=\"button\"\n                  onClick={() => setShowPassword(!showPassword)}\n                  className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-secondary-400 hover:text-white transition-colors\"\n                  disabled={loading}\n                >\n                  {showPassword ? <EyeOff className=\"w-5 h-5\" /> : <Eye className=\"w-5 h-5\" />}\n                </button>\n              </div>\n            </div>\n\n            {/* Forgot Password Link */}\n            <div className=\"text-right\">\n              <Link\n                to=\"/forgot-password\"\n                className=\"text-sm text-neon-pink hover:text-neon-purple transition-colors duration-300\"\n              >\n                Forgot your password?\n              </Link>\n            </div>\n\n            {/* Submit Button */}\n            <button\n              type=\"submit\"\n              disabled={loading}\n              className=\"w-full py-3 px-4 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed\"\n            >\n              {loading ? (\n                <span className=\"flex items-center justify-center\">\n                  <svg className=\"animate-spin -ml-1 mr-3 h-5 w-5 text-white\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\">\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                  </svg>\n                  Signing In...\n                </span>\n              ) : (\n                'Sign In'\n              )}\n            </button>\n          </form>\n\n          {/* Demo Credentials */}\n          <div className=\"mt-6 p-4 bg-secondary-800/30 rounded-lg border border-secondary-600\">\n            <p className=\"text-sm text-secondary-300 mb-3 font-medium\">Demo Credentials:</p>\n            <div className=\"space-y-2 text-xs text-secondary-400\">\n              <div className=\"p-2 bg-secondary-700/50 rounded\">\n                <p className=\"text-neon-pink font-semibold mb-1\">Admin Login:</p>\n                <p>Email: admin@gmail.com</p>\n                <p>Password: admin</p>\n              </div>\n              <div className=\"p-2 bg-secondary-700/50 rounded\">\n                <p className=\"text-neon-purple font-semibold mb-1\">Employee Login:</p>\n                <p>Email: employee@company.com</p>\n                <p>Password: EMP001 (Employee ID)</p>\n              </div>\n            </div>\n          </div>\n\n          {/* Login Help */}\n          <div className=\"mt-4 p-3 bg-blue-900/20 rounded-lg border border-blue-600/30\">\n            <p className=\"text-xs text-blue-300 text-center\">\n              💡 <strong>Employees:</strong> Login with your email address and use your Employee ID as password\n            </p>\n          </div>\n\n          {/* Additional Help */}\n          <div className=\"mt-3 p-3 bg-green-900/20 rounded-lg border border-green-600/30\">\n            <p className=\"text-xs text-green-300 text-center\">\n              🔐 <strong>Example:</strong> Email: john@company.com, Password: EMP001\n            </p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default Login;","path":null,"size_bytes":13427,"size_tokens":null},"backend/models/FaceData.js":{"content":"// models/FaceData.js\nimport mongoose from 'mongoose';\n\nconst faceDataSchema = new mongoose.Schema({\n  employee: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'Employee',\n    required: true,\n    unique: true\n  },\n  user: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true\n  },\n  faceDescriptor: {\n    type: [Number], // 128-dimensional face descriptor array (face-api.js)\n    required: true,\n    validate: {\n      validator: function(arr) {\n        return arr.length === 128; // face-api.js uses 128 dimensions\n      },\n      message: 'Face descriptor must be exactly 128 dimensions (face-api.js)'\n    }\n  },\n  landmarks: [{\n    x: { type: Number, required: true },\n    y: { type: Number, required: true }\n  }],\n  faceImageUrl: {\n    type: String,\n    required: true\n  },\n  confidence: {\n    type: Number,\n    min: 0,\n    max: 100,\n    default: 0\n  },\n  isActive: {\n    type: Boolean,\n    default: true\n  },\n  registrationDate: {\n    type: Date,\n    default: Date.now\n  },\n  lastUpdated: {\n    type: Date,\n    default: Date.now\n  },\n  metadata: {\n    captureDevice: String,\n    captureEnvironment: String,\n    processingVersion: {\n      type: String,\n      default: '1.0'\n    }\n  }\n}, {\n  timestamps: true\n});\n\n// Indexes for better query performance\n// Note: employee already has unique:true in schema, so no need for separate index\nfaceDataSchema.index({ user: 1 });\nfaceDataSchema.index({ isActive: 1 });\n\n// Methods\nfaceDataSchema.methods.updateDescriptor = function(newDescriptor, confidence = 0) {\n  this.faceDescriptor = newDescriptor;\n  this.confidence = confidence;\n  this.lastUpdated = new Date();\n  return this.save();\n};\n\nfaceDataSchema.methods.deactivate = function() {\n  this.isActive = false;\n  this.lastUpdated = new Date();\n  return this.save();\n};\n\n// Static methods\nfaceDataSchema.statics.findByEmployee = function(employeeId) {\n  return this.findOne({ employee: employeeId, isActive: true })\n    .populate('employee', 'personalInfo workInfo')\n    .populate('user', 'name email employeeId');\n};\n\nfaceDataSchema.statics.findByUser = function(userId) {\n  return this.findOne({ user: userId, isActive: true })\n    .populate('employee', 'personalInfo workInfo')\n    .populate('user', 'name email employeeId');\n};\n\nexport default mongoose.model('FaceData', faceDataSchema);","path":null,"size_bytes":2323,"size_tokens":null},"frontend/src/hooks/useAuth.js":{"content":"// hooks/useAuth.js\nimport { useState, useEffect, useCallback } from 'react';\nimport { authAPI } from '../utils/api';\nimport { authService } from '../services/authService';\n\nexport const useAuth = () => {\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [isAuthenticated, setIsAuthenticated] = useState(false);\n\n  // Initialize auth from localStorage (fast initial load)\n  const initAuthFromStorage = useCallback(() => {\n    try {\n      const token = localStorage.getItem('token');\n      const userData = localStorage.getItem('user');\n\n      if (token && userData) {\n        const parsedUser = JSON.parse(userData);\n        setUser(parsedUser);\n        setIsAuthenticated(true);\n        return true; // Successfully loaded from storage\n      }\n    } catch (error) {\n      console.error('Error parsing stored user data:', error);\n      // Clear corrupted data\n      localStorage.removeItem('token');\n      localStorage.removeItem('user');\n    }\n    return false; // No valid data in storage\n  }, []);\n\n  // Fetch user from API (for verification/updates)\n  const fetchUser = useCallback(async () => {\n    try {\n      setError(null);\n      \n      // Try your existing authService first, fallback to authAPI\n      let response;\n      try {\n        response = await authAPI.getCurrentUser();\n      } catch (apiError) {\n        // Fallback to authService if available\n        if (authService && authService.getCurrentUser) {\n          response = await authService.getCurrentUser();\n        } else {\n          throw apiError;\n        }\n      }\n      \n      if (response.data && response.data.success) {\n        const userData = response.data.data;\n        setUser(userData);\n        setIsAuthenticated(true);\n        \n        // Update localStorage with fresh data\n        localStorage.setItem('user', JSON.stringify(userData));\n        return userData;\n      }\n    } catch (error) {\n      console.error('Error fetching user:', error);\n      setError(error.message);\n      \n      // If API fails but we have stored data, keep using it\n      if (!user) {\n        setUser(null);\n        setIsAuthenticated(false);\n      }\n      \n      throw error;\n    }\n  }, []);\n\n  // Login function (from your existing code)\n  const login = useCallback(async (credentials) => {\n    try {\n      setLoading(true);\n      setError(null);\n      \n      // Use your existing authService\n      const response = await authService.login(credentials);\n      \n      setUser(response.user);\n      setIsAuthenticated(true);\n      \n      return response;\n    } catch (error) {\n      setError(error.message);\n      throw error;\n    } finally {\n      setLoading(false);\n    }\n  }, []);\n\n  // Enhanced logout function\n  const logout = useCallback(async () => {\n    try {\n      setLoading(true);\n      \n      // Try API logout first\n      try {\n        await authService.logout();\n      } catch (logoutError) {\n        console.error('Logout API error:', logoutError);\n        // Continue with local cleanup even if API fails\n      }\n    } catch (error) {\n      console.error('Logout error:', error);\n    } finally {\n      // Always clear local state and storage\n      setUser(null);\n      setIsAuthenticated(false);\n      setError(null);\n      \n      // Clear all possible auth-related storage keys\n      const keysToRemove = [\n        'token', 'authToken', 'user', 'userRole', 'role',\n        'userEmail', 'userName', 'userId', 'employeeId'\n      ];\n      \n      keysToRemove.forEach(key => {\n        localStorage.removeItem(key);\n        sessionStorage.removeItem(key);\n      });\n      \n      setLoading(false);\n      \n      // Redirect to login\n      window.location.href = '/login';\n    }\n  }, []);\n\n  // Update user function (from your existing code)\n  const updateUser = useCallback((userData) => {\n    setUser(userData);\n    setIsAuthenticated(true);\n    localStorage.setItem('user', JSON.stringify(userData));\n  }, []);\n\n  // Refresh user data\n  const refreshUser = useCallback(async () => {\n    if (!isAuthenticated) return;\n    \n    try {\n      await fetchUser();\n    } catch (error) {\n      // If refresh fails, user can still continue with cached data\n      console.warn('Failed to refresh user data:', error);\n    }\n  }, [fetchUser, isAuthenticated]);\n\n  // Initialize authentication\n  useEffect(() => {\n    const initAuth = async () => {\n      try {\n        setLoading(true);\n        \n        // First, try to load from storage (fast)\n        const hasStoredAuth = initAuthFromStorage();\n        \n        if (hasStoredAuth) {\n          // If we have stored data, set loading to false immediately\n          // but continue to verify with API in background\n          setLoading(false);\n          \n          // Verify/update with API in background\n          try {\n            await fetchUser();\n          } catch (error) {\n            // If API verification fails, we keep the stored data\n            console.warn('Background user verification failed:', error);\n          }\n        } else {\n          // No stored data, must fetch from API\n          try {\n            await fetchUser();\n          } catch (error) {\n            // No stored data and API failed\n            setUser(null);\n            setIsAuthenticated(false);\n          }\n        }\n      } catch (error) {\n        console.error('Auth initialization error:', error);\n        setError(error.message);\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    initAuth();\n  }, [initAuthFromStorage, fetchUser]);\n\n  return {\n    // State\n    user,\n    loading,\n    error,\n    isAuthenticated,\n    \n    // Computed properties\n    isAdmin: user?.role === 'admin',\n    isHR: user?.role === 'hr',\n    isManager: user?.role === 'manager',\n    isEmployee: user?.role === 'employee',\n    \n    // Actions\n    login,\n    logout,\n    updateUser,\n    refreshUser,\n    \n    // Utilities\n    hasPermission: (permission) => {\n      // You can implement permission checking logic here\n      return user?.permissions?.includes(permission) || false;\n    },\n    \n    getUserInitials: () => {\n      if (!user?.name) return 'U';\n      return user.name.split(' ')\n        .map(n => n[0])\n        .join('')\n        .toUpperCase()\n        .slice(0, 2);\n    }\n  };\n};","path":null,"size_bytes":6274,"size_tokens":null},"frontend/src/pages/Employee/EmployeeTasks.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport EmployeeLayout from '../../components/Employee/EmployeeLayout/EmployeeLayout';\nimport { \n  Target, \n  Clock, \n  CheckCircle, \n  Eye, \n  Play, \n  Pause,\n  Flag,\n  Calendar,\n  BarChart3,\n  MessageCircle,\n  Plus,\n  X,\n  Send,\n  AlertTriangle,\n  User,\n  FileText,\n  Filter,\n  Loader2   // Add loading spinner\n} from 'lucide-react';\nimport toast from 'react-hot-toast';\n\n// Import your API services\nimport { useTasks } from '../../hooks/useTasks';\nimport { useAuth } from '../../hooks/useAuth';\nimport { taskService } from '../../services/taskService';\n\nconst EmployeeTasks = () => {\n  const { user } = useAuth();\n  const {\n    tasks,\n    loading,\n    error,\n    stats,\n    filters,\n    setFilters,\n    updateProgress,\n    changeStatus,\n    addComment,\n    toggleSubtask,\n    fetchTasks\n  } = useTasks();\n\n  const [filteredTasks, setFilteredTasks] = useState([]);\n  const [statusFilter, setStatusFilter] = useState('');\n  const [priorityFilter, setPriorityFilter] = useState('');\n  const [selectedTask, setSelectedTask] = useState(null);\n  const [showTaskModal, setShowTaskModal] = useState(false);\n  const [newComment, setNewComment] = useState('');\n  const [timeTracking, setTimeTracking] = useState({});\n  const [modalLoading, setModalLoading] = useState(false);\n\n  // Filter tasks based on frontend filters\n  useEffect(() => {\n    let filtered = tasks.filter(task => {\n      const matchesStatus = !statusFilter || task.status === statusFilter;\n      const matchesPriority = !priorityFilter || task.priority === priorityFilter;\n      return matchesStatus && matchesPriority;\n    });\n\n    setFilteredTasks(filtered);\n  }, [tasks, statusFilter, priorityFilter]);\n\n  // Handle task status update\n  const updateTaskStatus = async (taskId, newStatus) => {\n    try {\n      await changeStatus(taskId, newStatus);\n    } catch (error) {\n      toast.error('Failed to update task status');\n    }\n  };\n\n  // Handle task progress update\n  const updateTaskProgress = async (taskId, progress) => {\n    try {\n      await updateProgress(taskId, Math.max(0, Math.min(100, progress)));\n    } catch (error) {\n      toast.error('Failed to update task progress');\n    }\n  };\n\n  // Handle subtask toggle\n  const handleToggleSubtask = async (taskId, subtaskId) => {\n    try {\n      await toggleSubtask(taskId, subtaskId);\n      \n      // Update progress based on subtasks for the selected task in modal\n      if (selectedTask && selectedTask._id === taskId) {\n        const updatedTask = tasks.find(t => t._id === taskId);\n        if (updatedTask && updatedTask.subtasks.length > 0) {\n          const completedSubtasks = updatedTask.subtasks.filter(st => st.completed).length;\n          const totalSubtasks = updatedTask.subtasks.length;\n          const newProgress = Math.round((completedSubtasks / totalSubtasks) * 100);\n          await updateTaskProgress(taskId, newProgress);\n        }\n      }\n    } catch (error) {\n      toast.error('Failed to update subtask');\n    }\n  };\n\n  // Handle add comment\n  const handleAddComment = async (taskId) => {\n    if (!newComment.trim()) return;\n\n    try {\n      await addComment(taskId, newComment.trim());\n      setNewComment('');\n    } catch (error) {\n      toast.error('Failed to add comment');\n    }\n  };\n\n  // Time tracking functions\n  const startTimer = (taskId) => {\n    setTimeTracking({\n      ...timeTracking,\n      [taskId]: {\n        isRunning: true,\n        startTime: Date.now(),\n        elapsed: timeTracking[taskId]?.elapsed || 0\n      }\n    });\n    toast.success('Timer started');\n  };\n\n  const stopTimer = (taskId) => {\n    const tracking = timeTracking[taskId];\n    if (tracking && tracking.isRunning) {\n      const newElapsed = tracking.elapsed + (Date.now() - tracking.startTime);\n      setTimeTracking({\n        ...timeTracking,\n        [taskId]: {\n          ...tracking,\n          isRunning: false,\n          elapsed: newElapsed\n        }\n      });\n\n      // Here you could also update actual hours in the backend\n      const hoursToAdd = newElapsed / (1000 * 60 * 60);\n      toast.success(`Timer stopped. Session: ${formatTime(newElapsed)}`);\n    }\n  };\n\n  // Get task details for modal\n  const handleViewTask = async (task) => {\n    try {\n      setModalLoading(true);\n      setSelectedTask(task);\n      setShowTaskModal(true);\n      \n      // Optionally fetch fresh task data\n      const response = await taskService.getTaskById(task._id);\n      setSelectedTask(response.task);\n    } catch (error) {\n      toast.error('Failed to load task details');\n    } finally {\n      setModalLoading(false);\n    }\n  };\n\n  // Utility functions\n  const getStatusColor = (status) => {\n    switch (status?.toLowerCase()) {\n      case 'not started': return 'text-gray-400 bg-gray-400/20';\n      case 'in progress': return 'text-blue-400 bg-blue-400/20';\n      case 'completed': return 'text-green-400 bg-green-400/20';\n      case 'review': return 'text-purple-400 bg-purple-400/20';\n      case 'on hold': return 'text-yellow-400 bg-yellow-400/20';\n      case 'cancelled': return 'text-red-400 bg-red-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  const getPriorityColor = (priority) => {\n    switch (priority?.toLowerCase()) {\n      case 'low': return 'text-green-400 bg-green-400/20';\n      case 'medium': return 'text-yellow-400 bg-yellow-400/20';\n      case 'high': return 'text-orange-400 bg-orange-400/20';\n      case 'critical': return 'text-red-400 bg-red-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  const isOverdue = (dueDate, status) => {\n    return status !== 'Completed' && new Date(dueDate) < new Date();\n  };\n\n  const formatTime = (ms) => {\n    const hours = Math.floor(ms / (1000 * 60 * 60));\n    const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));\n    return `${hours}h ${minutes}m`;\n  };\n\n  const formatDate = (dateString) => {\n    return new Date(dateString).toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric'\n    });\n  };\n\n  // Loading state\n  if (loading) {\n    return (\n      <EmployeeLayout>\n        <div className=\"flex items-center justify-center min-h-[400px]\">\n          <div className=\"flex flex-col items-center space-y-4\">\n            <Loader2 className=\"w-8 h-8 animate-spin text-neon-pink\" />\n            <p className=\"text-secondary-400\">Loading tasks...</p>\n          </div>\n        </div>\n      </EmployeeLayout>\n    );\n  }\n\n  // Error state\n  if (error) {\n    return (\n      <EmployeeLayout>\n        <div className=\"flex items-center justify-center min-h-[400px]\">\n          <div className=\"text-center\">\n            <AlertTriangle className=\"w-12 h-12 text-red-400 mx-auto mb-4\" />\n            <h3 className=\"text-lg font-medium text-white mb-2\">Error Loading Tasks</h3>\n            <p className=\"text-secondary-400 mb-4\">{error}</p>\n            <button\n              onClick={() => fetchTasks()}\n              className=\"px-4 py-2 bg-neon-pink/20 text-neon-pink rounded-lg hover:bg-neon-pink/30 transition-colors\"\n            >\n              Try Again\n            </button>\n          </div>\n        </div>\n      </EmployeeLayout>\n    );\n  }\n\n  const TaskDetailModal = () => (\n    <div className=\"fixed inset-0 z-[9999] flex items-center justify-center p-4\">\n      {/* Enhanced backdrop with blur */}\n      <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" onClick={() => setShowTaskModal(false)} />\n\n      {/* Modal content */}\n      <div className=\"relative glass-morphism neon-border rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto shadow-2xl\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h2 className=\"text-2xl font-bold text-white\">Task Details</h2>\n          <button \n            onClick={() => setShowTaskModal(false)}\n            className=\"text-secondary-400 hover:text-white\"\n          >\n            <X className=\"w-6 h-6\" />\n          </button>\n        </div>\n\n        {modalLoading ? (\n          <div className=\"flex items-center justify-center py-12\">\n            <Loader2 className=\"w-8 h-8 animate-spin text-neon-pink\" />\n          </div>\n        ) : selectedTask && (\n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n            {/* Main Task Info */}\n            <div className=\"lg:col-span-2 space-y-6\">\n              <div className=\"p-4 bg-secondary-800/30 rounded-lg\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <h3 className=\"text-xl font-bold text-white\">{selectedTask.title}</h3>\n                  <span className={`px-3 py-1 text-sm rounded-full ${getStatusColor(selectedTask.status)}`}>\n                    {selectedTask.status}\n                  </span>\n                </div>\n                <p className=\"text-secondary-400 mb-4\">{selectedTask.description}</p>\n                \n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                  <div>\n                    <span className=\"text-secondary-400\">Project:</span>\n                    <p className=\"text-white font-medium\">{selectedTask.project}</p>\n                  </div>\n                  <div>\n                    <span className=\"text-secondary-400\">Category:</span>\n                    <p className=\"text-white font-medium\">{selectedTask.category}</p>\n                  </div>\n                  <div>\n                    <span className=\"text-secondary-400\">Priority:</span>\n                    <span className={`px-2 py-1 text-xs rounded-full ${getPriorityColor(selectedTask.priority)}`}>\n                      {selectedTask.priority}\n                    </span>\n                  </div>\n                  <div>\n                    <span className=\"text-secondary-400\">Due Date:</span>\n                    <p className={`font-medium ${isOverdue(selectedTask.dueDate, selectedTask.status) ? 'text-red-400' : 'text-white'}`}>\n                      {formatDate(selectedTask.dueDate)}\n                    </p>\n                  </div>\n                  <div>\n                    <span className=\"text-secondary-400\">Assigned By:</span>\n                    <p className=\"text-white font-medium\">\n                      {selectedTask.assignedBy?.name || 'Admin'}\n                    </p>\n                  </div>\n                  <div>\n                    <span className=\"text-secondary-400\">Created:</span>\n                    <p className=\"text-white font-medium\">\n                      {formatDate(selectedTask.createdAt)}\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n              {/* Progress Section */}\n              <div className=\"p-4 bg-secondary-800/30 rounded-lg\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <h4 className=\"text-lg font-bold text-white\">Progress</h4>\n                  <span className=\"text-neon-pink font-bold\">{selectedTask.progress}%</span>\n                </div>\n                <div className=\"w-full bg-secondary-700 rounded-full h-3 mb-4\">\n                  <div \n                    className=\"bg-gradient-to-r from-neon-pink to-neon-purple h-3 rounded-full transition-all duration-300\"\n                    style={{ width: `${selectedTask.progress}%` }}\n                  ></div>\n                </div>\n                \n                <div className=\"flex items-center space-x-4\">\n                  <input\n                    type=\"range\"\n                    min=\"0\"\n                    max=\"100\"\n                    value={selectedTask.progress}\n                    onChange={(e) => updateTaskProgress(selectedTask._id, parseInt(e.target.value))}\n                    className=\"flex-1 accent-neon-pink\"\n                    disabled={selectedTask.status === 'Completed'}\n                  />\n                  <div className=\"flex space-x-2\">\n                    {selectedTask.status !== 'Completed' && (\n                      <>\n                        <button\n                          onClick={() => updateTaskStatus(selectedTask._id, selectedTask.status === 'In Progress' ? 'Not Started' : 'In Progress')}\n                          className=\"px-3 py-1 bg-blue-500/20 text-blue-400 rounded text-sm hover:bg-blue-500/30 transition-colors\"\n                        >\n                          {selectedTask.status === 'In Progress' ? 'Pause' : 'Start'}\n                        </button>\n                        <button\n                          onClick={() => updateTaskProgress(selectedTask._id, 100)}\n                          className=\"px-3 py-1 bg-green-500/20 text-green-400 rounded text-sm hover:bg-green-500/30 transition-colors\"\n                        >\n                          Complete\n                        </button>\n                      </>\n                    )}\n                  </div>\n                </div>\n              </div>\n\n              {/* Subtasks */}\n              {selectedTask.subtasks && selectedTask.subtasks.length > 0 && (\n                <div className=\"p-4 bg-secondary-800/30 rounded-lg\">\n                  <h4 className=\"text-lg font-bold text-white mb-4\">\n                    Subtasks ({selectedTask.subtasks.filter(st => st.completed).length}/{selectedTask.subtasks.length})\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {selectedTask.subtasks.map((subtask) => (\n                      <div key={subtask._id} className=\"flex items-center space-x-3 p-3 bg-secondary-700/30 rounded-lg\">\n                        <input\n                          type=\"checkbox\"\n                          checked={subtask.completed}\n                          onChange={() => handleToggleSubtask(selectedTask._id, subtask._id)}\n                          className=\"w-4 h-4 rounded border-secondary-600 bg-secondary-800 text-neon-pink focus:ring-neon-pink\"\n                        />\n                        <span className={`flex-1 ${subtask.completed ? 'text-secondary-400 line-through' : 'text-white'}`}>\n                          {subtask.title}\n                        </span>\n                        {subtask.completedAt && (\n                          <span className=\"text-xs text-secondary-400\">\n                            {formatDate(subtask.completedAt)}\n                          </span>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Comments Section */}\n              <div className=\"p-4 bg-secondary-800/30 rounded-lg\">\n                <h4 className=\"text-lg font-bold text-white mb-4\">\n                  Comments ({selectedTask.comments?.length || 0})\n                </h4>\n                \n                <div className=\"space-y-3 max-h-60 overflow-y-auto mb-4\">\n                  {selectedTask.comments && selectedTask.comments.length > 0 ? (\n                    selectedTask.comments.map((comment) => (\n                      <div key={comment._id} className=\"p-3 bg-secondary-700/30 rounded-lg\">\n                        <div className=\"flex items-center space-x-2 mb-2\">\n                          <div className=\"w-6 h-6 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                            <User className=\"w-3 h-3 text-white\" />\n                          </div>\n                          <span className=\"text-white font-medium text-sm\">\n                            {comment.user?.name || 'Unknown User'}\n                          </span>\n                          <span className=\"text-secondary-400 text-xs\">\n                            {formatDate(comment.createdAt)}\n                          </span>\n                        </div>\n                        <p className=\"text-secondary-300 text-sm\">{comment.text}</p>\n                      </div>\n                    ))\n                  ) : (\n                    <p className=\"text-secondary-400 text-sm\">No comments yet</p>\n                  )}\n                </div>\n\n                {/* Add Comment */}\n                <div className=\"flex space-x-3\">\n                  <input\n                    type=\"text\"\n                    value={newComment}\n                    onChange={(e) => setNewComment(e.target.value)}\n                    placeholder=\"Add a comment...\"\n                    className=\"flex-1 px-3 py-2 bg-secondary-700 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:ring-1 focus:ring-neon-pink/20\"\n                    onKeyPress={(e) => e.key === 'Enter' && handleAddComment(selectedTask._id)}\n                  />\n                  <button\n                    onClick={() => handleAddComment(selectedTask._id)}\n                    disabled={!newComment.trim()}\n                    className=\"px-3 py-2 bg-neon-pink/20 text-neon-pink rounded-lg hover:bg-neon-pink/30 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n                  >\n                    <Send className=\"w-4 h-4\" />\n                  </button>\n                </div>\n              </div>\n            </div>\n\n            {/* Side Info */}\n            <div className=\"space-y-6\">\n              {/* Time Tracking */}\n              <div className=\"p-4 bg-secondary-800/30 rounded-lg\">\n                <h4 className=\"text-lg font-bold text-white mb-4\">Time Tracking</h4>\n                <div className=\"space-y-3\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-secondary-400\">Estimated</span>\n                    <span className=\"text-white\">{selectedTask.estimatedHours || 0}h</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-secondary-400\">Actual</span>\n                    <span className=\"text-white\">{Math.round(selectedTask.actualHours || 0)}h</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-secondary-400\">Session</span>\n                    <span className=\"text-neon-pink\">\n                      {timeTracking[selectedTask._id] ? formatTime(timeTracking[selectedTask._id].elapsed) : '0h 0m'}\n                    </span>\n                  </div>\n                </div>\n\n                <div className=\"mt-4\">\n                  {timeTracking[selectedTask._id]?.isRunning ? (\n                    <button\n                      onClick={() => stopTimer(selectedTask._id)}\n                      className=\"w-full px-4 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition-colors flex items-center justify-center\"\n                    >\n                      <Pause className=\"w-4 h-4 mr-2\" />\n                      Stop Timer\n                    </button>\n                  ) : (\n                    <button\n                      onClick={() => startTimer(selectedTask._id)}\n                      className=\"w-full px-4 py-2 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30 transition-colors flex items-center justify-center\"\n                      disabled={selectedTask.status === 'Completed'}\n                    >\n                      <Play className=\"w-4 h-4 mr-2\" />\n                      Start Timer\n                    </button>\n                  )}\n                </div>\n              </div>\n\n              {/* Task Actions */}\n              <div className=\"p-4 bg-secondary-800/30 rounded-lg\">\n                <h4 className=\"text-lg font-bold text-white mb-4\">Actions</h4>\n                <div className=\"space-y-3\">\n                  {selectedTask.status !== 'Completed' && (\n                    <>\n                      <button\n                        onClick={() => updateTaskStatus(selectedTask._id, 'In Progress')}\n                        disabled={selectedTask.status === 'In Progress'}\n                        className=\"w-full px-4 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n                      >\n                        {selectedTask.status === 'In Progress' ? 'Already In Progress' : 'Start Task'}\n                      </button>\n                      <button\n                        onClick={() => updateTaskStatus(selectedTask._id, 'On Hold')}\n                        disabled={selectedTask.status === 'On Hold'}\n                        className=\"w-full px-4 py-2 bg-yellow-500/20 text-yellow-400 rounded-lg hover:bg-yellow-500/30 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n                      >\n                        {selectedTask.status === 'On Hold' ? 'Already On Hold' : 'Put On Hold'}\n                      </button>\n                      <button\n                        onClick={() => updateTaskStatus(selectedTask._id, 'Review')}\n                        disabled={selectedTask.status === 'Review'}\n                        className=\"w-full px-4 py-2 bg-purple-500/20 text-purple-400 rounded-lg hover:bg-purple-500/30 transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n                      >\n                        {selectedTask.status === 'Review' ? 'In Review' : 'Submit for Review'}\n                      </button>\n                      <button\n                        onClick={() => updateTaskStatus(selectedTask._id, 'Completed')}\n                        className=\"w-full px-4 py-2 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30 transition-colors\"\n                      >\n                        Mark Complete\n                      </button>\n                    </>\n                  )}\n                  {selectedTask.status === 'Completed' && (\n                    <div className=\"text-center py-4\">\n                      <CheckCircle className=\"w-12 h-12 text-green-400 mx-auto mb-2\" />\n                      <p className=\"text-green-400 font-medium\">Task Completed!</p>\n                      <p className=\"text-secondary-400 text-sm mt-1\">\n                        Completed on {formatDate(selectedTask.completedDate || selectedTask.updatedAt)}\n                      </p>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n\n  return (\n    <EmployeeLayout>\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-4\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-white\">My Tasks</h1>\n            <p className=\"text-secondary-400\">Track and manage your assigned tasks</p>\n          </div>\n          <div className=\"text-right\">\n            <p className=\"text-lg font-semibold text-white\">\n              {new Date().toLocaleDateString('en-US', { \n                weekday: 'long', \n                year: 'numeric', \n                month: 'long', \n                day: 'numeric' \n              })}\n            </p>\n            <p className=\"text-secondary-400\">Welcome back, {user?.name}</p>\n          </div>\n        </div>\n\n        {/* Stats Cards */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-2xl font-bold text-white\">{stats?.total || 0}</h3>\n                <p className=\"text-secondary-400\">Total Tasks</p>\n              </div>\n              <div className=\"w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center\">\n                <Target className=\"w-6 h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-2xl font-bold text-blue-400\">{stats?.inProgress || 0}</h3>\n                <p className=\"text-secondary-400\">In Progress</p>\n              </div>\n              <div className=\"w-12 h-12 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center\">\n                <Clock className=\"w-6 h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-2xl font-bold text-green-400\">{stats?.completed || 0}</h3>\n                <p className=\"text-secondary-400\">Completed</p>\n              </div>\n              <div className=\"w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center\">\n                <CheckCircle className=\"w-6 h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-2xl font-bold text-red-400\">{stats?.overdue || 0}</h3>\n                <p className=\"text-secondary-400\">Overdue</p>\n              </div>\n              <div className=\"w-12 h-12 bg-gradient-to-r from-red-500 to-red-600 rounded-lg flex items-center justify-center\">\n                <AlertTriangle className=\"w-6 h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Filters */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <div className=\"flex flex-col md:flex-row gap-4\">\n            <div className=\"relative\">\n              <Filter className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n              <select\n                value={statusFilter}\n                onChange={(e) => setStatusFilter(e.target.value)}\n                className=\"pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n              >\n                <option value=\"\">All Status</option>\n                <option value=\"Not Started\">Not Started</option>\n                <option value=\"In Progress\">In Progress</option>\n                <option value=\"Review\">Review</option>\n                <option value=\"Completed\">Completed</option>\n                <option value=\"On Hold\">On Hold</option>\n              </select>\n            </div>\n\n            <div className=\"relative\">\n              <Flag className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n              <select\n                value={priorityFilter}\n                onChange={(e) => setPriorityFilter(e.target.value)}\n                className=\"pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n              >\n                <option value=\"\">All Priority</option>\n                <option value=\"Low\">Low</option>\n                <option value=\"Medium\">Medium</option>\n                <option value=\"High\">High</option>\n                <option value=\"Critical\">Critical</option>\n              </select>\n            </div>\n\n            <button\n              onClick={() => {\n                setStatusFilter('');\n                setPriorityFilter('');\n              }}\n              className=\"px-4 py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700/50 transition-colors\"\n            >\n              Clear Filters\n            </button>\n\n            <button\n              onClick={() => fetchTasks()}\n              className=\"px-4 py-3 bg-neon-pink/20 text-neon-pink rounded-lg hover:bg-neon-pink/30 transition-colors flex items-center\"\n            >\n              <BarChart3 className=\"w-4 h-4 mr-2\" />\n              Refresh\n            </button>\n          </div>\n        </div>\n\n        {/* Tasks Grid */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6\">\n          {filteredTasks.map((task) => (\n            <div key={task._id} className=\"glass-morphism neon-border rounded-2xl p-6 hover-glow\">\n              <div className=\"flex items-start justify-between mb-4\">\n                <div className=\"flex-1\">\n                  <h3 className=\"text-lg font-bold text-white mb-2\">{task.title}</h3>\n                  <p className=\"text-secondary-400 text-sm mb-3 line-clamp-2\">{task.description}</p>\n                </div>\n                <span className={`px-2 py-1 text-xs rounded-full ${getPriorityColor(task.priority)}`}>\n                  {task.priority}\n                </span>\n              </div>\n\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between text-sm\">\n                  <span className=\"text-secondary-400\">Project</span>\n                  <span className=\"text-white font-medium\">{task.project}</span>\n                </div>\n\n                <div className=\"flex items-center justify-between text-sm\">\n                  <span className=\"text-secondary-400\">Due Date</span>\n                  <span className={`font-medium ${isOverdue(task.dueDate, task.status) ? 'text-red-400' : 'text-white'}`}>\n                    {formatDate(task.dueDate)}\n                  </span>\n                </div>\n\n                <div className=\"flex items-center justify-between text-sm\">\n                  <span className=\"text-secondary-400\">Status</span>\n                  <span className={`px-2 py-1 text-xs rounded-full ${getStatusColor(task.status)}`}>\n                    {task.status}\n                  </span>\n                </div>\n\n                <div>\n                  <div className=\"flex justify-between items-center mb-2\">\n                    <span className=\"text-sm text-secondary-400\">Progress</span>\n                    <span className=\"text-sm text-neon-pink font-medium\">{task.progress}%</span>\n                  </div>\n                  <div className=\"w-full bg-secondary-700 rounded-full h-2\">\n                    <div \n                      className=\"bg-gradient-to-r from-neon-pink to-neon-purple h-2 rounded-full transition-all duration-300\"\n                      style={{ width: `${task.progress}%` }}\n                    ></div>\n                  </div>\n                </div>\n\n                {isOverdue(task.dueDate, task.status) && (\n                  <div className=\"flex items-center text-red-400 text-sm\">\n                    <AlertTriangle className=\"w-4 h-4 mr-2\" />\n                    Overdue\n                  </div>\n                )}\n\n                <div className=\"flex items-center justify-between pt-4\">\n                  <button\n                    onClick={() => handleViewTask(task)}\n                    className=\"px-4 py-2 bg-secondary-700 text-white rounded-lg hover:bg-secondary-600 transition-colors flex items-center\"\n                  >\n                    <Eye className=\"w-4 h-4 mr-2\" />\n                    View Details\n                  </button>\n\n                  {task.status !== 'Completed' && (\n                    <div className=\"flex space-x-2\">\n                      {timeTracking[task._id]?.isRunning ? (\n                        <button\n                          onClick={() => stopTimer(task._id)}\n                          className=\"p-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition-colors\"\n                          title=\"Stop Timer\"\n                        >\n                          <Pause className=\"w-4 h-4\" />\n                        </button>\n                      ) : (\n                        <button\n                          onClick={() => startTimer(task._id)}\n                          className=\"p-2 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30 transition-colors\"\n                          title=\"Start Timer\"\n                        >\n                          <Play className=\"w-4 h-4\" />\n                        </button>\n                      )}\n                      \n                      <button\n                        onClick={() => updateTaskProgress(task._id, 100)}\n                        className=\"p-2 bg-neon-pink/20 text-neon-pink rounded-lg hover:bg-neon-pink/30 transition-colors\"\n                        title=\"Mark Complete\"\n                      >\n                        <CheckCircle className=\"w-4 h-4\" />\n                      </button>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n\n        {filteredTasks.length === 0 && (\n          <div className=\"glass-morphism neon-border rounded-2xl p-12 text-center\">\n            <Target className=\"w-12 h-12 text-secondary-600 mx-auto mb-4\" />\n            <h3 className=\"text-lg font-medium text-secondary-400 mb-2\">No tasks found</h3>\n            <p className=\"text-secondary-500\">\n              {statusFilter || priorityFilter\n                ? 'Try adjusting your filters to see more tasks'\n                : 'You have no assigned tasks at the moment'}\n            </p>\n          </div>\n        )}\n      </div>\n\n      {/* Task Detail Modal */}\n      {showTaskModal && <TaskDetailModal />}\n    </EmployeeLayout>\n  );\n};\n\nexport default EmployeeTasks;","path":null,"size_bytes":33334,"size_tokens":null},"backend/routes/employeeRoutes.js":{"content":"// routes/employeeRoutes.js\nimport express from 'express';\nimport { body } from 'express-validator';\nimport {\n  createEmployee,\n  getEmployees,\n  getEmployeeById,\n  getEmployeesByDepartment,\n  updateEmployee,\n  deleteEmployee,\n  getEmployeeStats,\n  getEmployeeBankingDetails\n\n} from '../controllers/employeeController.js';\nimport {\n  saveEmployeeFace,\n  getEmployeeFace,\n  deleteEmployeeFace,\n  verifyFaceAttendance,\n  getEmployeesWithoutFace,\n  upload\n} from '../controllers/faceDetectionController.js';\nimport { protect, adminOnly } from '../middleware/authMiddleware.js';\n\nconst router = express.Router();\n\n// Validation middleware for employee creation\nconst employeeValidation = [\n  body('personalInfo.firstName')\n    .trim()\n    .isLength({ min: 2, max: 30 })\n    .withMessage('First name must be between 2 and 30 characters'),\n  body('personalInfo.lastName')\n    .trim()\n    .isLength({ min: 2, max: 30 })\n    .withMessage('Last name must be between 2 and 30 characters'),\n  body('contactInfo.personalEmail')\n    .isEmail()\n    .normalizeEmail()\n    .withMessage('Please provide a valid email'),\n  body('contactInfo.phone')\n    .matches(/^\\+?[\\d\\s\\-\\(\\)]+$/)\n    .withMessage('Please provide a valid phone number'),\n  body('workInfo.position')\n    .trim()\n    .isLength({ min: 2, max: 50 })\n    .withMessage('Position must be between 2 and 50 characters'),\n  body('workInfo.department')\n    .isIn(['Engineering', 'Product', 'Design', 'HR', 'Marketing', 'Sales', 'Finance', 'Operations'])\n    .withMessage('Please select a valid department'),\n  body('salaryInfo.basicSalary')\n    .isNumeric()\n    .isFloat({ min: 0 })\n    .withMessage('Basic salary must be a positive number')\n];\n\n// Apply auth middleware to all routes\nrouter.use(protect);\n\n// Routes\nrouter.post('/', adminOnly, employeeValidation, createEmployee);\nrouter.get('/', getEmployees);\nrouter.get('/stats', adminOnly, getEmployeeStats);\nrouter.get('/:id/banking', adminOnly, getEmployeeBankingDetails);\nrouter.get('/me', getEmployeeById); // Special route for current user\nrouter.get('/department/:department', getEmployeesByDepartment);\nrouter.get('/:id', getEmployeeById); // Match any ID, but validate in controller\nrouter.put('/:id', updateEmployee);\nrouter.delete('/:id', adminOnly, deleteEmployee);\n\n\n// Face registration routes (integrated with employee management)\nrouter.post('/:id/face', protect, adminOnly, upload.single('faceImage'), saveEmployeeFace);\nrouter.get('/:id/face', protect, getEmployeeFace);\nrouter.delete('/:id/face', protect, adminOnly, deleteEmployeeFace);\n\n// Face verification for attendance (employee access)\nrouter.post('/verify-face', protect, verifyFaceAttendance);\n\n// Admin utilities\nrouter.get('/admin/without-face', protect, adminOnly, getEmployeesWithoutFace);\n\nexport default router;","path":null,"size_bytes":2790,"size_tokens":null},"backend/routes/userRoutes.js":{"content":"import express from 'express';\nimport { body } from 'express-validator';\nimport { registerUser, loginUser, getUsers } from '../controllers/userController.js';\nimport { protect, adminOnly } from '../middleware/authMiddleware.js';\n\nconst router = express.Router();\n\n// Validation rules\nconst registerValidation = [\n  body('name').trim().isLength({ min: 2, max: 50 }).withMessage('Name must be 2-50 characters'),\n  body('email').isEmail().normalizeEmail().withMessage('Please provide a valid email'),\n  body('password')\n    .isLength({ min: 6 })\n    .withMessage('Password must be at least 6 characters')\n    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)/)\n    .withMessage('Password must contain uppercase, lowercase, and number')\n];\n\nconst loginValidation = [\n  body('email').isEmail().normalizeEmail().withMessage('Please provide a valid email'),\n  body('password').notEmpty().withMessage('Password is required')\n];\n\n// Public routes\nrouter.post('/register', registerValidation, registerUser);\nrouter.post('/login', loginValidation, loginUser);\n\n// Protected routes\nrouter.get('/', protect, adminOnly, getUsers);\n\nexport default router;\n","path":null,"size_bytes":1133,"size_tokens":null},"backend/scripts/seedAttendance.js":{"content":"import mongoose from 'mongoose';\nimport dotenv from 'dotenv';\nimport Attendance from '../models/Attendance.js';\nimport Employee from '../models/Employee.js';\nimport User from '../models/User.js';\n\n// Load environment variables\ndotenv.config();\n\nconst seedAttendance = async () => {\n  try {\n    // Connect to MongoDB\n    await mongoose.connect(process.env.MONGODB_URI || process.env.MONGO_URI, {\n      useNewUrlParser: true,\n      useUnifiedTopology: true,\n    });\n\n    console.log('✅ Connected to MongoDB');\n\n    // Get all employees\n    const employees = await Employee.find({}).populate('user');\n    console.log(`Found ${employees.length} employees`);\n\n    if (employees.length === 0) {\n      console.log('No employees found. Please create some employees first.');\n      return;\n    }\n\n    // Create sample attendance records for the last 7 days\n    const attendanceRecords = [];\n    const today = new Date();\n\n    for (let i = 0; i < 7; i++) {\n      const date = new Date(today);\n      date.setDate(today.getDate() - i);\n\n      // Create attendance for each employee\n      for (const employee of employees) {\n        // Randomly decide if employee was present (80% chance)\n        const isPresent = Math.random() < 0.8;\n\n        if (isPresent) {\n          const checkInTime = new Date(date);\n          checkInTime.setHours(9 + Math.floor(Math.random() * 2), // 9-10 AM\n                              Math.floor(Math.random() * 60), 0, 0);\n\n          const checkOutTime = new Date(date);\n          checkOutTime.setHours(17 + Math.floor(Math.random() * 2), // 5-6 PM\n                               Math.floor(Math.random() * 60), 0, 0);\n\n          // Calculate working hours\n          const timeDiff = checkOutTime - checkInTime;\n          const workingMinutes = Math.round(timeDiff / (1000 * 60));\n\n          // Determine status\n          let status = 'Present';\n          let isLate = false;\n          let lateMinutes = 0;\n\n          const standardTime = new Date(date);\n          standardTime.setHours(9, 0, 0, 0);\n\n          if (checkInTime > standardTime) {\n            isLate = true;\n            lateMinutes = Math.round((checkInTime - standardTime) / (1000 * 60));\n\n            if (lateMinutes > 240) {\n              status = 'Half Day';\n            } else if (lateMinutes > 30) {\n              status = 'Late';\n            }\n          }\n\n          const attendance = {\n            employee: employee._id,\n            user: employee.user._id,\n            date: new Date(date.getFullYear(), date.getMonth(), date.getDate()),\n            checkInTime,\n            checkOutTime,\n            checkInLocation: {\n              latitude: 22.29269924053806 + (Math.random() - 0.5) * 0.01,\n              longitude: 73.12228427139301 + (Math.random() - 0.5) * 0.01,\n              address: 'Office Location',\n              accuracy: 10 + Math.random() * 20\n            },\n            checkOutLocation: {\n              latitude: 22.29269924053806 + (Math.random() - 0.5) * 0.01,\n              longitude: 73.12228427139301 + (Math.random() - 0.5) * 0.01,\n              address: 'Office Location',\n              accuracy: 10 + Math.random() * 20\n            },\n            workingHours: workingMinutes,\n            status,\n            isLate,\n            lateMinutes,\n            notes: '',\n            ipAddress: '192.168.1.100',\n            deviceInfo: {\n              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',\n              platform: 'Web',\n              browser: 'Chrome'\n            }\n          };\n\n          attendanceRecords.push(attendance);\n        }\n      }\n    }\n\n    // Insert attendance records\n    if (attendanceRecords.length > 0) {\n      await Attendance.insertMany(attendanceRecords);\n      console.log(`✅ Created ${attendanceRecords.length} attendance records`);\n    } else {\n      console.log('No attendance records to create');\n    }\n\n    // Show summary\n    const totalRecords = await Attendance.countDocuments();\n    console.log(`Total attendance records in database: ${totalRecords}`);\n\n  } catch (error) {\n    console.error('❌ Error seeding attendance data:', error.message);\n    if (error.code === 11000) {\n      console.log('Some attendance records might already exist');\n    }\n  } finally {\n    mongoose.connection.close();\n    console.log('🔌 Database connection closed');\n  }\n};\n\n// Run seeding if this file is executed directly\nif (process.argv[1] === new URL(import.meta.url).pathname) {\n  seedAttendance();\n}\n\nexport default seedAttendance;","path":null,"size_bytes":4505,"size_tokens":null},"backend/routes/groupRoutes.js":{"content":"import express from 'express';\nimport { protect } from '../middleware/auth.js';\nimport {\n  createGroup,\n  getMyGroups,\n  getGroupById,\n  updateGroup,\n  addMembers,\n  removeMember,\n  leaveGroup,\n  updateMemberRole,\n  deleteGroup,\n  getGroupMessages,\n  sendGroupMessage\n} from '../controllers/groupController.js';\n\nconst router = express.Router();\n\nrouter.use(protect);\n\nrouter.post('/', createGroup);\nrouter.get('/', getMyGroups);\nrouter.get('/:groupId', getGroupById);\nrouter.put('/:groupId', updateGroup);\nrouter.delete('/:groupId', deleteGroup);\n\nrouter.post('/:groupId/members', addMembers);\nrouter.delete('/:groupId/members/:memberId', removeMember);\nrouter.put('/:groupId/members/:memberId/role', updateMemberRole);\nrouter.post('/:groupId/leave', leaveGroup);\n\nrouter.get('/:groupId/messages', getGroupMessages);\nrouter.post('/:groupId/messages', sendGroupMessage);\n\nexport default router;\n","path":null,"size_bytes":895,"size_tokens":null},"backend/routes/taskRoutes.js":{"content":"// routes/taskRoutes.js\nimport express from 'express';\nimport { body } from 'express-validator';\nimport {\n  createTask,\n  getTasks,\n  getTaskById,\n  updateTask,\n  deleteTask,\n  addComment,\n  updateProgress,\n  changeStatus,\n  getTaskStats,\n  toggleSubtask\n} from '../controllers/taskController.js';\nimport { protect } from '../middleware/auth.js';\n\nconst router = express.Router();\n\n// Validation middleware for task creation\n\nconst taskValidation = [\n  body('title')\n    .trim()\n    .isLength({ min: 1, max: 100 })  // Changed from min: 3 to min: 1\n    .withMessage('Title must be between 1 and 100 characters'),\n  body('description')\n    .trim()\n    .isLength({ min: 1, max: 1000 })  // Changed from min: 10 to min: 1\n    .withMessage('Description must be between 1 and 1000 characters'),\n  body('assignedTo')\n    .isMongoId()\n    .withMessage('Please provide a valid employee ID'),\n  body('priority')\n    .isIn(['Low', 'Medium', 'High', 'Critical'])\n    .withMessage('Priority must be Low, Medium, High, or Critical'),\n  body('dueDate')\n    .isISO8601()\n    .withMessage('Please provide a valid due date'),\n  body('category')\n    .isIn(['Development', 'Design', 'Testing', 'Documentation', 'Research', 'Bug Fix', 'Feature', 'Maintenance', 'Other'])\n    .withMessage('Please select a valid category'),\n  body('estimatedHours')\n    .isNumeric()\n    .isFloat({ min: 0, max: 1000 })\n    .withMessage('Estimated hours must be between 0 and 1000')\n];\n\nconst commentValidation = [\n  body('text')\n    .trim()\n    .isLength({ min: 1, max: 500 })\n    .withMessage('Comment must be between 1 and 500 characters')\n];\n\nconst progressValidation = [\n  body('progress')\n    .isNumeric()\n    .isFloat({ min: 0, max: 100 })\n    .withMessage('Progress must be between 0 and 100')\n];\n\nconst statusValidation = [\n  body('status')\n    .isIn(['Not Started', 'In Progress', 'Review', 'Completed', 'On Hold', 'Cancelled'])\n    .withMessage('Invalid status')\n];\n\n// Apply auth middleware to all routes\nrouter.use(protect);\n\n// Routes\nrouter.route('/')\n  .get(getTasks)\n  .post(taskValidation, createTask);\n\nrouter.get('/stats', getTaskStats);\n\nrouter.route('/:id')\n  .get(getTaskById)\n  .put(updateTask)\n  .delete(deleteTask);\n\nrouter.post('/:id/comments', commentValidation, addComment);\nrouter.put('/:id/progress', progressValidation, updateProgress);\nrouter.put('/:id/status', statusValidation, changeStatus);\nrouter.put('/:id/subtasks/:subtaskId', toggleSubtask);\n\nexport default router;","path":null,"size_bytes":2467,"size_tokens":null},"backend/routes/departmentRoutes.js":{"content":"import express from 'express';\nimport {\n  getDepartments,\n  getDepartmentById,\n  createDepartment,\n  updateDepartment,\n  deleteDepartment,\n  getDepartmentStats,\n  getDepartmentList\n} from '../controllers/departmentController.js';\nimport { protect } from '../middleware/auth.js';\n\nconst router = express.Router();\n\n// Apply authentication middleware to all routes\nrouter.use(protect);\n\n// Routes\nrouter.route('/')\n  .get(getDepartments)\n  .post(createDepartment);\n\nrouter.route('/stats')\n  .get(getDepartmentStats);\n\nrouter.route('/list')\n  .get(getDepartmentList);\n\nrouter.route('/:id')\n  .get(getDepartmentById)\n  .put(updateDepartment)\n  .delete(deleteDepartment);\n\nexport default router;\n","path":null,"size_bytes":691,"size_tokens":null},"replit.md":{"content":"# Employee Management System\n\n## Overview\nA full-stack Employee Management System built with React (Vite) frontend and Node.js/Express backend with MongoDB database.\n\n## Project Structure\n```\n├── backend/              # Express.js API server\n│   ├── config/           # Database configuration\n│   ├── controllers/      # Request handlers\n│   ├── middleware/       # Auth, error handling, validation\n│   ├── models/           # Mongoose schemas\n│   ├── routes/           # API routes\n│   ├── socket/           # Socket.IO chat handlers\n│   ├── utils/            # Helper functions\n│   └── server.js         # Entry point\n├── frontend/             # React/Vite application\n│   ├── public/           # Static assets, face recognition models\n│   ├── src/\n│   │   ├── components/   # React components\n│   │   ├── pages/        # Page components\n│   │   ├── services/     # API service layers\n│   │   ├── utils/        # Utilities and API helpers\n│   │   └── hooks/        # Custom React hooks\n│   └── vite.config.js    # Vite configuration\n```\n\n## Features\n- User authentication (Admin/Employee roles)\n- Employee management\n- Leave management system\n- Attendance tracking with video-based face recognition\n- Task management\n- Department management\n- Sales lead management\n- Real-time chat (Socket.IO)\n- **Group Chat** - Create groups, add/remove members, owner/admin permissions, real-time messaging\n- AI chatbot integration\n- Purchase order management\n- **Payslip Management** - Admin can generate, bulk generate, view, and download employee payslips\n- **Employee Banking Details** - Admin can view employee banking information\n\n## Local Development Setup\nSee `LOCAL_SETUP.md` in the root directory for complete instructions on:\n- Running the project locally\n- Setting up environment variables (including Groq API key)\n- MongoDB database configuration\n- Troubleshooting common issues\n\n## Face Recognition System\nThe system uses InsightFace for robust face recognition with enhanced anti-spoofing:\n\n### Continuous Video Face Registration (Admin)\n- Single continuous video recording (no separate captures needed)\n- Automatic pose detection (front, left, right, up, down)\n- Real-time pose guidance with visual feedback\n- Quality validation per frame (brightness, sharpness, centering)\n- Minimum coverage requirements for registration\n- Stores embeddings for each detected pose plus averaged embedding\n\n### Live Video Verification with Anti-Spoofing (Employee)\n- Captures multiple video frames for verification\n- Enhanced liveness detection with multiple anti-spoofing checks:\n  - Texture analysis (detects printed photos)\n  - Screen detection using FFT (detects digital displays)\n  - Movement detection (requires natural motion)\n  - Embedding consistency across frames\n  - Pose variation verification\n- Uses averaged embedding comparison with stored multi-angle data\n- Strict security: attendance only marked when ALL checks pass\n\n### Face Service (Python)\n- Runs on port 8000\n- Endpoints:\n  - `/detect` - Basic face detection\n  - `/analyze-frame-base64` - Real-time frame analysis with pose detection\n  - `/register-continuous-video` - Continuous video registration with auto pose detection\n  - `/verify-live-video` - Live video verification with enhanced liveness checks\n- Uses InsightFace buffalo_sc model for face detection and embedding\n\n## Development Setup\n- **Frontend**: Runs on port 5000 (Vite dev server)\n- **Backend**: Runs on port 3001 (Express server)\n- **Database**: MongoDB Atlas (connection configured in backend/config/db.js)\n\n## API Proxy\nIn development, the Vite dev server proxies API requests:\n- `/api/*` routes are proxied to `http://localhost:3001`\n- `/socket.io/*` WebSocket connections are proxied to `http://localhost:3001`\n\n## Demo Credentials\n- **Admin**: admin@gmail.com / admin\n- **Employee**: employee@company.com / EMP001\n\n## Production Deployment\nThe backend serves the frontend static build in production mode.\n- Build command: `cd frontend && npm run build`\n- Run command: `cd backend && NODE_ENV=production PORT=5000 node server.js`\n\n## Technologies\n- **Frontend**: React 18, Vite, TailwindCSS, React Router, Axios, Socket.IO Client\n- **Backend**: Express.js, MongoDB/Mongoose, Socket.IO, JWT Authentication\n- **Features**: Face Recognition (face-api.js), Recharts, React Hot Toast\n","path":null,"size_bytes":4462,"size_tokens":null},"backend/services/faceRecognitionService.js":{"content":"// services/faceRecognitionService.js\nimport * as faceapi from 'face-api.js';\nimport * as tf from '@tensorflow/tfjs';\nimport canvas from 'canvas';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport fs from 'fs/promises';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\n// Setup canvas for Node.js environment\nconst { Canvas, Image, ImageData } = canvas;\nfaceapi.env.monkeyPatch({ Canvas, Image, ImageData });\n\nlet modelsLoaded = false;\nlet tfInitialized = false;\n\n// Face recognition configuration from environment variables\nconst FACE_MATCH_THRESHOLD = parseFloat(process.env.FACE_MATCH_THRESHOLD) || 0.45;\nconst FACE_MIN_CONFIDENCE = parseFloat(process.env.FACE_MIN_CONFIDENCE) || 0.7;\nconst FACE_FRONTALITY_TOLERANCE = parseFloat(process.env.FACE_FRONTALITY_TOLERANCE) || 0.15;\n\n/**\n * Initialize TensorFlow.js backend\n */\nasync function initializeTensorFlow() {\n  if (tfInitialized) {\n    return;\n  }\n\n  try {\n    // Set TensorFlow.js backend to CPU (more compatible than tfjs-node)\n    await tf.setBackend('cpu');\n    await tf.ready();\n    tfInitialized = true;\n    console.log('TensorFlow.js initialized with CPU backend');\n  } catch (error) {\n    console.error('Failed to initialize TensorFlow.js:', error);\n    throw error;\n  }\n}\n\n/**\n * Initialize face-api models\n * Downloads and loads the required models for face detection and recognition\n */\nexport async function initializeFaceModels() {\n  if (modelsLoaded) {\n    console.log('Face models already loaded');\n    return;\n  }\n\n  try {\n    // Initialize TensorFlow.js first\n    await initializeTensorFlow();\n\n    const modelsPath = path.join(__dirname, '../models/face-models');\n\n    // Create models directory if it doesn't exist\n    await fs.mkdir(modelsPath, { recursive: true });\n\n    console.log('Loading face recognition models...');\n\n    // Load models from local directory or download if not present\n    await Promise.all([\n      faceapi.nets.ssdMobilenetv1.loadFromDisk(modelsPath),\n      faceapi.nets.faceLandmark68Net.loadFromDisk(modelsPath),\n      faceapi.nets.faceRecognitionNet.loadFromDisk(modelsPath)\n    ]);\n\n    modelsLoaded = true;\n    console.log('Face recognition models loaded successfully!');\n  } catch (error) {\n    console.error('Error loading face models:', error);\n    throw new Error('Failed to initialize face recognition models');\n  }\n}\n\n/**\n * Detect faces in an image buffer\n * @param {Buffer} imageBuffer - Image buffer\n * @returns {Promise<Array>} Array of detected faces with descriptors\n */\nexport async function detectFaces(imageBuffer) {\n  if (!modelsLoaded) {\n    await initializeFaceModels();\n  }\n\n  try {\n    const img = await canvas.loadImage(imageBuffer);\n    \n    const detections = await faceapi\n      .detectAllFaces(img)\n      .withFaceLandmarks()\n      .withFaceDescriptors();\n\n    return detections.map(detection => ({\n      bbox: detection.detection.box,\n      confidence: detection.detection.score,\n      landmarks: detection.landmarks.positions,\n      descriptor: Array.from(detection.descriptor)\n    }));\n  } catch (error) {\n    console.error('Error detecting faces:', error);\n    throw new Error('Face detection failed');\n  }\n}\n\n/**\n * Detect a single face and return its descriptor with enhanced accuracy\n * @param {Buffer} imageBuffer - Image buffer\n * @returns {Promise<Object>} Face detection result\n */\nexport async function detectSingleFace(imageBuffer, options = {}) {\n  if (!modelsLoaded) {\n    await initializeFaceModels();\n  }\n\n  const { skipFrontalityCheck = false, skipQualityCheck = false } = options;\n\n  try {\n    const img = await canvas.loadImage(imageBuffer);\n\n    // Use higher quality detection with minimum confidence threshold\n    const detection = await faceapi\n      .detectSingleFace(img, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 }))\n      .withFaceLandmarks()\n      .withFaceDescriptor();\n\n    if (!detection) {\n      return {\n        success: false,\n        message: 'No face detected in the image. Please ensure your face is clearly visible and well-lit.'\n      };\n    }\n\n    // Check if face is frontal by analyzing landmarks (can be skipped for admin registration)\n    if (!skipFrontalityCheck) {\n      const isFrontal = checkFaceFrontality(detection.landmarks);\n      if (!isFrontal.isFrontal) {\n        return {\n          success: false,\n          message: `Please face the camera directly. ${isFrontal.reason}`\n        };\n      }\n    }\n\n    // Check face quality (can be skipped for admin registration)\n    if (!skipQualityCheck) {\n      const quality = assessFaceQuality(detection, img.width, img.height);\n      if (!quality.passed) {\n        return {\n          success: false,\n          message: quality.message\n        };\n      }\n    }\n\n    return {\n      success: true,\n      face: {\n        bbox: detection.detection.box,\n        confidence: detection.detection.score,\n        landmarks: detection.landmarks.positions,\n        descriptor: Array.from(detection.descriptor),\n        quality: detection.detection.score\n      }\n    };\n  } catch (error) {\n    console.error('Error detecting single face:', error);\n    throw new Error('Face detection failed');\n  }\n}\n\n/**\n * Check if face is frontal by analyzing facial landmarks\n * @param {Object} landmarks - Face landmarks\n * @returns {Object} Frontality check result\n */\nfunction checkFaceFrontality(landmarks) {\n  const positions = landmarks.positions;\n\n  // Get key facial points\n  const leftEye = positions[36]; // Left eye outer corner\n  const rightEye = positions[45]; // Right eye outer corner\n  const nose = positions[30]; // Nose tip\n  const leftMouth = positions[48]; // Left mouth corner\n  const rightMouth = positions[54]; // Right mouth corner\n\n  // Calculate horizontal symmetry\n  const eyeDistance = Math.abs(rightEye.x - leftEye.x);\n  const leftNoseDistance = Math.abs(nose.x - leftEye.x);\n  const rightNoseDistance = Math.abs(rightEye.x - nose.x);\n\n  // Nose should be centered between eyes (using configured tolerance)\n  const symmetryRatio = Math.abs(leftNoseDistance - rightNoseDistance) / eyeDistance;\n\n  if (symmetryRatio > FACE_FRONTALITY_TOLERANCE) {\n    return {\n      isFrontal: false,\n      reason: 'Face is turned to the side. Please look straight at the camera.'\n    };\n  }\n\n  // Check vertical alignment (face tilt)\n  const eyeHeightDiff = Math.abs(leftEye.y - rightEye.y);\n  const eyeTiltRatio = eyeHeightDiff / eyeDistance;\n\n  if (eyeTiltRatio > 0.1) {\n    return {\n      isFrontal: false,\n      reason: 'Face is tilted. Please keep your head straight.'\n    };\n  }\n\n  // Check mouth symmetry\n  const mouthDistance = Math.abs(rightMouth.x - leftMouth.x);\n  const leftMouthNoseDistance = Math.abs(nose.x - leftMouth.x);\n  const rightMouthNoseDistance = Math.abs(rightMouth.x - nose.x);\n  const mouthSymmetryRatio = Math.abs(leftMouthNoseDistance - rightMouthNoseDistance) / mouthDistance;\n\n  if (mouthSymmetryRatio > FACE_FRONTALITY_TOLERANCE) {\n    return {\n      isFrontal: false,\n      reason: 'Face angle is not optimal. Please face the camera directly.'\n    };\n  }\n\n  return {\n    isFrontal: true,\n    symmetryScore: 1 - symmetryRatio\n  };\n}\n\n/**\n * Assess face quality for registration\n * @param {Object} detection - Face detection result\n * @param {number} imageWidth - Image width\n * @param {number} imageHeight - Image height\n * @returns {Object} Quality assessment result\n */\nfunction assessFaceQuality(detection, imageWidth, imageHeight) {\n  const box = detection.detection.box;\n  const confidence = detection.detection.score;\n\n  // Check detection confidence (using configured minimum)\n  if (confidence < FACE_MIN_CONFIDENCE) {\n    return {\n      passed: false,\n      score: confidence,\n      message: 'Face detection confidence is too low. Please ensure good lighting and clear visibility.'\n    };\n  }\n\n  // Check face size (should be at least 20% of image width)\n  const faceWidthRatio = box.width / imageWidth;\n  if (faceWidthRatio < 0.2) {\n    return {\n      passed: false,\n      score: faceWidthRatio,\n      message: 'Face is too small. Please move closer to the camera.'\n    };\n  }\n\n  if (faceWidthRatio > 0.8) {\n    return {\n      passed: false,\n      score: faceWidthRatio,\n      message: 'Face is too close. Please move back a bit.'\n    };\n  }\n\n  // Check if face is centered (within 30% of center)\n  const faceCenterX = box.x + box.width / 2;\n  const faceCenterY = box.y + box.height / 2;\n  const imageCenterX = imageWidth / 2;\n  const imageCenterY = imageHeight / 2;\n\n  const horizontalOffset = Math.abs(faceCenterX - imageCenterX) / imageWidth;\n  const verticalOffset = Math.abs(faceCenterY - imageCenterY) / imageHeight;\n\n  if (horizontalOffset > 0.3 || verticalOffset > 0.3) {\n    return {\n      passed: false,\n      score: 1 - Math.max(horizontalOffset, verticalOffset),\n      message: 'Face is not centered. Please position your face in the center of the frame.'\n    };\n  }\n\n  return {\n    passed: true,\n    score: confidence,\n    message: 'Face quality is good'\n  };\n}\n\n/**\n * Process multiple video frames and extract face descriptors\n * @param {Array<string>} base64Frames - Array of base64 encoded frames\n * @returns {Promise<Object>} Processing result with embeddings\n */\nexport async function processVideoFrames(base64Frames) {\n  if (!modelsLoaded) {\n    await initializeFaceModels();\n  }\n\n  const validDescriptors = [];\n  const frameResults = [];\n\n  for (const frame of base64Frames) {\n    try {\n      // Remove data URL prefix if present\n      const base64Data = frame.replace(/^data:image\\/\\w+;base64,/, '');\n      const imageBuffer = Buffer.from(base64Data, 'base64');\n      \n      const result = await detectSingleFace(imageBuffer);\n      \n      if (result.success) {\n        validDescriptors.push(result.face.descriptor);\n        frameResults.push({\n          confidence: result.face.confidence,\n          descriptor: result.face.descriptor\n        });\n      }\n    } catch (error) {\n      console.error('Error processing frame:', error);\n      // Continue with next frame\n    }\n  }\n\n  if (validDescriptors.length === 0) {\n    return {\n      success: false,\n      message: 'No valid faces detected in video frames'\n    };\n  }\n\n  // Calculate average descriptor\n  const averageDescriptor = calculateAverageDescriptor(validDescriptors);\n\n  return {\n    success: true,\n    framesProcessed: base64Frames.length,\n    validFrames: validDescriptors.length,\n    averageDescriptor: averageDescriptor,\n    allDescriptors: validDescriptors,\n    frameResults: frameResults\n  };\n}\n\n/**\n * Calculate average descriptor from multiple descriptors\n * @param {Array<Array<number>>} descriptors - Array of face descriptors\n * @returns {Array<number>} Average descriptor\n */\nfunction calculateAverageDescriptor(descriptors) {\n  if (descriptors.length === 0) return null;\n  if (descriptors.length === 1) return descriptors[0];\n\n  const descriptorLength = descriptors[0].length;\n  const average = new Array(descriptorLength).fill(0);\n\n  for (const descriptor of descriptors) {\n    for (let i = 0; i < descriptorLength; i++) {\n      average[i] += descriptor[i];\n    }\n  }\n\n  for (let i = 0; i < descriptorLength; i++) {\n    average[i] /= descriptors.length;\n  }\n\n  return average;\n}\n\n/**\n * Compare two face descriptors using Euclidean distance\n * @param {Array<number>} descriptor1 - First face descriptor\n * @param {Array<number>} descriptor2 - Second face descriptor\n * @returns {number} Distance between descriptors (lower is more similar)\n */\nexport function compareFaceDescriptors(descriptor1, descriptor2) {\n  if (!descriptor1 || !descriptor2) {\n    throw new Error('Both descriptors are required for comparison');\n  }\n\n  if (descriptor1.length !== descriptor2.length) {\n    throw new Error('Descriptors must have the same length');\n  }\n\n  const distance = faceapi.euclideanDistance(descriptor1, descriptor2);\n  return distance;\n}\n\n/**\n * Verify if two faces match based on descriptor comparison\n * Enhanced accuracy with stricter threshold for front-facing verification\n * @param {Array<number>} descriptor1 - First face descriptor\n * @param {Array<number>} descriptor2 - Second face descriptor\n * @param {number} threshold - Distance threshold (uses configured value)\n * @returns {Object} Verification result\n */\nexport function verifyFaceMatch(descriptor1, descriptor2, threshold = FACE_MATCH_THRESHOLD) {\n  const distance = compareFaceDescriptors(descriptor1, descriptor2);\n  const match = distance < threshold;\n\n  // Convert distance to similarity score (0-1, higher is more similar)\n  const similarity = Math.max(0, 1 - distance);\n\n  return {\n    match,\n    distance,\n    similarity,\n    threshold,\n    confidence: match ? (1 - (distance / threshold)) : 0\n  };\n}\n\n/**\n * Process base64 image and detect face\n * @param {string} base64Image - Base64 encoded image\n * @param {Object} options - Detection options\n * @returns {Promise<Object>} Detection result\n */\nexport async function processBase64Image(base64Image, options = {}) {\n  const base64Data = base64Image.replace(/^data:image\\/\\w+;base64,/, '');\n  const imageBuffer = Buffer.from(base64Data, 'base64');\n  // For admin registration, skip strict frontality and quality checks\n  return await detectSingleFace(imageBuffer, {\n    skipFrontalityCheck: true,\n    skipQualityCheck: true,\n    ...options\n  });\n}\n\n/**\n * Register face from front angle only (enhanced accuracy)\n * Takes multiple front-facing images for better accuracy\n * @param {string} frontImage - Base64 front image\n * @param {string} _leftImage - Base64 second front image (optional, for compatibility)\n * @param {string} _rightImage - Base64 third front image (optional, for compatibility)\n * @returns {Promise<Object>} Registration result\n */\nexport async function registerMultiAngleFace(frontImage, _leftImage, _rightImage) {\n  // Process only the front image with strict front-facing validation\n  const frontResult = await processBase64Image(frontImage);\n\n  if (!frontResult.success) {\n    return {\n      success: false,\n      message: frontResult.message || 'Failed to detect front-facing face. Please ensure you are facing the camera directly.',\n      results: { front: frontResult }\n    };\n  }\n\n  // Use only the front descriptor for maximum accuracy\n  const frontDescriptor = frontResult.face.descriptor;\n\n  return {\n    success: true,\n    embeddings: {\n      front: frontDescriptor,\n      left: frontDescriptor,  // Use same descriptor for compatibility\n      right: frontDescriptor, // Use same descriptor for compatibility\n      average: frontDescriptor\n    },\n    qualityScores: {\n      front: frontResult.face.quality || frontResult.face.confidence,\n      left: frontResult.face.quality || frontResult.face.confidence,\n      right: frontResult.face.quality || frontResult.face.confidence\n    },\n    message: 'Front-facing face registered successfully with high accuracy'\n  };\n}\n\n/**\n * Verify face from video frames against stored embeddings\n * @param {Array<string>} frames - Array of base64 frames\n * @param {Object} storedEmbeddings - Stored face embeddings\n * @returns {Promise<Object>} Verification result\n */\nexport async function verifyVideoFace(frames, storedEmbeddings) {\n  const videoResult = await processVideoFrames(frames);\n\n  if (!videoResult.success) {\n    return {\n      success: false,\n      message: videoResult.message,\n      match: false,\n      liveness_passed: false\n    };\n  }\n\n  // Compare with stored embeddings\n  const storedDescriptor = storedEmbeddings.average || storedEmbeddings.front;\n\n  if (!storedDescriptor) {\n    return {\n      success: false,\n      message: 'No stored face embeddings found',\n      match: false\n    };\n  }\n\n  const verification = verifyFaceMatch(videoResult.averageDescriptor, storedDescriptor);\n\n  // Basic liveness check: require multiple valid frames\n  const livenessScore = Math.min(1.0, videoResult.validFrames / 10);\n  const livenessPassed = videoResult.validFrames >= 3 && livenessScore > 0.3;\n\n  return {\n    success: true,\n    match: verification.match,\n    confidence: verification.similarity,\n    similarity: verification.similarity,\n    distance: verification.distance,\n    liveness_passed: livenessPassed,\n    liveness_score: livenessScore,\n    frames_analyzed: videoResult.framesProcessed,\n    valid_frames: videoResult.validFrames,\n    message: verification.match ? 'Face verified successfully' : 'Face does not match'\n  };\n}\n\n","path":null,"size_bytes":16365,"size_tokens":null},"frontend/src/components/Admin/layout/AdminLayout.jsx":{"content":"import React, { useState } from \"react\";\nimport { useLocation } from \"react-router-dom\";\nimport Sidebar from \"../Siderbar/Sidebar\";\nimport Header from \"../Header/Header\";\n\nconst AdminLayout = ({ children }) => {\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const location = useLocation();\n\n  const sidebarItems = [\n    { name: \"Dashboard\", path: \"/admin/dashboard\" },\n    { name: \"Employee Management\", path: \"/admin/employees\" },\n    { name: \"Leave Management\", path: \"/admin/leaves\" },\n    { name: \"Attendance\", path: \"/admin/attendance\" },\n    { name: \"Department\", path: \"/admin/department\" },\n    { name: \"Task Management\", path: \"/admin/tasks\" },\n  ];\n\n  return (\n    <div className=\"min-h-screen flex bg-secondary-900 relative\">\n      {/* Sidebar */}\n      <Sidebar sidebarOpen={sidebarOpen} setSidebarOpen={setSidebarOpen} />\n\n      {/* Main Content Area */}\n      <div className=\"flex-1 flex flex-col lg:ml-64\"> {/* 👈 Push content right by sidebar width */}\n        {/* Header */}\n        <Header\n          sidebarItems={sidebarItems}\n          location={location}\n          setSidebarOpen={setSidebarOpen}\n        />\n        \n        {/* Main Content (with top padding to avoid header overlap) */}\n        <main className=\"p-4 sm:p-6 pt-16 lg:pt-6 flex-1 overflow-y-auto\"> {/* 👈 Add pt-16 to avoid header overlap */}\n          {children}\n        </main>\n      </div>\n\n      {/* Overlay for mobile sidebar */}\n      {sidebarOpen && (\n        <div\n          className=\"fixed inset-0 z-40 bg-black bg-opacity-50 lg:hidden\"\n          onClick={() => setSidebarOpen(false)}\n        ></div>\n      )}\n    </div>\n  );\n};\n\nexport default AdminLayout;","path":null,"size_bytes":1670,"size_tokens":null},"frontend/eslint.config.js":{"content":"import js from '@eslint/js'\nimport globals from 'globals'\nimport reactHooks from 'eslint-plugin-react-hooks'\nimport reactRefresh from 'eslint-plugin-react-refresh'\nimport { defineConfig, globalIgnores } from 'eslint/config'\n\nexport default defineConfig([\n  globalIgnores(['dist']),\n  {\n    files: ['**/*.{js,jsx}'],\n    extends: [\n      js.configs.recommended,\n      reactHooks.configs['recommended-latest'],\n      reactRefresh.configs.vite,\n    ],\n    languageOptions: {\n      ecmaVersion: 2020,\n      globals: globals.browser,\n      parserOptions: {\n        ecmaVersion: 'latest',\n        ecmaFeatures: { jsx: true },\n        sourceType: 'module',\n      },\n    },\n    rules: {\n      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],\n    },\n  },\n])\n","path":null,"size_bytes":763,"size_tokens":null},"frontend/src/hooks/useTasks.js":{"content":"// ===== CORRECTED useTasks.js Hook =====\nimport { useState, useEffect, useCallback } from 'react';\nimport { taskService } from '../services/taskService';\nimport toast from 'react-hot-toast';\n\nexport const useTasks = (initialFilters = {}) => {\n  const [tasks, setTasks] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [filters, setFilters] = useState(initialFilters);\n  const [stats, setStats] = useState(null);\n\n  // Fetch tasks with better error handling and logging\n  const fetchTasks = useCallback(async (filterParams = filters) => {\n    try {\n      setLoading(true);\n      setError(null);\n      \n      console.log('useTasks: Fetching tasks with filters:', filterParams);\n      const response = await taskService.getTasks(filterParams);\n      console.log('useTasks: API Response:', response);\n      \n      if (response && response.success) {\n        const taskList = response.tasks || [];\n        console.log('useTasks: Setting tasks, count:', taskList.length);\n        setTasks(taskList);\n      } else {\n        console.error('useTasks: Invalid response format:', response);\n        setError('Invalid response from server');\n      }\n    } catch (error) {\n      console.error('useTasks: Error fetching tasks:', error);\n      setError(error.message || 'Failed to fetch tasks');\n      toast.error(error.message || 'Failed to fetch tasks');\n    } finally {\n      setLoading(false);\n    }\n  }, [filters]);\n\n  // Fetch task stats\n  const fetchStats = useCallback(async () => {\n    try {\n      console.log('useTasks: Fetching task stats...');\n      const response = await taskService.getTaskStats();\n      console.log('useTasks: Stats response:', response);\n      \n      if (response && response.success) {\n        setStats(response.stats);\n      }\n    } catch (error) {\n      console.error('useTasks: Failed to fetch task stats:', error);\n    }\n  }, []);\n\n  // Create task with proper state update\n  const createTask = async (taskData) => {\n    try {\n      console.log('useTasks: Creating task with data:', taskData);\n      const response = await taskService.createTask(taskData);\n      console.log('useTasks: Create task response:', response);\n      \n      if (response && response.success && response.task) {\n        // Add the new task to the beginning of the list\n        setTasks(prev => [response.task, ...prev]);\n        toast.success('Task created successfully!');\n        \n        // Refresh stats after creating\n        fetchStats();\n        return response;\n      } else {\n        throw new Error(response.message || 'Failed to create task');\n      }\n    } catch (error) {\n      console.error('useTasks: Create task error:', error);\n      toast.error(error.message || 'Failed to create task');\n      throw error;\n    }\n  };\n\n  // Update task\n  const updateTask = async (taskId, taskData) => {\n    try {\n      console.log('useTasks: Updating task:', taskId, taskData);\n      const response = await taskService.updateTask(taskId, taskData);\n      \n      if (response && response.success && response.task) {\n        setTasks(prev => prev.map(task => \n          task._id === taskId ? response.task : task\n        ));\n        toast.success('Task updated successfully!');\n        fetchStats();\n        return response;\n      } else {\n        throw new Error(response.message || 'Failed to update task');\n      }\n    } catch (error) {\n      console.error('useTasks: Update task error:', error);\n      toast.error(error.message || 'Failed to update task');\n      throw error;\n    }\n  };\n\n  // Delete task\n  const deleteTask = async (taskId) => {\n    try {\n      console.log('useTasks: Deleting task:', taskId);\n      const response = await taskService.deleteTask(taskId);\n      \n      if (response && response.success) {\n        setTasks(prev => prev.filter(task => task._id !== taskId));\n        toast.success('Task deleted successfully!');\n        fetchStats();\n      } else {\n        throw new Error(response.message || 'Failed to delete task');\n      }\n    } catch (error) {\n      console.error('useTasks: Delete task error:', error);\n      toast.error(error.message || 'Failed to delete task');\n      throw error;\n    }\n  };\n\n  // Update task progress\n  const updateProgress = async (taskId, progress) => {\n    try {\n      const response = await taskService.updateProgress(taskId, progress);\n      if (response && response.success && response.task) {\n        setTasks(prev => prev.map(task => \n          task._id === taskId ? response.task : task\n        ));\n        return response;\n      }\n    } catch (error) {\n      console.error('useTasks: Update progress error:', error);\n      toast.error(error.message || 'Failed to update progress');\n      throw error;\n    }\n  };\n\n  // Change task status\n  const changeStatus = async (taskId, status) => {\n    try {\n      const response = await taskService.changeStatus(taskId, status);\n      if (response && response.success && response.task) {\n        setTasks(prev => prev.map(task => \n          task._id === taskId ? response.task : task\n        ));\n        toast.success(`Task status updated to ${status}!`);\n        return response;\n      }\n    } catch (error) {\n      console.error('useTasks: Change status error:', error);\n      toast.error(error.message || 'Failed to change status');\n      throw error;\n    }\n  };\n\n  // Add comment\n  const addComment = async (taskId, text) => {\n    try {\n      const response = await taskService.addComment(taskId, text);\n      if (response && response.success && response.task) {\n        setTasks(prev => prev.map(task => \n          task._id === taskId ? response.task : task\n        ));\n        toast.success('Comment added!');\n        return response;\n      }\n    } catch (error) {\n      console.error('useTasks: Add comment error:', error);\n      toast.error(error.message || 'Failed to add comment');\n      throw error;\n    }\n  };\n\n  // Toggle subtask\n  const toggleSubtask = async (taskId, subtaskId) => {\n    try {\n      const response = await taskService.toggleSubtask(taskId, subtaskId);\n      if (response && response.success && response.task) {\n        setTasks(prev => prev.map(task => \n          task._id === taskId ? response.task : task\n        ));\n        return response;\n      }\n    } catch (error) {\n      console.error('useTasks: Toggle subtask error:', error);\n      toast.error(error.message || 'Failed to toggle subtask');\n      throw error;\n    }\n  };\n\n  // Initial data fetch\n  useEffect(() => {\n    console.log('useTasks: Component mounted, fetching initial data');\n    fetchTasks();\n    fetchStats();\n  }, [fetchTasks, fetchStats]);\n\n  // Re-fetch when filters change\n  useEffect(() => {\n    console.log('useTasks: Filters changed, re-fetching tasks');\n    fetchTasks();\n  }, [filters, fetchTasks]);\n\n  return {\n    tasks,\n    loading,\n    error,\n    stats,\n    filters,\n    setFilters,\n    fetchTasks,\n    fetchStats,\n    createTask,\n    updateTask,\n    deleteTask,\n    updateProgress,\n    changeStatus,\n    addComment,\n    toggleSubtask\n  };\n};","path":null,"size_bytes":7035,"size_tokens":null},"frontend/src/components/Admin/main/AdminDashboard.jsx":{"content":"// components/Dashboard/AdminDashboard.js\nimport React, { useMemo, useState } from 'react';\nimport AdminLayout from '../layout/AdminLayout';\nimport WelcomeSection from '../Dashboard/WelcomeSection';\nimport StatCard from '../Dashboard/StatCard';\nimport RecentActivities from '../Dashboard/RecentActivities';\nimport UpcomingEvents from '../Dashboard/UpcomingEvents';\nimport QuickActions from '../Dashboard/QuickActions';\nimport LoadingSpinner from '../../Common/LoadingSpinner';\nimport FloatingChatButton from './FloatingChatButton';\nimport AdminChatbot from './AdminChatbot';\nimport { useDashboardData } from '../../../hooks/useDashboardData';\nimport { useRealTimeUpdates } from '../../../hooks/useRealTimeUpdates';\nimport { useAuth } from '../../../hooks/useAuth';\n\nconst AdminDashboard = () => {\n  const { user, isAuthenticated, isAdmin } = useAuth();\n  const {\n    stats,\n    recentActivities,\n    upcomingEvents,\n    loading,\n    error,\n    refreshData\n  } = useDashboardData();\n\n  const {\n    lastUpdated,\n    isAutoRefreshEnabled,\n    toggleAutoRefresh,\n    manualRefresh\n  } = useRealTimeUpdates(refreshData);\n\n  const [isChatOpen, setIsChatOpen] = useState(false);\n\n  // Memoized components for performance\n  const statsGrid = useMemo(() => (\n    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n      {stats.map((stat, index) => (\n        <StatCard key={stat.title} stat={stat} index={index} />\n      ))}\n    </div>\n  ), [stats]);\n\n  const contentGrid = useMemo(() => (\n    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n      <RecentActivities activities={recentActivities} loading={loading} />\n      <UpcomingEvents events={upcomingEvents} loading={loading} />\n    </div>\n  ), [recentActivities, upcomingEvents, loading]);\n\n  // Loading state\n  if (loading && stats.length === 0) {\n    return (\n      <AdminLayout>\n        <LoadingSpinner message=\"Loading dashboard...\" />\n      </AdminLayout>\n    );\n  }\n\n  // Error state (still show dashboard with error message)\n  if (error && stats.length === 0) {\n    return (\n      <AdminLayout>\n        <div className=\"flex flex-col items-center justify-center min-h-screen\">\n          <div className=\"text-red-400 text-xl mb-4\">⚠️ Dashboard Error</div>\n          <div className=\"text-white text-lg mb-6\">{error}</div>\n          <button \n            onClick={refreshData}\n            className=\"px-6 py-3 bg-neon-pink text-white rounded-lg hover:bg-neon-pink/80 transition-colors\"\n          >\n            Retry Loading\n          </button>\n        </div>\n      </AdminLayout>\n    );\n  }\n\n  return (\n    <AdminLayout>\n      <div className=\"space-y-6\">\n        {/* Control Bar */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center space-x-4\">\n            {error && (\n              <div className=\"text-red-400 text-sm\">\n                ⚠️ Some data may be outdated\n              </div>\n            )}\n          </div>\n          \n          <div className=\"flex items-center space-x-4\">\n            <div className=\"text-sm text-secondary-400\">\n              Last updated: {lastUpdated.toLocaleTimeString()}\n            </div>\n            \n            <button\n              onClick={toggleAutoRefresh}\n              className={`text-xs px-3 py-1 rounded-full transition-colors ${\n                isAutoRefreshEnabled \n                  ? 'bg-green-500/20 text-green-400' \n                  : 'bg-red-500/20 text-red-400'\n              }`}\n            >\n              Auto-refresh: {isAutoRefreshEnabled ? 'ON' : 'OFF'}\n            </button>\n            \n            <button\n              onClick={manualRefresh}\n              className=\"text-xs px-3 py-1 bg-neon-purple/20 text-neon-purple rounded-full hover:bg-neon-purple/30 transition-colors\"\n              disabled={loading}\n            >\n              {loading ? 'Refreshing...' : 'Refresh'}\n            </button>\n          </div>\n        </div>\n\n        {/* Welcome Section */}\n        <WelcomeSection userName={user?.name || 'Admin'} />\n\n        {/* Stats Grid */}\n        {statsGrid}\n\n        {/* Content Grid */}\n        {contentGrid}\n\n        {/* Quick Actions */}\n        <QuickActions userRole={user?.role || 'admin'} />\n      </div>\n\n      {/* Floating Chat Button */}\n      <FloatingChatButton\n        isAdmin={isAdmin}\n        onClick={() => setIsChatOpen(true)}\n      />\n\n      {/* Admin Chatbot */}\n      <AdminChatbot\n        isOpen={isChatOpen}\n        onClose={() => setIsChatOpen(false)}\n        isAdmin={isAdmin}\n      />\n    </AdminLayout>\n  );\n};\n\nexport default AdminDashboard;","path":null,"size_bytes":4589,"size_tokens":null},"frontend/src/components/Admin/main/FloatingChatButton.jsx":{"content":"import React, { useState } from 'react';\nimport { MessageCircle } from 'lucide-react';\n\nconst FloatingChatButton = ({ isAdmin, onClick }) => {\n  if (!isAdmin) return null;\n\n  return (\n    <button\n      onClick={onClick}\n      className=\"fixed bottom-6 right-6 bg-neon-purple hover:bg-neon-purple/80 text-white p-4 rounded-full shadow-lg transition-all duration-300 hover:scale-110 z-50\"\n      aria-label=\"Open Admin AI Chatbot\"\n    >\n      <MessageCircle size={24} />\n    </button>\n  );\n};\n\nexport default FloatingChatButton;\n","path":null,"size_bytes":526,"size_tokens":null},"backend/models/Lead.js":{"content":"import mongoose from 'mongoose';\n\nconst meetingSchema = new mongoose.Schema({\n  meetingId: {\n    type: String,\n    unique: true,\n    // required: true\n  },\n  type: {\n    type: String,\n    enum: ['Call', 'Video Meeting', 'In-Person', 'Email Follow-up', 'Demo', 'Presentation', 'Negotiation'],\n    required: true\n  },\n  scheduledDate: {\n    type: Date,\n    required: true\n  },\n  duration: {\n    type: Number, // Duration in minutes\n    default: 30\n  },\n  status: {\n    type: String,\n    enum: ['Scheduled', 'Completed', 'Cancelled', 'Rescheduled', 'No Show'],\n    default: 'Scheduled'\n  },\n  agenda: {\n    type: String,\n    trim: true\n  },\n  attendees: [{\n    name: String,\n    email: String,\n    role: String // 'Lead', 'Employee', 'Manager', 'External'\n  }],\n  outcome: {\n    type: String,\n    trim: true\n  },\n  nextAction: {\n    type: String,\n    trim: true\n  },\n  nextMeetingDate: {\n    type: Date\n  },\n  recording: {\n    url: String,\n    notes: String\n  },\n  documents: [{\n    name: String,\n    url: String,\n    type: String // 'Proposal', 'Contract', 'Presentation', 'Other'\n  }],\n  createdBy: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true\n  },\n  createdAt: {\n    type: Date,\n    default: Date.now\n  },\n  updatedAt: {\n    type: Date,\n    default: Date.now\n  }\n});\n\nconst leadSchema = new mongoose.Schema({\n  leadId: {\n    type: String,\n    unique: true,\n  },\n\n  // Lead Information\n  firstName: {\n    type: String,\n    required: true,\n    trim: true\n  },\n  lastName: {\n    type: String,\n    required: true,\n    trim: true\n  },\n  email: {\n    type: String,\n    required: true,\n    lowercase: true,\n    trim: true\n  },\n  phone: {\n    type: String,\n    required: true,\n    trim: true\n  },\n  company: {\n    type: String,\n    trim: true\n  },\n  position: {\n    type: String,\n    trim: true\n  },\n\n  // Lead Details\n  source: {\n    type: String,\n    enum: ['Website', 'Social Media', 'Email Campaign', 'Cold Call', 'Referral', 'Trade Show', 'Advertisement', 'Other'],\n    required: true\n  },\n  status: {\n    type: String,\n    enum: ['New', 'Contacted', 'Qualified', 'Proposal', 'Negotiation', 'Won', 'Lost'],\n    default: 'New'\n  },\n  priority: {\n    type: String,\n    enum: ['Low', 'Medium', 'High', 'Hot'],\n    default: 'Medium'\n  },\n  \n  // Product/Service Interest\n  interestedProducts: [{\n    type: String,\n    trim: true\n  }],\n  estimatedValue: {\n    type: Number,\n    min: 0\n  },\n  actualValue: {\n    type: Number,\n    min: 0 // Filled when status becomes 'Won'\n  },\n  expectedCloseDate: {\n    type: Date\n  },\n  actualCloseDate: {\n    type: Date // Filled when status becomes 'Won' or 'Lost'\n  },\n  \n  // Assignment\n  assignedTo: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'Employee',\n    required: true\n  },\n  assignedBy: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User'\n  },\n  \n  // Meeting Management\n  meetings: [meetingSchema],\n  totalMeetings: {\n    type: Number,\n    default: 0\n  },\n  completedMeetings: {\n    type: Number,\n    default: 0\n  },\n  upcomingMeetings: {\n    type: Number,\n    default: 0\n  },\n  nextMeetingDate: {\n    type: Date\n  },\n  lastMeetingDate: {\n    type: Date\n  },\n  averageMeetingDuration: {\n    type: Number,\n    default: 0\n  },\n  \n  // Communication History\n  notes: [{\n    content: {\n      type: String,\n      required: true\n    },\n    addedBy: {\n      type: mongoose.Schema.Types.ObjectId,\n      ref: 'User',\n      required: true\n    },\n    addedAt: {\n      type: Date,\n      default: Date.now\n    },\n    type: {\n      type: String,\n      enum: ['General', 'Meeting', 'Call', 'Email', 'Follow-up'],\n      default: 'General'\n    }\n  }],\n  \n  // Follow-up\n  lastContactDate: {\n    type: Date\n  },\n  nextFollowUpDate: {\n    type: Date\n  },\n  \n  // Address\n  address: {\n    street: String,\n    city: String,\n    state: String,\n    country: String,\n    pincode: String\n  },\n  \n  // Won Lead Tracking\n  wonDetails: {\n    wonDate: {\n      type: Date\n    },\n    finalValue: {\n      type: Number,\n      min: 0\n    },\n    discount: {\n      type: Number,\n      default: 0\n    },\n    discountReason: {\n      type: String,\n      trim: true\n    },\n    paymentTerms: {\n      type: String,\n      trim: true\n    },\n    deliveryDate: {\n      type: Date\n    },\n    contractDuration: {\n      type: Number // Duration in months\n    },\n    recurringRevenue: {\n      type: Number,\n      default: 0\n    },\n    renewalDate: {\n      type: Date\n    },\n    customerSuccessManager: {\n      type: mongoose.Schema.Types.ObjectId,\n      ref: 'Employee'\n    },\n    onboardingStatus: {\n      type: String,\n      enum: ['Not Started', 'In Progress', 'Completed'],\n      default: 'Not Started'\n    },\n    satisfactionScore: {\n      type: Number,\n      min: 1,\n      max: 10\n    },\n    referralPotential: {\n      type: String,\n      enum: ['Low', 'Medium', 'High'],\n      default: 'Medium'\n    }\n  },\n  \n  // Performance Metrics\n  leadScore: {\n    type: Number,\n    default: 0,\n    min: 0,\n    max: 100\n  },\n  engagementLevel: {\n    type: String,\n    enum: ['Low', 'Medium', 'High'],\n    default: 'Medium'\n  },\n  responseRate: {\n    type: Number,\n    default: 0 // Percentage\n  },\n  \n  // Additional Fields\n  tags: [{\n    type: String,\n    trim: true\n  }],\n  customFields: {\n    type: Map,\n    of: String\n  },\n  \n  // Timestamps\n  createdAt: {\n    type: Date,\n    default: Date.now\n  },\n  updatedAt: {\n    type: Date,\n    default: Date.now\n  },\n  convertedAt: {\n    type: Date\n  }\n}, {\n  timestamps: true\n});\n\n// Virtual for full name\nleadSchema.virtual('fullName').get(function() {\n  return `${this.firstName} ${this.lastName}`;\n});\n\n// Virtual for days since last contact\nleadSchema.virtual('daysSinceLastContact').get(function() {\n  if (!this.lastContactDate) return null;\n  const now = new Date();\n  const diffTime = Math.abs(now - this.lastContactDate);\n  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n});\n\n// Virtual for overdue follow-ups\nleadSchema.virtual('isOverdue').get(function() {\n  if (!this.nextFollowUpDate) return false;\n  return new Date() > this.nextFollowUpDate;\n});\n\n// Virtual for conversion rate\nleadSchema.virtual('conversionRate').get(function() {\n  if (this.totalMeetings === 0) return 0;\n  return Math.round((this.completedMeetings / this.totalMeetings) * 100);\n});\n\n// Pre-save middleware to generate leadId and update meeting counters\nleadSchema.pre('save', async function(next) {\n  if (!this.leadId) {\n    const count = await this.constructor.countDocuments();\n    this.leadId = `LEAD${(count + 1).toString().padStart(6, '0')}`;\n  }\n\n  // Update meeting counters\n  this.totalMeetings = this.meetings.length;\n  this.completedMeetings = this.meetings.filter(m => m.status === 'Completed').length;\n  this.upcomingMeetings = this.meetings.filter(m => \n    m.status === 'Scheduled' && new Date(m.scheduledDate) > new Date()\n  ).length;\n\n  // Update next meeting date\n  const upcomingMeetings = this.meetings\n    .filter(m => m.status === 'Scheduled' && new Date(m.scheduledDate) > new Date())\n    .sort((a, b) => new Date(a.scheduledDate) - new Date(b.scheduledDate));\n  \n  this.nextMeetingDate = upcomingMeetings.length > 0 ? upcomingMeetings[0].scheduledDate : null;\n\n  // Update last meeting date\n  const completedMeetings = this.meetings\n    .filter(m => m.status === 'Completed')\n    .sort((a, b) => new Date(b.scheduledDate) - new Date(a.scheduledDate));\n  \n  this.lastMeetingDate = completedMeetings.length > 0 ? completedMeetings[0].scheduledDate : null;\n\n  // Calculate average meeting duration\n  const completedMeetingsWithDuration = this.meetings.filter(m => \n    m.status === 'Completed' && m.duration\n  );\n  \n  if (completedMeetingsWithDuration.length > 0) {\n    const totalDuration = completedMeetingsWithDuration.reduce((sum, m) => sum + m.duration, 0);\n    this.averageMeetingDuration = Math.round(totalDuration / completedMeetingsWithDuration.length);\n  }\n\n  // Auto-fill won details when status changes to Won\n  if (this.status === 'Won' && !this.wonDetails.wonDate) {\n    this.wonDetails.wonDate = new Date();\n    this.actualCloseDate = new Date();\n    this.convertedAt = new Date();\n    this.actualValue = this.estimatedValue || 0;\n    this.wonDetails.finalValue = this.estimatedValue || 0;\n  }\n\n  // Auto-fill lost date\n  if (this.status === 'Lost' && !this.actualCloseDate) {\n    this.actualCloseDate = new Date();\n    this.convertedAt = new Date();\n  }\n\n  // Generate meeting IDs\n  this.meetings.forEach((meeting, index) => {\n    if (!meeting.meetingId) {\n      meeting.meetingId = `${this.leadId}-M${(index + 1).toString().padStart(3, '0')}`;\n    }\n  });\n\n  this.updatedAt = new Date();\n  next();\n});\n\n// Index for better performance\nleadSchema.index({ assignedTo: 1, status: 1 });\nleadSchema.index({ email: 1 });\nleadSchema.index({ phone: 1 });\nleadSchema.index({ status: 1, priority: 1 });\nleadSchema.index({ nextFollowUpDate: 1 });\nleadSchema.index({ nextMeetingDate: 1 });\nleadSchema.index({ 'wonDetails.wonDate': 1 });\nleadSchema.index({ 'wonDetails.renewalDate': 1 });\n\n// Static methods\nleadSchema.statics.getLeadStats = function(employeeId) {\n  return this.aggregate([\n    { $match: { assignedTo: employeeId } },\n    {\n      $group: {\n        _id: '$status',\n        count: { $sum: 1 },\n        totalValue: { $sum: '$estimatedValue' },\n        actualValue: { $sum: '$actualValue' },\n        avgMeetings: { $avg: '$totalMeetings' }\n      }\n    }\n  ]);\n};\n\nleadSchema.statics.getWonLeadsStats = function(employeeId) {\n  const matchQuery = employeeId ? { assignedTo: employeeId } : {};\n  \n  return this.aggregate([\n    { \n      $match: { \n        ...matchQuery,\n        status: 'Won' \n      } \n    },\n    {\n      $group: {\n        _id: null,\n        totalWon: { $sum: 1 },\n        totalRevenue: { $sum: '$wonDetails.finalValue' },\n        avgDealSize: { $avg: '$wonDetails.finalValue' },\n        totalRecurringRevenue: { $sum: '$wonDetails.recurringRevenue' },\n        avgMeetingsToClose: { $avg: '$completedMeetings' },\n        avgSatisfactionScore: { $avg: '$wonDetails.satisfactionScore' }\n      }\n    }\n  ]);\n};\n\nleadSchema.statics.getMeetingStats = function(employeeId) {\n  const matchQuery = employeeId ? { assignedTo: employeeId } : {};\n  \n  return this.aggregate([\n    { $match: matchQuery },\n    { $unwind: '$meetings' },\n    {\n      $group: {\n        _id: '$meetings.type',\n        count: { $sum: 1 },\n        completed: { \n          $sum: { \n            $cond: [{ $eq: ['$meetings.status', 'Completed'] }, 1, 0] \n          } \n        },\n        avgDuration: { $avg: '$meetings.duration' }\n      }\n    }\n  ]);\n};\n\nleadSchema.statics.getUpcomingMeetings = function(employeeId, days = 7) {\n  const matchQuery = employeeId ? { assignedTo: employeeId } : {};\n  const endDate = new Date();\n  endDate.setDate(endDate.getDate() + days);\n  \n  return this.aggregate([\n    { $match: matchQuery },\n    { $unwind: '$meetings' },\n    {\n      $match: {\n        'meetings.status': 'Scheduled',\n        'meetings.scheduledDate': {\n          $gte: new Date(),\n          $lte: endDate\n        }\n      }\n    },\n    {\n      $lookup: {\n        from: 'employees',\n        localField: 'assignedTo',\n        foreignField: '_id',\n        as: 'assignedTo'\n      }\n    },\n    { $unwind: '$assignedTo' },\n    {\n      $project: {\n        leadId: 1,\n        fullName: { $concat: ['$firstName', ' ', '$lastName'] },\n        company: 1,\n        meeting: '$meetings',\n        assignedTo: '$assignedTo.personalInfo'\n      }\n    },\n    { $sort: { 'meeting.scheduledDate': 1 } }\n  ]);\n};\n\nleadSchema.statics.getOverdueLeads = function(employeeId) {\n  return this.find({\n    assignedTo: employeeId,\n    nextFollowUpDate: { $lt: new Date() },\n    status: { $nin: ['Won', 'Lost'] }\n  }).populate('assignedTo', 'personalInfo.firstName personalInfo.lastName');\n};\n\nexport default mongoose.model('Lead', leadSchema);","path":null,"size_bytes":11799,"size_tokens":null},"frontend/src/pages/Employee/EmployeeSettings.jsx":{"content":"import React, { useState } from 'react';\nimport { Bell, Lock, Palette, Globe, Save, Key } from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport EmployeeLayout from '../../components/Employee/EmployeeLayout/EmployeeLayout';\nimport { authAPI } from '../../utils/api';\n\nconst EmployeeSettings = () => {\n  const [settings, setSettings] = useState({\n    emailNotifications: true,\n    pushNotifications: true,\n    darkMode: true,\n    language: 'en'\n  });\n  const [passwordData, setPasswordData] = useState({\n    currentPassword: '',\n    newPassword: '',\n    confirmPassword: ''\n  });\n  const [saving, setSaving] = useState(false);\n  const [changingPassword, setChangingPassword] = useState(false);\n\n  const handleToggle = (key) => {\n    setSettings(prev => ({\n      ...prev,\n      [key]: !prev[key]\n    }));\n  };\n\n  const handleSave = async () => {\n    setSaving(true);\n    try {\n      await new Promise(resolve => setTimeout(resolve, 1000));\n      localStorage.setItem('userSettings', JSON.stringify(settings));\n      toast.success('Settings saved successfully');\n    } catch (error) {\n      toast.error('Failed to save settings');\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const handleChangePassword = async (e) => {\n    e.preventDefault();\n    if (passwordData.newPassword !== passwordData.confirmPassword) {\n      toast.error('New passwords do not match');\n      return;\n    }\n    if (passwordData.newPassword.length < 6) {\n      toast.error('Password must be at least 6 characters');\n      return;\n    }\n    \n    setChangingPassword(true);\n    try {\n      await authAPI.changePassword({\n        currentPassword: passwordData.currentPassword,\n        newPassword: passwordData.newPassword\n      });\n      toast.success('Password changed successfully');\n      setPasswordData({ currentPassword: '', newPassword: '', confirmPassword: '' });\n    } catch (error) {\n      toast.error(error.response?.data?.message || 'Failed to change password');\n    } finally {\n      setChangingPassword(false);\n    }\n  };\n\n  const ToggleSwitch = ({ enabled, onToggle }) => (\n    <button\n      onClick={onToggle}\n      className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${\n        enabled ? 'bg-gradient-to-r from-neon-pink to-neon-purple' : 'bg-secondary-600'\n      }`}\n    >\n      <span\n        className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${\n          enabled ? 'translate-x-6' : 'translate-x-1'\n        }`}\n      />\n    </button>\n  );\n\n  return (\n    <EmployeeLayout>\n      <div className=\"max-w-2xl mx-auto\">\n        <div className=\"mb-6\">\n          <h1 className=\"text-2xl font-bold text-white\">Settings</h1>\n          <p className=\"text-secondary-400 mt-1\">Manage your preferences</p>\n        </div>\n\n        <div className=\"space-y-6\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center space-x-3 mb-6\">\n              <Bell className=\"w-6 h-6 text-neon-pink\" />\n              <h2 className=\"text-lg font-semibold text-white\">Notifications</h2>\n            </div>\n\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between py-3 border-b border-secondary-700\">\n                <div>\n                  <p className=\"text-white font-medium\">Email Notifications</p>\n                  <p className=\"text-sm text-secondary-400\">Receive email updates about your tasks and leaves</p>\n                </div>\n                <ToggleSwitch \n                  enabled={settings.emailNotifications} \n                  onToggle={() => handleToggle('emailNotifications')} \n                />\n              </div>\n\n              <div className=\"flex items-center justify-between py-3\">\n                <div>\n                  <p className=\"text-white font-medium\">Push Notifications</p>\n                  <p className=\"text-sm text-secondary-400\">Receive push notifications on your device</p>\n                </div>\n                <ToggleSwitch \n                  enabled={settings.pushNotifications} \n                  onToggle={() => handleToggle('pushNotifications')} \n                />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center space-x-3 mb-6\">\n              <Key className=\"w-6 h-6 text-neon-purple\" />\n              <h2 className=\"text-lg font-semibold text-white\">Change Password</h2>\n            </div>\n\n            <form onSubmit={handleChangePassword} className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                  Current Password\n                </label>\n                <input\n                  type=\"password\"\n                  value={passwordData.currentPassword}\n                  onChange={(e) => setPasswordData(prev => ({ ...prev, currentPassword: e.target.value }))}\n                  className=\"w-full py-3 px-4 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 transition-all\"\n                  placeholder=\"Enter current password\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                  New Password\n                </label>\n                <input\n                  type=\"password\"\n                  value={passwordData.newPassword}\n                  onChange={(e) => setPasswordData(prev => ({ ...prev, newPassword: e.target.value }))}\n                  className=\"w-full py-3 px-4 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 transition-all\"\n                  placeholder=\"Enter new password\"\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                  Confirm New Password\n                </label>\n                <input\n                  type=\"password\"\n                  value={passwordData.confirmPassword}\n                  onChange={(e) => setPasswordData(prev => ({ ...prev, confirmPassword: e.target.value }))}\n                  className=\"w-full py-3 px-4 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 transition-all\"\n                  placeholder=\"Confirm new password\"\n                />\n              </div>\n\n              <button\n                type=\"submit\"\n                disabled={changingPassword || !passwordData.currentPassword || !passwordData.newPassword}\n                className=\"w-full py-3 px-4 bg-secondary-700 hover:bg-secondary-600 text-white font-semibold rounded-lg transition-all duration-300 disabled:opacity-50 flex items-center justify-center space-x-2\"\n              >\n                {changingPassword ? (\n                  <span>Changing...</span>\n                ) : (\n                  <>\n                    <Lock className=\"w-5 h-5\" />\n                    <span>Change Password</span>\n                  </>\n                )}\n              </button>\n            </form>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center space-x-3 mb-6\">\n              <Palette className=\"w-6 h-6 text-neon-pink\" />\n              <h2 className=\"text-lg font-semibold text-white\">Appearance</h2>\n            </div>\n\n            <div className=\"flex items-center justify-between py-3\">\n              <div>\n                <p className=\"text-white font-medium\">Dark Mode</p>\n                <p className=\"text-sm text-secondary-400\">Use dark theme throughout the app</p>\n              </div>\n              <ToggleSwitch \n                enabled={settings.darkMode} \n                onToggle={() => handleToggle('darkMode')} \n              />\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center space-x-3 mb-6\">\n              <Globe className=\"w-6 h-6 text-neon-purple\" />\n              <h2 className=\"text-lg font-semibold text-white\">Language</h2>\n            </div>\n\n            <select\n              value={settings.language}\n              onChange={(e) => setSettings(prev => ({ ...prev, language: e.target.value }))}\n              className=\"w-full py-3 px-4 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 transition-all\"\n            >\n              <option value=\"en\">English</option>\n              <option value=\"es\">Spanish</option>\n              <option value=\"fr\">French</option>\n              <option value=\"de\">German</option>\n              <option value=\"hi\">Hindi</option>\n            </select>\n          </div>\n\n          <button\n            onClick={handleSave}\n            disabled={saving}\n            className=\"w-full py-3 px-4 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 disabled:opacity-50 flex items-center justify-center space-x-2\"\n          >\n            {saving ? (\n              <span>Saving...</span>\n            ) : (\n              <>\n                <Save className=\"w-5 h-5\" />\n                <span>Save Settings</span>\n              </>\n            )}\n          </button>\n        </div>\n      </div>\n    </EmployeeLayout>\n  );\n};\n\nexport default EmployeeSettings;","path":null,"size_bytes":9732,"size_tokens":null},"backend/models/Problem.js":{"content":"// backend/models/Problem.js\nimport mongoose from 'mongoose';\n\nconst problemSchema = new mongoose.Schema({\n  description: { type: String, required: true },\n  reportedBy: { type: mongoose.Schema.Types.ObjectId, ref: 'User', required: true },\n  solvedBy: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },\n  status: { type: String, enum: ['Pending', 'Solved'], default: 'Pending' },\n  solvedAt: Date,\n  createdAt: { type: Date, default: Date.now }\n});\n\nexport default mongoose.model('Problem', problemSchema);","path":null,"size_bytes":511,"size_tokens":null},"backend/controllers/payslipController.js":{"content":"import Payslip from '../models/Payslip.js';\nimport Employee from '../models/Employee.js';\nimport Attendance from '../models/Attendance.js';\nimport path from 'path';\nimport fs from 'fs';\nimport { v4 as uuidv4 } from 'uuid';\n\nconst generatePayslipPDF = async (payslip, employee) => {\n  const PDFDocument = (await import('pdfkit')).default;\n  const fileName = `payslip_${payslip.employeeId}_${payslip.period.month}_${payslip.period.year}_${uuidv4().slice(0, 8)}.pdf`;\n  const tempDir = path.join(process.cwd(), 'temp', 'payslips');\n  if (!fs.existsSync(tempDir)) fs.mkdirSync(tempDir, { recursive: true });\n  const filePath = path.join(tempDir, fileName);\n\n  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',\n    'July', 'August', 'September', 'October', 'November', 'December'];\n\n  return new Promise((resolve, reject) => {\n    const doc = new PDFDocument({ margin: 50 });\n    const stream = fs.createWriteStream(filePath);\n    doc.pipe(stream);\n\n    doc.fontSize(20).font('Helvetica-Bold').text('PAYSLIP', { align: 'center' });\n    doc.moveDown(0.5);\n    doc.fontSize(12).font('Helvetica').text('CompanyName Pvt Ltd', { align: 'center' });\n    doc.fontSize(10).text('123 Business Park, Tech City', { align: 'center' });\n    doc.moveDown();\n\n    doc.moveTo(50, doc.y).lineTo(550, doc.y).stroke();\n    doc.moveDown();\n\n    doc.fontSize(14).font('Helvetica-Bold').text(`Pay Period: ${monthNames[payslip.period.month - 1]} ${payslip.period.year}`);\n    doc.moveDown();\n\n    doc.fontSize(12).font('Helvetica-Bold').text('EMPLOYEE DETAILS');\n    doc.moveDown(0.5);\n    doc.fontSize(10).font('Helvetica');\n    doc.text(`Employee Name: ${payslip.employeeName}`);\n    doc.text(`Employee ID: ${payslip.employeeId}`);\n    doc.text(`Department: ${employee?.workInfo?.department?.name || 'N/A'}`);\n    doc.text(`Designation: ${employee?.workInfo?.position || 'N/A'}`);\n    doc.moveDown();\n\n    if (payslip.bankInfo?.accountNumber) {\n      doc.text(`Bank: ${payslip.bankInfo.bankName || 'N/A'}`);\n      doc.text(`Account: XXXX${payslip.bankInfo.accountNumber.slice(-4)}`);\n      doc.text(`IFSC: ${payslip.bankInfo.ifscCode || 'N/A'}`);\n      doc.moveDown();\n    }\n\n    doc.moveTo(50, doc.y).lineTo(550, doc.y).stroke();\n    doc.moveDown();\n\n    const startY = doc.y;\n    \n    doc.fontSize(11).font('Helvetica-Bold').text('EARNINGS', 50);\n    doc.moveDown(0.5);\n    doc.fontSize(10).font('Helvetica');\n    \n    const earnings = [\n      ['Basic Salary', payslip.earnings.basicSalary],\n      ['HRA', payslip.earnings.hra],\n      ['Medical Allowance', payslip.earnings.medical],\n      ['Transport Allowance', payslip.earnings.transport],\n      ['Bonus', payslip.earnings.bonus],\n      ['Overtime', payslip.earnings.overtime],\n      ['Other Allowances', payslip.earnings.otherAllowances]\n    ].filter(([_, val]) => val > 0);\n\n    earnings.forEach(([label, value]) => {\n      doc.text(`${label}:`, 60);\n      doc.text(`INR ${value.toLocaleString()}`, 200, doc.y - 12);\n      doc.moveDown(0.3);\n    });\n\n    doc.moveDown(0.5);\n    doc.font('Helvetica-Bold').text('Gross Earnings:', 60);\n    doc.text(`INR ${payslip.grossEarnings.toLocaleString()}`, 200, doc.y - 12);\n\n    doc.y = startY;\n    doc.fontSize(11).font('Helvetica-Bold').text('DEDUCTIONS', 320);\n    doc.moveDown(0.5);\n    doc.fontSize(10).font('Helvetica');\n\n    const deductions = [\n      ['Provident Fund', payslip.deductions.pf],\n      ['ESI', payslip.deductions.esi],\n      ['Income Tax', payslip.deductions.tax],\n      ['Professional Tax', payslip.deductions.professionalTax],\n      ['Loan Deduction', payslip.deductions.loanDeduction],\n      ['Other Deductions', payslip.deductions.otherDeductions]\n    ].filter(([_, val]) => val > 0);\n\n    deductions.forEach(([label, value]) => {\n      doc.text(`${label}:`, 330);\n      doc.text(`INR ${value.toLocaleString()}`, 470, doc.y - 12);\n      doc.moveDown(0.3);\n    });\n\n    doc.moveDown(0.5);\n    doc.font('Helvetica-Bold').text('Total Deductions:', 330);\n    doc.text(`INR ${payslip.totalDeductions.toLocaleString()}`, 470, doc.y - 12);\n\n    doc.moveDown(2);\n    doc.moveTo(50, doc.y).lineTo(550, doc.y).stroke();\n    doc.moveDown();\n\n    if (payslip.attendance) {\n      doc.fontSize(11).font('Helvetica-Bold').text('ATTENDANCE SUMMARY');\n      doc.moveDown(0.5);\n      doc.fontSize(10).font('Helvetica');\n      doc.text(`Working Days: ${payslip.attendance.workingDays} | Present: ${payslip.attendance.presentDays} | Leave: ${payslip.attendance.leaveDays} | Absent: ${payslip.attendance.absentDays}`);\n      doc.moveDown();\n    }\n\n    doc.moveTo(50, doc.y).lineTo(550, doc.y).stroke();\n    doc.moveDown();\n\n    doc.fontSize(14).font('Helvetica-Bold').fillColor('green');\n    doc.text(`NET SALARY: INR ${payslip.netSalary.toLocaleString()}`, { align: 'center' });\n    doc.fillColor('black');\n    doc.moveDown(2);\n\n    doc.fontSize(8).font('Helvetica').fillColor('gray');\n    doc.text('This is a computer-generated document. No signature required.', { align: 'center' });\n    doc.text(`Generated on: ${new Date().toLocaleString()}`, { align: 'center' });\n\n    doc.end();\n    stream.on('finish', () => resolve(fileName));\n    stream.on('error', reject);\n  });\n};\n\nexport const generatePayslip = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { employeeId, month, year, earnings, deductions, remarks, regenerate } = req.body;\n\n    if (!employeeId || !month || !year) {\n      return res.status(400).json({\n        success: false,\n        message: 'Employee ID, month, and year are required'\n      });\n    }\n\n    const employee = await Employee.findById(employeeId)\n      .populate('user', 'name email')\n      .populate('workInfo.department', 'name');\n\n    if (!employee) {\n      return res.status(404).json({\n        success: false,\n        message: 'Employee not found'\n      });\n    }\n\n    const existingPayslip = await Payslip.findOne({\n      employee: employeeId,\n      'period.month': month,\n      'period.year': year\n    });\n\n    if (existingPayslip) {\n      // If regenerate flag is true, delete the existing payslip and continue\n      if (regenerate === true) {\n        console.log(`Regenerating payslip for employee ${employee.employeeId} for ${month}/${year}`);\n\n        // Delete the old PDF file if it exists\n        if (existingPayslip.pdfPath) {\n          const oldPdfPath = path.join(process.cwd(), 'temp', 'payslips', existingPayslip.pdfPath);\n          if (fs.existsSync(oldPdfPath)) {\n            try {\n              fs.unlinkSync(oldPdfPath);\n              console.log(`Deleted old PDF: ${existingPayslip.pdfPath}`);\n            } catch (err) {\n              console.error('Error deleting old PDF:', err);\n            }\n          }\n        }\n\n        // Delete the existing payslip from database\n        await Payslip.findByIdAndDelete(existingPayslip._id);\n        console.log(`Deleted existing payslip ID: ${existingPayslip._id}`);\n      } else {\n        // If regenerate flag is not set, return error with regenerate option\n        return res.status(400).json({\n          success: false,\n          message: `Payslip already exists for ${month}/${year}.`,\n          existingPayslip: {\n            id: existingPayslip._id,\n            generatedAt: existingPayslip.createdAt,\n            netSalary: existingPayslip.netSalary\n          },\n          canRegenerate: true\n        });\n      }\n    }\n\n    const startDate = new Date(year, month - 1, 1);\n    const endDate = new Date(year, month, 0);\n    \n    const attendanceRecords = await Attendance.find({\n      $or: [\n        { employee: employeeId },\n        { user: employee.user._id }\n      ],\n      date: { $gte: startDate, $lte: endDate }\n    });\n\n    const workingDays = endDate.getDate();\n    const presentDays = attendanceRecords.filter(a => \n      ['present', 'Present', 'late', 'Late'].includes(a.status)\n    ).length;\n    const leaveDays = attendanceRecords.filter(a => \n      ['leave', 'Leave', 'approved_leave'].includes(a.status)\n    ).length;\n    const absentDays = workingDays - presentDays - leaveDays;\n\n    const payslipData = {\n      employee: employeeId,\n      employeeId: employee.employeeId,\n      employeeName: `${employee.personalInfo.firstName} ${employee.personalInfo.lastName}`,\n      period: { month, year },\n      earnings: {\n        basicSalary: earnings?.basicSalary ?? employee.salaryInfo.basicSalary,\n        hra: earnings?.hra ?? employee.salaryInfo.allowances?.hra ?? 0,\n        medical: earnings?.medical ?? employee.salaryInfo.allowances?.medical ?? 0,\n        transport: earnings?.transport ?? employee.salaryInfo.allowances?.transport ?? 0,\n        bonus: earnings?.bonus ?? 0,\n        overtime: earnings?.overtime ?? 0,\n        otherAllowances: earnings?.otherAllowances ?? employee.salaryInfo.allowances?.other ?? 0\n      },\n      deductions: {\n        pf: deductions?.pf ?? employee.salaryInfo.deductions?.pf ?? 0,\n        esi: deductions?.esi ?? employee.salaryInfo.deductions?.esi ?? 0,\n        tax: deductions?.tax ?? employee.salaryInfo.deductions?.tax ?? 0,\n        professionalTax: deductions?.professionalTax ?? 0,\n        loanDeduction: deductions?.loanDeduction ?? 0,\n        otherDeductions: deductions?.otherDeductions ?? employee.salaryInfo.deductions?.other ?? 0\n      },\n      attendance: {\n        workingDays,\n        presentDays,\n        leaveDays,\n        absentDays: Math.max(0, absentDays)\n      },\n      bankInfo: {\n        accountNumber: employee.bankInfo?.accountNumber || '',\n        bankName: employee.bankInfo?.bankName || '',\n        ifscCode: employee.bankInfo?.ifscCode || ''\n      },\n      generatedBy: req.user.id,\n      remarks: remarks || ''\n    };\n\n    const payslip = new Payslip(payslipData);\n    await payslip.save();\n\n    try {\n      const pdfFileName = await generatePayslipPDF(payslip, employee);\n      payslip.pdfPath = pdfFileName;\n      await payslip.save();\n    } catch (pdfError) {\n      console.error('PDF generation error:', pdfError);\n    }\n\n    await payslip.populate('employee', 'personalInfo.firstName personalInfo.lastName employeeId');\n    await payslip.populate('generatedBy', 'name email');\n\n    res.status(201).json({\n      success: true,\n      message: 'Payslip generated successfully',\n      data: payslip\n    });\n\n  } catch (error) {\n    console.error('Generate payslip error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\nexport const getPayslips = async (req, res) => {\n  try {\n    const { month, year, employeeId, status, page = 1, limit = 20 } = req.query;\n\n    const query = {};\n    \n    if (month) query['period.month'] = parseInt(month);\n    if (year) query['period.year'] = parseInt(year);\n    if (employeeId) query.employee = employeeId;\n    if (status) query.status = status;\n\n    if (req.user.role !== 'admin') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee) {\n        return res.status(404).json({\n          success: false,\n          message: 'Employee record not found'\n        });\n      }\n      query.employee = employee._id;\n    }\n\n    const payslips = await Payslip.find(query)\n      .populate('employee', 'personalInfo.firstName personalInfo.lastName employeeId workInfo.position')\n      .populate('generatedBy', 'name email')\n      .sort({ 'period.year': -1, 'period.month': -1 })\n      .limit(limit * 1)\n      .skip((page - 1) * limit);\n\n    const total = await Payslip.countDocuments(query);\n\n    res.json({\n      success: true,\n      data: {\n        payslips,\n        pagination: {\n          currentPage: parseInt(page),\n          totalPages: Math.ceil(total / limit),\n          totalPayslips: total\n        }\n      }\n    });\n\n  } catch (error) {\n    console.error('Get payslips error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\nexport const getPayslipById = async (req, res) => {\n  try {\n    const payslip = await Payslip.findById(req.params.id)\n      .populate('employee', 'personalInfo contactInfo workInfo salaryInfo bankInfo employeeId')\n      .populate('generatedBy', 'name email');\n\n    if (!payslip) {\n      return res.status(404).json({\n        success: false,\n        message: 'Payslip not found'\n      });\n    }\n\n    if (req.user.role !== 'admin') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee || payslip.employee._id.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied'\n        });\n      }\n    }\n\n    res.json({\n      success: true,\n      data: payslip\n    });\n\n  } catch (error) {\n    console.error('Get payslip by ID error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\nexport const getEmployeePayslips = async (req, res) => {\n  try {\n    const { employeeId } = req.params;\n\n    if (req.user.role !== 'admin') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee || employee._id.toString() !== employeeId) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied'\n        });\n      }\n    }\n\n    const payslips = await Payslip.find({ employee: employeeId })\n      .populate('generatedBy', 'name')\n      .sort({ 'period.year': -1, 'period.month': -1 });\n\n    res.json({\n      success: true,\n      data: payslips\n    });\n\n  } catch (error) {\n    console.error('Get employee payslips error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\nexport const downloadPayslip = async (req, res) => {\n  try {\n    const payslip = await Payslip.findById(req.params.id)\n      .populate('employee');\n\n    if (!payslip) {\n      return res.status(404).json({\n        success: false,\n        message: 'Payslip not found'\n      });\n    }\n\n    if (req.user.role !== 'admin') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (!employee || payslip.employee._id.toString() !== employee._id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied'\n        });\n      }\n    }\n\n    if (!payslip.pdfPath) {\n      const pdfFileName = await generatePayslipPDF(payslip, payslip.employee);\n      payslip.pdfPath = pdfFileName;\n      await payslip.save();\n    }\n\n    const filePath = path.join(process.cwd(), 'temp', 'payslips', payslip.pdfPath);\n    \n    if (!fs.existsSync(filePath)) {\n      const pdfFileName = await generatePayslipPDF(payslip, payslip.employee);\n      payslip.pdfPath = pdfFileName;\n      await payslip.save();\n    }\n\n    const finalPath = path.join(process.cwd(), 'temp', 'payslips', payslip.pdfPath);\n    res.download(finalPath, `Payslip_${payslip.employeeId}_${payslip.period.month}_${payslip.period.year}.pdf`);\n\n  } catch (error) {\n    console.error('Download payslip error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\nexport const updatePayslipStatus = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { status, paymentDate, paymentMethod } = req.body;\n\n    const payslip = await Payslip.findById(req.params.id);\n\n    if (!payslip) {\n      return res.status(404).json({\n        success: false,\n        message: 'Payslip not found'\n      });\n    }\n\n    if (status) payslip.status = status;\n    if (paymentDate) payslip.paymentDate = paymentDate;\n    if (paymentMethod) payslip.paymentMethod = paymentMethod;\n\n    await payslip.save();\n\n    res.json({\n      success: true,\n      message: 'Payslip status updated',\n      data: payslip\n    });\n\n  } catch (error) {\n    console.error('Update payslip status error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\nexport const deletePayslip = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const payslip = await Payslip.findById(req.params.id);\n\n    if (!payslip) {\n      return res.status(404).json({\n        success: false,\n        message: 'Payslip not found'\n      });\n    }\n\n    if (payslip.pdfPath) {\n      const filePath = path.join(process.cwd(), 'temp', 'payslips', payslip.pdfPath);\n      if (fs.existsSync(filePath)) {\n        fs.unlinkSync(filePath);\n      }\n    }\n\n    await Payslip.findByIdAndDelete(req.params.id);\n\n    res.json({\n      success: true,\n      message: 'Payslip deleted successfully'\n    });\n\n  } catch (error) {\n    console.error('Delete payslip error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\nexport const generateBulkPayslips = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { month, year, departmentId, regenerate } = req.body;\n\n    if (!month || !year) {\n      return res.status(400).json({\n        success: false,\n        message: 'Month and year are required'\n      });\n    }\n\n    const query = { status: 'Active' };\n    if (departmentId) {\n      query['workInfo.department'] = departmentId;\n    }\n\n    const employees = await Employee.find(query)\n      .populate('user', 'name email')\n      .populate('workInfo.department', 'name');\n\n    const results = {\n      success: [],\n      failed: [],\n      skipped: [],\n      regenerated: []\n    };\n\n    for (const employee of employees) {\n      try {\n        const existing = await Payslip.findOne({\n          employee: employee._id,\n          'period.month': month,\n          'period.year': year\n        });\n\n        if (existing) {\n          if (regenerate === true) {\n            // Delete existing payslip and regenerate\n            console.log(`Regenerating payslip for employee ${employee.employeeId}`);\n\n            // Delete old PDF\n            if (existing.pdfPath) {\n              const oldPdfPath = path.join(process.cwd(), 'temp', 'payslips', existing.pdfPath);\n              if (fs.existsSync(oldPdfPath)) {\n                try {\n                  fs.unlinkSync(oldPdfPath);\n                } catch (err) {\n                  console.error('Error deleting old PDF:', err);\n                }\n              }\n            }\n\n            await Payslip.findByIdAndDelete(existing._id);\n            // Continue to generate new payslip below\n          } else {\n            results.skipped.push({\n              employeeId: employee.employeeId,\n              name: `${employee.personalInfo.firstName} ${employee.personalInfo.lastName}`,\n              reason: 'Payslip already exists'\n            });\n            continue;\n          }\n        }\n\n        const startDate = new Date(year, month - 1, 1);\n        const endDate = new Date(year, month, 0);\n        \n        const attendanceRecords = await Attendance.find({\n          $or: [\n            { employee: employee._id },\n            { user: employee.user._id }\n          ],\n          date: { $gte: startDate, $lte: endDate }\n        });\n\n        const workingDays = endDate.getDate();\n        const presentDays = attendanceRecords.filter(a => \n          ['present', 'Present', 'late', 'Late'].includes(a.status)\n        ).length;\n        const leaveDays = attendanceRecords.filter(a => \n          ['leave', 'Leave', 'approved_leave'].includes(a.status)\n        ).length;\n\n        const payslipData = {\n          employee: employee._id,\n          employeeId: employee.employeeId,\n          employeeName: `${employee.personalInfo.firstName} ${employee.personalInfo.lastName}`,\n          period: { month, year },\n          earnings: {\n            basicSalary: employee.salaryInfo.basicSalary,\n            hra: employee.salaryInfo.allowances?.hra ?? 0,\n            medical: employee.salaryInfo.allowances?.medical ?? 0,\n            transport: employee.salaryInfo.allowances?.transport ?? 0,\n            otherAllowances: employee.salaryInfo.allowances?.other ?? 0\n          },\n          deductions: {\n            pf: employee.salaryInfo.deductions?.pf ?? 0,\n            esi: employee.salaryInfo.deductions?.esi ?? 0,\n            tax: employee.salaryInfo.deductions?.tax ?? 0,\n            otherDeductions: employee.salaryInfo.deductions?.other ?? 0\n          },\n          attendance: {\n            workingDays,\n            presentDays,\n            leaveDays,\n            absentDays: Math.max(0, workingDays - presentDays - leaveDays)\n          },\n          bankInfo: {\n            accountNumber: employee.bankInfo?.accountNumber || '',\n            bankName: employee.bankInfo?.bankName || '',\n            ifscCode: employee.bankInfo?.ifscCode || ''\n          },\n          generatedBy: req.user.id\n        };\n\n        const payslip = new Payslip(payslipData);\n        await payslip.save();\n\n        try {\n          const pdfFileName = await generatePayslipPDF(payslip, employee);\n          payslip.pdfPath = pdfFileName;\n          await payslip.save();\n        } catch (pdfError) {\n          console.error('PDF generation error for', employee.employeeId, pdfError);\n        }\n\n        const payslipInfo = {\n          employeeId: employee.employeeId,\n          name: `${employee.personalInfo.firstName} ${employee.personalInfo.lastName}`,\n          netSalary: payslip.netSalary\n        };\n\n        if (existing && regenerate) {\n          results.regenerated.push(payslipInfo);\n        } else {\n          results.success.push(payslipInfo);\n        }\n\n      } catch (error) {\n        results.failed.push({\n          employeeId: employee.employeeId,\n          name: `${employee.personalInfo.firstName} ${employee.personalInfo.lastName}`,\n          reason: error.message\n        });\n      }\n    }\n\n    const totalGenerated = results.success.length + results.regenerated.length;\n    let message = `Generated ${results.success.length} new payslips`;\n    if (results.regenerated.length > 0) {\n      message += `, regenerated ${results.regenerated.length} payslips`;\n    }\n    if (results.skipped.length > 0) {\n      message += `, skipped ${results.skipped.length} existing payslips`;\n    }\n    if (results.failed.length > 0) {\n      message += `, ${results.failed.length} failed`;\n    }\n\n    res.json({\n      success: true,\n      message,\n      data: results\n    });\n\n  } catch (error) {\n    console.error('Bulk payslip generation error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n","path":null,"size_bytes":22779,"size_tokens":null},"backend/routes/aiRoutes.js":{"content":"import express from 'express';\nimport { body } from 'express-validator';\nimport * as aiController from '../controllers/aiController.js';\nimport { protect, adminOnly } from '../middleware/auth.js';\n\nconst router = express.Router();\n\n// Validation middleware\nconst chatValidation = [\n  body('message')\n    .isString()\n    .trim()\n    .isLength({ min: 1, max: 1000 })\n    .withMessage('Message must be a string between 1 and 1000 characters')\n];\n\n// Protected routes (require authentication and admin role)\nrouter.use(protect);\nrouter.use(adminOnly);\n\n// AI chat endpoint\nrouter.post('/chat', chatValidation, aiController.chat);\n\nexport default router;\n","path":null,"size_bytes":650,"size_tokens":null},"backend/scripts/seedAdmin.js":{"content":"// scripts/seedAdmin.js\nimport mongoose from \"mongoose\";\nimport dotenv from \"dotenv\";\nimport User from \"../models/User.js\";\n\ndotenv.config({ path: \".env\" });\n\nconst ADMIN_EMAIL = process.env.ADMIN_EMAIL || \"admin@gmail.com\";\nconst ADMIN_PASSWORD = process.env.ADMIN_PASSWORD || \"admin123\";\nconst ADMIN_NAME = process.env.ADMIN_NAME || \"Admin\";\n\nif (!ADMIN_EMAIL || !ADMIN_PASSWORD) {\n  console.error(\"❌ ADMIN_EMAIL or ADMIN_PASSWORD missing in .env\");\n  process.exit(1);\n}\n\nconst adminData = {\n  name: ADMIN_NAME,\n  email: ADMIN_EMAIL.toLowerCase().trim(),\n  password: ADMIN_PASSWORD, // will be hashed by model\n  role: \"admin\",\n  isActive: true,\n};\n\nconst seedAdmin = async () => {\n  try {\n    console.log(\"⏳ Connecting to MongoDB...\");\n    await mongoose.connect(process.env.MONGODB_URI);\n\n    console.log(\"✅ Connected.\");\n\n    const existingAdmin = await User.findOne({ email: adminData.email });\n\n    if (existingAdmin) {\n      console.log(\"⚠️ Admin exists. Updating password...\");\n      existingAdmin.password = ADMIN_PASSWORD; // new password\n      await existingAdmin.save(); // triggers pre-save hashing\n\n      console.log(\"🔄 Admin password updated!\");\n      return;\n    }\n\n    const admin = new User(adminData);\n    await admin.save();\n\n    console.log(\"🎉 Admin created:\", {\n      name: admin.name,\n      email: admin.email,\n      role: admin.role,\n    });\n  } catch (err) {\n    console.error(\"❌ Error seeding admin:\", err);\n  } finally {\n    await mongoose.disconnect();\n    console.log(\"🔌 Disconnected.\");\n  }\n};\n\nseedAdmin();\n","path":null,"size_bytes":1559,"size_tokens":null},"backend/routes/faceDetectionRoutes.js":{"content":"import express from 'express';\nimport {\n  saveEmployeeFace,\n  getEmployeeFace,\n  deleteEmployeeFace,\n  verifyFaceAttendance,\n  getEmployeesWithoutFace,\n  detectFaces,\n  analyzeFrame,\n  analyzeFrameBase64,\n  registerMultiAngleFace,\n  registerContinuousVideo,\n  verifyVideoFace,\n  verifyLiveVideo,\n  checkLiveness,\n  upload\n} from '../controllers/faceDetectionController.js';\nimport { protect, adminOnly } from '../middleware/authMiddleware.js';\n\nconst router = express.Router();\n\nrouter.use(protect);\n\n// Continuous video registration (new primary method)\nrouter.post('/register-continuous-video', adminOnly, registerContinuousVideo);\n\n// Multi-angle video registration (legacy)\nrouter.post('/register-multi-angle', adminOnly, registerMultiAngleFace);\n\n// Frame analysis for real-time feedback\nrouter.post('/analyze-frame', adminOnly, upload.single('file'), analyzeFrame);\nrouter.post('/analyze-frame-base64', adminOnly, analyzeFrameBase64);\n\n// Live video verification with enhanced liveness detection (new primary method)\nrouter.post('/verify-live-video', verifyLiveVideo);\n\n// Video-based verification with liveness detection (legacy)\nrouter.post('/verify-video', verifyVideoFace);\n\n// Liveness check\nrouter.post('/check-liveness', checkLiveness);\n\n// Legacy single-image registration\nrouter.post('/save-face', adminOnly, upload.single('file'), saveEmployeeFace);\n\nrouter.get('/employee/:employeeId', getEmployeeFace);\n\nrouter.delete('/employee/:employeeId', adminOnly, deleteEmployeeFace);\n\n// Legacy single-image verification\nrouter.post('/verify-attendance', upload.single('file'), verifyFaceAttendance);\n\nrouter.get('/employees-without-face', adminOnly, getEmployeesWithoutFace);\n\nrouter.post('/detect', upload.single('file'), detectFaces);\n\nexport default router;\n","path":null,"size_bytes":1771,"size_tokens":null},"backend/controllers/userController.js":{"content":"import User from '../models/User.js';\nimport { validationResult } from 'express-validator';\n\n// @desc    Register user\n// @route   POST /api/users/register\n// @access  Public\nexport const registerUser = async (req, res) => {\n  // Validate request body\n  const errors = validationResult(req);\n  if (!errors.isEmpty()) {\n    return res.status(400).json({ success: false, errors: errors.array() });\n  }\n\n  try {\n    const { name, email, password, role = 'user' } = req.body;\n\n    // Check if user already exists\n    const existingUser = await User.findOne({ email: email.toLowerCase() });\n    if (existingUser) {\n      return res.status(400).json({ success: false, message: 'Email already registered' });\n    }\n\n    // Create user\n    const user = await User.create({ name, email: email.toLowerCase(), password, role });\n\n    // Generate token\n    const token = user.getSignedJwtToken();\n\n    // Exclude sensitive fields\n    const { password: pwd, ...userData } = user.toObject();\n\n    res.status(201).json({ success: true, token, user: userData });\n  } catch (err) {\n    res.status(500).json({ success: false, message: err.message });\n  }\n};\n\n// @desc    Login user\n// @route   POST /api/users/login\n// @access  Public\nexport const loginUser = async (req, res) => {\n  const errors = validationResult(req);\n  if (!errors.isEmpty()) return res.status(400).json({ success: false, errors: errors.array() });\n\n  try {\n    const { email, password } = req.body;\n\n    const user = await User.findOne({ email: email.toLowerCase() }).select('+password');\n    if (!user || !(await user.matchPassword(password))) {\n      return res.status(401).json({ success: false, message: 'Invalid credentials' });\n    }\n\n    // Generate token\n    const token = user.getSignedJwtToken();\n\n    // Update last login (optional)\n    if (user.updateLastLogin) await user.updateLastLogin();\n\n    // Exclude password\n    const { password: pwd, ...userData } = user.toObject();\n\n    res.status(200).json({ success: true, token, user: userData });\n  } catch (err) {\n    res.status(500).json({ success: false, message: err.message });\n  }\n};\n\n// @desc    Get all users (Admin only)\n// @route   GET /api/users\n// @access  Private/Admin\nexport const getUsers = async (req, res) => {\n  try {\n    const users = await User.find().select('-password -passwordResetToken -passwordResetExpires');\n    res.status(200).json({ success: true, count: users.length, users });\n  } catch (err) {\n    res.status(500).json({ success: false, message: err.message });\n  }\n};\n","path":null,"size_bytes":2517,"size_tokens":null},"frontend/src/services/employeeService.js":{"content":"import api from './api';\n\nexport const employeeService = {\n  // Get all employees\n  getEmployees: async (params = {}) => {\n    try {\n      const response = await api.get('/employees', { params });\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to get employees' };\n    }\n  },\n\n  // Get employee by ID\n  getEmployeeById: async (employeeId) => {\n    try {\n      const response = await api.get(`/employees/${employeeId}`);\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to get employee' };\n    }\n  },\n\n  // Create new employee (Admin only)\n  createEmployee: async (employeeData) => {\n    try {\n      const response = await api.post('/employees', employeeData);\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to create employee' };\n    }\n  },\n\n  // Update employee\n  updateEmployee: async (employeeId, employeeData) => {\n    try {\n      const response = await api.put(`/employees/${employeeId}`, employeeData);\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to update employee' };\n    }\n  },\n\n  // Delete employee (Admin only)\n  deleteEmployee: async (employeeId) => {\n    try {\n      const response = await api.delete(`/employees/${employeeId}`);\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to delete employee' };\n    }\n  },\n\n  // Get employee statistics\n  getEmployeeStats: async () => {\n    try {\n      const response = await api.get('/employees/stats');\n      return response.data;\n    } catch (error) {\n      throw error.response?.data || { message: 'Failed to get employee stats' };\n    }\n  }\n};\n","path":null,"size_bytes":1791,"size_tokens":null},"frontend/src/components/Admin/Header/ProfileDropdown.jsx":{"content":"import React, { useEffect } from \"react\";\nimport { Link } from \"react-router-dom\";\nimport { User, LogOut, Shield, Clock } from \"lucide-react\";\n\nconst ProfileDropdown = ({ onLogout, userProfile, onClose }) => {\n  useEffect(() => {\n    const handleEscape = (e) => {\n      if (e.key === 'Escape') {\n        onClose();\n      }\n    };\n\n    document.addEventListener('keydown', handleEscape);\n    return () => document.removeEventListener('keydown', handleEscape);\n  }, [onClose]);\n\n  const userRole = userProfile?.role || localStorage.getItem('userRole') || 'employee';\n  const isAdmin = userRole === 'admin';\n\n  const formatName = () => {\n    if (userProfile?.name) return userProfile.name;\n    if (userProfile?.personalInfo) {\n      const { firstName, lastName } = userProfile.personalInfo;\n      if (firstName && lastName) return `${firstName} ${lastName}`;\n    }\n    return localStorage.getItem('userName') || 'User';\n  };\n\n  const formatEmail = () => {\n    return userProfile?.email || \n           userProfile?.contactInfo?.personalEmail ||\n           localStorage.getItem('userEmail') || \n           '';\n  };\n\n  return (\n    <div className=\"absolute right-0 mt-2 w-72 bg-secondary-800 rounded-lg border border-secondary-600 shadow-xl z-50\">\n      <div className=\"p-4 border-b border-secondary-600\">\n        <div className=\"flex items-center space-x-3\">\n          <div className=\"w-12 h-12 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center flex-shrink-0\">\n            <User className=\"w-6 h-6 text-white\" />\n          </div>\n          <div className=\"flex-1 min-w-0\">\n            <p className=\"text-sm font-semibold text-white truncate\">\n              {formatName()}\n            </p>\n            <p className=\"text-xs text-secondary-400 truncate\">\n              {formatEmail()}\n            </p>\n            <div className=\"flex items-center space-x-2 mt-1\">\n              <div className=\"flex items-center space-x-1\">\n                <Shield className=\"w-3 h-3 text-neon-pink\" />\n                <span className=\"text-xs text-neon-pink capitalize\">\n                  {isAdmin ? 'Administrator' : 'Employee'}\n                </span>\n              </div>\n              {userProfile?.employeeId && (\n                <span className=\"text-xs text-secondary-500\">\n                  ID: {userProfile.employeeId}\n                </span>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"py-2\">\n        <Link\n          to={isAdmin ? '/admin/profile' : '/employee/profile'}\n          onClick={onClose}\n          className=\"flex items-center px-4 py-2.5 text-sm text-secondary-300 hover:text-white hover:bg-secondary-700/50 transition-colors\"\n        >\n          <User className=\"w-4 h-4 mr-3\" />\n          {isAdmin ? 'Profile Settings' : 'Profile Information'}\n        </Link>\n\n        {isAdmin && (\n          <Link\n            to=\"/admin/employees\"\n            onClick={onClose}\n            className=\"flex items-center px-4 py-2.5 text-sm text-secondary-300 hover:text-white hover:bg-secondary-700/50 transition-colors\"\n          >\n            <User className=\"w-4 h-4 mr-3\" />\n            Manage Employees\n          </Link>\n        )}\n\n        {!isAdmin && (\n          <Link\n            to=\"/employee/attendance\"\n            onClick={onClose}\n            className=\"flex items-center px-4 py-2.5 text-sm text-secondary-300 hover:text-white hover:bg-secondary-700/50 transition-colors\"\n          >\n            <Clock className=\"w-4 h-4 mr-3\" />\n            My Attendance\n          </Link>\n        )}\n\n        <hr className=\"my-2 border-secondary-600\" />\n\n        <button\n          onClick={() => {\n            onClose();\n            onLogout();\n          }}\n          className=\"flex items-center w-full px-4 py-2.5 text-sm text-red-400 hover:text-red-300 hover:bg-red-400/10 transition-colors\"\n        >\n          <LogOut className=\"w-4 h-4 mr-3\" />\n          Logout\n        </button>\n      </div>\n    </div>\n  );\n};\n\nexport default ProfileDropdown;","path":null,"size_bytes":4040,"size_tokens":null},"backend/controllers/botController.js":{"content":"// backend/controllers/botController.js\nimport Groq from 'groq-sdk';\nimport User from '../models/User.js';\nimport Employee from '../models/Employee.js';\nimport Attendance from '../models/Attendance.js';\nimport Leave from '../models/Leave.js';\nimport Message from '../models/Message.js';\nimport Department from '../models/Department.js';\nimport Payslip from '../models/Payslip.js';\nimport path from 'path';\nimport fs from 'fs';\nimport { v4 as uuidv4 } from 'uuid';\n\nconst ADMIN_HR_CONTEXT = `You are an intelligent HR Admin Assistant bot for an Employee Management System. You have access to COMPLETE employee data and can answer any question about any employee in the organization.\n\nYour capabilities as Admin HR Assistant:\n1. **Employee Information**: You have access to all employee details including personal info, contact details, work info, salary, attendance, and leave records.\n2. **Search Employees**: Can find employees by name, ID, department, position, or any other criteria.\n3. **Salary & Payroll**: Access to all employee salary information, payslips, and compensation details.\n4. **Attendance Reports**: Can provide attendance data for any employee or the entire organization.\n5. **Leave Management**: Access to all leave requests, balances, and approvals.\n6. **Department Analytics**: Can provide department-wise statistics and reports.\n7. **Performance Data**: Access to performance and appraisal information.\n8. **HR Policies**: General HR policies and guidelines.\n\nIMPORTANT RULES:\n- Answer questions accurately based on the employee data provided\n- When asked about specific employees, use the data to provide accurate information\n- For queries about multiple employees, provide organized summaries\n- Use markdown formatting for better readability\n- Be professional and maintain data privacy awareness\n- If specific data is not available, say so clearly\n\nYou can answer questions like:\n- \"What is John's salary?\"\n- \"How many employees are in the Engineering department?\"\n- \"Show me attendance summary for EMP001\"\n- \"List all employees on leave today\"\n- \"What is the average salary in Sales department?\"`;\n\nconst EMPLOYEE_HR_CONTEXT = `You are an HR Assistant bot for an Employee Management System. You help employees with HR-related questions about THEIR OWN information only.\n\nYour capabilities:\n1. **Personal Leave Balance**: Check your own leave balance and history\n2. **Attendance Records**: View your own attendance records\n3. **Salary Information**: Your salary details and payslips\n4. **HR Policies**: General leave, attendance, and company policies\n5. **Document Requests**: Generate your salary slip or appraisal letter\n6. **Benefits Information**: Your employee benefits and perks\n\nIMPORTANT RULES:\n- ONLY provide information about the logged-in employee\n- Keep responses concise and professional\n- Use markdown formatting for better readability\n- If you cannot answer something, suggest contacting the HR department\n\nFor document generation requests, respond with the appropriate action marker:\n- For salary slip: Include \"[GENERATE_SALARY_SLIP]\" in your response\n- For appraisal letter: Include \"[GENERATE_APPRAISAL_LETTER]\" in your response`;\n\nlet groqClient = null;\n\nconst getGroqClient = () => {\n  if (!groqClient && process.env.GROQ_API_KEY) {\n    groqClient = new Groq({\n      apiKey: process.env.GROQ_API_KEY\n    });\n  }\n  return groqClient;\n};\n\nconst getEmployeeId = (user) => {\n  return user.employeeId?.employeeId || \n         user.employeeId?._id || \n         user.employeeId || \n         user._id.toString() || \n         'unknown';\n};\n\nconst generateSalarySlipPDF = async (user, month = 'current', year = new Date().getFullYear()) => {\n  const PDFDocument = (await import('pdfkit')).default;\n  const empId = getEmployeeId(user);\n  const fileName = `salary_slip_${empId}_${month}_${year}_${uuidv4().slice(0,8)}.pdf`;\n  const tempDir = path.join(process.cwd(), 'temp');\n  if (!fs.existsSync(tempDir)) fs.mkdirSync(tempDir, { recursive: true });\n  const filePath = path.join(tempDir, fileName);\n\n  return new Promise((resolve, reject) => {\n    const doc = new PDFDocument();\n    const stream = fs.createWriteStream(filePath);\n    doc.pipe(stream);\n\n    doc.fontSize(20).text('Salary Slip', { align: 'center' });\n    doc.moveDown();\n    doc.fontSize(12)\n      .text(`Employee: ${user.name || user.fullName || 'N/A'}`)\n      .text(`ID: ${empId}`)\n      .text(`Month: ${month} ${year}`)\n      .moveDown()\n      .text('Basic Salary: $5000')\n      .text('HRA: $1000')\n      .text('Conveyance: $500')\n      .text('Total: $6500');\n\n    doc.end();\n    stream.on('finish', () => resolve(fileName));\n    stream.on('error', reject);\n  });\n};\n\nconst generateAppraisalLetterPDF = async (user) => {\n  const PDFDocument = (await import('pdfkit')).default;\n  const empId = getEmployeeId(user);\n  const fileName = `appraisal_letter_${empId}_${uuidv4().slice(0,8)}.pdf`;\n  const tempDir = path.join(process.cwd(), 'temp');\n  if (!fs.existsSync(tempDir)) fs.mkdirSync(tempDir, { recursive: true });\n  const filePath = path.join(tempDir, fileName);\n\n  return new Promise((resolve, reject) => {\n    const doc = new PDFDocument();\n    const stream = fs.createWriteStream(filePath);\n    doc.pipe(stream);\n\n    doc.fontSize(20).text('Appraisal Letter', { align: 'center' });\n    doc.moveDown();\n    doc.fontSize(12)\n      .text(`Dear ${user.name || user.fullName || 'Employee'},`)\n      .moveDown()\n      .text('Congratulations on your performance this year. Your rating is Excellent.')\n      .text('Salary increment: 10%')\n      .moveDown()\n      .text('Best regards,')\n      .text('HR Department');\n\n    doc.end();\n    stream.on('finish', () => resolve(fileName));\n    stream.on('error', reject);\n  });\n};\n\nconst getAllEmployeesContext = async () => {\n  try {\n    const employees = await Employee.find({ status: 'Active' })\n      .populate('user', 'name email role')\n      .populate('workInfo.department', 'name')\n      .lean();\n\n    if (!employees || employees.length === 0) {\n      return 'No employee data available.';\n    }\n\n    const departments = await Department.find().lean();\n    const deptMap = {};\n    departments.forEach(d => {\n      deptMap[d._id.toString()] = d.name;\n    });\n\n    const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);\n    const endOfMonth = new Date();\n\n    let contextParts = [];\n    contextParts.push(`=== ORGANIZATION OVERVIEW ===`);\n    contextParts.push(`Total Active Employees: ${employees.length}`);\n    contextParts.push(`Departments: ${departments.map(d => d.name).join(', ')}`);\n    contextParts.push('');\n\n    const deptCounts = {};\n    employees.forEach(emp => {\n      const deptName = emp.workInfo?.department?.name || 'Unassigned';\n      deptCounts[deptName] = (deptCounts[deptName] || 0) + 1;\n    });\n    contextParts.push(`Department Distribution:`);\n    Object.entries(deptCounts).forEach(([dept, count]) => {\n      contextParts.push(`  - ${dept}: ${count} employees`);\n    });\n    contextParts.push('');\n\n    contextParts.push(`=== EMPLOYEE DETAILS ===`);\n    \n    for (const emp of employees) {\n      const attendance = await Attendance.find({\n        $or: [\n          { employee: emp._id },\n          { user: emp.user?._id }\n        ],\n        date: { $gte: startOfMonth, $lte: endOfMonth }\n      }).lean();\n\n      const presentDays = attendance.filter(a => \n        ['present', 'Present', 'late', 'Late'].includes(a.status)\n      ).length;\n\n      const leaves = await Leave.find({\n        $or: [\n          { employee: emp._id },\n          { user: emp.user?._id }\n        ]\n      }).lean();\n\n      const pendingLeaves = leaves.filter(l => l.status === 'pending').length;\n      const approvedLeaves = leaves.filter(l => l.status === 'approved').length;\n\n      const deptName = emp.workInfo?.department?.name || 'Unassigned';\n      \n      contextParts.push(`---`);\n      contextParts.push(`Employee ID: ${emp.employeeId}`);\n      contextParts.push(`Name: ${emp.personalInfo?.firstName} ${emp.personalInfo?.lastName}`);\n      contextParts.push(`Email: ${emp.user?.email || emp.contactInfo?.personalEmail || 'N/A'}`);\n      contextParts.push(`Phone: ${emp.contactInfo?.phone || 'N/A'}`);\n      contextParts.push(`Department: ${deptName}`);\n      contextParts.push(`Position: ${emp.workInfo?.position || 'N/A'}`);\n      contextParts.push(`Employment Type: ${emp.workInfo?.employmentType || 'Full-time'}`);\n      contextParts.push(`Work Location: ${emp.workInfo?.workLocation || 'Office'}`);\n      contextParts.push(`Joining Date: ${emp.workInfo?.joiningDate ? new Date(emp.workInfo.joiningDate).toLocaleDateString() : 'N/A'}`);\n      contextParts.push(`Status: ${emp.status}`);\n      contextParts.push(`Basic Salary: ₹${emp.salaryInfo?.basicSalary?.toLocaleString() || 'N/A'}`);\n      contextParts.push(`Leave Balance: ${emp.leaveBalance?.remaining || 0} days remaining`);\n      contextParts.push(`Attendance This Month: ${presentDays} days present`);\n      contextParts.push(`Pending Leave Requests: ${pendingLeaves}`);\n      contextParts.push(`Total Approved Leaves: ${approvedLeaves}`);\n      \n      if (emp.personalInfo?.gender) {\n        contextParts.push(`Gender: ${emp.personalInfo.gender}`);\n      }\n      if (emp.personalInfo?.dateOfBirth) {\n        const age = Math.floor((new Date() - new Date(emp.personalInfo.dateOfBirth)) / (365.25 * 24 * 60 * 60 * 1000));\n        contextParts.push(`Age: ${age} years`);\n      }\n      if (emp.workInfo?.skills && emp.workInfo.skills.length > 0) {\n        contextParts.push(`Skills: ${emp.workInfo.skills.join(', ')}`);\n      }\n      contextParts.push('');\n    }\n\n    return contextParts.join('\\n');\n  } catch (error) {\n    console.error('Error getting all employees context:', error);\n    return 'Error loading employee data.';\n  }\n};\n\nconst getDetailedEmployeeContext = async (userId) => {\n  try {\n    const user = await User.findById(userId).populate('employeeId');\n    if (!user) return '';\n\n    const employee = await Employee.findOne({ user: userId })\n      .populate('workInfo.department', 'name')\n      .lean();\n\n    let contextParts = [];\n    \n    if (employee) {\n      contextParts.push(`=== YOUR EMPLOYEE PROFILE ===`);\n      contextParts.push(`Employee ID: ${employee.employeeId}`);\n      contextParts.push(`Name: ${employee.personalInfo?.firstName} ${employee.personalInfo?.lastName}`);\n      contextParts.push(`Email: ${user.email}`);\n      contextParts.push(`Phone: ${employee.contactInfo?.phone || 'N/A'}`);\n      contextParts.push(`Department: ${employee.workInfo?.department?.name || 'N/A'}`);\n      contextParts.push(`Position: ${employee.workInfo?.position || 'N/A'}`);\n      contextParts.push(`Employment Type: ${employee.workInfo?.employmentType || 'Full-time'}`);\n      contextParts.push(`Work Location: ${employee.workInfo?.workLocation || 'Office'}`);\n      contextParts.push(`Joining Date: ${employee.workInfo?.joiningDate ? new Date(employee.workInfo.joiningDate).toLocaleDateString() : 'N/A'}`);\n      contextParts.push(`Status: ${employee.status}`);\n      contextParts.push('');\n      \n      contextParts.push(`=== SALARY INFORMATION ===`);\n      contextParts.push(`Basic Salary: ₹${employee.salaryInfo?.basicSalary?.toLocaleString() || 'N/A'}`);\n      contextParts.push(`HRA: ₹${employee.salaryInfo?.allowances?.hra?.toLocaleString() || '0'}`);\n      contextParts.push(`Medical Allowance: ₹${employee.salaryInfo?.allowances?.medical?.toLocaleString() || '0'}`);\n      contextParts.push(`Transport Allowance: ₹${employee.salaryInfo?.allowances?.transport?.toLocaleString() || '0'}`);\n      contextParts.push(`PF Deduction: ₹${employee.salaryInfo?.deductions?.pf?.toLocaleString() || '0'}`);\n      contextParts.push(`Tax Deduction: ₹${employee.salaryInfo?.deductions?.tax?.toLocaleString() || '0'}`);\n      contextParts.push('');\n\n      contextParts.push(`=== LEAVE BALANCE ===`);\n      contextParts.push(`Total Leaves: ${employee.leaveBalance?.total || 30} days`);\n      contextParts.push(`Used Leaves: ${employee.leaveBalance?.used || 0} days`);\n      contextParts.push(`Remaining Leaves: ${employee.leaveBalance?.remaining || 30} days`);\n      contextParts.push('');\n    } else {\n      contextParts.push(`Employee Name: ${user.fullName || user.name || 'Unknown'}`);\n      contextParts.push(`Employee ID: ${getEmployeeId(user)}`);\n    }\n\n    const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);\n    const endOfMonth = new Date();\n    \n    const attendance = await Attendance.find({\n      $or: [\n        { employee: employee?._id },\n        { user: userId }\n      ],\n      date: { $gte: startOfMonth, $lte: endOfMonth }\n    }).lean();\n    \n    if (attendance.length > 0) {\n      const present = attendance.filter(a => \n        ['present', 'Present', 'late', 'Late'].includes(a.status)\n      ).length;\n      const late = attendance.filter(a => \n        ['late', 'Late'].includes(a.status)\n      ).length;\n      const absent = attendance.filter(a => \n        ['absent', 'Absent'].includes(a.status)\n      ).length;\n\n      contextParts.push(`=== ATTENDANCE THIS MONTH ===`);\n      contextParts.push(`Total Working Days: ${attendance.length}`);\n      contextParts.push(`Present: ${present} days`);\n      contextParts.push(`Late: ${late} days`);\n      contextParts.push(`Absent: ${absent} days`);\n      contextParts.push('');\n    }\n\n    const leaves = await Leave.find({ \n      $or: [\n        { employee: employee?._id },\n        { user: userId }\n      ]\n    }).sort({ createdAt: -1 }).limit(5).lean();\n    \n    if (leaves.length > 0) {\n      contextParts.push(`=== RECENT LEAVE REQUESTS ===`);\n      leaves.forEach(leave => {\n        contextParts.push(`- ${leave.leaveType || 'Leave'}: ${new Date(leave.startDate).toLocaleDateString()} to ${new Date(leave.endDate).toLocaleDateString()} - Status: ${leave.status}`);\n      });\n      contextParts.push('');\n    }\n\n    return contextParts.join('\\n');\n  } catch (error) {\n    console.error('Error getting detailed employee context:', error);\n    return '';\n  }\n};\n\nexport const processBotMessage = async (text, userId, isAdmin = false) => {\n  try {\n    console.log('Bot processing message:', text, 'for user:', userId, 'isAdmin:', isAdmin);\n    \n    const user = await User.findById(userId);\n    if (!user) {\n      console.error('User not found:', userId);\n      return { \n        response: 'Sorry, I cannot find your profile. Please contact HR support.', \n        intent: 'error' \n      };\n    }\n\n    let contextData = '';\n    let systemPrompt = '';\n\n    if (isAdmin) {\n      contextData = await getAllEmployeesContext();\n      systemPrompt = ADMIN_HR_CONTEXT;\n    } else {\n      contextData = await getDetailedEmployeeContext(userId);\n      systemPrompt = EMPLOYEE_HR_CONTEXT;\n    }\n    \n    let response = '';\n    \n    const groq = getGroqClient();\n    if (!groq) {\n      console.log('Groq client not available, using fallback');\n      response = getFallbackResponse(text, user, contextData, isAdmin);\n    } else {\n      try {\n        console.log('Sending request to Groq API with model llama-3.1-8b-instant');\n        const chatCompletion = await groq.chat.completions.create({\n          messages: [\n            {\n              role: 'system',\n              content: systemPrompt\n            },\n            {\n              role: 'system',\n              content: `${isAdmin ? 'ALL EMPLOYEE DATA' : 'YOUR EMPLOYEE DATA'}:\\n${contextData}`\n            },\n            {\n              role: 'user',\n              content: text\n            }\n          ],\n          model: 'llama-3.1-8b-instant',\n          temperature: 0.7,\n          max_tokens: 2048,\n          top_p: 1,\n          stream: false\n        });\n\n        response = chatCompletion.choices[0]?.message?.content || 'Sorry, I could not generate a response. Please try again.';\n        \n        if (response.includes('[GENERATE_SALARY_SLIP]')) {\n          try {\n            const fileName = await generateSalarySlipPDF(user);\n            response = response.replace('[GENERATE_SALARY_SLIP]', `\\n\\n✅ Your salary slip is ready! [Download here](/api/bot/download/${fileName})`);\n          } catch (err) {\n            console.error('Salary slip generation error:', err);\n            response = response.replace('[GENERATE_SALARY_SLIP]', '\\n\\n❌ Failed to generate salary slip. Please try again later.');\n          }\n        }\n        \n        if (response.includes('[GENERATE_APPRAISAL_LETTER]')) {\n          try {\n            const fileName = await generateAppraisalLetterPDF(user);\n            response = response.replace('[GENERATE_APPRAISAL_LETTER]', `\\n\\n✅ Your appraisal letter is ready! [Download here](/api/bot/download/${fileName})`);\n          } catch (err) {\n            console.error('Appraisal letter generation error:', err);\n            response = response.replace('[GENERATE_APPRAISAL_LETTER]', '\\n\\n❌ Failed to generate appraisal letter. Please try again later.');\n          }\n        }\n      } catch (groqError) {\n        console.error('Groq API error:', groqError);\n        response = getFallbackResponse(text, user, contextData, isAdmin);\n      }\n    }\n\n    await new Message({\n      from: null,\n      to: userId,\n      text: response,\n      fromBot: true\n    }).save();\n\n    return { response, intent: 'groq_response' };\n\n  } catch (error) {\n    console.error('Bot processing error:', error);\n    return { \n      response: 'Sorry, I encountered an unexpected error. Please try again or contact HR support.', \n      intent: 'error' \n    };\n  }\n};\n\nconst getFallbackResponse = (text, user, contextData, isAdmin = false) => {\n  const lowerText = text.toLowerCase();\n  \n  if (lowerText.includes('hello') || lowerText.includes('hi') || lowerText.includes('hey')) {\n    if (isAdmin) {\n      return `Hello Admin! 👋 I'm your HR Admin Assistant with access to all employee data.\\n\\nYou can ask me about:\\n• **Employee information** (e.g., \"What is John's salary?\")\\n• **Department statistics** (e.g., \"How many employees in Engineering?\")\\n• **Attendance reports** (e.g., \"Show attendance for EMP001\")\\n• **Leave requests** (e.g., \"Who is on leave today?\")\\n• **Salary & payroll** information\\n\\nHow can I help you today?`;\n    }\n    return `Hello! 👋 I'm your HR Assistant. How can I help you today?\\n\\nYou can ask me about:\\n• **Your attendance** and **leave balance**\\n• **HR policies** (leave, salary, working hours)\\n• **Generate documents** (salary slip, appraisal letter)\\n• **Your profile** and **salary information**`;\n  }\n  \n  if (lowerText.includes('leave') && (lowerText.includes('policy') || lowerText.includes('policies'))) {\n    return 'Our leave policy allows **21 annual leaves**, **10 sick leaves**, and **5 casual leaves** per year. Unused leaves can be carried forward up to a maximum of 15 days.';\n  }\n  \n  if (lowerText.includes('leave') && (lowerText.includes('balance') || lowerText.includes('remaining'))) {\n    const match = contextData.match(/Remaining Leaves?: (\\d+)/i);\n    if (match) {\n      return `You have **${match[1]} leave days** remaining this year.`;\n    }\n    return 'I cannot access leave records right now. Please check your dashboard or contact HR.';\n  }\n  \n  if (lowerText.includes('attendance')) {\n    const match = contextData.match(/Present: (\\d+) days/i);\n    if (match) {\n      return `Attendance this month: **${match[1]} days present**.`;\n    }\n    return 'No attendance records found for this month.';\n  }\n  \n  if (lowerText.includes('salary') && lowerText.includes('slip')) {\n    return 'I can generate your salary slip! Please wait while I prepare it... [GENERATE_SALARY_SLIP]';\n  }\n  \n  if (lowerText.includes('appraisal') && lowerText.includes('letter')) {\n    return 'I can generate your appraisal letter! Please wait... [GENERATE_APPRAISAL_LETTER]';\n  }\n  \n  if (lowerText.includes('salary') || lowerText.includes('pay')) {\n    const match = contextData.match(/Basic Salary: ₹([\\d,]+)/);\n    if (match) {\n      return `Your basic salary is **₹${match[1]}**. Salaries are credited on the 1st of every month.`;\n    }\n    return 'Salaries are credited on the **1st of every month** to your registered bank account. If the 1st is a holiday, it will be credited on the next working day.';\n  }\n  \n  if (lowerText.includes('working hours') || lowerText.includes('work hours')) {\n    return 'Standard working hours are **9:00 AM to 6:00 PM**, Monday to Friday. Flexible hours can be arranged with manager approval.';\n  }\n  \n  if (isAdmin) {\n    if (lowerText.includes('employee') || lowerText.includes('total') || lowerText.includes('count')) {\n      const match = contextData.match(/Total Active Employees: (\\d+)/);\n      if (match) {\n        return `There are **${match[1]} active employees** in the organization.`;\n      }\n    }\n    return 'As Admin HR Assistant, I can help you with:\\n• **Employee details** - Ask about any employee by name or ID\\n• **Department statistics** - Team sizes, distribution\\n• **Attendance reports** - Individual or team attendance\\n• **Leave management** - Pending requests, balances\\n• **Salary information** - Compensation details\\n\\nPlease ask a specific question!';\n  }\n  \n  return 'I can help with HR-related questions about:\\n• **Leave policies** and your balance\\n• **Your attendance** records\\n• **Your salary** information\\n• **Working hours** and policies\\n• **Document generation** (salary slip, appraisal letter)\\n\\nPlease ask me about any of these topics!';\n};\n\nexport const processMessage = async (req, res) => {\n  const { text, userId } = req.body;\n  const isAdmin = req.user?.role === 'admin';\n\n  await new Message({\n    from: userId,\n    to: userId,\n    text: text.trim()\n  }).save();\n\n  const { response } = await processBotMessage(text, userId, isAdmin);\n  res.json({ success: true, response });\n};\n\nexport const processAdminMessage = async (req, res) => {\n  const { text } = req.body;\n  const userId = req.user.id;\n\n  if (req.user.role !== 'admin') {\n    return res.status(403).json({ success: false, message: 'Admin access required' });\n  }\n\n  await new Message({\n    from: userId,\n    to: userId,\n    text: text.trim()\n  }).save();\n\n  const { response } = await processBotMessage(text, userId, true);\n  res.json({ success: true, response });\n};\n\nexport const getBotHistory = async (req, res) => {\n  try {\n    const { userId } = req.params;\n    const messages = await Message.find({\n      $or: [\n        { to: userId, fromBot: true },\n        { from: userId }\n      ]\n    }).sort({ timestamp: 1 });\n\n    res.json({ success: true, messages });\n  } catch (error) {\n    res.status(500).json({ success: false, message: 'Failed to load history' });\n  }\n};\n","path":null,"size_bytes":22627,"size_tokens":null},"frontend/src/components/Admin/Dashboard/WelcomeSection.jsx":{"content":"// components/Dashboard/WelcomeSection.js\nimport React, { useMemo } from 'react';\n\nconst WelcomeSection = ({ userName = 'Admin' }) => {\n  const formattedDate = useMemo(() => {\n    return new Date().toLocaleDateString('en-US', { \n      weekday: 'long', \n      year: 'numeric', \n      month: 'long', \n      day: 'numeric' \n    });\n  }, []);\n\n  const currentTime = useMemo(() => {\n    return new Date().toLocaleTimeString('en-US', {\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  }, []);\n\n  return (\n    <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold text-white mb-2\">\n            Welcome back, <span className=\"neon-text\">{userName}!</span>\n          </h1>\n          <p className=\"text-secondary-400\">Here's what's happening in your company today.</p>\n        </div>\n        <div className=\"hidden md:flex items-center space-x-6\">\n          <div className=\"text-right\">\n            <p className=\"text-sm text-secondary-400\">Today's Date</p>\n            <p className=\"text-lg font-semibold text-white\">\n              {formattedDate}\n            </p>\n          </div>\n          <div className=\"text-right\">\n            <p className=\"text-sm text-secondary-400\">Current Time</p>\n            <p className=\"text-lg font-semibold text-neon-pink\">\n              {currentTime}\n            </p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default WelcomeSection;","path":null,"size_bytes":1519,"size_tokens":null},"SETUP_AND_DEPLOYMENT.md":{"content":"# Employee Management System - Setup and Deployment Guide\n\n## Project Overview\nA full-stack Employee Management System with React frontend and Node.js/Express backend using MongoDB.\n\n---\n\n## Running Locally\n\n### Prerequisites\n- Node.js v18+ installed\n- MongoDB database (local or cloud like MongoDB Atlas)\n- Git\n\n### Step 1: Clone the Repository\n```bash\ngit clone <your-repo-url>\ncd employee-management-system\n```\n\n### Step 2: Backend Setup\n\n1. Navigate to backend folder:\n```bash\ncd backend\n```\n\n2. Install dependencies:\n```bash\nnpm install\n```\n\n3. Create `.env` file in the backend folder:\n```env\n# MongoDB Connection\nMONGODB_URI=mongodb+srv://<username>:<password>@cluster.mongodb.net/employee_management\n\n# JWT Secret (generate a random string)\nJWT_SECRET=your-super-secret-jwt-key-here\n\n# Server Port\nPORT=3001\n\n# Email Configuration (for password reset)\nEMAIL_HOST=smtp.gmail.com\nEMAIL_PORT=587\nEMAIL_USER=your-email@gmail.com\nEMAIL_PASS=your-app-password\n\n# Google AI (optional - for AI chatbot)\nGOOGLE_AI_API_KEY=your-google-ai-api-key\n```\n\n4. Start the backend server:\n```bash\nnpm run dev\n# Or for production:\nnpm start\n```\n\nThe backend will run on `http://localhost:3001`\n\n### Step 3: Frontend Setup\n\n1. Navigate to frontend folder:\n```bash\ncd frontend\n```\n\n2. Install dependencies:\n```bash\nnpm install\n```\n\n3. Start the development server:\n```bash\nnpm run dev\n```\n\nThe frontend will run on `http://localhost:5000`\n\n### Step 4: Access the Application\nOpen `http://localhost:5000` in your browser.\n\n**Demo Credentials:**\n- Admin: `admin@gmail.com` / `admin`\n- Employee: Use email with Employee ID as password\n\n---\n\n## Deployment\n\n### Option A: Deploy Backend on Render\n\n1. **Create Render Account**: Go to [render.com](https://render.com)\n\n2. **Create New Web Service**:\n   - Connect your GitHub repository\n   - Select the repository\n\n3. **Configure Build Settings**:\n   - **Name**: `employee-management-api`\n   - **Root Directory**: `backend`\n   - **Environment**: `Node`\n   - **Build Command**: `npm install`\n   - **Start Command**: `npm start`\n\n4. **Add Environment Variables** in Render dashboard:\n   ```\n   MONGODB_URI=mongodb+srv://...\n   JWT_SECRET=your-production-secret\n   PORT=3001\n   NODE_ENV=production\n   EMAIL_HOST=smtp.gmail.com\n   EMAIL_PORT=587\n   EMAIL_USER=your-email@gmail.com\n   EMAIL_PASS=your-app-password\n   ```\n\n5. Click **Deploy**. Note your backend URL (e.g., `https://employee-management-api.onrender.com`)\n\n### Option B: Deploy Frontend on Netlify\n\n1. **Create Netlify Account**: Go to [netlify.com](https://netlify.com)\n\n2. **Update Frontend API URL**:\n   \n   Edit `frontend/src/services/api.js`:\n   ```javascript\n   const API = axios.create({\n     baseURL: 'https://your-render-backend-url.onrender.com/api',\n     headers: {\n       'Content-Type': 'application/json'\n     }\n   });\n   ```\n\n   Or use environment variable:\n   ```javascript\n   const API = axios.create({\n     baseURL: import.meta.env.VITE_API_URL || '/api',\n   });\n   ```\n\n3. **Build the Frontend**:\n   ```bash\n   cd frontend\n   npm run build\n   ```\n\n4. **Deploy to Netlify**:\n   \n   **Option 1 - Drag & Drop**:\n   - Go to Netlify dashboard\n   - Drag the `frontend/dist` folder to deploy\n\n   **Option 2 - Connect GitHub**:\n   - Click \"New site from Git\"\n   - Connect your GitHub repository\n   - Configure:\n     - **Base directory**: `frontend`\n     - **Build command**: `npm run build`\n     - **Publish directory**: `frontend/dist`\n\n5. **Add Environment Variables** in Netlify:\n   ```\n   VITE_API_URL=https://your-render-backend-url.onrender.com/api\n   ```\n\n6. **Configure Redirects** for SPA routing:\n   \n   Create `frontend/public/_redirects`:\n   ```\n   /*    /index.html   200\n   ```\n\n7. **Deploy**. Your frontend will be at `https://your-app.netlify.app`\n\n---\n\n## Environment Variables Summary\n\n### Backend (.env)\n| Variable | Description | Example |\n|----------|-------------|---------|\n| MONGODB_URI | MongoDB connection string | `mongodb+srv://...` |\n| JWT_SECRET | Secret for JWT tokens | Random string |\n| PORT | Server port | `3001` |\n| NODE_ENV | Environment | `development` or `production` |\n| EMAIL_HOST | SMTP host | `smtp.gmail.com` |\n| EMAIL_PORT | SMTP port | `587` |\n| EMAIL_USER | Email address | `your@email.com` |\n| EMAIL_PASS | Email app password | App-specific password |\n\n### Frontend (Netlify)\n| Variable | Description | Example |\n|----------|-------------|---------|\n| VITE_API_URL | Backend API URL | `https://api.example.com/api` |\n\n---\n\n## Troubleshooting\n\n### CORS Issues\nIf you get CORS errors, ensure your backend allows your frontend domain:\n```javascript\n// In backend/server.js\napp.use(cors({\n  origin: ['https://your-netlify-app.netlify.app', 'http://localhost:5000'],\n  credentials: true\n}));\n```\n\n### MongoDB Connection Issues\n- Ensure your IP is whitelisted in MongoDB Atlas\n- For Render, add `0.0.0.0/0` to allow all IPs\n\n### Build Failures\n- Check Node.js version matches (v18+)\n- Clear npm cache: `npm cache clean --force`\n- Delete node_modules and reinstall\n\n---\n\n## Support\nFor issues, check the browser console and server logs for error messages.","path":null,"size_bytes":5095,"size_tokens":null},"frontend/src/components/Common/LoadingSpinner.jsx":{"content":"// components/Common/LoadingSpinner.js\nimport React from 'react';\n\nconst LoadingSpinner = ({ \n  message = \"Loading...\", \n  size = \"large\", \n  color = \"neon-pink\",\n  showMessage = true \n}) => {\n  const sizeClasses = {\n    small: \"w-6 h-6\",\n    medium: \"w-12 h-12\",\n    large: \"w-16 h-16\"\n  };\n\n  const colorClasses = {\n    'neon-pink': 'border-neon-pink',\n    'neon-purple': 'border-neon-purple',\n    'white': 'border-white',\n    'gray': 'border-gray-400'\n  };\n\n  return (\n    <div className=\"flex flex-col items-center justify-center min-h-[200px]\">\n      {/* Spinner */}\n      <div className=\"relative\">\n        <div className={`${sizeClasses[size]} border-4 border-transparent border-t-4 ${colorClasses[color]} rounded-full animate-spin`}></div>\n        <div className={`absolute inset-0 ${sizeClasses[size]} border-4 border-transparent border-r-4 ${colorClasses[color]} rounded-full animate-spin`} style={{ animationDirection: 'reverse', animationDuration: '1.5s' }}></div>\n      </div>\n      \n      {/* Message */}\n      {showMessage && (\n        <div className=\"mt-4 text-center\">\n          <p className=\"text-white text-lg font-medium\">{message}</p>\n          <div className=\"flex items-center justify-center mt-2 space-x-1\">\n            <div className=\"w-2 h-2 bg-neon-pink rounded-full animate-bounce\" style={{ animationDelay: '0ms' }}></div>\n            <div className=\"w-2 h-2 bg-neon-pink rounded-full animate-bounce\" style={{ animationDelay: '150ms' }}></div>\n            <div className=\"w-2 h-2 bg-neon-pink rounded-full animate-bounce\" style={{ animationDelay: '300ms' }}></div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default LoadingSpinner;","path":null,"size_bytes":1684,"size_tokens":null},"frontend/src/pages/Admin/AdminSettings.jsx":{"content":"import React, { useState } from 'react';\nimport { Settings, Bell, Lock, Palette, Globe, Save } from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport AdminLayout from '../../components/Admin/layout/AdminLayout';\n\nconst AdminSettings = () => {\n  const [settings, setSettings] = useState({\n    emailNotifications: true,\n    pushNotifications: true,\n    twoFactorAuth: false,\n    darkMode: true,\n    language: 'en'\n  });\n  const [saving, setSaving] = useState(false);\n\n  const handleToggle = (key) => {\n    setSettings(prev => ({\n      ...prev,\n      [key]: !prev[key]\n    }));\n  };\n\n  const handleSave = async () => {\n    setSaving(true);\n    try {\n      await new Promise(resolve => setTimeout(resolve, 1000));\n      localStorage.setItem('userSettings', JSON.stringify(settings));\n      toast.success('Settings saved successfully');\n    } catch (error) {\n      toast.error('Failed to save settings');\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const ToggleSwitch = ({ enabled, onToggle }) => (\n    <button\n      onClick={onToggle}\n      className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${\n        enabled ? 'bg-gradient-to-r from-neon-pink to-neon-purple' : 'bg-secondary-600'\n      }`}\n    >\n      <span\n        className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${\n          enabled ? 'translate-x-6' : 'translate-x-1'\n        }`}\n      />\n    </button>\n  );\n\n  return (\n    <AdminLayout>\n      <div className=\"max-w-2xl mx-auto\">\n        <div className=\"mb-6\">\n          <h1 className=\"text-2xl font-bold text-white\">Settings</h1>\n          <p className=\"text-secondary-400 mt-1\">Manage your application preferences</p>\n        </div>\n\n        <div className=\"space-y-6\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center space-x-3 mb-6\">\n              <Bell className=\"w-6 h-6 text-neon-pink\" />\n              <h2 className=\"text-lg font-semibold text-white\">Notifications</h2>\n            </div>\n\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between py-3 border-b border-secondary-700\">\n                <div>\n                  <p className=\"text-white font-medium\">Email Notifications</p>\n                  <p className=\"text-sm text-secondary-400\">Receive email updates about activity</p>\n                </div>\n                <ToggleSwitch \n                  enabled={settings.emailNotifications} \n                  onToggle={() => handleToggle('emailNotifications')} \n                />\n              </div>\n\n              <div className=\"flex items-center justify-between py-3\">\n                <div>\n                  <p className=\"text-white font-medium\">Push Notifications</p>\n                  <p className=\"text-sm text-secondary-400\">Receive push notifications on your device</p>\n                </div>\n                <ToggleSwitch \n                  enabled={settings.pushNotifications} \n                  onToggle={() => handleToggle('pushNotifications')} \n                />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center space-x-3 mb-6\">\n              <Lock className=\"w-6 h-6 text-neon-purple\" />\n              <h2 className=\"text-lg font-semibold text-white\">Security</h2>\n            </div>\n\n            <div className=\"flex items-center justify-between py-3\">\n              <div>\n                <p className=\"text-white font-medium\">Two-Factor Authentication</p>\n                <p className=\"text-sm text-secondary-400\">Add an extra layer of security</p>\n              </div>\n              <ToggleSwitch \n                enabled={settings.twoFactorAuth} \n                onToggle={() => handleToggle('twoFactorAuth')} \n              />\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center space-x-3 mb-6\">\n              <Palette className=\"w-6 h-6 text-neon-pink\" />\n              <h2 className=\"text-lg font-semibold text-white\">Appearance</h2>\n            </div>\n\n            <div className=\"flex items-center justify-between py-3\">\n              <div>\n                <p className=\"text-white font-medium\">Dark Mode</p>\n                <p className=\"text-sm text-secondary-400\">Use dark theme throughout the app</p>\n              </div>\n              <ToggleSwitch \n                enabled={settings.darkMode} \n                onToggle={() => handleToggle('darkMode')} \n              />\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center space-x-3 mb-6\">\n              <Globe className=\"w-6 h-6 text-neon-purple\" />\n              <h2 className=\"text-lg font-semibold text-white\">Language</h2>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                Select Language\n              </label>\n              <select\n                value={settings.language}\n                onChange={(e) => setSettings(prev => ({ ...prev, language: e.target.value }))}\n                className=\"w-full py-3 px-4 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 transition-all\"\n              >\n                <option value=\"en\">English</option>\n                <option value=\"es\">Spanish</option>\n                <option value=\"fr\">French</option>\n                <option value=\"de\">German</option>\n                <option value=\"hi\">Hindi</option>\n              </select>\n            </div>\n          </div>\n\n          <button\n            onClick={handleSave}\n            disabled={saving}\n            className=\"w-full py-3 px-4 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 disabled:opacity-50 flex items-center justify-center space-x-2\"\n          >\n            {saving ? (\n              <span className=\"flex items-center\">\n                <svg className=\"animate-spin -ml-1 mr-3 h-5 w-5 text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                  <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                </svg>\n                Saving...\n              </span>\n            ) : (\n              <>\n                <Save className=\"w-5 h-5\" />\n                <span>Save Settings</span>\n              </>\n            )}\n          </button>\n        </div>\n      </div>\n    </AdminLayout>\n  );\n};\n\nexport default AdminSettings;","path":null,"size_bytes":6970,"size_tokens":null},"backend/middleware/authMiddleware.js":{"content":"import jwt from \"jsonwebtoken\";\nimport User from \"../models/User.js\";\nimport Employee from \"../models/Employee.js\";\n\n// Protect routes - verify JWT token\nexport const protect = async (req, res, next) => {\n  let token;\n\n  try {\n    // Get token from header\n    if (req.headers.authorization && req.headers.authorization.startsWith(\"Bearer\")) {\n      token = req.headers.authorization.split(\" \")[1];\n    }\n\n    // Make sure token exists\n    if (!token) {\n      return res.status(401).json({ \n        success: false, \n        message: \"Not authorized, no token provided\" \n      });\n    }\n\n    // Verify token\n    const decoded = jwt.verify(token, process.env.JWT_SECRET);\n\n    // Get user from token\n    const user = await User.findById(decoded.id).select('-password');\n\n    if (!user) {\n      return res.status(401).json({ \n        success: false, \n        message: \"Not authorized, user not found\" \n      });\n    }\n\n    // Check if user is active\n    if (!user.isActive) {\n      return res.status(401).json({ \n        success: false, \n        message: \"Account is deactivated. Please contact administrator.\" \n      });\n    }\n\n    // Add user to request object\n    req.user = user;\n    next();\n\n  } catch (error) {\n    console.error('Auth middleware error:', error);\n\n    if (error.name === 'JsonWebTokenError') {\n      return res.status(401).json({ \n        success: false, \n        message: \"Not authorized, invalid token\" \n      });\n    } else if (error.name === 'TokenExpiredError') {\n      return res.status(401).json({ \n        success: false, \n        message: \"Not authorized, token expired\" \n      });\n    } else {\n      return res.status(401).json({ \n        success: false, \n        message: \"Not authorized, token failed\" \n      });\n    }\n  }\n};\n\n// Admin only middleware\nexport const adminOnly = (req, res, next) => {\n  console.log('adminOnly middleware - User:', req.user?.email, 'Role:', req.user?.role);\n\n  if (!req.user) {\n    console.log('Access denied - no user found');\n    return res.status(401).json({\n      success: false,\n      message: \"Not authorized, user not found\"\n    });\n  }\n\n  if (req.user.role !== 'admin') {\n    console.log('Access denied - user is not admin');\n    return res.status(403).json({\n      success: false,\n      message: \"Access denied. Admin privileges required.\"\n    });\n  }\n\n  console.log('Admin access granted');\n  next();\n};\n\n// Employee or Admin middleware (for routes accessible to both)\nexport const employeeOrAdmin = (req, res, next) => {\n  if (!req.user) {\n    return res.status(401).json({\n      success: false,\n      message: \"Not authorized, user not found\"\n    });\n  }\n\n  if (req.user.role !== 'admin' && req.user.role !== 'employee') {\n    return res.status(403).json({\n      success: false,\n      message: \"Access denied. Employee or Admin privileges required.\"\n    });\n  }\n\n  next();\n};\n\n// Employee only middleware - checks if user has associated employee record\nexport const employeeOnly = async (req, res, next) => {\n  if (!req.user) {\n    return res.status(401).json({\n      success: false,\n      message: \"Not authorized, user not found\"\n    });\n  }\n\n  try {\n    // Check if user has an associated employee record\n    let employee = await Employee.findOne({ user: req.user.id });\n    if (!employee) {\n      // Create a basic employee record for authenticated users\n      // Get default department\n      const Department = (await import('../models/Department.js')).default;\n      let defaultDepartment = await Department.findOne();\n      if (!defaultDepartment) {\n        defaultDepartment = new Department({\n          name: 'General',\n          code: 'GEN',\n          description: 'Default department'\n        });\n        await defaultDepartment.save();\n      }\n\n      employee = new Employee({\n        user: req.user.id,\n        personalInfo: {\n          firstName: req.user.name?.split(' ')[0] || 'Employee',\n          lastName: req.user.name?.split(' ').slice(1).join(' ') || 'User',\n          dateOfBirth: new Date('1990-01-01'),\n          gender: 'Male'\n        },\n        contactInfo: {\n          phone: '0000000000',\n          personalEmail: req.user.email,\n          emergencyContact: {\n            name: 'Emergency Contact',\n            relationship: 'Relative',\n            phone: '0000000000'\n          }\n        },\n        workInfo: {\n          position: 'Employee',\n          department: defaultDepartment._id,\n          joiningDate: new Date()\n        },\n        salaryInfo: {\n          basicSalary: 0\n        },\n        status: 'Active'\n      });\n      await employee.save();\n      console.log(`Created new employee record for user ${req.user.id}`);\n    }\n\n    // Add employee to request object for convenience\n    req.employee = employee;\n    next();\n  } catch (error) {\n    console.error('Employee check error:', error);\n    return res.status(500).json({\n      success: false,\n      message: \"Server error during authorization check\"\n    });\n  }\n};\n\n// Optional middleware to get user if token is provided (doesn't fail if no token)\nexport const optionalAuth = async (req, res, next) => {\n  let token;\n\n  try {\n    // Get token from header\n    if (req.headers.authorization && req.headers.authorization.startsWith(\"Bearer\")) {\n      token = req.headers.authorization.split(\" \")[1];\n    }\n\n    // If no token, continue without user\n    if (!token) {\n      return next();\n    }\n\n    // Verify token\n    const decoded = jwt.verify(token, process.env.JWT_SECRET);\n\n    // Get user from token\n    const user = await User.findById(decoded.id).select('-password');\n\n    if (user && user.isActive) {\n      req.user = user;\n    }\n\n    next();\n\n  } catch (error) {\n    // If token is invalid, continue without user (don't throw error)\n    console.log('Optional auth failed:', error.message);\n    next();\n  }\n};","path":null,"size_bytes":5783,"size_tokens":null},"frontend/src/services/api.js":{"content":"// services/api.js - Base API configuration\nimport axios from 'axios';\n\nconst API_BASE_URL = '/api';\n\n// Create axios instance\nconst api = axios.create({\n  baseURL: API_BASE_URL,\n  headers: {\n    'Content-Type': 'application/json',\n  },\n});\n\n// Request interceptor to add auth token\napi.interceptors.request.use(\n  (config) => {\n    const token = localStorage.getItem('token');\n    if (token) {\n      config.headers.Authorization = `Bearer ${token}`;\n    }\n    return config;\n  },\n  (error) => {\n    return Promise.reject(error);\n  }\n);\n\n// Response interceptor to handle errors\napi.interceptors.response.use(\n  (response) => response,\n  (error) => {\n    if (error.response?.status === 401) {\n      localStorage.removeItem('token');\n      localStorage.removeItem('user');\n      window.location.href = '/login';\n    }\n    return Promise.reject(error);\n  }\n);\n\nexport default api;","path":null,"size_bytes":878,"size_tokens":null},"backend/models/Group.js":{"content":"import mongoose from 'mongoose';\n\nconst memberSchema = new mongoose.Schema({\n  user: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true\n  },\n  role: {\n    type: String,\n    enum: ['owner', 'admin', 'member'],\n    default: 'member'\n  },\n  joinedAt: {\n    type: Date,\n    default: Date.now\n  },\n  addedBy: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User'\n  }\n}, { _id: false });\n\nconst groupSchema = new mongoose.Schema({\n  name: {\n    type: String,\n    required: true,\n    trim: true,\n    maxlength: 100\n  },\n  description: {\n    type: String,\n    trim: true,\n    maxlength: 500,\n    default: ''\n  },\n  avatar: {\n    type: String,\n    default: null\n  },\n  owner: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true\n  },\n  members: [memberSchema],\n  settings: {\n    onlyAdminsCanSend: {\n      type: Boolean,\n      default: false\n    },\n    onlyAdminsCanAddMembers: {\n      type: Boolean,\n      default: false\n    },\n    onlyAdminsCanEditInfo: {\n      type: Boolean,\n      default: true\n    }\n  },\n  isActive: {\n    type: Boolean,\n    default: true\n  },\n  lastMessage: {\n    text: String,\n    sender: {\n      type: mongoose.Schema.Types.ObjectId,\n      ref: 'User'\n    },\n    timestamp: Date\n  }\n}, {\n  timestamps: true\n});\n\ngroupSchema.index({ owner: 1 });\ngroupSchema.index({ 'members.user': 1 });\ngroupSchema.index({ isActive: 1 });\ngroupSchema.index({ updatedAt: -1 });\n\ngroupSchema.methods.isMember = function(userId) {\n  return this.members.some(m => m.user.toString() === userId.toString());\n};\n\ngroupSchema.methods.isAdmin = function(userId) {\n  const member = this.members.find(m => m.user.toString() === userId.toString());\n  return member && (member.role === 'admin' || member.role === 'owner');\n};\n\ngroupSchema.methods.isOwner = function(userId) {\n  return this.owner.toString() === userId.toString();\n};\n\ngroupSchema.methods.getMemberRole = function(userId) {\n  const member = this.members.find(m => m.user.toString() === userId.toString());\n  return member ? member.role : null;\n};\n\ngroupSchema.methods.canSendMessage = function(userId) {\n  if (!this.isMember(userId)) return false;\n  if (!this.settings.onlyAdminsCanSend) return true;\n  return this.isAdmin(userId);\n};\n\ngroupSchema.methods.canAddMembers = function(userId) {\n  if (!this.isMember(userId)) return false;\n  if (!this.settings.onlyAdminsCanAddMembers) return true;\n  return this.isAdmin(userId);\n};\n\ngroupSchema.methods.canEditInfo = function(userId) {\n  if (!this.isMember(userId)) return false;\n  if (!this.settings.onlyAdminsCanEditInfo) return true;\n  return this.isAdmin(userId);\n};\n\nexport default mongoose.model('Group', groupSchema);\n","path":null,"size_bytes":2685,"size_tokens":null},"frontend/src/components/Common/Modal.jsx":{"content":"import React, { useEffect } from 'react';\nimport { X } from 'lucide-react';\n\n/**\n * Reusable Modal Component with proper backdrop blur and accessibility\n * \n * @param {boolean} isOpen - Controls modal visibility\n * @param {function} onClose - Callback when modal should close\n * @param {string} title - Modal title\n * @param {React.ReactNode} children - Modal content\n * @param {string} size - Modal size: 'sm', 'md', 'lg', 'xl', '2xl', '3xl', '4xl', '5xl', '6xl', 'full'\n * @param {boolean} showCloseButton - Show/hide close button (default: true)\n * @param {boolean} closeOnBackdropClick - Close modal when clicking backdrop (default: true)\n * @param {boolean} closeOnEscape - Close modal when pressing Escape (default: true)\n * @param {string} className - Additional classes for modal content\n */\nconst Modal = ({\n  isOpen,\n  onClose,\n  title,\n  children,\n  size = 'lg',\n  showCloseButton = true,\n  closeOnBackdropClick = true,\n  closeOnEscape = true,\n  className = '',\n  footer = null\n}) => {\n  // Size mappings\n  const sizeClasses = {\n    sm: 'max-w-sm',\n    md: 'max-w-md',\n    lg: 'max-w-lg',\n    xl: 'max-w-xl',\n    '2xl': 'max-w-2xl',\n    '3xl': 'max-w-3xl',\n    '4xl': 'max-w-4xl',\n    '5xl': 'max-w-5xl',\n    '6xl': 'max-w-6xl',\n    full: 'max-w-full'\n  };\n\n  // Handle escape key\n  useEffect(() => {\n    if (!isOpen || !closeOnEscape) return;\n\n    const handleEscape = (e) => {\n      if (e.key === 'Escape') {\n        onClose();\n      }\n    };\n\n    document.addEventListener('keydown', handleEscape);\n    return () => document.removeEventListener('keydown', handleEscape);\n  }, [isOpen, closeOnEscape, onClose]);\n\n  // Prevent body scroll when modal is open\n  useEffect(() => {\n    if (isOpen) {\n      document.body.style.overflow = 'hidden';\n    } else {\n      document.body.style.overflow = 'unset';\n    }\n\n    return () => {\n      document.body.style.overflow = 'unset';\n    };\n  }, [isOpen]);\n\n  if (!isOpen) return null;\n\n  const handleBackdropClick = (e) => {\n    if (closeOnBackdropClick && e.target === e.currentTarget) {\n      onClose();\n    }\n  };\n\n  return (\n    <div\n      className=\"fixed inset-0 z-[9999] flex items-center justify-center p-2 sm:p-4 overflow-y-auto\"\n      onClick={handleBackdropClick}\n    >\n      {/* Enhanced Backdrop with blur */}\n      <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" aria-hidden=\"true\" />\n\n      {/* Modal Content */}\n      <div\n        className={`\n          relative w-full ${sizeClasses[size]} \n          glass-morphism neon-border rounded-2xl \n          shadow-2xl\n          max-h-[95vh] overflow-y-auto\n          ${className}\n        `}\n        role=\"dialog\"\n        aria-modal=\"true\"\n        aria-labelledby=\"modal-title\"\n      >\n        {/* Header */}\n        {(title || showCloseButton) && (\n          <div className=\"sticky top-0 z-10 bg-secondary-900/95 backdrop-blur-sm border-b border-secondary-700 px-4 sm:px-6 py-4 rounded-t-2xl\">\n            <div className=\"flex items-center justify-between\">\n              {title && (\n                <h2 id=\"modal-title\" className=\"text-lg sm:text-xl md:text-2xl font-bold text-white\">\n                  {title}\n                </h2>\n              )}\n              {showCloseButton && (\n                <button\n                  onClick={onClose}\n                  className=\"ml-auto p-2 text-secondary-400 hover:text-white hover:bg-secondary-700 rounded-lg transition-colors\"\n                  aria-label=\"Close modal\"\n                >\n                  <X className=\"w-5 h-5 sm:w-6 sm:h-6\" />\n                </button>\n              )}\n            </div>\n          </div>\n        )}\n\n        {/* Body */}\n        <div className=\"px-4 sm:px-6 py-4 sm:py-6\">\n          {children}\n        </div>\n\n        {/* Footer */}\n        {footer && (\n          <div className=\"sticky bottom-0 z-10 bg-secondary-900/95 backdrop-blur-sm border-t border-secondary-700 px-4 sm:px-6 py-4 rounded-b-2xl\">\n            {footer}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default Modal;\n\n","path":null,"size_bytes":4020,"size_tokens":null},"backend/middleware/validateRequest.js":{"content":"// middleware/validateRequest.js\nimport { validationResult } from 'express-validator';\n\nexport const validateRequest = (req, res, next) => {\n  const errors = validationResult(req);\n  \n  if (!errors.isEmpty()) {\n    const extractedErrors = [];\n    errors.array().map(err => extractedErrors.push({ \n      field: err.path || err.param, \n      message: err.msg \n    }));\n\n    console.log('Validation errors:', extractedErrors);\n\n    return res.status(400).json({\n      success: false,\n      message: 'Validation failed',\n      errors: extractedErrors\n    });\n  }\n\n  next();\n};","path":null,"size_bytes":572,"size_tokens":null},"frontend/src/main.jsx":{"content":"import { StrictMode } from 'react'\nimport { createRoot } from 'react-dom/client'\nimport './index.css'\nimport App from './App.jsx'\n\ncreateRoot(document.getElementById('root')).render(\n  <StrictMode>\n    <App />\n  </StrictMode>,\n)\n","path":null,"size_bytes":229,"size_tokens":null},"frontend/src/pages/Employee/Sales.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { \n  TrendingUp, DollarSign, Target, Award, Activity, \n  UserCheck, Phone, Download, Bell, Plus, AlertCircle,\n  Eye, Calendar, CheckCircle, XCircle, Edit3, Trash2\n} from 'lucide-react';\nimport EmployeeLayout from '../../components/Employee/EmployeeLayout/EmployeeLayout';\nimport { leadAPI } from '../../utils/api';\nimport toast from 'react-hot-toast';\n\nconst SalesPage = () => {\n  // State\n  const [leads, setLeads] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [showViewModal, setShowViewModal] = useState(false);\n  const [showMeetingModal, setShowMeetingModal] = useState(false);\n  const [showWonModal, setShowWonModal] = useState(false);\n  const [selectedLead, setSelectedLead] = useState(null);\n  const [newLead, setNewLead] = useState({\n    firstName: '',\n    lastName: '',\n    email: '',\n    phone: '',\n    company: '',\n    position: '',\n    source: 'Referral',\n    priority: 'Medium',\n    estimatedValue: '',\n    expectedCloseDate: '',\n    nextFollowUpDate: new Date(Date.now() + 24*60*60*1000).toISOString().split('T')[0],\n    notes: ''\n  });\n  const [meetingData, setMeetingData] = useState({\n    type: 'Call',\n    scheduledDate: new Date(Date.now() + 86400000).toISOString().slice(0, 16),\n    duration: 30,\n    agenda: ''\n  });\n  const [wonData, setWonData] = useState({\n    finalValue: '',\n    recurringRevenue: '',\n    onboardingStatus: 'Not Started',\n    satisfactionScore: '',\n    renewalDate: '',\n    discount: '',\n    contractDuration: '',\n    paymentTerms: '',\n    deliveryDate: ''\n  });\n\n  // Fetch employee's leads\n  const fetchLeads = async () => {\n    try {\n      setLoading(true);\n      const email = localStorage.getItem('userEmail');\n      const response = await leadAPI.getLeads({ assignedTo: email });\n      if (response.data.success) {\n        setLeads(response.data.data.leads || []);\n      }\n    } catch (err) {\n      console.error('Failed to load leads:', err);\n      setError('Failed to load your sales data');\n      toast.error('Could not load sales data');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchLeads();\n  }, []);\n\n  // Stats (mocked for demo — replace with real API if available)\n  const stats = {\n    monthlyTarget: 500000,\n    actualSales: leads\n      .filter(l => l.status === 'Won')\n      .reduce((sum, l) => sum + (l.wonDetails?.finalValue || 0), 0),\n    commission: 40000,\n    rank: 3,\n    teamSize: 10\n  };\n\n  // Helpers\n  const getStatusColor = (status) => {\n    switch (status) {\n      case 'Won': return 'text-green-400 bg-green-400/20';\n      case 'Lost': return 'text-red-400 bg-red-400/20';\n      case 'Negotiation': return 'text-purple-400 bg-purple-400/20';\n      case 'Proposal': return 'text-orange-400 bg-orange-400/20';\n      case 'Qualified': return 'text-blue-400 bg-blue-400/20';\n      case 'Contacted': return 'text-yellow-400 bg-yellow-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  const getPriorityColor = (priority) => {\n    switch (priority) {\n      case 'High': return 'text-red-400 bg-red-400/20';\n      case 'Medium': return 'text-yellow-400 bg-yellow-400/20';\n      case 'Low': return 'text-green-400 bg-green-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  // Handlers\n  const handleAddLead = async (e) => {\n    e.preventDefault();\n    try {\n      const leadData = {\n        ...newLead,\n        estimatedValue: newLead.estimatedValue ? parseFloat(newLead.estimatedValue) : undefined,\n        expectedCloseDate: newLead.expectedCloseDate || undefined,\n        nextFollowUpDate: newLead.nextFollowUpDate || undefined\n      };\n      const response = await leadAPI.createLead(leadData);\n      if (response.data.success) {\n        toast.success('Lead added successfully!');\n        fetchLeads();\n        setNewLead({\n          firstName: '',\n          lastName: '',\n          email: '',\n          phone: '',\n          company: '',\n          position: '',\n          source: 'Referral',\n          priority: 'Medium',\n          estimatedValue: '',\n          expectedCloseDate: '',\n          nextFollowUpDate: new Date(Date.now() + 24*60*60*1000).toISOString().split('T')[0],\n          notes: ''\n        });\n        setShowAddModal(false);\n      }\n    } catch (err) {\n      toast.error('Failed to add lead');\n    }\n  };\n\n  const handleScheduleMeeting = async (e) => {\n    e.preventDefault();\n    try {\n      await leadAPI.addMeeting(selectedLead._id, meetingData);\n      toast.success('Meeting scheduled!');\n      fetchLeads();\n      setShowMeetingModal(false);\n    } catch (err) {\n      toast.error('Failed to schedule meeting');\n    }\n  };\n\n  const handleMarkAsWon = async (e) => {\n    e.preventDefault();\n    try {\n      await leadAPI.updateWonLead(selectedLead._id, wonData);\n      toast.success('Deal marked as won!');\n      fetchLeads();\n      setShowWonModal(false);\n    } catch (err) {\n      toast.error('Failed to update deal');\n    }\n  };\n\n  const handleDeleteLead = async (id) => {\n    if (!window.confirm('Delete this lead?')) return;\n    try {\n      await leadAPI.deleteLead(id);\n      toast.success('Lead deleted');\n      fetchLeads();\n    } catch (err) {\n      toast.error('Failed to delete lead');\n    }\n  };\n\n  // Format helpers\n  const formatCurrency = (value) => `₹${(value || 0).toLocaleString()}`;\n  const formatDate = (date) => date ? new Date(date).toLocaleDateString() : '—';\n\n  return (\n    <EmployeeLayout>\n      <div className=\"space-y-4 sm:space-y-6\">\n        {/* Dashboard Stats */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-3 sm:p-4 md:p-6\">\n          <h2 className=\"text-lg sm:text-xl font-bold text-white mb-3 sm:mb-4 flex items-center\">\n            <TrendingUp className=\"w-4 h-4 sm:w-5 sm:h-5 mr-2 text-neon-pink\" />\n            My Sales Performance\n          </h2>\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4\">\n            <StatCard\n              title=\"Monthly Target\"\n              value={formatCurrency(stats.monthlyTarget)}\n              progress={Math.min(100, (stats.actualSales / stats.monthlyTarget) * 100)}\n            />\n            <StatCard\n              title=\"Sales Achieved\"\n              value={formatCurrency(stats.actualSales)}\n              color=\"green\"\n            />\n            <StatCard\n              title=\"Commission\"\n              value={formatCurrency(stats.commission)}\n              color=\"neon-pink\"\n            />\n            <StatCard\n              title=\"Rank\"\n              value={`#${stats.rank}`}\n              subtitle={`in team of ${stats.teamSize}`}\n            />\n          </div>\n        </div>\n\n        {/* Quick Actions */}\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4\">\n          <ActionButton icon={Plus} label=\"Add New Lead\" onClick={() => setShowAddModal(true)} />\n          <ActionButton icon={Calendar} label=\"Schedule Meeting\" onClick={() => {\n            if (leads.length === 0) {\n              toast.error('No leads available');\n              return;\n            }\n            setSelectedLead(leads[0]);\n            setShowMeetingModal(true);\n          }} />\n          <ActionButton icon={Download} label=\"Export Report\" onClick={() => toast.success('Report exported')} />\n        </div>\n\n        {/* Leads Table */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-3 sm:p-4 md:p-6\">\n          <div className=\"flex justify-between items-center mb-3 sm:mb-4\">\n            <h2 className=\"text-lg sm:text-xl font-bold text-white\">My Leads & Opportunities</h2>\n            <span className=\"text-secondary-400 text-xs sm:text-sm\">{leads.length} leads</span>\n          </div>\n\n          {loading ? (\n            <div className=\"text-center py-8 text-secondary-400\">\n              <div className=\"animate-spin rounded-full h-6 w-6 border-b-2 border-neon-pink mx-auto\"></div>\n              <p className=\"mt-2\">Loading your leads...</p>\n            </div>\n          ) : leads.length === 0 ? (\n            <div className=\"text-center py-8\">\n              <Activity className=\"w-10 h-10 text-secondary-600 mx-auto mb-2\" />\n              <p className=\"text-secondary-400\">No leads assigned to you yet</p>\n            </div>\n          ) : (\n            <>\n              {/* Desktop Table */}\n              <div className=\"hidden sm:block overflow-x-auto\">\n                <table className=\"w-full text-sm\">\n                  <thead>\n                    <tr className=\"border-b border-secondary-700\">\n                      <th className=\"text-left py-3 text-secondary-400\">Lead</th>\n                      <th className=\"text-left py-3 text-secondary-400\">Value</th>\n                      <th className=\"text-left py-3 text-secondary-400\">Status</th>\n                      <th className=\"text-left py-3 text-secondary-400\">Priority</th>\n                      <th className=\"text-left py-3 text-secondary-400\">Next Follow-up</th>\n                      <th className=\"text-left py-3 text-secondary-400\">Actions</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {leads.map(lead => (\n                      <tr key={lead._id} className=\"border-b border-secondary-700/50 hover:bg-secondary-800/30\">\n                        <td className=\"py-3\">\n                          <p className=\"text-white font-medium\">{lead.firstName} {lead.lastName}</p>\n                          <p className=\"text-xs text-secondary-400\">{lead.company || '—'}</p>\n                        </td>\n                        <td className=\"py-3 text-neon-pink font-medium\">\n                          {formatCurrency(lead.estimatedValue)}\n                        </td>\n                        <td className=\"py-3\">\n                          <span className={`px-2 py-1 rounded-full text-xs ${getStatusColor(lead.status)}`}>\n                            {lead.status}\n                          </span>\n                        </td>\n                        <td className=\"py-3\">\n                          <span className={`px-2 py-1 rounded-full text-xs ${getPriorityColor(lead.priority)}`}>\n                            {lead.priority}\n                          </span>\n                        </td>\n                        <td className=\"py-3 text-secondary-400\">\n                          {formatDate(lead.nextFollowUpDate)}\n                        </td>\n                        <td className=\"py-3\">\n                          <div className=\"flex items-center gap-1\">\n                            <button\n                              onClick={() => {\n                                setSelectedLead(lead);\n                                setShowViewModal(true);\n                              }}\n                              className=\"p-1 text-secondary-400 hover:text-blue-400\"\n                            >\n                              <Eye className=\"w-3.5 h-3.5\" />\n                            </button>\n                            <button\n                              onClick={() => {\n                                setSelectedLead(lead);\n                                setShowMeetingModal(true);\n                              }}\n                              className=\"p-1 text-secondary-400 hover:text-purple-400\"\n                            >\n                              <Phone className=\"w-3.5 h-3.5\" />\n                            </button>\n                            {lead.status !== 'Won' && (\n                              <button\n                                onClick={() => {\n                                  setSelectedLead(lead);\n                                  setWonData({\n                                    finalValue: lead.estimatedValue || '',\n                                    recurringRevenue: '',\n                                    onboardingStatus: 'Not Started',\n                                    satisfactionScore: '',\n                                    renewalDate: '',\n                                    discount: '',\n                                    contractDuration: '',\n                                    paymentTerms: '',\n                                    deliveryDate: ''\n                                  });\n                                  setShowWonModal(true);\n                                }}\n                                className=\"p-1 text-secondary-400 hover:text-green-400\"\n                              >\n                                <CheckCircle className=\"w-3.5 h-3.5\" />\n                              </button>\n                            )}\n                            <button\n                              onClick={() => handleDeleteLead(lead._id)}\n                              className=\"p-1 text-secondary-400 hover:text-red-400\"\n                            >\n                              <Trash2 className=\"w-3.5 h-3.5\" />\n                            </button>\n                          </div>\n                        </td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              </div>\n\n              {/* Mobile Cards */}\n              <div className=\"block sm:hidden space-y-4\">\n                {leads.map(lead => (\n                  <div key={lead._id} className=\"glass-morphism rounded-lg p-4 border border-secondary-700\">\n                    <div className=\"flex justify-between items-start mb-3\">\n                      <div>\n                        <p className=\"text-white font-medium text-base\">{lead.firstName} {lead.lastName}</p>\n                        <p className=\"text-sm text-secondary-400\">{lead.company || '—'}</p>\n                      </div>\n                      <div className=\"flex gap-1\">\n                        <button\n                          onClick={() => {\n                            setSelectedLead(lead);\n                            setShowViewModal(true);\n                          }}\n                          className=\"p-2 text-secondary-400 hover:text-blue-400\"\n                        >\n                          <Eye className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                          onClick={() => {\n                            setSelectedLead(lead);\n                            setShowMeetingModal(true);\n                          }}\n                          className=\"p-2 text-secondary-400 hover:text-purple-400\"\n                        >\n                          <Phone className=\"w-4 h-4\" />\n                        </button>\n                        {lead.status !== 'Won' && (\n                          <button\n                            onClick={() => {\n                              setSelectedLead(lead);\n                              setWonData({\n                                finalValue: lead.estimatedValue || '',\n                                recurringRevenue: '',\n                                onboardingStatus: 'Not Started',\n                                satisfactionScore: '',\n                                renewalDate: '',\n                                discount: '',\n                                contractDuration: '',\n                                paymentTerms: '',\n                                deliveryDate: ''\n                              });\n                              setShowWonModal(true);\n                            }}\n                            className=\"p-2 text-secondary-400 hover:text-green-400\"\n                          >\n                            <CheckCircle className=\"w-4 h-4\" />\n                          </button>\n                        )}\n                        <button\n                          onClick={() => handleDeleteLead(lead._id)}\n                          className=\"p-2 text-secondary-400 hover:text-red-400\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </button>\n                      </div>\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                      <div>\n                        <p className=\"text-secondary-400\">Value</p>\n                        <p className=\"text-neon-pink font-medium\">{formatCurrency(lead.estimatedValue)}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-secondary-400\">Status</p>\n                        <span className={`px-2 py-1 rounded-full text-xs ${getStatusColor(lead.status)}`}>\n                          {lead.status}\n                        </span>\n                      </div>\n                      <div>\n                        <p className=\"text-secondary-400\">Priority</p>\n                        <span className={`px-2 py-1 rounded-full text-xs ${getPriorityColor(lead.priority)}`}>\n                          {lead.priority}\n                        </span>\n                      </div>\n                      <div>\n                        <p className=\"text-secondary-400\">Next Follow-up</p>\n                        <p className=\"text-white\">{formatDate(lead.nextFollowUpDate)}</p>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </>\n          )}\n        </div>\n      </div>\n\n      {/* Modals */}\n      {/* Add Lead Modal */}\n      {showAddModal && (\n        <Modal title=\"Add New Lead\" onClose={() => setShowAddModal(false)}>\n          <form onSubmit={handleAddLead} className=\"space-y-4\">\n            <Input label=\"First Name *\" value={newLead.firstName} onChange={(v) => setNewLead({...newLead, firstName: v})} />\n            <Input label=\"Last Name *\" value={newLead.lastName} onChange={(v) => setNewLead({...newLead, lastName: v})} />\n            <Input label=\"Email *\" type=\"email\" value={newLead.email} onChange={(v) => setNewLead({...newLead, email: v})} />\n            <Input label=\"Phone *\" value={newLead.phone} onChange={(v) => setNewLead({...newLead, phone: v})} />\n            <Input label=\"Company\" value={newLead.company} onChange={(v) => setNewLead({...newLead, company: v})} />\n            <Input label=\"Estimated Value (₹)\" type=\"number\" value={newLead.estimatedValue} onChange={(v) => setNewLead({...newLead, estimatedValue: v})} />\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n              <Input label=\"Expected Close Date\" type=\"date\" value={newLead.expectedCloseDate} onChange={(v) => setNewLead({...newLead, expectedCloseDate: v})} />\n              <Input label=\"Next Follow-up\" type=\"date\" value={newLead.nextFollowUpDate} onChange={(v) => setNewLead({...newLead, nextFollowUpDate: v})} />\n            </div>\n            <div className=\"flex justify-end gap-2 pt-4\">\n              <button type=\"button\" onClick={() => setShowAddModal(false)} className=\"px-4 py-2 bg-secondary-700 text-white rounded-lg\">Cancel</button>\n              <button type=\"submit\" className=\"px-4 py-2 bg-gradient-to-r from-neon-pink to-neon-purple text-white rounded-lg\">Add Lead</button>\n            </div>\n          </form>\n        </Modal>\n      )}\n\n      {/* View Lead Modal */}\n      {showViewModal && selectedLead && (\n        <Modal title={`${selectedLead.firstName} ${selectedLead.lastName}`} onClose={() => setShowViewModal(false)}>\n          <div className=\"space-y-3 text-sm\">\n            <InfoRow label=\"Email\" value={selectedLead.email} />\n            <InfoRow label=\"Phone\" value={selectedLead.phone} />\n            <InfoRow label=\"Company\" value={selectedLead.company || '—'} />\n            <InfoRow label=\"Status\" value={\n              <span className={`px-2 py-1 rounded-full text-xs ${getStatusColor(selectedLead.status)}`}>\n                {selectedLead.status}\n              </span>\n            } />\n            <InfoRow label=\"Priority\" value={\n              <span className={`px-2 py-1 rounded-full text-xs ${getPriorityColor(selectedLead.priority)}`}>\n                {selectedLead.priority}\n              </span>\n            } />\n            <InfoRow label=\"Estimated Value\" value={formatCurrency(selectedLead.estimatedValue)} />\n            <InfoRow label=\"Next Follow-up\" value={formatDate(selectedLead.nextFollowUpDate)} />\n            {selectedLead.notes && <InfoRow label=\"Notes\" value={selectedLead.notes} />}\n          </div>\n        </Modal>\n      )}\n\n      {/* Meeting Modal */}\n      {showMeetingModal && selectedLead && (\n        <Modal title=\"Schedule Meeting\" onClose={() => setShowMeetingModal(false)}>\n          <form onSubmit={handleScheduleMeeting} className=\"space-y-4\">\n            <Select label=\"Meeting Type\" value={meetingData.type} onChange={(v) => setMeetingData({...meetingData, type: v})} options={[\n              { value: 'Call', label: 'Call' },\n              { value: 'Video Meeting', label: 'Video Meeting' },\n              { value: 'In-Person', label: 'In-Person' },\n              { value: 'Demo', label: 'Demo' }\n            ]} />\n            <Input label=\"Scheduled Date & Time\" type=\"datetime-local\" value={meetingData.scheduledDate} onChange={(v) => setMeetingData({...meetingData, scheduledDate: v})} />\n            <Input label=\"Duration (minutes)\" type=\"number\" value={meetingData.duration} onChange={(v) => setMeetingData({...meetingData, duration: v})} />\n            <Textarea label=\"Agenda\" value={meetingData.agenda} onChange={(v) => setMeetingData({...meetingData, agenda: v})} />\n            <div className=\"flex justify-end gap-2 pt-4\">\n              <button type=\"button\" onClick={() => setShowMeetingModal(false)} className=\"px-4 py-2 bg-secondary-700 text-white rounded-lg\">Cancel</button>\n              <button type=\"submit\" className=\"px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg\">Schedule</button>\n            </div>\n          </form>\n        </Modal>\n      )}\n\n      {/* Won Modal */}\n      {showWonModal && selectedLead && (\n        <Modal title=\"Mark Deal as Won\" onClose={() => setShowWonModal(false)}>\n          <form onSubmit={handleMarkAsWon} className=\"space-y-4\">\n            <Input label=\"Final Deal Value (₹)\" type=\"number\" value={wonData.finalValue} onChange={(v) => setWonData({...wonData, finalValue: v})} />\n            <Input label=\"Monthly Recurring Revenue (₹)\" type=\"number\" value={wonData.recurringRevenue} onChange={(v) => setWonData({...wonData, recurringRevenue: v})} />\n            <Input label=\"Renewal Date\" type=\"date\" value={wonData.renewalDate} onChange={(v) => setWonData({...wonData, renewalDate: v})} />\n            <Input label=\"Contract Duration (months)\" type=\"number\" value={wonData.contractDuration} onChange={(v) => setWonData({...wonData, contractDuration: v})} />\n            <div className=\"flex justify-end gap-2 pt-4\">\n              <button type=\"button\" onClick={() => setShowWonModal(false)} className=\"px-4 py-2 bg-secondary-700 text-white rounded-lg\">Cancel</button>\n              <button type=\"submit\" className=\"px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg\">Mark as Won</button>\n            </div>\n          </form>\n        </Modal>\n      )}\n    </EmployeeLayout>\n  );\n};\n\n// Helper Components\nconst StatCard = ({ title, value, progress, color = 'neon-pink', subtitle }) => (\n  <div className=\"glass-morphism p-3 rounded-lg\">\n    <p className=\"text-xs text-secondary-400\">{title}</p>\n    <p className=\"text-lg font-bold text-white mt-1\">{value}</p>\n    {subtitle && <p className=\"text-xs text-secondary-400 mt-1\">{subtitle}</p>}\n    {progress !== undefined && (\n      <div className=\"mt-2 w-full bg-secondary-700 rounded-full h-1.5\">\n        <div \n          className={`h-full rounded-full ${color === 'green' ? 'bg-green-500' : color === 'neon-pink' ? 'bg-gradient-to-r from-neon-pink to-neon-purple' : 'bg-blue-500'}`} \n          style={{ width: `${progress}%` }}\n        ></div>\n      </div>\n    )}\n  </div>\n);\n\nconst ActionButton = ({ icon: Icon, label, onClick }) => (\n  <button \n    onClick={onClick}\n    className=\"p-4 rounded-lg border-2 border-dashed border-secondary-600 hover:border-neon-pink/50 hover:bg-neon-pink/5 group text-left\"\n  >\n    <Icon className=\"w-6 h-6 text-secondary-400 group-hover:text-neon-pink mb-2\" />\n    <p className=\"text-sm text-secondary-400 group-hover:text-white\">{label}</p>\n  </button>\n);\n\nconst Modal = ({ title, children, onClose }) => (\n  <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-3 sm:p-4\">\n    <div className=\"glass-morphism neon-border rounded-2xl p-3 sm:p-4 w-full max-w-sm sm:max-w-md max-h-[90vh] overflow-y-auto\">\n      <div className=\"flex justify-between items-center mb-3 sm:mb-4\">\n        <h3 className=\"text-base sm:text-lg font-bold text-white\">{title}</h3>\n        <button onClick={onClose} className=\"text-secondary-400 hover:text-white\">\n          <XCircle className=\"w-4 h-4 sm:w-5 sm:h-5\" />\n        </button>\n      </div>\n      {children}\n    </div>\n  </div>\n);\n\nconst Input = ({ label, value, onChange, type = 'text', ...props }) => (\n  <div>\n    <label className=\"block text-xs text-secondary-400 mb-1\">{label}</label>\n    <input\n      type={type}\n      value={value}\n      onChange={(e) => onChange(e.target.value)}\n      className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:outline-none\"\n      {...props}\n    />\n  </div>\n);\n\nconst Textarea = ({ label, value, onChange, rows = 3 }) => (\n  <div>\n    <label className=\"block text-xs text-secondary-400 mb-1\">{label}</label>\n    <textarea\n      value={value}\n      onChange={(e) => onChange(e.target.value)}\n      rows={rows}\n      className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:outline-none\"\n    />\n  </div>\n);\n\nconst Select = ({ label, value, onChange, options }) => (\n  <div>\n    <label className=\"block text-xs text-secondary-400 mb-1\">{label}</label>\n    <select\n      value={value}\n      onChange={(e) => onChange(e.target.value)}\n      className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink focus:outline-none\"\n    >\n      {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}\n    </select>\n  </div>\n);\n\nconst InfoRow = ({ label, value }) => (\n  <div className=\"flex justify-between border-b border-secondary-700 pb-2\">\n    <span className=\"text-secondary-400 text-sm\">{label}</span>\n    <span className=\"text-white text-sm\">{value}</span>\n  </div>\n);\n\nexport default SalesPage;","path":null,"size_bytes":26632,"size_tokens":null},"backend/controllers/employeeController.js":{"content":"import mongoose from 'mongoose';\nimport User from '../models/User.js';\nimport FaceData from '../models/FaceData.js';\nimport Employee from '../models/Employee.js';\nimport { sendEmail } from '../utils/email.js';\nimport Department from '../models/Department.js';\n\n// Create new employee\n// Updated createEmployee controller to handle face registration\n// Updated createEmployee function in employeeController.js\nexport const createEmployee = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const employeeData = req.body;\n    \n    // Validate required fields\n    if (!employeeData.personalInfo?.firstName || !employeeData.personalInfo?.lastName) {\n      return res.status(400).json({\n        success: false,\n        message: 'First name and last name are required'\n      });\n    }\n\n    if (!employeeData.contactInfo?.personalEmail) {\n      return res.status(400).json({\n        success: false,\n        message: 'Email is required'\n      });\n    }\n\n    const email = employeeData.contactInfo.personalEmail.toLowerCase();\n\n    // Check if user already exists\n    const existingUser = await User.findOne({ email });\n    if (existingUser) {\n      return res.status(400).json({\n        success: false,\n        message: 'User already exists with this email'\n      });\n    }\n\n    // Extract and validate face data FIRST - FACE REGISTRATION IS COMPULSORY\n    // Validate BEFORE creating user to avoid orphaned users\n    const { faceDescriptor, faceImage, hasFaceRegistered, ...cleanEmployeeData } = employeeData;\n    \n    // COMPULSORY: Validate face descriptor - employee MUST have valid face data\n    if (!faceDescriptor || !Array.isArray(faceDescriptor)) {\n      return res.status(400).json({\n        success: false,\n        message: 'Face registration is compulsory. Please capture employee face data before creating the account.'\n      });\n    }\n\n    // face-api.js uses 128-dimensional descriptors (not 512 like InsightFace)\n    if (faceDescriptor.length !== 128 || !faceDescriptor.every(val => typeof val === 'number' && !isNaN(val))) {\n      return res.status(400).json({\n        success: false,\n        message: `Invalid face data. Face descriptor must be a valid 128-dimensional vector (received ${faceDescriptor.length} dimensions). Please recapture the face.`\n      });\n    }\n\n    // Face data is valid - now safe to create user\n    const validFaceDescriptor = faceDescriptor;\n    const validFaceImage = faceImage;\n    const faceRegistered = true;\n    console.log('✅ Valid face descriptor received:', faceDescriptor.length, 'dimensions');\n\n    // Create user account AFTER face validation to avoid orphans\n    const user = await User.create({\n      name: `${employeeData.personalInfo.firstName} ${employeeData.personalInfo.lastName}`,\n      email: email,\n      password: 'temp123', // Temporary password\n      role: 'employee'\n    });\n\n    // Create employee record\n    const employee = await Employee.create({\n      ...cleanEmployeeData,\n      user: user._id,\n      // Store face data directly in employee model\n      faceDescriptor: validFaceDescriptor,\n      faceImage: validFaceImage,\n      hasFaceRegistered: faceRegistered\n    });\n\n    // Update user with employeeId\n    user.employeeId = employee.employeeId;\n    user.password = employee.employeeId; // Employee ID is the password\n    await user.save();\n\n    // If valid face data was provided, create FaceData record\n    if (validFaceDescriptor) {\n      try {\n        const faceData = new FaceData({\n          employee: employee._id,\n          user: user._id,\n          faceDescriptor: validFaceDescriptor,\n          landmarks: [],\n          faceImageUrl: validFaceImage || null,\n          confidence: 95,\n          metadata: {\n            captureDevice: req.headers['user-agent'] || 'Web Registration',\n            captureEnvironment: 'Employee Creation',\n            processingVersion: '1.0'\n          }\n        });\n\n        await faceData.save();\n        console.log('✅ Face data saved for employee:', employee.employeeId);\n      } catch (faceError) {\n        console.error('❌ Error saving face data:', faceError);\n        // Don't fail employee creation if face data save fails\n      }\n    }\n\n    // Populate user data\n    await employee.populate('user', 'name email role employeeId isActive');\n\n    // Send welcome email (existing code)\n    try {\n      const emailMessage = `\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background-color: #ffffff;\">\n          <div style=\"background: linear-gradient(135deg, #ff0080, #8b5cf6); padding: 20px; text-align: center;\">\n            <h1 style=\"color: white; margin: 0; font-size: 24px;\">Welcome to CompanyName!</h1>\n          </div>\n          \n          <div style=\"padding: 30px 20px;\">\n            <p style=\"font-size: 16px; color: #333; margin-bottom: 20px;\">\n              Hello <strong>${user.name}</strong>,\n            </p>\n            \n            <p style=\"color: #555; line-height: 1.6; margin-bottom: 25px;\">\n              Your employee account has been created successfully${faceRegistered ? ' with biometric registration' : ''}. Welcome to the team!\n            </p>\n            \n            <div style=\"background-color: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #ff0080; margin: 25px 0;\">\n              <h3 style=\"margin-top: 0; color: #333; font-size: 18px;\">Your Login Credentials:</h3>\n              <div style=\"background-color: white; padding: 15px; border-radius: 6px; margin-top: 15px;\">\n                <p style=\"margin: 8px 0; color: #555;\"><strong>Email:</strong> ${user.email}</p>\n                <p style=\"margin: 8px 0; color: #555;\"><strong>Employee ID:</strong> <span style=\"font-family: monospace; background-color: #e9ecef; padding: 3px 6px; border-radius: 3px;\">${employee.employeeId}</span></p>\n                <p style=\"margin: 8px 0; color: #555;\"><strong>Password:</strong> <span style=\"font-family: monospace; background-color: #fff3cd; padding: 3px 6px; border-radius: 3px; border: 1px solid #ffeaa7;\">${employee.employeeId}</span></p>\n              </div>\n            </div>\n            \n            ${faceRegistered ? `\n            <div style=\"background-color: #d4edda; padding: 15px; border-radius: 6px; border: 1px solid #c3e6cb; margin: 25px 0;\">\n              <h4 style=\"margin: 0 0 10px 0; color: #155724;\">🎉 Biometric Registration Complete!</h4>\n              <p style=\"margin: 0; color: #155724;\">Your face has been registered for secure attendance marking. You can now use face recognition for quick check-in/check-out.</p>\n            </div>\n            ` : ''}\n            \n            <div style=\"text-align: center; margin: 30px 0;\">\n              <a href=\"${process.env.FRONTEND_URL}/login\" \n                 style=\"display: inline-block; padding: 12px 30px; background: linear-gradient(135deg, #ff0080, #8b5cf6); color: white; text-decoration: none; border-radius: 25px; font-weight: bold;\">\n                Login to Your Account\n              </a>\n            </div>\n          </div>\n        </div>\n      `;\n\n      await sendEmail({\n        to: user.email,\n        subject: `Welcome to CompanyName - Account Created${faceRegistered ? ' with Biometric Registration' : ''}`,\n        html: emailMessage\n      });\n\n      console.log('✅ Welcome email sent to:', user.email);\n    } catch (emailError) {\n      console.error('❌ Error sending welcome email:', emailError);\n    }\n\n    res.status(201).json({\n      success: true,\n      message: `Employee created successfully${faceRegistered ? ' with face registration' : ''}! Welcome email sent.`,\n      data: {\n        employee,\n        faceRegistered,\n        loginCredentials: {\n          email: user.email,\n          employeeId: employee.employeeId,\n          password: employee.employeeId\n        }\n      }\n    });\n\n  } catch (error) {\n    console.error('❌ Create employee error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n// / Update the getEmployees function to populate department information\nexport const getEmployees = async (req, res) => {\n  try {\n    const { page = 1, limit = 50, department, status, search } = req.query;\n\n    const query = {};\n    if (department && department !== 'all') {\n      // If department is provided, it could be either name or ObjectId\n      // First try to find department by name to get ObjectId\n      try {\n        const deptDoc = await Department.findOne({ name: department });\n        if (deptDoc) {\n          query['workInfo.department'] = deptDoc._id;\n        } else {\n          // If not found by name, try as ObjectId\n          if (mongoose.Types.ObjectId.isValid(department)) {\n            query['workInfo.department'] = department;\n          }\n        }\n      } catch (err) {\n        console.error('Department filter error:', err);\n      }\n    }\n    if (status && status !== 'all') {\n      query.status = status;\n    }\n\n    let employees = await Employee.find(query)\n      .populate('user', 'name email role employeeId isActive')\n      .populate('workInfo.department', 'name code') // Populate department with name and code\n      .populate('workInfo.reportingManager', 'personalInfo.firstName personalInfo.lastName')\n      .sort({ createdAt: -1 })\n      .limit(limit * 1)\n      .skip((page - 1) * limit);\n\n    // Apply search filter after population\n    if (search) {\n      employees = employees.filter(emp => {\n        const searchTerm = search.toLowerCase();\n        const fullName = emp.fullName?.toLowerCase() || '';\n        const email = emp.user?.email?.toLowerCase() || '';\n        const position = emp.workInfo?.position?.toLowerCase() || '';\n        const employeeId = emp.employeeId?.toLowerCase() || '';\n        const departmentName = emp.workInfo?.department?.name?.toLowerCase() || '';\n        \n        return fullName.includes(searchTerm) || \n               email.includes(searchTerm) || \n               position.includes(searchTerm) ||\n               employeeId.includes(searchTerm) ||\n               departmentName.includes(searchTerm);\n      });\n    }\n\n    const total = await Employee.countDocuments(query);\n\n    res.json({\n      success: true,\n      data: {\n        employees,\n        pagination: {\n          currentPage: parseInt(page),\n          totalPages: Math.ceil(total / limit),\n          totalEmployees: total,\n          hasNext: page < Math.ceil(total / limit),\n          hasPrev: page > 1\n        }\n      }\n    });\n\n  } catch (error) {\n    console.error('Get employees error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\nexport const getEmployeeById = async (req, res) => {\n  try {\n    console.log('getEmployeeById called with params:', req.params);\n    console.log('Request path:', req.path);\n    console.log('Request originalUrl:', req.originalUrl);\n\n    let employee;\n\n    if (req.params.id === 'me') {\n      employee = await Employee.findOne({ user: req.user.id })\n        .populate('user', 'name email role employeeId isActive')\n        .populate('workInfo.department', 'name code description') // Populate department\n        .populate('workInfo.reportingManager', 'personalInfo.firstName personalInfo.lastName');\n\n      if (!employee) {\n        return res.status(404).json({\n          success: false,\n          message: 'Employee record not found for current user'\n        });\n      }\n    } else {\n      if (!mongoose.Types.ObjectId.isValid(req.params.id)) {\n        return res.status(400).json({\n          success: false,\n          message: 'Invalid employee ID format. Must be a valid ObjectId or \"me\".'\n        });\n      }\n\n      employee = await Employee.findById(req.params.id)\n        .populate('user', 'name email role employeeId isActive')\n        .populate('workInfo.department', 'name code description') // Populate department\n        .populate('workInfo.reportingManager', 'personalInfo.firstName personalInfo.lastName');\n\n      if (!employee) {\n        return res.status(404).json({\n          success: false,\n          message: 'Employee not found'\n        });\n      }\n\n      if (req.user.role !== 'admin' && employee.user._id.toString() !== req.user.id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied. You can only view your own employee record.'\n        });\n      }\n    }\n\n    res.json({\n      success: true,\n      data: employee\n    });\n\n  } catch (error) {\n    console.error('Get employee by ID error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching employee'\n    });\n  }\n};\n\n\n// Get employees by department\nexport const getEmployeesByDepartment = async (req, res) => {\n  try {\n    const employees = await Employee.getByDepartment(req.params.department);\n    res.json({\n      success: true,\n      data: employees\n    });\n  } catch (error) {\n    console.error('Get employees by department error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n\n// Update the updateEmployee function to handle department updates\nexport const updateEmployee = async (req, res) => {\n  try {\n    const employeeId = req.params.id;\n    let targetEmployeeId = employeeId;\n\n    if (employeeId === 'me') {\n      const currentEmployee = await Employee.findOne({ user: req.user.id });\n      if (!currentEmployee) {\n        return res.status(404).json({\n          success: false,\n          message: 'Employee record not found for current user'\n        });\n      }\n      targetEmployeeId = currentEmployee._id;\n    }\n\n    if (req.user.role !== 'admin') {\n      const employee = await Employee.findById(targetEmployeeId);\n      if (!employee || employee.user.toString() !== req.user.id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied. You can only update your own profile.'\n        });\n      }\n    }\n\n    // Validate department ObjectId if department is being updated\n    if (req.body.workInfo?.department) {\n      const departmentId = req.body.workInfo.department;\n      if (!mongoose.Types.ObjectId.isValid(departmentId)) {\n        return res.status(400).json({\n          success: false,\n          message: 'Invalid department ID format'\n        });\n      }\n      \n      // Verify department exists\n      const department = await Department.findById(departmentId);\n      if (!department) {\n        return res.status(400).json({\n          success: false,\n          message: 'Department not found'\n        });\n      }\n    }\n\n    const employee = await Employee.findByIdAndUpdate(\n      targetEmployeeId,\n      req.body,\n      { new: true, runValidators: true }\n    ).populate('user', 'name email role employeeId isActive')\n     .populate('workInfo.department', 'name code description');\n\n    if (!employee) {\n      return res.status(404).json({\n        success: false,\n        message: 'Employee not found'\n      });\n    }\n\n    // Update department employee counts\n    if (req.body.workInfo?.department) {\n      try {\n        // Update the new department's employee count\n        const newDepartment = await Department.findById(req.body.workInfo.department);\n        if (newDepartment) {\n          await newDepartment.updateEmployeeCount();\n        }\n        \n        // If the employee was moved from another department, update that count too\n        // This would require knowing the previous department, which we could track\n      } catch (countError) {\n        console.error('Error updating department counts:', countError);\n      }\n    }\n\n    // Sync with User collection\n    if (employee.user) {\n      const updateUserData = {};\n\n      if (req.body.personalInfo?.firstName || req.body.personalInfo?.lastName) {\n        updateUserData.name = `${req.body.personalInfo?.firstName || employee.personalInfo.firstName} ${req.body.personalInfo?.lastName || employee.personalInfo.lastName}`;\n      }\n\n      if (req.body.contactInfo?.personalEmail) {\n        updateUserData.email = req.body.contactInfo.personalEmail.toLowerCase();\n      }\n\n      if (Object.keys(updateUserData).length > 0) {\n        await User.findByIdAndUpdate(employee.user._id, updateUserData, { new: true });\n      }\n    }\n\n    res.json({\n      success: true,\n      message: 'Employee updated successfully',\n      data: employee\n    });\n\n  } catch (error) {\n    console.error('Update employee error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Delete employee\nexport const deleteEmployee = async (req, res) => {\n  try {\n    // Check if user is admin\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const employee = await Employee.findById(req.params.id);\n    if (!employee) {\n      return res.status(404).json({\n        success: false,\n        message: 'Employee not found'\n      });\n    }\n\n    // Delete employee record\n    await Employee.findByIdAndDelete(req.params.id);\n\n    // Delete associated user account\n    if (employee.user) {\n      await User.findByIdAndDelete(employee.user);\n    }\n\n    res.json({\n      success: true,\n      message: 'Employee and associated user account deleted successfully'\n    });\n\n  } catch (error) {\n    console.error('Delete employee error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// Get employee statistics\nexport const getEmployeeStats = async (req, res) => {\n  try {\n    const totalEmployees = await Employee.countDocuments({ status: { $ne: 'Terminated' } });\n    const activeEmployees = await Employee.countDocuments({ status: 'Active' });\n    const inactiveEmployees = await Employee.countDocuments({ status: 'Inactive' });\n    const onLeaveEmployees = await Employee.countDocuments({ status: 'On Leave' });\n\n    // Department wise count\n    const departmentStats = await Employee.aggregate([\n      { $match: { status: { $ne: 'Terminated' } } },\n      { $group: { _id: '$workInfo.department', count: { $sum: 1 } } },\n      { $sort: { count: -1 } }\n    ]);\n\n    // Recent joinings (last 30 days)\n    const thirtyDaysAgo = new Date();\n    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\n    \n    const recentJoinings = await Employee.countDocuments({\n      'workInfo.joiningDate': { $gte: thirtyDaysAgo },\n      status: { $ne: 'Terminated' }\n    });\n\n    res.json({\n      success: true,\n      data: {\n        total: totalEmployees,\n        active: activeEmployees,\n        inactive: inactiveEmployees,\n        onLeave: onLeaveEmployees,\n        recentJoinings,\n        departmentStats: departmentStats.map(stat => ({\n          department: stat._id,\n          count: stat.count\n        }))\n      }\n    });\n\n  } catch (error) {\n    console.error('Get employee stats error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n// Add this method to your existing employee controller\nexport const updateEmployeeWithFace = async (req, res) => {\n  try {\n    const employeeId = req.params.id;\n    let targetEmployeeId = employeeId;\n\n    // Handle 'me' case\n    if (employeeId === 'me') {\n      const currentEmployee = await Employee.findOne({ user: req.user.id });\n      if (!currentEmployee) {\n        return res.status(404).json({\n          success: false,\n          message: 'Employee record not found for current user'\n        });\n      }\n      targetEmployeeId = currentEmployee._id;\n    }\n\n    // Check permissions\n    if (req.user.role !== 'admin') {\n      const employee = await Employee.findById(targetEmployeeId);\n      if (!employee || employee.user.toString() !== req.user.id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied. You can only update your own profile.'\n        });\n      }\n    }\n\n    // Extract face data from request body\n    const { faceDescriptor, faceImage, hasFaceRegistered, ...employeeData } = req.body;\n\n    // Update employee record\n    const updateData = {\n      ...employeeData,\n      ...(faceDescriptor && { faceDescriptor }),\n      ...(faceImage && { faceImage }),\n      ...(hasFaceRegistered !== undefined && { hasFaceRegistered })\n    };\n\n    const employee = await Employee.findByIdAndUpdate(\n      targetEmployeeId,\n      updateData,\n      { new: true, runValidators: true }\n    ).populate('user', 'name email role employeeId isActive');\n\n    if (!employee) {\n      return res.status(404).json({\n        success: false,\n        message: 'Employee not found'\n      });\n    }\n\n    // If face data was provided, create or update FaceData record\n    if (faceDescriptor && faceDescriptor.length === 512) {\n      try {\n        const existingFaceData = await FaceData.findOne({ employee: targetEmployeeId });\n        \n        if (existingFaceData) {\n          // Update existing face data\n          existingFaceData.faceDescriptor = faceDescriptor;\n          existingFaceData.faceImageUrl = faceImage || existingFaceData.faceImageUrl;\n          existingFaceData.lastUpdated = new Date();\n          await existingFaceData.save();\n        } else {\n          // Create new face data record\n          const faceData = new FaceData({\n            employee: targetEmployeeId,\n            user: employee.user._id,\n            faceDescriptor,\n            faceImageUrl: faceImage,\n            metadata: {\n              captureDevice: req.headers['user-agent'] || 'Employee Update',\n              captureEnvironment: 'Profile Update',\n              processingVersion: '1.0'\n            }\n          });\n          await faceData.save();\n        }\n      } catch (faceError) {\n        console.error('Error updating face data:', faceError);\n        // Don't fail the employee update if face data fails\n      }\n    }\n\n    // Sync with User collection if needed\n    if (employee.user) {\n      const updateUserData = {};\n\n      if (req.body.personalInfo?.firstName || req.body.personalInfo?.lastName) {\n        updateUserData.name = `${req.body.personalInfo?.firstName || employee.personalInfo.firstName} ${req.body.personalInfo?.lastName || employee.personalInfo.lastName}`;\n      }\n\n      if (req.body.contactInfo?.personalEmail) {\n        updateUserData.email = req.body.contactInfo.personalEmail.toLowerCase();\n      }\n\n      if (Object.keys(updateUserData).length > 0) {\n        await User.findByIdAndUpdate(employee.user._id, updateUserData, { new: true });\n      }\n    }\n\n    res.json({\n      success: true,\n      message: `Employee updated successfully${hasFaceRegistered ? ' with face registration' : ''}`,\n      data: employee\n    });\n\n  } catch (error) {\n    console.error('Update employee error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\nexport const getEmployeeBankingDetails = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { id } = req.params;\n\n    if (!mongoose.Types.ObjectId.isValid(id)) {\n      return res.status(400).json({\n        success: false,\n        message: 'Invalid employee ID format'\n      });\n    }\n\n    const employee = await Employee.findById(id)\n      .select('employeeId personalInfo.firstName personalInfo.lastName bankInfo salaryInfo contactInfo.personalEmail workInfo.position workInfo.department')\n      .populate('user', 'name email')\n      .populate('workInfo.department', 'name');\n\n    if (!employee) {\n      return res.status(404).json({\n        success: false,\n        message: 'Employee not found'\n      });\n    }\n\n    res.json({\n      success: true,\n      data: {\n        employeeId: employee.employeeId,\n        name: `${employee.personalInfo.firstName} ${employee.personalInfo.lastName}`,\n        email: employee.user?.email || employee.contactInfo?.personalEmail,\n        position: employee.workInfo?.position,\n        department: employee.workInfo?.department?.name,\n        bankInfo: employee.bankInfo,\n        salaryInfo: employee.salaryInfo\n      }\n    });\n\n  } catch (error) {\n    console.error('Get employee banking details error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};","path":null,"size_bytes":24440,"size_tokens":null},"frontend/src/components/Employee/GroupChat/GroupChatModal.jsx":{"content":"import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { X, Send, Users, Plus, Settings, LogOut, Crown, Shield, UserPlus, Trash2, MoreVertical, ArrowLeft, Check } from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport { employeeAPI } from '../../../utils/api';\n\nconst GroupChatModal = ({ \n  isOpen, \n  onClose, \n  socket, \n  employeeData, \n  onlineUsers \n}) => {\n  const socketReady = socket?.connected;\n  const [groups, setGroups] = useState([]);\n  const [selectedGroup, setSelectedGroup] = useState(null);\n  const [groupMessages, setGroupMessages] = useState([]);\n  const [newMessage, setNewMessage] = useState('');\n  const [loading, setLoading] = useState(false);\n  const [loadingMessages, setLoadingMessages] = useState(false);\n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [showGroupSettings, setShowGroupSettings] = useState(false);\n  const [showAddMembers, setShowAddMembers] = useState(false);\n  const [availableUsers, setAvailableUsers] = useState([]);\n  const [typingUsers, setTypingUsers] = useState({});\n  const [newGroupName, setNewGroupName] = useState('');\n  const [newGroupDescription, setNewGroupDescription] = useState('');\n  const [selectedMembers, setSelectedMembers] = useState([]);\n  const messagesEndRef = useRef(null);\n  const typingTimeoutRef = useRef(null);\n\n  const scrollToBottom = useCallback(() => {\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n  }, []);\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [groupMessages, scrollToBottom]);\n\n  useEffect(() => {\n    if (isOpen) {\n      fetchGroups();\n      fetchAvailableUsers();\n    }\n  }, [isOpen]);\n\n  useEffect(() => {\n    if (!socket || !isOpen) return;\n\n    const handleGroupMessage = (message) => {\n      if (message.groupId === selectedGroup?._id) {\n        setGroupMessages(prev => {\n          if (prev.some(m => m._id === message._id)) return prev;\n          if (message.clientMessageId && prev.some(m => m.clientMessageId === message.clientMessageId)) {\n            return prev.map(m => m.clientMessageId === message.clientMessageId ? message : m);\n          }\n          return [...prev, message];\n        });\n      }\n      setGroups(prev => prev.map(g => \n        g._id === message.groupId \n          ? { ...g, lastMessage: { text: message.text, sender: message.sender, timestamp: message.timestamp } }\n          : g\n      ));\n    };\n\n    const handleTypingStart = ({ groupId, userId, userName }) => {\n      if (groupId === selectedGroup?._id && userId !== employeeData?.id) {\n        setTypingUsers(prev => ({ ...prev, [userId]: userName }));\n      }\n    };\n\n    const handleTypingStop = ({ groupId, userId }) => {\n      if (groupId === selectedGroup?._id) {\n        setTypingUsers(prev => {\n          const updated = { ...prev };\n          delete updated[userId];\n          return updated;\n        });\n      }\n    };\n\n    const handleGroupAdded = ({ groupId }) => {\n      fetchGroups();\n      toast.success('You were added to a new group');\n    };\n\n    const handleGroupRemoved = ({ groupId }) => {\n      setGroups(prev => prev.filter(g => g._id !== groupId));\n      if (selectedGroup?._id === groupId) {\n        setSelectedGroup(null);\n        setGroupMessages([]);\n        toast.info('You were removed from the group');\n      }\n    };\n\n    socket.on('group:message', handleGroupMessage);\n    socket.on('group:typing:start', handleTypingStart);\n    socket.on('group:typing:stop', handleTypingStop);\n    socket.on('group:added', handleGroupAdded);\n    socket.on('group:removed', handleGroupRemoved);\n\n    return () => {\n      socket.off('group:message', handleGroupMessage);\n      socket.off('group:typing:start', handleTypingStart);\n      socket.off('group:typing:stop', handleTypingStop);\n      socket.off('group:added', handleGroupAdded);\n      socket.off('group:removed', handleGroupRemoved);\n    };\n  }, [socket, selectedGroup, employeeData]);\n\n  useEffect(() => {\n    if (selectedGroup && socket) {\n      socket.emit('group:join', { groupId: selectedGroup._id });\n      fetchGroupMessages(selectedGroup._id);\n    }\n  }, [selectedGroup, socket]);\n\n  const fetchGroups = async () => {\n    try {\n      setLoading(true);\n      const response = await employeeAPI.get('/groups');\n      if (response.data.success) {\n        setGroups(response.data.data);\n      }\n    } catch (error) {\n      console.error('Failed to fetch groups:', error);\n      toast.error('Failed to load groups');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const fetchGroupMessages = async (groupId) => {\n    try {\n      setLoadingMessages(true);\n      const response = await employeeAPI.get(`/groups/${groupId}/messages`);\n      if (response.data.success) {\n        setGroupMessages(response.data.data);\n      }\n    } catch (error) {\n      console.error('Failed to fetch group messages:', error);\n      toast.error('Failed to load messages');\n    } finally {\n      setLoadingMessages(false);\n    }\n  };\n\n  const fetchAvailableUsers = async () => {\n    try {\n      const response = await employeeAPI.get('/messages/chat-users');\n      if (response.data.success) {\n        setAvailableUsers(response.data.data);\n      }\n    } catch (error) {\n      console.error('Failed to fetch users:', error);\n    }\n  };\n\n  const handleSendMessage = async () => {\n    if (!newMessage.trim() || !selectedGroup) return;\n\n    const clientMessageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n    const tempMessage = {\n      _id: clientMessageId,\n      clientMessageId,\n      groupId: selectedGroup._id,\n      sender: {\n        _id: employeeData.id,\n        name: `${employeeData.personalInfo?.firstName} ${employeeData.personalInfo?.lastName}`,\n        profileImage: null\n      },\n      text: newMessage.trim(),\n      timestamp: new Date().toISOString(),\n      pending: true\n    };\n\n    setGroupMessages(prev => [...prev, tempMessage]);\n    setNewMessage('');\n\n    if (socket?.connected) {\n      socket.emit('group:message', {\n        groupId: selectedGroup._id,\n        text: newMessage.trim(),\n        clientMessageId\n      });\n    } else {\n      try {\n        const response = await employeeAPI.post(`/groups/${selectedGroup._id}/messages`, { text: newMessage.trim() });\n        if (response.data.success) {\n          setGroupMessages(prev => prev.map(m => \n            m.clientMessageId === clientMessageId ? response.data.data : m\n          ));\n        }\n      } catch (error) {\n        console.error('Failed to send message:', error);\n        setGroupMessages(prev => prev.filter(m => m.clientMessageId !== clientMessageId));\n        toast.error('Failed to send message');\n      }\n    }\n  };\n\n  const handleTyping = (e) => {\n    setNewMessage(e.target.value);\n    \n    if (socket?.connected && selectedGroup) {\n      socket.emit('group:typing:start', { groupId: selectedGroup._id });\n      \n      if (typingTimeoutRef.current) {\n        clearTimeout(typingTimeoutRef.current);\n      }\n      typingTimeoutRef.current = setTimeout(() => {\n        socket.emit('group:typing:stop', { groupId: selectedGroup._id });\n      }, 2000);\n    }\n  };\n\n  const handleCreateGroup = async () => {\n    if (!newGroupName.trim()) {\n      toast.error('Group name is required');\n      return;\n    }\n\n    try {\n      const response = await employeeAPI.post('/groups', {\n        name: newGroupName.trim(),\n        description: newGroupDescription.trim(),\n        memberIds: selectedMembers\n      });\n\n      if (response.data.success) {\n        toast.success('Group created successfully');\n        setGroups(prev => [response.data.data, ...prev]);\n        setShowCreateModal(false);\n        setNewGroupName('');\n        setNewGroupDescription('');\n        setSelectedMembers([]);\n        setSelectedGroup(response.data.data);\n\n        if (socket && selectedMembers.length > 0) {\n          socket.emit('group:member:added', {\n            groupId: response.data.data._id,\n            memberIds: selectedMembers\n          });\n        }\n      }\n    } catch (error) {\n      console.error('Failed to create group:', error);\n      toast.error('Failed to create group');\n    }\n  };\n\n  const handleAddMembers = async () => {\n    if (selectedMembers.length === 0 || !selectedGroup) return;\n\n    try {\n      const response = await employeeAPI.post(`/groups/${selectedGroup._id}/members`, {\n        memberIds: selectedMembers\n      });\n\n      if (response.data.success) {\n        toast.success('Members added successfully');\n        setSelectedGroup(response.data.data);\n        setShowAddMembers(false);\n        setSelectedMembers([]);\n\n        if (socket) {\n          socket.emit('group:member:added', {\n            groupId: selectedGroup._id,\n            memberIds: selectedMembers\n          });\n        }\n      }\n    } catch (error) {\n      console.error('Failed to add members:', error);\n      toast.error('Failed to add members');\n    }\n  };\n\n  const handleRemoveMember = async (memberId) => {\n    if (!selectedGroup) return;\n\n    try {\n      const response = await employeeAPI.delete(`/groups/${selectedGroup._id}/members/${memberId}`);\n      if (response.data.success) {\n        toast.success('Member removed');\n        setSelectedGroup(response.data.data);\n\n        if (socket) {\n          socket.emit('group:member:removed', {\n            groupId: selectedGroup._id,\n            memberId\n          });\n        }\n      }\n    } catch (error) {\n      console.error('Failed to remove member:', error);\n      toast.error('Failed to remove member');\n    }\n  };\n\n  const handleLeaveGroup = async () => {\n    if (!selectedGroup) return;\n\n    if (!window.confirm('Are you sure you want to leave this group?')) return;\n\n    try {\n      const response = await employeeAPI.post(`/groups/${selectedGroup._id}/leave`);\n      if (response.data.success) {\n        toast.success('You left the group');\n        setGroups(prev => prev.filter(g => g._id !== selectedGroup._id));\n        setSelectedGroup(null);\n        setGroupMessages([]);\n        setShowGroupSettings(false);\n      }\n    } catch (error) {\n      console.error('Failed to leave group:', error);\n      toast.error('Failed to leave group');\n    }\n  };\n\n  const handleDeleteGroup = async () => {\n    if (!selectedGroup) return;\n\n    if (!window.confirm('Are you sure you want to delete this group? This action cannot be undone.')) return;\n\n    try {\n      const response = await employeeAPI.delete(`/groups/${selectedGroup._id}`);\n      if (response.data.success) {\n        toast.success('Group deleted');\n        setGroups(prev => prev.filter(g => g._id !== selectedGroup._id));\n        setSelectedGroup(null);\n        setGroupMessages([]);\n        setShowGroupSettings(false);\n      }\n    } catch (error) {\n      console.error('Failed to delete group:', error);\n      toast.error('Failed to delete group');\n    }\n  };\n\n  const handleUpdateMemberRole = async (memberId, role) => {\n    if (!selectedGroup) return;\n\n    try {\n      const response = await employeeAPI.put(`/groups/${selectedGroup._id}/members/${memberId}/role`, { role });\n      if (response.data.success) {\n        toast.success('Member role updated');\n        setSelectedGroup(response.data.data);\n      }\n    } catch (error) {\n      console.error('Failed to update role:', error);\n      toast.error('Failed to update role');\n    }\n  };\n\n  const toggleMemberSelection = (userId) => {\n    setSelectedMembers(prev => \n      prev.includes(userId) \n        ? prev.filter(id => id !== userId)\n        : [...prev, userId]\n    );\n  };\n\n  const getMemberRole = (group, userId) => {\n    const member = group?.members?.find(m => (m.user?._id || m.user) === userId);\n    return member?.role || 'member';\n  };\n\n  const isGroupOwner = selectedGroup?.owner?._id === employeeData?.id || selectedGroup?.owner === employeeData?.id;\n  const isGroupAdmin = isGroupOwner || getMemberRole(selectedGroup, employeeData?.id) === 'admin';\n\n  const getTypingText = () => {\n    const names = Object.values(typingUsers);\n    if (names.length === 0) return null;\n    if (names.length === 1) return `${names[0]} is typing...`;\n    if (names.length === 2) return `${names[0]} and ${names[1]} are typing...`;\n    return `${names.length} people are typing...`;\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-[99999] flex items-center justify-center p-4\">\n      <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md z-[99998]\" onClick={onClose} />\n      <div className=\"relative z-[99999] glass-morphism neon-border rounded-2xl w-full max-w-4xl h-[80vh] flex flex-col shadow-2xl bg-gray-900\">\n        <div className=\"flex items-center justify-between p-4 border-b border-secondary-700\">\n          <h2 className=\"text-xl font-bold text-white flex items-center\">\n            <Users className=\"w-5 h-5 mr-2 text-neon-purple\" />\n            Group Chats\n          </h2>\n          <div className=\"flex items-center gap-2\">\n            <button \n              onClick={() => setShowCreateModal(true)}\n              className=\"p-2 text-secondary-400 hover:text-neon-pink transition-colors\"\n              title=\"Create new group\"\n            >\n              <Plus className=\"w-5 h-5\" />\n            </button>\n            <button onClick={onClose} className=\"text-secondary-400 hover:text-white transition-colors\">\n              <X className=\"w-6 h-6\" />\n            </button>\n          </div>\n        </div>\n\n        <div className=\"flex flex-1 overflow-hidden\">\n          <div className=\"w-1/3 border-r border-secondary-700 overflow-y-auto\">\n            <div className=\"p-3 text-sm text-secondary-400 font-medium\">\n              My Groups ({groups.length})\n            </div>\n            {loading ? (\n              <div className=\"p-4 text-center text-secondary-500 text-sm\">Loading groups...</div>\n            ) : groups.length === 0 ? (\n              <div className=\"p-4 text-center text-secondary-500 text-sm\">\n                <Users className=\"w-12 h-12 mx-auto mb-2 opacity-30\" />\n                <p>No groups yet</p>\n                <button \n                  onClick={() => setShowCreateModal(true)}\n                  className=\"mt-2 text-neon-pink hover:underline text-xs\"\n                >\n                  Create your first group\n                </button>\n              </div>\n            ) : (\n              groups.map(group => {\n                const onlineCount = group.members?.filter(m => \n                  onlineUsers.has(m.user?._id || m.user)\n                ).length || 0;\n                return (\n                  <div\n                    key={group._id}\n                    onClick={() => {\n                      setSelectedGroup(group);\n                      setShowGroupSettings(false);\n                    }}\n                    className={`p-3 border-l-4 cursor-pointer transition-colors ${\n                      selectedGroup?._id === group._id\n                        ? 'border-neon-purple bg-secondary-800/50 text-white'\n                        : 'border-transparent text-secondary-400 hover:bg-secondary-800/30'\n                    }`}\n                  >\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-10 h-10 bg-gradient-to-br from-neon-purple to-neon-pink rounded-full flex items-center justify-center flex-shrink-0\">\n                        <Users className=\"w-5 h-5 text-white\" />\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <div className=\"font-medium truncate\">{group.name}</div>\n                        <div className=\"text-xs text-secondary-500 flex items-center gap-1\">\n                          <span>{group.members?.length || 0} members</span>\n                          {onlineCount > 0 && <span className=\"text-green-400\">• {onlineCount} online</span>}\n                        </div>\n                        {group.lastMessage?.text && (\n                          <div className=\"text-xs text-secondary-500 truncate mt-1\">\n                            {group.lastMessage.text}\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                );\n              })\n            )}\n          </div>\n\n          <div className=\"flex-1 flex flex-col\">\n            {selectedGroup ? (\n              showGroupSettings ? (\n                <div className=\"flex-1 overflow-y-auto p-4\">\n                  <div className=\"flex items-center gap-2 mb-4\">\n                    <button \n                      onClick={() => setShowGroupSettings(false)}\n                      className=\"text-secondary-400 hover:text-white\"\n                    >\n                      <ArrowLeft className=\"w-5 h-5\" />\n                    </button>\n                    <h3 className=\"text-lg font-bold text-white\">Group Settings</h3>\n                  </div>\n\n                  <div className=\"space-y-4\">\n                    <div className=\"p-4 bg-secondary-800/50 rounded-lg\">\n                      <h4 className=\"text-white font-medium mb-2\">{selectedGroup.name}</h4>\n                      <p className=\"text-secondary-400 text-sm\">{selectedGroup.description || 'No description'}</p>\n                    </div>\n\n                    <div className=\"p-4 bg-secondary-800/50 rounded-lg\">\n                      <div className=\"flex items-center justify-between mb-3\">\n                        <h4 className=\"text-white font-medium\">Members ({selectedGroup.members?.length})</h4>\n                        {isGroupAdmin && (\n                          <button \n                            onClick={() => setShowAddMembers(true)}\n                            className=\"text-neon-pink hover:text-neon-purple text-sm flex items-center gap-1\"\n                          >\n                            <UserPlus className=\"w-4 h-4\" /> Add\n                          </button>\n                        )}\n                      </div>\n                      <div className=\"space-y-2 max-h-60 overflow-y-auto\">\n                        {selectedGroup.members?.map(member => {\n                          const memberId = member.user?._id || member.user;\n                          const memberName = member.user?.name || 'Unknown';\n                          const isOnline = onlineUsers.has(memberId);\n                          const isSelf = memberId === employeeData?.id;\n\n                          return (\n                            <div key={memberId} className=\"flex items-center justify-between p-2 rounded bg-secondary-700/50\">\n                              <div className=\"flex items-center gap-2\">\n                                <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-gray-500'}`} />\n                                <span className=\"text-white text-sm\">{memberName}</span>\n                                {member.role === 'owner' && (\n                                  <Crown className=\"w-4 h-4 text-yellow-500\" title=\"Owner\" />\n                                )}\n                                {member.role === 'admin' && (\n                                  <Shield className=\"w-4 h-4 text-blue-500\" title=\"Admin\" />\n                                )}\n                                {isSelf && <span className=\"text-xs text-secondary-400\">(You)</span>}\n                              </div>\n                              {isGroupOwner && !isSelf && member.role !== 'owner' && (\n                                <div className=\"flex items-center gap-1\">\n                                  <select\n                                    value={member.role}\n                                    onChange={(e) => handleUpdateMemberRole(memberId, e.target.value)}\n                                    className=\"text-xs bg-secondary-600 text-white rounded px-2 py-1 border-none\"\n                                  >\n                                    <option value=\"member\">Member</option>\n                                    <option value=\"admin\">Admin</option>\n                                  </select>\n                                  <button\n                                    onClick={() => handleRemoveMember(memberId)}\n                                    className=\"text-red-400 hover:text-red-300 p-1\"\n                                    title=\"Remove member\"\n                                  >\n                                    <Trash2 className=\"w-4 h-4\" />\n                                  </button>\n                                </div>\n                              )}\n                            </div>\n                          );\n                        })}\n                      </div>\n                    </div>\n\n                    <div className=\"flex flex-col gap-2\">\n                      <button\n                        onClick={handleLeaveGroup}\n                        className=\"w-full py-2 px-4 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition-colors flex items-center justify-center gap-2\"\n                      >\n                        <LogOut className=\"w-4 h-4\" /> Leave Group\n                      </button>\n                      {isGroupOwner && (\n                        <button\n                          onClick={handleDeleteGroup}\n                          className=\"w-full py-2 px-4 bg-red-600/20 text-red-500 rounded-lg hover:bg-red-600/30 transition-colors flex items-center justify-center gap-2\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" /> Delete Group\n                        </button>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              ) : (\n                <>\n                  <div className=\"p-3 border-b border-secondary-700 bg-secondary-800/30 flex items-center justify-between\">\n                    <div>\n                      <div className=\"font-bold text-white\">{selectedGroup.name}</div>\n                      <div className=\"text-sm text-secondary-400\">\n                        {selectedGroup.members?.length} members\n                        {getTypingText() && (\n                          <span className=\"ml-2 text-neon-pink animate-pulse\">{getTypingText()}</span>\n                        )}\n                      </div>\n                    </div>\n                    <button \n                      onClick={() => setShowGroupSettings(true)}\n                      className=\"p-2 text-secondary-400 hover:text-white rounded-lg hover:bg-secondary-700/50\"\n                    >\n                      <Settings className=\"w-5 h-5\" />\n                    </button>\n                  </div>\n\n                  <div className=\"flex-1 overflow-y-auto p-4 space-y-3 bg-secondary-900/30\">\n                    {loadingMessages ? (\n                      <div className=\"flex items-center justify-center h-full\">\n                        <div className=\"text-secondary-500\">Loading messages...</div>\n                      </div>\n                    ) : groupMessages.length === 0 ? (\n                      <div className=\"flex flex-col items-center justify-center h-full text-secondary-500\">\n                        <Users className=\"w-16 h-16 mb-3 opacity-30\" />\n                        <p className=\"text-sm\">No messages yet</p>\n                        <p className=\"text-xs mt-1\">Start the conversation!</p>\n                      </div>\n                    ) : (\n                      groupMessages.map((msg, idx) => {\n                        const isSelf = (msg.sender?._id || msg.sender) === employeeData?.id;\n                        return (\n                          <div key={msg._id || `msg-${idx}`} className={`flex ${isSelf ? 'justify-end' : 'justify-start'}`}>\n                            <div className={`max-w-xs md:max-w-md p-3 rounded-lg ${\n                              isSelf \n                                ? 'bg-gradient-to-r from-neon-purple to-neon-pink text-white' \n                                : 'bg-secondary-800 text-white'\n                            } ${msg.pending ? 'opacity-70' : ''}`}>\n                              {!isSelf && (\n                                <div className=\"text-xs text-secondary-400 mb-1 font-medium\">\n                                  {msg.sender?.name || 'Unknown'}\n                                </div>\n                              )}\n                              <div className=\"text-sm break-words\">{msg.text}</div>\n                              <div className={`text-xs mt-1 ${isSelf ? 'text-purple-200' : 'text-secondary-400'}`}>\n                                {new Date(msg.timestamp || msg.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n                              </div>\n                            </div>\n                          </div>\n                        );\n                      })\n                    )}\n                    <div ref={messagesEndRef} />\n                  </div>\n\n                  <div className=\"p-3 border-t border-secondary-700\">\n                    <form onSubmit={(e) => { e.preventDefault(); handleSendMessage(); }} className=\"flex\">\n                      <input\n                        type=\"text\"\n                        value={newMessage}\n                        onChange={handleTyping}\n                        onKeyDown={(e) => {\n                          if (e.key === 'Enter' && !e.shiftKey) {\n                            e.preventDefault();\n                            handleSendMessage();\n                          }\n                        }}\n                        placeholder=\"Type a message...\"\n                        className=\"flex-1 px-4 py-2 bg-secondary-800 border border-secondary-600 rounded-l-lg text-white placeholder-secondary-500 focus:outline-none focus:ring-2 focus:ring-neon-purple focus:border-transparent\"\n                        autoComplete=\"off\"\n                      />\n                      <button\n                        type=\"submit\"\n                        disabled={!newMessage.trim()}\n                        className=\"px-4 bg-gradient-to-r from-neon-purple to-neon-pink text-white rounded-r-lg disabled:opacity-50 disabled:cursor-not-allowed hover:opacity-90 transition-opacity\"\n                      >\n                        <Send className=\"w-4 h-4\" />\n                      </button>\n                    </form>\n                  </div>\n                </>\n              )\n            ) : (\n              <div className=\"flex-1 flex flex-col items-center justify-center text-secondary-500\">\n                <Users className=\"w-16 h-16 mb-3 opacity-30\" />\n                <p>Select a group to start chatting</p>\n                <p className=\"text-xs mt-1\">or create a new one</p>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {showCreateModal && (\n        <div className=\"fixed inset-0 z-[100000] flex items-center justify-center p-4\">\n          <div className=\"fixed inset-0 bg-black/50\" onClick={() => setShowCreateModal(false)} />\n          <div className=\"relative z-[100001] bg-gray-900 rounded-xl p-6 w-full max-w-md border border-secondary-700\">\n            <h3 className=\"text-lg font-bold text-white mb-4\">Create New Group</h3>\n            \n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"text-sm text-secondary-400 mb-1 block\">Group Name *</label>\n                <input\n                  type=\"text\"\n                  value={newGroupName}\n                  onChange={(e) => setNewGroupName(e.target.value)}\n                  placeholder=\"Enter group name\"\n                  className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:outline-none focus:ring-2 focus:ring-neon-purple\"\n                />\n              </div>\n              \n              <div>\n                <label className=\"text-sm text-secondary-400 mb-1 block\">Description</label>\n                <textarea\n                  value={newGroupDescription}\n                  onChange={(e) => setNewGroupDescription(e.target.value)}\n                  placeholder=\"Enter group description (optional)\"\n                  rows={2}\n                  className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:outline-none focus:ring-2 focus:ring-neon-purple resize-none\"\n                />\n              </div>\n\n              <div>\n                <label className=\"text-sm text-secondary-400 mb-1 block\">Add Members</label>\n                <div className=\"max-h-40 overflow-y-auto space-y-1 bg-secondary-800/50 rounded-lg p-2\">\n                  {availableUsers.map(user => (\n                    <div\n                      key={user._id}\n                      onClick={() => toggleMemberSelection(user._id)}\n                      className={`flex items-center justify-between p-2 rounded cursor-pointer transition-colors ${\n                        selectedMembers.includes(user._id)\n                          ? 'bg-neon-purple/20 border border-neon-purple/50'\n                          : 'hover:bg-secondary-700/50'\n                      }`}\n                    >\n                      <span className=\"text-white text-sm\">{user.name}</span>\n                      {selectedMembers.includes(user._id) && (\n                        <Check className=\"w-4 h-4 text-neon-purple\" />\n                      )}\n                    </div>\n                  ))}\n                </div>\n                {selectedMembers.length > 0 && (\n                  <p className=\"text-xs text-secondary-400 mt-1\">{selectedMembers.length} member(s) selected</p>\n                )}\n              </div>\n            </div>\n\n            <div className=\"flex gap-2 mt-6\">\n              <button\n                onClick={() => {\n                  setShowCreateModal(false);\n                  setNewGroupName('');\n                  setNewGroupDescription('');\n                  setSelectedMembers([]);\n                }}\n                className=\"flex-1 py-2 px-4 bg-secondary-700 text-white rounded-lg hover:bg-secondary-600 transition-colors\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={handleCreateGroup}\n                disabled={!newGroupName.trim()}\n                className=\"flex-1 py-2 px-4 bg-gradient-to-r from-neon-purple to-neon-pink text-white rounded-lg disabled:opacity-50 hover:opacity-90 transition-opacity\"\n              >\n                Create Group\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {showAddMembers && (\n        <div className=\"fixed inset-0 z-[100000] flex items-center justify-center p-4\">\n          <div className=\"fixed inset-0 bg-black/50\" onClick={() => setShowAddMembers(false)} />\n          <div className=\"relative z-[100001] bg-gray-900 rounded-xl p-6 w-full max-w-md border border-secondary-700\">\n            <h3 className=\"text-lg font-bold text-white mb-4\">Add Members</h3>\n            \n            <div className=\"max-h-60 overflow-y-auto space-y-1 bg-secondary-800/50 rounded-lg p-2\">\n              {availableUsers\n                .filter(user => !selectedGroup?.members?.some(m => (m.user?._id || m.user) === user._id))\n                .map(user => (\n                  <div\n                    key={user._id}\n                    onClick={() => toggleMemberSelection(user._id)}\n                    className={`flex items-center justify-between p-2 rounded cursor-pointer transition-colors ${\n                      selectedMembers.includes(user._id)\n                        ? 'bg-neon-purple/20 border border-neon-purple/50'\n                        : 'hover:bg-secondary-700/50'\n                    }`}\n                  >\n                    <span className=\"text-white text-sm\">{user.name}</span>\n                    {selectedMembers.includes(user._id) && (\n                      <Check className=\"w-4 h-4 text-neon-purple\" />\n                    )}\n                  </div>\n                ))}\n            </div>\n\n            <div className=\"flex gap-2 mt-6\">\n              <button\n                onClick={() => {\n                  setShowAddMembers(false);\n                  setSelectedMembers([]);\n                }}\n                className=\"flex-1 py-2 px-4 bg-secondary-700 text-white rounded-lg hover:bg-secondary-600 transition-colors\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={handleAddMembers}\n                disabled={selectedMembers.length === 0}\n                className=\"flex-1 py-2 px-4 bg-gradient-to-r from-neon-purple to-neon-pink text-white rounded-lg disabled:opacity-50 hover:opacity-90 transition-opacity\"\n              >\n                Add Members\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default GroupChatModal;\n","path":null,"size_bytes":32836,"size_tokens":null},"backend/config/db.js":{"content":"// config/db.js\nimport mongoose from 'mongoose';\n\nconst connectDB = async () => {\n  // Reuse existing connection if already connected\n  if (mongoose.connection.readyState >= 1) {\n    console.log('📦 MongoDB already connected');\n    return;\n  }\n\n  try {\n    const mongoUri = process.env.MONGODB_URI || \"mongodb+srv://yash14:m73FMaTmzwguxmKQ@ems.afot6m7.mongodb.net/?appName=ems\";\n    const conn = await mongoose.connect(mongoUri);\n    console.log(`📦 MongoDB Connected: ${conn.connection.host}`);\n\n    mongoose.connection.on('error', (err) => {\n      console.error('MongoDB connection error:', err);\n    });\n\n    mongoose.connection.on('disconnected', () => {\n      console.log('MongoDB disconnected');\n    });\n\n  } catch (err) {\n    console.error('Database connection failed:', err);\n    throw err;\n  }\n};\n\nexport default connectDB;\n","path":null,"size_bytes":837,"size_tokens":null},"TODO.md":{"content":"# EmployeeManagement Component Fixes\n\n## Tasks\n- [x] Remove duplicate and malformed updateSelectedEmployee function (No duplicate found - function is properly implemented)\n- [x] Move loading check to proper position at component return start (Already in correct position)\n- [x] Implement EditModal component for editing employee details (Already fully implemented)\n- [x] Verify component structure and exports (Component structure is correct and properly exported)\n","path":null,"size_bytes":465,"size_tokens":null},"backend/scripts/downloadFaceModels.js":{"content":"// scripts/downloadFaceModels.js\nimport https from 'https';\nimport fs from 'fs';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nconst modelsPath = path.join(__dirname, '../models/face-models');\nconst baseUrl = 'https://raw.githubusercontent.com/vladmandic/face-api/master/model/';\n\nconst models = [\n  // SSD MobileNet V1 - Face Detection\n  { name: 'ssd_mobilenetv1_model-weights_manifest.json', url: 'ssd_mobilenetv1_model-weights_manifest.json' },\n  { name: 'ssd_mobilenetv1_model.bin', url: 'ssd_mobilenetv1_model.bin' },\n\n  // Face Landmark 68 Point\n  { name: 'face_landmark_68_model-weights_manifest.json', url: 'face_landmark_68_model-weights_manifest.json' },\n  { name: 'face_landmark_68_model.bin', url: 'face_landmark_68_model.bin' },\n\n  // Face Recognition\n  { name: 'face_recognition_model-weights_manifest.json', url: 'face_recognition_model-weights_manifest.json' },\n  { name: 'face_recognition_model.bin', url: 'face_recognition_model.bin' }\n];\n\nasync function downloadFile(url, dest) {\n  return new Promise((resolve, reject) => {\n    const file = fs.createWriteStream(dest);\n    \n    https.get(url, (response) => {\n      if (response.statusCode !== 200) {\n        reject(new Error(`Failed to download ${url}: ${response.statusCode}`));\n        return;\n      }\n      \n      response.pipe(file);\n      \n      file.on('finish', () => {\n        file.close();\n        console.log(`✓ Downloaded: ${path.basename(dest)}`);\n        resolve();\n      });\n    }).on('error', (err) => {\n      fs.unlink(dest, () => {});\n      reject(err);\n    });\n  });\n}\n\nasync function downloadModels() {\n  try {\n    // Create models directory if it doesn't exist\n    if (!fs.existsSync(modelsPath)) {\n      fs.mkdirSync(modelsPath, { recursive: true });\n      console.log(`Created directory: ${modelsPath}`);\n    }\n\n    console.log('Downloading face-api models...\\n');\n\n    for (const model of models) {\n      const url = baseUrl + model.url;\n      const dest = path.join(modelsPath, model.name);\n\n      // Skip if file already exists\n      if (fs.existsSync(dest)) {\n        console.log(`⊘ Skipped (already exists): ${model.name}`);\n        continue;\n      }\n\n      await downloadFile(url, dest);\n    }\n\n    console.log('\\n✓ All models downloaded successfully!');\n    console.log(`Models location: ${modelsPath}`);\n  } catch (error) {\n    console.error('Error downloading models:', error);\n    process.exit(1);\n  }\n}\n\ndownloadModels();\n\n","path":null,"size_bytes":2544,"size_tokens":null},"backend/routes/payslipRoutes.js":{"content":"import express from 'express';\nimport { protect } from '../middleware/auth.js';\nimport {\n  generatePayslip,\n  getPayslips,\n  getPayslipById,\n  getEmployeePayslips,\n  downloadPayslip,\n  updatePayslipStatus,\n  deletePayslip,\n  generateBulkPayslips\n} from '../controllers/payslipController.js';\n\nconst router = express.Router();\n\nrouter.use(protect);\n\nrouter.post('/generate', generatePayslip);\nrouter.post('/bulk-generate', generateBulkPayslips);\n\nrouter.get('/', getPayslips);\nrouter.get('/employee/:employeeId', getEmployeePayslips);\nrouter.get('/:id/download', downloadPayslip);\nrouter.get('/:id', getPayslipById);\n\nrouter.patch('/:id/status', updatePayslipStatus);\nrouter.delete('/:id', deletePayslip);\n\nexport default router;\n","path":null,"size_bytes":729,"size_tokens":null},"frontend/vite.config.js":{"content":"import { defineConfig } from 'vite'\nimport react from '@vitejs/plugin-react'\n\n// https://vite.dev/config/\nexport default defineConfig({\n  plugins: [react()],\n  server: {\n    host: '0.0.0.0',\n    port: 5000,\n    strictPort: true,\n    allowedHosts: true,\n    proxy: {\n      '/api': {\n        target: 'http://localhost:3001',\n        changeOrigin: true,\n      },\n      '/socket.io': {\n        target: 'http://localhost:3001',\n        changeOrigin: true,\n        ws: true,\n      }\n    }\n  }\n})\n","path":null,"size_bytes":490,"size_tokens":null},"backend/routes/authRoutes.js":{"content":"import express from 'express';\nimport { body, validationResult } from 'express-validator';\nimport * as authController from '../controllers/authController.js';\nimport { protect } from '../middleware/auth.js';\n\nconst router = express.Router();\n\n// Validation middleware\n// Accept either email or employee ID for login\nconst loginValidation = [\n  body('email')\n    .notEmpty()\n    .withMessage('Email or Employee ID is required')\n    .custom((value) => {\n      // Accept either valid email OR employee ID format (alphanumeric with hyphens/underscores)\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n      const employeeIdRegex = /^[A-Za-z0-9_-]+$/;\n      if (!emailRegex.test(value) && !employeeIdRegex.test(value)) {\n        throw new Error('Please provide a valid email or employee ID');\n      }\n      return true;\n    }),\n  body('password')\n    .notEmpty()\n    .withMessage('Password is required')\n];\n\nconst registerValidation = [\n  body('name')\n    .trim()\n    .isLength({ min: 2, max: 50 })\n    .withMessage('Name must be between 2 and 50 characters'),\n  body('email')\n    .isEmail()\n    .normalizeEmail()\n    .withMessage('Please provide a valid email'),\n  body('password')\n    .isLength({ min: 6 })\n    .withMessage('Password must be at least 6 characters')\n    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)/)\n    .withMessage('Password must contain at least one uppercase letter, one lowercase letter, and one number')\n];\n\nconst forgotPasswordValidation = [\n  body('email')\n    .isEmail()\n    .normalizeEmail()\n    .withMessage('Please provide a valid email')\n];\n\nconst resetPasswordValidation = [\n  body('password')\n    .isLength({ min: 6 })\n    .withMessage('Password must be at least 6 characters')\n    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)/)\n    .withMessage('Password must contain at least one uppercase letter, one lowercase letter, and one number')\n];\n\nconst changePasswordValidation = [\n  body('currentPassword')\n    .notEmpty()\n    .withMessage('Current password is required'),\n  body('newPassword')\n    .isLength({ min: 6 })\n    .withMessage('New password must be at least 6 characters')\n    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)/)\n    .withMessage('New password must contain at least one uppercase letter, one lowercase letter, and one number')\n];\n\n// Public routes\nrouter.post('/login', loginValidation, authController.login);\nrouter.post('/register', registerValidation, authController.register);\nrouter.post('/forgot-password', forgotPasswordValidation, authController.forgotPassword);\nrouter.put('/reset-password/:resetToken', resetPasswordValidation, authController.resetPassword);\n\n// Protected routes\nrouter.use(protect); // All routes below this middleware are protected\n\n// Employee profile endpoints\nrouter.get('/me', authController.getMe);  // NEW: Get current employee's profile\nrouter.get('/profile', authController.getProfile);\nrouter.put('/profile', authController.updateProfile);\nrouter.put('/change-password', changePasswordValidation, authController.changePassword);\nrouter.post('/logout', authController.logout);\nrouter.delete('/delete-account', authController.deleteAccount);\n\n// Admin only routes\nrouter.get('/users', authController.getAllUsers); // Admin can view all users\nrouter.put('/users/:id/status', authController.updateUserStatus); // Admin can activate/deactivate users\nrouter.put('/users/:id/unlock', authController.unlockAccount); // Admin can unlock locked accounts\n\nexport default router;\n","path":null,"size_bytes":3452,"size_tokens":null},"frontend/src/components/Admin/Dashboard/QuickActions.jsx":{"content":"import React from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { Users, Calendar, Award, Clock, Building2, DollarSign, FileText, UserCheck } from 'lucide-react';\n\nconst QuickActions = ({ userRole = 'admin' }) => {\n  const navigate = useNavigate();\n\n  const adminActions = [\n    {\n      icon: Users,\n      label: 'Manage Employees',\n      href: '/admin/employees',\n      color: 'neon-pink',\n      description: 'Add, edit, or remove employees'\n    },\n    {\n      icon: Calendar,\n      label: 'Leave Management',\n      href: '/admin/leaves',\n      color: 'neon-purple',\n      description: 'Review and approve leave requests'\n    },\n    {\n      icon: Award,\n      label: 'Task Management',\n      href: '/admin/tasks',\n      color: 'neon-pink',\n      description: 'Assign and track tasks'\n    },\n    {\n      icon: Building2,\n      label: 'Departments',\n      href: '/admin/department',\n      color: 'neon-purple',\n      description: 'Manage company departments'\n    },\n    {\n      icon: Clock,\n      label: 'Attendance',\n      href: '/admin/attendance',\n      color: 'neon-pink',\n      description: 'Monitor employee attendance'\n    },\n    {\n      icon: UserCheck,\n      label: 'Face Registration',\n      href: '/admin/face-registration',\n      color: 'neon-purple',\n      description: 'Register employee faces'\n    },\n    {\n      icon: DollarSign,\n      label: 'Sales Dashboard',\n      href: '/admin/sales',\n      color: 'neon-pink',\n      description: 'View sales performance'\n    },\n    {\n      icon: FileText,\n      label: 'Purchase Orders',\n      href: '/admin/purchase-orders',\n      color: 'neon-purple',\n      description: 'Manage purchase orders'\n    }\n  ];\n\n  const employeeActions = [\n    {\n      icon: Clock,\n      label: 'Check In/Out',\n      href: '/employee/attendance',\n      color: 'neon-pink',\n      description: 'Mark your attendance'\n    },\n    {\n      icon: Calendar,\n      label: 'Apply for Leave',\n      href: '/employee/leaves',\n      color: 'neon-purple',\n      description: 'Submit leave applications'\n    },\n    {\n      icon: Award,\n      label: 'My Tasks',\n      href: '/employee/tasks',\n      color: 'neon-pink',\n      description: 'View assigned tasks'\n    },\n    {\n      icon: DollarSign,\n      label: 'Sales',\n      href: '/employee/sales',\n      color: 'neon-purple',\n      description: 'View your sales'\n    }\n  ];\n\n  const actions = userRole === 'admin' ? adminActions : employeeActions;\n  const visibleActions = actions.slice(0, userRole === 'admin' ? 8 : 4);\n\n  const handleActionClick = (href) => {\n    navigate(href);\n  };\n\n  return (\n    <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n      <div className=\"flex items-center justify-between mb-6\">\n        <h2 className=\"text-xl font-bold text-white\">Quick Actions</h2>\n        {userRole === 'admin' && (\n          <span className=\"text-xs px-2 py-1 bg-neon-pink/20 text-neon-pink rounded-full\">\n            Admin Panel\n          </span>\n        )}\n      </div>\n      \n      <div className={`grid gap-4 ${\n        userRole === 'admin' \n          ? 'grid-cols-2 md:grid-cols-4' \n          : 'grid-cols-2 md:grid-cols-2 lg:grid-cols-4'\n      }`}>\n        {visibleActions.map((action, index) => (\n          <button\n            key={index}\n            onClick={() => handleActionClick(action.href)}\n            className=\"p-4 rounded-lg border-2 border-dashed border-secondary-600 hover:border-neon-pink/50 hover:bg-neon-pink/5 transition-all duration-300 group relative overflow-hidden\"\n            title={action.description}\n          >\n            <div className=\"absolute inset-0 bg-gradient-to-r from-transparent via-neon-pink/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300\"></div>\n            \n            <div className=\"relative z-10\">\n              <action.icon className=\"w-8 h-8 text-secondary-400 group-hover:text-neon-pink mx-auto mb-2 transition-all duration-300 group-hover:scale-110\" />\n              <p className=\"text-sm text-secondary-400 group-hover:text-white transition-colors duration-300 leading-tight\">\n                {action.label}\n              </p>\n            </div>\n\n            <div className=\"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none whitespace-nowrap z-20\">\n              {action.description}\n              <div className=\"absolute top-full left-1/2 transform -translate-x-1/2 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900\"></div>\n            </div>\n          </button>\n        ))}\n      </div>\n    </div>\n  );\n};\n\nexport default QuickActions;","path":null,"size_bytes":4707,"size_tokens":null},"backend/models/Attendance.js":{"content":"// models/Attendance.js\nimport mongoose from 'mongoose';\n\nconst attendanceSchema = new mongoose.Schema({\n  employee: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'Employee',\n    required: true\n  },\n  user: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true\n  },\n  date: {\n    type: Date,\n    required: true,\n    default: function() {\n      const now = new Date();\n      return new Date(now.getFullYear(), now.getMonth(), now.getDate());\n    }\n  },\n  checkInTime: {\n    type: Date,\n    required: true\n  },\n  checkOutTime: {\n    type: Date,\n    // default: null\n  },\n\n  checkInLocation: {\n    type: {\n      latitude: {\n        type: Number,\n        required: true\n      },\n      longitude: {\n        type: Number,\n        required: true\n      },\n      address: {\n        type: String,\n        default: ''\n      },\n      accuracy: {\n        type: Number,\n        default: 0\n      }\n    },\n    \n    required: true\n  },\n  checkOutLocation: {\n    type: {\n      latitude: {\n        type: Number\n      },\n      longitude: {\n        type: Number\n      },\n      address: {\n        type: String,\n        default: ''\n      },\n      accuracy: {\n        type: Number,\n        default: 0\n      }\n    },\n    default: null\n  },\n  workingHours: {\n    type: Number,\n    default: 0 // in minutes\n  },\n  status: {\n    type: String,\n    enum: ['Present', 'Late', 'Half Day', 'Absent', 'Work from Home'],\n    default: 'Present'\n  },\n  isLate: {\n    type: Boolean,\n    default: false\n  },\n  lateMinutes: {\n    type: Number,\n    default: 0\n  },\n  notes: {\n    type: String,\n    default: ''\n  },\n  approvedBy: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    default: null\n  },\n  ipAddress: {\n    type: String,\n    default: ''\n  },\n  deviceInfo: {\n    userAgent: String,\n    platform: String,\n    browser: String\n  },\n  isManualEntry: {\n    type: Boolean,\n    default: false\n  },\n  manualEntryReason: {\n    type: String,\n    default: ''\n  }\n}, {\n  timestamps: true\n});\n\n// Create indexes - avoid duplicates by only defining them once here\nattendanceSchema.index({ user: 1, date: 1 });\nattendanceSchema.index({ date: 1 });\nattendanceSchema.index({ status: 1 });\nattendanceSchema.index({ checkInTime: 1 });\n\n// Compound unique index to prevent duplicate attendance for same day\nattendanceSchema.index(\n  { employee: 1, date: 1 },\n  { \n    unique: true,\n    partialFilterExpression: { date: { $type: \"date\" } }\n  }\n);\n\n// Pre-save middleware to set date to start of day and calculate working hours\nattendanceSchema.pre('save', function(next) {\n  // Ensure date is set to start of day (midnight) based on checkInTime\n  if (this.checkInTime && this.isNew) {\n    const checkInDate = new Date(this.checkInTime);\n    this.date = new Date(checkInDate.getFullYear(), checkInDate.getMonth(), checkInDate.getDate());\n  }\n\n  // Calculate working hours if both check-in and check-out exist\n  if (this.checkInTime && this.checkOutTime) {\n    const timeDiff = this.checkOutTime - this.checkInTime;\n    this.workingHours = Math.round(timeDiff / (1000 * 60)); // Convert to minutes\n  }\n\n  // Check if employee is late (assuming 9:00 AM is standard time)\n  if (this.checkInTime && (this.isNew || this.isModified('checkInTime'))) {\n    const checkInTime = new Date(this.checkInTime);\n    const standardTime = new Date(checkInTime);\n    standardTime.setHours(9, 0, 0, 0); // 9:00 AM\n\n    if (checkInTime > standardTime) {\n      this.isLate = true;\n      this.lateMinutes = Math.round((checkInTime - standardTime) / (1000 * 60));\n      \n      // Set status based on how late\n      if (this.lateMinutes > 240) { // More than 4 hours late\n        this.status = 'Half Day';\n      } else if (this.lateMinutes > 30) { // More than 30 minutes late\n        this.status = 'Late';\n      } else {\n        this.status = 'Present';\n      }\n    } else {\n      this.isLate = false;\n      this.lateMinutes = 0;\n      this.status = 'Present';\n    }\n  }\n\n  next();\n});\n\n// Instance method to calculate total working time with better formatting\nattendanceSchema.methods.getWorkingTime = function() {\n  if (!this.checkOutTime || !this.workingHours) {\n    return {\n      hours: 0,\n      minutes: 0,\n      total: '00:00',\n      totalMinutes: 0\n    };\n  }\n\n  const hours = Math.floor(this.workingHours / 60);\n  const minutes = this.workingHours % 60;\n  \n  return {\n    hours,\n    minutes,\n    total: `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`,\n    totalMinutes: this.workingHours\n  };\n};\n\n// Static method to get attendance summary for a date range\nattendanceSchema.statics.getAttendanceSummary = async function(employeeId, startDate, endDate) {\n  const start = new Date(startDate);\n  const end = new Date(endDate);\n  end.setHours(23, 59, 59, 999); // Include the entire end date\n  \n  return await this.aggregate([\n    {\n      $match: {\n        employee: new mongoose.Types.ObjectId(employeeId),\n        date: { $gte: start, $lte: end }\n      }\n    },\n    {\n      $group: {\n        _id: null,\n        totalDays: { $sum: 1 },\n        presentDays: { \n          $sum: { \n            $cond: [\n              { $or: [\n                { $eq: ['$status', 'Present'] },\n                { $eq: ['$status', 'Late'] }\n              ]}, \n              1, \n              0\n            ] \n          } \n        },\n        lateDays: { \n          $sum: { \n            $cond: [{ $eq: ['$status', 'Late'] }, 1, 0] \n          } \n        },\n        halfDays: { \n          $sum: { \n            $cond: [{ $eq: ['$status', 'Half Day'] }, 1, 0] \n          } \n        },\n        totalWorkingMinutes: { $sum: '$workingHours' },\n        avgCheckInTime: { $avg: '$checkInTime' }\n      }\n    }\n  ]);\n};\n\n// Static method to check if attendance exists for today\nattendanceSchema.statics.getTodayAttendance = async function(employeeId) {\n  const today = new Date();\n  const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());\n  const endOfDay = new Date(startOfDay.getTime() + 24 * 60 * 60 * 1000);\n  \n  return await this.findOne({\n    employee: employeeId,\n    date: { $gte: startOfDay, $lt: endOfDay }\n  }).populate([\n    { path: 'employee', select: 'personalInfo workInfo' },\n    { path: 'user', select: 'name email employeeId' }\n  ]);\n};\n\n// Static method to get monthly attendance statistics\nattendanceSchema.statics.getMonthlyStats = async function(year, month, employeeId = null) {\n  const startOfMonth = new Date(year, month - 1, 1);\n  const endOfMonth = new Date(year, month, 0);\n  endOfMonth.setHours(23, 59, 59, 999);\n\n  const matchCondition = {\n    date: { $gte: startOfMonth, $lte: endOfMonth }\n  };\n\n  if (employeeId) {\n    matchCondition.employee = new mongoose.Types.ObjectId(employeeId);\n  }\n\n  return await this.aggregate([\n    { $match: matchCondition },\n    {\n      $group: {\n        _id: employeeId ? '$employee' : null,\n        totalDays: { $sum: 1 },\n        presentDays: { \n          $sum: { \n            $cond: [\n              { $in: ['$status', ['Present', 'Late']] }, \n              1, \n              0\n            ] \n          } \n        },\n        lateDays: { $sum: { $cond: [{ $eq: ['$status', 'Late'] }, 1, 0] } },\n        halfDays: { $sum: { $cond: [{ $eq: ['$status', 'Half Day'] }, 1, 0] } },\n        totalWorkingHours: { $sum: '$workingHours' },\n        avgWorkingHours: { $avg: '$workingHours' }\n      }\n    }\n  ]);\n};\n\nconst Attendance = mongoose.model('Attendance', attendanceSchema);\n\nexport default Attendance;","path":null,"size_bytes":7462,"size_tokens":null},"backend/middleware/errorHandler.js":{"content":"// / middleware/errorHandler.js - NEW FILE\n\nconst errorHandler = (err, req, res, next) => {\n  let error = { ...err };\n  error.message = err.message;\n\n  console.error(err);\n\n  // Mongoose bad ObjectId\n  if (err.name === 'CastError') {\n    const message = 'Resource not found';\n    error = { message, statusCode: 404 };\n  }\n\n  // Mongoose duplicate key\n  if (err.code === 11000) {\n    const message = 'Duplicate field value entered';\n    error = { message, statusCode: 400 };\n  }\n\n  // Mongoose validation error\n  if (err.name === 'ValidationError') {\n    const message = Object.values(err.errors).map(val => val.message).join(', ');\n    error = { message, statusCode: 400 };\n  }\n\n  // JWT errors\n  if (err.name === 'JsonWebTokenError') {\n    const message = 'Invalid token';\n    error = { message, statusCode: 401 };\n  }\n\n  if (err.name === 'TokenExpiredError') {\n    const message = 'Token expired';\n    error = { message, statusCode: 401 };\n  }\n\n  res.status(error.statusCode || 500).json({\n    success: false,\n    message: error.message || 'Server Error',\n    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })\n  });\n};\n\nexport default errorHandler;\n","path":null,"size_bytes":1169,"size_tokens":null},"backend/controllers/faceDetectionController.js":{"content":"// controllers/faceDetectionController.js\nimport FaceData from '../models/FaceData.js';\nimport Employee from '../models/Employee.js';\nimport User from '../models/User.js';\nimport Attendance from '../models/Attendance.js';\nimport multer from 'multer';\nimport path from 'path';\nimport fs from 'fs/promises';\nimport * as faceService from '../services/faceRecognitionService.js';\n\n// Initialize face models on startup\nfaceService.initializeFaceModels().catch(err => {\n  console.error('Failed to initialize face models:', err);\n});\n\nconst storage = multer.diskStorage({\n  destination: async (req, file, cb) => {\n    const uploadDir = 'uploads/faces';\n    try {\n      await fs.mkdir(uploadDir, { recursive: true });\n      cb(null, uploadDir);\n    } catch (error) {\n      cb(error);\n    }\n  },\n  filename: (req, file, cb) => {\n    const uniqueName = `face_${Date.now()}_${Math.round(Math.random() * 1e9)}${path.extname(file.originalname)}`;\n    cb(null, uniqueName);\n  }\n});\n\nexport const upload = multer({\n  storage,\n  limits: { fileSize: 10 * 1024 * 1024 },\n  fileFilter: (req, file, cb) => {\n    const allowedTypes = /jpeg|jpg|png/;\n    const mimetype = allowedTypes.test(file.mimetype);\n    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());\n\n    if (mimetype && extname) return cb(null, true);\n    cb(new Error('Only JPEG, JPG and PNG images are allowed'));\n  }\n});\n\n// Legacy functions removed - now using integrated face recognition service\n\nfunction calculateGeoDistance(lat1, lon1, lat2, lon2) {\n  const R = 6371e3;\n  const toRad = (deg) => (deg * Math.PI) / 180;\n\n  const φ1 = toRad(lat1);\n  const φ2 = toRad(lat2);\n  const Δφ = toRad(lat2 - lat1);\n  const Δλ = toRad(lon2 - lon1);\n\n  const a =\n    Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +\n    Math.cos(φ1) * Math.cos(φ2) *\n    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n  return R * c;\n}\n\nconst FACE_MATCH_THRESHOLD = 0.9;\nconst MIN_CONFIDENCE_REQUIRED = 50;\n\n// @desc    Analyze a single video frame for face quality\n// @route   POST /api/face-detection/analyze-frame\n// @access  Private (Admin)\nexport const analyzeFrame = async (req, res) => {\n  try {\n    if (!req.file) {\n      return res.status(400).json({ success: false, message: 'Image is required' });\n    }\n\n    const imageBuffer = await fs.readFile(req.file.path);\n\n    let result;\n    try {\n      result = await faceService.detectSingleFace(imageBuffer);\n    } catch (error) {\n      try { await fs.unlink(req.file.path); } catch (_) {}\n      return res.status(500).json({\n        success: false,\n        message: 'Face analysis service error',\n        error: error.message\n      });\n    }\n\n    try { await fs.unlink(req.file.path); } catch (_) {}\n\n    if (!result.success) {\n      return res.json({\n        success: false,\n        face_detected: false,\n        message: result.message || 'No face detected'\n      });\n    }\n\n    res.json({\n      success: true,\n      face_detected: true,\n      quality: {\n        passed: result.face.confidence > 0.7,\n        score: result.face.confidence,\n        issues: result.face.confidence < 0.7 ? ['Low confidence detection'] : [],\n        details: {\n          confidence: result.face.confidence\n        }\n      },\n      bbox: result.face.bbox,\n      message: 'Frame analyzed successfully'\n    });\n\n  } catch (error) {\n    console.error('Analyze frame error:', error);\n    if (req.file && req.file.path) {\n      try { await fs.unlink(req.file.path); } catch (_) {}\n    }\n    res.status(500).json({ success: false, message: 'Server error during frame analysis' });\n  }\n};\n\n// @desc    Analyze frame from base64 for real-time feedback\n// @route   POST /api/face-detection/analyze-frame-base64\n// @access  Private (Admin)\nexport const analyzeFrameBase64 = async (req, res) => {\n  try {\n    const { image } = req.body;\n\n    console.log('Analyze frame base64 request received');\n\n    if (!image) {\n      console.log('No image data provided');\n      return res.status(400).json({ success: false, message: 'Image data is required' });\n    }\n\n    console.log('Processing base64 image...');\n    let result;\n    try {\n      result = await faceService.processBase64Image(image);\n      console.log('Face detection result:', result.success ? 'Success' : 'Failed');\n    } catch (error) {\n      console.error('Face service error:', error);\n      return res.status(500).json({\n        success: false,\n        message: 'Face analysis service error',\n        error: error.message\n      });\n    }\n\n    if (!result.success) {\n      console.log('Face detection failed:', result.message);\n      return res.json({\n        success: false,\n        face_detected: false,\n        message: result.message || 'No face detected'\n      });\n    }\n\n    console.log('Face detected successfully with confidence:', result.face.confidence);\n    res.json({\n      success: true,\n      face_detected: true,\n      face: {\n        descriptor: result.face.descriptor,\n        bbox: result.face.bbox,\n        confidence: result.face.confidence\n      },\n      quality: {\n        passed: result.face.confidence > 0.5,\n        score: result.face.confidence,\n        issues: result.face.confidence < 0.5 ? ['Low confidence detection'] : [],\n        details: {\n          confidence: result.face.confidence\n        }\n      },\n      bbox: result.face.bbox,\n      message: 'Frame analyzed successfully'\n    });\n\n  } catch (error) {\n    console.error('Analyze frame base64 error:', error);\n    console.error('Error stack:', error.stack);\n    res.status(500).json({ success: false, message: 'Server error during frame analysis', error: error.message });\n  }\n};\n\n// @desc    Register face with multiple angles (video-based)\n// @route   POST /api/face-detection/register-multi-angle\n// @access  Private (Admin)\nexport const registerMultiAngleFace = async (req, res) => {\n  try {\n    const { employeeId, frontImage, leftImage, rightImage } = req.body;\n\n    if (!employeeId) {\n      return res.status(400).json({ success: false, message: 'Employee ID is required' });\n    }\n\n    if (!frontImage || !leftImage || !rightImage) {\n      return res.status(400).json({ \n        success: false, \n        message: 'All three angle images (front, left, right) are required' \n      });\n    }\n\n    const employee = await Employee.findById(employeeId).populate('user');\n    if (!employee) {\n      return res.status(404).json({ success: false, message: 'Employee not found' });\n    }\n\n    let faceResult;\n    try {\n      faceResult = await faceService.registerMultiAngleFace(frontImage, leftImage, rightImage);\n    } catch (error) {\n      return res.status(500).json({\n        success: false,\n        message: error.message || 'Face registration service error'\n      });\n    }\n\n    if (!faceResult.success) {\n      return res.status(400).json({\n        success: false,\n        message: faceResult.message || 'Face registration failed'\n      });\n    }\n\n    // Update employee with multi-angle face data\n    employee.faceEmbeddings = {\n      front: faceResult.embeddings.front,\n      left: faceResult.embeddings.left,\n      right: faceResult.embeddings.right,\n      average: faceResult.embeddings.average\n    };\n    employee.faceQualityScores = faceResult.qualityScores;\n    employee.faceDescriptor = faceResult.embeddings.average;\n    employee.hasFaceRegistered = true;\n    employee.faceRegistrationDate = new Date();\n    employee.faceRegistrationMethod = 'multi-angle';\n\n    await employee.save();\n\n    // Also update/create FaceData record\n    const existingFaceData = await FaceData.findOne({ employee: employeeId });\n    if (existingFaceData) {\n      existingFaceData.faceDescriptor = faceResult.average_embedding;\n      existingFaceData.confidence = Math.round(\n        (faceResult.quality_scores.front + faceResult.quality_scores.left + faceResult.quality_scores.right) / 3 * 100\n      );\n      existingFaceData.lastUpdated = new Date();\n      existingFaceData.metadata = {\n        captureDevice: req.headers['user-agent'] || 'Unknown',\n        captureEnvironment: 'Multi-Angle Registration',\n        processingVersion: '2.0-InsightFace-MultiAngle'\n      };\n      await existingFaceData.save();\n    } else {\n      const faceData = new FaceData({\n        employee: employeeId,\n        user: employee.user._id,\n        faceDescriptor: faceResult.average_embedding,\n        landmarks: [],\n        faceImageUrl: '',\n        confidence: Math.round(\n          (faceResult.quality_scores.front + faceResult.quality_scores.left + faceResult.quality_scores.right) / 3 * 100\n        ),\n        metadata: {\n          captureDevice: req.headers['user-agent'] || 'Unknown',\n          captureEnvironment: 'Multi-Angle Registration',\n          processingVersion: '2.0-InsightFace-MultiAngle'\n        }\n      });\n      await faceData.save();\n    }\n\n    res.json({ \n      success: true, \n      message: 'Multi-angle face registration successful',\n      qualityScores: faceResult.quality_scores\n    });\n\n  } catch (error) {\n    console.error('Multi-angle face registration error:', error);\n    res.status(500).json({ success: false, message: 'Server error during face registration' });\n  }\n};\n\n// @desc    Verify face using video frames with liveness detection\n// @route   POST /api/face-detection/verify-video\n// @access  Private (Employee)\nexport const verifyVideoFace = async (req, res) => {\n  try {\n    const { frames, location } = req.body;\n\n    if (!frames || !Array.isArray(frames) || frames.length < 3) {\n      return res.status(400).json({\n        success: false,\n        message: 'At least 3 video frames are required for verification'\n      });\n    }\n\n    // Validate location data is provided\n    if (!location || location.latitude === undefined || location.longitude === undefined) {\n      return res.status(400).json({\n        success: false,\n        message: 'Location data is required for attendance verification'\n      });\n    }\n\n    const userLocation = location;\n\n    const employee = await Employee.findOne({ user: req.user.id });\n    if (!employee) {\n      return res.status(404).json({ success: false, message: 'Employee record not found' });\n    }\n\n    // Check for face registration - face-api.js uses 128 dimensions\n    let storedEmbeddings;\n    if (employee.faceEmbeddings && employee.faceEmbeddings.average && employee.faceEmbeddings.average.length === 128) {\n      storedEmbeddings = employee.faceEmbeddings;\n    } else if (employee.faceDescriptor && employee.faceDescriptor.length === 128) {\n      storedEmbeddings = { average: employee.faceDescriptor };\n    } else {\n      const faceData = await FaceData.findByEmployee(employee._id);\n      if (!faceData || !faceData.faceDescriptor || faceData.faceDescriptor.length !== 128) {\n        return res.status(404).json({\n          success: false,\n          message: 'Face data not registered. Please register your face first.'\n        });\n      }\n      storedEmbeddings = { average: faceData.faceDescriptor };\n    }\n\n    let verifyResult;\n    try {\n      verifyResult = await callFaceServiceJSON('/verify-video', {\n        frames: frames,\n        stored_embeddings: storedEmbeddings\n      });\n    } catch (error) {\n      return res.status(500).json({ \n        success: false, \n        message: 'Face verification service error', \n        error: error.message \n      });\n    }\n\n    if (!verifyResult.success) {\n      return res.status(400).json({\n        success: false,\n        message: verifyResult.message || 'Face verification failed',\n        verification: {\n          match: false,\n          confidence: verifyResult.confidence || 0,\n          liveness_score: verifyResult.liveness_score || 0\n        }\n      });\n    }\n\n    if (!verifyResult.match) {\n      return res.status(400).json({\n        success: false,\n        message: `Face verification failed. Confidence: ${Math.round(verifyResult.confidence)}%`,\n        verification: {\n          match: false,\n          confidence: verifyResult.confidence,\n          similarity: verifyResult.similarity,\n          liveness_score: verifyResult.liveness_score\n        }\n      });\n    }\n\n    // Location check\n    const OFFICE_LOCATION = {\n      latitude: 22.29867,\n      longitude: 73.13130,\n      radius: 100 // meters - Strict office location enforcement\n    };\n\n    const distance = calculateGeoDistance(\n      Number(userLocation.latitude),\n      Number(userLocation.longitude),\n      OFFICE_LOCATION.latitude,\n      OFFICE_LOCATION.longitude\n    );\n\n    if (!Number.isFinite(distance)) {\n      return res.status(400).json({ success: false, message: 'Invalid location coordinates' });\n    }\n\n    if (distance > OFFICE_LOCATION.radius) {\n      return res.status(400).json({\n        success: false,\n        message: `You are not within office premises. Distance: ${Math.round(distance)}m`,\n        verification: {\n          faceMatch: true,\n          faceConfidence: verifyResult.confidence,\n          livenessScore: verifyResult.liveness_score,\n          locationMatch: false,\n          distance: Math.round(distance),\n          maxDistance: OFFICE_LOCATION.radius\n        }\n      });\n    }\n\n    res.json({\n      success: true,\n      message: 'Face verification successful with liveness check',\n      verification: {\n        faceMatch: true,\n        faceConfidence: verifyResult.confidence,\n        similarity: verifyResult.similarity,\n        livenessScore: verifyResult.liveness_score,\n        locationMatch: true,\n        distance: Math.round(distance),\n        maxDistance: OFFICE_LOCATION.radius\n      }\n    });\n\n  } catch (error) {\n    console.error('Video face verification error:', error);\n    res.status(500).json({ success: false, message: 'Server error during face verification' });\n  }\n};\n\n// @desc    Save employee face data during registration (single image - legacy support)\n// @route   POST /api/face-detection/save-face\n// @access  Private (Admin)\nexport const saveEmployeeFace = async (req, res) => {\n  try {\n    const { employeeId } = req.body;\n\n    if (!employeeId) {\n      return res.status(400).json({ success: false, message: 'Employee ID is required' });\n    }\n\n    if (!req.file) {\n      return res.status(400).json({ success: false, message: 'Face image is required' });\n    }\n\n    const employee = await Employee.findById(employeeId).populate('user');\n    if (!employee) {\n      try { await fs.unlink(req.file.path); } catch (_) {}\n      return res.status(404).json({ success: false, message: 'Employee not found' });\n    }\n\n    const imageBuffer = await fs.readFile(req.file.path);\n\n    let faceResult;\n    try {\n      faceResult = await faceService.detectSingleFace(imageBuffer);\n    } catch (error) {\n      try { await fs.unlink(req.file.path); } catch (_) {}\n      return res.status(500).json({\n        success: false,\n        message: 'Face detection service error',\n        error: error.message\n      });\n    }\n\n    if (!faceResult.success) {\n      try { await fs.unlink(req.file.path); } catch (_) {}\n      return res.status(400).json({\n        success: false,\n        message: faceResult.message || 'No face detected in the image. Please try again with a clear face photo.'\n      });\n    }\n\n    const face = faceResult.face;\n    const faceDescriptor = face.descriptor;\n\n    if (!Array.isArray(faceDescriptor) || faceDescriptor.length === 0) {\n      try { await fs.unlink(req.file.path); } catch (_) {}\n      return res.status(500).json({\n        success: false,\n        message: 'Invalid face descriptor received from face service'\n      });\n    }\n\n    // Update employee with face data\n    employee.faceDescriptor = faceDescriptor;\n    employee.faceImage = req.file.path;\n    employee.hasFaceRegistered = true;\n    employee.faceRegistrationDate = new Date();\n    employee.faceRegistrationMethod = 'single';\n    await employee.save();\n\n    const existingFaceData = await FaceData.findOne({ employee: employeeId });\n    if (existingFaceData) {\n      existingFaceData.faceDescriptor = faceDescriptor;\n      existingFaceData.landmarks = [];\n      existingFaceData.faceImageUrl = req.file.path;\n      existingFaceData.lastUpdated = new Date();\n      existingFaceData.confidence = Math.round(face.confidence * 100);\n      existingFaceData.metadata = {\n        captureDevice: req.headers['user-agent'] || 'Unknown',\n        captureEnvironment: 'Registration',\n        processingVersion: '4.0-FaceAPI'\n      };\n\n      await existingFaceData.save();\n      return res.json({ success: true, message: 'Face data updated successfully', data: existingFaceData });\n    }\n\n    const faceData = new FaceData({\n      employee: employeeId,\n      user: employee.user._id,\n      faceDescriptor,\n      landmarks: [],\n      faceImageUrl: req.file.path,\n      confidence: Math.round(face.confidence * 100),\n      metadata: {\n        captureDevice: req.headers['user-agent'] || 'Unknown',\n        captureEnvironment: 'Registration',\n        processingVersion: '2.0-InsightFace'\n      }\n    });\n\n    await faceData.save();\n    res.status(201).json({ success: true, message: 'Face data saved successfully', data: faceData });\n\n  } catch (error) {\n    console.error('Save face data error:', error);\n    if (req.file && req.file.path) {\n      try { await fs.unlink(req.file.path); } catch (unlinkError) { console.error('Error deleting file:', unlinkError); }\n    }\n    res.status(500).json({ success: false, message: 'Server error while saving face data' });\n  }\n};\n\n// @desc    Get employee face data\n// @route   GET /api/face-detection/employee/:employeeId\n// @access  Private\nexport const getEmployeeFace = async (req, res) => {\n  try {\n    const { employeeId } = req.params;\n\n    const employee = await Employee.findById(employeeId);\n    if (employee && employee.hasFaceRegistered) {\n      return res.json({ \n        success: true, \n        data: {\n          _id: employee._id,\n          hasRegisteredFace: true,\n          registrationDate: employee.faceRegistrationDate,\n          registrationMethod: employee.faceRegistrationMethod,\n          hasMultiAngle: !!(employee.faceEmbeddings && employee.faceEmbeddings.average)\n        }\n      });\n    }\n\n    const faceData = await FaceData.findByEmployee(employeeId);\n    if (!faceData) {\n      return res.status(404).json({ success: false, message: 'Face data not found for this employee' });\n    }\n\n    const responseData = {\n      _id: faceData._id,\n      employee: faceData.employee,\n      user: faceData.user,\n      hasRegisteredFace: true,\n      registrationDate: faceData.registrationDate,\n      lastUpdated: faceData.lastUpdated,\n      confidence: faceData.confidence\n    };\n\n    res.json({ success: true, data: responseData });\n\n  } catch (error) {\n    console.error('Get employee face error:', error);\n    res.status(500).json({ success: false, message: 'Server error while fetching face data' });\n  }\n};\n\n// @desc    Verify face for attendance using InsightFace (single image - legacy)\n// @route   POST /api/face-detection/verify-attendance\n// @access  Private (Employee)\nexport const verifyFaceAttendance = async (req, res) => {\n  try {\n    console.log('📸 Face attendance verification started for user:', req.user.email);\n    let location = req.body.location;\n\n    if (!req.file) {\n      return res.status(400).json({ success: false, message: 'Face image is required' });\n    }\n\n    console.log('Image received, size:', req.file.size, 'bytes');\n\n    // Parse location if it's a JSON string (from FormData)\n    if (typeof location === 'string') {\n      try {\n        location = JSON.parse(location);\n      } catch (e) {\n        try { await fs.unlink(req.file.path); } catch (_) {}\n        return res.status(400).json({\n          success: false,\n          message: 'Invalid location data format'\n        });\n      }\n    }\n\n    // Validate location data is provided\n    if (!location || location.latitude === undefined || location.longitude === undefined) {\n      try { await fs.unlink(req.file.path); } catch (_) {}\n      return res.status(400).json({\n        success: false,\n        message: 'Location data is required for attendance verification'\n      });\n    }\n\n    const userLocation = location;\n\n    const employee = await Employee.findOne({ user: req.user.id });\n    if (!employee) {\n      try { await fs.unlink(req.file.path); } catch (_) {}\n      return res.status(404).json({ success: false, message: 'Employee record not found' });\n    }\n\n    console.log('Employee found:', employee.employeeId);\n\n    // Get stored descriptor from employee or FaceData\n    let storedDescriptor;\n    if (employee.faceEmbeddings && employee.faceEmbeddings.average && employee.faceEmbeddings.average.length > 0) {\n      storedDescriptor = employee.faceEmbeddings.average;\n    } else if (employee.faceDescriptor && employee.faceDescriptor.length > 0) {\n      storedDescriptor = employee.faceDescriptor;\n    } else {\n      const faceData = await FaceData.findByEmployee(employee._id);\n      if (!faceData) {\n        try { await fs.unlink(req.file.path); } catch (_) {}\n        return res.status(404).json({ success: false, message: 'Face data not registered. Please register your face first.' });\n      }\n      storedDescriptor = faceData.faceDescriptor;\n    }\n\n    if (!Array.isArray(storedDescriptor) || storedDescriptor.length === 0) {\n      try { await fs.unlink(req.file.path); } catch (_) {}\n      return res.status(500).json({ success: false, message: 'Stored face descriptor invalid' });\n    }\n\n    const imageBuffer = await fs.readFile(req.file.path);\n    console.log('Starting face detection...');\n\n    let currentFaceResult;\n    try {\n      currentFaceResult = await faceService.detectSingleFace(imageBuffer, {\n        skipFrontalityCheck: true,\n        skipQualityCheck: true\n      });\n      console.log('Face detection result:', currentFaceResult.success ? 'Success' : 'Failed');\n    } catch (error) {\n      console.error('Face detection error:', error);\n      try { await fs.unlink(req.file.path); } catch (_) {}\n      return res.status(500).json({\n        success: false,\n        message: 'Face detection service error',\n        error: error.message\n      });\n    }\n\n    try { await fs.unlink(req.file.path); } catch (_) {}\n\n    if (!currentFaceResult.success) {\n      return res.status(400).json({\n        success: false,\n        message: currentFaceResult.message || 'No face detected in the image',\n        verification: {\n          match: false,\n          confidence: 0\n        }\n      });\n    }\n\n    console.log('Comparing face descriptors...');\n    const verifyResult = faceService.verifyFaceMatch(currentFaceResult.face.descriptor, storedDescriptor);\n    console.log('Face match result:', verifyResult.match, 'Similarity:', Math.round(verifyResult.similarity * 100) + '%');\n\n    if (!verifyResult.match) {\n      return res.status(400).json({\n        success: false,\n        message: `Face verification failed. Similarity: ${Math.round(verifyResult.similarity * 100)}%`,\n        verification: {\n          match: false,\n          confidence: verifyResult.similarity * 100,\n          distance: verifyResult.distance\n        }\n      });\n    }\n\n    const OFFICE_LOCATION = {\n      latitude: 22.29867,\n      longitude: 73.13130,\n      radius: 100 // meters - Strict office location enforcement\n    };\n\n    const distance = calculateGeoDistance(\n      Number(userLocation.latitude),\n      Number(userLocation.longitude),\n      OFFICE_LOCATION.latitude,\n      OFFICE_LOCATION.longitude\n    );\n\n    if (!Number.isFinite(distance)) {\n      return res.status(400).json({ success: false, message: 'Invalid location coordinates' });\n    }\n\n    if (distance > OFFICE_LOCATION.radius) {\n      return res.status(400).json({\n        success: false,\n        message: `You are not within office premises. Distance: ${Math.round(distance)}m`,\n        verification: {\n          faceMatch: true,\n          faceConfidence: verifyResult.confidence,\n          locationMatch: false,\n          distance: Math.round(distance),\n          maxDistance: OFFICE_LOCATION.radius\n        }\n      });\n    }\n\n    res.json({\n      success: true,\n      message: 'Face and location verification successful',\n      verification: {\n        faceMatch: true,\n        faceConfidence: verifyResult.confidence,\n        locationMatch: true,\n        distance: Math.round(distance),\n        maxDistance: OFFICE_LOCATION.radius\n      }\n    });\n\n  } catch (error) {\n    console.error('Face verification error:', error);\n    if (req.file && req.file.path) {\n      try { await fs.unlink(req.file.path); } catch (_) {}\n    }\n    res.status(500).json({ success: false, message: 'Server error during face verification' });\n  }\n};\n\n// @desc    Delete employee face data\n// @route   DELETE /api/face-detection/employee/:employeeId\n// @access  Private (Admin)\nexport const deleteEmployeeFace = async (req, res) => {\n  try {\n    const { employeeId } = req.params;\n\n    // Clear employee face data\n    const employee = await Employee.findById(employeeId);\n    if (employee) {\n      employee.faceDescriptor = null;\n      employee.faceEmbeddings = {\n        front: null,\n        left: null,\n        right: null,\n        average: null\n      };\n      employee.faceQualityScores = {\n        front: 0,\n        left: 0,\n        right: 0\n      };\n      employee.faceImage = null;\n      employee.faceImages = {\n        front: null,\n        left: null,\n        right: null\n      };\n      employee.hasFaceRegistered = false;\n      employee.faceRegistrationDate = null;\n      employee.faceRegistrationMethod = null;\n      await employee.save();\n    }\n\n    const faceData = await FaceData.findOne({ employee: employeeId });\n    if (faceData) {\n      try {\n        if (faceData.faceImageUrl) await fs.unlink(faceData.faceImageUrl);\n      } catch (fileError) {\n        console.warn('Could not delete face image file:', fileError);\n      }\n      await faceData.deleteOne();\n    }\n\n    res.json({ success: true, message: 'Face data deleted successfully' });\n\n  } catch (error) {\n    console.error('Delete face data error:', error);\n    res.status(500).json({ success: false, message: 'Server error while deleting face data' });\n  }\n};\n\n// @desc    Get all employees without face data\n// @route   GET /api/face-detection/employees-without-face\n// @access  Private (Admin)\nexport const getEmployeesWithoutFace = async (req, res) => {\n  try {\n    const employeesWithoutFace = await Employee.find({\n      $or: [\n        { hasFaceRegistered: false },\n        { hasFaceRegistered: { $exists: false } }\n      ],\n      status: 'Active'\n    })\n      .populate('user', 'name email employeeId')\n      .select('personalInfo workInfo hasFaceRegistered');\n\n    res.json({ success: true, data: employeesWithoutFace, count: employeesWithoutFace.length });\n\n  } catch (error) {\n    console.error('Get employees without face error:', error);\n    res.status(500).json({ success: false, message: 'Server error while fetching employees' });\n  }\n};\n\n// @desc    Detect faces in an image (for testing/preview)\n// @route   POST /api/face-detection/detect\n// @access  Private\nexport const detectFaces = async (req, res) => {\n  try {\n    if (!req.file) {\n      return res.status(400).json({ success: false, message: 'Image is required' });\n    }\n\n    const imageBuffer = await fs.readFile(req.file.path);\n\n    let faceResult;\n    try {\n      faceResult = await faceService.detectFaces(imageBuffer);\n    } catch (error) {\n      try { await fs.unlink(req.file.path); } catch (_) {}\n      return res.status(500).json({\n        success: false,\n        message: 'Face detection service error',\n        error: error.message\n      });\n    }\n\n    try { await fs.unlink(req.file.path); } catch (_) {}\n\n    res.json({\n      success: true,\n      faces: faceResult.map(face => ({\n        bbox: face.bbox,\n        confidence: face.confidence,\n        descriptor: face.descriptor\n      })),\n      count: faceResult.length\n    });\n\n  } catch (error) {\n    console.error('Face detection error:', error);\n    if (req.file && req.file.path) {\n      try { await fs.unlink(req.file.path); } catch (_) {}\n    }\n    res.status(500).json({ success: false, message: 'Server error during face detection' });\n  }\n};\n\n// @desc    Register face using continuous video recording\n// @route   POST /api/face-detection/register-continuous-video\n// @access  Private (Admin)\nexport const registerContinuousVideo = async (req, res) => {\n  try {\n    const { employeeId, frames } = req.body;\n\n    if (!employeeId) {\n      return res.status(400).json({ success: false, message: 'Employee ID is required' });\n    }\n\n    if (!frames || !Array.isArray(frames) || frames.length < 10) {\n      return res.status(400).json({ \n        success: false, \n        message: 'At least 10 video frames are required for registration' \n      });\n    }\n\n    const employee = await Employee.findById(employeeId).populate('user');\n    if (!employee) {\n      return res.status(404).json({ success: false, message: 'Employee not found' });\n    }\n\n    let faceResult;\n    try {\n      faceResult = await faceService.processVideoFrames(frames);\n    } catch (error) {\n      return res.status(500).json({\n        success: false,\n        message: error.message || 'Face registration service error'\n      });\n    }\n\n    if (!faceResult.success) {\n      return res.status(400).json({\n        success: false,\n        message: faceResult.message || 'Face registration failed',\n        validFrames: faceResult.validFrames || 0\n      });\n    }\n\n    // Store the average descriptor as the main face embedding\n    employee.faceDescriptor = faceResult.averageDescriptor;\n    employee.faceEmbeddings = {\n      average: faceResult.averageDescriptor,\n      front: faceResult.averageDescriptor, // Use average for all angles\n      left: faceResult.averageDescriptor,\n      right: faceResult.averageDescriptor\n    };\n    employee.faceQualityScores = {\n      front: faceResult.validFrames / faceResult.framesProcessed,\n      left: faceResult.validFrames / faceResult.framesProcessed,\n      right: faceResult.validFrames / faceResult.framesProcessed\n    };\n    employee.hasFaceRegistered = true;\n    employee.faceRegistrationDate = new Date();\n    employee.faceRegistrationMethod = 'video';\n\n    await employee.save();\n\n    const existingFaceData = await FaceData.findOne({ employee: employeeId });\n    const livenessScore = faceResult.validFrames / faceResult.framesProcessed;\n\n    if (existingFaceData) {\n      existingFaceData.faceDescriptor = faceResult.averageDescriptor;\n      existingFaceData.confidence = Math.round(livenessScore * 100);\n      existingFaceData.lastUpdated = new Date();\n      existingFaceData.metadata = {\n        captureDevice: req.headers['user-agent'] || 'Unknown',\n        captureEnvironment: 'Continuous Video Registration',\n        processingVersion: '4.0-FaceAPI-Video'\n      };\n      await existingFaceData.save();\n    } else {\n      const faceData = new FaceData({\n        employee: employeeId,\n        user: employee.user._id,\n        faceDescriptor: faceResult.averageDescriptor,\n        landmarks: [],\n        faceImageUrl: '',\n        confidence: Math.round(livenessScore * 100),\n        metadata: {\n          captureDevice: req.headers['user-agent'] || 'Unknown',\n          captureEnvironment: 'Continuous Video Registration',\n          processingVersion: '4.0-FaceAPI-Video'\n        }\n      });\n      await faceData.save();\n    }\n\n    res.json({\n      success: true,\n      message: 'Face registered successfully with continuous video capture',\n      validFrames: faceResult.validFrames,\n      quality_scores: employee.faceQualityScores,\n      liveness_score: livenessScore,\n      total_frames_processed: faceResult.framesProcessed\n    });\n\n  } catch (error) {\n    console.error('Continuous video registration error:', error);\n    res.status(500).json({ success: false, message: 'Server error during face registration' });\n  }\n};\n\n// @desc    Verify face using live video with enhanced liveness detection\n// @route   POST /api/face-detection/verify-live-video\n// @access  Private (Employee)\nexport const verifyLiveVideo = async (req, res) => {\n  try {\n    const { frames, location } = req.body;\n\n    if (!frames || !Array.isArray(frames) || frames.length < 5) {\n      return res.status(400).json({\n        success: false,\n        message: 'At least 5 video frames are required for live verification'\n      });\n    }\n\n    // Validate location data is provided\n    if (!location || location.latitude === undefined || location.longitude === undefined) {\n      return res.status(400).json({\n        success: false,\n        message: 'Location data is required for attendance verification'\n      });\n    }\n\n    const userLocation = location;\n\n    const employee = await Employee.findOne({ user: req.user.id });\n    if (!employee) {\n      return res.status(404).json({ success: false, message: 'Employee record not found' });\n    }\n\n    let storedEmbeddings;\n    // face-api.js uses 128-dimensional descriptors, not 512\n    if (employee.faceEmbeddings && employee.faceEmbeddings.average && employee.faceEmbeddings.average.length > 0) {\n      storedEmbeddings = employee.faceEmbeddings;\n    } else if (employee.faceDescriptor && employee.faceDescriptor.length > 0) {\n      storedEmbeddings = { average: employee.faceDescriptor };\n    } else {\n      const faceData = await FaceData.findByEmployee(employee._id);\n      if (!faceData || !faceData.faceDescriptor || faceData.faceDescriptor.length === 0) {\n        return res.status(404).json({\n          success: false,\n          message: 'Face data not registered. Please register your face first.'\n        });\n      }\n      storedEmbeddings = { average: faceData.faceDescriptor };\n    }\n\n    let verifyResult;\n    try {\n      verifyResult = await faceService.verifyVideoFace(frames, storedEmbeddings);\n    } catch (error) {\n      return res.status(500).json({\n        success: false,\n        message: 'Face verification service error',\n        error: error.message\n      });\n    }\n\n    if (!verifyResult.success || !verifyResult.liveness_passed) {\n      return res.status(400).json({\n        success: false,\n        message: verifyResult.message || 'Liveness check failed - verification denied',\n        verification: {\n          match: false,\n          liveness_passed: false,\n          liveness_score: verifyResult.liveness_score || 0,\n          anti_spoof_score: verifyResult.anti_spoof_score || 0\n        }\n      });\n    }\n\n    if (!verifyResult.match) {\n      return res.status(400).json({\n        success: false,\n        message: `Face verification failed. Confidence: ${Math.round(verifyResult.confidence)}%`,\n        verification: {\n          match: false,\n          confidence: verifyResult.confidence,\n          similarity: verifyResult.similarity,\n          liveness_passed: true,\n          liveness_score: verifyResult.liveness_score\n        }\n      });\n    }\n\n    const OFFICE_LOCATION = {\n      latitude: 22.29867,\n      longitude: 73.13130,\n      radius: 100 // meters - Strict office location enforcement\n    };\n\n    const distance = calculateGeoDistance(\n      Number(userLocation.latitude),\n      Number(userLocation.longitude),\n      OFFICE_LOCATION.latitude,\n      OFFICE_LOCATION.longitude\n    );\n\n    if (!Number.isFinite(distance)) {\n      return res.status(400).json({ success: false, message: 'Invalid location coordinates' });\n    }\n\n    if (distance > OFFICE_LOCATION.radius) {\n      return res.status(400).json({\n        success: false,\n        message: `You are not within office premises. Distance: ${Math.round(distance)}m`,\n        verification: {\n          faceMatch: true,\n          faceConfidence: verifyResult.confidence,\n          livenessScore: verifyResult.liveness_score,\n          locationMatch: false,\n          distance: Math.round(distance)\n        }\n      });\n    }\n\n    res.json({\n      success: true,\n      message: 'Live face verification successful',\n      verification: {\n        faceMatch: true,\n        faceConfidence: verifyResult.confidence,\n        similarity: verifyResult.similarity,\n        livenessScore: verifyResult.liveness_score,\n        antiSpoofScore: verifyResult.anti_spoof_score,\n        locationMatch: true,\n        distance: Math.round(distance)\n      }\n    });\n\n  } catch (error) {\n    console.error('Live video verification error:', error);\n    res.status(500).json({ success: false, message: 'Server error during face verification' });\n  }\n};\n\n// @desc    Check liveness from video frames\n// @route   POST /api/face-detection/check-liveness\n// @access  Private\nexport const checkLiveness = async (req, res) => {\n  try {\n    const { frames } = req.body;\n\n    if (!frames || !Array.isArray(frames) || frames.length < 3) {\n      return res.status(400).json({ \n        success: false, \n        message: 'At least 3 video frames are required for liveness check' \n      });\n    }\n\n    let result;\n    try {\n      result = await faceService.processVideoFrames(frames);\n    } catch (error) {\n      return res.status(500).json({\n        success: false,\n        message: 'Liveness check service error',\n        error: error.message\n      });\n    }\n\n    if (!result.success) {\n      return res.json({\n        success: false,\n        liveness_passed: false,\n        message: result.message || 'Liveness check failed'\n      });\n    }\n\n    // Basic liveness score based on valid frames\n    const livenessScore = Math.min(1.0, result.validFrames / 10);\n    const livenessPassed = result.validFrames >= 3 && livenessScore > 0.3;\n\n    res.json({\n      success: true,\n      liveness_passed: livenessPassed,\n      liveness_score: livenessScore,\n      frames_analyzed: result.framesProcessed,\n      valid_frames: result.validFrames,\n      message: livenessPassed ? 'Liveness check passed' : 'Liveness check failed - insufficient valid frames'\n    });\n\n  } catch (error) {\n    console.error('Liveness check error:', error);\n    res.status(500).json({ success: false, message: 'Server error during liveness check' });\n  }\n};\n","path":null,"size_bytes":37847,"size_tokens":null},"frontend/src/components/Common/ErrorBoundary.jsx":{"content":"// components/Common/ErrorBoundary.js\nimport React from 'react';\nimport { AlertTriangle, RefreshCw, Home } from 'lucide-react';\n\nclass ErrorBoundary extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = { \n      hasError: false, \n      error: null, \n      errorInfo: null \n    };\n  }\n\n  static getDerivedStateFromError(error) {\n    return { hasError: true };\n  }\n\n  componentDidCatch(error, errorInfo) {\n    console.error('ErrorBoundary caught an error:', error, errorInfo);\n    this.setState({\n      error: error,\n      errorInfo: errorInfo\n    });\n\n    // Log error to monitoring service (e.g., Sentry, LogRocket)\n    if (process.env.NODE_ENV === 'production') {\n      // logErrorToService(error, errorInfo);\n    }\n  }\n\n  handleRetry = () => {\n    this.setState({ \n      hasError: false, \n      error: null, \n      errorInfo: null \n    });\n  };\n\n  handleGoHome = () => {\n    window.location.href = '/';\n  };\n\n  render() {\n    if (this.state.hasError) {\n      return (\n        <div className=\"min-h-screen bg-gradient-to-br from-secondary-900 via-secondary-800 to-secondary-900 flex items-center justify-center p-6\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-8 max-w-md w-full text-center\">\n            <div className=\"flex items-center justify-center w-16 h-16 bg-red-500/20 rounded-full mx-auto mb-6\">\n              <AlertTriangle className=\"w-8 h-8 text-red-400\" />\n            </div>\n            \n            <h1 className=\"text-2xl font-bold text-white mb-4\">\n              Oops! Something went wrong\n            </h1>\n            \n            <p className=\"text-secondary-400 mb-6 leading-relaxed\">\n              We encountered an unexpected error. Don't worry, our team has been notified and we're working to fix it.\n            </p>\n\n            {process.env.NODE_ENV === 'development' && this.state.error && (\n              <details className=\"text-left mb-6\">\n                <summary className=\"cursor-pointer text-red-400 mb-2\">\n                  Error Details (Development)\n                </summary>\n                <div className=\"bg-red-500/10 border border-red-500/20 rounded-lg p-4 text-xs\">\n                  <pre className=\"text-red-300 whitespace-pre-wrap break-words\">\n                    {this.state.error && this.state.error.toString()}\n                    <br />\n                    {this.state.errorInfo.componentStack}\n                  </pre>\n                </div>\n              </details>\n            )}\n\n            <div className=\"flex flex-col sm:flex-row gap-3\">\n              <button\n                onClick={this.handleRetry}\n                className=\"flex-1 flex items-center justify-center px-4 py-3 bg-neon-pink hover:bg-neon-pink/80 text-white rounded-lg transition-colors duration-300 group\"\n              >\n                <RefreshCw className=\"w-4 h-4 mr-2 group-hover:animate-spin\" />\n                Try Again\n              </button>\n              \n              <button\n                onClick={this.handleGoHome}\n                className=\"flex-1 flex items-center justify-center px-4 py-3 border border-secondary-600 hover:border-neon-purple text-secondary-400 hover:text-white rounded-lg transition-colors duration-300\"\n              >\n                <Home className=\"w-4 h-4 mr-2\" />\n                Go Home\n              </button>\n            </div>\n\n            <div className=\"mt-6 text-xs text-secondary-500\">\n              Error ID: {Date.now().toString(36)}\n            </div>\n          </div>\n        </div>\n      );\n    }\n\n    return this.props.children;\n  }\n}\n\nexport default ErrorBoundary;","path":null,"size_bytes":3607,"size_tokens":null},"backend/controllers/dashboardController.js":{"content":"// controllers/dashboardController.js\nimport Employee from '../models/Employee.js';\nimport User from '../models/User.js';\nimport Leave from '../models/Leave.js';\nimport Task from '../models/Task.js';\n\n// @desc    Get admin dashboard statistics\n// @route   GET /api/dashboard/stats\n// @access  Private (Admin)\nexport const getAdminStats = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    // Get employee statistics\n    const totalEmployees = await Employee.countDocuments({ status: { $ne: 'Terminated' } });\n    const activeEmployees = await Employee.countDocuments({ status: 'Active' });\n    const inactiveEmployees = await Employee.countDocuments({ status: 'Inactive' });\n    const onLeaveEmployees = await Employee.countDocuments({ status: 'On Leave' });\n\n    // Get department count\n    const departmentStats = await Employee.aggregate([\n      { $match: { status: { $ne: 'Terminated' } } },\n      { $group: { _id: '$workInfo.department', count: { $sum: 1 } } }\n    ]);\n    const totalDepartments = departmentStats.length;\n\n    // Get today's leaves\n    const today = new Date();\n    const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());\n    const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1);\n    \n    const leavesToday = await Leave.countDocuments({\n      status: 'Approved',\n      startDate: { $lte: endOfDay },\n      endDate: { $gte: startOfDay }\n    });\n\n    // Get pending leave requests\n    const pendingLeaves = await Leave.countDocuments({ status: 'Pending' });\n\n    // Get recent joinings (last 30 days)\n    const thirtyDaysAgo = new Date();\n    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\n    \n    const recentJoinings = await Employee.countDocuments({\n      'workInfo.joiningDate': { $gte: thirtyDaysAgo },\n      status: { $ne: 'Terminated' }\n    });\n\n    // Get task statistics\n    const totalTasks = await Task.countDocuments();\n    const completedTasks = await Task.countDocuments({ status: 'Completed' });\n    const overdueTasks = await Task.countDocuments({\n      status: { $nin: ['Completed', 'Cancelled'] },\n      dueDate: { $lt: new Date() }\n    });\n\n    res.json({\n      success: true,\n      totalEmployees,\n      activeEmployees,\n      inactiveEmployees,\n      onLeaveEmployees,\n      departments: totalDepartments,\n      leavesToday,\n      pendingLeaves,\n      recentJoinings,\n      totalTasks,\n      completedTasks,\n      overdueTasks,\n      departmentDistribution: departmentStats.map(stat => ({\n        department: stat._id,\n        count: stat.count\n      }))\n    });\n\n  } catch (error) {\n    console.error('Admin dashboard stats error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching dashboard statistics'\n    });\n  }\n};\n\n// @desc    Get employee dashboard statistics\n// @route   GET /api/dashboard/employee-stats\n// @access  Private (Employee)\nexport const getEmployeeStats = async (req, res) => {\n  try {\n    const employee = await Employee.findOne({ user: req.user.id });\n    \n    if (!employee) {\n      return res.status(404).json({\n        success: false,\n        message: 'Employee record not found'\n      });\n    }\n\n    // Get leave statistics for current year\n    const currentYear = new Date().getFullYear();\n    const yearStart = new Date(currentYear, 0, 1);\n    const yearEnd = new Date(currentYear, 11, 31);\n\n    const leaveStats = await Leave.aggregate([\n      {\n        $match: {\n          employee: employee._id,\n          status: 'Approved',\n          startDate: { $gte: yearStart, $lte: yearEnd }\n        }\n      },\n      {\n        $group: {\n          _id: '$leaveType',\n          totalDays: { $sum: '$totalDays' }\n        }\n      }\n    ]);\n\n    // Calculate leave balance\n    const leaveBalance = {\n      casual: { allocated: 12, used: 0, remaining: 12 },\n      sick: { allocated: 7, used: 0, remaining: 7 },\n      earned: { allocated: 15, used: 0, remaining: 15 }\n    };\n\n    leaveStats.forEach(stat => {\n      const leaveType = stat._id.toLowerCase();\n      if (leaveBalance[leaveType]) {\n        leaveBalance[leaveType].used = stat.totalDays;\n        leaveBalance[leaveType].remaining = leaveBalance[leaveType].allocated - stat.totalDays;\n      }\n    });\n\n    // Get task statistics for this employee\n    const myTasks = await Task.countDocuments({ assignedTo: employee._id });\n    const completedTasks = await Task.countDocuments({ \n      assignedTo: employee._id, \n      status: 'Completed' \n    });\n    const pendingTasks = await Task.countDocuments({ \n      assignedTo: employee._id, \n      status: { $in: ['Not Started', 'In Progress'] }\n    });\n    const overdueTasks = await Task.countDocuments({\n      assignedTo: employee._id,\n      status: { $nin: ['Completed', 'Cancelled'] },\n      dueDate: { $lt: new Date() }\n    });\n\n    // Get recent tasks\n    const recentTasks = await Task.find({ assignedTo: employee._id })\n      .sort({ createdAt: -1 })\n      .limit(5)\n      .select('title status priority dueDate');\n\n    // Get pending leave requests\n    const pendingLeaves = await Leave.countDocuments({\n      employee: employee._id,\n      status: 'Pending'\n    });\n\n    // Calculate attendance (mock for now - you can implement actual attendance tracking)\n    const attendanceData = {\n      currentMonth: {\n        present: 22,\n        absent: 1,\n        total: 23\n      }\n    };\n\n    res.json({\n      success: true,\n      employee: {\n        name: employee.fullName,\n        employeeId: employee.user?.employeeId,\n        department: employee.workInfo?.department,\n        position: employee.workInfo?.position,\n        joiningDate: employee.workInfo?.joiningDate\n      },\n      leaveBalance,\n      tasks: {\n        total: myTasks,\n        completed: completedTasks,\n        pending: pendingTasks,\n        overdue: overdueTasks,\n        recent: recentTasks\n      },\n      attendance: attendanceData,\n      pendingLeaves\n    });\n\n  } catch (error) {\n    console.error('Employee dashboard stats error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching dashboard statistics'\n    });\n  }\n};\n\n// @desc    Get recent activities (admin)\n// @route   GET /api/dashboard/activities\n// @access  Private (Admin)\nexport const getRecentActivities = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    // Get recent employee additions\n    const recentEmployees = await Employee.find()\n      .populate('user', 'name email')\n      .sort({ createdAt: -1 })\n      .limit(5);\n\n    // Get recent leave applications\n    const recentLeaves = await Leave.find()\n      .populate('employee', 'personalInfo.firstName personalInfo.lastName')\n      .populate('user', 'name')\n      .sort({ appliedDate: -1 })\n      .limit(5);\n\n    // Get recent task completions\n    const recentTaskCompletions = await Task.find({ \n      status: 'Completed',\n      completedDate: { $exists: true }\n    })\n      .populate('assignedTo', 'personalInfo.firstName personalInfo.lastName')\n      .sort({ completedDate: -1 })\n      .limit(5);\n\n    // Format activities\n    const activities = [];\n\n    recentEmployees.forEach(emp => {\n      activities.push({\n        id: emp._id,\n        type: 'success',\n        action: 'New employee added to the system',\n        user: emp.fullName,\n        time: emp.createdAt,\n        category: 'employee'\n      });\n    });\n\n    recentLeaves.forEach(leave => {\n      activities.push({\n        id: leave._id,\n        type: leave.status === 'Approved' ? 'success' : leave.status === 'Pending' ? 'warning' : 'info',\n        action: `Leave application ${leave.status.toLowerCase()}`,\n        user: leave.employee?.fullName || leave.user?.name,\n        time: leave.appliedDate,\n        category: 'leave'\n      });\n    });\n\n    recentTaskCompletions.forEach(task => {\n      activities.push({\n        id: task._id,\n        type: 'success',\n        action: `Completed task: ${task.title}`,\n        user: task.assignedTo?.fullName,\n        time: task.completedDate,\n        category: 'task'\n      });\n    });\n\n    // Sort all activities by time and limit\n    activities.sort((a, b) => new Date(b.time) - new Date(a.time));\n    const limitedActivities = activities.slice(0, 10);\n\n    res.json({\n      success: true,\n      activities: limitedActivities.map(activity => ({\n        ...activity,\n        time: new Date(activity.time).toLocaleString()\n      }))\n    });\n\n  } catch (error) {\n    console.error('Get activities error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching activities'\n    });\n  }\n};\n\n// @desc    Get upcoming events/deadlines\n// @route   GET /api/dashboard/events\n// @access  Private\nexport const getUpcomingEvents = async (req, res) => {\n  try {\n    const upcomingEvents = [];\n\n    // Get upcoming task deadlines\n    const upcomingTasks = await Task.find({\n      status: { $nin: ['Completed', 'Cancelled'] },\n      dueDate: { \n        $gte: new Date(),\n        $lte: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // Next 7 days\n      }\n    })\n      .populate('assignedTo', 'personalInfo.firstName personalInfo.lastName workInfo.department')\n      .sort({ dueDate: 1 })\n      .limit(5);\n\n    upcomingTasks.forEach(task => {\n      upcomingEvents.push({\n        id: task._id,\n        title: `Task Deadline: ${task.title}`,\n        date: task.dueDate,\n        time: new Date(task.dueDate).toLocaleTimeString(),\n        department: task.assignedTo?.workInfo?.department || 'General',\n        type: 'task',\n        priority: task.priority\n      });\n    });\n\n    // Get upcoming leave periods\n    const upcomingLeaves = await Leave.find({\n      status: 'Approved',\n      startDate: {\n        $gte: new Date(),\n        $lte: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // Next 7 days\n      }\n    })\n      .populate('employee', 'personalInfo.firstName personalInfo.lastName workInfo.department')\n      .sort({ startDate: 1 })\n      .limit(5);\n\n    upcomingLeaves.forEach(leave => {\n      upcomingEvents.push({\n        id: leave._id,\n        title: `${leave.employee?.fullName} on ${leave.leaveType} leave`,\n        date: leave.startDate,\n        time: 'All Day',\n        department: leave.employee?.workInfo?.department || 'General',\n        type: 'leave',\n        duration: leave.duration\n      });\n    });\n\n    // Sort events by date\n    upcomingEvents.sort((a, b) => new Date(a.date) - new Date(b.date));\n\n    res.json({\n      success: true,\n      events: upcomingEvents.slice(0, 6)\n    });\n\n  } catch (error) {\n    console.error('Get upcoming events error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching upcoming events'\n    });\n  }\n};\n\n// @desc    Get dashboard summary for both admin and employee\n// @route   GET /api/dashboard/summary\n// @access  Private\nexport const getDashboardSummary = async (req, res) => {\n  try {\n    if (req.user.role === 'admin') {\n      return getAdminStats(req, res);\n    } else {\n      return getEmployeeStats(req, res);\n    }\n  } catch (error) {\n    console.error('Dashboard summary error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching dashboard summary'\n    });\n  }\n};\n// Add these endpoints to your existing controllers/dashboardController.js\n\n// @desc    Get user-specific notifications\n// @route   GET /api/dashboard/notifications\n// @access  Private\nexport const getUserNotifications = async (req, res) => {\n  try {\n    const notifications = [];\n    \n    if (req.user.role === 'admin') {\n      // Admin notifications - recent system activities\n      \n      // Recent employee additions (last 7 days)\n      const recentEmployees = await Employee.find({\n        createdAt: { $gte: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) }\n      })\n        .populate('user', 'name email')\n        .sort({ createdAt: -1 })\n        .limit(5);\n\n      recentEmployees.forEach(emp => {\n        notifications.push({\n          id: `employee-${emp._id}`,\n          message: `New employee ${emp.fullName} has been added to the system`,\n          user: emp.fullName,\n          time: emp.createdAt,\n          type: 'success',\n          category: 'employee',\n          unread: true\n        });\n      });\n\n      // Recent leave applications (last 3 days)\n      const recentLeaves = await Leave.find({\n        appliedDate: { $gte: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000) }\n      })\n        .populate('employee', 'personalInfo.firstName personalInfo.lastName')\n        .populate('user', 'name')\n        .sort({ appliedDate: -1 })\n        .limit(10);\n\n      recentLeaves.forEach(leave => {\n        const employeeName = leave.employee?.fullName || leave.user?.name;\n        notifications.push({\n          id: `leave-${leave._id}`,\n          message: `${employeeName} has applied for ${leave.leaveType.toLowerCase()} leave`,\n          user: employeeName,\n          time: leave.appliedDate,\n          type: leave.status === 'Pending' ? 'warning' : 'info',\n          category: 'leave',\n          unread: true\n        });\n      });\n\n      // Pending approvals\n      const pendingLeaves = await Leave.countDocuments({ status: 'Pending' });\n      if (pendingLeaves > 0) {\n        notifications.push({\n          id: 'pending-leave-approvals',\n          message: `You have ${pendingLeaves} pending leave applications to review`,\n          time: new Date().toISOString(),\n          type: 'warning',\n          category: 'leave',\n          unread: true\n        });\n      }\n\n      // Low attendance alerts\n      const today = new Date();\n      const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);\n      \n      // This would require an Attendance model - simplified for now\n      const lowAttendanceEmployees = await Employee.aggregate([\n        {\n          $lookup: {\n            from: 'attendances',\n            localField: '_id',\n            foreignField: 'employee',\n            as: 'attendanceRecords'\n          }\n        },\n        {\n          $addFields: {\n            monthlyAttendance: {\n              $size: {\n                $filter: {\n                  input: '$attendanceRecords',\n                  cond: {\n                    $and: [\n                      { $gte: ['$$this.date', startOfMonth] },\n                      { $eq: ['$$this.status', 'Present'] }\n                    ]\n                  }\n                }\n              }\n            }\n          }\n        },\n        { $match: { monthlyAttendance: { $lt: 15 } } }, // Less than 15 days present\n        { $limit: 5 }\n      ]);\n\n      lowAttendanceEmployees.forEach(emp => {\n        notifications.push({\n          id: `low-attendance-${emp._id}`,\n          message: `${emp.fullName} has low attendance this month (${emp.monthlyAttendance} days)`,\n          user: emp.fullName,\n          time: new Date().toISOString(),\n          type: 'error',\n          category: 'attendance',\n          unread: true\n        });\n      });\n\n    } else {\n      // Employee notifications - personal activities and tasks\n      const employee = await Employee.findOne({ user: req.user.id });\n      \n      if (employee) {\n        // Task-related notifications\n        const myTasks = await Task.find({ assignedTo: employee._id });\n        const pendingTasks = myTasks.filter(t => ['Not Started', 'In Progress'].includes(t.status));\n        const overdueTasks = myTasks.filter(t => \n          !['Completed', 'Cancelled'].includes(t.status) && \n          new Date(t.dueDate) < new Date()\n        );\n\n        if (pendingTasks.length > 0) {\n          notifications.push({\n            id: 'my-pending-tasks',\n            message: `You have ${pendingTasks.length} pending task${pendingTasks.length > 1 ? 's' : ''} to complete`,\n            time: new Date().toISOString(),\n            type: 'warning',\n            category: 'tasks',\n            unread: true\n          });\n        }\n\n        if (overdueTasks.length > 0) {\n          notifications.push({\n            id: 'my-overdue-tasks',\n            message: `You have ${overdueTasks.length} overdue task${overdueTasks.length > 1 ? 's' : ''}`,\n            time: new Date().toISOString(),\n            type: 'error',\n            category: 'tasks',\n            unread: true\n          });\n\n          // Individual overdue task notifications\n          overdueTasks.slice(0, 3).forEach(task => {\n            notifications.push({\n              id: `overdue-task-${task._id}`,\n              message: `Task \"${task.title}\" was due on ${new Date(task.dueDate).toLocaleDateString()}`,\n              time: task.dueDate,\n              type: 'error',\n              category: 'task',\n              unread: true\n            });\n          });\n        }\n\n        // Leave-related notifications\n        const myLeaves = await Leave.find({ employee: employee._id });\n        const pendingLeaves = myLeaves.filter(l => l.status === 'Pending');\n        const approvedUpcomingLeaves = myLeaves.filter(l => \n          l.status === 'Approved' && \n          new Date(l.startDate) > new Date() &&\n          new Date(l.startDate) <= new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // Next 7 days\n        );\n\n        if (pendingLeaves.length > 0) {\n          notifications.push({\n            id: 'my-pending-leaves',\n            message: `You have ${pendingLeaves.length} pending leave request${pendingLeaves.length > 1 ? 's' : ''}`,\n            time: new Date().toISOString(),\n            type: 'info',\n            category: 'leaves',\n            unread: true\n          });\n        }\n\n        approvedUpcomingLeaves.forEach(leave => {\n          notifications.push({\n            id: `upcoming-leave-${leave._id}`,\n            message: `Your ${leave.leaveType.toLowerCase()} leave starts on ${new Date(leave.startDate).toLocaleDateString()}`,\n            time: leave.startDate,\n            type: 'success',\n            category: 'leave',\n            unread: true\n          });\n        });\n\n        // Recently completed tasks (achievements)\n        const recentCompletions = await Task.find({\n          assignedTo: employee._id,\n          status: 'Completed',\n          completedDate: { \n            $gte: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000) // Last 3 days\n          }\n        }).sort({ completedDate: -1 }).limit(5);\n\n        recentCompletions.forEach(task => {\n          notifications.push({\n            id: `completed-task-${task._id}`,\n            message: `You completed \"${task.title}\"`,\n            time: task.completedDate,\n            type: 'success',\n            category: 'task',\n            unread: true\n          });\n        });\n\n        // Profile completion reminder (if incomplete)\n        const profileCompletion = calculateProfileCompletion(employee);\n        if (profileCompletion < 80) {\n          notifications.push({\n            id: 'profile-incomplete',\n            message: `Your profile is ${profileCompletion}% complete. Please update your information.`,\n            time: new Date().toISOString(),\n            type: 'warning',\n            category: 'profile',\n            unread: true\n          });\n        }\n\n        // Face registration reminder (if not registered)\n        if (!employee.hasFaceRegistered) {\n          notifications.push({\n            id: 'face-registration-pending',\n            message: 'Complete your face registration for biometric attendance',\n            time: new Date().toISOString(),\n            type: 'info',\n            category: 'profile',\n            unread: true\n          });\n        }\n      }\n    }\n\n    // Sort notifications by time (most recent first)\n    notifications.sort((a, b) => new Date(b.time) - new Date(a.time));\n\n    res.json({\n      success: true,\n      data: notifications.slice(0, 20), // Limit to 20 most recent notifications\n      unreadCount: notifications.filter(n => n.unread).length\n    });\n\n  } catch (error) {\n    console.error('Get notifications error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching notifications'\n    });\n  }\n};\n\n// Helper function to calculate profile completion percentage\nconst calculateProfileCompletion = (employee) => {\n  const fields = [\n    employee.personalInfo?.firstName,\n    employee.personalInfo?.lastName,\n    employee.personalInfo?.dateOfBirth,\n    employee.personalInfo?.gender,\n    employee.contactInfo?.phone,\n    employee.contactInfo?.personalEmail,\n    employee.contactInfo?.address?.city,\n    employee.workInfo?.position,\n    employee.workInfo?.department,\n    employee.bankInfo?.accountNumber,\n    employee.bankInfo?.bankName\n  ];\n  \n  const completedFields = fields.filter(field => field && field.trim() !== '').length;\n  return Math.round((completedFields / fields.length) * 100);\n};\n\n// @desc    Mark notification as read\n// @route   PUT /api/dashboard/notifications/:id/read\n// @access  Private\nexport const markNotificationAsRead = async (req, res) => {\n  try {\n    // In a real implementation, you'd store notification read status in database\n    // For now, we'll just return success\n    res.json({\n      success: true,\n      message: 'Notification marked as read'\n    });\n  } catch (error) {\n    console.error('Mark notification as read error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while marking notification as read'\n    });\n  }\n};\n\n// @desc    Mark all notifications as read\n// @route   PUT /api/dashboard/notifications/read-all\n// @access  Private\nexport const markAllNotificationsAsRead = async (req, res) => {\n  try {\n    // In a real implementation, you'd update all unread notifications for the user\n    res.json({\n      success: true,\n      message: 'All notifications marked as read'\n    });\n  } catch (error) {\n    console.error('Mark all notifications as read error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while marking notifications as read'\n    });\n  }\n};","path":null,"size_bytes":22143,"size_tokens":null},"frontend/src/components/Admin/DepartmentManagement.jsx":{"content":"import React from 'react'\n\nfunction DepartmentManagement() {\n  return (\n    <div>DepartmentManagement</div>\n  )\n}\n\nexport default DepartmentManagement","path":null,"size_bytes":150,"size_tokens":null},"backend/models/Message.js":{"content":"// backend/models/Message.js\nimport mongoose from 'mongoose';\n\nconst messageSchema = new mongoose.Schema({\n  from: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    default: null // Bot messages have from: null\n  },\n  to: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true\n  },\n  text: {\n    type: String,\n    required: true,\n    trim: true\n  },\n  timestamp: {\n    type: Date,\n    default: Date.now\n  },\n  fromBot: {\n    type: Boolean,\n    default: false\n  }\n}, {\n  timestamps: true\n});\n\nmessageSchema.index({ from: 1, to: 1, timestamp: -1 });\nmessageSchema.index({ to: 1, from: 1, timestamp: -1 });\n\nexport default mongoose.model('Message', messageSchema);","path":null,"size_bytes":701,"size_tokens":null},"backend/models/Payslip.js":{"content":"import mongoose from 'mongoose';\n\nconst payslipSchema = new mongoose.Schema({\n  employee: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'Employee',\n    required: true\n  },\n  employeeId: {\n    type: String,\n    required: true\n  },\n  employeeName: {\n    type: String,\n    required: true\n  },\n  period: {\n    month: {\n      type: Number,\n      required: true,\n      min: 1,\n      max: 12\n    },\n    year: {\n      type: Number,\n      required: true\n    }\n  },\n  earnings: {\n    basicSalary: { type: Number, default: 0 },\n    hra: { type: Number, default: 0 },\n    medical: { type: Number, default: 0 },\n    transport: { type: Number, default: 0 },\n    bonus: { type: Number, default: 0 },\n    overtime: { type: Number, default: 0 },\n    otherAllowances: { type: Number, default: 0 }\n  },\n  deductions: {\n    pf: { type: Number, default: 0 },\n    esi: { type: Number, default: 0 },\n    tax: { type: Number, default: 0 },\n    professionalTax: { type: Number, default: 0 },\n    loanDeduction: { type: Number, default: 0 },\n    otherDeductions: { type: Number, default: 0 }\n  },\n  attendance: {\n    workingDays: { type: Number, default: 0 },\n    presentDays: { type: Number, default: 0 },\n    leaveDays: { type: Number, default: 0 },\n    absentDays: { type: Number, default: 0 }\n  },\n  grossEarnings: {\n    type: Number,\n    default: 0\n  },\n  totalDeductions: {\n    type: Number,\n    default: 0\n  },\n  netSalary: {\n    type: Number,\n    default: 0\n  },\n  bankInfo: {\n    accountNumber: String,\n    bankName: String,\n    ifscCode: String\n  },\n  status: {\n    type: String,\n    enum: ['draft', 'generated', 'paid', 'cancelled'],\n    default: 'generated'\n  },\n  paymentDate: {\n    type: Date,\n    default: null\n  },\n  paymentMethod: {\n    type: String,\n    enum: ['bank_transfer', 'cheque', 'cash'],\n    default: 'bank_transfer'\n  },\n  pdfPath: {\n    type: String,\n    default: null\n  },\n  generatedBy: {\n    type: mongoose.Schema.Types.ObjectId,\n    ref: 'User',\n    required: true\n  },\n  remarks: {\n    type: String,\n    default: ''\n  }\n}, {\n  timestamps: true\n});\n\npayslipSchema.index({ employee: 1, 'period.year': 1, 'period.month': 1 }, { unique: true });\npayslipSchema.index({ 'period.year': 1, 'period.month': 1 });\npayslipSchema.index({ status: 1 });\n\npayslipSchema.pre('save', function(next) {\n  const earnings = this.earnings;\n  this.grossEarnings = (earnings.basicSalary || 0) + \n                       (earnings.hra || 0) + \n                       (earnings.medical || 0) + \n                       (earnings.transport || 0) + \n                       (earnings.bonus || 0) + \n                       (earnings.overtime || 0) + \n                       (earnings.otherAllowances || 0);\n\n  const deductions = this.deductions;\n  this.totalDeductions = (deductions.pf || 0) + \n                         (deductions.esi || 0) + \n                         (deductions.tax || 0) + \n                         (deductions.professionalTax || 0) + \n                         (deductions.loanDeduction || 0) + \n                         (deductions.otherDeductions || 0);\n\n  this.netSalary = this.grossEarnings - this.totalDeductions;\n  \n  next();\n});\n\npayslipSchema.statics.getByEmployeeAndPeriod = function(employeeId, month, year) {\n  return this.findOne({\n    employee: employeeId,\n    'period.month': month,\n    'period.year': year\n  });\n};\n\npayslipSchema.statics.getPayslipsByPeriod = function(month, year) {\n  return this.find({\n    'period.month': month,\n    'period.year': year\n  }).populate('employee', 'personalInfo.firstName personalInfo.lastName employeeId workInfo.department')\n    .populate('generatedBy', 'name email');\n};\n\nexport default mongoose.model('Payslip', payslipSchema);\n","path":null,"size_bytes":3685,"size_tokens":null},"frontend/src/pages/Admin/PurchaseOrders.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport AdminLayout from '../../components/Admin/layout/AdminLayout';\nimport {\n  FileText, Plus, Search, Filter, Download, Edit3, Trash2, Eye,\n  CheckCircle, XCircle, ChevronDown, AlertCircle, RefreshCw\n} from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport { purchaseAPI } from '../../utils/api';\n\nconst PurchaseOrders = () => {\n  // State\n  const [purchaseOrders, setPurchaseOrders] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [filters, setFilters] = useState({\n    status: 'all',\n    supplier: '',\n    startDate: new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().slice(0, 10),\n    endDate: new Date().toISOString().slice(0, 10),\n    search: ''\n  });\n  const [showFilters, setShowFilters] = useState(false);\n  const [showCreateModal, setShowCreateModal] = useState(false);\n  const [showEditModal, setShowEditModal] = useState(false);\n  const [showViewModal, setShowViewModal] = useState(false);\n  const [selectedPO, setSelectedPO] = useState(null);\n  \n  // Form state for modals\n  const [formData, setFormData] = useState({\n    poNumber: '',\n    supplier: '',\n    status: 'Draft',\n    deliveryDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10),\n    paymentTerms: 'Net 30',\n    notes: '',\n    lineItems: [{ item: '', description: '', quantity: 1, unitPrice: 0 }]\n  });\n\n  const [suppliers, setSuppliers] = useState([]);\n  const [showSupplierModal, setShowSupplierModal] = useState(false);\n  const [supplierForm, setSupplierForm] = useState({\n    name: '',\n    email: '',\n    phone: '',\n    address: ''\n  });\n\n  // Fetch data\n  const fetchData = async () => {\n    try {\n      setLoading(true);\n      const [poRes, supplierRes] = await Promise.all([\n        purchaseAPI.getPurchaseOrders(filters),\n        purchaseAPI.getSuppliers()\n      ]);\n      \n      if (poRes.data.success) {\n        setPurchaseOrders(poRes.data.data.purchaseOrders || []);\n      }\n      if (supplierRes.data.success) {\n        setSuppliers(supplierRes.data.data.suppliers || []);\n      }\n    } catch (err) {\n      console.error('Failed to load purchase data:', err);\n      toast.error('Failed to load purchase orders');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchData();\n  }, [filters]);\n\n  // Helpers\n  const getStatusColor = (status) => {\n    switch (status) {\n      case 'Closed': return 'text-gray-400 bg-gray-400/20';\n      case 'Received': return 'text-green-400 bg-green-400/20';\n      case 'Ordered': return 'text-purple-400 bg-purple-400/20';\n      case 'Approved': return 'text-blue-400 bg-blue-400/20';\n      case 'PendingApproval': return 'text-yellow-400 bg-yellow-400/20';\n      case 'Draft': return 'text-secondary-400 bg-secondary-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  const handleFilterChange = (key, value) => {\n    setFilters(prev => ({ ...prev, [key]: value }));\n  };\n\n  const handleInputChange = (e) => {\n    const { name, value } = e.target;\n    setFormData(prev => ({ ...prev, [name]: value }));\n  };\n\n  const handleLineItemChange = (index, field, value) => {\n    const newLineItems = [...formData.lineItems];\n    newLineItems[index][field] = value;\n    newLineItems[index].total = (newLineItems[index].quantity || 0) * (newLineItems[index].unitPrice || 0);\n    setFormData(prev => ({ ...prev, lineItems: newLineItems }));\n  };\n\n  const addLineItem = () => {\n    setFormData(prev => ({\n      ...prev,\n      lineItems: [...prev.lineItems, { item: '', description: '', quantity: 1, unitPrice: 0, total: 0 }]\n    }));\n  };\n\n  const removeLineItem = (index) => {\n    if (formData.lineItems.length <= 1) return;\n    const newLineItems = formData.lineItems.filter((_, i) => i !== index);\n    setFormData(prev => ({ ...prev, lineItems: newLineItems }));\n  };\n\n  const calculateTotal = () => {\n    return formData.lineItems.reduce((sum, item) => sum + (item.total || 0), 0);\n  };\n\n  // CRUD Handlers\n  const handleCreatePO = async (e) => {\n    e.preventDefault();\n    try {\n      const poData = {\n        ...formData,\n        totalAmount: calculateTotal(),\n        grandTotal: calculateTotal() // add tax logic later if needed\n      };\n      const response = await purchaseAPI.createPurchaseOrder(poData);\n      if (response.data.success) {\n        toast.success('Purchase order created successfully!');\n        fetchData();\n        resetForm();\n        setShowCreateModal(false);\n      }\n    } catch (err) {\n      toast.error('Failed to create purchase order');\n    }\n  };\n\n  const handleUpdatePO = async (e) => {\n    e.preventDefault();\n    try {\n      const poData = {\n        ...formData,\n        totalAmount: calculateTotal(),\n        grandTotal: calculateTotal()\n      };\n      await purchaseAPI.updatePurchaseOrder(selectedPO._id, poData);\n      toast.success('Purchase order updated!');\n      fetchData();\n      setShowEditModal(false);\n    } catch (err) {\n      toast.error('Failed to update purchase order');\n    }\n  };\n\n  const handleDeletePO = async (id) => {\n    if (!window.confirm('Delete this purchase order permanently?')) return;\n    try {\n      await purchaseAPI.deletePurchaseOrder(id);\n      toast.success('Purchase order deleted');\n      fetchData();\n    } catch (err) {\n      toast.error('Failed to delete purchase order');\n    }\n  };\n\n  const handleCreateSupplier = async (e) => {\n    e.preventDefault();\n    try {\n      const response = await purchaseAPI.createSupplier(supplierForm);\n      if (response.data.success) {\n        toast.success('Supplier created successfully!');\n        fetchData();\n        setShowSupplierModal(false);\n        setSupplierForm({ name: '', email: '', phone: '', address: '' });\n      }\n    } catch (err) {\n      toast.error('Failed to create supplier');\n    }\n  };\n\n  const resetForm = () => {\n    setFormData({\n      poNumber: '',\n      supplier: '',\n      status: 'Draft',\n      deliveryDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10),\n      paymentTerms: 'Net 30',\n      notes: '',\n      lineItems: [{ item: '', description: '', quantity: 1, unitPrice: 0 }]\n    });\n  };\n\n  const openEditModal = (po) => {\n    setSelectedPO(po);\n    setFormData({\n      poNumber: po.poNumber || '',\n      supplier: po.supplier?._id || '',\n      status: po.status || 'Draft',\n      deliveryDate: po.deliveryDate ? new Date(po.deliveryDate).toISOString().slice(0, 10) : new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10),\n      paymentTerms: po.paymentTerms || 'Net 30',\n      notes: po.notes || '',\n      lineItems: po.lineItems?.map(item => ({\n        item: item.item || '',\n        description: item.description || '',\n        quantity: item.quantity || 1,\n        unitPrice: item.unitPrice || 0,\n        total: (item.quantity || 0) * (item.unitPrice || 0)\n      })) || [{ item: '', description: '', quantity: 1, unitPrice: 0 }]\n    });\n    setShowEditModal(true);\n  };\n\n  const openViewModal = (po) => {\n    setSelectedPO(po);\n    setShowViewModal(true);\n  };\n\n  const exportData = () => {\n    const csvContent = [\n      ['PO Number', 'Supplier', 'Status', 'Total Amount', 'Delivery Date', 'Created At'],\n      ...purchaseOrders.map(po => [\n        po.poNumber || '—',\n        po.supplier?.name || '—',\n        po.status,\n        `₹${(po.grandTotal || 0).toLocaleString()}`,\n        po.deliveryDate ? new Date(po.deliveryDate).toLocaleDateString() : '—',\n        new Date(po.createdAt).toLocaleDateString()\n      ])\n    ];\n    const csv = csvContent.map(row => row.map(field => `\"${field}\"`).join(',')).join('\\n');\n    const blob = new Blob([csv], { type: 'text/csv' });\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `purchase_orders_${filters.startDate}_to_${filters.endDate}.csv`;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    window.URL.revokeObjectURL(url);\n    toast.success('Purchase orders exported!');\n  };\n\n  // Format helpers\n  const formatCurrency = (value) => `₹${(value || 0).toLocaleString()}`;\n  const formatDate = (date) => date ? new Date(date).toLocaleDateString() : '—';\n\n  return (\n    <AdminLayout>\n      <div className=\"px-2 sm:px-4 md:px-6 lg:px-8 xl:px-12 space-y-6\">\n        {/* Header */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-3 sm:p-4 md:p-6\">\n          <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-3\">\n            <div>\n              <h1 className=\"text-xl sm:text-2xl md:text-3xl font-bold text-white mb-1\">\n                Purchase <span className=\"neon-text\">Orders</span>\n              </h1>\n              <p className=\"text-secondary-400 text-xs sm:text-sm\">Manage your procurement pipeline</p>\n            </div>\n            <div className=\"flex flex-wrap gap-2\">\n              <button\n                onClick={() => setShowFilters(!showFilters)}\n                className=\"px-3 py-1.5 sm:px-4 sm:py-2 bg-secondary-700 hover:bg-secondary-600 text-white rounded-lg flex items-center gap-1.5 text-xs sm:text-sm transition-colors\"\n              >\n                <Filter className=\"w-3.5 h-3.5 sm:w-4 sm:h-4\" />\n                <span>Filters</span>\n              </button>\n              <button\n                onClick={exportData}\n                disabled={purchaseOrders.length === 0}\n                className=\"px-3 py-1.5 sm:px-4 sm:py-2 bg-neon-purple/20 hover:bg-neon-purple/30 text-neon-purple rounded-lg flex items-center gap-1.5 text-xs sm:text-sm transition-colors disabled:opacity-50\"\n              >\n                <Download className=\"w-3.5 h-3.5 sm:w-4 sm:h-4\" />\n                <span>Export</span>\n              </button>\n              <button\n                onClick={fetchData}\n                className=\"px-3 py-1.5 sm:px-4 sm:py-2 bg-neon-pink/20 hover:bg-neon-pink/30 text-neon-pink rounded-lg flex items-center gap-1.5 text-xs sm:text-sm transition-colors\"\n              >\n                <RefreshCw className=\"w-3.5 h-3.5 sm:w-4 sm:h-4\" />\n                <span>Refresh</span>\n              </button>\n              <button\n                onClick={() => {\n                  setSupplierForm({ name: '', email: '', phone: '', address: '' });\n                  setShowSupplierModal(true);\n                }}\n                className=\"px-3 py-1.5 sm:px-4 sm:py-2 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg flex items-center gap-1.5 text-xs sm:text-sm transition-colors\"\n              >\n                <Plus className=\"w-3.5 h-3.5 sm:w-4 sm:h-4\" />\n                <span>Add Supplier</span>\n              </button>\n              <button\n                onClick={() => {\n                  resetForm();\n                  setShowCreateModal(true);\n                }}\n                className=\"px-3 py-1.5 sm:px-4 sm:py-2 bg-gradient-to-r from-neon-pink to-neon-purple text-white rounded-lg flex items-center gap-1.5 text-xs sm:text-sm transition-colors\"\n              >\n                <Plus className=\"w-3.5 h-3.5 sm:w-4 sm:h-4\" />\n                <span>New PO</span>\n              </button>\n            </div>\n          </div>\n        </div>\n\n        {/* Filters */}\n        {showFilters && (\n          <div className=\"glass-morphism neon-border rounded-2xl p-3 sm:p-4 md:p-6\">\n            <h3 className=\"text-base sm:text-lg font-bold text-white mb-3\">Filters</h3>\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 sm:gap-4\">\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1.5\">Start Date</label>\n                <input\n                  type=\"date\"\n                  value={filters.startDate}\n                  onChange={(e) => handleFilterChange('startDate', e.target.value)}\n                  className=\"w-full px-2.5 py-1.5 sm:px-3 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-xs sm:text-sm focus:border-neon-pink\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1.5\">End Date</label>\n                <input\n                  type=\"date\"\n                  value={filters.endDate}\n                  onChange={(e) => handleFilterChange('endDate', e.target.value)}\n                  className=\"w-full px-2.5 py-1.5 sm:px-3 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-xs sm:text-sm focus:border-neon-pink\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1.5\">Status</label>\n                <select\n                  value={filters.status}\n                  onChange={(e) => handleFilterChange('status', e.target.value)}\n                  className=\"w-full px-2.5 py-1.5 sm:px-3 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-xs sm:text-sm focus:border-neon-pink\"\n                >\n                  <option value=\"all\">All Status</option>\n                  <option value=\"Draft\">Draft</option>\n                  <option value=\"PendingApproval\">Pending Approval</option>\n                  <option value=\"Approved\">Approved</option>\n                  <option value=\"Ordered\">Ordered</option>\n                  <option value=\"Received\">Received</option>\n                  <option value=\"Closed\">Closed</option>\n                </select>\n              </div>\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1.5\">Supplier</label>\n                <select\n                  value={filters.supplier}\n                  onChange={(e) => handleFilterChange('supplier', e.target.value)}\n                  className=\"w-full px-2.5 py-1.5 sm:px-3 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-xs sm:text-sm focus:border-neon-pink\"\n                >\n                  <option value=\"\">All Suppliers</option>\n                  {suppliers.map(supplier => (\n                    <option key={supplier._id} value={supplier._id}>\n                      {supplier.name}\n                    </option>\n                  ))}\n                </select>\n              </div>\n              <div>\n                <label className=\"block text-xs sm:text-sm text-secondary-400 mb-1.5\">Search</label>\n                <div className=\"relative\">\n                  <Search className=\"absolute left-2.5 top-1/2 transform -translate-y-1/2 w-3.5 h-3.5 text-secondary-400\" />\n                  <input\n                    type=\"text\"\n                    placeholder=\"PO number, item...\"\n                    value={filters.search}\n                    onChange={(e) => handleFilterChange('search', e.target.value)}\n                    className=\"w-full pl-8 pr-3 py-1.5 sm:py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white placeholder-secondary-400 text-xs sm:text-sm focus:border-neon-pink\"\n                  />\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Purchase Orders Table */}\n        <div className=\"glass-morphism neon-border rounded-2xl overflow-hidden\">\n          <div className=\"p-3 sm:p-4 md:p-6\">\n            <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-2 mb-4\">\n              <h2 className=\"text-base sm:text-lg font-bold text-white\">All Purchase Orders</h2>\n              <p className=\"text-secondary-400 text-xs sm:text-sm\">\n                Showing {purchaseOrders.length} orders\n              </p>\n            </div>\n\n            {/* Desktop Table */}\n            <div className=\"hidden sm:block overflow-x-auto -mx-3 px-3\">\n              <table className=\"w-full min-w-[700px]\">\n                <thead className=\"border-b border-secondary-700\">\n                  <tr>\n                    <th className=\"text-left p-2 sm:p-3 text-secondary-300 font-medium text-xs sm:text-sm\">PO #</th>\n                    <th className=\"text-left p-2 sm:p-3 text-secondary-300 font-medium text-xs sm:text-sm\">Supplier</th>\n                    <th className=\"text-left p-2 sm:p-3 text-secondary-300 font-medium text-xs sm:text-sm\">Status</th>\n                    <th className=\"text-left p-2 sm:p-3 text-secondary-300 font-medium text-xs sm:text-sm\">Total</th>\n                    <th className=\"text-left p-2 sm:p-3 text-secondary-300 font-medium text-xs sm:text-sm\">Delivery Date</th>\n                    <th className=\"text-left p-2 sm:p-3 text-secondary-300 font-medium text-xs sm:text-sm\">Actions</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {loading ? (\n                    <tr><td colSpan=\"6\" className=\"py-6 text-center text-secondary-400\">Loading...</td></tr>\n                  ) : purchaseOrders.length === 0 ? (\n                    <tr><td colSpan=\"6\" className=\"py-8 text-center text-secondary-400\">No purchase orders found</td></tr>\n                  ) : (\n                    purchaseOrders.map(po => (\n                      <tr key={po._id} className=\"border-b border-secondary-800 hover:bg-secondary-800/30\">\n                        <td className=\"p-2 sm:p-3\">\n                          <div className=\"flex items-center gap-2\">\n                            <FileText className=\"w-4 h-4 text-secondary-400\" />\n                            <span className=\"text-white font-medium text-xs sm:text-sm\">{po.poNumber || '—'}</span>\n                          </div>\n                        </td>\n                        <td className=\"p-2 sm:p-3 text-white text-xs sm:text-sm\">\n                          {po.supplier?.name || '—'}\n                        </td>\n                        <td className=\"p-2 sm:p-3\">\n                          <span className={`px-1.5 py-0.5 text-[10px] rounded-full ${getStatusColor(po.status)}`}>\n                            {po.status}\n                          </span>\n                        </td>\n                        <td className=\"p-2 sm:p-3 text-neon-pink font-medium text-xs sm:text-sm\">\n                          {formatCurrency(po.grandTotal)}\n                        </td>\n                        <td className=\"p-2 sm:p-3 text-secondary-400 text-xs sm:text-sm\">\n                          {formatDate(po.deliveryDate)}\n                        </td>\n                        <td className=\"p-2 sm:p-3\">\n                          <div className=\"flex items-center gap-1\">\n                            <button\n                              onClick={() => openViewModal(po)}\n                              className=\"p-1 text-secondary-400 hover:text-blue-400\"\n                            >\n                              <Eye className=\"w-2.5 h-2.5\" />\n                            </button>\n                            <button\n                              onClick={() => openEditModal(po)}\n                              className=\"p-1 text-secondary-400 hover:text-purple-400\"\n                            >\n                              <Edit3 className=\"w-2.5 h-2.5\" />\n                            </button>\n                            <button\n                              onClick={() => handleDeletePO(po._id)}\n                              className=\"p-1 text-secondary-400 hover:text-red-400\"\n                            >\n                              <Trash2 className=\"w-2.5 h-2.5\" />\n                            </button>\n                          </div>\n                        </td>\n                      </tr>\n                    ))\n                  )}\n                </tbody>\n              </table>\n            </div>\n\n            {/* Mobile Cards */}\n            <div className=\"block sm:hidden space-y-4\">\n              {loading ? (\n                <div className=\"text-center py-8 text-secondary-400\">\n                  <div className=\"animate-spin rounded-full h-6 w-6 border-b-2 border-neon-pink mx-auto\"></div>\n                  <p className=\"mt-2\">Loading purchase orders...</p>\n                </div>\n              ) : purchaseOrders.length === 0 ? (\n                <div className=\"text-center py-8\">\n                  <FileText className=\"w-10 h-10 text-secondary-600 mx-auto mb-2\" />\n                  <p className=\"text-secondary-400\">No purchase orders found</p>\n                </div>\n              ) : (\n                purchaseOrders.map(po => (\n                  <div key={po._id} className=\"glass-morphism rounded-lg p-4 border border-secondary-700\">\n                    <div className=\"flex justify-between items-start mb-3\">\n                      <div>\n                        <p className=\"text-white font-medium text-base\">PO: {po.poNumber || '—'}</p>\n                        <p className=\"text-sm text-secondary-400\">{po.supplier?.name || '—'}</p>\n                      </div>\n                      <div className=\"flex gap-1\">\n                        <button\n                          onClick={() => openViewModal(po)}\n                          className=\"p-2 text-secondary-400 hover:text-blue-400\"\n                        >\n                          <Eye className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                          onClick={() => openEditModal(po)}\n                          className=\"p-2 text-secondary-400 hover:text-purple-400\"\n                        >\n                          <Edit3 className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                          onClick={() => handleDeletePO(po._id)}\n                          className=\"p-2 text-secondary-400 hover:text-red-400\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </button>\n                      </div>\n                    </div>\n                    <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                      <div>\n                        <p className=\"text-secondary-400\">Status</p>\n                        <span className={`px-2 py-1 rounded-full text-xs ${getStatusColor(po.status)}`}>\n                          {po.status}\n                        </span>\n                      </div>\n                      <div>\n                        <p className=\"text-secondary-400\">Total</p>\n                        <p className=\"text-neon-pink font-medium\">{formatCurrency(po.grandTotal)}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-secondary-400\">Delivery</p>\n                        <p className=\"text-white\">{formatDate(po.deliveryDate)}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-secondary-400\">Created</p>\n                        <p className=\"text-white\">{formatDate(po.createdAt)}</p>\n                      </div>\n                    </div>\n                  </div>\n                ))\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Create/Edit Modals */}\n      {(showCreateModal || showEditModal) && (\n        <div className=\"fixed inset-0 z-[9999] flex items-center justify-center p-4\">\n          {/* Enhanced backdrop with blur */}\n          <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" onClick={() => {\n            setShowCreateModal(false);\n            setShowEditModal(false);\n          }} />\n\n          {/* Modal content */}\n          <div className=\"relative glass-morphism neon-border rounded-2xl p-4 w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl\">\n            <h3 className=\"text-lg font-bold text-white mb-4\">\n              {showCreateModal ? 'Create Purchase Order' : 'Edit Purchase Order'}\n            </h3>\n            \n            <form onSubmit={showCreateModal ? handleCreatePO : handleUpdatePO} className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-xs text-secondary-400 mb-1\">Supplier *</label>\n                  <select\n                    name=\"supplier\"\n                    value={formData.supplier}\n                    onChange={handleInputChange}\n                    className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink\"\n                    required\n                  >\n                    <option value=\"\">Select Supplier</option>\n                    {suppliers.map(supplier => (\n                      <option key={supplier._id} value={supplier._id}>\n                        {supplier.name}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n                <div>\n                  <label className=\"block text-xs text-secondary-400 mb-1\">Delivery Date *</label>\n                  <input\n                    type=\"date\"\n                    name=\"deliveryDate\"\n                    value={formData.deliveryDate}\n                    onChange={handleInputChange}\n                    className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink\"\n                    required\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs text-secondary-400 mb-1\">Status</label>\n                  <select\n                    name=\"status\"\n                    value={formData.status}\n                    onChange={handleInputChange}\n                    className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink\"\n                  >\n                    <option value=\"Draft\">Draft</option>\n                    <option value=\"PendingApproval\">Pending Approval</option>\n                    <option value=\"Approved\">Approved</option>\n                    <option value=\"Ordered\">Ordered</option>\n                    <option value=\"Received\">Received</option>\n                    <option value=\"Closed\">Closed</option>\n                  </select>\n                </div>\n                <div>\n                  <label className=\"block text-xs text-secondary-400 mb-1\">Payment Terms</label>\n                  <input\n                    type=\"text\"\n                    name=\"paymentTerms\"\n                    value={formData.paymentTerms}\n                    onChange={handleInputChange}\n                    className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink\"\n                  />\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-xs text-secondary-400 mb-2\">Line Items</label>\n                <div className=\"space-y-3\">\n                  {formData.lineItems.map((item, index) => (\n                    <div key={index} className=\"grid grid-cols-12 gap-2 items-end\">\n                      <div className=\"col-span-3\">\n                        <input\n                          type=\"text\"\n                          placeholder=\"Item\"\n                          value={item.item}\n                          onChange={(e) => handleLineItemChange(index, 'item', e.target.value)}\n                          className=\"w-full px-2 py-1.5 bg-secondary-800 border border-secondary-600 rounded text-white text-sm\"\n                        />\n                      </div>\n                      <div className=\"col-span-3\">\n                        <input\n                          type=\"text\"\n                          placeholder=\"Description\"\n                          value={item.description}\n                          onChange={(e) => handleLineItemChange(index, 'description', e.target.value)}\n                          className=\"w-full px-2 py-1.5 bg-secondary-800 border border-secondary-600 rounded text-white text-sm\"\n                        />\n                      </div>\n                      <div className=\"col-span-2\">\n                        <input\n                          type=\"number\"\n                          placeholder=\"Qty\"\n                          value={item.quantity}\n                          onChange={(e) => handleLineItemChange(index, 'quantity', parseFloat(e.target.value) || 0)}\n                          className=\"w-full px-2 py-1.5 bg-secondary-800 border border-secondary-600 rounded text-white text-sm\"\n                          min=\"1\"\n                        />\n                      </div>\n                      <div className=\"col-span-2\">\n                        <input\n                          type=\"number\"\n                          placeholder=\"Rate\"\n                          value={item.unitPrice}\n                          onChange={(e) => handleLineItemChange(index, 'unitPrice', parseFloat(e.target.value) || 0)}\n                          className=\"w-full px-2 py-1.5 bg-secondary-800 border border-secondary-600 rounded text-white text-sm\"\n                          step=\"0.01\"\n                        />\n                      </div>\n                      <div className=\"col-span-1\">\n                        <span className=\"text-white text-sm\">₹{(item.total || 0).toFixed(2)}</span>\n                      </div>\n                      <div className=\"col-span-1\">\n                        {formData.lineItems.length > 1 && (\n                          <button\n                            type=\"button\"\n                            onClick={() => removeLineItem(index)}\n                            className=\"text-red-400 hover:text-red-300\"\n                          >\n                            <XCircle className=\"w-4 h-4\" />\n                          </button>\n                        )}\n                      </div>\n                    </div>\n                  ))}\n                  <button\n                    type=\"button\"\n                    onClick={addLineItem}\n                    className=\"text-neon-pink text-sm flex items-center gap-1\"\n                  >\n                    <Plus className=\"w-3 h-3\" /> Add Item\n                  </button>\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-xs text-secondary-400 mb-1\">Notes</label>\n                <textarea\n                  name=\"notes\"\n                  value={formData.notes}\n                  onChange={handleInputChange}\n                  rows=\"3\"\n                  className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink\"\n                />\n              </div>\n\n              <div className=\"flex justify-between items-center pt-2\">\n                <div className=\"text-white font-medium\">\n                  Total: {formatCurrency(calculateTotal())}\n                </div>\n                <div className=\"flex gap-2\">\n                  <button\n                    type=\"button\"\n                    onClick={() => {\n                      setShowCreateModal(false);\n                      setShowEditModal(false);\n                    }}\n                    className=\"px-3 py-2 bg-secondary-700 text-white rounded-lg text-sm\"\n                  >\n                    Cancel\n                  </button>\n                  <button\n                    type=\"submit\"\n                    className=\"px-3 py-2 bg-gradient-to-r from-neon-pink to-neon-purple text-white rounded-lg text-sm\"\n                  >\n                    {showCreateModal ? 'Create PO' : 'Update PO'}\n                  </button>\n                </div>\n              </div>\n            </form>\n          </div>\n        </div>\n      )}\n\n      {/* View Modal */}\n      {showViewModal && selectedPO && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-4 w-full max-w-md\">\n            <div className=\"flex justify-between items-center mb-4\">\n              <h3 className=\"text-lg font-bold text-white\">PO Details</h3>\n              <button\n                onClick={() => setShowViewModal(false)}\n                className=\"text-secondary-400 hover:text-white\"\n              >\n                <XCircle className=\"w-5 h-5\" />\n              </button>\n            </div>\n            \n            <div className=\"space-y-3 text-sm\">\n              <InfoRow label=\"PO Number\" value={selectedPO.poNumber || '—'} />\n              <InfoRow label=\"Supplier\" value={selectedPO.supplier?.name || '—'} />\n              <InfoRow label=\"Status\" value={\n                <span className={`px-2 py-1 rounded-full text-xs ${getStatusColor(selectedPO.status)}`}>\n                  {selectedPO.status}\n                </span>\n              } />\n              <InfoRow label=\"Total Amount\" value={formatCurrency(selectedPO.grandTotal)} />\n              <InfoRow label=\"Delivery Date\" value={formatDate(selectedPO.deliveryDate)} />\n              <InfoRow label=\"Payment Terms\" value={selectedPO.paymentTerms || '—'} />\n              <InfoRow label=\"Created At\" value={formatDate(selectedPO.createdAt)} />\n              {selectedPO.notes && <InfoRow label=\"Notes\" value={selectedPO.notes} />}\n              \n              <div className=\"mt-4\">\n                <p className=\"text-secondary-400 text-xs mb-2\">Line Items</p>\n                <div className=\"space-y-2\">\n                  {selectedPO.lineItems?.map((item, i) => (\n                    <div key={i} className=\"text-white text-sm border-b border-secondary-700 pb-2\">\n                      <div className=\"font-medium\">{item.item}</div>\n                      <div className=\"text-xs text-secondary-400\">{item.description}</div>\n                      <div className=\"text-xs\">\n                        {item.quantity} × ₹{(item.unitPrice || 0).toLocaleString()} = ₹{(item.total || 0).toLocaleString()}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Supplier Modal */}\n      {showSupplierModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-4 w-full max-w-md\">\n            <div className=\"flex justify-between items-center mb-4\">\n              <h3 className=\"text-lg font-bold text-white\">Add Supplier</h3>\n              <button\n                onClick={() => setShowSupplierModal(false)}\n                className=\"text-secondary-400 hover:text-white\"\n              >\n                <XCircle className=\"w-5 h-5\" />\n              </button>\n            </div>\n\n            <form onSubmit={handleCreateSupplier} className=\"space-y-4\">\n              <div>\n                <label className=\"block text-xs text-secondary-400 mb-1\">Name *</label>\n                <input\n                  type=\"text\"\n                  value={supplierForm.name}\n                  onChange={(e) => setSupplierForm(prev => ({ ...prev, name: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink\"\n                  required\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs text-secondary-400 mb-1\">Email</label>\n                <input\n                  type=\"email\"\n                  value={supplierForm.email}\n                  onChange={(e) => setSupplierForm(prev => ({ ...prev, email: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs text-secondary-400 mb-1\">Phone</label>\n                <input\n                  type=\"tel\"\n                  value={supplierForm.phone}\n                  onChange={(e) => setSupplierForm(prev => ({ ...prev, phone: e.target.value }))}\n                  className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs text-secondary-400 mb-1\">Address</label>\n                <textarea\n                  value={supplierForm.address}\n                  onChange={(e) => setSupplierForm(prev => ({ ...prev, address: e.target.value }))}\n                  rows=\"3\"\n                  className=\"w-full px-3 py-2 bg-secondary-800 border border-secondary-600 rounded-lg text-white text-sm focus:border-neon-pink\"\n                />\n              </div>\n\n              <div className=\"flex gap-2 pt-2\">\n                <button\n                  type=\"button\"\n                  onClick={() => setShowSupplierModal(false)}\n                  className=\"flex-1 px-3 py-2 bg-secondary-700 text-white rounded-lg text-sm\"\n                >\n                  Cancel\n                </button>\n                <button\n                  type=\"submit\"\n                  className=\"flex-1 px-3 py-2 bg-green-500 text-white rounded-lg text-sm\"\n                >\n                  Create Supplier\n                </button>\n              </div>\n            </form>\n          </div>\n        </div>\n      )}\n    </AdminLayout>\n  );\n};\n\n// Helper Component\nconst InfoRow = ({ label, value }) => (\n  <div className=\"flex justify-between border-b border-secondary-700 pb-2\">\n    <span className=\"text-secondary-400 text-sm\">{label}</span>\n    <span className=\"text-white text-sm\">{value}</span>\n  </div>\n);\n\nexport default PurchaseOrders;","path":null,"size_bytes":37660,"size_tokens":null},"frontend/src/pages/Admin/AdminTaskManagement.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport AdminLayout from '../../components/Admin/layout/AdminLayout';\nimport { \n  Plus, \n  Search, \n  Filter, \n  Eye, \n  Edit,\n  Trash2, \n  User,\n  Calendar,\n  Flag,\n  Target,\n  Clock,\n  CheckCircle,\n  AlertTriangle,\n  BarChart3,\n  X,\n  Save,\n  Loader2\n} from 'lucide-react';\nimport toast from 'react-hot-toast';\n\n// Import API services\nimport { useTasks } from '../../hooks/useTasks';\nimport { useAuth } from '../../hooks/useAuth';\nimport { employeeAPI } from '../../utils/api'; // Use the same API as employee management\n\nconst AdminTaskManagement = () => {\n\n\n  const { user } = useAuth();\n  const {\n    tasks,\n    loading,\n    error,\n    stats,\n    createTask,\n    updateTask,\n    deleteTask,\n    fetchTasks\n  } = useTasks();\n\n  const [filteredTasks, setFilteredTasks] = useState([]);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [statusFilter, setStatusFilter] = useState('');\n  const [priorityFilter, setPriorityFilter] = useState('');\n  const [projectFilter, setProjectFilter] = useState('');\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [showEditModal, setShowEditModal] = useState(false);\n  const [showViewModal, setShowViewModal] = useState(false);\n  const [selectedTask, setSelectedTask] = useState(null);\n  const [newTask, setNewTask] = useState({\n    title: '',\n    description: '',\n    assignedTo: '',\n    project: '',\n    priority: 'Medium',\n    dueDate: '',\n    category: 'Development',\n    estimatedHours: 0\n  });\n\n  // State for employees and projects\n  const [employees, setEmployees] = useState([]);\n  const [projects] = useState(['E-commerce Platform', 'Mobile App', 'Bug Fixes', 'Website Redesign', 'API Integration']);\n  const [employeesLoading, setEmployeesLoading] = useState(false);\n  const [modalLoading, setModalLoading] = useState(false);\n\n  // Fetch employees when component mounts using the same API as employee management\n  const fetchEmployees = async () => {\n    try {\n      setEmployeesLoading(true);\n      console.log('Fetching employees for task assignment...');\n      \n      const response = await employeeAPI.getEmployees();\n      console.log('Employee API Response for tasks:', response.data);\n      \n      if (response.data.success) {\n        const employeeData = response.data.data?.employees || [];\n        console.log('Setting employees for task assignment:', employeeData.length, 'employees');\n        setEmployees(employeeData);\n      } else {\n        console.error('API returned success: false');\n        toast.error('Failed to fetch employees');\n      }\n    } catch (error) {\n      console.error('Error fetching employees for task assignment:', error);\n      \n      // Better error handling\n      if (error.response?.status === 401) {\n        toast.error('Session expired. Please login again.');\n      } else if (error.response?.status === 403) {\n        toast.error('Access denied. You don\\'t have permission to view employees.');\n      } else if (error.response?.data?.message) {\n        toast.error(error.response.data.message);\n      } else {\n        toast.error('Failed to fetch employees. Please try again.');\n      }\n    } finally {\n      setEmployeesLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchEmployees();\n  }, []);\n\n  // Filter tasks\n  useEffect(() => {\n    let filtered = tasks.filter(task => {\n      const matchesSearch = task.title.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                           (task.assignedTo?.user?.name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||\n                           task.project.toLowerCase().includes(searchTerm.toLowerCase());\n      const matchesStatus = !statusFilter || task.status === statusFilter;\n      const matchesPriority = !priorityFilter || task.priority === priorityFilter;\n      const matchesProject = !projectFilter || task.project === projectFilter;\n      \n      return matchesSearch && matchesStatus && matchesPriority && matchesProject;\n    });\n\n    setFilteredTasks(filtered);\n  }, [tasks, searchTerm, statusFilter, priorityFilter, projectFilter]);\nconst handleAddTask = async (e) => {\n  // Prevent form submission if it's a form event\n  if (e && e.preventDefault) {\n    e.preventDefault();\n  }\n\n  try {\n    // Validation\n    if (!newTask.title?.trim()) {\n      toast.error(\"Task title is required\");\n      return;\n    }\n\n    if (!newTask.description?.trim()) {\n      toast.error(\"Task description is required\");\n      return;\n    }\n\n    if (!newTask.assignedTo) {\n      toast.error(\"Please assign the task to an employee\");\n      return;\n    }\n\n    if (!newTask.dueDate) {\n      toast.error(\"Due date is required\");\n      return;\n    }\n\n    // Find the selected employee to verify it exists\n    const selectedEmployee = employees.find(emp => emp._id === newTask.assignedTo);\n    if (!selectedEmployee) {\n      toast.error(\"Selected employee not found. Please refresh and try again.\");\n      return;\n    }\n\n    console.log('AdminTask: Creating task with data:', newTask);\n    console.log('AdminTask: Selected employee:', selectedEmployee);\n\n    // Prepare task payload\n    const taskPayload = {\n      title: newTask.title.trim(),\n      description: newTask.description.trim(),\n      assignedTo: newTask.assignedTo, // This should be the employee _id\n      project: newTask.project || '',\n      priority: newTask.priority || 'Medium',\n      dueDate: newTask.dueDate,\n      category: newTask.category || 'Development',\n      estimatedHours: parseInt(newTask.estimatedHours) || 0\n    };\n\n    console.log('AdminTask: Final payload:', taskPayload);\n\n    // Create the task\n    const response = await createTask(taskPayload);\n    console.log('AdminTask: Create response:', response);\n\n    // Reset form and close modal\n    setNewTask({\n      title: '',\n      description: '',\n      assignedTo: '',\n      project: '',\n      priority: 'Medium',\n      dueDate: '',\n      category: 'Development',\n      estimatedHours: 0\n    });\n    setShowAddModal(false);\n\n    // Refresh tasks to ensure we have the latest data\n    await fetchTasks();\n    \n  } catch (error) {\n    console.error('AdminTask: Create task error:', error);\n    \n    // Better error handling\n    if (error.response?.data?.errors) {\n      // Validation errors from backend\n      const validationErrors = error.response.data.errors;\n      validationErrors.forEach(err => {\n        toast.error(err.msg || err.message);\n      });\n    } else if (error.response?.data?.message) {\n      toast.error(error.response.data.message);\n    } else {\n      toast.error(error.message || 'Failed to create task');\n    }\n  }\n};\n\n\n  const handleEditTask = async (e) => {\n    e.preventDefault();\n    try {\n      await updateTask(selectedTask._id, {\n        title: selectedTask.title,\n        description: selectedTask.description,\n        assignedTo: selectedTask.assignedTo._id,\n        project: selectedTask.project,\n        priority: selectedTask.priority,\n        dueDate: selectedTask.dueDate,\n        category: selectedTask.category,\n        estimatedHours: parseInt(selectedTask.estimatedHours) || 0\n      });\n      \n      setShowEditModal(false);\n      setSelectedTask(null);\n    } catch (error) {\n    }\n  };\n\n  const handleDeleteTask = async (taskId) => {\n    if (window.confirm('Are you sure you want to delete this task?')) {\n      try {\n        await deleteTask(taskId);\n      } catch (error) {\n      }\n    }\n  };\n\n  const handleViewTask = async (task) => {\n    try {\n      setModalLoading(true);\n      setSelectedTask(task);\n      setShowViewModal(true);\n      \n      // Optionally fetch fresh task data\n      // const response = await taskService.getTaskById(task._id);\n      // setSelectedTask(response.task);\n    } catch (error) {\n      toast.error('Failed to load task details');\n    } finally {\n      setModalLoading(false);\n    }\n  };\n\n  const getStatusColor = (status) => {\n    switch (status?.toLowerCase()) {\n      case 'not started': return 'text-gray-400 bg-gray-400/20';\n      case 'in progress': return 'text-blue-400 bg-blue-400/20';\n      case 'completed': return 'text-green-400 bg-green-400/20';\n      case 'review': return 'text-purple-400 bg-purple-400/20';\n      case 'on hold': return 'text-yellow-400 bg-yellow-400/20';\n      case 'cancelled': return 'text-red-400 bg-red-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  const getPriorityColor = (priority) => {\n    switch (priority?.toLowerCase()) {\n      case 'low': return 'text-green-400 bg-green-400/20';\n      case 'medium': return 'text-yellow-400 bg-yellow-400/20';\n      case 'high': return 'text-orange-400 bg-orange-400/20';\n      case 'critical': return 'text-red-400 bg-red-400/20';\n      default: return 'text-secondary-400 bg-secondary-400/20';\n    }\n  };\n\n  const isOverdue = (dueDate, status) => {\n    return status !== 'Completed' && new Date(dueDate) < new Date();\n  };\n\n  const formatDate = (dateString) => {\n    return new Date(dateString).toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric'\n    });\n  };\n\n  // Loading state\n  if (loading) {\n    return (\n      <AdminLayout>\n        <div className=\"flex items-center justify-center min-h-[400px]\">\n          <div className=\"flex flex-col items-center space-y-4\">\n            <Loader2 className=\"w-8 h-8 animate-spin text-neon-pink\" />\n            <p className=\"text-secondary-400\">Loading tasks...</p>\n          </div>\n        </div>\n      </AdminLayout>\n    );\n  }\n\n  // Error state\n  if (error) {\n    return (\n      <AdminLayout>\n        <div className=\"flex items-center justify-center min-h-[400px]\">\n          <div className=\"text-center\">\n            <AlertTriangle className=\"w-12 h-12 text-red-400 mx-auto mb-4\" />\n            <h3 className=\"text-lg font-medium text-white mb-2\">Error Loading Tasks</h3>\n            <p className=\"text-secondary-400 mb-4\">{error}</p>\n            <button\n              onClick={() => fetchTasks()}\n              className=\"px-4 py-2 bg-neon-pink/20 text-neon-pink rounded-lg hover:bg-neon-pink/30 transition-colors\"\n            >\n              Try Again\n            </button>\n          </div>\n        </div>\n      </AdminLayout>\n    );\n  }\n\n  const TaskModal = ({ isEdit = false, isView = false }) => (\n    <div className=\"fixed inset-0 z-[9999] flex items-center justify-center p-0 sm:p-2 md:p-4\">\n      {/* Enhanced backdrop with blur */}\n      <div className=\"fixed inset-0 bg-black/70 backdrop-blur-md\" onClick={() => {\n        if (isView) setShowViewModal(false);\n        else if (isEdit) setShowEditModal(false);\n        else setShowAddModal(false);\n      }} />\n\n      {/* Modal content */}\n      <div className=\"relative glass-morphism neon-border rounded-2xl p-1 sm:p-3 md:p-4 lg:p-6 w-full sm:max-w-sm md:max-w-md lg:max-w-lg xl:max-w-2xl max-h-[85vh] overflow-auto shadow-2xl\">\n        <div className=\"flex items-center justify-between mb-4 sm:mb-6\">\n          <h2 className=\"text-lg sm:text-xl md:text-2xl font-bold text-white\">\n            {isView ? 'Task Details' : isEdit ? 'Edit Task' : 'Create New Task'}\n          </h2>\n          <button \n            onClick={() => {\n              if (isView) setShowViewModal(false);\n              else if (isEdit) setShowEditModal(false);\n              else setShowAddModal(false);\n            }}\n            className=\"text-secondary-400 hover:text-white\"\n          >\n            <X className=\"w-6 h-6\" />\n          </button>\n        </div>\n\n        {modalLoading ? (\n          <div className=\"flex items-center justify-center py-12\">\n            <Loader2 className=\"w-8 h-8 animate-spin text-neon-pink\" />\n          </div>\n        ) : isView ? (\n          // View Mode\n          <div className=\"space-y-6\">\n            <div className=\"flex items-center justify-between p-4 bg-secondary-800/30 rounded-lg\">\n              <div>\n                <h3 className=\"text-xl font-bold text-white\">{selectedTask.title}</h3>\n                <p className=\"text-neon-pink\">{selectedTask.project}</p>\n              </div>\n              <span className={`px-3 py-1 text-sm rounded-full ${getStatusColor(selectedTask.status)}`}>\n                {selectedTask.status}\n              </span>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              <div className=\"space-y-4\">\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Assigned To</label>\n                  <p className=\"text-white font-medium\">\n                    {selectedTask.assignedTo?.user?.name || selectedTask.assignedTo?.fullName || 'Unknown Employee'}\n                  </p>\n                  <p className=\"text-secondary-400 text-sm\">\n                    {selectedTask.assignedTo?.user?.employeeId || selectedTask.assignedTo?.employeeId || 'N/A'}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Priority</label>\n                  <span className={`inline-block px-2 py-1 text-xs rounded-full ${getPriorityColor(selectedTask.priority)}`}>\n                    {selectedTask.priority}\n                  </span>\n                </div>\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Category</label>\n                  <p className=\"text-white font-medium\">{selectedTask.category}</p>\n                </div>\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Created</label>\n                  <p className=\"text-white font-medium\">{formatDate(selectedTask.createdAt)}</p>\n                </div>\n              </div>\n              <div className=\"space-y-4\">\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Due Date</label>\n                  <p className={`font-medium ${isOverdue(selectedTask.dueDate, selectedTask.status) ? 'text-red-400' : 'text-white'}`}>\n                    {formatDate(selectedTask.dueDate)}\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Progress</label>\n                  <div className=\"flex items-center space-x-2\">\n                    <div className=\"flex-1 bg-secondary-700 rounded-full h-2\">\n                      <div \n                        className=\"bg-gradient-to-r from-neon-pink to-neon-purple h-2 rounded-full\"\n                        style={{ width: `${selectedTask.progress}%` }}\n                      ></div>\n                    </div>\n                    <span className=\"text-neon-pink text-sm\">{selectedTask.progress}%</span>\n                  </div>\n                </div>\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Hours</label>\n                  <p className=\"text-white font-medium\">\n                    {Math.round(selectedTask.actualHours || 0)} / {selectedTask.estimatedHours || 0} hrs\n                  </p>\n                </div>\n                <div>\n                  <label className=\"text-sm text-secondary-400\">Last Updated</label>\n                  <p className=\"text-white font-medium\">{formatDate(selectedTask.updatedAt)}</p>\n                </div>\n              </div>\n            </div>\n\n            <div>\n              <label className=\"text-sm text-secondary-400\">Description</label>\n              <p className=\"text-white bg-secondary-800/30 p-3 rounded-lg mt-1\">{selectedTask.description}</p>\n            </div>\n\n            {selectedTask.comments && selectedTask.comments.length > 0 && (\n              <div>\n                <label className=\"text-sm text-secondary-400\">Recent Comments ({selectedTask.comments.length})</label>\n                <div className=\"space-y-2 mt-2 max-h-40 overflow-y-auto\">\n                  {selectedTask.comments.slice(-3).map((comment) => (\n                    <div key={comment._id} className=\"bg-secondary-800/30 p-3 rounded-lg\">\n                      <div className=\"flex items-center space-x-2 mb-1\">\n                        <span className=\"text-white text-sm font-medium\">\n                          {comment.user?.name || 'Unknown'}\n                        </span>\n                        <span className=\"text-secondary-400 text-xs\">\n                          {formatDate(comment.createdAt)}\n                        </span>\n                      </div>\n                      <p className=\"text-secondary-300 text-sm\">{comment.text}</p>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n          </div>\n        ) : (\n          // Add/Edit Form\n          <form onSubmit={isEdit ? handleEditTask : handleAddTask} className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Title</label>\n                <input\n                  type=\"text\"\n                  value={isEdit ? selectedTask?.title || '' : newTask.title}\n                  onChange={(e) => {\n                    if (isEdit) {\n                      setSelectedTask({...selectedTask, title: e.target.value});\n                    } else {\n                      setNewTask({...newTask, title: e.target.value});\n                    }\n                  }}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  required\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Project</label>\n                <select\n                  value={isEdit ? selectedTask?.project || '' : newTask.project}\n                  onChange={(e) => {\n                    if (isEdit) {\n                      setSelectedTask({...selectedTask, project: e.target.value});\n                    } else {\n                      setNewTask({...newTask, project: e.target.value});\n                    }\n                  }}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  required\n                >\n                  <option value=\"\">Select Project</option>\n                  {projects.map(project => (\n                    <option key={project} value={project}>{project}</option>\n                  ))}\n                </select>\n              </div>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Description</label>\n              <textarea\n                value={isEdit ? selectedTask?.description || '' : newTask.description}\n                onChange={(e) => {\n                  if (isEdit) {\n                    setSelectedTask({...selectedTask, description: e.target.value});\n                  } else {\n                    setNewTask({...newTask, description: e.target.value});\n                  }\n                }}\n                rows=\"3\"\n                className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                required\n              ></textarea>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Assign To</label>\n                {employeesLoading ? (\n                  <div className=\"flex items-center space-x-2 px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg\">\n                    <Loader2 className=\"w-4 h-4 animate-spin text-neon-pink\" />\n                    <span className=\"text-secondary-400\">Loading employees...</span>\n                  </div>\n                ) : (\n                  <select\n                    value={isEdit ? selectedTask?.assignedTo?._id || '' : newTask.assignedTo}\n                    onChange={(e) => {\n                      if (isEdit) {\n                        const employee = employees.find(emp => emp._id === e.target.value);\n                        setSelectedTask({...selectedTask, assignedTo: employee});\n                      } else {\n                        setNewTask({...newTask, assignedTo: e.target.value});\n                      }\n                    }}\n                    className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                    required\n                  >\n                    <option value=\"\">Select Employee</option>\n                    {employees.map(emp => (\n                      <option key={emp._id} value={emp._id}>\n                        {emp.fullName || `${emp.personalInfo?.firstName} ${emp.personalInfo?.lastName}` || emp.user?.name || 'Unknown'} \n                        ({emp.employeeId || emp.user?.employeeId || 'N/A'})\n                      </option>\n                    ))}\n                  </select>\n                )}\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Priority</label>\n                <select\n                  value={isEdit ? selectedTask?.priority || '' : newTask.priority}\n                  onChange={(e) => {\n                    if (isEdit) {\n                      setSelectedTask({...selectedTask, priority: e.target.value});\n                    } else {\n                      setNewTask({...newTask, priority: e.target.value});\n                    }\n                  }}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                >\n                  <option value=\"Low\">Low</option>\n                  <option value=\"Medium\">Medium</option>\n                  <option value=\"High\">High</option>\n                  <option value=\"Critical\">Critical</option>\n                </select>\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Due Date</label>\n                <input\n                  type=\"date\"\n                  value={isEdit ? selectedTask?.dueDate?.split('T')[0] || '' : newTask.dueDate}\n                  onChange={(e) => {\n                    if (isEdit) {\n                      setSelectedTask({...selectedTask, dueDate: e.target.value});\n                    } else {\n                      setNewTask({...newTask, dueDate: e.target.value});\n                    }\n                  }}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  required\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Category</label>\n                <select\n                  value={isEdit ? selectedTask?.category || '' : newTask.category}\n                  onChange={(e) => {\n                    if (isEdit) {\n                      setSelectedTask({...selectedTask, category: e.target.value});\n                    } else {\n                      setNewTask({...newTask, category: e.target.value});\n                    }\n                  }}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                >\n                  <option value=\"Development\">Development</option>\n                  <option value=\"Design\">Design</option>\n                  <option value=\"Testing\">Testing</option>\n                  <option value=\"Documentation\">Documentation</option>\n                  <option value=\"Bug Fix\">Bug Fix</option>\n                  <option value=\"Feature\">Feature</option>\n                  <option value=\"Maintenance\">Maintenance</option>\n                  <option value=\"Other\">Other</option>\n                </select>\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">Estimated Hours</label>\n                <input\n                  type=\"number\"\n                  min=\"0\"\n                  step=\"0.5\"\n                  value={isEdit ? selectedTask?.estimatedHours || '' : newTask.estimatedHours}\n                  onChange={(e) => {\n                    if (isEdit) {\n                      setSelectedTask({...selectedTask, estimatedHours: parseFloat(e.target.value) || 0});\n                    } else {\n                      setNewTask({...newTask, estimatedHours: parseFloat(e.target.value) || 0});\n                    }\n                  }}\n                  className=\"w-full px-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n                  required\n                />\n              </div>\n            </div>\n\n            <div className=\"flex justify-end space-x-4\">\n              <button\n                type=\"button\"\n                onClick={() => {\n                  if (isEdit) setShowEditModal(false);\n                  else setShowAddModal(false);\n                }}\n                className=\"px-6 py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700/50 transition-colors\"\n              >\n                Cancel\n              </button>\n              <button\n                type=\"submit\"\n                disabled={employeesLoading}\n                className=\"px-6 py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed\"\n              >\n                <Save className=\"w-4 h-4 mr-2 inline\" />\n                {isEdit ? 'Update Task' : 'Create Task'}\n              </button>\n            </div>\n          </form>\n        )}\n      </div>\n    </div>\n  );\n\n  return (\n    <AdminLayout>\n      <div className=\"space-y-6\">\n        {/* Header */}\n        <div className=\"flex flex-col md:flex-row md:items-center justify-between gap-3 sm:gap-4\">\n          <div>\n            <h1 className=\"text-xl sm:text-2xl font-bold text-white\">Task Management</h1>\n            <p className=\"text-secondary-400 text-sm sm:text-base\">Assign and track tasks for your team</p>\n          </div>\n          <div className=\"flex flex-col sm:flex-row space-y-2 sm:space-y-0 space-x-0 sm:space-x-3\">\n            <button\n              onClick={() => {\n                fetchTasks();\n                fetchEmployees();\n              }}\n              className=\"px-4 sm:px-6 py-2 sm:py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700/50 transition-colors flex items-center\"\n            >\n              <BarChart3 className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1.5 sm:mr-2\" />\n              Refresh\n            </button>\n            <button\n              onClick={() => setShowAddModal(true)}\n              className=\"px-4 sm:px-6 py-2 sm:py-3 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 flex items-center\"\n            >\n              <Plus className=\"w-3 h-3 sm:w-4 sm:h-4 mr-1.5 sm:mr-2\" />\n              Add Task\n            </button>\n          </div>\n        </div>\n\n        {/* Stats Cards */}\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 sm:gap-6\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-xl sm:text-2xl font-bold text-white\">{stats?.total || 0}</h3>\n                <p className=\"text-secondary-400 text-sm sm:text-base\">Total Tasks</p>\n              </div>\n              <div className=\"w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg flex items-center justify-center\">\n                <Target className=\"w-5 h-5 sm:w-6 sm:h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-xl sm:text-2xl font-bold text-blue-400\">{stats?.inProgress || 0}</h3>\n                <p className=\"text-secondary-400 text-sm sm:text-base\">In Progress</p>\n              </div>\n              <div className=\"w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center\">\n                <Clock className=\"w-5 h-5 sm:w-6 sm:h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-xl sm:text-2xl font-bold text-green-400\">{stats?.completed || 0}</h3>\n                <p className=\"text-secondary-400 text-sm sm:text-base\">Completed</p>\n              </div>\n              <div className=\"w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-lg flex items-center justify-center\">\n                <CheckCircle className=\"w-5 h-5 sm:w-6 sm:h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <h3 className=\"text-xl sm:text-2xl font-bold text-red-400\">{stats?.overdue || 0}</h3>\n                <p className=\"text-secondary-400 text-sm sm:text-base\">Overdue</p>\n              </div>\n              <div className=\"w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-red-500 to-red-600 rounded-lg flex items-center justify-center\">\n                <AlertTriangle className=\"w-5 h-5 sm:w-6 sm:h-6 text-white\" />\n              </div>\n            </div>\n          </div>\n        </div>\n\n        {/* Filters */}\n        <div className=\"glass-morphism neon-border rounded-2xl p-4 sm:p-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\n            {/* Search */}\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n              <input\n                type=\"text\"\n                placeholder=\"Search tasks...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n              />\n            </div>\n\n            {/* Status Filter */}\n            <div className=\"relative\">\n              <Filter className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n              <select\n                value={statusFilter}\n                onChange={(e) => setStatusFilter(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n              >\n                <option value=\"\">All Status</option>\n                <option value=\"Not Started\">Not Started</option>\n                <option value=\"In Progress\">In Progress</option>\n                <option value=\"Review\">Review</option>\n                <option value=\"Completed\">Completed</option>\n                <option value=\"On Hold\">On Hold</option>\n                <option value=\"Cancelled\">Cancelled</option>\n              </select>\n            </div>\n\n            {/* Priority Filter */}\n            <div className=\"relative\">\n              <Flag className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n              <select\n                value={priorityFilter}\n                onChange={(e) => setPriorityFilter(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n              >\n                <option value=\"\">All Priority</option>\n                <option value=\"Low\">Low</option>\n                <option value=\"Medium\">Medium</option>\n                <option value=\"High\">High</option>\n                <option value=\"Critical\">Critical</option>\n              </select>\n            </div>\n\n            {/* Project Filter */}\n            <div className=\"relative\">\n              <BarChart3 className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n              <select\n                value={projectFilter}\n                onChange={(e) => setProjectFilter(e.target.value)}\n                className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20\"\n              >\n                <option value=\"\">All Projects</option>\n                {projects.map(project => (\n                  <option key={project} value={project}>{project}</option>\n                ))}\n              </select>\n            </div>\n\n            {/* Clear Filters */}\n            <button\n              onClick={() => {\n                setSearchTerm('');\n                setStatusFilter('');\n                setPriorityFilter('');\n                setProjectFilter('');\n              }}\n              className=\"px-4 py-3 border border-secondary-600 text-secondary-300 rounded-lg hover:bg-secondary-700/50 transition-colors md:col-span-2 lg:col-span-1\"\n            >\n              Clear Filters\n            </button>\n          </div>\n        </div>\n\n        {/* Tasks Table - Desktop */}\n        <div className=\"hidden md:block glass-morphism neon-border rounded-2xl overflow-hidden\">\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full\">\n              <thead className=\"border-b border-secondary-700\">\n                <tr>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Task</th>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Assigned To</th>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Project</th>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Priority</th>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Status</th>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Progress</th>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Due Date</th>\n                  <th className=\"text-left p-4 sm:p-6 text-secondary-300 font-medium\">Actions</th>\n                </tr>\n              </thead>\n              <tbody>\n                {filteredTasks.map((task) => (\n                  <tr key={task._id} className=\"border-b border-secondary-800 hover:bg-secondary-800/30 transition-colors\">\n                    <td className=\"p-4 sm:p-6\">\n                      <div>\n                        <p className=\"text-white font-medium\">{task.title}</p>\n                        <p className=\"text-secondary-400 text-sm\">{task.category}</p>\n                      </div>\n                    </td>\n                    <td className=\"p-4 sm:p-6\">\n                      <div className=\"flex items-center space-x-3\">\n                        <div className=\"w-8 h-8 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                          <User className=\"w-4 h-4 text-white\" />\n                        </div>\n                        <div>\n                          <p className=\"text-white font-medium\">\n                            {task.assignedTo?.user?.name || 'Unknown Employee'}\n                          </p>\n                          <p className=\"text-secondary-400 text-sm\">\n                            {task.assignedTo?.user?.employeeId || 'N/A'}\n                          </p>\n                        </div>\n                      </div>\n                    </td>\n                    <td className=\"p-4 sm:p-6\">\n                      <span className=\"px-3 py-1 text-xs rounded-full bg-secondary-700 text-secondary-300\">\n                        {task.project}\n                      </span>\n                    </td>\n                    <td className=\"p-4 sm:p-6\">\n                      <span className={`px-3 py-1 text-xs rounded-full ${getPriorityColor(task.priority)}`}>\n                        {task.priority}\n                      </span>\n                    </td>\n                    <td className=\"p-4 sm:p-6\">\n                      <span className={`px-3 py-1 text-xs rounded-full ${getStatusColor(task.status)}`}>\n                        {task.status}\n                      </span>\n                    </td>\n                    <td className=\"p-4 sm:p-6\">\n                      <div className=\"flex items-center space-x-2\">\n                        <div className=\"flex-1 bg-secondary-700 rounded-full h-2\">\n                          <div\n                            className=\"bg-gradient-to-r from-neon-pink to-neon-purple h-2 rounded-full\"\n                            style={{ width: `${task.progress}%` }}\n                          ></div>\n                        </div>\n                        <span className=\"text-neon-pink text-sm\">{task.progress}%</span>\n                      </div>\n                    </td>\n                    <td className=\"p-4 sm:p-6\">\n                      <div className={`${isOverdue(task.dueDate, task.status) ? 'text-red-400' : 'text-white'}`}>\n                        {formatDate(task.dueDate)}\n                        {isOverdue(task.dueDate, task.status) && (\n                          <div className=\"flex items-center text-red-400 text-sm mt-1\">\n                            <AlertTriangle className=\"w-3 h-3 mr-1\" />\n                            Overdue\n                          </div>\n                        )}\n                      </div>\n                    </td>\n                    <td className=\"p-4 sm:p-6\">\n                      <div className=\"flex items-center space-x-2\">\n                        <button\n                          onClick={() => handleViewTask(task)}\n                          className=\"p-2 text-secondary-400 hover:text-blue-400 hover:bg-blue-400/10 rounded-lg transition-colors\"\n                          title=\"View Details\"\n                        >\n                          <Eye className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                          onClick={() => {\n                            setSelectedTask(task);\n                            setShowEditModal(true);\n                          }}\n                          className=\"p-2 text-secondary-400 hover:text-neon-pink hover:bg-neon-pink/10 rounded-lg transition-colors\"\n                          title=\"Edit\"\n                        >\n                          <Edit className=\"w-4 h-4\" />\n                        </button>\n                        <button\n                          onClick={() => handleDeleteTask(task._id)}\n                          className=\"p-2 text-secondary-400 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-colors\"\n                          title=\"Delete\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </button>\n                      </div>\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n\n          {filteredTasks.length === 0 && (\n            <div className=\"p-6 sm:p-12 text-center\">\n              <Target className=\"w-12 h-12 text-secondary-600 mx-auto mb-4\" />\n              <h3 className=\"text-lg font-medium text-secondary-400 mb-2\">No tasks found</h3>\n              <p className=\"text-secondary-500\">\n                {searchTerm || statusFilter || priorityFilter || projectFilter\n                  ? 'Try adjusting your search filters'\n                  : 'Start by creating your first task'}\n              </p>\n            </div>\n          )}\n        </div>\n\n        {/* Tasks Cards - Mobile */}\n        <div className=\"md:hidden space-y-4\">\n          {filteredTasks.length === 0 ? (\n            <div className=\"glass-morphism neon-border rounded-2xl p-6 sm:p-12 text-center\">\n              <Target className=\"w-12 h-12 text-secondary-600 mx-auto mb-4\" />\n              <h3 className=\"text-lg font-medium text-secondary-400 mb-2\">No tasks found</h3>\n              <p className=\"text-secondary-500\">\n                {searchTerm || statusFilter || priorityFilter || projectFilter\n                  ? 'Try adjusting your search filters'\n                  : 'Start by creating your first task'}\n              </p>\n            </div>\n          ) : (\n            filteredTasks.map((task) => (\n              <div key={task._id} className=\"glass-morphism neon-border rounded-2xl p-4 space-y-4\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex-1\">\n                    <h3 className=\"text-white font-medium text-lg\">{task.title}</h3>\n                    <p className=\"text-secondary-400 text-sm\">{task.category}</p>\n                  </div>\n                  <span className={`px-3 py-1 text-xs rounded-full ${getStatusColor(task.status)}`}>\n                    {task.status}\n                  </span>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                  <div>\n                    <p className=\"text-secondary-400\">Assigned To</p>\n                    <p className=\"text-white font-medium\">\n                      {task.assignedTo?.user?.name || 'Unknown Employee'}\n                    </p>\n                  </div>\n                  <div>\n                    <p className=\"text-secondary-400\">Project</p>\n                    <p className=\"text-white font-medium\">{task.project}</p>\n                  </div>\n                  <div>\n                    <p className=\"text-secondary-400\">Priority</p>\n                    <span className={`px-2 py-1 text-xs rounded-full ${getPriorityColor(task.priority)}`}>\n                      {task.priority}\n                    </span>\n                  </div>\n                  <div>\n                    <p className=\"text-secondary-400\">Due Date</p>\n                    <p className={`font-medium ${isOverdue(task.dueDate, task.status) ? 'text-red-400' : 'text-white'}`}>\n                      {formatDate(task.dueDate)}\n                      {isOverdue(task.dueDate, task.status) && (\n                        <span className=\"text-red-400 text-xs block\">Overdue</span>\n                      )}\n                    </p>\n                  </div>\n                </div>\n\n                <div>\n                  <p className=\"text-secondary-400 text-sm mb-2\">Progress</p>\n                  <div className=\"flex items-center space-x-2\">\n                    <div className=\"flex-1 bg-secondary-700 rounded-full h-2\">\n                      <div\n                        className=\"bg-gradient-to-r from-neon-pink to-neon-purple h-2 rounded-full\"\n                        style={{ width: `${task.progress}%` }}\n                      ></div>\n                    </div>\n                    <span className=\"text-neon-pink text-sm\">{task.progress}%</span>\n                  </div>\n                </div>\n\n                <div className=\"flex items-center justify-end space-x-2 pt-2 border-t border-secondary-700\">\n                  <button\n                    onClick={() => handleViewTask(task)}\n                    className=\"p-2 text-secondary-400 hover:text-blue-400 hover:bg-blue-400/10 rounded-lg transition-colors\"\n                    title=\"View Details\"\n                  >\n                    <Eye className=\"w-4 h-4\" />\n                  </button>\n                  <button\n                    onClick={() => {\n                      setSelectedTask(task);\n                      setShowEditModal(true);\n                    }}\n                    className=\"p-2 text-secondary-400 hover:text-neon-pink hover:bg-neon-pink/10 rounded-lg transition-colors\"\n                    title=\"Edit\"\n                  >\n                    <Edit className=\"w-4 h-4\" />\n                  </button>\n                  <button\n                    onClick={() => handleDeleteTask(task._id)}\n                    className=\"p-2 text-secondary-400 hover:text-red-400 hover:bg-red-400/10 rounded-lg transition-colors\"\n                    title=\"Delete\"\n                  >\n                    <Trash2 className=\"w-4 h-4\" />\n                  </button>\n                </div>\n              </div>\n            ))\n          )}\n        </div>\n\n        {/* Quick Stats */}\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between mb-6\">\n              <h2 className=\"text-xl font-bold text-white\">Task Distribution by Project</h2>\n              <BarChart3 className=\"w-5 h-5 text-neon-pink\" />\n            </div>\n            <div className=\"space-y-4\">\n              {stats?.projectDistribution?.slice(0, 4).map((project) => {\n                const percentage = stats.total > 0 ? (project.count / stats.total) * 100 : 0;\n                return (\n                  <div key={project._id} className=\"space-y-2\">\n                    <div className=\"flex justify-between items-center\">\n                      <span className=\"text-white font-medium\">{project._id || 'No Project'}</span>\n                      <span className=\"text-neon-pink text-sm\">{project.count} tasks</span>\n                    </div>\n                    <div className=\"w-full bg-secondary-700 rounded-full h-2\">\n                      <div \n                        className=\"bg-gradient-to-r from-neon-pink to-neon-purple h-2 rounded-full\"\n                        style={{ width: `${percentage}%` }}\n                      ></div>\n                    </div>\n                  </div>\n                );\n              }) || (\n                <div className=\"text-center py-4\">\n                  <p className=\"text-secondary-400\">No project data available</p>\n                </div>\n              )}\n            </div>\n          </div>\n\n          <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n            <div className=\"flex items-center justify-between mb-6\">\n              <h2 className=\"text-xl font-bold text-white\">Recent Tasks</h2>\n              <Clock className=\"w-5 h-5 text-neon-purple\" />\n            </div>\n            <div className=\"space-y-4\">\n              {tasks.slice(0, 4).map((task) => (\n                <div key={task._id} className=\"flex items-center justify-between p-3 bg-secondary-800/30 rounded-lg\">\n                  <div>\n                    <p className=\"text-white font-medium\">{task.title}</p>\n                    <p className=\"text-sm text-secondary-400\">\n                      {task.assignedTo?.user?.name || 'Unknown Employee'}\n                    </p>\n                  </div>\n                  <div className=\"flex flex-col items-end space-y-1\">\n                    <span className={`px-2 py-1 text-xs rounded-full ${getStatusColor(task.status)}`}>\n                      {task.status}\n                    </span>\n                    <span className=\"text-xs text-secondary-400\">\n                      {formatDate(task.createdAt)}\n                    </span>\n                  </div>\n                </div>\n              ))}\n              {tasks.length === 0 && (\n                <div className=\"text-center py-4\">\n                  <p className=\"text-secondary-400\">No tasks created yet</p>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Modals */}\n      {showAddModal && <TaskModal />}\n      {showEditModal && <TaskModal isEdit />}\n      {showViewModal && <TaskModal isView />}\n    </AdminLayout>\n  );\n};\n\nexport default AdminTaskManagement;","path":null,"size_bytes":48667,"size_tokens":null},"backend/controllers/authController.js":{"content":"import { validationResult } from 'express-validator';\nimport crypto from 'crypto';\nimport User from '../models/User.js';\nimport Employee from '../models/Employee.js';\nimport { sendEmail } from '../utils/email.js';\n\n// Helper function to determine if input is employee ID\nconst isEmployeeId = (value) => {\n  return !value.includes('@') && /^[A-Z0-9_-]+$/i.test(value);\n};\n\n// @desc    Login user\n// @route   POST /api/auth/login\n// @access  Public\n// Add this updated login function to your existing authController.js\n\nconst login = async (req, res) => {\n  try {\n    // Check for validation errors\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation errors',\n        errors: errors.array()\n      });\n    }\n\n    const { email, password } = req.body;\n    const identifier = email.trim();\n    let user;\n    \n    // Check if identifier is an email or employee ID\n    const isEmail = identifier.includes('@');\n    \n    if (isEmail) {\n      // Email-based login\n      console.log('Email login attempt:', identifier);\n      user = await User.findOne({ \n        email: identifier.toLowerCase(),\n        isActive: true\n      }).select('+password');\n    } else {\n      // Employee ID-based login\n      console.log('Employee ID login attempt:', identifier);\n      user = await User.findOne({ \n        employeeId: identifier.toUpperCase(),\n        isActive: true\n      }).select('+password');\n    }\n\n    if (!user) {\n      return res.status(401).json({\n        success: false,\n        message: isEmail ? 'Invalid email or password' : 'Invalid Employee ID or password'\n      });\n    }\n\n    // Check user role and handle accordingly\n    if (user.role === 'admin') {\n      // Admin login - verify password normally\n      const isMatch = await user.matchPassword(password);\n      if (!isMatch) {\n        await user.handleFailedLogin();\n        return res.status(401).json({\n          success: false,\n          message: 'Invalid admin email or password'\n        });\n      }\n    } else if (user.role === 'employee') {\n      // Employee login with email - password should be employeeId\n      if (password.toUpperCase() !== user.employeeId) {\n        await user.handleFailedLogin();\n        return res.status(401).json({\n          success: false,\n          message: 'Invalid email or Employee ID. Use your Employee ID as password.'\n        });\n      }\n    } else {\n      return res.status(401).json({\n        success: false,\n        message: 'Invalid user role'\n      });\n    }\n\n    // Check if account is locked\n    if (user.isLocked) {\n      return res.status(401).json({\n        success: false,\n        message: 'Account temporarily locked due to too many failed login attempts'\n      });\n    }\n    \n    if (!user.isActive) {\n      return res.status(401).json({\n        success: false,\n        message: 'Account is deactivated. Please contact administrator.'\n      });\n    }\n\n    // Reset login attempts on successful login\n    if (user.loginAttempts > 0) {\n      user.loginAttempts = 0;\n      user.lockUntil = undefined;\n      await user.save();\n    }\n\n    // Generate JWT token\n    const token = user.getSignedJwtToken();\n\n    // Update last login\n    await user.updateLastLogin();\n\n    // Get employee details if user is an employee\n    let employeeDetails = null;\n    let departmentInfo = null;\n    \n    if (user.role === 'employee') {\n      employeeDetails = await Employee.findOne({ user: user._id })\n        .select('employeeId workInfo')\n        .populate('workInfo.department', 'name code');\n        \n      if (employeeDetails && employeeDetails.workInfo?.department) {\n        departmentInfo = {\n          id: employeeDetails.workInfo.department._id,\n          name: employeeDetails.workInfo.department.name,\n          code: employeeDetails.workInfo.department.code\n        };\n      }\n    }\n\n    console.log('Login successful for user:', user.email, 'Role:', user.role, 'Department:', departmentInfo?.name);\n\n    res.status(200).json({\n      success: true,\n      message: 'Login successful',\n      token,\n      user: {\n        id: user._id,\n        name: user.name,\n        email: user.email,\n        role: user.role,\n        employeeId: user.employeeId || employeeDetails?.employeeId,\n        isActive: user.isActive,\n        department: departmentInfo // Include department information\n      }\n    });\n\n  } catch (error) {\n    console.error('Login error:', error);\n    \n    return res.status(500).json({\n      success: false,\n      message: 'Authentication failed'\n    });\n  }\n};\n\n// @desc    Get current user profile with enhanced data (UPDATED FOR NOTIFICATIONS)\n// @route   GET /api/auth/me\n// @access  Private\nconst getMe = async (req, res) => {\n  try {\n    // Get user data\n    const user = await User.findById(req.user.id).select('-password');\n    \n    if (!user) {\n      return res.status(404).json({\n        success: false,\n        message: 'User not found'\n      });\n    }\n\n    let userData = {\n      id: user._id,\n      name: user.name,\n      email: user.email,\n      phone: user.phone,\n      role: user.role,\n      employeeId: user.employeeId,\n      isActive: user.isActive,\n      lastLogin: user.lastLogin\n    };\n\n    // If user is an employee, get additional employee data\n    if (user.role === 'employee') {\n      const employee = await Employee.findOne({ user: user._id })\n        .populate('workInfo.reportingManager', 'personalInfo.firstName personalInfo.lastName');\n      \n      if (employee) {\n        userData = {\n          ...userData,\n          // Personal Information\n          personalInfo: employee.personalInfo,\n          \n          // Contact Information\n          contactInfo: employee.contactInfo,\n          \n          // Work Information\n          workInfo: employee.workInfo,\n          \n          // Additional employee fields\n          employeeId: employee.employeeId || user.employeeId,\n          fullName: employee.fullName,\n          status: employee.status,\n          hasFaceRegistered: employee.hasFaceRegistered,\n          joiningDate: employee.workInfo?.joiningDate,\n          \n          // Profile completion percentage\n          profileCompletion: calculateProfileCompletion(employee),\n          \n          // Quick stats (for dashboard and notifications)\n          quickStats: await getEmployeeQuickStats(employee._id)\n        };\n      }\n    } else if (user.role === 'admin') {\n      // For admin users, add admin-specific data\n      userData.adminStats = await getAdminQuickStats();\n    }\n\n    res.json({\n      success: true,\n      data: userData\n    });\n\n  } catch (error) {\n    console.error('Get current user error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching user profile'\n    });\n  }\n};\n\n// @desc    Get current user's employee profile (for employees) - KEEP YOUR EXISTING FUNCTION\n// @route   GET /api/auth/profile  \n// @access  Private (Employee)\nconst getMyProfile = async (req, res) => {\n  try {\n    // Find the employee record for the current user\n    const employee = await Employee.findOne({ user: req.user.id })\n      .populate('user', 'name email role employeeId isActive')\n      .populate('workInfo.reportingManager', 'personalInfo.firstName personalInfo.lastName');\n\n    if (!employee) {\n      return res.status(404).json({\n        success: false,\n        message: 'Employee record not found'\n      });\n    }\n\n    // Calculate years of service\n    let yearsOfService = 0;\n    if (employee.workInfo?.joiningDate) {\n      const joiningDate = new Date(employee.workInfo.joiningDate);\n      const currentDate = new Date();\n      yearsOfService = Math.floor((currentDate - joiningDate) / (365.25 * 24 * 60 * 60 * 1000));\n    }\n\n    // Ensure leave balance exists\n    if (!employee.leaveBalance) {\n      employee.leaveBalance = {\n        total: 30,\n        used: 0,\n        remaining: 30\n      };\n      await employee.save();\n    }\n\n    // Calculate gross salary (basic + allowances, simple calculation)\n    let grossSalary = employee.salaryInfo?.basicSalary || 60000;\n    if (employee.salaryInfo?.allowances) {\n      Object.values(employee.salaryInfo.allowances).forEach(allowance => {\n        if (typeof allowance === 'number') {\n          grossSalary += allowance;\n        }\n      });\n    }\n\n    // Prepare response data in the format expected by the dashboard\n    const responseData = {\n      _id: employee._id,\n      employeeId: employee.employeeId,\n      fullName: employee.fullName,\n      personalInfo: employee.personalInfo,\n      contactInfo: employee.contactInfo,\n      workInfo: employee.workInfo,\n      salaryInfo: employee.salaryInfo,\n      leaveBalance: employee.leaveBalance,\n      user: employee.user,\n      yearsOfService: yearsOfService,\n      grossSalary: grossSalary,\n      status: employee.status,\n      hasFaceRegistered: employee.hasFaceRegistered,\n      createdAt: employee.createdAt,\n      updatedAt: employee.updatedAt\n    };\n\n    res.status(200).json({\n      success: true,\n      data: responseData,\n      message: 'Employee profile retrieved successfully'\n    });\n\n  } catch (error) {\n    console.error('Get my profile error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching employee profile'\n    });\n  }\n};\n\n// Helper function to calculate profile completion percentage\nconst calculateProfileCompletion = (employee) => {\n  const requiredFields = [\n    employee.personalInfo?.firstName,\n    employee.personalInfo?.lastName,\n    employee.personalInfo?.dateOfBirth,\n    employee.personalInfo?.gender,\n    employee.contactInfo?.phone,\n    employee.contactInfo?.personalEmail,\n    employee.contactInfo?.address?.street,\n    employee.contactInfo?.address?.city,\n    employee.contactInfo?.address?.state,\n    employee.contactInfo?.address?.pincode,\n    employee.contactInfo?.emergencyContact?.name,\n    employee.contactInfo?.emergencyContact?.phone,\n    employee.workInfo?.position,\n    employee.workInfo?.department,\n    employee.bankInfo?.accountNumber,\n    employee.bankInfo?.bankName,\n    employee.bankInfo?.ifscCode\n  ];\n  \n  const completedFields = requiredFields.filter(field => \n    field && field.toString().trim() !== ''\n  ).length;\n  \n  return Math.round((completedFields / requiredFields.length) * 100);\n};\n\n// Helper function to get employee quick stats\nconst getEmployeeQuickStats = async (employeeId) => {\n  try {\n    // Import Task and Leave models (adjust paths as needed)\n    let Task, Leave;\n    try {\n      Task = (await import('../models/Task.js')).default;\n      Leave = (await import('../models/Leave.js')).default;\n    } catch (importError) {\n      console.log('Task/Leave models not available:', importError.message);\n      return {\n        tasks: { total: 0, completed: 0, pending: 0, overdue: 0 },\n        leaves: {\n          casual: { used: 0, remaining: 12 },\n          sick: { used: 0, remaining: 7 },\n          earned: { used: 0, remaining: 15 }\n        }\n      };\n    }\n    \n    const [taskStats, leaveStats] = await Promise.all([\n      // Task statistics\n      Task.aggregate([\n        { $match: { assignedTo: employeeId } },\n        {\n          $group: {\n            _id: '$status',\n            count: { $sum: 1 }\n          }\n        }\n      ]),\n      \n      // Leave statistics for current year\n      Leave.aggregate([\n        {\n          $match: {\n            employee: employeeId,\n            status: 'Approved',\n            startDate: {\n              $gte: new Date(new Date().getFullYear(), 0, 1),\n              $lte: new Date(new Date().getFullYear(), 11, 31)\n            }\n          }\n        },\n        {\n          $group: {\n            _id: '$leaveType',\n            totalDays: { $sum: '$totalDays' }\n          }\n        }\n      ])\n    ]);\n\n    // Process task stats\n    const tasks = {\n      total: 0,\n      completed: 0,\n      pending: 0,\n      overdue: 0\n    };\n\n    taskStats.forEach(stat => {\n      tasks.total += stat.count;\n      if (stat._id === 'Completed') tasks.completed = stat.count;\n      if (['Not Started', 'In Progress'].includes(stat._id)) tasks.pending += stat.count;\n    });\n\n    // Get overdue tasks count\n    const overdueTasks = await Task.countDocuments({\n      assignedTo: employeeId,\n      status: { $nin: ['Completed', 'Cancelled'] },\n      dueDate: { $lt: new Date() }\n    });\n    tasks.overdue = overdueTasks;\n\n    // Process leave stats\n    const leaves = {\n      casual: { used: 0, remaining: 12 },\n      sick: { used: 0, remaining: 7 },\n      earned: { used: 0, remaining: 15 }\n    };\n\n    leaveStats.forEach(stat => {\n      const leaveType = stat._id.toLowerCase();\n      if (leaves[leaveType]) {\n        leaves[leaveType].used = stat.totalDays;\n        leaves[leaveType].remaining = Math.max(0, leaves[leaveType].remaining - stat.totalDays);\n      }\n    });\n\n    return {\n      tasks,\n      leaves\n    };\n\n  } catch (error) {\n    console.error('Error getting employee quick stats:', error);\n    return {\n      tasks: { total: 0, completed: 0, pending: 0, overdue: 0 },\n      leaves: {\n        casual: { used: 0, remaining: 12 },\n        sick: { used: 0, remaining: 7 },\n        earned: { used: 0, remaining: 15 }\n      }\n    };\n  }\n};\n\n// Helper function to get admin quick stats\nconst getAdminQuickStats = async () => {\n  try {\n    let Leave;\n    try {\n      Leave = (await import('../models/Leave.js')).default;\n    } catch (importError) {\n      console.log('Leave model not available:', importError.message);\n      Leave = null;\n    }\n\n    const [employeeCount, pendingLeaves, recentEmployees] = await Promise.all([\n      Employee.countDocuments({ status: { $ne: 'Terminated' } }),\n      Leave ? Leave.countDocuments({ status: 'Pending' }) : 0,\n      Employee.countDocuments({\n        createdAt: { $gte: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000) }\n      })\n    ]);\n\n    return {\n      totalEmployees: employeeCount,\n      pendingLeaves,\n      recentEmployees\n    };\n  } catch (error) {\n    console.error('Error getting admin quick stats:', error);\n    return {\n      totalEmployees: 0,\n      pendingLeaves: 0,\n      recentEmployees: 0\n    };\n  }\n};\n\n// Keep all your existing functions unchanged\nconst register = async (req, res) => {\n  try {\n    // Check for validation errors\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation errors',\n        errors: errors.array()\n      });\n    }\n\n    const { name, email, password, role = 'employee', employeeId } = req.body;\n\n    // Check if user already exists\n    const existingUser = await User.findOne({ \n      $or: [\n        { email: email.toLowerCase() },\n        ...(employeeId ? [{ employeeId: employeeId.toUpperCase() }] : [])\n      ]\n    });\n    \n    if (existingUser) {\n      return res.status(400).json({\n        success: false,\n        message: existingUser.email === email.toLowerCase() \n          ? 'User already exists with this email'\n          : 'Employee ID already exists'\n      });\n    }\n\n    // For employees, generate employeeId if not provided\n    let finalEmployeeId = employeeId;\n    if (role === 'employee' && !finalEmployeeId) {\n      // Generate a simple employee ID (you can customize this logic)\n      const empCount = await User.countDocuments({ role: 'employee' });\n      finalEmployeeId = `EMP${(empCount + 1).toString().padStart(4, '0')}`;\n    }\n\n    // Create user\n    const userData = {\n      name,\n      email: email.toLowerCase(),\n      password,\n      role\n    };\n\n    if (role === 'employee' && finalEmployeeId) {\n      userData.employeeId = finalEmployeeId.toUpperCase();\n    }\n\n    const user = await User.create(userData);\n\n    // Generate JWT token\n    const token = user.getSignedJwtToken();\n\n    res.status(201).json({\n      success: true,\n      message: 'User registered successfully',\n      token,\n      user: {\n        id: user._id,\n        name: user.name,\n        email: user.email,\n        role: user.role,\n        employeeId: user.employeeId\n      }\n    });\n\n  } catch (error) {\n    console.error('Registration error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\nconst forgotPassword = async (req, res) => {\n  try {\n    // Check for validation errors\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation errors',\n        errors: errors.array()\n      });\n    }\n\n    const { email } = req.body;\n    let user;\n    \n    // Check if identifier is email or employee ID\n    if (isEmployeeId(email)) {\n      // Employee ID provided\n      user = await User.findOne({ \n        employeeId: email.toUpperCase(), \n        role: 'employee',\n        isActive: true \n      });\n    } else if (email.includes('@')) {\n      // Email provided\n      user = await User.findOne({ \n        email: email.toLowerCase(), \n        isActive: true \n      });\n    } else {\n      return res.status(400).json({\n        success: false,\n        message: 'Please provide a valid email address or Employee ID'\n      });\n    }\n\n    if (!user) {\n      return res.status(404).json({\n        success: false,\n        message: 'No user found with this email address or Employee ID'\n      });\n    }\n\n    // For employees, remind them to use Employee ID as password\n    if (user.role === 'employee') {\n      const message = `\n        <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n          <h2 style=\"color: #333; text-align: center;\">Login Reminder</h2>\n          <div style=\"background-color: #f9f9f9; padding: 20px; border-radius: 8px; margin: 20px 0;\">\n            <p>Hello <strong>${user.name}</strong>,</p>\n            <p>You requested help with your login credentials.</p>\n            \n            <div style=\"background-color: #fff; padding: 15px; border-radius: 5px; border-left: 4px solid #ff0080;\">\n              <h3 style=\"margin-top: 0; color: #333;\">Your Login Options:</h3>\n              <div style=\"margin: 10px 0;\">\n                <strong>Option 1 - Login with Email:</strong>\n                <p style=\"margin: 5px 0;\"><strong>Email:</strong> ${user.email}</p>\n                <p style=\"margin: 5px 0;\"><strong>Password:</strong> ${user.employeeId}</p>\n              </div>\n              <div style=\"margin: 10px 0;\">\n                <strong>Option 2 - Login with Employee ID:</strong>\n                <p style=\"margin: 5px 0;\"><strong>Employee ID:</strong> ${user.employeeId}</p>\n                <p style=\"margin: 5px 0;\"><strong>Password:</strong> ${user.employeeId}</p>\n              </div>\n            </div>\n            \n            <div style=\"text-align: center; margin: 20px 0;\">\n              <a href=\"${process.env.FRONTEND_URL}/login\" \n                 style=\"display: inline-block; padding: 12px 25px; background: linear-gradient(45deg, #ff0080, #8b5cf6); color: white; text-decoration: none; border-radius: 5px; font-weight: bold;\">\n                Login to Your Account\n              </a>\n            </div>\n            \n            <div style=\"background-color: #d1ecf1; padding: 10px; border-radius: 5px; border: 1px solid #bee5eb;\">\n              <p style=\"margin: 0; color: #0c5460;\"><strong>Note:</strong> Employees use their Employee ID as password for both login methods.</p>\n            </div>\n          </div>\n          \n          <p style=\"color: #666; font-size: 14px;\">Best regards,<br>HR Team<br>CompanyName</p>\n        </div>\n      `;\n\n      try {\n        await sendEmail({\n          to: user.email,\n          subject: 'Login Credentials Reminder - Employee Management System',\n          html: message\n        });\n\n        return res.status(200).json({\n          success: true,\n          message: 'Login reminder sent to your email'\n        });\n      } catch (emailError) {\n        console.error('Email sending error:', emailError);\n        return res.status(500).json({\n          success: false,\n          message: 'Email could not be sent. Please contact HR directly.'\n        });\n      }\n    }\n\n    // For admin users, generate reset token\n    const resetToken = user.getResetPasswordToken();\n    await user.save();\n\n    // Create reset URL\n    const resetUrl = `${process.env.FRONTEND_URL}/reset-password/${resetToken}`;\n\n    // Email message for admin\n    const message = `\n      <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n        <h2 style=\"color: #333; text-align: center;\">Password Reset Request</h2>\n        <div style=\"background-color: #f9f9f9; padding: 20px; border-radius: 8px; margin: 20px 0;\">\n          <p>Hello <strong>${user.name}</strong>,</p>\n          <p>You have requested to reset your password. Click the link below to reset your password:</p>\n          \n          <div style=\"text-align: center; margin: 20px 0;\">\n            <a href=\"${resetUrl}\" style=\"display: inline-block; padding: 12px 25px; background: linear-gradient(45deg, #ff0080, #8b5cf6); color: white; text-decoration: none; border-radius: 5px; font-weight: bold;\">Reset Password</a>\n          </div>\n          \n          <div style=\"background-color: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #ffeaa7;\">\n            <p style=\"margin: 0; color: #856404;\"><strong>Important:</strong> This link will expire in 10 minutes. If you did not request this, please ignore this email.</p>\n          </div>\n        </div>\n        <p style=\"color: #666; font-size: 14px;\">Best regards,<br>Employee Management System</p>\n      </div>\n    `;\n\n    try {\n      await sendEmail({\n        to: user.email,\n        subject: 'Password Reset Request - Employee Management System',\n        html: message\n      });\n\n      res.status(200).json({\n        success: true,\n        message: 'Password reset email sent successfully'\n      });\n    } catch (emailError) {\n      console.error('Email sending error:', emailError);\n      \n      // Reset the token fields\n      user.resetPasswordToken = undefined;\n      user.resetPasswordExpire = undefined;\n      await user.save();\n\n      res.status(500).json({\n        success: false,\n        message: 'Email could not be sent. Please try again later.'\n      });\n    }\n\n  } catch (error) {\n    console.error('Forgot password error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error. Please try again later.'\n    });\n  }\n};\n\nconst resetPassword = async (req, res) => {\n  try {\n    // Check for validation errors\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation errors',\n        errors: errors.array()\n      });\n    }\n\n    // Get hashed token\n    const resetPasswordToken = crypto\n      .createHash('sha256')\n      .update(req.params.resetToken)\n      .digest('hex');\n\n    const user = await User.findOne({\n      resetPasswordToken,\n      resetPasswordExpire: { $gt: Date.now() },\n      isActive: true,\n      role: 'admin' // Only allow admin password reset\n    });\n\n    if (!user) {\n      return res.status(400).json({\n        success: false,\n        message: 'Invalid or expired reset token'\n      });\n    }\n\n    // Set new password\n    user.password = req.body.password;\n    user.resetPasswordToken = undefined;\n    user.resetPasswordExpire = undefined;\n    user.loginAttempts = 0;\n    user.lockUntil = undefined;\n\n    await user.save();\n\n    // Generate JWT token\n    const token = user.getSignedJwtToken();\n\n    res.status(200).json({\n      success: true,\n      message: 'Password reset successful',\n      token,\n      user: {\n        id: user._id,\n        name: user.name,\n        email: user.email,\n        role: user.role,\n        employeeId: user.employeeId\n      }\n    });\n\n  } catch (error) {\n    console.error('Reset password error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error. Please try again later.'\n    });\n  }\n};\n\n// Keep all your other existing functions (getProfile, updateProfile, changePassword, logout, deleteAccount, getAllUsers, updateUserStatus, initializeAdmin)\nconst getProfile = async (req, res) => {\n  try {\n    const user = await User.findById(req.user.id);\n    \n    if (!user) {\n      return res.status(404).json({\n        success: false,\n        message: 'User not found'\n      });\n    }\n\n    // Get employee details if user is an employee\n    let employeeDetails = null;\n    if (user.role === 'employee') {\n      employeeDetails = await Employee.findOne({ user: user._id });\n    }\n\n    res.status(200).json({\n      success: true,\n      data: {\n        user,\n        employee: employeeDetails\n      }\n    });\n\n  } catch (error) {\n    console.error('Get profile error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error'\n    });\n  }\n};\n\nconst updateProfile = async (req, res) => {\n  try {\n    const { name, phone, profileImage } = req.body;\n\n    const user = await User.findByIdAndUpdate(\n      req.user.id,\n      {\n        ...(name && { name }),\n        ...(phone !== undefined && { phone }),\n        ...(profileImage && { profileImage })\n      },\n      {\n        new: true,\n        runValidators: true\n      }\n    );\n\n    if (!user) {\n      return res.status(404).json({\n        success: false,\n        message: 'User not found'\n      });\n    }\n\n    res.status(200).json({\n      success: true,\n      message: 'Profile updated successfully',\n      data: user\n    });\n\n  } catch (error) {\n    console.error('Update profile error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\nconst changePassword = async (req, res) => {\n  try {\n    // Only allow admins to change password\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Only administrators can change passwords. Employees use Employee ID as password.'\n      });\n    }\n\n    // Check for validation errors\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation errors',\n        errors: errors.array()\n      });\n    }\n\n    const { currentPassword, newPassword } = req.body;\n\n    // Get user with password\n    const user = await User.findById(req.user.id).select('+password');\n\n    if (!user) {\n      return res.status(404).json({\n        success: false,\n        message: 'User not found'\n      });\n    }\n\n    // Check current password\n    const isMatch = await user.matchPassword(currentPassword);\n    if (!isMatch) {\n      return res.status(400).json({\n        success: false,\n        message: 'Current password is incorrect'\n      });\n    }\n\n    // Update password\n    user.password = newPassword;\n    await user.save();\n\n    res.status(200).json({\n      success: true,\n      message: 'Password changed successfully'\n    });\n\n  } catch (error) {\n    console.error('Change password error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\nconst logout = async (req, res) => {\n  try {\n    res.status(200).json({\n      success: true,\n      message: 'Logged out successfully'\n    });\n\n  } catch (error) {\n    console.error('Logout error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error'\n    });\n  }\n};\n\nconst deleteAccount = async (req, res) => {\n  try {\n    const user = await User.findById(req.user.id);\n\n    if (!user) {\n      return res.status(404).json({\n        success: false,\n        message: 'User not found'\n      });\n    }\n\n    // If employee, also delete employee record\n    if (user.role === 'employee') {\n      await Employee.findOneAndDelete({ user: user._id });\n    }\n\n    // Delete user\n    await User.findByIdAndDelete(req.user.id);\n\n    res.status(200).json({\n      success: true,\n      message: 'Account deleted successfully'\n    });\n\n  } catch (error) {\n    console.error('Delete account error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error'\n    });\n  }\n};\n\nconst getAllUsers = async (req, res) => {\n  try {\n    // Check if user is admin\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { page = 1, limit = 10, role, status } = req.query;\n\n    const query = {};\n    if (role) query.role = role;\n    if (status === 'active') query.isActive = true;\n    if (status === 'inactive') query.isActive = false;\n\n    const users = await User.find(query)\n      .select('-password')\n      .sort({ createdAt: -1 })\n      .limit(limit * 1)\n      .skip((page - 1) * limit);\n\n    const total = await User.countDocuments(query);\n\n    res.status(200).json({\n      success: true,\n      data: {\n        users,\n        pagination: {\n          currentPage: parseInt(page),\n          totalPages: Math.ceil(total / limit),\n          totalUsers: total,\n          hasNext: page < Math.ceil(total / limit),\n          hasPrev: page > 1\n        }\n      }\n    });\n\n  } catch (error) {\n    console.error('Get all users error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error'\n    });\n  }\n};\n\nconst updateUserStatus = async (req, res) => {\n  try {\n    // Check if user is admin\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { isActive } = req.body;\n    const userId = req.params.id;\n\n    // Prevent admin from deactivating themselves\n    if (userId === req.user.id.toString()) {\n      return res.status(400).json({\n        success: false,\n        message: 'You cannot change your own status'\n      });\n    }\n\n    const user = await User.findByIdAndUpdate(\n      userId,\n      { isActive },\n      { new: true, runValidators: true }\n    );\n\n    if (!user) {\n      return res.status(404).json({\n        success: false,\n        message: 'User not found'\n      });\n    }\n\n    res.status(200).json({\n      success: true,\n      message: `User ${isActive ? 'activated' : 'deactivated'} successfully`,\n      data: user\n    });\n\n  } catch (error) {\n    console.error('Update user status error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\nconst initializeAdmin = async (req, res) => {\n  try {\n    // Check if admin already exists\n    const adminExists = await User.findOne({ role: 'admin' });\n\n    if (adminExists) {\n      return res.status(400).json({\n        success: false,\n        message: 'Admin user already exists'\n      });\n    }\n\n    // Create default admin\n    const admin = await User.create({\n      name: 'Administrator',\n      email: process.env.ADMIN_EMAIL || 'admin@gmail.com',\n      password: process.env.ADMIN_PASSWORD || 'admin',\n      role: 'admin'\n    });\n\n    res.status(201).json({\n      success: true,\n      message: 'Default admin user created successfully',\n      admin: {\n        id: admin._id,\n        name: admin.name,\n        email: admin.email,\n        role: admin.role\n      }\n    });\n\n  } catch (error) {\n    console.error('Initialize admin error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while creating admin user'\n    });\n  }\n};\n\n// @desc    Unlock a locked user account (Admin only)\n// @route   PUT /api/auth/users/:id/unlock\n// @access  Private (Admin)\nconst unlockAccount = async (req, res) => {\n  try {\n    // Check if user is admin\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const userId = req.params.id;\n\n    // Find the user\n    const user = await User.findById(userId);\n\n    if (!user) {\n      return res.status(404).json({\n        success: false,\n        message: 'User not found'\n      });\n    }\n\n    // Check if account is actually locked\n    if (!user.isLocked) {\n      return res.status(400).json({\n        success: false,\n        message: 'Account is not locked'\n      });\n    }\n\n    // Unlock the account\n    await user.unlockAccount();\n\n    res.status(200).json({\n      success: true,\n      message: 'Account unlocked successfully',\n      data: {\n        id: user._id,\n        name: user.name,\n        email: user.email,\n        role: user.role,\n        isLocked: user.isLocked\n      }\n    });\n\n  } catch (error) {\n    console.error('Unlock account error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while unlocking account'\n    });\n  }\n};\n\nexport {\n  login,\n  register,\n  forgotPassword,\n  resetPassword,\n  getProfile,\n  updateProfile,\n  changePassword,\n  logout,\n  deleteAccount,\n  getAllUsers,\n  updateUserStatus,\n  initializeAdmin,\n  unlockAccount,\n  getMyProfile, // Keep your existing function\n  getMe        // Add the new enhanced function\n};\n","path":null,"size_bytes":32948,"size_tokens":null},"backend/utils/faceStorage.js":{"content":"export class FaceDataStorage {\n  static async saveFaceImage(base64Image, employeeId) {\n    try {\n      if (!base64Image || !base64Image.startsWith('data:image/')) {\n        throw new Error('Invalid image format');\n      }\n\n      // Extract image data\n      const matches = base64Image.match(/^data:image\\/([a-zA-Z]*);base64,(.+)$/);\n      if (!matches) {\n        throw new Error('Invalid base64 image format');\n      }\n\n      const imageType = matches[1];\n      const imageData = matches[2];\n\n      // Create filename\n      const timestamp = Date.now();\n      const filename = `face_${employeeId}_${timestamp}.${imageType}`;\n      const filepath = `uploads/faces/${filename}`;\n\n      // Ensure upload directory exists\n      const uploadDir = 'uploads/faces';\n      await fs.mkdir(uploadDir, { recursive: true });\n\n      // Save file\n      await fs.writeFile(filepath, imageData, 'base64');\n\n      return filepath;\n    } catch (error) {\n      console.error('Error saving face image:', error);\n      throw error;\n    }\n  }\n\n  static async deleteFaceImage(filepath) {\n    try {\n      if (filepath && await fs.access(filepath).then(() => true).catch(() => false)) {\n        await fs.unlink(filepath);\n      }\n    } catch (error) {\n      console.warn('Could not delete face image:', error);\n    }\n  }\n\n  static validateFaceImageSize(base64Image, maxSizeMB = 5) {\n    try {\n      // Calculate base64 size in bytes\n      const sizeInBytes = (base64Image.length * 3) / 4;\n      const sizeInMB = sizeInBytes / (1024 * 1024);\n      \n      return sizeInMB <= maxSizeMB;\n    } catch (error) {\n      return false;\n    }\n  }\n}\n\nexport default router;","path":null,"size_bytes":1636,"size_tokens":null},"frontend/tailwind.config.js":{"content":"/** @type {import('tailwindcss').Config} */\nmodule.exports = {\n  content: [\n    \"./src/**/*.{js,jsx,ts,tsx}\",\n  ],\n  theme: {\n    extend: {\n      colors: {\n        primary: {\n          50: '#fdf4ff',\n          100: '#fae8ff',\n          200: '#f5d0fe',\n          300: '#f0abfc',\n          400: '#e879f9',\n          500: '#d946ef',\n          600: '#c026d3',\n          700: '#a21caf',\n          800: '#86198f',\n          900: '#701a75',\n        },\n        secondary: {\n          50: '#f8fafc',\n          100: '#f1f5f9',\n          200: '#e2e8f0',\n          300: '#cbd5e1',\n          400: '#94a3b8',\n          500: '#64748b',\n          600: '#475569',\n          700: '#334155',\n          800: '#1e293b',\n          900: '#0f172a',\n        },\n        neon: {\n          pink: '#ff0080',\n          purple: '#8000ff',\n          glow: '#ff00ff',\n        }\n      },\n      animation: {\n        'pulse-neon': 'pulse-neon 2s ease-in-out infinite alternate',\n        'glow': 'glow 2s ease-in-out infinite alternate',\n      },\n      keyframes: {\n        'pulse-neon': {\n          '0%': { textShadow: '0 0 5px #ff0080, 0 0 10px #ff0080, 0 0 20px #ff0080' },\n          '100%': { textShadow: '0 0 10px #8000ff, 0 0 20px #8000ff, 0 0 40px #8000ff' }\n        },\n        'glow': {\n          '0%': { boxShadow: '0 0 5px #ff0080, 0 0 10px #ff0080, 0 0 20px #ff0080' },\n          '100%': { boxShadow: '0 0 10px #8000ff, 0 0 20px #8000ff, 0 0 40px #8000ff' }\n        }\n      }\n    },\n  },\n  plugins: [],\n}","path":null,"size_bytes":1478,"size_tokens":null},"frontend/src/utils/api.js":{"content":"// utils/api.js - Updated version with attendance endpoints\nimport axios from 'axios';\nimport toast from 'react-hot-toast';\n\n// Create axios instance with base URL\nconst API = axios.create({\n  baseURL: '/api',\n  headers: {\n    'Content-Type': 'application/json'\n  },\n  timeout: 30000 // 30 second timeout for all requests\n});\n\n// Get token from storage (check both localStorage and sessionStorage)\nconst getToken = () => {\n  return localStorage.getItem('token') || \n         sessionStorage.getItem('token') || \n         localStorage.getItem('authToken') || \n         sessionStorage.getItem('authToken');\n};\n\n// Get user role from storage\nconst getUserRole = () => {\n  return localStorage.getItem('userRole') || \n         sessionStorage.getItem('userRole') || \n         localStorage.getItem('role') || \n         sessionStorage.getItem('role');\n};\n\n// Add auth token to requests\nAPI.interceptors.request.use(\n  (config) => {\n    const token = getToken();\n    if (token) {\n      config.headers.Authorization = `Bearer ${token}`;\n    }\n    console.log('API Request:', {\n      url: config.url,\n      method: config.method,\n      hasToken: !!token,\n      token: token?.substring(0, 20) + '...'\n    });\n    return config;\n  },\n  \n  (error) => {\n    console.error('API Request Error:', error);\n    return Promise.reject(error);\n  }\n);\n\n// Handle auth errors and responses\nAPI.interceptors.response.use(\n  (response) => {\n    console.log('API Response:', {\n      url: response.config.url,\n      status: response.status,\n      success: response.data?.success\n    });\n    return response;\n  },\n  (error) => {\n    console.error('API Response Error:', {\n      url: error.config?.url,\n      status: error.response?.status,\n      message: error.response?.data?.message\n    });\n\n    if (error.response?.status === 401) {\n      console.log('Authentication failed, clearing storage and redirecting...');\n      \n      // Clear all auth data\n      localStorage.removeItem('token');\n      localStorage.removeItem('authToken');\n      localStorage.removeItem('userRole');\n      localStorage.removeItem('userEmail');\n      localStorage.removeItem('userName');\n      localStorage.removeItem('userId');\n      localStorage.removeItem('employeeId');\n      \n      sessionStorage.removeItem('token');\n      sessionStorage.removeItem('authToken');\n      sessionStorage.removeItem('userRole');\n      sessionStorage.removeItem('userEmail');\n      sessionStorage.removeItem('userName');\n      sessionStorage.removeItem('userId');\n      sessionStorage.removeItem('employeeId');\n      \n      // Redirect to login\n      window.location.href = '/login';\n      toast.error('Session expired. Please login again.');\n    }\n    \n    return Promise.reject(error);\n  }\n);\n\n// Dashboard API calls\nexport const dashboardAPI = {\n  getAdminStats: () => API.get('/dashboard/stats'),\n  getEmployeeStats: () => API.get('/dashboard/employee-stats'),\n  getRecentActivities: () => API.get('/dashboard/activities'),\n  getUpcomingEvents: () => API.get('/dashboard/events'),\n  getDashboardSummary: () => API.get('/dashboard/summary'),\n\n  // / New notification endpoints\n    getUserNotifications: () => API.get('/dashboard/notifications'),\n\n  getNotifications: () => API.get('/dashboard/notifications'),\n  markNotificationAsRead: (notificationId) => API.put(`/dashboard/notifications/${notificationId}/read`),\n  markAllNotificationsAsRead: () => API.put('/dashboard/notifications/read-all')\n};\n\n// Employee API calls\nexport const employeeAPI = {\n  createEmployee: (employeeData) => API.post('/employees', employeeData),\n  getEmployees: (params = {}) => API.get('/employees', { params }),\n  getEmployeeById: (id) => {\n    console.log('employeeAPI.getEmployeeById called with id:', id);\n    console.log('Making request to:', `/employees/${id}`);\n    return API.get(`/employees/${id}`);\n  },\n  getMyProfile: () => API.get('/auth/me'),\n  updateEmployee: (id, employeeData) => API.put(`/employees/${id}`, employeeData),\n  deleteEmployee: (id) => API.delete(`/employees/${id}`),\n  getEmployeeStats: () => API.get('/employees/stats'),\n  getEmployeesByDepartment: (department) => API.get(`/employees/department/${department}`),\n\n  // Message/Chat endpoints\n  get: (endpoint) => API.get(endpoint),\n  post: (endpoint, data) => API.post(endpoint, data)\n};\n\n// Department API calls\nexport const departmentAPI = {\n  // Get all departments with optional filtering\n  getDepartments: (params = {}) => {\n    const queryString = new URLSearchParams(params).toString();\n    const url = `/departments${queryString ? `?${queryString}` : ''}`;\n    console.log('Fetching departments from:', url);\n    return API.get(url);\n  },\n\n  // Get department by ID\n  getDepartmentById: (id) => {\n    console.log('Fetching department by ID:', id);\n    return API.get(`/departments/${id}`);\n  },\n\n  // Create new department\n  createDepartment: (departmentData) => {\n    console.log('Creating department:', departmentData);\n    return API.post('/departments', departmentData);\n  },\n\n  // Update department\n  updateDepartment: (id, departmentData) => {\n    console.log('Updating department:', id, departmentData);\n    return API.put(`/departments/${id}`, departmentData);\n  },\n\n  // Delete department\n  deleteDepartment: (id) => {\n    console.log('Deleting department:', id);\n    return API.delete(`/departments/${id}`);\n  },\n\n  // Get department statistics\n  getDepartmentStats: () => {\n    console.log('Fetching department stats');\n    return API.get('/departments/stats');\n  },\n\n  // Get department list (lightweight - for dropdowns in employee forms)\n  getDepartmentList: () => {\n    console.log('Fetching department list for dropdowns');\n    return API.get('/departments/list');\n  },\n\n  // Get employees by department\n  getDepartmentEmployees: (departmentId) => {\n    console.log('Fetching employees for department:', departmentId);\n    return API.get(`/departments/${departmentId}/employees`);\n  }\n};\n\n// Lead API calls\nexport const leadAPI = {\n  // Get all leads with filters and pagination\n  getLeads: (params = {}) => {\n    console.log('Fetching leads with params:', params);\n    return API.get('/leads', { params });\n  },\n\n  // Get lead by ID\n  getLeadById: (id) => {\n    console.log('Fetching lead by ID:', id);\n    return API.get(`/leads/${id}`);\n  },\n\n  // Create new lead\n  createLead: (leadData) => {\n    console.log('Creating lead:', leadData);\n    return API.post('/leads', leadData);\n  },\n\n  // Update lead\n  updateLead: (id, leadData) => {\n    console.log('Updating lead:', id, leadData);\n    return API.put(`/leads/${id}`, leadData);\n  },\n\n  // Delete lead (Admin only)\n  deleteLead: (id) => {\n    console.log('Deleting lead:', id);\n    return API.delete(`/leads/${id}`);\n  },\n\n  // Get lead statistics\n  getLeadStats: () => {\n    console.log('Fetching lead stats');\n    return API.get('/leads/stats');\n  },\n\n  // Get upcoming follow-ups\n  getUpcomingFollowUps: () => {\n    console.log('Fetching upcoming follow-ups');\n    return API.get('/leads/upcoming-followups');\n  },\n\n  // Get overdue follow-ups\n  getOverdueFollowUps: () => {\n    console.log('Fetching overdue follow-ups');\n    return API.get('/leads/overdue-followups');\n  },\n\n  // Get upcoming meetings\n  getUpcomingMeetings: () => {\n    console.log('Fetching upcoming meetings');\n    return API.get('/leads/upcoming-meetings');\n  },\n\n  // Add note to lead\n  addLeadNote: (leadId, content) => {\n    console.log('Adding note to lead:', leadId, content);\n    return API.post(`/leads/${leadId}/notes`, { content });\n  },\n\n  // Lead conversion and pipeline management\n  convertLead: (leadId, conversionData) => {\n    console.log('Converting lead:', leadId, conversionData);\n    return API.put(`/leads/${leadId}/convert`, conversionData);\n  },\n\n  // Bulk operations\n  bulkUpdateLeads: (leadIds, updateData) => {\n    console.log('Bulk updating leads:', leadIds, updateData);\n    return API.put('/leads/bulk-update', { leadIds, updateData });\n  },\n\n  // Update won lead details\n  updateWonLead: (id, wonData) => {\n    console.log('Updating won lead details:', id, wonData);\n    return API.put(`/leads/${id}/won-details`, wonData);\n  },\n\n  // Add meeting to lead\n  addMeeting: (leadId, meetingData) => {\n    console.log('Adding meeting to lead:', leadId, meetingData);\n    return API.post(`/leads/${leadId}/meetings`, meetingData);\n  },\n  \n  // Update meeting\n  updateMeeting: (leadId, meetingId, meetingData) => {\n    console.log('Updating meeting:', leadId, meetingId, meetingData);\n    return API.put(`/leads/${leadId}/meetings/${meetingId}`, meetingData);\n  },\n\n  // Export leads\n  exportLeads: (params = {}) => {\n    console.log('Exporting leads with params:', params);\n    return API.get('/leads/export', { \n      params,\n      responseType: 'blob' // For file download\n    });\n  }}\n\n// Auth API calls\nexport const authAPI = {\n  login: (loginData) => API.post('/auth/login', loginData),\n  logout: () => API.post('/auth/logout'),\n  getProfile: () => API.get('/auth/profile'),\n  getMyProfile: () => API.get('/auth/me'),\n  updateProfile: (profileData) => API.put('/auth/profile', profileData),\n  changePassword: (passwordData) => API.put('/auth/change-password', passwordData),\n  forgotPassword: (email) => API.post('/auth/forgot-password', { email }),\n  resetPassword: (token, password) => API.put(`/auth/reset-password/${token}`, { password }),\n\n  // Alternative endpoint that checks both user and employee data\n  getCurrentUser: async () => {\n    try {\n      // First try to get auth profile\n      const authResponse = await API.get('/auth/me');\n      if (authResponse.data.success) {\n        return authResponse;\n      }\n    } catch (error) {\n      console.log('Auth endpoint failed, trying employee endpoint');\n    }\n    \n    // Fallback to employee endpoint\n    try {\n      console.log('Calling employeeAPI.getEmployeeById with \"me\"');\n      const employeeResponse = await employeeAPI.getEmployeeById('me');\n      if (employeeResponse.data.success) {\n        // Transform employee data to match auth format\n        const employee = employeeResponse.data.data;\n        return {\n          data: {\n            success: true,\n            data: {\n              id: employee.user?._id,\n              name: employee.fullName,\n              email: employee.user?.email || employee.contactInfo?.personalEmail,\n              role: employee.user?.role || 'employee',\n              employeeId: employee.user?.employeeId || employee.employeeId,\n              personalInfo: employee.personalInfo,\n              contactInfo: employee.contactInfo,\n              workInfo: employee.workInfo,\n              hasFaceRegistered: employee.hasFaceRegistered\n            }\n          }\n        };\n      }\n    } catch (employeeError) {\n      console.error('Both auth and employee endpoints failed:', employeeError);\n      throw employeeError;\n    }\n  }\n};\n\n// Notification utility functions\nexport const notificationUtils = {\n  // Format notification time for display\n  formatNotificationTime: (timestamp) => {\n    const now = new Date();\n    const time = new Date(timestamp);\n    const diffInMinutes = Math.floor((now - time) / (1000 * 60));\n    \n    if (diffInMinutes < 1) return 'Just now';\n    if (diffInMinutes < 60) return `${diffInMinutes} min ago`;\n    \n    const diffInHours = Math.floor(diffInMinutes / 60);\n    if (diffInHours < 24) return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;\n    \n    const diffInDays = Math.floor(diffInHours / 24);\n    if (diffInDays < 7) return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;\n    \n    return time.toLocaleDateString();\n  },\n\n  // Get notification priority based on type and category\n  getNotificationPriority: (notification) => {\n    const { type, category } = notification;\n    \n    if (type === 'error') return 3; // High priority\n    if (type === 'warning') return 2; // Medium priority\n    if (category === 'leave' && type === 'info') return 2; // Medium priority\n    return 1; // Low priority\n  },\n\n  // Group notifications by category\n  groupNotificationsByCategory: (notifications) => {\n    const grouped = {\n      tasks: [],\n      leaves: [],\n      employee: [],\n      attendance: [],\n      profile: [],\n      other: []\n    };\n    \n    notifications.forEach(notification => {\n      const category = notification.category || 'other';\n      if (grouped[category]) {\n        grouped[category].push(notification);\n      } else {\n        grouped.other.push(notification);\n      }\n    });\n    \n    return grouped;\n  },\n\n  // Get notification sound/vibration settings (for future use)\n  getNotificationSettings: () => {\n    const settings = localStorage.getItem('notificationSettings');\n    return settings ? JSON.parse(settings) : {\n      sound: true,\n      vibration: true,\n      desktop: true,\n      email: false\n    };\n  },\n\n  // Save notification settings\n  saveNotificationSettings: (settings) => {\n    localStorage.setItem('notificationSettings', JSON.stringify(settings));\n  }\n\n};\n\n\n// Attendance API calls\nexport const attendanceAPI = {\n  // Employee attendance functions\n  checkIn: (attendanceData) => API.post('/attendance/checkin', attendanceData),\n  checkOut: (attendanceData) => API.put('/attendance/checkout', attendanceData),\n  getTodayAttendance: () => API.get('/attendance/today'),\n  getAttendanceHistory: (params = {}) => API.get('/attendance/history', { params }),\n  \n  // Admin attendance functions\n  getAllAttendance: (params = {}) => API.get('/attendance/all', { params }),\n  getAttendanceSummary: (params = {}) => API.get('/attendance/summary', { params }),\n  updateAttendance: (id, attendanceData) => API.put(`/attendance/${id}`, attendanceData),\n  deleteAttendance: (id) => API.delete(`/attendance/${id}`)\n};\n\n// Geolocation utility functions\nexport const geolocationUtils = {\n  getCurrentPosition: () => {\n    return new Promise((resolve, reject) => {\n      if (!navigator.geolocation) {\n        reject(new Error('Geolocation is not supported by this browser'));\n        return;\n      }\n\n      const options = {\n        enableHighAccuracy: true,\n        timeout: 10000,\n        maximumAge: 60000 // 1 minute cache\n      };\n\n      navigator.geolocation.getCurrentPosition(\n        (position) => {\n          resolve({\n            latitude: position.coords.latitude,\n            longitude: position.coords.longitude,\n            accuracy: position.coords.accuracy,\n            timestamp: position.timestamp\n          });\n        },\n        (error) => {\n          let errorMessage = 'Unable to retrieve your location';\n          \n          switch (error.code) {\n            case error.PERMISSION_DENIED:\n              errorMessage = 'Location access denied by user';\n              break;\n            case error.POSITION_UNAVAILABLE:\n              errorMessage = 'Location information is unavailable';\n              break;\n            case error.TIMEOUT:\n              errorMessage = 'Location request timed out';\n              break;\n            default:\n              errorMessage = 'An unknown error occurred while retrieving location';\n              break;\n          }\n          \n          reject(new Error(errorMessage));\n        },\n        options\n      );\n    });\n  },\n\n  // Get address from coordinates (reverse geocoding)\n  getAddressFromCoords: async (latitude, longitude) => {\n    try {\n      // Using a free geocoding service\n      const response = await fetch(\n        `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`\n      );\n      \n      if (!response.ok) {\n        throw new Error('Geocoding service unavailable');\n      }\n      \n      const data = await response.json();\n      return data.display_name || data.locality || 'Unknown location';\n    } catch (error) {\n      console.warn('Geocoding failed:', error);\n      return `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;\n    }\n  },\n\n  // Get device information\n  getDeviceInfo: () => {\n    const userAgent = navigator.userAgent;\n    let browser = 'Unknown';\n    let platform = navigator.platform || 'Unknown';\n\n    // Simple browser detection\n    if (userAgent.includes('Chrome')) browser = 'Chrome';\n    else if (userAgent.includes('Firefox')) browser = 'Firefox';\n    else if (userAgent.includes('Safari')) browser = 'Safari';\n    else if (userAgent.includes('Edge')) browser = 'Edge';\n    else if (userAgent.includes('Opera')) browser = 'Opera';\n\n    return {\n      userAgent,\n      platform,\n      browser,\n      language: navigator.language,\n      cookieEnabled: navigator.cookieEnabled,\n      onLine: navigator.onLine\n    };\n  },\n\n  // Calculate distance between two coordinates (in meters)\n  calculateDistance: (lat1, lon1, lat2, lon2) => {\n    const R = 6371e3; // Earth's radius in meters\n    const φ1 = lat1 * Math.PI / 180;\n    const φ2 = lat2 * Math.PI / 180;\n    const Δφ = (lat2 - lat1) * Math.PI / 180;\n    const Δλ = (lon2 - lon1) * Math.PI / 180;\n\n    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +\n              Math.cos(φ1) * Math.cos(φ2) *\n              Math.sin(Δλ/2) * Math.sin(Δλ/2);\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));\n\n    return R * c; // Distance in meters\n  }\n};\n\n// AI API calls\nexport const aiAPI = {\n  chat: (message) => API.post('/ai/chat', { message })\n};\n\n// Bot API calls\nexport const botAPI = {\n  sendMessage: (text, userId) => API.post('/bot/message', { text, userId }),\n  sendAdminMessage: (text) => API.post('/bot/admin-message', { text }),\n  getHistory: (userId) => API.get(`/bot/history/${userId}`)\n};\n\n// Purchase API calls\nexport const purchaseAPI = {\n  getPurchaseOrders: (filters) => API.get('/purchase', { params: filters }),\n  getSuppliers: () => API.get('/purchase/suppliers'),\n  createSupplier: (data) => API.post('/purchase/suppliers', data),\n  createPurchaseOrder: (data) => API.post('/purchase', data),\n  updatePurchaseOrder: (id, data) => API.put(`/purchase/${id}`, data),\n  deletePurchaseOrder: (id) => API.delete(`/purchase/${id}`)\n};\n\n// Payslip API calls\nexport const payslipAPI = {\n  getPayslips: (params = {}) => API.get('/payslips', { params }),\n  getPayslipById: (id) => API.get(`/payslips/${id}`),\n  getEmployeePayslips: (employeeId) => API.get(`/payslips/employee/${employeeId}`),\n  generatePayslip: (data) => API.post('/payslips/generate', data),\n  bulkGenerate: (data) => API.post('/payslips/bulk-generate', data),\n  downloadPayslip: (id) => API.get(`/payslips/${id}/download`, { responseType: 'blob' }),\n  updatePayslipStatus: (id, data) => API.patch(`/payslips/${id}/status`, data),\n  deletePayslip: (id) => API.delete(`/payslips/${id}`)\n};\n\n// Banking Details API (Admin only)\nexport const bankingAPI = {\n  getEmployeeBankingDetails: (employeeId) => API.get(`/employees/${employeeId}/banking`)\n};\n\n// Export the configured axios instance\nexport default API;\n","path":null,"size_bytes":18762,"size_tokens":null},"frontend/src/pages/Employee/EmployeeProfile.jsx":{"content":"import React, { useState, useEffect } from 'react';\nimport { User, Mail, Phone, Building2, Briefcase, Calendar, Save, Camera } from 'lucide-react';\nimport toast from 'react-hot-toast';\nimport EmployeeLayout from '../../components/Employee/EmployeeLayout/EmployeeLayout';\nimport { authAPI } from '../../utils/api';\n\nconst EmployeeProfile = () => {\n  const [profile, setProfile] = useState({\n    name: '',\n    email: '',\n    phone: '',\n    department: '',\n    position: '',\n    employeeId: '',\n    joiningDate: ''\n  });\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n\n  useEffect(() => {\n    fetchProfile();\n  }, []);\n\n  const fetchProfile = async () => {\n    try {\n      setLoading(true);\n      const response = await authAPI.getProfile();\n      if (response.data.success) {\n        const userData = response.data.data.user;\n        const employeeData = response.data.data.employee;\n\n        setProfile({\n          name: userData.name || (employeeData?.personalInfo ? `${employeeData.personalInfo.firstName} ${employeeData.personalInfo.lastName}` : '') || localStorage.getItem('userName') || '',\n          email: userData.email || employeeData?.contactInfo?.personalEmail || localStorage.getItem('userEmail') || '',\n          phone: userData.phone || employeeData?.contactInfo?.phone || '',\n          department: employeeData?.workInfo?.department?.name || localStorage.getItem('userDepartment') || '',\n          position: employeeData?.workInfo?.position || '',\n          employeeId: userData.employeeId || employeeData?.employeeId || localStorage.getItem('employeeId') || '',\n          joiningDate: employeeData?.workInfo?.joiningDate || ''\n        });\n      }\n    } catch (error) {\n      console.error('Error fetching profile:', error);\n      setProfile({\n        name: localStorage.getItem('userName') || 'Employee',\n        email: localStorage.getItem('userEmail') || '',\n        phone: '',\n        department: localStorage.getItem('userDepartment') || '',\n        position: '',\n        employeeId: localStorage.getItem('employeeId') || '',\n        joiningDate: ''\n      });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleChange = (e) => {\n    setProfile(prev => ({\n      ...prev,\n      [e.target.name]: e.target.value\n    }));\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setSaving(true);\n    try {\n      await authAPI.updateProfile({\n        name: profile.name,\n        phone: profile.phone\n      });\n      toast.success('Profile updated successfully');\n      localStorage.setItem('userName', profile.name);\n      // Refresh profile data to show updated values\n      await fetchProfile();\n    } catch (error) {\n      console.error('Update profile error:', error);\n      toast.error(error.response?.data?.message || 'Failed to update profile');\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  if (loading) {\n    return (\n      <EmployeeLayout>\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-neon-pink\"></div>\n        </div>\n      </EmployeeLayout>\n    );\n  }\n\n  return (\n    <EmployeeLayout>\n      <div className=\"max-w-2xl mx-auto\">\n        <div className=\"mb-6\">\n          <h1 className=\"text-2xl font-bold text-white\">My Profile</h1>\n          <p className=\"text-secondary-400 mt-1\">View and update your information</p>\n        </div>\n\n        <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n          <div className=\"flex items-center space-x-4 mb-8\">\n            <div className=\"relative\">\n              <div className=\"w-20 h-20 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center\">\n                <User className=\"w-10 h-10 text-white\" />\n              </div>\n              <button className=\"absolute bottom-0 right-0 w-8 h-8 bg-secondary-700 rounded-full flex items-center justify-center border-2 border-secondary-800 hover:bg-secondary-600 transition-colors\">\n                <Camera className=\"w-4 h-4 text-white\" />\n              </button>\n            </div>\n            <div>\n              <h2 className=\"text-xl font-semibold text-white\">{profile.name}</h2>\n              <p className=\"text-sm text-secondary-400\">{profile.position || 'Employee'}</p>\n              {profile.employeeId && (\n                <p className=\"text-xs text-neon-pink mt-1\">ID: {profile.employeeId}</p>\n              )}\n            </div>\n          </div>\n\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                  Full Name\n                </label>\n                <div className=\"relative\">\n                  <User className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                  <input\n                    type=\"text\"\n                    value={profile.name}\n                    disabled\n                    className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/30 border border-secondary-700 rounded-lg text-secondary-400 cursor-not-allowed\"\n                  />\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                  Employee ID\n                </label>\n                <div className=\"relative\">\n                  <Briefcase className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                  <input\n                    type=\"text\"\n                    value={profile.employeeId}\n                    disabled\n                    className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/30 border border-secondary-700 rounded-lg text-secondary-400 cursor-not-allowed\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                Email Address\n              </label>\n              <div className=\"relative\">\n                <Mail className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                <input\n                  type=\"email\"\n                  value={profile.email}\n                  disabled\n                  className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/30 border border-secondary-700 rounded-lg text-secondary-400 cursor-not-allowed\"\n                />\n              </div>\n            </div>\n\n            <div>\n              <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                Phone Number\n              </label>\n              <div className=\"relative\">\n                <Phone className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                <input\n                  type=\"tel\"\n                  name=\"phone\"\n                  value={profile.phone}\n                  onChange={handleChange}\n                  className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/50 border border-secondary-600 rounded-lg text-white placeholder-secondary-500 focus:border-neon-pink focus:ring-2 focus:ring-neon-pink/20 transition-all\"\n                  placeholder=\"Enter your phone number\"\n                />\n              </div>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                  Department\n                </label>\n                <div className=\"relative\">\n                  <Building2 className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                  <input\n                    type=\"text\"\n                    value={profile.department}\n                    disabled\n                    className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/30 border border-secondary-700 rounded-lg text-secondary-400 cursor-not-allowed\"\n                  />\n                </div>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                  Position\n                </label>\n                <div className=\"relative\">\n                  <Briefcase className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                  <input\n                    type=\"text\"\n                    value={profile.position}\n                    disabled\n                    className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/30 border border-secondary-700 rounded-lg text-secondary-400 cursor-not-allowed\"\n                  />\n                </div>\n              </div>\n            </div>\n\n            {profile.joiningDate && (\n              <div>\n                <label className=\"block text-sm font-medium text-secondary-300 mb-2\">\n                  Joining Date\n                </label>\n                <div className=\"relative\">\n                  <Calendar className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400\" />\n                  <input\n                    type=\"text\"\n                    value={new Date(profile.joiningDate).toLocaleDateString()}\n                    disabled\n                    className=\"w-full pl-10 pr-4 py-3 bg-secondary-800/30 border border-secondary-700 rounded-lg text-secondary-400 cursor-not-allowed\"\n                  />\n                </div>\n              </div>\n            )}\n\n            <button\n              type=\"submit\"\n              disabled={saving}\n              className=\"w-full py-3 px-4 bg-gradient-to-r from-neon-pink to-neon-purple text-white font-semibold rounded-lg hover-glow transition-all duration-300 disabled:opacity-50 flex items-center justify-center space-x-2\"\n            >\n              {saving ? (\n                <span className=\"flex items-center\">\n                  <svg className=\"animate-spin -ml-1 mr-3 h-5 w-5 text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                  </svg>\n                  Saving...\n                </span>\n              ) : (\n                <>\n                  <Save className=\"w-5 h-5\" />\n                  <span>Save Changes</span>\n                </>\n              )}\n            </button>\n          </form>\n        </div>\n      </div>\n    </EmployeeLayout>\n  );\n};\n\nexport default EmployeeProfile;","path":null,"size_bytes":10862,"size_tokens":null},"backend/controllers/notificationController.js":{"content":"import Notification from '../models/Notification.js';\nimport User from '../models/User.js';\n\n// @desc    Get user notifications\n// @route   GET /api/notifications\n// @access  Private\nexport const getUserNotifications = async (req, res) => {\n  try {\n    const { page = 1, limit = 20, category, isRead, type } = req.query;\n\n    const result = await Notification.getUserNotifications(req.user.id, {\n      page: parseInt(page),\n      limit: parseInt(limit),\n      category,\n      isRead: isRead === 'true',\n      type\n    });\n\n    res.json({\n      success: true,\n      data: result.notifications,\n      pagination: result.pagination\n    });\n\n  } catch (error) {\n    console.error('Get user notifications error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching notifications'\n    });\n  }\n};\n\n// @desc    Get unread notification count\n// @route   GET /api/notifications/unread-count\n// @access  Private\nexport const getUnreadCount = async (req, res) => {\n  try {\n    const count = await Notification.getUnreadCount(req.user.id);\n\n    res.json({\n      success: true,\n      count\n    });\n\n  } catch (error) {\n    console.error('Get unread count error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching unread count'\n    });\n  }\n};\n\n// @desc    Mark notification as read\n// @route   PUT /api/notifications/:id/read\n// @access  Private\nexport const markAsRead = async (req, res) => {\n  try {\n    const notification = await Notification.findById(req.params.id);\n\n    if (!notification) {\n      return res.status(404).json({\n        success: false,\n        message: 'Notification not found'\n      });\n    }\n\n    // Check if user is authorized to read this notification\n    if (!notification.targetUsers.includes(req.user.id)) {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied'\n      });\n    }\n\n    await notification.markAsRead(req.user.id);\n    await notification.populate('sender', 'name email');\n\n    res.json({\n      success: true,\n      message: 'Notification marked as read',\n      data: notification\n    });\n\n  } catch (error) {\n    console.error('Mark as read error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while marking notification as read'\n    });\n  }\n};\n\n// @desc    Mark all notifications as read\n// @route   PUT /api/notifications/read-all\n// @access  Private\nexport const markAllAsRead = async (req, res) => {\n  try {\n    const { category } = req.query;\n\n    const query = {\n      targetUsers: req.user.id,\n      isRead: false\n    };\n\n    if (category) {\n      query.category = category;\n    }\n\n    const notifications = await Notification.find(query);\n\n    for (const notification of notifications) {\n      await notification.markAsRead(req.user.id);\n    }\n\n    res.json({\n      success: true,\n      message: 'All notifications marked as read',\n      count: notifications.length\n    });\n\n  } catch (error) {\n    console.error('Mark all as read error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while marking notifications as read'\n    });\n  }\n};\n\n// @desc    Delete notification\n// @route   DELETE /api/notifications/:id\n// @access  Private\nexport const deleteNotification = async (req, res) => {\n  try {\n    const notification = await Notification.findById(req.params.id);\n\n    if (!notification) {\n      return res.status(404).json({\n        success: false,\n        message: 'Notification not found'\n      });\n    }\n\n    // Check if user is authorized to delete this notification\n    if (!notification.targetUsers.includes(req.user.id)) {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied'\n      });\n    }\n\n    await notification.deleteOne();\n\n    res.json({\n      success: true,\n      message: 'Notification deleted successfully'\n    });\n\n  } catch (error) {\n    console.error('Delete notification error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while deleting notification'\n    });\n  }\n};\n\n// @desc    Create notification (Admin/Employee)\n// @route   POST /api/notifications\n// @access  Private\nexport const createNotification = async (req, res) => {\n  try {\n    const { title, message, type, category, targetUsers, priority, metadata } = req.body;\n\n    // Validate required fields\n    if (!title || !message || !category || !targetUsers || !Array.isArray(targetUsers)) {\n      return res.status(400).json({\n        success: false,\n        message: 'Title, message, category, and targetUsers are required'\n      });\n    }\n\n    // Verify target users exist\n    const users = await User.find({ _id: { $in: targetUsers } });\n    if (users.length !== targetUsers.length) {\n      return res.status(400).json({\n        success: false,\n        message: 'One or more target users not found'\n      });\n    }\n\n    const notification = await Notification.createNotification({\n      title,\n      message,\n      type: type || 'info',\n      category,\n      targetUsers,\n      sender: req.user.id,\n      priority: priority || 'medium',\n      metadata: metadata || {}\n    });\n\n    await notification.populate('sender', 'name email');\n\n    res.status(201).json({\n      success: true,\n      message: 'Notification created successfully',\n      data: notification\n    });\n\n  } catch (error) {\n    console.error('Create notification error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while creating notification'\n    });\n  }\n};\n\n// @desc    Get notification statistics\n// @route   GET /api/notifications/stats\n// @access  Private\nexport const getNotificationStats = async (req, res) => {\n  try {\n    const userId = req.user.id;\n\n    const total = await Notification.countDocuments({ targetUsers: userId });\n    const unread = await Notification.countDocuments({\n      targetUsers: userId,\n      isRead: false\n    });\n\n    // Category-wise count\n    const categoryStats = await Notification.aggregate([\n      { $match: { targetUsers: userId } },\n      { $group: { _id: '$category', count: { $sum: 1 } } }\n    ]);\n\n    // Type-wise count\n    const typeStats = await Notification.aggregate([\n      { $match: { targetUsers: userId } },\n      { $group: { _id: '$type', count: { $sum: 1 } } }\n    ]);\n\n    res.json({\n      success: true,\n      stats: {\n        total,\n        unread,\n        read: total - unread,\n        categoryStats,\n        typeStats\n      }\n    });\n\n  } catch (error) {\n    console.error('Get notification stats error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while fetching notification statistics'\n    });\n  }\n};\n\n// @desc    Send notification to admins\n// @route   POST /api/notifications/notify-admins\n// @access  Private\nexport const notifyAdmins = async (req, res) => {\n  try {\n    const { title, message, type, category, priority, metadata } = req.body;\n\n    // Get all admin users\n    const adminUsers = await User.find({ role: 'admin', isActive: true });\n\n    if (adminUsers.length === 0) {\n      return res.status(404).json({\n        success: false,\n        message: 'No active admin users found'\n      });\n    }\n\n    const notification = await Notification.createNotification({\n      title,\n      message,\n      type: type || 'info',\n      category,\n      targetUsers: adminUsers.map(admin => admin._id),\n      sender: req.user.id,\n      priority: priority || 'medium',\n      metadata: metadata || {}\n    });\n\n    await notification.populate('sender', 'name email');\n\n    res.status(201).json({\n      success: true,\n      message: `Notification sent to ${adminUsers.length} admin(s)`,\n      data: notification\n    });\n\n  } catch (error) {\n    console.error('Notify admins error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while notifying admins'\n    });\n  }\n};\n\n// @desc    Send notification to specific users\n// @route   POST /api/notifications/notify-users\n// @access  Private\nexport const notifyUsers = async (req, res) => {\n  try {\n    const { title, message, type, category, userIds, priority, metadata } = req.body;\n\n    if (!userIds || !Array.isArray(userIds) || userIds.length === 0) {\n      return res.status(400).json({\n        success: false,\n        message: 'User IDs are required'\n      });\n    }\n\n    // Verify users exist\n    const users = await User.find({ _id: { $in: userIds } });\n    if (users.length !== userIds.length) {\n      return res.status(400).json({\n        success: false,\n        message: 'One or more users not found'\n      });\n    }\n\n    const notification = await Notification.createNotification({\n      title,\n      message,\n      type: type || 'info',\n      category,\n      targetUsers: userIds,\n      sender: req.user.id,\n      priority: priority || 'medium',\n      metadata: metadata || {}\n    });\n\n    await notification.populate('sender', 'name email');\n\n    res.status(201).json({\n      success: true,\n      message: `Notification sent to ${userIds.length} user(s)`,\n      data: notification\n    });\n\n  } catch (error) {\n    console.error('Notify users error:', error);\n    res.status(500).json({\n      success: false,\n      message: 'Server error while notifying users'\n    });\n  }\n};\n","path":null,"size_bytes":9310,"size_tokens":null},"backend/middleware/faceValidation.js":{"content":"export const validateFaceData = (req, res, next) => {\n  const { faceDescriptor } = req.body;\n  \n  if (faceDescriptor) {\n    try {\n      // Parse if it's a string\n      const descriptor = typeof faceDescriptor === 'string' \n        ? JSON.parse(faceDescriptor) \n        : faceDescriptor;\n\n      // Validate descriptor format\n      if (!Array.isArray(descriptor)) {\n        return res.status(400).json({\n          success: false,\n          message: 'Face descriptor must be an array'\n        });\n      }\n\n      // face-api.js uses 128-dimensional descriptors\n      if (descriptor.length !== 128) {\n        return res.status(400).json({\n          success: false,\n          message: `Face descriptor must have exactly 128 dimensions (received ${descriptor.length})`\n        });\n      }\n\n      // Validate that all values are numbers\n      if (!descriptor.every(val => typeof val === 'number' && !isNaN(val))) {\n        return res.status(400).json({\n          success: false,\n          message: 'Face descriptor must contain only valid numbers'\n        });\n      }\n\n      // Store parsed descriptor back in request\n      req.body.faceDescriptor = descriptor;\n    } catch (error) {\n      return res.status(400).json({\n        success: false,\n        message: 'Invalid face descriptor format'\n      });\n    }\n  }\n  \n  next();\n};\n","path":null,"size_bytes":1322,"size_tokens":null},"frontend/src/routes/ProtectedRoute.jsx":{"content":"import React from 'react';\nimport { Navigate } from 'react-router-dom';\n\nconst ProtectedRoute = ({ children, role, requiredRole }) => {\n  const effectiveRole = role || requiredRole;\n  \n  const token = localStorage.getItem('token') || \n                sessionStorage.getItem('token') || \n                sessionStorage.getItem('authToken');\n  \n  const userRole = localStorage.getItem('userRole') || \n                   sessionStorage.getItem('userRole');\n\n  if (!token) {\n    return <Navigate to=\"/login\" replace />;\n  }\n\n  if (effectiveRole && userRole !== effectiveRole) {\n    if (userRole === 'admin') {\n      return <Navigate to=\"/admin/dashboard\" replace />;\n    } else if (userRole === 'employee') {\n      return <Navigate to=\"/employee/dashboard\" replace />;\n    } else {\n      localStorage.clear();\n      sessionStorage.clear();\n      return <Navigate to=\"/login\" replace />;\n    }\n  }\n\n  return children;\n};\n\nexport default ProtectedRoute;","path":null,"size_bytes":947,"size_tokens":null},"backend/test-email.js":{"content":"// test-email.js\nimport { sendEmail } from './utils/email.js'; // 👈 Adjust path if needed!\n\nconst testSend = async () => {\n  try {\n    const result = await sendEmail({\n      to: 'your-real-email@gmail.com', // 🚨 REPLACE THIS WITH YOUR EMAIL\n      subject: 'Test Email from Backend',\n      html: '<h1>Hello from Node.js!</h1><p>This is a test email to verify your setup.</p>',\n    });\n    console.log('📧 Test email sent successfully:', result);\n  } catch (error) {\n    console.error('❌ Failed to send test email:', error.message);\n  }\n};\n\ntestSend();","path":null,"size_bytes":560,"size_tokens":null},"backend/server.js":{"content":"import express from 'express';\nimport { createServer } from 'http';\nimport { Server as SocketIOServer } from 'socket.io';\nimport helmet from 'helmet';\nimport cors from 'cors';\nimport dotenv from 'dotenv';\nimport mongoose from 'mongoose';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nimport connectDB from './config/db.js';\nimport errorHandler from './middleware/errorHandler.js';\nimport setupShutdown from './utils/shutdown.js';\nimport setupChatSocket from './socket/chat.js';\n\n// Routes\nimport authRoutes from './routes/authRoutes.js';\nimport employeeRoutes from './routes/employeeRoutes.js';\nimport userRoutes from './routes/userRoutes.js';\nimport dashboardRoutes from './routes/dashboardRoutes.js';\nimport leaveRoutes from './routes/leaveRoutes.js';\nimport taskRoutes from './routes/taskRoutes.js';\nimport attendanceRoutes from './routes/attendanceRoutes.js';\nimport departmentRoutes from './routes/departmentRoutes.js';\nimport leadsRoutes from  './routes/leadRoutes.js';\nimport notificationRoutes from './routes/notificationRoutes.js';\nimport problemRoutes from './routes/problemRoutes.js';\nimport messageRoutes from './routes/messageRoutes.js';\nimport botRoutes from './routes/botRoutes.js';\nimport aiRoutes from './routes/aiRoutes.js';\nimport purchaseRoutes from './routes/purchaseRoutes.js';\nimport faceDetectionRoutes from './routes/faceDetectionRoutes.js';\nimport payslipRoutes from './routes/payslipRoutes.js';\nimport groupRoutes from './routes/groupRoutes.js';\n\n// import { createAdminIfNotExists } from './controllers/initAdmin.js';\n\ndotenv.config();\n\nconst app = express();\nconst PORT = process.env.BACKEND_PORT || 3001;\n\n// ----------------- MIDDLEWARE -----------------\n\n// CORS Configuration - MUST BE BEFORE OTHER MIDDLEWARE\napp.use(cors({\n  origin: true,\n  methods: [\"GET\", \"POST\", \"PUT\", \"DELETE\", \"PATCH\", \"OPTIONS\"],\n  allowedHeaders: [\"Content-Type\", \"Authorization\"],\n  credentials: true\n}));\n\n// Body parsing middleware - MUST BE BEFORE ROUTES\napp.use(express.json({ limit: '10mb' }));\napp.use(express.urlencoded({ extended: true, limit: '10mb' }));\n\n// Security middleware\napp.use(helmet({\n  crossOriginResourcePolicy: { policy: \"cross-origin\" }\n}));\n\n// Logging middleware (optional)\napp.use((req, res, next) => {\n  console.log(`${req.method} ${req.path} - ${new Date().toISOString()}`);\n  next();\n});\n\n// ----------------- ROUTES -----------------\napp.use('/api/auth', authRoutes);\napp.use('/api/employees', employeeRoutes);\napp.use('/api/dashboard', dashboardRoutes);\napp.use('/api/users', userRoutes);\napp.use('/api/leaves', leaveRoutes);\napp.use('/api/tasks', taskRoutes);\napp.use('/api/attendance', attendanceRoutes); // NEW: Add attendance routes\napp.use('/api/departments', departmentRoutes);\napp.use('/api/leads', leadsRoutes);\napp.use('/api/notifications', notificationRoutes);\napp.use('/api/problems', problemRoutes);\napp.use('/api/messages', messageRoutes);\napp.use('/api/bot', botRoutes);\napp.use('/api/ai', aiRoutes);\napp.use('/api/purchase', purchaseRoutes);\napp.use('/api/face-detection', faceDetectionRoutes);\napp.use('/api/payslips', payslipRoutes);\napp.use('/api/groups', groupRoutes);\n// Health check endpoint\napp.get('/api/health', (req, res) => {\n  res.status(200).json({\n    success: true,\n    message: 'Server is running',\n    timestamp: new Date().toISOString(),\n    environment: process.env.NODE_ENV || 'development'\n  });\n});\n\n// Serve static files from React app in production\nif (process.env.NODE_ENV === 'production') {\n  app.use(express.static(path.join(__dirname, '../frontend/dist')));\n  \n  // Handle React routing, return all requests to React app\n  app.get('*', (req, res) => {\n    res.sendFile(path.join(__dirname, '../frontend/dist/index.html'));\n  });\n} else {\n  // Root endpoint for development\n  app.get('/', (req, res) => {\n    res.json({\n      success: true,\n      message: 'Employee Management System API',\n      version: '1.0.0',\n      endpoints: {\n        auth: '/api/auth',\n        employees: '/api/employees',\n        dashboard: '/api/dashboard',\n        leaves: '/api/leaves',\n        tasks: '/api/tasks',\n        users: '/api/users'\n      }\n    });\n  });\n}\n\n// Global error handler (must be last)\napp.use(errorHandler);\n\n// ----------------- SERVER START -----------------\nconst startServer = async () => {\n  try {\n    // Connect to MongoDB\n    await connectDB();\n    console.log('✅ Database connected successfully');\n\n    // Create default admin if doesn't exist\n    // await createAdminIfNotExists();\n    console.log('✅ Admin user verified/created');\n\n    // Create HTTP server\n    const httpServer = createServer(app);\n\n    // Initialize Socket.IO\n    const io = new SocketIOServer(httpServer, {\n      cors: {\n        origin: true,\n        methods: ['GET', 'POST'],\n        credentials: true\n      }\n    });\n\n    // Setup chat socket handlers\n    setupChatSocket(io);\n\n    // Start the server\n    httpServer.listen(PORT, () => {\n      console.log(`🚀 Server running on port ${PORT}`);\n      console.log(`📊 Admin Panel: http://localhost:${PORT}`);\n      console.log(`🔗 Frontend URL: ${process.env.FRONTEND_URL || 'http://localhost:3000'}`);\n      console.log(`📝 Environment: ${process.env.NODE_ENV || 'development'}`);\n    });\n\n  } catch (err) {\n    console.error('❌ Server start failed:', err);\n    process.exit(1);\n  }\n};\n\n// Graceful shutdown\nsetupShutdown();\n\n// Start the server\nstartServer();\n\nexport default app;\n","path":null,"size_bytes":5527,"size_tokens":null},"frontend/src/App.jsx":{"content":"import React from 'react';\nimport { BrowserRouter as Router, Routes, Route } from 'react-router-dom';\nimport { Toaster } from 'react-hot-toast';\nimport Login from \"./pages/Common/login\";\nimport ForgotPassword from './components/Common/ForgotPassword';\nimport AdminDashboardPage from './pages/Admin/AdminDashboardPage';\nimport EmployeeManagement from './pages/Admin/EmployeeManagement';\nimport EmployeeDashboard from './pages/Employee/EmployeeDashboard';\nimport ProtectedRoute from './routes/ProtectedRoute';\nimport './App.css';\nimport AdminLeaveManagement from './pages/Admin/AdminLeaveManagement';\nimport AdminTaskManagement from './pages/Admin/AdminTaskManagement';\nimport EmployeeLeaveRequests from './pages/Employee/EmployeeLeaveRequests';\nimport EmployeeTasks from './pages/Employee/EmployeeTasks';\nimport AdminAttendance from './pages/Admin/AdminAttendance';\nimport EmployeeAttendance from './pages/Employee/EmployeeAttendance';\nimport AdminFaceRegistration from './pages/Admin/AdminFaceRegistration';\nimport ContinuousFaceRegistration from './pages/Admin/ContinuousFaceRegistration';\nimport DepartmentManagementPage from './pages/Admin/DepartmentManagement';\nimport LeadManagement from './pages/Sales/LeadManagement';\nimport ProblemStatementPage from './pages/Employee/ProblemStatementPage';\nimport SalesPage from './pages/Employee/Sales';\nimport AdminSalesDashboard from './pages/Admin/AdminSalesDashboard';\nimport PurchaseOrders from './pages/Admin/PurchaseOrders';\nimport AdminPayslips from './pages/Admin/AdminPayslips';\nimport AdminProfile from './pages/Admin/AdminProfile';\nimport AdminSettings from './pages/Admin/AdminSettings';\nimport EmployeeProfile from './pages/Employee/EmployeeProfile';\nimport EmployeeSettings from './pages/Employee/EmployeeSettings';\n\nfunction App() {\n  return (\n    <div className=\"App\">\n      <Router>\n        <Routes>\n          {/* Auth Routes */}\n          <Route path=\"/\" element={<Login />} />\n          <Route path=\"/login\" element={<Login />} />\n          <Route path=\"/forgot-password\" element={<ForgotPassword />} />\n          \n          {/* Admin Routes */}\n          <Route path=\"/admin/dashboard\" element={\n            <ProtectedRoute role=\"admin\">\n              <AdminDashboardPage />\n            </ProtectedRoute>\n          } />\n          <Route path=\"/admin/employees\" element={\n            <ProtectedRoute role=\"admin\">\n              <EmployeeManagement />\n            </ProtectedRoute>\n          } />\n          <Route path=\"/admin/attendance\" element={\n            <ProtectedRoute role=\"admin\">\n              <AdminAttendance/>\n            </ProtectedRoute>\n          } />\n          <Route path=\"/admin/leaves\" element={\n            <ProtectedRoute role=\"admin\">\n              <AdminLeaveManagement />\n            </ProtectedRoute>\n          } />\n          <Route path=\"/admin/department\" element={\n            <ProtectedRoute role=\"admin\">\n              <DepartmentManagementPage/>\n            </ProtectedRoute>\n          } />\n          <Route path=\"/admin/tasks\" element={\n            <ProtectedRoute role=\"admin\">\n              <AdminTaskManagement/>\n            </ProtectedRoute>\n          } />\n          <Route path=\"/admin/face-registration\" element={\n            <ProtectedRoute role=\"admin\">\n              <ContinuousFaceRegistration/>\n            </ProtectedRoute>\n          } />\n          <Route path=\"/admin/face-registration-legacy\" element={\n            <ProtectedRoute role=\"admin\">\n              <AdminFaceRegistration/>\n            </ProtectedRoute>\n          } />\n          <Route path=\"/admin/sales\" element={\n            <ProtectedRoute role=\"admin\">\n              <AdminSalesDashboard />\n            </ProtectedRoute>\n          } />\n          <Route path=\"/admin/purchase-orders\" element={\n            <ProtectedRoute role=\"admin\">\n              <PurchaseOrders />\n            </ProtectedRoute>\n          } />\n          <Route path=\"/admin/payslips\" element={\n            <ProtectedRoute role=\"admin\">\n              <AdminPayslips />\n            </ProtectedRoute>\n          } />\n          <Route path=\"/admin/profile\" element={\n            <ProtectedRoute role=\"admin\">\n              <AdminProfile />\n            </ProtectedRoute>\n          } />\n          <Route path=\"/admin/settings\" element={\n            <ProtectedRoute role=\"admin\">\n              <AdminSettings />\n            </ProtectedRoute>\n          } />\n          \n          {/* Employee Routes */}\n          <Route path=\"/employee/dashboard\" element={\n            <ProtectedRoute role=\"employee\">\n              <EmployeeDashboard />\n            </ProtectedRoute>\n          } />\n          <Route path=\"/employee/leaves\" element={\n            <ProtectedRoute role=\"employee\">\n              <EmployeeLeaveRequests />\n            </ProtectedRoute>\n          } />\n          <Route path=\"/employee/attendance\" element={\n            <ProtectedRoute role=\"employee\">\n              <EmployeeAttendance/>\n            </ProtectedRoute>\n          } />\n          <Route path=\"/employee/tasks\" element={\n            <ProtectedRoute role=\"employee\">\n              <EmployeeTasks />\n            </ProtectedRoute>\n          } />\n          <Route path=\"/employee/leads\" element={\n            <ProtectedRoute role=\"employee\">\n              <LeadManagement/>\n            </ProtectedRoute>\n          } />\n          <Route path=\"/employee/problems\" element={\n            <ProtectedRoute role=\"employee\">\n              <ProblemStatementPage />\n            </ProtectedRoute>\n          } />\n          <Route path=\"/employee/sales\" element={\n            <ProtectedRoute role=\"employee\">\n              <SalesPage />\n            </ProtectedRoute>\n          } />\n          <Route path=\"/employee/profile\" element={\n            <ProtectedRoute role=\"employee\">\n              <EmployeeProfile />\n            </ProtectedRoute>\n          } />\n          <Route path=\"/employee/settings\" element={\n            <ProtectedRoute role=\"employee\">\n              <EmployeeSettings />\n            </ProtectedRoute>\n          } />\n        </Routes>\n        <Toaster position=\"top-right\" />\n      </Router>\n    </div>\n  );\n}\n\nexport default App;","path":null,"size_bytes":6141,"size_tokens":null},"frontend/src/components/Admin/Dashboard/UpcomingEvents.jsx":{"content":"// components/Dashboard/UpcomingEvents.js\nimport React from 'react';\nimport { Calendar } from 'lucide-react';\n\nconst UpcomingEvents = ({ events = [], loading = false }) => {\n  const formatEventDate = (dateString) => {\n    try {\n      const date = new Date(dateString);\n      const today = new Date();\n      const tomorrow = new Date(today);\n      tomorrow.setDate(tomorrow.getDate() + 1);\n      \n      const isToday = date.toDateString() === today.toDateString();\n      const isTomorrow = date.toDateString() === tomorrow.toDateString();\n      \n      if (isToday) return 'Today';\n      if (isTomorrow) return 'Tomorrow';\n      \n      return date.toLocaleDateString('en-US', { \n        month: 'short', \n        day: 'numeric' \n      });\n    } catch (error) {\n      return dateString || 'Unknown date';\n    }\n  };\n\n  const getDepartmentColor = (department) => {\n    const colors = {\n      'HR': 'bg-pink-500/20 text-pink-400',\n      'IT': 'bg-blue-500/20 text-blue-400',\n      'Finance': 'bg-green-500/20 text-green-400',\n      'Marketing': 'bg-purple-500/20 text-purple-400',\n      'Operations': 'bg-orange-500/20 text-orange-400',\n      'Sales': 'bg-yellow-500/20 text-yellow-400'\n    };\n    return colors[department] || 'bg-gray-500/20 text-gray-400';\n  };\n\n  const isEventSoon = (dateString, timeString) => {\n    try {\n      const eventDate = new Date(`${dateString} ${timeString}`);\n      const now = new Date();\n      const diffInHours = (eventDate - now) / (1000 * 60 * 60);\n      return diffInHours <= 24 && diffInHours > 0;\n    } catch (error) {\n      return false;\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h2 className=\"text-xl font-bold text-white\">Upcoming Events</h2>\n          <Calendar className=\"w-5 h-5 text-neon-purple animate-pulse\" />\n        </div>\n        <div className=\"space-y-4\">\n          {[1, 2, 3].map((i) => (\n            <div key={i} className=\"animate-pulse\">\n              <div className=\"p-4 rounded-lg border border-secondary-600\">\n                <div className=\"flex items-center justify-between mb-2\">\n                  <div className=\"h-4 bg-gray-600 rounded w-3/4\"></div>\n                  <div className=\"h-6 bg-gray-700 rounded-full w-16\"></div>\n                </div>\n                <div className=\"flex items-center space-x-4 text-sm\">\n                  <div className=\"h-3 bg-gray-700 rounded w-20\"></div>\n                  <div className=\"h-3 bg-gray-700 rounded w-16\"></div>\n                </div>\n              </div>\n            </div>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"glass-morphism neon-border rounded-2xl p-6\">\n      <div className=\"flex items-center justify-between mb-6\">\n        <h2 className=\"text-xl font-bold text-white\">Upcoming Events</h2>\n        <Calendar className=\"w-5 h-5 text-neon-purple\" />\n      </div>\n      <div className=\"space-y-4 max-h-80 overflow-y-auto scrollbar-thin scrollbar-thumb-gray-600\">\n        {events.length > 0 ? (\n          events.map((event, index) => (\n            <div \n              key={event.id || index} \n              className={`p-4 rounded-lg border transition-all duration-200 cursor-pointer group ${\n                isEventSoon(event.date, event.time)\n                  ? 'border-neon-pink/50 bg-neon-pink/5 hover:border-neon-pink'\n                  : 'border-secondary-600 hover:border-neon-purple/30 hover:bg-secondary-700/30'\n              }`}\n            >\n              <div className=\"flex items-center justify-between mb-2\">\n                <h4 className=\"text-white font-medium group-hover:text-neon-purple transition-colors truncate flex-1\">\n                  {event.title}\n                </h4>\n                {event.department && (\n                  <span className={`text-xs px-2 py-1 rounded-full ml-2 flex-shrink-0 ${getDepartmentColor(event.department)}`}>\n                    {event.department}\n                  </span>\n                )}\n              </div>\n              <div className=\"flex items-center justify-between text-sm text-secondary-400\">\n                <div className=\"flex items-center space-x-4\">\n                  <span className=\"flex items-center\">\n                    <Calendar className=\"w-3 h-3 mr-1\" />\n                    {formatEventDate(event.date)}\n                  </span>\n                  {event.time && (\n                    <span className=\"flex items-center\">\n                      🕐 {event.time}\n                    </span>\n                  )}\n                </div>\n                {isEventSoon(event.date, event.time) && (\n                  <span className=\"text-xs px-2 py-1 bg-neon-pink/20 text-neon-pink rounded-full animate-pulse\">\n                    Soon\n                  </span>\n                )}\n              </div>\n              {event.description && (\n                <p className=\"text-secondary-400 text-xs mt-2 line-clamp-2\">\n                  {event.description}\n                </p>\n              )}\n            </div>\n          ))\n        ) : (\n          <div className=\"text-center py-12\">\n            <Calendar className=\"w-12 h-12 text-secondary-500 mx-auto mb-4\" />\n            <p className=\"text-secondary-400 text-lg\">No upcoming events</p>\n            <p className=\"text-secondary-500 text-sm mt-2\">Events will be displayed here when scheduled</p>\n          </div>\n        )}\n      </div>\n    </div>\n  )\n}\n\nexport default UpcomingEvents;","path":null,"size_bytes":5518,"size_tokens":null},"frontend/src/components/Admin/Siderbar/Sidebar.jsx":{"content":"import React from \"react\";\nimport { Link, useLocation } from \"react-router-dom\";\nimport { Building2, LayoutDashboard, Users, Calendar, Clock, FileText, Settings, X, DollarSign, CreditCard } from \"lucide-react\";\n\nconst Sidebar = ({ sidebarOpen, setSidebarOpen }) => {\n  const location = useLocation();\n\n  const sidebarItems = [\n    { name: \"Dashboard\", icon: LayoutDashboard, path: \"/admin/dashboard\" },\n    { name: \"Employee Management\", icon: Users, path: \"/admin/employees\" },\n    { name: \"Leave Management\", icon: Calendar, path: \"/admin/leaves\" },\n            { name: \"Attendance\",icon:Clock, path: \"/admin/attendance\" },\n                        { name: \"Department\",icon:FileText, path: \"/admin/department\" },\n \n\n        { name: \"Task Management\", icon: Calendar, path: \"/admin/tasks\" },\n        { name: \"Sales\", icon: DollarSign, path: \"/admin/sales\" },\n        { name: \"Purchase Orders\", icon: FileText, path: \"/admin/purchase-orders\" },\n        { name: \"Payslips\", icon: CreditCard, path: \"/admin/payslips\" },\n\n    // { name: \"Reports\", icon: FileText, path: \"/admin/reports\" },\n    // { name: \"Settings\", icon: Settings, path: \"/admin/settings\" },\n  ];\n\n  return (\n    <div\n      className={`fixed inset-y-0 left-0 z-50 w-64 transform ${\n        sidebarOpen ? \"translate-x-0\" : \"-translate-x-full\"\n      } transition-transform duration-300 ease-in-out lg:translate-x-0`}\n    >\n      <div className=\"glass-morphism h-full border-r border-secondary-700\">\n        {/* Logo */}\n        <div className=\"flex items-center justify-between h-16 px-6 border-b border-secondary-700\">\n          <div className=\"flex items-center space-x-3\">\n            {/* Logo Container - Fixed aspect ratio */}\n            <div className=\"w-12 h-12 rounded-lg overflow-hidden flex items-center justify-center bg-gradient-to-br from-neon-pink/10 to-neon-purple/10 border border-neon-pink/20 flex-shrink-0\">\n              <img\n                src=\"/src/assets/logo.jpg\"\n                alt=\"Taruna Technology Logo\"\n                className=\"w-full h-full object-contain p-1\"\n              />\n            </div>\n\n            {/* Text Container */}\n            <div className=\"flex flex-col justify-center min-w-0\">\n              <h1 className=\"text-base font-bold text-white leading-tight tracking-wide\">\n                Taruna Technology\n              </h1>\n              <p className=\"text-xs text-secondary-400 leading-tight mt-0.5\">\n                Admin Panel\n              </p>\n            </div>\n          </div>\n\n          {/* Close button for mobile */}\n          <button\n            onClick={() => setSidebarOpen(false)}\n            className=\"lg:hidden text-secondary-400 hover:text-white transition-colors flex-shrink-0\"\n            aria-label=\"Close sidebar\"\n          >\n            <X className=\"w-5 h-5\" />\n          </button>\n        </div>\n\n        {/* Navigation */}\n        <nav className=\"mt-8 px-4\">\n          <div className=\"space-y-2\">\n            {sidebarItems.map((item) => {\n              const isActive = location.pathname === item.path;\n              return (\n                <Link\n                  key={item.name}\n                  to={item.path}\n                  className={`flex items-center space-x-3 px-4 py-3 rounded-lg transition-all duration-300 ${\n                    isActive\n                      ? \"bg-gradient-to-r from-neon-pink/20 to-neon-purple/20 border border-neon-pink/30 text-white\"\n                      : \"text-secondary-400 hover:text-white hover:bg-secondary-700/50\"\n                  }`}\n                >\n                  <item.icon\n                    className={`w-5 h-5 ${isActive ? \"text-neon-pink\" : \"\"}`}\n                  />\n                  <span className=\"font-medium\">{item.name}</span>\n                </Link>\n              );\n            })}\n          </div>\n        </nav>\n      </div>\n    </div>\n  );\n};\n\nexport default Sidebar;\n","path":null,"size_bytes":3884,"size_tokens":null},"frontend/src/utils/errorHandler.js":{"content":"export const handleApiError = (error) => {\n  if (error.response) {\n    // Server responded with error status\n    const { status, data } = error.response;\n    \n    switch (status) {\n      case 400:\n        return data.message || 'Bad request';\n      case 401:\n        return 'Unauthorized. Please login again.';\n      case 403:\n        return 'Access denied. Insufficient permissions.';\n      case 404:\n        return 'Resource not found';\n      case 422:\n        return data.errors ? data.errors.map(err => err.msg).join(', ') : 'Validation error';\n      case 500:\n        return 'Server error. Please try again later.';\n      default:\n        return data.message || 'An unexpected error occurred';\n    }\n  } else if (error.request) {\n    // Request made but no response received\n    return 'Network error. Please check your connection.';\n  } else {\n    // Something else happened\n    return error.message || 'An unexpected error occurred';\n  }\n};","path":null,"size_bytes":947,"size_tokens":null},"frontend/src/components/Admin/main/AdminChatbot.jsx":{"content":"import React, { useState, useRef, useEffect } from 'react';\nimport { X, Send, Bot, User } from 'lucide-react';\nimport { employeeAPI, departmentAPI, attendanceAPI, dashboardAPI, aiAPI, botAPI } from '../../../utils/api';\nimport { taskService } from '../../../services/taskService';\n\nconst AdminChatbot = ({ isOpen, onClose, isAdmin }) => {\n  const [messages, setMessages] = useState([\n    {\n      id: 1,\n      type: 'bot',\n      content: 'Hello! I\\'m your AI assistant for HR operations. How can I help you today?',\n      timestamp: new Date()\n    },\n    // {\n    //   id: 2,\n    //   type: 'alert',\n    //   content: '⚠️ 3 employees have birthdays this week — send greeting?',\n    //   timestamp: new Date()\n    // },\n    // {\n    //   id: 3,\n    //   type: 'alert',\n    //   content: '🚨 2 employees didn\\'t clock in today — notify their managers?',\n    //   timestamp: new Date()\n    // }\n  ]);\n  const [inputValue, setInputValue] = useState('');\n  const [isTyping, setIsTyping] = useState(false);\n  const messagesEndRef = useRef(null);\n\n  const scrollToBottom = () => {\n    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });\n  };\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages]);\n\n  // Fetch employees and departments dynamically for accurate matching\n  const [employees, setEmployees] = useState([]);\n  const [departments, setDepartments] = useState([]);\n\n  useEffect(() => {\n    const fetchData = async () => {\n      try {\n        // Fetch employees\n        const empRes = await employeeAPI.getEmployees();\n        const emps = empRes.data.data?.employees || empRes.data.employees || empRes.data || [];\n        setEmployees(emps);\n\n        // Fetch departments\n        const deptRes = await departmentAPI.getDepartments();\n        const depts = deptRes.data.data || deptRes.data.departments || [];\n        setDepartments(depts);\n      } catch (error) {\n        console.error('Failed to fetch data:', error);\n      }\n    };\n    fetchData();\n  }, []);\n\n  const mockLeaveRequests = [\n    { id: 4567, employee: 'Alex', status: 'Pending', reason: 'Vacation' }\n  ];\n\n  const mockTasks = [\n    { id: 1, title: 'Update website', assignedTo: 'Alex', status: 'In Progress', project: 'Phoenix', dueDate: '2024-02-15' },\n    { id: 2, title: 'Fix bug', assignedTo: 'Priya', status: 'Overdue', project: 'Phoenix', dueDate: '2024-01-30' }\n  ];\n\n  const parseCommand = async (input) => {\n    const lowerInput = input.toLowerCase();\n\n    try {\n      if (lowerInput === 'hello') {\n        return 'hello how can i help you?';\n      }\n\n      // Handle specific creation commands first (before general employee queries)\n      if (lowerInput.includes('add employee') || lowerInput.includes('create employee')) {\n        // Parse employee details from input - more comprehensive parsing\n        // Fix regex to handle trailing quotes and spaces properly\n        const employeeMatch = input.match(/add employee (.+?)(?: position (.+?))?(?: department (.+?))?(?: email (.+?))?(?: phone (.+?))?(?: salary (\\d+))?(?: gender (male|female|other))?(?: date of birth (.+?))?(?: emergency contact (.+?) relationship (.+?) phone (.+?))?[\"']?$/i);\n\n        if (employeeMatch) {\n          const name = employeeMatch[1].trim().replace(/[\"']$/, '');\n          const position = employeeMatch[2]?.trim().replace(/[\"']$/, '') || 'Employee';\n          const departmentName = employeeMatch[3]?.trim().replace(/[\"']$/, '');\n          const email = employeeMatch[4]?.trim().replace(/[\"']$/, '');\n          const phone = employeeMatch[5]?.trim().replace(/[\"']$/, '') || '1234567890';\n          const salaryStr = employeeMatch[6]?.trim().replace(/[\"']$/, '');\n          const gender = employeeMatch[7]?.trim().replace(/[\"']$/, '') || 'Male';\n          const dateOfBirth = employeeMatch[8]?.trim().replace(/[\"']$/, '') || '1990-01-01';\n          const emergencyName = employeeMatch[9]?.trim().replace(/[\"']$/, '') || 'Emergency Contact';\n          const emergencyRelationship = employeeMatch[10]?.trim().replace(/[\"']$/, '') || 'Family';\n          const emergencyPhone = employeeMatch[11]?.trim().replace(/[\"']$/, '') || '1234567890';\n\n          // Validate required fields\n          if (!name || !email) {\n            return 'Please specify employee name and email. Example: \"add employee John Doe position Developer department Engineering email john@example.com phone 1234567890 salary 50000\"';\n          }\n\n          // Parse name\n          const nameParts = name.split(' ');\n          const firstName = nameParts[0];\n          const lastName = nameParts.slice(1).join(' ') || 'Doe';\n\n          // Find department by name\n          let departmentId = null;\n          if (departmentName) {\n            const normalizedDeptName = departmentName.toLowerCase().replace(/\\s+/g, '');\n            const department = departments.find(dept => {\n              const deptName = dept.name?.toLowerCase().replace(/\\s+/g, '') || '';\n              const deptCode = dept.code?.toLowerCase() || '';\n              return deptName.includes(normalizedDeptName) || deptCode.includes(normalizedDeptName);\n            });\n            if (!department) {\n              return `Department \"${departmentName}\" not found. Please provide a valid department name.`;\n            }\n            departmentId = department._id || department.id;\n          } else {\n            return 'Please specify a department for the employee.';\n          }\n\n          // Parse salary\n          const basicSalary = salaryStr ? parseFloat(salaryStr) : 30000;\n\n          // Construct employee data\n          const employeeData = {\n            personalInfo: {\n              firstName,\n              lastName,\n              dateOfBirth,\n              gender: gender.charAt(0).toUpperCase() + gender.slice(1).toLowerCase()\n            },\n            contactInfo: {\n              personalEmail: email.toLowerCase(),\n              phone,\n              emergencyContact: {\n                name: emergencyName,\n                relationship: emergencyRelationship,\n                phone: emergencyPhone\n              }\n            },\n            workInfo: {\n              position,\n              department: departmentId,\n              joiningDate: new Date().toISOString().split('T')[0]\n            },\n            salaryInfo: {\n              basicSalary,\n              currency: 'INR',\n              payFrequency: 'Monthly'\n            }\n          };\n\n          try {\n            await employeeAPI.createEmployee(employeeData);\n            return `Employee ${firstName} ${lastName} has been created successfully with email ${email} and added to ${departmentName} department.`;\n          } catch (error) {\n            console.error('Error creating employee:', error);\n            return 'Failed to create employee. Please try again.';\n          }\n        } else {\n          return 'Please specify employee details. Example: \"add employee John Doe position Developer department Engineering email john@example.com phone 1234567890 salary 50000\"';\n        }\n      }\n\n      if (lowerInput.includes('add new task') || lowerInput.includes('create task')) {\n        // Parse task details from input\n        const titleMatch = input.match(/add new task (.+?)(?: assigned to (.+?))?(?: for project (.+?))?(?: due (.+?))?(?: priority (.+?))?(?: category (.+?))?(?: estimated hours (.+?))?$/i);\n        if (titleMatch) {\n          const title = titleMatch[1].trim();\n          const assignedToName = titleMatch[2]?.trim();\n          const project = titleMatch[3]?.trim();\n          const dueDate = titleMatch[4]?.trim();\n          const priority = titleMatch[5]?.trim() || 'Medium';\n          const category = titleMatch[6]?.trim() || 'General';\n          const estimatedHoursStr = titleMatch[7]?.trim();\n          const estimatedHours = estimatedHoursStr ? parseFloat(estimatedHoursStr) : 0;\n\n          // Validate required fields\n          if (!title || !assignedToName) {\n            return 'Please specify at least the task title and assigned employee name.';\n          }\n\n          // Find employee ID by name from mockEmployees or API (using mock here)\n          // Try to find employee by name or by ID (id as string)\n          // Normalize assignedToName for matching\n          const normalizedAssignedTo = assignedToName.toLowerCase().replace(/\\s+/g, '');\n          const employee = employees.find(emp => {\n            const empName = emp.fullName || emp.personalInfo?.firstName + ' ' + emp.personalInfo?.lastName || emp.name || '';\n            const normalizedEmpName = empName.toLowerCase().replace(/\\s+/g, ' ');\n            const empId = emp.employeeId || emp.id || '';\n            return normalizedEmpName.includes(normalizedAssignedTo) || empId.toString().toLowerCase() === normalizedAssignedTo;\n          });\n          if (!employee) {\n            return `Employee \"${assignedToName}\" not found. Please provide a valid employee name or ID.`;\n          }\n\n          // Validate priority\n          const validPriorities = ['Low', 'Medium', 'High', 'Critical'];\n          if (!validPriorities.includes(priority)) {\n            return `Priority must be one of: ${validPriorities.join(', ')}`;\n          }\n\n          // Validate estimated hours\n          if (isNaN(estimatedHours) || estimatedHours < 0 || estimatedHours > 1000) {\n            return 'Estimated hours must be a number between 0 and 1000.';\n          }\n\n          // Construct task object with required fields\n          const taskData = {\n            title,\n            description: title, // Using title as description for now\n            assignedTo: employee.id,\n            project,\n            dueDate,\n            priority,\n            category,\n            estimatedHours\n          };\n\n          try {\n            await taskService.createTask(taskData);\n            return `New task \"${title}\" has been created successfully.`;\n          } catch (error) {\n            console.error('Error creating task:', error);\n            return 'Failed to create task. Please try again.';\n          }\n        } else {\n          return 'Please specify task details. Example: \"add new task Update website assigned to Alex for project Phoenix due 2024-02-15 priority High category Development estimated hours 10\"';\n        }\n      }\n\n      if (lowerInput.includes('add new department') || lowerInput.includes('create department')) {\n        // Parse department details from input\n        const deptMatch = input.match(/add new department (.+?)(?: with manager (.+?))?(?: description (.+?))?$/i);\n        if (deptMatch) {\n          const name = deptMatch[1].trim();\n          const managerName = deptMatch[2]?.trim();\n          const description = deptMatch[3]?.trim() || name; // Use name as description if not provided\n\n          // Validate required fields\n          if (!name) {\n            return 'Please specify the department name.';\n          }\n\n          // Find manager by name if provided\n          let managerId = null;\n          if (managerName) {\n            const normalizedManagerName = managerName.toLowerCase().replace(/\\s+/g, '');\n            const manager = employees.find(emp => {\n              const empName = emp.fullName || emp.personalInfo?.firstName + ' ' + emp.personalInfo?.lastName || emp.name || '';\n              const normalizedEmpName = empName.toLowerCase().replace(/\\s+/g, '');\n              const empId = emp.employeeId || emp.id || '';\n              return normalizedEmpName.includes(normalizedManagerName) || empId.toString().toLowerCase() === normalizedManagerName;\n            });\n            if (!manager) {\n              return `Manager \"${managerName}\" not found. Please provide a valid employee name or ID.`;\n            }\n            managerId = manager.id;\n          }\n\n          // Generate department code from name (e.g., first 3 letters uppercase)\n          const generateCode = (deptName) => {\n            return deptName\n              .split(' ')\n              .map(word => word[0])\n              .join('')\n              .toUpperCase()\n              .slice(0, 3);\n          };\n\n          const code = generateCode(name);\n\n          // Construct department object\n          const departmentData = {\n            name,\n            code,\n            description,\n            manager: managerId\n          };\n\n          try {\n            await departmentAPI.createDepartment(departmentData);\n            return `New department \"${name}\" has been created successfully.`;\n          } catch (error) {\n            console.error('Error creating department:', error);\n            return 'Failed to create department. Please try again.';\n          }\n        } else {\n          return 'Please specify department details. Example: \"add new department Marketing with manager John Doe description Sales and marketing department\"';\n        }\n      }\n\n      // Employee Management\n      if (lowerInput.includes('all employees') || lowerInput.includes('show me all employees') || lowerInput.includes('i want employee data') || lowerInput.includes('employee data')) {\n        const res = await employeeAPI.getEmployees();\n        const employees = res.data.data?.employees || res.data.employees || res.data || [];\n        const employeeList = employees.map(emp => `${emp.fullName || emp.personalInfo?.firstName + ' ' + emp.personalInfo?.lastName || emp.name} (${emp.workInfo?.department?.name || emp.workInfo?.department || emp.department || 'N/A'})`).join(', ');\n        return `Here are all employees: ${employeeList || 'No employees found.'}`;\n      }\n\n      if (lowerInput.includes('face registration') || lowerInput.includes('biometric')) {\n        const res = await employeeAPI.getEmployees();\n        const employees = res.data.data?.employees || res.data.employees || res.data || [];\n        const registeredEmployees = employees.filter(emp => emp.hasFaceRegistered || emp.faceRegistered);\n        const count = registeredEmployees.length;\n        const remainingEmployees = employees.filter(emp => !(emp.hasFaceRegistered || emp.faceRegistered));\n        const remainingNames = remainingEmployees.map(emp => emp.fullName || emp.personalInfo?.firstName + ' ' + emp.personalInfo?.lastName || emp.name).join(', ') || 'None';\n        return `${count} employees have face registration enabled. Remaining employees without face registration: ${remainingNames}`;\n      }\n\n      if (lowerInput.includes('contact info') || lowerInput.includes('contact information') || lowerInput.includes('employee')) {\n        // Try to extract full name or first name from input\n        const nameMatch = input.match(/(?:employee|for|named|called)?\\s*([A-Z][a-z]+(?:\\s[A-Z][a-z]+)?)/i);\n        const employeeName = nameMatch ? nameMatch[1] : null;\n        if (employeeName) {\n          const res = await employeeAPI.getEmployees();\n          const employees = res.data.data?.employees || res.data.employees || res.data || [];\n          // Try to find employee by full name or partial name case insensitive\n          const employee = employees.find(emp => {\n            const fullName = emp.fullName || (emp.personalInfo?.firstName + ' ' + emp.personalInfo?.lastName) || emp.name || '';\n            return fullName.toLowerCase().includes(employeeName.toLowerCase());\n          });\n          if (employee) {\n            const email = employee.contactInfo?.personalEmail || employee.user?.email || employee.email || 'N/A';\n            const phone = employee.contactInfo?.personalPhone || employee.phone || 'N/A';\n            return `Contact info for ${employee.fullName || employeeName}: Email: ${email}, Phone: ${phone}`;\n          }\n          return `No employee found matching name \"${employeeName}\".`;\n        }\n        return 'Please specify the employee name.';\n      }\n\n      if (lowerInput.includes('update') && lowerInput.includes('department')) {\n        return 'Update confirmed. Employee department has been updated to Marketing. (Note: This would require confirmation in a real implementation)';\n      }\n\n      // Leave & Attendance\n      if (lowerInput.includes('approve leave')) {\n        const requestId = input.match(/#(\\d+)/)?.[1];\n        if (requestId) {\n          return `Leave request #${requestId} has been approved.`;\n        }\n      }\n\n      if (lowerInput.includes('on leave today')) {\n        return 'No employees are currently on leave today.';\n      }\n\n      if (lowerInput.includes('leave status')) {\n        const employeeName = input.match(/for (\\w+)/i)?.[1];\n        if (employeeName) {\n          return `${employeeName}'s leave status: Approved`;\n        }\n      }\n\n      if (lowerInput.includes('attendance record')) {\n        const employeeName = input.match(/for (\\w+)/i)?.[1];\n        if (employeeName) {\n          const res = await attendanceAPI.getAllAttendance({ employeeName });\n          const records = res.data.data || res.data.attendance || [];\n          const summary = records.length > 0 ? `${records.length} attendance records found.` : 'No attendance records found.';\n          return `${employeeName}'s attendance: ${summary}`;\n        }\n      }\n\n      // Department & Team\n      if (lowerInput.includes('managers under')) {\n        const department = input.match(/under (\\w+)/i)?.[1];\n        if (department) {\n          const res = await departmentAPI.getDepartments();\n          const depts = res.data.data || res.data.departments || [];\n          const dept = depts.find(d => d.name.toLowerCase().includes(department.toLowerCase()));\n          if (dept) {\n            return `Manager for ${dept.name}: ${dept.manager || 'Not assigned'}`;\n          }\n        }\n        return `No department found with name containing \"${department}\".`;\n      }\n\n      if (lowerInput.includes('all managers')) {\n        const res = await departmentAPI.getDepartments();\n        const depts = res.data.data || res.data.departments || [];\n        const managers = depts.map(dept => `${dept.manager || 'Unassigned'} (${dept.name})`).join(', ');\n        return `All managers: ${managers || 'No managers found.'}`;\n      }\n\n      if (lowerInput.includes('list all departments') || lowerInput.includes('departments')) {\n        const res = await departmentAPI.getDepartments();\n        const depts = res.data.data || res.data.departments || [];\n        const deptList = depts.map(dept => `${dept.name} (${dept.employeeCount || 0} employees, Manager: ${dept.manager || 'Unassigned'})`).join(', ');\n        return `Departments: ${deptList || 'No departments found.'}`;\n      }\n\n      // Task & Project\n      if (lowerInput.includes('all tasks') || lowerInput.includes('show me all tasks')) {\n        const res = await taskService.getTasks();\n        const tasks = res.tasks || [];\n        const taskList = tasks.map(task => `${task.title} (${task.status})`).join(', ');\n        return `All tasks: ${taskList || 'No tasks found.'}`;\n      }\n\n      if (lowerInput.includes('tasks assigned to')) {\n        const employeeName = input.match(/to (\\w+)/i)?.[1];\n        if (employeeName) {\n          const res = await taskService.getTasks();\n          const tasks = res.tasks || [];\n          const assignedTasks = tasks.filter(task => task.assignedTo?.toLowerCase().includes(employeeName.toLowerCase()));\n          const taskList = assignedTasks.map(task => task.title).join(', ');\n          return `Tasks assigned to ${employeeName}: ${taskList || 'No tasks assigned.'}`;\n        }\n      }\n\n      if (lowerInput.includes('tasks for project')) {\n        const project = input.match(/project (\\w+)/i)?.[1];\n        if (project) {\n          const res = await taskService.getTasks();\n          const tasks = res.tasks || [];\n          const projectTasks = tasks.filter(task => task.project?.toLowerCase().includes(project.toLowerCase()));\n          const taskDetails = projectTasks.map(task => `${task.title} - Status: ${task.status}, Due: ${task.dueDate || 'N/A'}`).join('; ');\n          return `Tasks for Project ${project}: ${taskDetails || 'No tasks found for this project.'}`;\n        }\n      }\n\n      if (lowerInput.includes('overdue')) {\n        const res = await taskService.getTasks();\n        const tasks = res.tasks || [];\n        const overdueCount = tasks.filter(task => task.status === 'Overdue').length;\n        return `${overdueCount} tasks are overdue.`;\n      }\n\n      if (lowerInput.includes('add new task') || lowerInput.includes('create task')) {\n        // Parse task details from input\n        const titleMatch = input.match(/add new task (.+?)(?: assigned to (.+?))?(?: for project (.+?))?(?: due (.+?))?(?: priority (.+?))?(?: category (.+?))?(?: estimated hours (.+?))?$/i);\n        if (titleMatch) {\n          const title = titleMatch[1].trim();\n          const assignedToName = titleMatch[2]?.trim();\n          const project = titleMatch[3]?.trim();\n          const dueDate = titleMatch[4]?.trim();\n          const priority = titleMatch[5]?.trim() || 'Medium';\n          const category = titleMatch[6]?.trim() || 'General';\n          const estimatedHoursStr = titleMatch[7]?.trim();\n          const estimatedHours = estimatedHoursStr ? parseFloat(estimatedHoursStr) : 0;\n\n          // Validate required fields\n          if (!title || !assignedToName) {\n            return 'Please specify at least the task title and assigned employee name.';\n          }\n\n          // Find employee ID by name from mockEmployees or API (using mock here)\n          // Try to find employee by name or by ID (id as string)\n          // Normalize assignedToName for matching\n          const normalizedAssignedTo = assignedToName.toLowerCase().replace(/\\s+/g, '');\n          const employee = employees.find(emp => {\n            const empName = emp.fullName || emp.personalInfo?.firstName + ' ' + emp.personalInfo?.lastName || emp.name || '';\n            const normalizedEmpName = empName.toLowerCase().replace(/\\s+/g, ' ');\n            const empId = emp.employeeId || emp.id || '';\n            return normalizedEmpName.includes(normalizedAssignedTo) || empId.toString().toLowerCase() === normalizedAssignedTo;\n          });\n          if (!employee) {\n            return `Employee \"${assignedToName}\" not found. Please provide a valid employee name or ID.`;\n          }\n\n          // Validate priority\n          const validPriorities = ['Low', 'Medium', 'High', 'Critical'];\n          if (!validPriorities.includes(priority)) {\n            return `Priority must be one of: ${validPriorities.join(', ')}`;\n          }\n\n          // Validate estimated hours\n          if (isNaN(estimatedHours) || estimatedHours < 0 || estimatedHours > 1000) {\n            return 'Estimated hours must be a number between 0 and 1000.';\n          }\n\n          // Construct task object with required fields\n          const taskData = {\n            title,\n            description: title, // Using title as description for now\n            assignedTo: employee.id,\n            project,\n            dueDate,\n            priority,\n            category,\n            estimatedHours\n          };\n\n          try {\n            await taskService.createTask(taskData);\n            return `New task \"${title}\" has been created successfully.`;\n          } catch (error) {\n            console.error('Error creating task:', error);\n            return 'Failed to create task. Please try again.';\n          }\n        } else {\n          return 'Please specify task details. Example: \"add new task Update website assigned to Alex for project Phoenix due 2024-02-15 priority High category Development estimated hours 10\"';\n        }\n      }\n\n      if (lowerInput.includes('add new department') || lowerInput.includes('create department')) {\n        // Parse department details from input\n        const deptMatch = input.match(/add new department (.+?)(?: with manager (.+?))?(?: description (.+?))?$/i);\n        if (deptMatch) {\n          const name = deptMatch[1].trim();\n          const managerName = deptMatch[2]?.trim();\n          const description = deptMatch[3]?.trim() || name; // Use name as description if not provided\n\n          // Validate required fields\n          if (!name) {\n            return 'Please specify the department name.';\n          }\n\n          // Find manager by name if provided\n          let managerId = null;\n          if (managerName) {\n            const normalizedManagerName = managerName.toLowerCase().replace(/\\s+/g, '');\n            const manager = employees.find(emp => {\n              const empName = emp.fullName || emp.personalInfo?.firstName + ' ' + emp.personalInfo?.lastName || emp.name || '';\n              const normalizedEmpName = empName.toLowerCase().replace(/\\s+/g, '');\n              const empId = emp.employeeId || emp.id || '';\n              return normalizedEmpName.includes(normalizedManagerName) || empId.toString().toLowerCase() === normalizedManagerName;\n            });\n            if (!manager) {\n              return `Manager \"${managerName}\" not found. Please provide a valid employee name or ID.`;\n            }\n            managerId = manager.id;\n          }\n\n          // Generate department code from name (e.g., first 3 letters uppercase)\n          const generateCode = (deptName) => {\n            return deptName\n              .split(' ')\n              .map(word => word[0])\n              .join('')\n              .toUpperCase()\n              .slice(0, 3);\n          };\n\n          const code = generateCode(name);\n\n          // Construct department object\n          const departmentData = {\n            name,\n            code,\n            description,\n            manager: managerId\n          };\n\n          try {\n            await departmentAPI.createDepartment(departmentData);\n            return `New department \"${name}\" has been created successfully.`;\n          } catch (error) {\n            console.error('Error creating department:', error);\n            return 'Failed to create department. Please try again.';\n          }\n        } else {\n          return 'Please specify department details. Example: \"add new department Marketing with manager John Doe description Sales and marketing department\"';\n        }\n      }\n\n      // System Insights\n      if (lowerInput.includes('total employees') || lowerInput.includes('how many total')) {\n        const res = await dashboardAPI.getAdminStats();\n        const total = res.data.totalEmployees || 0;\n        return `Total employees: ${total}`;\n      }\n\n      if (lowerInput.includes('active vs inactive')) {\n        const res = await dashboardAPI.getAdminStats();\n        const active = res.data.activeEmployees || 0;\n        const inactive = res.data.inactiveEmployees || 0;\n        return `Active users: ${active}, Inactive users: ${inactive}`;\n      }\n\n      if (lowerInput.includes('last backup')) {\n        return 'Last backup: 2024-01-15 02:00 AM';\n      }\n\n      if (lowerInput.includes('recent admin actions') || lowerInput.includes('audit log')) {\n        return 'Recent admin actions: User login (2 hours ago), Employee update (4 hours ago), Leave approval (1 day ago)';\n      }\n\n      return \"I'm sorry, I didn't understand that command. Try asking about employees, leave requests, tasks, or departments.\";\n    } catch (error) {\n      console.error('Error parsing command:', error);\n      return 'Sorry, I encountered an error while processing your request. Please try again.';\n    }\n  };\n\n  // Hybrid approach: Handle specific commands with structured logic, use AI for general questions\n  const parseCommandWithAI = async (input) => {\n    const lowerInput = input.toLowerCase();\n\n    // Handle specific structured commands that require API calls with parameters\n    if (lowerInput.includes('add new task') || lowerInput.includes('create task') ||\n        lowerInput.includes('add employee') || lowerInput.includes('create employee') ||\n        lowerInput.includes('add department') || lowerInput.includes('create department')) {\n      return await parseCommand(input);\n    }\n\n    // For general questions and natural language, use AI HR Bot with all employee context\n    try {\n      const botRes = await botAPI.sendAdminMessage(input);\n      if (botRes.data && botRes.data.success && botRes.data.response) {\n        return botRes.data.response;\n      }\n      return \"Sorry, I couldn't get a response from the AI assistant.\";\n    } catch (botError) {\n      console.error('Admin bot error:', botError);\n      // Fallback to structured parsing if bot fails\n      const fallbackResponse = await parseCommand(input);\n      if (fallbackResponse && !fallbackResponse.startsWith(\"I'm sorry\")) {\n        return fallbackResponse;\n      }\n      return \"Sorry, I couldn't process your request. Please try again.\";\n    }\n  };\n\n  const handleSendMessage = async () => {\n    if (!inputValue.trim()) return;\n\n    const userMessage = {\n      id: messages.length + 1,\n      type: 'user',\n      content: inputValue,\n      timestamp: new Date()\n    };\n\n    setMessages(prev => [...prev, userMessage]);\n    const currentInput = inputValue;\n    setInputValue('');\n    setIsTyping(true);\n\n    try {\n      const botContent = await parseCommandWithAI(currentInput);\n      const botResponse = {\n        id: messages.length + 2,\n        type: 'bot',\n        content: botContent,\n        timestamp: new Date()\n      };\n\n      setMessages(prev => [...prev, botResponse]);\n    } catch (error) {\n      console.error('Error in handleSendMessage:', error);\n      const errorResponse = {\n        id: messages.length + 2,\n        type: 'bot',\n        content: 'Sorry, I encountered an error. Please try again.',\n        timestamp: new Date()\n      };\n      setMessages(prev => [...prev, errorResponse]);\n    } finally {\n      setIsTyping(false);\n    }\n  };\n\n  const handleKeyPress = (e) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault();\n      handleSendMessage();\n    }\n  };\n\n  if (!isOpen || !isAdmin) return null;\n\n  return (\n    <div className=\"fixed inset-0 bg-black/50 flex items-end justify-end p-4 z-50\">\n      <div className=\"bg-gray-900 border border-gray-700 rounded-lg shadow-xl w-full max-w-md h-96 flex flex-col\">\n        {/* Header */}\n        <div className=\"flex items-center justify-between p-4 border-b border-gray-700\">\n          <div className=\"flex items-center space-x-2\">\n            <Bot className=\"text-neon-purple\" size={20} />\n            <span className=\"text-white font-semibold\">AI HR Assistant</span>\n          </div>\n          <button\n            onClick={onClose}\n            className=\"text-gray-400 hover:text-white transition-colors\"\n          >\n            <X size={20} />\n          </button>\n        </div>\n\n        {/* Messages */}\n        <div className=\"flex-1 overflow-y-auto p-4 space-y-4\">\n          {messages.map((message) => (\n            <div\n              key={message.id}\n              className={`flex ${message.type === 'user' ? 'justify-end' : 'justify-start'}`}\n            >\n              <div\n                className={`max-w-xs px-4 py-2 rounded-lg ${\n                  message.type === 'user'\n                    ? 'bg-neon-purple text-white'\n                    : 'bg-gray-700 text-gray-100'\n                }`}\n              >\n                <div className=\"flex items-center space-x-2 mb-1\">\n                  {message.type === 'bot' ? <Bot size={14} /> : <User size={14} />}\n                  <span className=\"text-xs opacity-70\">\n                    {message.timestamp.toLocaleTimeString()}\n                  </span>\n                </div>\n                <p className=\"text-sm\">{message.content}</p>\n              </div>\n            </div>\n          ))}\n          {isTyping && (\n            <div className=\"flex justify-start\">\n              <div className=\"bg-gray-700 text-gray-100 px-4 py-2 rounded-lg\">\n                <div className=\"flex items-center space-x-2\">\n                  <Bot size={14} />\n                  <div className=\"flex space-x-1\">\n                    <div className=\"w-2 h-2 bg-gray-400 rounded-full animate-bounce\"></div>\n                    <div className=\"w-2 h-2 bg-gray-400 rounded-full animate-bounce\" style={{ animationDelay: '0.1s' }}></div>\n                    <div className=\"w-2 h-2 bg-gray-400 rounded-full animate-bounce\" style={{ animationDelay: '0.2s' }}></div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n          <div ref={messagesEndRef} />\n        </div>\n\n        {/* Input */}\n        <div className=\"p-4 border-t border-gray-700\">\n          <div className=\"flex space-x-2\">\n            <input\n              type=\"text\"\n              value={inputValue}\n              onChange={(e) => setInputValue(e.target.value)}\n              onKeyPress={handleKeyPress}\n              placeholder=\"Ask me about employees, leave, tasks...\"\n              className=\"flex-1 bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:outline-none focus:border-neon-purple\"\n            />\n            <button\n              onClick={handleSendMessage}\n              disabled={!inputValue.trim()}\n              className=\"bg-neon-purple hover:bg-neon-purple/80 disabled:opacity-50 disabled:cursor-not-allowed text-white p-2 rounded-lg transition-colors\"\n            >\n              <Send size={20} />\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default AdminChatbot;\n","path":null,"size_bytes":33207,"size_tokens":null},"frontend/README.md":{"content":"# React + Vite\n\nThis template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.\n\nCurrently, two official plugins are available:\n\n- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react) uses [Babel](https://babeljs.io/) for Fast Refresh\n- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh\n\n## Expanding the ESLint configuration\n\nIf you are developing a production application, we recommend using TypeScript with type-aware lint rules enabled. Check out the [TS template](https://github.com/vitejs/vite/tree/main/packages/create-vite/template-react-ts) for information on how to integrate TypeScript and [`typescript-eslint`](https://typescript-eslint.io) in your project.\n","path":null,"size_bytes":856,"size_tokens":null},"backend/controllers/leaveController.js":{"content":"// controllers/leaveController.js\nimport { validationResult } from 'express-validator';\nimport Leave from '../models/Leave.js';\nimport Employee from '../models/Employee.js';\nimport User from '../models/User.js';\nimport { sendEmail } from '../utils/email.js';\n\n// @desc    Apply for leave\n// @route   POST /api/leaves\n// @access  Private (Employee)\nexport const applyLeave = async (req, res) => {\n  try {\n    const errors = validationResult(req);\n    if (!errors.isEmpty()) {\n      return res.status(400).json({\n        success: false,\n        message: 'Validation errors',\n        errors: errors.array()\n      });\n    }\n\n    const employee = await Employee.findOne({ user: req.user.id });\n    if (!employee) {\n      return res.status(404).json({ success: false, message: 'Employee record not found' });\n    }\n\n    // Initialize leave balance if not exists\n    if (!employee.leaveBalance) {\n      employee.leaveBalance = {\n        total: 30,\n        used: 0,\n        remaining: 30\n      };\n      await employee.save();\n    }\n\n    const { leaveType, startDate, endDate, reason, isHalfDay, halfDaySession } = req.body;\n\n    // Validate dates\n    if (!startDate || (!isHalfDay && !endDate)) {\n      return res.status(400).json({ success: false, message: 'Start and end dates are required' });\n    }\n\n    const start = new Date(startDate);\n    const end = isHalfDay ? start : new Date(endDate);\n    if (start > end) {\n      return res.status(400).json({ success: false, message: 'End date cannot be before start date' });\n    }\n\n    // Check for leave conflicts\n    const conflicts = await Leave.checkConflicts(employee._id, start, end);\n    if (conflicts.length > 0) {\n      return res.status(400).json({ success: false, message: 'Leave request conflicts with existing leave' });\n    }\n\n    // Calculate total days\n    let totalDays = isHalfDay ? 0.5 : Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;\n\n    // Check available balance (simple total balance)\n    const availableBalance = employee.leaveBalance.remaining || 0;\n\n    if (totalDays > availableBalance) {\n      return res.status(400).json({\n        success: false,\n        message: `Insufficient leave balance. Available: ${availableBalance} days`\n      });\n    }\n\n    // Deduct from total leave balance\n    employee.leaveBalance.used += totalDays;\n    employee.leaveBalance.remaining -= totalDays;\n    await employee.save();\n\n    // Create leave\n    const leave = await Leave.create({\n      employee: employee._id,\n      user: req.user.id,\n      leaveType,\n      startDate: start,\n      endDate: end,\n      totalDays,\n      reason,\n      isHalfDay,\n      halfDaySession: isHalfDay ? halfDaySession : undefined\n    });\n\n    // Send notification email to admins\n    try {\n      const adminUsers = await User.find({ role: 'admin', isActive: true });\n\n      console.log(`Found ${adminUsers.length} active admin users for leave notification`);\n\n      if (adminUsers.length === 0) {\n        console.warn('⚠️ No active admin users found for leave notification');\n        console.log('Leave application saved successfully but no admin notifications sent');\n      } else {\n        for (const admin of adminUsers) {\n          console.log(`📧 Sending leave notification to admin: ${admin.email}`);\n\n          const emailMessage = `\n            <h2>New Leave Application</h2>\n            <p>A new leave application has been submitted:</p>\n            <ul>\n              <li><strong>Employee:</strong> ${employee.personalInfo?.firstName} ${employee.personalInfo?.lastName}</li>\n              <li><strong>Employee ID:</strong> ${employee.employeeId}</li>\n              <li><strong>Leave Type:</strong> ${leaveType}</li>\n              <li><strong>Duration:</strong> ${totalDays} days</li>\n              <li><strong>Start Date:</strong> ${start.toLocaleDateString()}</li>\n              <li><strong>End Date:</strong> ${end.toLocaleDateString()}</li>\n              <li><strong>Reason:</strong> ${reason}</li>\n            </ul>\n            <p>Please review and take appropriate action.</p>\n          `;\n\n          const emailResult = await sendEmail({\n            to: admin.email,\n            subject: 'New Leave Application - Action Required',\n            html: emailMessage\n          });\n\n          if (emailResult.success) {\n            console.log(`✅ Leave notification sent to ${admin.email}: ${emailResult.messageId}`);\n          } else {\n            console.error(`❌ Failed to send leave notification to ${admin.email}: ${emailResult.error}`);\n          }\n        }\n      }\n    } catch (emailError) {\n      console.error('❌ Error sending leave notification email:', emailError);\n      console.log('⚠️ Leave application saved successfully but email notification failed');\n      // Don't fail the entire request if email fails\n    }\n\n    res.status(201).json({\n      success: true,\n      message: 'Leave application submitted successfully',\n      leave\n    });\n\n  } catch (error) {\n    console.error('Apply leave error:', error);\n    res.status(400).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// @desc    Get leave statistics (for admin dashboard)\n// @route   GET /api/leaves/stats\n// @access  Private (Admin)\nexport const getLeaveStats = async (req, res) => {\n  try {\n    let query = {};\n    if (req.user.role === 'employee') {\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (employee) query.employee = employee._id;\n    }\n\n    const total = await Leave.countDocuments(query);\n    const approved = await Leave.countDocuments({ ...query, status: 'Approved' });\n    const pending = await Leave.countDocuments({ ...query, status: 'Pending' });\n    const rejected = await Leave.countDocuments({ ...query, status: 'Rejected' });\n    const cancelled = await Leave.countDocuments({ ...query, status: 'Cancelled' });\n\n    res.json({ success: true, stats: { total, approved, pending, rejected, cancelled } });\n  } catch (error) {\n    console.error(error);\n    res.status(500).json({ success: false, message: error.message });\n  }\n};\n\n// @desc    Get leave balance\n// @route   GET /api/leaves/balance\n// @access  Private (Employee)\nexport const getLeaveBalance = async (req, res) => {\n  try {\n    const employee = await Employee.findOne({ user: req.user.id });\n    if (!employee) {\n      return res.status(404).json({ success: false, message: 'Employee not found' });\n    }\n\n    // Initialize leave balance if not exists\n    if (!employee.leaveBalance) {\n      employee.leaveBalance = {\n        total: 30,\n        used: 0,\n        remaining: 30\n      };\n      await employee.save();\n    }\n\n    // Return simple balance structure\n    res.json({ \n      success: true, \n      balance: {\n        total: employee.leaveBalance.total,\n        used: employee.leaveBalance.used,\n        remaining: employee.leaveBalance.remaining\n      }\n    });\n  } catch (error) {\n    console.error(error);\n    res.status(500).json({ success: false, message: error.message });\n  }\n};\n\n\n// @desc    Get leave applications\n// @route   GET /api/leaves\n// @access  Private\nexport const getLeaves = async (req, res) => {\n  try {\n    const { \n      page = 1, \n      limit = 50, \n      status, \n      leaveType, \n      employeeId,\n      startDate,\n      endDate\n    } = req.query;\n\n    let query = {};\n\n    // Build query based on user role\n    if (req.user.role === 'employee') {\n      // Employees can only see their own leaves\n      const employee = await Employee.findOne({ user: req.user.id });\n      if (employee) {\n        query.employee = employee._id;\n      }\n    } else if (employeeId) {\n      // Admin can filter by specific employee\n      query.employee = employeeId;\n    }\n\n    // Apply filters\n    if (status) query.status = status;\n    if (leaveType) query.leaveType = leaveType;\n    \n    if (startDate && endDate) {\n      query.startDate = {\n        $gte: new Date(startDate),\n        $lte: new Date(endDate)\n      };\n    }\n\n    const leaves = await Leave.find(query)\n      .populate([\n        {\n          path: 'employee',\n          populate: {\n            path: 'user',\n            select: 'name email employeeId'\n          }\n        },\n        {\n          path: 'user',\n          select: 'name email'\n        },\n        {\n          path: 'actionBy',\n          select: 'name email'\n        }\n      ])\n      .sort({ appliedDate: -1 })\n      .limit(limit * 1)\n      .skip((page - 1) * limit);\n\n    const total = await Leave.countDocuments(query);\n\n    res.json({\n      success: true,\n      leaves,\n      pagination: {\n        currentPage: parseInt(page),\n        totalPages: Math.ceil(total / limit),\n        totalLeaves: total,\n        hasNext: page < Math.ceil(total / limit),\n        hasPrev: page > 1\n      }\n    });\n\n  } catch (error) {\n    console.error('Get leaves error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// @desc    Get leave by ID\n// @route   GET /api/leaves/:id\n// @access  Private\nexport const getLeaveById = async (req, res) => {\n  try {\n    const leave = await Leave.findById(req.params.id)\n      .populate([\n        {\n          path: 'employee',\n          populate: {\n            path: 'user',\n            select: 'name email employeeId'\n          }\n        },\n        {\n          path: 'user',\n          select: 'name email'\n        },\n        {\n          path: 'actionBy',\n          select: 'name email'\n        }\n      ]);\n\n    if (!leave) {\n      return res.status(404).json({\n        success: false,\n        message: 'Leave application not found'\n      });\n    }\n\n    // Check permissions - employees can only view their own leaves\n    if (req.user.role === 'employee') {\n      if (leave.user._id.toString() !== req.user.id.toString()) {\n        return res.status(403).json({\n          success: false,\n          message: 'Access denied'\n        });\n      }\n    }\n\n    res.json({\n      success: true,\n      leave\n    });\n\n  } catch (error) {\n    console.error('Get leave by ID error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// @desc    Cancel leave\n// @route   PUT /api/leaves/:id/cancel\n// @access  Private (Employee)\nexport const cancelLeave = async (req, res) => {\n  try {\n    const leave = await Leave.findById(req.params.id);\n\n    if (!leave) {\n      return res.status(404).json({ success: false, message: 'Leave not found' });\n    }\n\n    if (leave.user.toString() !== req.user.id) {\n      return res.status(403).json({ success: false, message: 'Access denied' });\n    }\n\n    if (leave.status !== 'pending') {\n      return res.status(400).json({ success: false, message: 'Only pending leaves can be cancelled' });\n    }\n\n    leave.status = 'Cancelled';\n    leave.actionBy = req.user.id;\n    leave.actionDate = new Date();\n    await leave.save();\n\n    res.json({ success: true, message: 'Leave cancelled successfully', leave });\n  } catch (error) {\n    console.error(error);\n    res.status(500).json({ success: false, message: error.message });\n  }\n};\n\n\n// @desc    Approve leave\n// @route   PUT /api/leaves/:id/approve\n// @access  Private (Admin)\n// @desc    Approve leave\n// @route   PUT /api/leaves/:id/approve\n// @access  Private (Admin)\nexport const approveLeave = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { comments = '' } = req.body;\n\n    const leave = await Leave.findById(req.params.id).populate([\n      {\n        path: 'employee',\n        populate: { path: 'user', select: 'name email employeeId' }\n      },\n      { path: 'user', select: 'name email' }\n    ]);\n\n    if (!leave) {\n      return res.status(404).json({\n        success: false,\n        message: 'Leave application not found'\n      });\n    }\n\n    if (leave.status.toLowerCase() !== 'pending') {\n      return res.status(400).json({\n        success: false,\n        message: `Cannot approve a leave that is already ${leave.status}`\n      });\n    }\n\n    // Update leave status\n    leave.status = 'Approved';\n    leave.actionBy = req.user.id;\n    leave.approverComments = comments; // Use approverComments as per model\n    leave.actionDate = new Date();\n\n    await leave.save();\n\n    // Send notification email to employee\n    try {\n      const emailMessage = `\n        <h2>Leave Approved</h2>\n        <p>Your leave application has been approved:</p>\n        <ul>\n          <li><strong>Leave Type:</strong> ${leave.leaveType}</li>\n          <li><strong>Start Date:</strong> ${new Date(leave.startDate).toLocaleDateString()}</li>\n          <li><strong>End Date:</strong> ${new Date(leave.endDate).toLocaleDateString()}</li>\n          <li><strong>Total Days:</strong> ${leave.totalDays}</li>\n          ${comments ? `<li><strong>Comments:</strong> ${comments}</li>` : ''}\n        </ul>\n      `;\n      \n      await sendEmail({\n        to: leave.user.email,\n        subject: 'Leave Approved',\n        html: emailMessage\n      });\n    } catch (err) {\n      console.error('Error sending approval email:', err);\n      // Don't fail the approval if email fails\n    }\n\n    res.json({\n      success: true,\n      message: 'Leave approved successfully',\n      leave\n    });\n\n  } catch (error) {\n    console.error('Approve leave error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};\n\n// @desc    Reject leave (updated to restore simple balance)\n// @route   PUT /api/leaves/:id/reject\n// @access  Private (Admin)\nexport const rejectLeave = async (req, res) => {\n  try {\n    if (req.user.role !== 'admin') {\n      return res.status(403).json({\n        success: false,\n        message: 'Access denied. Admin only.'\n      });\n    }\n\n    const { comments = '' } = req.body;\n\n    const leave = await Leave.findById(req.params.id).populate([\n      {\n        path: 'employee',\n        populate: { path: 'user', select: 'name email employeeId' }\n      },\n      { path: 'user', select: 'name email' }\n    ]);\n\n    if (!leave) {\n      return res.status(404).json({\n        success: false,\n        message: 'Leave application not found'\n      });\n    }\n\n    if (leave.status.toLowerCase() !== 'pending') {\n      return res.status(400).json({\n        success: false,\n        message: `Cannot reject a leave that is already ${leave.status}`\n      });\n    }\n\n    // Restore simple leave balance when rejecting\n    const employee = await Employee.findById(leave.employee._id);\n    if (employee) {\n      employee.leaveBalance.used -= leave.totalDays;\n      employee.leaveBalance.remaining += leave.totalDays;\n      await employee.save();\n    }\n\n    // Update leave status\n    leave.status = 'Rejected';\n    leave.actionBy = req.user.id;\n    leave.approverComments = comments;\n    leave.actionDate = new Date();\n\n    await leave.save();\n\n    // Send notification email\n    try {\n      const emailMessage = `\n        <h2>Leave Rejected</h2>\n        <p>Your leave application has been rejected:</p>\n        <ul>\n          <li><strong>Leave Type:</strong> ${leave.leaveType}</li>\n          <li><strong>Start Date:</strong> ${new Date(leave.startDate).toLocaleDateString()}</li>\n          <li><strong>End Date:</strong> ${new Date(leave.endDate).toLocaleDateString()}</li>\n          <li><strong>Total Days:</strong> ${leave.totalDays}</li>\n          ${comments ? `<li><strong>Comments:</strong> ${comments}</li>` : ''}\n        </ul>\n      `;\n      \n      await sendEmail({\n        to: leave.user.email,\n        subject: 'Leave Rejected',\n        html: emailMessage\n      });\n    } catch (err) {\n      console.error('Error sending rejection email:', err);\n    }\n\n    res.json({\n      success: true,\n      message: 'Leave rejected successfully',\n      leave\n    });\n\n  } catch (error) {\n    console.error('Reject leave error:', error);\n    res.status(500).json({\n      success: false,\n      message: error.message\n    });\n  }\n};","path":null,"size_bytes":15932,"size_tokens":null},"frontend/src/components/Admin/Header/Header.jsx":{"content":"// components/Header/Header.jsx - Improved version with better error handling\nimport React, { useState, useEffect, useRef } from \"react\";\nimport { Menu, User, ChevronDown } from \"lucide-react\";\nimport NotificationBell from \"./NotificationBell\";\nimport ProfileDropdown from \"./ProfileDropdown\";\nimport { authAPI, dashboardAPI } from '../../../utils/api';\nimport toast from 'react-hot-toast';\n\nconst Header = ({ sidebarItems, location, setSidebarOpen }) => {\n  const [profileDropdown, setProfileDropdown] = useState(false);\n  const [userProfile, setUserProfile] = useState(null);\n  const [notifications, setNotifications] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  \n  // Use ref to prevent multiple simultaneous API calls\n  const fetchingRef = useRef(false);\n  // Ref for profile dropdown container to detect outside clicks\n  const profileDropdownRef = useRef(null);\n\n  // Close dropdowns when clicking outside or on mobile\n  useEffect(() => {\n    const handleClickOutside = (event) => {\n      // Only close if click is outside the profile dropdown container\n      if (profileDropdown && profileDropdownRef.current && \n          !profileDropdownRef.current.contains(event.target)) {\n        setProfileDropdown(false);\n      }\n    };\n\n    const handleResize = () => {\n      if (window.innerWidth < 768 && profileDropdown) {\n        setProfileDropdown(false);\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    window.addEventListener('resize', handleResize);\n    \n    return () => {\n      document.removeEventListener('mousedown', handleClickOutside);\n      window.removeEventListener('resize', handleResize);\n    };\n  }, [profileDropdown]);\n\n  // Fetch user data only once on mount\n  useEffect(() => {\n    const initializeHeader = async () => {\n      if (fetchingRef.current) return; // Prevent duplicate calls\n      fetchingRef.current = true;\n\n      try {\n        await Promise.all([\n          fetchUserData(),\n          fetchNotifications()\n        ]);\n      } catch (error) {\n        console.error('Header initialization error:', error);\n      } finally {\n        setLoading(false);\n        fetchingRef.current = false;\n      }\n    };\n\n    initializeHeader();\n  }, []);\n\n  // Fetch current user profile data\n  const fetchUserData = async () => {\n    try {\n      setError(null);\n      const response = await authAPI.getMyProfile();\n      \n      if (response.data.success) {\n        setUserProfile(response.data.data);\n      } else {\n        throw new Error(response.data.message || 'Failed to fetch profile');\n      }\n    } catch (error) {\n      console.error('Error fetching user profile:', error);\n      setError(error.message);\n      \n      // Fallback to localStorage data\n      const fallbackData = {\n        name: localStorage.getItem('userName') || 'User',\n        email: localStorage.getItem('userEmail') || 'user@example.com',\n        role: localStorage.getItem('userRole') || 'employee'\n      };\n      setUserProfile(fallbackData);\n    }\n  };\n\n  // Fetch notifications with error handling\n  const fetchNotifications = async () => {\n    try {\n      const userRole = localStorage.getItem('userRole');\n      \n      if (userRole === 'admin') {\n        // Fetch admin activities\n       // Replace in fetchNotifications\nconst response = await dashboardAPI.getUserNotifications();\nif (response.data.success) {\n  setNotifications(\n    (response.data.data || []).map((n, index) => ({\n      id: n.id || `notification-${index}`,\n      message: n.message,\n      user: n.user,\n      time: n.time,\n      type: n.type || 'info',\n      category: n.category || 'general',\n      unread: n.unread ?? true\n    }))\n  );\n}\n    \n      } else {\n        // For employees, create sample notifications based on stats\n        try {\n          const response = await dashboardAPI.getEmployeeStats();\n          if (response.data.success) {\n            const employeeNotifications = [];\n            \n            // Create notifications based on employee data\n            const stats = response.data;\n            \n            if (stats.tasks?.pending > 0) {\n              employeeNotifications.push({\n                id: 'pending-tasks',\n                message: `You have ${stats.tasks.pending} pending tasks`,\n                time: 'Today',\n                type: 'warning',\n                category: 'tasks',\n                unread: true\n              });\n            }\n            \n            if (stats.tasks?.overdue > 0) {\n              employeeNotifications.push({\n                id: 'overdue-tasks',\n                message: `You have ${stats.tasks.overdue} overdue tasks`,\n                time: 'Today',\n                type: 'error',\n                category: 'tasks',\n                unread: true\n              });\n            }\n            \n            setNotifications(employeeNotifications);\n          }\n        } catch (employeeError) {\n          // If employee stats fail, set empty notifications\n          setNotifications([]);\n        }\n      }\n    } catch (error) {\n      console.error('Error fetching notifications:', error);\n      setNotifications([]);\n    }\n  };\n\n  // Refresh notifications manually\n  const handleRefreshNotifications = async () => {\n    if (fetchingRef.current) return;\n    \n    try {\n      await fetchNotifications();\n    } catch (error) {\n      toast.error('Failed to refresh notifications');\n    }\n  };\n\n  // Handle logout with proper cleanup\n  const handleLogout = async () => {\n    try {\n      // Call logout API (don't fail if it errors)\n      await authAPI.logout().catch(() => {});\n    } finally {\n      // Always clear storage and redirect\n      const authKeys = [\n        'token', 'authToken', 'userRole', 'userEmail', 'userName', 'userId', 'employeeId'\n      ];\n      \n      authKeys.forEach(key => {\n        localStorage.removeItem(key);\n        sessionStorage.removeItem(key);\n      });\n      \n      toast.success(\"Logged out successfully!\");\n      window.location.href = '/login';\n    }\n  };\n\n  // Mark notification as read\n  const handleNotificationRead = (notificationId) => {\n    setNotifications(prev => \n      prev.map(n => n.id === notificationId ? { ...n, unread: false } : n)\n    );\n  };\n\n  // Count unread notifications\n  const unreadNotifications = notifications.filter(n => n.unread).length;\n\n  // Get display information\n  const getDisplayInfo = () => {\n    if (loading && !userProfile) {\n      return { name: 'Loading...', email: '', role: '' };\n    }\n    \n    if (error && !userProfile) {\n      return { \n        name: 'User', \n        email: localStorage.getItem('userEmail') || '', \n        role: localStorage.getItem('userRole') || '' \n      };\n    }\n    \n    if (userProfile) {\n      // Handle both user profile formats\n      const firstName = userProfile.personalInfo?.firstName || '';\n      const lastName = userProfile.personalInfo?.lastName || '';\n      const fullName = firstName && lastName ? `${firstName} ${lastName}` : userProfile.name;\n      \n      return {\n        name: fullName || userProfile.name || 'User',\n        email: userProfile.email || userProfile.contactInfo?.personalEmail || '',\n        role: userProfile.role === 'admin' ? 'Administrator' : 'Employee'\n      };\n    }\n    \n    return {\n      name: localStorage.getItem('userName') || 'User',\n      email: localStorage.getItem('userEmail') || '',\n      role: localStorage.getItem('userRole') === 'admin' ? 'Administrator' : 'Employee'\n    };\n  };\n\n  const { name, email, role } = getDisplayInfo();\n\n  return (\n    <header className=\"bg-gray-900 border-b border-secondary-700 h-16 z-40 sticky top-0\">\n      <div className=\"flex items-center justify-between h-full px-4 sm:px-6\">\n        {/* Mobile menu button */}\n        <button\n          onClick={() => setSidebarOpen(true)}\n          className=\"lg:hidden text-secondary-400 hover:text-white p-1 rounded-md transition-colors\"\n          aria-label=\"Open sidebar\"\n        >\n          <Menu className=\"w-6 h-6\" />\n        </button>\n\n        {/* Page Title - Hidden on very small screens */}\n        <div className=\"hidden sm:hidden lg:block\">\n          <h2 className=\"text-xl font-semibold text-white\">\n            {sidebarItems.find((item) => item.path === location.pathname)?.name ||\n              \"Dashboard\"}\n          </h2>\n        </div>\n\n        {/* Mobile Page Title - Only show on small screens */}\n        <div className=\"sm:hidden lg:hidden flex-1 text-center\">\n          <h2 className=\"text-lg font-semibold text-white truncate px-2\">\n            {sidebarItems.find((item) => item.path === location.pathname)?.name ||\n              \"Dashboard\"}\n          </h2>\n        </div>\n\n        {/* Right Section */}\n        <div className=\"flex items-center space-x-2 sm:space-x-4\">\n          <NotificationBell \n            unreadCount={unreadNotifications} \n            notifications={notifications}\n            onNotificationRead={handleNotificationRead}\n            onRefresh={handleRefreshNotifications}\n          />\n\n          {/* Profile */}\n          <div className=\"relative\" ref={profileDropdownRef}>\n            <button\n              onClick={() => setProfileDropdown(!profileDropdown)}\n              className=\"flex items-center space-x-2 sm:space-x-3 p-1 sm:p-2 rounded-lg hover:bg-secondary-700/50 transition-colors\"\n              aria-label=\"Open profile menu\"\n            >\n              <div className=\"w-7 h-7 sm:w-8 sm:h-8 bg-gradient-to-r from-neon-pink to-neon-purple rounded-full flex items-center justify-center flex-shrink-0\">\n                <User className=\"w-3 h-3 sm:w-4 sm:h-4 text-white\" />\n              </div>\n              \n              {/* User info - responsive visibility */}\n              <div className=\"hidden sm:block md:block text-left min-w-0\">\n                <p className=\"text-sm font-medium text-white truncate max-w-[120px] lg:max-w-none\">\n                  {name}\n                </p>\n                <p className=\"text-xs text-secondary-400 truncate max-w-[120px] lg:max-w-none\">\n                  {email}\n                </p>\n              </div>\n              \n              {/* Show only on larger screens */}\n              <ChevronDown className={`w-4 h-4 text-secondary-400 hidden sm:block transition-transform ${profileDropdown ? 'rotate-180' : ''}`} />\n            </button>\n\n            {profileDropdown && (\n              <ProfileDropdown \n                onLogout={handleLogout}\n                userProfile={userProfile}\n                onClose={() => setProfileDropdown(false)}\n              />\n            )}\n          </div>\n        </div>\n      </div>\n    </header>\n  );\n};\n\nexport default Header;","path":null,"size_bytes":10636,"size_tokens":null},"frontend/src/utils/constants.js":{"content":"export const API_ENDPOINTS = {\n  AUTH: {\n    LOGIN: '/auth/login',\n    REGISTER: '/auth/register',\n    FORGOT_PASSWORD: '/auth/forgot-password',\n    RESET_PASSWORD: '/auth/reset-password',\n    PROFILE: '/auth/profile',\n    CHANGE_PASSWORD: '/auth/change-password',\n    LOGOUT: '/auth/logout',\n    USERS: '/auth/users',\n    INIT_ADMIN: '/auth/init-admin'\n  },\n  TASKS: {\n    BASE: '/tasks',\n    STATS: '/tasks/stats',\n    COMMENTS: (id) => `/tasks/${id}/comments`,\n    PROGRESS: (id) => `/tasks/${id}/progress`,\n    STATUS: (id) => `/tasks/${id}/status`,\n    SUBTASKS: (id, subtaskId) => `/tasks/${id}/subtasks/${subtaskId}`\n  },\n  EMPLOYEES: {\n    BASE: '/employees',\n    STATS: '/employees/stats'\n  }\n};\n\nexport const TASK_STATUSES = [\n  'Not Started',\n  'In Progress', \n  'Review',\n  'Completed',\n  'On Hold',\n  'Cancelled'\n];\n\nexport const TASK_PRIORITIES = [\n  'Low',\n  'Medium',\n  'High',\n  'Critical'\n];\n\nexport const TASK_CATEGORIES = [\n  'Development',\n  'Design',\n  'Testing',\n  'Documentation',\n  'Research',\n  'Bug Fix',\n  'Feature',\n  'Maintenance',\n  'Other'\n];\n\n// Export all services\nexport { authService, taskService, employeeService };\nexport { useAuth, useTasks };\nexport { handleApiError };","path":null,"size_bytes":1209,"size_tokens":null},"backend/routes/purchaseRoutes.js":{"content":"import express from 'express';\nimport { body } from 'express-validator';\nimport {\n  getPurchaseOrders,\n  getSuppliers,\n  createSupplier,\n  createPurchaseOrder,\n  updatePurchaseOrder,\n  deletePurchaseOrder\n} from '../controllers/purchaseController.js';\nimport { protect, adminOnly } from '../middleware/authMiddleware.js';\n\nconst router = express.Router();\n\n// Apply auth middleware to all routes\nrouter.use(protect);\n\n// Validation middleware for purchase order creation\nconst purchaseOrderValidation = [\n  body('supplier')\n    .isMongoId()\n    .withMessage('Invalid supplier ID'),\n  body('deliveryDate')\n    .isISO8601()\n    .withMessage('Invalid delivery date'),\n  body('lineItems')\n    .isArray({ min: 1 })\n    .withMessage('At least one line item is required'),\n  body('lineItems.*.item')\n    .trim()\n    .isLength({ min: 1 })\n    .withMessage('Item name is required'),\n  body('lineItems.*.quantity')\n    .isNumeric()\n    .isFloat({ min: 1 })\n    .withMessage('Quantity must be a positive number'),\n  body('lineItems.*.unitPrice')\n    .isNumeric()\n    .isFloat({ min: 0 })\n    .withMessage('Unit price must be a non-negative number')\n];\n\n// Validation middleware for supplier creation\nconst supplierValidation = [\n  body('name')\n    .trim()\n    .isLength({ min: 1 })\n    .withMessage('Supplier name is required'),\n  body('email')\n    .optional()\n    .isEmail()\n    .withMessage('Invalid email format'),\n  body('phone')\n    .optional()\n    .isMobilePhone()\n    .withMessage('Invalid phone number'),\n  body('address')\n    .optional()\n    .isString()\n    .withMessage('Address must be a string')\n];\n\n// Routes\nrouter.get('/suppliers', getSuppliers);\nrouter.post('/suppliers', adminOnly, supplierValidation, createSupplier);\nrouter.get('/', getPurchaseOrders);\nrouter.post('/', adminOnly, purchaseOrderValidation, createPurchaseOrder);\nrouter.put('/:id', adminOnly, purchaseOrderValidation, updatePurchaseOrder);\nrouter.delete('/:id', adminOnly, deletePurchaseOrder);\n\nexport default router;\n","path":null,"size_bytes":1992,"size_tokens":null},"backend/controllers/groupController.js":{"content":"import Group from '../models/Group.js';\nimport GroupMessage from '../models/GroupMessage.js';\nimport User from '../models/User.js';\n\nexport const createGroup = async (req, res) => {\n  try {\n    const { name, description, memberIds } = req.body;\n    const ownerId = req.user.id;\n\n    if (!name || name.trim().length === 0) {\n      return res.status(400).json({ success: false, message: 'Group name is required' });\n    }\n\n    const members = [{\n      user: ownerId,\n      role: 'owner',\n      joinedAt: new Date(),\n      addedBy: ownerId\n    }];\n\n    if (memberIds && Array.isArray(memberIds)) {\n      const validMembers = await User.find({ \n        _id: { $in: memberIds, $ne: ownerId },\n        isActive: true \n      }).select('_id');\n      \n      validMembers.forEach(member => {\n        members.push({\n          user: member._id,\n          role: 'member',\n          joinedAt: new Date(),\n          addedBy: ownerId\n        });\n      });\n    }\n\n    const group = new Group({\n      name: name.trim(),\n      description: description?.trim() || '',\n      owner: ownerId,\n      members\n    });\n\n    await group.save();\n    await group.populate('members.user', 'name email profileImage');\n    await group.populate('owner', 'name email profileImage');\n\n    res.status(201).json({\n      success: true,\n      message: 'Group created successfully',\n      data: group\n    });\n  } catch (error) {\n    console.error('Create group error:', error);\n    res.status(500).json({ success: false, message: 'Failed to create group' });\n  }\n};\n\nexport const getMyGroups = async (req, res) => {\n  try {\n    const userId = req.user.id;\n\n    const groups = await Group.find({\n      'members.user': userId,\n      isActive: true\n    })\n    .populate('owner', 'name email profileImage')\n    .populate('members.user', 'name email profileImage')\n    .populate('lastMessage.sender', 'name')\n    .sort({ updatedAt: -1 });\n\n    res.json({ success: true, data: groups });\n  } catch (error) {\n    console.error('Get my groups error:', error);\n    res.status(500).json({ success: false, message: 'Failed to fetch groups' });\n  }\n};\n\nexport const getGroupById = async (req, res) => {\n  try {\n    const { groupId } = req.params;\n    const userId = req.user.id;\n\n    const group = await Group.findById(groupId)\n      .populate('owner', 'name email profileImage')\n      .populate('members.user', 'name email profileImage')\n      .populate('members.addedBy', 'name');\n\n    if (!group) {\n      return res.status(404).json({ success: false, message: 'Group not found' });\n    }\n\n    if (!group.isMember(userId)) {\n      return res.status(403).json({ success: false, message: 'You are not a member of this group' });\n    }\n\n    res.json({ success: true, data: group });\n  } catch (error) {\n    console.error('Get group error:', error);\n    res.status(500).json({ success: false, message: 'Failed to fetch group' });\n  }\n};\n\nexport const updateGroup = async (req, res) => {\n  try {\n    const { groupId } = req.params;\n    const { name, description, settings } = req.body;\n    const userId = req.user.id;\n\n    const group = await Group.findById(groupId);\n    if (!group) {\n      return res.status(404).json({ success: false, message: 'Group not found' });\n    }\n\n    if (!group.isMember(userId)) {\n      return res.status(403).json({ success: false, message: 'You are not a member of this group' });\n    }\n\n    if (!group.canEditInfo(userId)) {\n      return res.status(403).json({ success: false, message: 'You do not have permission to edit this group' });\n    }\n\n    if (name && typeof name === 'string') {\n      const trimmedName = name.trim();\n      if (trimmedName.length > 0 && trimmedName.length <= 100) {\n        group.name = trimmedName;\n      }\n    }\n    if (description !== undefined && typeof description === 'string') {\n      group.description = description.trim().substring(0, 500);\n    }\n    if (settings && group.isOwner(userId)) {\n      const allowedSettings = ['onlyAdminsCanSend', 'onlyAdminsCanAddMembers', 'onlyAdminsCanEditInfo'];\n      allowedSettings.forEach(key => {\n        if (typeof settings[key] === 'boolean') {\n          group.settings[key] = settings[key];\n        }\n      });\n    }\n\n    await group.save();\n    await group.populate('owner', 'name email profileImage');\n    await group.populate('members.user', 'name email profileImage');\n\n    res.json({ success: true, message: 'Group updated', data: group });\n  } catch (error) {\n    console.error('Update group error:', error);\n    res.status(500).json({ success: false, message: 'Failed to update group' });\n  }\n};\n\nexport const addMembers = async (req, res) => {\n  try {\n    const { groupId } = req.params;\n    const { memberIds } = req.body;\n    const userId = req.user.id;\n\n    const group = await Group.findById(groupId);\n    if (!group) {\n      return res.status(404).json({ success: false, message: 'Group not found' });\n    }\n\n    if (!group.canAddMembers(userId)) {\n      return res.status(403).json({ success: false, message: 'You do not have permission to add members' });\n    }\n\n    if (!memberIds || !Array.isArray(memberIds) || memberIds.length === 0) {\n      return res.status(400).json({ success: false, message: 'Member IDs are required' });\n    }\n\n    const existingMemberIds = group.members.map(m => m.user.toString());\n    const newMemberIds = memberIds.filter(id => !existingMemberIds.includes(id));\n\n    const validMembers = await User.find({\n      _id: { $in: newMemberIds },\n      isActive: true\n    }).select('_id');\n\n    const addedMembers = [];\n    validMembers.forEach(member => {\n      group.members.push({\n        user: member._id,\n        role: 'member',\n        joinedAt: new Date(),\n        addedBy: userId\n      });\n      addedMembers.push(member._id);\n    });\n\n    await group.save();\n    await group.populate('members.user', 'name email profileImage');\n\n    res.json({ \n      success: true, \n      message: `${addedMembers.length} member(s) added`,\n      data: group \n    });\n  } catch (error) {\n    console.error('Add members error:', error);\n    res.status(500).json({ success: false, message: 'Failed to add members' });\n  }\n};\n\nexport const removeMember = async (req, res) => {\n  try {\n    const { groupId, memberId } = req.params;\n    const userId = req.user.id;\n\n    const group = await Group.findById(groupId);\n    if (!group) {\n      return res.status(404).json({ success: false, message: 'Group not found' });\n    }\n\n    const memberToRemove = group.members.find(m => m.user.toString() === memberId);\n    if (!memberToRemove) {\n      return res.status(404).json({ success: false, message: 'Member not found in group' });\n    }\n\n    if (memberToRemove.role === 'owner') {\n      return res.status(400).json({ success: false, message: 'Cannot remove the group owner' });\n    }\n\n    const isRemovingSelf = userId === memberId;\n    const isAdmin = group.isAdmin(userId);\n\n    if (!isRemovingSelf && !isAdmin) {\n      return res.status(403).json({ success: false, message: 'You do not have permission to remove members' });\n    }\n\n    group.members = group.members.filter(m => m.user.toString() !== memberId);\n    await group.save();\n    await group.populate('members.user', 'name email profileImage');\n\n    res.json({ \n      success: true, \n      message: isRemovingSelf ? 'You left the group' : 'Member removed',\n      data: group \n    });\n  } catch (error) {\n    console.error('Remove member error:', error);\n    res.status(500).json({ success: false, message: 'Failed to remove member' });\n  }\n};\n\nexport const leaveGroup = async (req, res) => {\n  try {\n    const { groupId } = req.params;\n    const userId = req.user.id;\n\n    const group = await Group.findById(groupId);\n    if (!group) {\n      return res.status(404).json({ success: false, message: 'Group not found' });\n    }\n\n    if (!group.isMember(userId)) {\n      return res.status(400).json({ success: false, message: 'You are not a member of this group' });\n    }\n\n    if (group.isOwner(userId)) {\n      const admins = group.members.filter(m => m.role === 'admin' && m.user.toString() !== userId);\n      if (admins.length > 0) {\n        const newOwnerMember = admins[0];\n        group.owner = newOwnerMember.user;\n        newOwnerMember.role = 'owner';\n      } else {\n        const otherMembers = group.members.filter(m => m.user.toString() !== userId);\n        if (otherMembers.length > 0) {\n          const newOwnerMember = otherMembers[0];\n          group.owner = newOwnerMember.user;\n          newOwnerMember.role = 'owner';\n        } else {\n          group.isActive = false;\n        }\n      }\n    }\n\n    group.members = group.members.filter(m => m.user.toString() !== userId);\n    await group.save();\n\n    res.json({ success: true, message: 'You left the group' });\n  } catch (error) {\n    console.error('Leave group error:', error);\n    res.status(500).json({ success: false, message: 'Failed to leave group' });\n  }\n};\n\nexport const updateMemberRole = async (req, res) => {\n  try {\n    const { groupId, memberId } = req.params;\n    const { role } = req.body;\n    const userId = req.user.id;\n\n    if (!['admin', 'member'].includes(role)) {\n      return res.status(400).json({ success: false, message: 'Invalid role' });\n    }\n\n    const group = await Group.findById(groupId);\n    if (!group) {\n      return res.status(404).json({ success: false, message: 'Group not found' });\n    }\n\n    if (!group.isOwner(userId)) {\n      return res.status(403).json({ success: false, message: 'Only the owner can change member roles' });\n    }\n\n    const member = group.members.find(m => m.user.toString() === memberId);\n    if (!member) {\n      return res.status(404).json({ success: false, message: 'Member not found' });\n    }\n\n    if (member.role === 'owner') {\n      return res.status(400).json({ success: false, message: 'Cannot change owner role' });\n    }\n\n    member.role = role;\n    await group.save();\n    await group.populate('members.user', 'name email profileImage');\n\n    res.json({ success: true, message: 'Member role updated', data: group });\n  } catch (error) {\n    console.error('Update member role error:', error);\n    res.status(500).json({ success: false, message: 'Failed to update role' });\n  }\n};\n\nexport const deleteGroup = async (req, res) => {\n  try {\n    const { groupId } = req.params;\n    const userId = req.user.id;\n\n    const group = await Group.findById(groupId);\n    if (!group) {\n      return res.status(404).json({ success: false, message: 'Group not found' });\n    }\n\n    if (!group.isOwner(userId)) {\n      return res.status(403).json({ success: false, message: 'Only the owner can delete the group' });\n    }\n\n    group.isActive = false;\n    await group.save();\n\n    res.json({ success: true, message: 'Group deleted' });\n  } catch (error) {\n    console.error('Delete group error:', error);\n    res.status(500).json({ success: false, message: 'Failed to delete group' });\n  }\n};\n\nexport const getGroupMessages = async (req, res) => {\n  try {\n    const { groupId } = req.params;\n    const { limit = 50, before } = req.query;\n    const userId = req.user.id;\n\n    const group = await Group.findById(groupId);\n    if (!group) {\n      return res.status(404).json({ success: false, message: 'Group not found' });\n    }\n\n    if (!group.isMember(userId)) {\n      return res.status(403).json({ success: false, message: 'You are not a member of this group' });\n    }\n\n    const query = { group: groupId, isDeleted: false };\n    if (before) {\n      query.createdAt = { $lt: new Date(before) };\n    }\n\n    const messages = await GroupMessage.find(query)\n      .populate('sender', 'name email profileImage')\n      .sort({ createdAt: -1 })\n      .limit(parseInt(limit));\n\n    res.json({ success: true, data: messages.reverse() });\n  } catch (error) {\n    console.error('Get group messages error:', error);\n    res.status(500).json({ success: false, message: 'Failed to fetch messages' });\n  }\n};\n\nexport const sendGroupMessage = async (req, res) => {\n  try {\n    const { groupId } = req.params;\n    const { text } = req.body;\n    const userId = req.user.id;\n\n    if (!text || typeof text !== 'string' || text.trim().length === 0) {\n      return res.status(400).json({ success: false, message: 'Message text is required' });\n    }\n\n    const sanitizedText = text.trim().substring(0, 5000);\n\n    const group = await Group.findById(groupId);\n    if (!group) {\n      return res.status(404).json({ success: false, message: 'Group not found' });\n    }\n\n    if (!group.isMember(userId)) {\n      return res.status(403).json({ success: false, message: 'You are not a member of this group' });\n    }\n\n    if (!group.canSendMessage(userId)) {\n      return res.status(403).json({ success: false, message: 'You cannot send messages in this group' });\n    }\n\n    const message = new GroupMessage({\n      group: groupId,\n      sender: userId,\n      text: sanitizedText\n    });\n\n    await message.save();\n    await message.populate('sender', 'name email profileImage');\n\n    group.lastMessage = {\n      text: sanitizedText.substring(0, 100),\n      sender: userId,\n      timestamp: new Date()\n    };\n    await group.save();\n\n    res.status(201).json({ success: true, data: message });\n  } catch (error) {\n    console.error('Send group message error:', error);\n    res.status(500).json({ success: false, message: 'Failed to send message' });\n  }\n};\n","path":null,"size_bytes":13294,"size_tokens":null},"backend/scripts/initDB.js":{"content":"// scripts/initDB.js\nimport mongoose from 'mongoose';\nimport dotenv from 'dotenv';\nimport User from '../models/User.js';\n\n// Load environment variables\ndotenv.config();\n\nconst initializeDatabase = async () => {\n  try {\n    // Determine MongoDB URI (support both names and fall back to localhost)\n    const mongoUri = process.env.MONGODB_URI || process.env.MONGO_URI || 'mongodb://127.0.0.1:27017/EMS';\n\n    // Connect to MongoDB\n    console.log('🔗 Connecting to MongoDB at:', mongoUri);\n    await mongoose.connect(mongoUri, {\n      useNewUrlParser: true,\n      useUnifiedTopology: true,\n    });\n\n    console.log('✅ Connected to MongoDB');\n\n    // Check if admin already exists\n    const adminExists = await User.findOne({ role: 'admin' });\n    \n    if (adminExists) {\n      console.log('ℹ️ Admin user already exists');\n      console.log(`   Email: ${adminExists.email}`);\n      console.log(`   Name: ${adminExists.name}`);\n      return;\n    }\n\n    // Create default admin user\n    const adminData = {\n      name: 'Administrator',\n      email: process.env.ADMIN_EMAIL || 'admin@gmail.com',\n      password: process.env.ADMIN_PASSWORD || 'admin',\n      role: 'admin'\n    };\n\n    const admin = await User.create(adminData);\n\n    console.log('🎉 Default admin user created successfully!');\n    console.log(`   Email: ${admin.email}`);\n    console.log(`   Password: ${process.env.ADMIN_PASSWORD || 'admin'}`);\n    console.log(`   Role: ${admin.role}`);\n    console.log('\\n⚠️  Please change the default password after first login for security!');\n\n  } catch (error) {\n    console.error('❌ Error initializing database:', error.message);\n    if (error.code === 11000) {\n      console.log('ℹ️ Admin user might already exist');\n    }\n  } finally {\n    mongoose.connection.close();\n    console.log('🔌 Database connection closed');\n  }\n};\n\n// Run initialization if this file is executed directly\nif (process.argv[1] === new URL(import.meta.url).pathname) {\n  initializeDatabase();\n}\n\nexport default initializeDatabase;","path":null,"size_bytes":2029,"size_tokens":null}},"version":2}