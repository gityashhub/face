<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #10b981; }
        .error { background: #ef4444; }
        .warning { background: #f59e0b; }
        .info { background: #3b82f6; }
        video, canvas {
            max-width: 100%;
            border: 2px solid #333;
            border-radius: 10px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #7c3aed;
        }
        button:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Face API.js Test Page</h1>

        <div id="status" class="status info">Initializing...</div>

        <div class="controls">
            <button id="loadModels">Load Models</button>
            <button id="startCamera" disabled>Start Camera</button>
            <button id="testDetection" disabled>Test Detection</button>
        </div>

        <div>
            <video id="video" width="640" height="480" autoplay muted playsinline></video>
            <canvas id="canvas" width="640" height="480"></canvas>
        </div>

        <div id="results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script>
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        const loadModelsBtn = document.getElementById('loadModels');
        const startCameraBtn = document.getElementById('startCamera');
        const testDetectionBtn = document.getElementById('testDetection');

        let modelsLoaded = false;
        let cameraStarted = false;
        let detectionInterval = null;

        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        async function loadModels() {
            try {
                updateStatus('Loading models...', 'info');
                loadModelsBtn.disabled = true;

                // Try loading from local models directory
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri('/models'),
                    faceapi.nets.faceLandmark68Net.loadFromUri('/models'),
                    faceapi.nets.faceRecognitionNet.loadFromUri('/models')
                ]);

                modelsLoaded = true;
                updateStatus('Models loaded successfully!', 'success');
                startCameraBtn.disabled = false;

                resultsDiv.innerHTML = '<p>✅ Models loaded from /models directory</p>';
            } catch (error) {
                console.error('Model loading error:', error);
                updateStatus(`Model loading failed: ${error.message}`, 'error');

                // Try loading from CDN as fallback
                try {
                    updateStatus('Trying CDN fallback...', 'warning');
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights'),
                        faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights'),
                        faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights')
                    ]);

                    modelsLoaded = true;
                    updateStatus('Models loaded from CDN!', 'success');
                    startCameraBtn.disabled = false;

                    resultsDiv.innerHTML = '<p>✅ Models loaded from CDN (fallback)</p>';
                } catch (cdnError) {
                    console.error('CDN loading error:', cdnError);
                    updateStatus(`CDN loading failed: ${cdnError.message}`, 'error');
                    resultsDiv.innerHTML = `<p>❌ Both local and CDN loading failed</p><p>Error: ${error.message}</p><p>CDN Error: ${cdnError.message}</p>`;
                }
            }
        }

        async function startCamera() {
            try {
                updateStatus('Starting camera...', 'info');
                startCameraBtn.disabled = true;

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: 640,
                        height: 480,
                        facingMode: 'user'
                    }
                });

                const video = document.getElementById('video');
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    video.play();
                    cameraStarted = true;
                    updateStatus('Camera started successfully!', 'success');
                    testDetectionBtn.disabled = false;

                    resultsDiv.innerHTML += '<p>✅ Camera access granted</p>';
                    startFaceDetection();
                };
            } catch (error) {
                console.error('Camera error:', error);
                updateStatus(`Camera error: ${error.message}`, 'error');
                resultsDiv.innerHTML += `<p>❌ Camera error: ${error.message}</p>`;
            }
        }

        function startFaceDetection() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');

            if (detectionInterval) {
                clearInterval(detectionInterval);
            }

            detectionInterval = setInterval(async () => {
                if (video.readyState >= 2) {
                    try {
                        const detections = await faceapi
                            .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                            .withFaceLandmarks()
                            .withFaceDescriptors();

                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);

                        if (detections && detections.length > 0) {
                            // Draw detections
                            ctx.strokeStyle = '#ff0080';
                            ctx.lineWidth = 3;

                            detections.forEach(detection => {
                                const box = detection.detection.box;
                                ctx.strokeRect(box.x, box.y, box.width, box.height);

                                // Draw landmarks
                                ctx.fillStyle = '#00ff00';
                                const landmarks = detection.landmarks;

                                const leftEye = landmarks.getLeftEye();
                                const rightEye = landmarks.getRightEye();
                                const nose = landmarks.getNose();
                                const mouth = landmarks.getMouth();

                                [...leftEye, ...rightEye, ...nose, ...mouth].forEach(point => {
                                    ctx.fillRect(point.x - 1, point.y - 1, 2, 2);
                                });
                            });

                            resultsDiv.innerHTML = resultsDiv.innerHTML.replace(/<p>.*Face Detection: .*/g, '');
                            resultsDiv.innerHTML += `<p>✅ Face Detection: ${detections.length} face(s) detected</p>`;

                            if (detections.length > 0) {
                                const descriptor = detections[0].descriptor;
                                resultsDiv.innerHTML += `<p>✅ Face Descriptor: ${descriptor.length} dimensions</p>`;
                            }
                        } else {
                            resultsDiv.innerHTML = resultsDiv.innerHTML.replace(/<p>.*Face Detection: .*/g, '');
                            resultsDiv.innerHTML += '<p>⚠️ Face Detection: No faces detected</p>';
                        }
                    } catch (error) {
                        console.error('Detection error:', error);
                        resultsDiv.innerHTML += `<p>❌ Detection error: ${error.message}</p>`;
                    }
                }
            }, 300);
        }

        async function testDetection() {
            if (!modelsLoaded || !cameraStarted) {
                updateStatus('Models or camera not ready', 'error');
                return;
            }

            updateStatus('Testing face detection...', 'info');
            testDetectionBtn.disabled = true;

            // Wait a moment for the camera to stabilize
            setTimeout(async () => {
                try {
                    const video = document.getElementById('video');
                    const detections = await faceapi
                        .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceDescriptors();

                    if (detections && detections.length > 0) {
                        const detection = detections[0];
                        const descriptor = Array.from(detection.descriptor);
                        const confidence = Math.round(detection.detection.score * 100);

                        resultsDiv.innerHTML += `
                            <div style="background: #10b981; padding: 10px; border-radius: 5px; margin: 10px 0;">
                                <h3>✅ Face Detection Test Results:</h3>
                                <p>• Faces detected: ${detections.length}</p>
                                <p>• Descriptor length: ${descriptor.length} dimensions</p>
                                <p>• Confidence: ${confidence}%</p>
                                <p>• Box: x=${Math.round(detection.detection.box.x)}, y=${Math.round(detection.detection.box.y)}, w=${Math.round(detection.detection.box.width)}, h=${Math.round(detection.detection.box.height)}</p>
                            </div>
                        `;

                        updateStatus('Face detection test completed successfully!', 'success');
                    } else {
                        resultsDiv.innerHTML += '<p>❌ No faces detected in test</p>';
                        updateStatus('Face detection test failed - no faces found', 'error');
                    }
                } catch (error) {
                    console.error('Test error:', error);
                    resultsDiv.innerHTML += `<p>❌ Test error: ${error.message}</p>`;
                    updateStatus('Face detection test failed', 'error');
                } finally {
                    testDetectionBtn.disabled = false;
                }
            }, 1000);
        }

        // Event listeners
        loadModelsBtn.addEventListener('click', loadModels);
        startCameraBtn.addEventListener('click', startCamera);
        testDetectionBtn.addEventListener('click', testDetection);

        // Initialize
        updateStatus('Ready to test face-api.js', 'info');
        resultsDiv.innerHTML = '<p>Click "Load Models" to start testing</p>';
    </script>
</body>
</html>
